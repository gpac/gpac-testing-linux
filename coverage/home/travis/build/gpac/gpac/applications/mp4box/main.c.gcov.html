<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - /home/travis/build/gpac/gpac/applications/mp4box/main.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../../index.html">top level</a> - <a href="index.html">home/travis/build/gpac/gpac/applications/mp4box</a> - main.c<span style="font-size: 80%;"> (source / <a href="main.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">2322</td>
            <td class="headerCovTableEntry">2983</td>
            <td class="headerCovTableEntryMed">77.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">78</td>
            <td class="headerCovTableEntry">89</td>
            <td class="headerCovTableEntryMed">87.6 %</td>
          </tr>
          <tr><td><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2000-2021
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / mp4box application
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : #include &quot;mp4box.h&quot;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #ifdef GPAC_DISABLE_ISOM
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : #error &quot;Cannot compile MP4Box if GPAC is not built with ISO File Format support&quot;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : #else
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : #if defined(WIN32) &amp;&amp; !defined(_WIN32_WCE)
<span class="lineNum">      36 </span>            : #include &lt;io.h&gt;
<span class="lineNum">      37 </span>            : #include &lt;fcntl.h&gt;
<span class="lineNum">      38 </span>            : #endif
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : #include &lt;gpac/media_tools.h&gt;
<span class="lineNum">      41 </span>            : #include &lt;gpac/main.h&gt;
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : /*RTP packetizer flags*/
<span class="lineNum">      44 </span>            : #ifndef GPAC_DISABLE_STREAMING
<span class="lineNum">      45 </span>            : #include &lt;gpac/ietf.h&gt;
<span class="lineNum">      46 </span>            : #endif
<span class="lineNum">      47 </span>            : 
<span class="lineNum">      48 </span>            : #ifndef GPAC_DISABLE_CRYPTO
<span class="lineNum">      49 </span>            : #include &lt;gpac/crypt_tools.h&gt;
<span class="lineNum">      50 </span>            : #endif
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      53 </span>            : #include &lt;gpac/filters.h&gt;
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span>            : #include &lt;gpac/mpd.h&gt;
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : #define BUFFSIZE        8192
<span class="lineNum">      58 </span>            : #define DEFAULT_INTERLEAVING_IN_SEC 0.5
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span>            : //undefine to check validity of defined args' syntax
<span class="lineNum">      61 </span>            : //#define TEST_ARGS
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            : int mp4boxTerminal(int argc, char **argv);
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span>            : static u32 mp4box_cleanup(u32 ret_code);
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            : /*
<span class="lineNum">      69 </span>            :  *              START OF ARGUMENT VALUES DECLARATION
<span class="lineNum">      70 </span>            :  */
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            : typedef struct
<span class="lineNum">      75 </span>            : {
<span class="lineNum">      76 </span>            :         GF_ISOTrackID trackID;
<span class="lineNum">      77 </span>            :         char *line;
<span class="lineNum">      78 </span>            : } SDPLine;
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span>            : typedef enum {
<span class="lineNum">      81 </span>            :         META_ACTION_SET_TYPE                    = 0,
<span class="lineNum">      82 </span>            :         META_ACTION_ADD_ITEM                    = 1,
<span class="lineNum">      83 </span>            :         META_ACTION_REM_ITEM                    = 2,
<span class="lineNum">      84 </span>            :         META_ACTION_SET_PRIMARY_ITEM    = 3,
<span class="lineNum">      85 </span>            :         META_ACTION_SET_XML                             = 4,
<span class="lineNum">      86 </span>            :         META_ACTION_SET_BINARY_XML              = 5,
<span class="lineNum">      87 </span>            :         META_ACTION_REM_XML                             = 6,
<span class="lineNum">      88 </span>            :         META_ACTION_DUMP_ITEM                   = 7,
<span class="lineNum">      89 </span>            :         META_ACTION_DUMP_XML                    = 8,
<span class="lineNum">      90 </span>            :         META_ACTION_ADD_IMAGE_ITEM              = 9,
<span class="lineNum">      91 </span>            :         META_ACTION_ADD_IMAGE_GRID              = 10,
<span class="lineNum">      92 </span>            : } MetaActionType;
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span>            : typedef struct {
<span class="lineNum">      95 </span>            :         u32 ref_item_id;
<span class="lineNum">      96 </span>            :         u32 ref_type;
<span class="lineNum">      97 </span>            : } MetaRef;
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span>            : typedef struct
<span class="lineNum">     100 </span>            : {
<span class="lineNum">     101 </span>            :         MetaActionType act_type;
<span class="lineNum">     102 </span>            :         Bool root_meta, use_dref;
<span class="lineNum">     103 </span>            :         GF_ISOTrackID trackID;
<span class="lineNum">     104 </span>            :         u32 meta_4cc;
<span class="lineNum">     105 </span>            :         char *szPath, *szName, *mime_type, *enc_type;
<span class="lineNum">     106 </span>            :         u32 item_id;
<span class="lineNum">     107 </span>            :         Bool primary;
<span class="lineNum">     108 </span>            :         u32 item_type;
<span class="lineNum">     109 </span>            :         u32 ref_item_id;
<span class="lineNum">     110 </span>            :         GF_List *item_refs;
<span class="lineNum">     111 </span>            :         u32 group_id;
<span class="lineNum">     112 </span>            :         u32 group_type;
<span class="lineNum">     113 </span>            :         GF_ImageItemProperties *image_props;
<span class="lineNum">     114 </span>            : } MetaAction;
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span>            : typedef enum {
<span class="lineNum">     118 </span>            :         TRAC_ACTION_REM_TRACK= 0,
<span class="lineNum">     119 </span>            :         TRAC_ACTION_SET_LANGUAGE,
<span class="lineNum">     120 </span>            :         TRAC_ACTION_SET_DELAY,
<span class="lineNum">     121 </span>            :         TRAC_ACTION_SET_KMS_URI,
<span class="lineNum">     122 </span>            :         TRAC_ACTION_SET_PAR,
<span class="lineNum">     123 </span>            :         TRAC_ACTION_SET_HANDLER_NAME,
<span class="lineNum">     124 </span>            :         TRAC_ACTION_ENABLE,
<span class="lineNum">     125 </span>            :         TRAC_ACTION_DISABLE,
<span class="lineNum">     126 </span>            :         TRAC_ACTION_REFERENCE,
<span class="lineNum">     127 </span>            :         TRAC_ACTION_RAW_EXTRACT,
<span class="lineNum">     128 </span>            :         TRAC_ACTION_REM_NON_RAP,
<span class="lineNum">     129 </span>            :         TRAC_ACTION_SET_KIND,
<span class="lineNum">     130 </span>            :         TRAC_ACTION_REM_KIND,
<span class="lineNum">     131 </span>            :         TRAC_ACTION_SET_ID,
<span class="lineNum">     132 </span>            :         TRAC_ACTION_SET_UDTA,
<span class="lineNum">     133 </span>            :         TRAC_ACTION_SWAP_ID,
<span class="lineNum">     134 </span>            :         TRAC_ACTION_REM_NON_REFS,
<span class="lineNum">     135 </span>            :         TRAC_ACTION_SET_CLAP,
<span class="lineNum">     136 </span>            :         TRAC_ACTION_SET_MX,
<span class="lineNum">     137 </span>            :         TRAC_ACTION_SET_EDITS,
<span class="lineNum">     138 </span>            :         TRAC_ACTION_SET_TIME,
<span class="lineNum">     139 </span>            :         TRAC_ACTION_SET_MEDIA_TIME,
<span class="lineNum">     140 </span>            : } TrackActionType;
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span>            : typedef struct
<span class="lineNum">     143 </span>            : {
<span class="lineNum">     144 </span>            :         TrackActionType act_type;
<span class="lineNum">     145 </span>            :         GF_ISOTrackID trackID;
<span class="lineNum">     146 </span>            :         char lang[10];
<span class="lineNum">     147 </span>            :         GF_Fraction delay;
<span class="lineNum">     148 </span>            :         const char *kms;
<span class="lineNum">     149 </span>            :         const char *hdl_name;
<span class="lineNum">     150 </span>            :         s32 par_num, par_den;
<span class="lineNum">     151 </span>            :         u8 force_par, rewrite_bs;
<span class="lineNum">     152 </span>            :         u32 dump_type, sample_num;
<span class="lineNum">     153 </span>            :         char *out_name;
<span class="lineNum">     154 </span>            :         char *src_name;
<span class="lineNum">     155 </span>            :         char *string;
<span class="lineNum">     156 </span>            :         u32 udta_type;
<span class="lineNum">     157 </span>            :         char *kind_scheme, *kind_value;
<span class="lineNum">     158 </span>            :         u32 newTrackID;
<span class="lineNum">     159 </span>            :         s32 clap_wnum, clap_wden, clap_hnum, clap_hden, clap_honum, clap_hoden, clap_vonum, clap_voden;
<span class="lineNum">     160 </span>            :         s32 mx[9];
<span class="lineNum">     161 </span>            :         u64 time;
<span class="lineNum">     162 </span>            :         u8 dump_track_type;
<span class="lineNum">     163 </span>            : } TrackAction;
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span>            : enum
<span class="lineNum">     166 </span>            : {
<span class="lineNum">     167 </span>            :         GF_ISOM_CONV_TYPE_ISMA = 1,
<span class="lineNum">     168 </span>            :         GF_ISOM_CONV_TYPE_ISMA_EX,
<span class="lineNum">     169 </span>            :         GF_ISOM_CONV_TYPE_3GPP,
<span class="lineNum">     170 </span>            :         GF_ISOM_CONV_TYPE_IPOD,
<span class="lineNum">     171 </span>            :         GF_ISOM_CONV_TYPE_PSP,
<span class="lineNum">     172 </span>            :         GF_ISOM_CONV_TYPE_MOV
<span class="lineNum">     173 </span>            : };
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span>            : typedef enum {
<span class="lineNum">     176 </span>            :         TSEL_ACTION_SET_PARAM = 0,
<span class="lineNum">     177 </span>            :         TSEL_ACTION_REMOVE_TSEL = 1,
<span class="lineNum">     178 </span>            :         TSEL_ACTION_REMOVE_ALL_TSEL_IN_GROUP = 2,
<span class="lineNum">     179 </span>            : } TSELActionType;
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span>            : typedef struct
<span class="lineNum">     182 </span>            : {
<span class="lineNum">     183 </span>            :         TSELActionType act_type;
<span class="lineNum">     184 </span>            :         GF_ISOTrackID trackID;
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span>            :         GF_ISOTrackID refTrackID;
<span class="lineNum">     187 </span>            :         u32 criteria[30];
<span class="lineNum">     188 </span>            :         u32 nb_criteria;
<span class="lineNum">     189 </span>            :         Bool is_switchGroup;
<span class="lineNum">     190 </span>            :         u32 switchGroupID;
<span class="lineNum">     191 </span>            : } TSELAction;
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span>            : GF_FileType get_file_type_by_ext(char *inName);
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span>            : char outfile[GF_MAX_PATH];
<span class="lineNum">     197 </span>            : GF_SMEncodeOptions smenc_opts;
<span class="lineNum">     198 </span>            : GF_Fraction import_fps;
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            : //things to free upon cleanup
<span class="lineNum">     201 </span>            : MetaAction *metas = NULL;
<span class="lineNum">     202 </span>            : TrackAction *tracks = NULL;
<span class="lineNum">     203 </span>            : TSELAction *tsel_acts = NULL;
<span class="lineNum">     204 </span>            : SDPLine *sdp_lines = NULL;
<span class="lineNum">     205 </span>            : u32 *brand_add = NULL;
<span class="lineNum">     206 </span>            : u32 *brand_rem = NULL;
<span class="lineNum">     207 </span>            : char **mpd_base_urls = NULL;
<span class="lineNum">     208 </span>            : u32 nb_mpd_base_urls = 0;
<span class="lineNum">     209 </span>            : GF_DashSegmenterInput *dash_inputs = NULL;
<span class="lineNum">     210 </span>            : u32 nb_dash_inputs = 0;
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span>            : //all other options values - keep options with assignment other than 0 on a single line
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span>            : u32 swf_flags = GF_SM_SWF_SPLIT_TIMELINE;
<span class="lineNum">     217 </span>            : 
<span class="lineNum">     218 </span>            : FILE *helpout = NULL;
<span class="lineNum">     219 </span>            : u32 help_flags = 0;
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span>            : Double interleaving_time=0.0, split_duration=0.0, split_start=-1.0, dash_duration=0.0, dash_subduration=0.0, swf_flatten_angle=0.0;
<span class="lineNum">     222 </span>            : Bool dash_duration_strict=0, dvbhdemux=0, keep_sys_tracks=0;
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span>            : u64 initial_tfdt=0;
<span class="lineNum">     225 </span>            : s32 subsegs_per_sidx=0, laser_resolution=0, ast_offset_ms=0;
<span class="lineNum">     226 </span>            : const char *split_range_str = NULL;
<span class="lineNum">     227 </span>            : GF_DashSwitchingMode bitstream_switching_mode = GF_DASH_BSMODE_DEFAULT;
<span class="lineNum">     228 </span>            : u32 stat_level=0, hint_flags=0, info_track_id=0, import_flags=0, nb_add=0, nb_cat=0, crypt=0, agg_samples=0, nb_sdp_ex=0, max_ptime=0, split_size=0, nb_meta_act=0, nb_track_act=0, rtp_rate=0, major_brand=0, nb_alt_brand_add=0, nb_alt_brand_rem=0, old_interleave=0, minor_version=0, conv_type=0, nb_tsel_acts=0, program_number=0, dump_nal=0, time_shift_depth=0, initial_moof_sn=0, dump_std=0, import_subtitle=0, dump_saps=0, dump_saps_mode=0, force_new=0;
<span class="lineNum">     229 </span>            : GF_DashDynamicMode dash_mode=GF_DASH_STATIC;
<span class="lineNum">     230 </span>            : #ifndef GPAC_DISABLE_SCENE_DUMP
<span class="lineNum">     231 </span>            : GF_SceneDumpFormat dump_mode=GF_SM_DUMP_NONE;
<span class="lineNum">     232 </span>            : #endif
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span>            : /*align cat is the new default behavior for -cat*/
<span class="lineNum">     235 </span>            : Bool align_cat=GF_TRUE;
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span>            : Double mpd_live_duration=0;
<span class="lineNum">     238 </span>            : Bool do_hint=0, do_save=0, full_interleave=0, do_frag=0, hint_interleave=0, dump_rtp=0, regular_iod=0, remove_sys_tracks=0, remove_hint=0, remove_root_od=0;
<span class="lineNum">     239 </span>            : Bool print_sdp=0, open_edit=0, dump_cr=0, force_ocr=0, encode=0, do_scene_log=0, dump_srt=0, dump_ttxt=0, do_saf=0, dump_m2ts=0, dump_cart=0;
<span class="lineNum">     240 </span>            : Bool do_hash=0, verbose=0, force_cat=0, pack_wgt=0, single_group=0, clean_groups=0, dash_live=0, no_fragments_defaults=0;
<span class="lineNum">     241 </span>            : Bool single_traf_per_moof=0, tfdt_per_traf=0, hls_clock=0, do_mpd_rip=0, merge_vtt_cues=0, get_nb_tracks=0;
<span class="lineNum">     242 </span>            : u32 compress_moov=0;
<span class="lineNum">     243 </span>            : char *inName=NULL, *outName=NULL, *mediaSource=NULL, *input_ctx=NULL, *output_ctx=NULL, *drm_file=NULL, *avi2raw=NULL, *cprt=NULL;
<span class="lineNum">     244 </span>            : char *chap_file=NULL, *chap_file_qt=NULL, *itunes_tags=NULL, *pack_file=NULL, *raw_cat=NULL, *seg_name=NULL, *dash_ctx_file=NULL;
<span class="lineNum">     245 </span>            : char *compress_top_boxes=NULL, *high_dynamc_range_filename=NULL, *use_init_seg=NULL, *box_patch_filename=NULL, *udp_dest = NULL;
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span>            : GF_ISOTrackID trackID=0;
<span class="lineNum">     248 </span>            : u32 track_dump_type=0, dump_isom=0, dump_timestamps=0, dump_nal_type=0, do_flat=0, box_patch_trackID=0, print_info=0;
<span class="lineNum">     249 </span>            : Bool no_inplace=0, merge_last_seg=0, freeze_box_order=0, no_odf_conf=0;
<span class="lineNum">     250 </span>            : Double min_buffer = 1.5;
<span class="lineNum">     251 </span>            : u32 size_top_box=0, fs_dump_flags=0, dump_chap=0, dump_udta_type=0, dump_udta_track=0, moov_pading=0, sdtp_in_traf=0, segment_marker=0, timescale=0;
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span>            : u32 dash_scale = 1000;
<span class="lineNum">     254 </span>            : GF_ISOFile *file = NULL;
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span>            : Bool insert_utc=0, chunk_mode=0, HintCopy=0, hint_no_offset=0, do_bin_xml=0, frag_real_time=0, force_co64=0, live_scene=0, use_mfra=0;
<span class="lineNum">     257 </span>            : Bool dump_iod=0, samplegroups_in_traf=0, mvex_after_traks=0, daisy_chain_sidx=0, use_ssix=0, single_segment=0, single_file=0, segment_timeline=0;
<span class="lineNum">     258 </span>            : Bool has_add_image=0;
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span>            : char *do_mpd_conv=NULL;
<span class="lineNum">     261 </span>            : u32 MTUSize = 1450;
<span class="lineNum">     262 </span>            : char *dash_start_date=NULL;
<span class="lineNum">     263 </span>            : GF_DASH_ContentLocationMode cp_location_mode = GF_DASH_CPMODE_ADAPTATION_SET;
<span class="lineNum">     264 </span>            : Double mpd_update_time = 0.0;
<span class="lineNum">     265 </span>            : GF_MemTrackerType mem_track = GF_MemTrackerNone;
<span class="lineNum">     266 </span>            : GF_DASHPSSHMode pssh_mode=0;
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span>            : GF_DashProfile dash_profile=GF_DASH_PROFILE_AUTO;
<span class="lineNum">     269 </span>            : char *dash_profile_extension = NULL;
<span class="lineNum">     270 </span>            : char *dash_cues = NULL;
<span class="lineNum">     271 </span>            : Bool strict_cues=0, use_url_template=0, seg_at_rap=0, frag_at_rap=0, memory_frags=0, keep_utc=0, has_next_arg=0, no_cache=0, no_loop=0;
<span class="lineNum">     272 </span>            : u32 adjust_split_end=0;
<span class="lineNum">     273 </span>            : char *do_wget = NULL;
<span class="lineNum">     274 </span>            : char *mux_name = NULL;
<span class="lineNum">     275 </span>            : char *seg_ext = NULL;
<span class="lineNum">     276 </span>            : char *init_seg_ext = NULL;
<span class="lineNum">     277 </span>            : char *dash_title = NULL;
<span class="lineNum">     278 </span>            : char *dash_source = NULL;
<span class="lineNum">     279 </span>            : char *dash_more_info = NULL;
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span>            : FILE *logfile = NULL;
<span class="lineNum">     282 </span>            : u32 run_for=0, dash_cumulated_time=0, dash_prev_time=0, dash_now_time=0;
<span class="lineNum">     283 </span>            : GF_DASH_SplitMode dash_split_mode = GF_DASH_SPLIT_OUT;
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span>            : typedef u32 (*parse_arg_fun)(char *arg_val, u32 param);
<span class="lineNum">     287 </span>            : typedef u32 (*parse_arg_fun2)(char *arg_name, char *arg_val, u32 param);
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span>            : //other custom option parsing functions definitions are in mp4box.h
<span class="lineNum">     290 </span>            : static u32 parse_meta_args(char *opts, MetaActionType act_type);
<span class="lineNum">     291 </span>            : static Bool parse_tsel_args(char *opts, TSELActionType act);
<span class="lineNum">     292 </span>            : 
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span>            : /*
<span class="lineNum">     296 </span>            :  *              START OF ARGS PARSING AND HELP
<span class="lineNum">     297 </span>            :  */
<a name="298"><span class="lineNum">     298 </span>            : </a>
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span><span class="lineCov">          2 : Bool print_version(char *arg_val, u32 param)</span>
<span class="lineNum">     301 </span>            : {
<span class="lineNum">     302 </span><span class="lineCov">          2 :         fprintf(stderr, &quot;MP4Box - GPAC version %s\n&quot;</span>
<span class="lineNum">     303 </span>            :                 &quot;%s\n&quot;
<span class="lineNum">     304 </span>            :                 &quot;GPAC Configuration: &quot; GPAC_CONFIGURATION &quot;\n&quot;
<span class="lineNum">     305 </span>            :                 &quot;Features: %s %s\n&quot;, gf_gpac_version(), gf_gpac_copyright_cite(), gf_sys_features(GF_FALSE), gf_sys_features(GF_TRUE));
<span class="lineNum">     306 </span><span class="lineCov">          2 :         return GF_TRUE;</span>
<span class="lineNum">     307 </span>            : }
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span>            : //arg will toggle open_edit
<span class="lineNum">     310 </span>            : #define ARG_OPEN_EDIT           1
<span class="lineNum">     311 </span>            : //arg will toggle do_save
<span class="lineNum">     312 </span>            : #define ARG_NEED_SAVE           1&lt;&lt;1
<span class="lineNum">     313 </span>            : #define ARG_NO_INPLACE          1&lt;&lt;2
<span class="lineNum">     314 </span>            : #define ARG_BIT_MASK            1&lt;&lt;3
<span class="lineNum">     315 </span>            : #define ARG_BIT_MASK_REM        1&lt;&lt;4
<span class="lineNum">     316 </span>            : #define ARG_HAS_VALUE           1&lt;&lt;5
<span class="lineNum">     317 </span>            : #define ARG_DIV_1000            1&lt;&lt;6
<span class="lineNum">     318 </span>            : #define ARG_NON_ZERO            1&lt;&lt;7
<span class="lineNum">     319 </span>            : #define ARG_64BITS                      1&lt;&lt;8
<span class="lineNum">     320 </span>            : #define ARG_IS_4CC                      1&lt;&lt;9
<span class="lineNum">     321 </span>            : #define ARG_BOOL_REV            1&lt;&lt;10
<span class="lineNum">     322 </span>            : #define ARG_INT_INC                     1&lt;&lt;11
<span class="lineNum">     323 </span>            : #define ARG_IS_FUN                      1&lt;&lt;12
<span class="lineNum">     324 </span>            : #define ARG_EMPTY                       1&lt;&lt;13
<span class="lineNum">     325 </span>            : #define ARG_PUSH_SYSARGS        1&lt;&lt;14
<span class="lineNum">     326 </span>            : #define ARG_IS_FUN2                     1&lt;&lt;15
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span>            : typedef struct
<span class="lineNum">     331 </span>            : {
<span class="lineNum">     332 </span>            :         GF_GPAC_ARG_BASE
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span>            :         void *arg_ptr;
<span class="lineNum">     335 </span>            :         u32 argv_val;
<span class="lineNum">     336 </span>            :         u16 parse_flags;
<span class="lineNum">     337 </span>            : } MP4BoxArg;
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span>            : #define MP4BOX_ARG(_a, _c, _f, _g, _h, _i, _j) {_a, NULL, _c, NULL, NULL, _f, _g, _h, _i, _j}
<span class="lineNum">     340 </span>            : #define MP4BOX_ARG_ALT(_a, _b, _c, _f, _g, _h, _i, _j) {_a, _b, _c, NULL, NULL, _f, _g, _h, _i, _j}
<span class="lineNum">     341 </span>            : #define MP4BOX_ARG_S(_a, _s, _c, _g, _h, _i, _j) {_a, NULL, _c, _s, NULL, GF_ARG_CUSTOM, _g, _h, _i, _j}
<span class="lineNum">     342 </span>            : #define MP4BOX_ARG_S_ALT(_a, _b, _s, _c, _g, _h, _i, _j) {_a, _b, _c, _s, NULL, GF_ARG_CUSTOM, _g, _h, _i, _j}
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span>            : MP4BoxArg m4b_gen_args[] =
<span class="lineNum">     346 </span>            : {
<span class="lineNum">     347 </span>            : #ifdef GPAC_MEMORY_TRACKING
<span class="lineNum">     348 </span>            :         MP4BOX_ARG(&quot;mem-track&quot;, &quot;enable memory tracker&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, NULL, 0, 0),
<span class="lineNum">     349 </span>            :         MP4BOX_ARG(&quot;mem-track-stack&quot;, &quot;enable memory tracker with stack dumping&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, NULL, 0, 0),
<span class="lineNum">     350 </span>            : #endif
<span class="lineNum">     351 </span>            :         MP4BOX_ARG(&quot;p&quot;, &quot;use indicated profile for the global GPAC config. If not found, config file is created. If a file path is indicated, this will load profile from that file. Otherwise, this will create a directory of the specified name and store new config there. Reserved name `0` means a new profile, not stored to disk. Works using -p=NAME or -p NAME&quot;, GF_ARG_STRING, GF_ARG_HINT_EXPERT, NULL, 0, 0),
<span class="lineNum">     352 </span>            :         {&quot;inter&quot;, NULL, &quot;interleave file, producing track chunks with given duration in ms. A value of 0 disables interleaving &quot;, &quot;0.5&quot;, NULL, GF_ARG_DOUBLE, 0, parse_store_mode, 0, ARG_IS_FUN},
<span class="lineNum">     353 </span>            :         MP4BOX_ARG(&quot;old-inter&quot;, &quot;same as [-inter]() but without drift correction&quot;, GF_ARG_DOUBLE, GF_ARG_HINT_EXPERT, parse_store_mode, 1, ARG_IS_FUN),
<span class="lineNum">     354 </span>            :         MP4BOX_ARG(&quot;tight&quot;, &quot;tight interleaving (sample based) of the file. This reduces disk seek operations but increases file size&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;full_interleave, 0, ARG_OPEN_EDIT|ARG_NEED_SAVE),
<span class="lineNum">     355 </span>            :         MP4BOX_ARG(&quot;flat&quot;, &quot;store file with all media data first, non-interleaved. This speeds up writing time when creating new files&quot;, GF_ARG_BOOL, 0, &amp;do_flat, 0, ARG_OPEN_EDIT| ARG_NO_INPLACE),
<span class="lineNum">     356 </span>            :         MP4BOX_ARG(&quot;frag&quot;, &quot;fragment file, producing track fragments of given duration in ms. This disables interleaving&quot;, GF_ARG_DOUBLE, 0, parse_store_mode, 2, ARG_IS_FUN),
<span class="lineNum">     357 </span>            :         MP4BOX_ARG(&quot;out&quot;, &quot;specify ISOBMFF output file name. By default input file is overwritten&quot;, GF_ARG_STRING, 0, &amp;outName, 0, 0),
<span class="lineNum">     358 </span>            :         MP4BOX_ARG(&quot;co64&quot;,&quot;force usage of 64-bit chunk offsets for ISOBMF files&quot;, GF_ARG_BOOL, GF_ARG_HINT_ADVANCED, &amp;force_co64, 0, ARG_OPEN_EDIT),
<span class="lineNum">     359 </span>            :         MP4BOX_ARG(&quot;new&quot;, &quot;force creation of a new destination file&quot;, GF_ARG_BOOL, GF_ARG_HINT_ADVANCED, &amp;force_new, 0, 0),
<span class="lineNum">     360 </span>            :         MP4BOX_ARG(&quot;newfs&quot;, &quot;force creation of a new destination file without temp file but interleaving support&quot;, GF_ARG_BOOL, GF_ARG_HINT_ADVANCED, parse_store_mode, 3, ARG_IS_FUN),
<span class="lineNum">     361 </span>            :         MP4BOX_ARG_ALT(&quot;no-sys&quot;, &quot;nosys&quot;, &quot;remove all MPEG-4 Systems info except IOD, kept for profiles. This is the default when creating regular AV content&quot;, GF_ARG_BOOL, GF_ARG_HINT_ADVANCED, &amp;remove_sys_tracks, 0, ARG_OPEN_EDIT),
<span class="lineNum">     362 </span>            :         MP4BOX_ARG(&quot;no-iod&quot;, &quot;remove MPEG-4 InitialObjectDescriptor from file&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;remove_root_od, 0, ARG_OPEN_EDIT),
<span class="lineNum">     363 </span>            :         MP4BOX_ARG(&quot;mfra&quot;, &quot;insert movie fragment random offset when fragmenting file (ignored in dash mode)&quot;, GF_ARG_BOOL, GF_ARG_HINT_ADVANCED, &amp;use_mfra, 0, 0),
<span class="lineNum">     364 </span>            :         MP4BOX_ARG(&quot;isma&quot;, &quot;rewrite the file as an ISMA 1.0 file&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;conv_type, GF_ISOM_CONV_TYPE_ISMA, ARG_OPEN_EDIT),
<span class="lineNum">     365 </span>            :         MP4BOX_ARG(&quot;ismax&quot;, &quot;same as [-isma]() and remove all clock references&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;conv_type, GF_ISOM_CONV_TYPE_ISMA_EX, ARG_OPEN_EDIT),
<span class="lineNum">     366 </span>            :         MP4BOX_ARG(&quot;3gp&quot;, &quot;rewrite as 3GPP(2) file (no more MPEG-4 Systems Info), always enabled if destination file extension is `.3gp`, `.3g2` or `.3gpp`. Some tracks may be removed in the process&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;conv_type, GF_ISOM_CONV_TYPE_3GPP, ARG_OPEN_EDIT),
<span class="lineNum">     367 </span>            :         MP4BOX_ARG(&quot;ipod&quot;, &quot;rewrite the file for iPod/old iTunes&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;conv_type, GF_ISOM_CONV_TYPE_IPOD, ARG_OPEN_EDIT),
<span class="lineNum">     368 </span>            :         MP4BOX_ARG(&quot;psp&quot;, &quot;rewrite the file for PSP devices&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;conv_type, GF_ISOM_CONV_TYPE_PSP, ARG_OPEN_EDIT),
<span class="lineNum">     369 </span>            :         MP4BOX_ARG(&quot;brand&quot;, &quot;set major brand of file (`ABCD`) or brand with optional version (`ABCD:v`)&quot;, GF_ARG_STRING, GF_ARG_HINT_ADVANCED, parse_brand, 0, ARG_IS_FUN),
<span class="lineNum">     370 </span>            :         MP4BOX_ARG(&quot;ab&quot;, &quot;add given brand to file's alternate brand list&quot;, GF_ARG_STRING, GF_ARG_HINT_ADVANCED, parse_brand, 1, ARG_IS_FUN),
<span class="lineNum">     371 </span>            :         MP4BOX_ARG(&quot;rb&quot;, &quot;remove given brand to file's alternate brand list&quot;, GF_ARG_STRING, GF_ARG_HINT_ADVANCED, parse_brand, 2, ARG_IS_FUN),
<span class="lineNum">     372 </span>            :         MP4BOX_ARG(&quot;cprt&quot;, &quot;add copyright string to file&quot;, GF_ARG_STRING, GF_ARG_HINT_ADVANCED, &amp;cprt, 0, 0),
<span class="lineNum">     373 </span>            :         MP4BOX_ARG(&quot;chap&quot;, &quot;set chapter information from given file. The following formats are supported (but cannot be mixed) in the chapter text file:\n&quot;
<span class="lineNum">     374 </span>            :                 &quot;  - ZoomPlayer: `AddChapter(nb_frames,chapter name)`, `AddChapterBySeconds(nb_sec,chapter name)` and `AddChapterByTime(h,m,s,chapter name)` with 1 chapter per line\n&quot;
<span class="lineNum">     375 </span>            :                 &quot;  - Time codes: `h:m:s chapter_name`, `h:m:s:ms chapter_name` and `h:m:s.ms chapter_name` with 1 chapter per line\n&quot;
<span class="lineNum">     376 </span>            :                 &quot;  - SMPTE codes: `h:m:s;nb_f/fps chapter_name` and `h:m:s;nb_f chapter_name` with `nb_f` the number of frames and `fps` the framerate with 1 chapter per line\n&quot;
<span class="lineNum">     377 </span>            :                 &quot;  - Common syntax: `CHAPTERX=h:m:s[:ms or .ms]` on first line and `CHAPTERXNAME=name` on next line (reverse order accepted)&quot;, GF_ARG_STRING, GF_ARG_HINT_ADVANCED, &amp;chap_file, 0, ARG_OPEN_EDIT),
<span class="lineNum">     378 </span>            :         MP4BOX_ARG(&quot;chapqt&quot;, &quot;set chapter information from given file, using QT signaling for text tracks&quot;, GF_ARG_STRING, GF_ARG_HINT_ADVANCED, &amp;chap_file_qt, 0, ARG_OPEN_EDIT),
<span class="lineNum">     379 </span>            :         MP4BOX_ARG_S(&quot;set-track-id&quot;, &quot;id1:id2&quot;, &quot;change id of track with id1 to id2&quot;, 0, parse_track_action, TRAC_ACTION_SET_ID, ARG_IS_FUN),
<span class="lineNum">     380 </span>            :         MP4BOX_ARG_S(&quot;swap-track-id&quot;, &quot;id1:id2&quot;, &quot;swap the id between tracks with id1 to id2&quot;, 0, parse_track_action, TRAC_ACTION_SWAP_ID, ARG_IS_FUN),
<span class="lineNum">     381 </span>            :         MP4BOX_ARG(&quot;rem&quot;, &quot;remove given track from file&quot;, GF_ARG_INT, 0, parse_track_action, TRAC_ACTION_REM_TRACK, ARG_IS_FUN),
<span class="lineNum">     382 </span>            :         MP4BOX_ARG(&quot;rap&quot;, &quot;remove all non-RAP samples from given track&quot;, GF_ARG_INT, GF_ARG_HINT_ADVANCED, parse_rap_ref, 0, ARG_IS_FUN | ARG_EMPTY),
<span class="lineNum">     383 </span>            :         MP4BOX_ARG(&quot;refonly&quot;, &quot;remove all non-reference pictures from given track&quot;, GF_ARG_INT, GF_ARG_HINT_ADVANCED, parse_rap_ref, 1, ARG_IS_FUN | ARG_EMPTY),
<span class="lineNum">     384 </span>            :         MP4BOX_ARG(&quot;enable&quot;, &quot;enable given track&quot;, GF_ARG_INT, 0, parse_track_action, TRAC_ACTION_ENABLE, ARG_IS_FUN),
<span class="lineNum">     385 </span>            :         MP4BOX_ARG(&quot;disable&quot;, &quot;disable given track&quot;, GF_ARG_INT, 0, parse_track_action, TRAC_ACTION_DISABLE, ARG_IS_FUN),
<span class="lineNum">     386 </span>            :         {&quot;timescale&quot;, NULL, &quot;set movie timescale to given value (ticks per second)&quot;, &quot;600&quot;, NULL, GF_ARG_INT, 0, &amp;timescale, 0, ARG_OPEN_EDIT},
<span class="lineNum">     387 </span>            :         MP4BOX_ARG_S(&quot;lang&quot;, &quot;[tkID=]LAN&quot;, &quot;set language. LAN is the BCP-47 code (eng, en-UK, ...). If no track ID is given, sets language to all tracks&quot;, 0, parse_track_action, TRAC_ACTION_SET_LANGUAGE, ARG_IS_FUN),
<span class="lineNum">     388 </span>            :         MP4BOX_ARG_S(&quot;delay&quot;, &quot;tkID=TIME&quot;, &quot;set track start delay (&gt;0) or initial skip (&lt;0) in ms or in fractional seconds (`N/D`)&quot;, 0, parse_track_action, TRAC_ACTION_SET_DELAY, ARG_IS_FUN),
<span class="lineNum">     389 </span>            :         MP4BOX_ARG_S(&quot;par&quot;, &quot;tkID=PAR&quot;, &quot;set visual track pixel aspect ratio. PAR is:\n&quot;
<span class="lineNum">     390 </span>            :                                         &quot;  - N:D: set PAR to N:D in track, do not modify the bitstream\n&quot;
<span class="lineNum">     391 </span>            :                                         &quot;  - wN:D: set PAR to N:D in track and try to modify the bitstream\n&quot;
<span class="lineNum">     392 </span>            :                                         &quot;  - none: remove PAR info from track, do not modify the bitstream\n&quot;
<span class="lineNum">     393 </span>            :                                         &quot;  - auto: retrieve PAR info from bitstream and set it in track\n&quot;
<span class="lineNum">     394 </span>            :                                         &quot;  - force: force 1:1 PAR in track, do not modify the bitstream&quot;, GF_ARG_HINT_ADVANCED, parse_track_action, TRAC_ACTION_SET_PAR, ARG_IS_FUN
<span class="lineNum">     395 </span>            :                                         ),
<span class="lineNum">     396 </span>            :         MP4BOX_ARG_S(&quot;clap&quot;, &quot;tkID=CLAP&quot;, &quot;set visual track clean aperture. CLAP is `Wn,Wd,Hn,Hd,HOn,HOd,VOn,VOd` or `none`\n&quot;
<span class="lineNum">     397 </span>            :                         &quot;- n, d: numerator, denominator\n&quot;
<span class="lineNum">     398 </span>            :                 &quot;- W, H, HO, VO: clap width, clap height, clap horizontal offset, clap vertical offset\n&quot;
<span class="lineNum">     399 </span>            :                         , GF_ARG_HINT_ADVANCED, parse_track_action, TRAC_ACTION_SET_CLAP, ARG_IS_FUN),
<span class="lineNum">     400 </span>            :         MP4BOX_ARG_S(&quot;mx&quot;, &quot;tkID=MX&quot;, &quot;set track matrix, with MX is M1:M2:M3:M4:M5:M6:M7:M8:M9 in 16.16 fixed point intergers or hexa&quot;
<span class="lineNum">     401 </span>            :                         , GF_ARG_HINT_ADVANCED, parse_track_action, TRAC_ACTION_SET_MX, ARG_IS_FUN),
<span class="lineNum">     402 </span>            :         MP4BOX_ARG_S(&quot;kind&quot;, &quot;tkID=schemeURI=value&quot;, &quot;set kind for the track or for all tracks using `all=schemeURI=value`&quot;, 0, parse_track_action, TRAC_ACTION_SET_KIND, ARG_IS_FUN),
<span class="lineNum">     403 </span>            :         MP4BOX_ARG_S(&quot;kind-rem&quot;, &quot;tkID=schemeURI=value&quot;, &quot;remove kind if given schemeID for the track or for all tracks with `all=schemeURI=value`&quot;, 0, parse_track_action, TRAC_ACTION_REM_KIND, ARG_IS_FUN),
<span class="lineNum">     404 </span>            :         MP4BOX_ARG_S(&quot;name&quot;, &quot;tkID=NAME&quot;, &quot;set track handler name to NAME (UTF-8 string)&quot;, GF_ARG_HINT_ADVANCED, parse_track_action, TRAC_ACTION_SET_HANDLER_NAME, ARG_IS_FUN),
<span class="lineNum">     405 </span>            :         MP4BOX_ARG(&quot;itags&quot;, &quot;set iTunes tags to file, see `-h tags`&quot;, GF_ARG_STRING, GF_ARG_HINT_ADVANCED, &amp;itunes_tags, 0, ARG_OPEN_EDIT),
<span class="lineNum">     406 </span>            :         MP4BOX_ARG(&quot;group-add&quot;, &quot;create a new grouping information in the file. Format is a colon-separated list of following options:\n&quot;
<span class="lineNum">     407 </span>            :                 &quot;- refTrack=ID: ID of the track used as a group reference. If not set, the track will belong to the same group as the &quot;
<span class="lineNum">     408 </span>            :                 &quot;previous trackID specified. If 0 or no previous track specified, a new alternate group will be created\n&quot;
<span class="lineNum">     409 </span>            :                 &quot;- switchID=ID: ID of the switch group to create. If 0, a new ID will be computed for you. If &lt;0, disables SwitchGroup\n&quot;
<span class="lineNum">     410 </span>            :                 &quot;- criteria=string: list of space-separated 4CCs\n&quot;
<span class="lineNum">     411 </span>            :                 &quot;- trackID=ID: ID of the track to add to this group\n&quot;
<span class="lineNum">     412 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     413 </span>            :                 &quot;Warning: Options modify state as they are parsed, `trackID=1:criteria=lang:trackID=2` is different from `criteria=lang:trackID=1:trackID=2`&quot;
<span class="lineNum">     414 </span>            :                 &quot;\n&quot;, GF_ARG_STRING, GF_ARG_HINT_ADVANCED, parse_tsel_args, TSEL_ACTION_SET_PARAM, ARG_IS_FUN),
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span>            :         MP4BOX_ARG(&quot;group-rem-track&quot;, &quot;remove given track from its group&quot;, GF_ARG_INT, GF_ARG_HINT_ADVANCED, parse_tsel_args, TSEL_ACTION_REMOVE_TSEL, ARG_IS_FUN),
<span class="lineNum">     417 </span>            :         MP4BOX_ARG(&quot;group-rem&quot;, &quot;remove the track's group&quot;, GF_ARG_INT, GF_ARG_HINT_ADVANCED, parse_tsel_args, TSEL_ACTION_REMOVE_ALL_TSEL_IN_GROUP, ARG_IS_FUN),
<span class="lineNum">     418 </span>            :         MP4BOX_ARG(&quot;group-clean&quot;, &quot;remove all group information from all tracks&quot;, GF_ARG_BOOL, GF_ARG_HINT_ADVANCED, &amp;clean_groups, 0, ARG_OPEN_EDIT),
<span class="lineNum">     419 </span>            :         MP4BOX_ARG_S(&quot;ref&quot;, &quot;id:XXXX:refID&quot;, &quot;add a reference of type 4CC from track ID to track refID&quot;, GF_ARG_HINT_ADVANCED, parse_track_action, TRAC_ACTION_REFERENCE, ARG_IS_FUN),
<span class="lineNum">     420 </span>            :         MP4BOX_ARG(&quot;keep-utc&quot;, &quot;keep UTC timing in the file after edit&quot;, GF_ARG_BOOL, GF_ARG_HINT_ADVANCED, &amp;keep_utc, 0, 0),
<span class="lineNum">     421 </span>            :         MP4BOX_ARG_S(&quot;udta&quot;, &quot;tkID:[OPTS]&quot;, &quot;set udta for given track or movie if tkID is 0. OPTS is a colon separated list of:\n&quot;
<span class="lineNum">     422 </span>            :                 &quot;- type=CODE: 4CC code of the UDTA (not needed for `box=` option)\n&quot;
<span class="lineNum">     423 </span>            :                 &quot;- box=FILE: location of the udta data, formatted as serialized boxes\n&quot;
<span class="lineNum">     424 </span>            :                 &quot;- box=base64,DATA: base64 encoded udta data, formatted as serialized boxes\n&quot;
<span class="lineNum">     425 </span>            :                 &quot;- src=FILE: location of the udta data (will be stored in a single box of type CODE)\n&quot;
<span class="lineNum">     426 </span>            :                 &quot;- src=base64,DATA: base64 encoded udta data (will be stored in a single box of type CODE)\n&quot;
<span class="lineNum">     427 </span>            :                 &quot;- str=STRING: use the given string as payload for the udta box\n&quot;
<span class="lineNum">     428 </span>            :                 &quot;Note: If no source is set, UDTA of type CODE will be removed\n&quot;, GF_ARG_HINT_ADVANCED, parse_track_action, TRAC_ACTION_SET_UDTA, ARG_IS_FUN|ARG_OPEN_EDIT),
<span class="lineNum">     429 </span>            :         MP4BOX_ARG_S(&quot;patch&quot;, &quot;[tkID=]FILE&quot;, &quot;apply box patch described in FILE, for given trackID if set&quot;, GF_ARG_HINT_ADVANCED, parse_boxpatch, 0, ARG_IS_FUN),
<span class="lineNum">     430 </span>            :         MP4BOX_ARG(&quot;bo&quot;, &quot;freeze the order of boxes in input file&quot;, GF_ARG_BOOL, GF_ARG_HINT_ADVANCED, &amp;freeze_box_order, 0, 0),
<span class="lineNum">     431 </span>            :         MP4BOX_ARG(&quot;init-seg&quot;, &quot;use the given file as an init segment for dumping or for encryption&quot;, GF_ARG_STRING, GF_ARG_HINT_ADVANCED, &amp;use_init_seg, 0, 0),
<span class="lineNum">     432 </span>            :         MP4BOX_ARG(&quot;zmov&quot;, &quot;compress movie box according to ISOBMFF box compression&quot;, GF_ARG_BOOL, GF_ARG_HINT_ADVANCED, parse_compress, 0, ARG_IS_FUN),
<span class="lineNum">     433 </span>            :         MP4BOX_ARG(&quot;xmov&quot;, &quot;same as zmov and wraps ftyp in otyp&quot;, GF_ARG_BOOL, GF_ARG_HINT_ADVANCED, parse_compress, 1, ARG_IS_FUN),
<span class="lineNum">     434 </span>            :         MP4BOX_ARG_S(&quot;edits&quot;, &quot;tkID=EDITS&quot;, &quot;set edit list. The following syntax is used (no separators between entries):\n&quot;
<span class="lineNum">     435 </span>            :                         &quot; - `r`: removes all edits\n&quot;
<span class="lineNum">     436 </span>            :                         &quot; - `eSTART`: add empty edit with given start time. START can be\n&quot;
<span class="lineNum">     437 </span>            :                         &quot;   - `VAL`: start time in seconds (int, double, fraction), media duration used as edit duration\n&quot;
<span class="lineNum">     438 </span>            :                         &quot;   - `VAL-DUR`: start time and duration in seconds (int, double, fraction)\n&quot;
<span class="lineNum">     439 </span>            :                         &quot; - `eSTART,MEDIA[,RATE]`: add regular edit with given start, media start time in seconds (int, double, fraction) and rate (fraction or INT)\n&quot;
<span class="lineNum">     440 </span>            :                         &quot; - Examples: \n&quot;
<span class="lineNum">     441 </span>            :                         &quot;   - `re0-5e5-3,4`: remove edits, add empty edit at 0s for 5s, then add regular edit at 5s for 3s starting at 4s in media track\n&quot;
<span class="lineNum">     442 </span>            :                         &quot;   - `re0-4,0,0.5`: remove edits, add single edit at 0s for 4s starting at 0s in media track and playing at speed 0.5\n&quot;
<span class="lineNum">     443 </span>            :                                 , 0, parse_track_action, TRAC_ACTION_SET_EDITS, ARG_IS_FUN),
<span class="lineNum">     444 </span>            :         MP4BOX_ARG(&quot;moovpad&quot;, &quot;specify amount of padding to keep after moov box for later inplace editing - if 0, moov padding is disabled&quot;, GF_ARG_INT, GF_ARG_HINT_EXPERT, &amp;moov_pading, 0, ARG_NEED_SAVE),
<span class="lineNum">     445 </span>            :         MP4BOX_ARG(&quot;no-inplace&quot;, &quot;disable inplace rewrite&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;no_inplace, 0, 0),
<span class="lineNum">     446 </span>            :         MP4BOX_ARG(&quot;hdr&quot;, &quot;update HDR information based on given XML&quot;, GF_ARG_STRING, GF_ARG_HINT_EXPERT, &amp;high_dynamc_range_filename, 0, ARG_OPEN_EDIT),
<span class="lineNum">     447 </span>            :         MP4BOX_ARG_S(&quot;time&quot;, &quot;[tkID=]DAY/MONTH/YEAR-H:M:S&quot;, &quot;set movie or track creation time&quot;, GF_ARG_HINT_EXPERT, parse_track_action, TRAC_ACTION_SET_TIME, ARG_IS_FUN),
<span class="lineNum">     448 </span>            :         MP4BOX_ARG_S(&quot;mtime&quot;, &quot;tkID=DAY/MONTH/YEAR-H:M:S&quot;, &quot;set media creation time&quot;, GF_ARG_HINT_EXPERT, parse_track_action, TRAC_ACTION_SET_MEDIA_TIME, ARG_IS_FUN),
<span class="lineNum">     449 </span>            :         {0}
<a name="450"><span class="lineNum">     450 </span>            : };</a>
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span><span class="lineCov">          4 : void PrintGeneralUsage()</span>
<span class="lineNum">     453 </span>            : {
<span class="lineNum">     454 </span>            :         u32 i=0;
<span class="lineNum">     455 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# General Options\n&quot;</span>
<span class="lineNum">     456 </span>            :                 &quot;MP4Box is a multimedia packager, with a vast number of functionalities: conversion, splitting, hinting, dumping, DASH-ing, encryption, transcoding and others.\n&quot;
<span class="lineNum">     457 </span>            :                 &quot;MP4Box provides a large set of options, classified by categories (see [-h]()). These options do not follow any particular ordering.\n&quot;
<span class="lineNum">     458 </span>            :                 &quot;MP4Box performs in-place rewrite of IsoMedia files (the input file is overwritten). You can change this behavior by using the [-out]() option.\n&quot;
<span class="lineNum">     459 </span>            :                 &quot;MP4Box stores by default the file with 0.5 second interleaving and meta-data (`moov` ...) at the beginning, making it suitable for HTTP streaming. This may however takes longer to store the file, use [-flat]() to change this behavior.\n&quot;
<span class="lineNum">     460 </span>            :                 &quot;MP4Box usually generates a temporary file when creating a new IsoMedia file. The location of this temporary file is OS-dependent, and it may happen that the drive/partition the temporary file is created on has not enough space or no write access. In such a case, you can specify a temporary file location with [-tmp]().\n&quot;
<span class="lineNum">     461 </span>            :                 &quot;Note: Track operations identify tracks through their ID (usually referred to as tkID in the help), not their order.\n&quot;
<span class="lineNum">     462 </span>            :                 &quot;Option values:\n&quot;
<span class="lineNum">     463 </span>            :                 &quot;Unless specified otherwise, an option of type `integer` expects a trackID value following it.&quot;
<span class="lineNum">     464 </span>            :                 &quot;An option of type `boolean` expects no following value.&quot;
<span class="lineNum">     465 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     466 </span>            :         );
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span><span class="lineCov">        252 :         while (m4b_gen_args[i].name) {</span>
<span class="lineNum">     470 </span><span class="lineCov">        244 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_gen_args[i];</span>
<span class="lineNum">     471 </span><span class="lineCov">        244 :                 i++;</span>
<span class="lineNum">     472 </span><span class="lineCov">        244 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-gen&quot;);</span>
<span class="lineNum">     473 </span>            :         }
<span class="lineNum">     474 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span>            : MP4BoxArg m4b_split_args[] =
<span class="lineNum">     478 </span>            : {
<span class="lineNum">     479 </span>            :         MP4BOX_ARG(&quot;split&quot;, &quot;split in files of given max duration&quot;, GF_ARG_STRING, 0, parse_split, 0, ARG_IS_FUN),
<span class="lineNum">     480 </span>            :         MP4BOX_ARG_ALT(&quot;split-rap&quot;, &quot;splitr&quot;, &quot;split in files at each new RAP&quot;, GF_ARG_STRING, 0, parse_split, 1, ARG_IS_FUN),
<span class="lineNum">     481 </span>            :         MP4BOX_ARG_ALT(&quot;split-size&quot;, &quot;splits&quot;, &quot;split in files of given max size (in kb)&quot;, GF_ARG_STRING, 0, parse_split, 2, ARG_IS_FUN),
<span class="lineNum">     482 </span>            :         MP4BOX_ARG_ALT(&quot;split-chunk&quot;, &quot;splitx&quot;, &quot;extract the specified time range formatted as:\n&quot;
<span class="lineNum">     483 </span>            :         &quot;- `S:E` or `S-E`: `S` start time and `E` end time in seconds (int, double, fraction)\n&quot;
<span class="lineNum">     484 </span>            :         &quot;- `S:end` or `S:end-N`: `S` start time in seconds (int, double), `N` number of seconds (int, double) before the end\n&quot;
<span class="lineNum">     485 </span>            :         &quot;- `S-E`: start and end dates, each formatted as `HH:MM:SS.ms` or `MM:SS.ms`&quot;, GF_ARG_STRING, 0, parse_split, 3, ARG_IS_FUN),
<span class="lineNum">     486 </span>            :         MP4BOX_ARG(&quot;splitz&quot;, &quot;same as -splitx, but adjust range times so that ranges `A:B` and `B:C` share exactly the same boundary `B`:\n&quot;
<span class="lineNum">     487 </span>            :         &quot;- the start time is moved to the RAP sample at or after the specified start time\n&quot;
<span class="lineNum">     488 </span>            :         &quot;- the end time is moved to the frame preceeding the RAP sample at or following the specified end time&quot;
<span class="lineNum">     489 </span>            :         , GF_ARG_STRING, 0, parse_split, 4, ARG_IS_FUN),
<span class="lineNum">     490 </span>            :         MP4BOX_ARG(&quot;splitg&quot;, &quot;same as -splitx, but adjust range times so that:\n&quot;
<span class="lineNum">     491 </span>            :         &quot;- the start time is moved to the RAP sample at or before the specified start time\n&quot;
<span class="lineNum">     492 </span>            :         &quot;- the end time is moved to the frame preceeding the RAP sample at or following the specified end time&quot;
<span class="lineNum">     493 </span>            :         , GF_ARG_STRING, 0, parse_split, 5, ARG_IS_FUN),
<span class="lineNum">     494 </span>            :         MP4BOX_ARG(&quot;splitf&quot;, &quot;same as -splitx but insert edits such that the extracted output is exactly the specified range\n&quot;, GF_ARG_STRING, 0, parse_split, 6, ARG_IS_FUN),
<span class="lineNum">     495 </span>            :         {0}
<span class="lineNum">     496 </span>            : };
<a name="497"><span class="lineNum">     497 </span>            : </a>
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span><span class="lineCov">          3 : static void PrintSplitUsage()</span>
<span class="lineNum">     500 </span>            : {
<span class="lineNum">     501 </span>            :         u32 i=0;
<span class="lineNum">     502 </span><span class="lineCov">          3 :         gf_sys_format_help(helpout, help_flags, &quot;  \n&quot;</span>
<span class="lineNum">     503 </span>            :                 &quot;# File splitting\n&quot;
<span class="lineNum">     504 </span>            :                 &quot;MP4Box can split input files by size, duration or extract a given part of the file to new IsoMedia file(s).\n&quot;
<span class="lineNum">     505 </span>            :                 &quot;This requires that at most one track in the input file has non random-access points (typically one video track at most).\n&quot;
<span class="lineNum">     506 </span>            :                 &quot;Splitting will ignore all MPEG-4 Systems tracks and hint tracks, but will try to split private media tracks.\n&quot;
<span class="lineNum">     507 </span>            :                 &quot;The input file must have enough random access points in order to be split. If this is not the case, you will have to re-encode the content.\n&quot;
<span class="lineNum">     508 </span>            :                 &quot;You can add media to a file and split it in the same pass. In this case, the destination file (the one which would be obtained without splitting) will not be stored.\n&quot;
<span class="lineNum">     509 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     510 </span>            :                 &quot;MP4Box splitting runs a filter session using the `reframer` filter as follows:\n&quot;
<span class="lineNum">     511 </span>            :                 &quot;- `splitrange` option of the reframer is always set\n&quot;
<span class="lineNum">     512 </span>            :                 &quot;- source is demuxed with `alltk` option set\n&quot;
<span class="lineNum">     513 </span>            :                 &quot;- start and end ranges are passed to `xs` and `xe` options of the reframer\n&quot;
<span class="lineNum">     514 </span>            :                 &quot;- for `-splitz`, options `xadjust` and `xround=after` are enforced\n&quot;
<span class="lineNum">     515 </span>            :                 &quot;- for `-splitg`, options `xadjust` and `xround=before` are enforced\n&quot;
<span class="lineNum">     516 </span>            :                 &quot;- for `-splitf`, option `xround=seek` is enforced and `propbe_ref`set if not specified at prompt\n&quot;
<span class="lineNum">     517 </span>            :                 &quot;- for `-splitx`, option `xround=closest` and `propbe_ref` are enforced if not specified at prompt\n&quot;
<span class="lineNum">     518 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     519 </span>            :         );
<span class="lineNum">     520 </span>            : 
<span class="lineNum">     521 </span>            :         i=0;
<span class="lineNum">     522 </span><span class="lineCov">         27 :         while (m4b_split_args[i].name) {</span>
<span class="lineNum">     523 </span><span class="lineCov">         21 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_split_args[i];</span>
<span class="lineNum">     524 </span><span class="lineCov">         21 :                 i++;</span>
<span class="lineNum">     525 </span><span class="lineCov">         21 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-split&quot;);</span>
<span class="lineNum">     526 </span>            :         }
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span><span class="lineCov">          3 : }</span>
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span>            : MP4BoxArg m4b_dash_args[] =
<span class="lineNum">     532 </span>            : {
<span class="lineNum">     533 </span>            :         MP4BOX_ARG (&quot;dash&quot;, &quot;create DASH from input files with given segment (subsegment for onDemand profile) duration in ms&quot;, GF_ARG_DOUBLE, 0, &amp;dash_duration, 0, ARG_NON_ZERO),
<span class="lineNum">     534 </span>            :         MP4BOX_ARG(&quot;dash-live&quot;, &quot;generate a live DASH session using the given segment duration in ms; using `-dash-live=F` will also write the live context to `F`. MP4Box will run the live session until `q` is pressed or a fatal error occurs&quot;, GF_ARG_DOUBLE, 0, parse_dashlive, 0, ARG_IS_FUN2),
<span class="lineNum">     535 </span>            :         MP4BOX_ARG(&quot;ddbg-live&quot;, &quot;same as [-dash-live]() without time regulation for debug purposes&quot;, GF_ARG_DOUBLE, 0, parse_dashlive, 1, ARG_IS_FUN2),
<span class="lineNum">     536 </span>            :         MP4BOX_ARG(&quot;frag&quot;, &quot;specify the fragment duration in ms. If not set, this is the DASH duration (one fragment per segment)&quot;, GF_ARG_DOUBLE, 0, parse_store_mode, 2, ARG_IS_FUN),
<span class="lineNum">     537 </span>            :         MP4BOX_ARG(&quot;out&quot;, &quot;specify the output MPD file name&quot;, GF_ARG_STRING, 0, &amp;outName, 0, 0),
<span class="lineNum">     538 </span>            :         MP4BOX_ARG_ALT(&quot;profile&quot;, &quot;dash-profile&quot;, &quot;specify the target DASH profile, and set default options to ensure conformance to the desired profile. Default profile is `full` in static mode, `live` in dynamic mode (old syntax using `:live` instead of `.live` as separator still possible). Defined values are onDemand, live, main, simple, full, hbbtv1.5.live, dashavc264.live, dashavc264.onDemand, dashif.ll&quot;, GF_ARG_STRING, 0, parse_dash_profile, 0, ARG_IS_FUN),
<span class="lineNum">     539 </span>            :         MP4BOX_ARG(&quot;profile-ext&quot;, &quot;specify a list of profile extensions, as used by DASH-IF and DVB. The string will be colon-concatenated with the profile used&quot;, GF_ARG_STRING, 0, &amp;dash_profile_extension, 0, 0),
<span class="lineNum">     540 </span>            :         MP4BOX_ARG(&quot;rap&quot;, &quot;ensure that segments begin with random access points, segment durations might vary depending on the source encoding&quot;, GF_ARG_BOOL, 0, parse_rap_ref, 0, ARG_IS_FUN | ARG_EMPTY),
<span class="lineNum">     541 </span>            :         MP4BOX_ARG(&quot;frag-rap&quot;, &quot;ensure that all fragments begin with random access points (duration might vary depending on the source encoding)&quot;, GF_ARG_BOOL, 0, &amp;frag_at_rap, 0, 0),
<span class="lineNum">     542 </span>            :         MP4BOX_ARG(&quot;segment-name&quot;, &quot;set the segment name for generated segments. If not set (default), segments are concatenated in output file except in `live` profile where `dash_%%s`. Supported replacement strings are:\n&quot;
<span class="lineNum">     543 </span>            :                 &quot;- $Number[%%0Nd]$ is replaced by the segment number, possibly prefixed with 0\n&quot;
<span class="lineNum">     544 </span>            :                 &quot;- $RepresentationID$ is replaced by representation name\n&quot;
<span class="lineNum">     545 </span>            :                 &quot;- $Time$ is replaced by segment start time\n&quot;
<span class="lineNum">     546 </span>            :                 &quot;- $Bandwidth$ is replaced by representation bandwidth\n&quot;
<span class="lineNum">     547 </span>            :                 &quot;- $Init=NAME$ is replaced by NAME for init segment, ignored otherwise\n&quot;
<span class="lineNum">     548 </span>            :                 &quot;- $Index=NAME$ is replaced by NAME for index segments, ignored otherwise\n&quot;
<span class="lineNum">     549 </span>            :                 &quot;- $Path=PATH$ is replaced by PATH when creating segments, ignored otherwise\n&quot;
<span class="lineNum">     550 </span>            :                 &quot;- $Segment=NAME$ is replaced by NAME for media segments, ignored for init segments&quot;, GF_ARG_STRING, 0, &amp;seg_name, 0, 0),
<span class="lineNum">     551 </span>            :         {&quot;segment-ext&quot;, NULL, &quot;set the segment extension, `null` means no extension&quot;, &quot;m4s&quot;, NULL, GF_ARG_STRING, 0, &amp;seg_ext, 0, 0},
<span class="lineNum">     552 </span>            :         {&quot;init-segment-ext&quot;, NULL, &quot;set the segment extension for init, index and bitstream switching segments, `null` means no extension\n&quot;, &quot;mp4&quot;, NULL, GF_ARG_STRING, 0, &amp;init_seg_ext, 0, 0},
<span class="lineNum">     553 </span>            :         MP4BOX_ARG(&quot;segment-timeline&quot;, &quot;use `SegmentTimeline` when generating segments&quot;, GF_ARG_BOOL, 0, &amp;segment_timeline, 0, 0),
<span class="lineNum">     554 </span>            :         MP4BOX_ARG(&quot;segment-marker&quot;, &quot;add a box of given type (4CC) at the end of each DASH segment&quot;, GF_ARG_STRING, 0, &amp;segment_marker, 0, ARG_IS_4CC),
<span class="lineNum">     555 </span>            :         MP4BOX_ARG(&quot;insert-utc&quot;, &quot;insert UTC clock at the beginning of each ISOBMF segment&quot;, GF_ARG_BOOL, 0, &amp;insert_utc, 0, 0),
<span class="lineNum">     556 </span>            :         MP4BOX_ARG(&quot;base-url&quot;, &quot;set Base url at MPD level. Can be used several times.  \nWarning: this does not  modify generated files location&quot;, GF_ARG_STRING, 0, parse_base_url, 0, ARG_IS_FUN),
<span class="lineNum">     557 </span>            :         MP4BOX_ARG(&quot;mpd-title&quot;, &quot;set MPD title&quot;, GF_ARG_STRING, 0, &amp;dash_title, 0, 0),
<span class="lineNum">     558 </span>            :         MP4BOX_ARG(&quot;mpd-source&quot;, &quot;set MPD source&quot;, GF_ARG_STRING, 0, &amp;dash_source, 0, 0),
<span class="lineNum">     559 </span>            :         MP4BOX_ARG(&quot;mpd-info-url&quot;, &quot;set MPD info url&quot;, GF_ARG_STRING, 0, &amp;dash_more_info, 0, 0),
<span class="lineNum">     560 </span>            :         MP4BOX_ARG(&quot;cprt&quot;, &quot;add copyright string to MPD&quot;, GF_ARG_STRING, GF_ARG_HINT_ADVANCED, &amp;cprt, 0, 0),
<span class="lineNum">     561 </span>            :         MP4BOX_ARG(&quot;dash-ctx&quot;, &quot;store/restore DASH timing from indicated file&quot;, GF_ARG_STRING, 0, &amp;dash_ctx_file, 0, 0),
<span class="lineNum">     562 </span>            :         MP4BOX_ARG(&quot;dynamic&quot;, &quot;use dynamic MPD type instead of static&quot;, GF_ARG_BOOL, 0, &amp;dash_mode, GF_DASH_DYNAMIC, 0),
<span class="lineNum">     563 </span>            :         MP4BOX_ARG(&quot;last-dynamic&quot;, &quot;same as [-dynamic]() but close the period (insert lmsg brand if needed and update duration)&quot;, GF_ARG_BOOL, 0, &amp;dash_mode, GF_DASH_DYNAMIC_LAST, 0),
<span class="lineNum">     564 </span>            :         MP4BOX_ARG(&quot;mpd-duration&quot;, &quot;set the duration in second of a live session (if `0`, you must use [-mpd-refresh]())&quot;, GF_ARG_DOUBLE, 0, &amp;mpd_live_duration, 0, 0),
<span class="lineNum">     565 </span>            :         MP4BOX_ARG(&quot;mpd-refresh&quot;, &quot;specify MPD update time in seconds&quot;, GF_ARG_DOUBLE, 0, &amp;mpd_update_time, 0, 0),
<span class="lineNum">     566 </span>            :         MP4BOX_ARG(&quot;time-shift&quot;, &quot;specify MPD time shift buffer depth in seconds, `-1` to keep all files)&quot;, GF_ARG_INT, 0, &amp;time_shift_depth, 0, 0),
<span class="lineNum">     567 </span>            :         MP4BOX_ARG(&quot;subdur&quot;, &quot;specify maximum duration in ms of the input file to be dashed in LIVE or context mode. This does not change the segment duration, but stops dashing once segments produced exceeded the duration. If there is not enough samples to finish a segment, data is looped unless [-no-loop]() is used which triggers a period end&quot;, GF_ARG_DOUBLE, 0, &amp;dash_subduration, 0, 0),
<span class="lineNum">     568 </span>            :         MP4BOX_ARG(&quot;run-for&quot;, &quot;run for given ms  the dash-live session then exits&quot;, GF_ARG_INT, 0, &amp;run_for, 0, 0),
<span class="lineNum">     569 </span>            :         MP4BOX_ARG(&quot;min-buffer&quot;, &quot;specify MPD min buffer time in ms&quot;, GF_ARG_INT, 0, &amp;min_buffer, 0, ARG_DIV_1000),
<span class="lineNum">     570 </span>            :         MP4BOX_ARG(&quot;ast-offset&quot;, &quot;specify MPD AvailabilityStartTime offset in ms if positive, or availabilityTimeOffset of each representation if negative&quot;, GF_ARG_INT, 0, &amp;ast_offset_ms, 0, 0),
<span class="lineNum">     571 </span>            :         MP4BOX_ARG(&quot;dash-scale&quot;, &quot;specify that timing for [-dash](),  [-dash-live](), [-subdur]() and [-do_frag]() are expressed in given timescale (units per seconds) rather than ms&quot;, GF_ARG_INT, 0, &amp;dash_scale, 0, ARG_NON_ZERO),
<span class="lineNum">     572 </span>            :         MP4BOX_ARG(&quot;mem-frags&quot;, &quot;fragmentation happens in memory rather than on disk before flushing to disk&quot;, GF_ARG_BOOL, 0, &amp;memory_frags, 0, 0),
<span class="lineNum">     573 </span>            :         MP4BOX_ARG(&quot;pssh&quot;, &quot;set pssh store mode\n&quot;
<span class="lineNum">     574 </span>            :         &quot;- v: initial movie\n&quot;
<span class="lineNum">     575 </span>            :         &quot;- f: movie fragments\n&quot;
<span class="lineNum">     576 </span>            :         &quot;- m: MPD\n&quot;
<span class="lineNum">     577 </span>            :         &quot;- mv, vm: in initial movie and MPD\n&quot;
<span class="lineNum">     578 </span>            :         &quot;- mf, fm: in movie fragments and MPD&quot;, GF_ARG_INT, 0, parse_pssh, 0, ARG_IS_FUN),
<span class="lineNum">     579 </span>            :         MP4BOX_ARG(&quot;sample-groups-traf&quot;, &quot;store sample group descriptions in traf (duplicated for each traf). If not set, sample group descriptions are stored in the initial movie&quot;, GF_ARG_BOOL, 0, &amp;samplegroups_in_traf, 0, 0),
<span class="lineNum">     580 </span>            :         MP4BOX_ARG(&quot;mvex-after-traks&quot;, &quot;store `mvex` box after `trak` boxes within the moov box. If not set, `mvex` is before&quot;, GF_ARG_BOOL, 0, &amp;mvex_after_traks, 0, 0),
<span class="lineNum">     581 </span>            :         MP4BOX_ARG(&quot;sdtp-traf&quot;, &quot;use `sdtp` box in `traf` (Smooth-like)\n&quot;
<span class="lineNum">     582 </span>            :         &quot;- no: do not use sdtp\n&quot;
<span class="lineNum">     583 </span>            :         &quot;- sdtp: use sdtp box to indicate sample dependencies and do not write info in trun sample flags\n&quot;
<span class="lineNum">     584 </span>            :         &quot;- both: use sdtp box to indicate sample dependencies and also write info in trun sample flags\n&quot;, GF_ARG_INT, 0, parse_sdtp, 0, ARG_IS_FUN),
<span class="lineNum">     585 </span>            :         MP4BOX_ARG(&quot;no-cache&quot;, &quot;disable file cache for dash inputs&quot;, GF_ARG_BOOL, 0, &amp;no_cache, 0, 0),
<span class="lineNum">     586 </span>            :         MP4BOX_ARG(&quot;no-loop&quot;, &quot;disable looping content in live mode and uses period switch instead&quot;, GF_ARG_BOOL, 0, &amp;no_loop, 0, 0),
<span class="lineNum">     587 </span>            :         MP4BOX_ARG(&quot;hlsc&quot;, &quot;insert UTC in variant playlists for live HLS&quot;, GF_ARG_BOOL, 0, &amp;hls_clock, 0, 0),
<span class="lineNum">     588 </span>            :         MP4BOX_ARG(&quot;bound&quot;, &quot;segmentation will always try to split before or at, but never after, the segment boundary&quot;, GF_ARG_BOOL, 0, &amp;dash_split_mode, GF_DASH_SPLIT_IN, 0),
<span class="lineNum">     589 </span>            :         MP4BOX_ARG(&quot;closest&quot;, &quot;segmentation will use the closest frame to the segment boundary (before or after)&quot;, GF_ARG_BOOL, 0, &amp;dash_split_mode, GF_DASH_SPLIT_CLOSEST, 0),
<span class="lineNum">     590 </span>            :         MP4BOX_ARG_ALT(&quot;subsegs-per-sidx&quot;, &quot;frags-per-sidx&quot;, &quot;set the number of subsegments to be written in each SIDX box\n&quot;
<span class="lineNum">     591 </span>            :         &quot;- 0: a single SIDX box is used per segment\n&quot;
<span class="lineNum">     592 </span>            :         &quot;- -1: no SIDX box is used&quot;, GF_ARG_INT, GF_ARG_HINT_EXPERT, &amp;subsegs_per_sidx, 0, 0),
<span class="lineNum">     593 </span>            :         MP4BOX_ARG(&quot;ssix&quot;, &quot;enable SubsegmentIndexBox describing 2 ranges, first one from moof to end of first I-frame, second one unmapped. This does not work with daisy chaining mode enabled&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;use_ssix, 0, 0),
<span class="lineNum">     594 </span>            :         MP4BOX_ARG(&quot;url-template&quot;, &quot;use SegmentTemplate instead of explicit sources in segments. Ignored if segments are stored in the output file&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;use_url_template, 1, 0),
<span class="lineNum">     595 </span>            :         MP4BOX_ARG(&quot;url-template-sim&quot;, &quot;use SegmentTemplate simulation while converting HLS to MPD&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;use_url_template, 2, 0),
<span class="lineNum">     596 </span>            :         MP4BOX_ARG(&quot;daisy-chain&quot;, &quot;use daisy-chain SIDX instead of hierarchical. Ignored if frags/sidx is 0&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;daisy_chain_sidx, 0, 0),
<span class="lineNum">     597 </span>            :         MP4BOX_ARG(&quot;single-segment&quot;, &quot;use a single segment for the whole file (OnDemand profile)&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;single_segment, 0, 0),
<span class="lineNum">     598 </span>            :         {&quot;single-file&quot;, NULL, &quot;use a single file for the whole file (default)&quot;, &quot;yes&quot;, NULL, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;single_file, 0, 0},
<span class="lineNum">     599 </span>            :         {&quot;bs-switching&quot;, NULL, &quot;set bitstream switching mode\n&quot;
<span class="lineNum">     600 </span>            :         &quot;- inband: use inband param set and a single init segment\n&quot;
<span class="lineNum">     601 </span>            :         &quot;- merge: try to merge param sets in a single sample description, fallback to `no`\n&quot;
<span class="lineNum">     602 </span>            :         &quot;- multi: use several sample description, one per quality\n&quot;
<span class="lineNum">     603 </span>            :         &quot;- no: use one init segment per quality\n&quot;
<span class="lineNum">     604 </span>            :         &quot;- single: to test with single input&quot;, &quot;inband&quot;, &quot;inband|merge|multi|no|single&quot;, GF_ARG_STRING, GF_ARG_HINT_EXPERT, parse_bs_switch, 0, ARG_IS_FUN},
<span class="lineNum">     605 </span>            :         MP4BOX_ARG(&quot;moof-sn&quot;, &quot;set sequence number of first moof to given value&quot;, GF_ARG_INT, GF_ARG_HINT_EXPERT, &amp;initial_moof_sn, 0, 0),
<span class="lineNum">     606 </span>            :         MP4BOX_ARG(&quot;tfdt&quot;, &quot;set TFDT of first traf to given value in SCALE units (cf -dash-scale)&quot;, GF_ARG_INT, GF_ARG_HINT_EXPERT, &amp;initial_tfdt, 0, ARG_64BITS),
<span class="lineNum">     607 </span>            :         MP4BOX_ARG(&quot;no-frags-default&quot;, &quot;disable default fragments flags in trex (required by some dash-if profiles and CMAF/smooth streaming compatibility)&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;no_fragments_defaults, 0, 0),
<span class="lineNum">     608 </span>            :         MP4BOX_ARG(&quot;single-traf&quot;, &quot;use a single track fragment per moof (smooth streaming and derived specs may require this)&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;single_traf_per_moof, 0, 0),
<span class="lineNum">     609 </span>            :         MP4BOX_ARG(&quot;tfdt-traf&quot;, &quot;use a tfdt per track fragment (when -single-traf is used)&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;tfdt_per_traf, 0, 0),
<span class="lineNum">     610 </span>            :         MP4BOX_ARG(&quot;dash-ts-prog&quot;, &quot;program_number to be considered in case of an MPTS input file&quot;, GF_ARG_INT, GF_ARG_HINT_EXPERT, &amp;program_number, 0, 0),
<span class="lineNum">     611 </span>            :         MP4BOX_ARG(&quot;frag-rt&quot;, &quot;when using fragments in live mode, flush fragments according to their timing&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;frag_real_time, 0, 0),
<span class="lineNum">     612 </span>            :         MP4BOX_ARG(&quot;cp-location&quot;, &quot;set ContentProtection element location\n&quot;
<span class="lineNum">     613 </span>            :                 &quot;- as: sets ContentProtection in AdaptationSet element\n&quot;
<span class="lineNum">     614 </span>            :                 &quot;- rep: sets ContentProtection in Representation element\n&quot;
<span class="lineNum">     615 </span>            :                 &quot;- both: sets ContentProtection in both elements&quot;, GF_ARG_STRING, GF_ARG_HINT_EXPERT, parse_cp_loc, 0, ARG_IS_FUN),
<span class="lineNum">     616 </span>            :         MP4BOX_ARG(&quot;start-date&quot;, &quot;for live mode, set start date (as xs:date, eg YYYY-MM-DDTHH:MM:SSZ). Default is current UTC\n&quot;
<span class="lineNum">     617 </span>            :         &quot;Warning: Do not use with multiple periods, nor when DASH duration is not a multiple of GOP size&quot;, GF_ARG_STRING, GF_ARG_HINT_EXPERT, &amp;dash_start_date, 0, 0),
<span class="lineNum">     618 </span>            :         MP4BOX_ARG(&quot;cues&quot;, &quot;ignore dash duration and segment according to cue times in given XML file (tests/media/dash_cues for examples)&quot;, GF_ARG_STRING, GF_ARG_HINT_EXPERT, &amp;dash_cues, 0, 0),
<span class="lineNum">     619 </span>            :         MP4BOX_ARG(&quot;strict-cues&quot;, &quot;throw error if something is wrong while parsing cues or applying cue-based segmentation&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;strict_cues, 0, 0),
<span class="lineNum">     620 </span>            :         MP4BOX_ARG(&quot;merge-last-seg&quot;, &quot;merge last segment if shorter than half the target duration&quot;, GF_ARG_BOOL, GF_ARG_HINT_EXPERT, &amp;merge_last_seg, 0, 0),
<span class="lineNum">     621 </span>            :         {0}
<a name="622"><span class="lineNum">     622 </span>            : };</a>
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span><span class="lineCov">          4 : void PrintDASHUsage()</span>
<span class="lineNum">     625 </span>            : {
<span class="lineNum">     626 </span>            :         u32 i=0;
<span class="lineNum">     627 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# DASH Options\n&quot;</span>
<span class="lineNum">     628 </span>            :                 &quot;Also see:\n&quot;
<span class="lineNum">     629 </span>            :                 &quot;- the [dasher `gpac -h dash`](dasher) filter documentation\n&quot;
<span class="lineNum">     630 </span>            :                 &quot;- [[DASH wiki|DASH-intro]].\n&quot;
<span class="lineNum">     631 </span>            :                 &quot;\n&quot;
<span class="lineNum">     632 </span>            :                 &quot;# Specifying input files\n&quot;
<span class="lineNum">     633 </span>            :                 &quot;Input media files to dash can use the following modifiers\n&quot;
<span class="lineNum">     634 </span>            :                 &quot;- #trackID=N: only use the track ID N from the source file\n&quot;
<span class="lineNum">     635 </span>            :                 &quot;- #N: only use the track ID N from the source file (mapped to [-tkid](mp4dmx))\n&quot;
<span class="lineNum">     636 </span>            :                 &quot;- #video: only use the first video track from the source file\n&quot;
<span class="lineNum">     637 </span>            :                 &quot;- #audio: only use the first audio track from the source file\n&quot;
<span class="lineNum">     638 </span>            :                 &quot;- :id=NAME: set the representation ID to NAME. Reserved value `NULL` disables representation ID for multiplexed inputs. If not set, a default value is computed and all selected tracks from the source will be in the same output mux.\n&quot;
<span class="lineNum">     639 </span>            :                 &quot;- :dur=VALUE: process VALUE seconds (fraction) from the media. If VALUE is longer than media duration, last sample duration is extended.\n&quot;
<span class="lineNum">     640 </span>            :                 &quot;- :period=NAME: set the representation's period to NAME. Multiple periods may be used. Periods appear in the MPD in the same order as specified with this option\n&quot;
<span class="lineNum">     641 </span>            :                 &quot;- :BaseURL=NAME: set the BaseURL. Set multiple times for multiple BaseURLs\nWarning: This does not modify generated files location (see segment template).\n&quot;
<span class="lineNum">     642 </span>            :                 &quot;- :bandwidth=VALUE: set the representation's bandwidth to a given value\n&quot;
<span class="lineNum">     643 </span>            :                 &quot;- :pdur=VALUE: sets the duration of the associated period to VALUE seconds (fraction) (alias for period_duration:VALUE). This is only used when no input media is specified (remote period insertion), eg `:period=X:xlink=Z:pdur=Y`\n&quot;
<span class="lineNum">     644 </span>            :                 &quot;- :ddur=VALUE: override target DASH segment duration to VALUE seconds (fraction) for this input (alias for duration:VALUE)\n&quot;
<span class="lineNum">     645 </span>            :                 &quot;- :xlink=VALUE: set the xlink value for the period containing this element. Only the xlink declared on the first rep of a period will be used\n&quot;
<span class="lineNum">     646 </span>            :                 &quot;- :asID=VALUE: set the AdaptationSet ID to NAME\n&quot;
<span class="lineNum">     647 </span>            :                 &quot;- :role=VALUE: set the role of this representation (cf DASH spec). Media with different roles belong to different adaptation sets.\n&quot;
<span class="lineNum">     648 </span>            :                 &quot;- :desc_p=VALUE: add a descriptor at the Period level. Value must be a properly formatted XML element.\n&quot;
<span class="lineNum">     649 </span>            :                 &quot;- :desc_as=VALUE: add a descriptor at the AdaptationSet level. Value must be a properly formatted XML element. Two input files with different values will be in different AdaptationSet elements.\n&quot;
<span class="lineNum">     650 </span>            :                 &quot;- :desc_as_c=VALUE: add a descriptor at the AdaptationSet level. Value must be a properly formatted XML element. Value is ignored while creating AdaptationSet elements.\n&quot;
<span class="lineNum">     651 </span>            :                 &quot;- :desc_rep=VALUE: add a descriptor at the Representation level. Value must be a properly formatted XML element. Value is ignored while creating AdaptationSet elements.\n&quot;
<span class="lineNum">     652 </span>            :                 &quot;- :sscale: force movie timescale to match media timescale of the first track in the segment.\n&quot;
<span class="lineNum">     653 </span>            :                 &quot;- :trackID=N: only use the track ID N from the source file\n&quot;
<span class="lineNum">     654 </span>            :                 &quot;- @f1[:args][@fN:args][@@fK:args]: set a filter chain to insert between the source and the dasher. Each filter in the chain is formatted as a regular filter, see [filter doc `gpac -h doc`](filters_general). If several filters are set:\n&quot;
<span class="lineNum">     655 </span>            :                 &quot;  - they will be chained in the given order if separated by a single `@`\n&quot;
<span class="lineNum">     656 </span>            :                 &quot;  - a new filter chain will be created if separated by a double `@@`. In this case, no representation ID is assigned to the source.\n&quot;
<span class="lineNum">     657 </span>            :                 &quot;EX source.mp4:@enc:c=avc:b=1M@@enc:c=avc:b=500k\n&quot;
<span class="lineNum">     658 </span>            :                 &quot;This will load a filter chain with two encoders connected to the source and to the dasher.\n&quot;
<span class="lineNum">     659 </span>            :                 &quot;EX source.mp4:@enc:c=avc:b=1M@enc:c=avc:b=500k\n&quot;
<span class="lineNum">     660 </span>            :                 &quot;This will load a filter chain with the second encoder connected to the output of the first (!!).\n&quot;
<span class="lineNum">     661 </span>            :                 &quot;\n&quot;
<span class="lineNum">     662 </span>            :                 &quot;Note: `@f` must be placed after all other options.\n&quot;
<span class="lineNum">     663 </span>            :                 &quot;\n&quot;
<span class="lineNum">     664 </span>            :                 &quot;# Options\n&quot;
<span class="lineNum">     665 </span>            :                 );
<span class="lineNum">     666 </span>            : 
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span><span class="lineCov">        252 :         while (m4b_dash_args[i].name) {</span>
<span class="lineNum">     669 </span><span class="lineCov">        244 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_dash_args[i];</span>
<span class="lineNum">     670 </span><span class="lineCov">        244 :                 i++;</span>
<span class="lineNum">     671 </span><span class="lineCov">        244 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-dash&quot;);</span>
<span class="lineNum">     672 </span>            :         }
<span class="lineNum">     673 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span>            : 
<span class="lineNum">     676 </span>            : MP4BoxArg m4b_imp_args[] =
<span class="lineNum">     677 </span>            : {
<span class="lineNum">     678 </span>            :         MP4BOX_ARG(&quot;add&quot;, &quot;add given file tracks to file. Multiple inputs can be specified using `+`, eg `-add url1+url2`&quot;, GF_ARG_STRING, 0, &amp;nb_add, 0, ARG_INT_INC),
<span class="lineNum">     679 </span>            :         MP4BOX_ARG(&quot;cat&quot;, &quot;concatenate given file samples to file, creating tracks if needed. Multiple inputs can be specified using `+`, eg `-cat url1+url2`.  \nNote: This aligns initial timestamp of the file to be concatenated&quot;, GF_ARG_STRING, 0, &amp;nb_cat, 0, ARG_INT_INC),
<span class="lineNum">     680 </span>            :         MP4BOX_ARG(&quot;catx&quot;, &quot;same as [-cat]() but new tracks can be imported before concatenation by specifying `+ADD_COMMAND` where `ADD_COMMAND` is a regular [-add]() syntax&quot;, GF_ARG_STRING, 0, &amp;nb_cat, 0, ARG_INT_INC),
<span class="lineNum">     681 </span>            :         MP4BOX_ARG(&quot;catpl&quot;, &quot;concatenate files listed in the given playlist file (one file per line, lines starting with # are comments).  \nNote: Each listed file is concatenated as if called with -cat&quot;, GF_ARG_STRING, 0, &amp;nb_cat, 0, ARG_INT_INC),
<span class="lineNum">     682 </span>            :         MP4BOX_ARG(&quot;unalign-cat&quot;, &quot;do not attempt to align timestamps of samples in-between tracks&quot;, GF_ARG_BOOL, 0, &amp;align_cat, 0, ARG_BOOL_REV),
<span class="lineNum">     683 </span>            :         MP4BOX_ARG(&quot;force-cat&quot;, &quot;skip media configuration check when concatenating file.  \nWarning: THIS MAY BREAK THE CONCATENATED TRACK(S)&quot;, GF_ARG_BOOL, 0, &amp;force_cat, 0, 0),
<span class="lineNum">     684 </span>            :         MP4BOX_ARG(&quot;keep-sys&quot;, &quot;keep all MPEG-4 Systems info when using [-add]() and [-cat]() (only used when adding IsoMedia files)&quot;, GF_ARG_BOOL, 0, &amp;keep_sys_tracks, 0, 0),
<span class="lineNum">     685 </span>            :         MP4BOX_ARG(&quot;dref&quot;, &quot;keep media data in original file using `data referencing`. The resulting file only contains the meta-data of the presentation (frame sizes, timing, etc...) and references media data in the original file. This is extremely useful when developing content, since importing and storage of the MP4 file is much faster and the resulting file much smaller.  \nNote: Data referencing may fail on some files because it requires the framed data (eg an IsoMedia sample) to be continuous in the original file, which is not always the case depending on the original interleaving or bitstream format (__AVC__ or __HEVC__ cannot use this option)&quot;, GF_ARG_BOOL, 0, &amp;import_flags, GF_IMPORT_USE_DATAREF, ARG_BIT_MASK),
<span class="lineNum">     686 </span>            :         MP4BOX_ARG_ALT(&quot;no-drop&quot;, &quot;nodrop&quot;, &quot;force constant FPS when importing AVI video&quot;, GF_ARG_BOOL, 0, &amp;import_flags, GF_IMPORT_NO_FRAME_DROP, ARG_BIT_MASK),
<span class="lineNum">     687 </span>            :         MP4BOX_ARG(&quot;packed&quot;, &quot;force packed bitstream when importing raw MPEG-4 part 2 Advanced Simple Profile&quot;, GF_ARG_BOOL, 0, &amp;import_flags, GF_IMPORT_FORCE_PACKED, ARG_BIT_MASK),
<span class="lineNum">     688 </span>            :         MP4BOX_ARG(&quot;sbr&quot;, &quot;backward compatible signaling of AAC-SBR&quot;, GF_ARG_BOOL, 0, &amp;import_flags, GF_IMPORT_SBR_IMPLICIT, ARG_BIT_MASK),
<span class="lineNum">     689 </span>            :         MP4BOX_ARG(&quot;sbrx&quot;, &quot;non-backward compatible signaling of AAC-SBR&quot;, GF_ARG_BOOL, 0, &amp;import_flags, GF_IMPORT_SBR_EXPLICIT, ARG_BIT_MASK),
<span class="lineNum">     690 </span>            :         MP4BOX_ARG(&quot;ps&quot;, &quot;backward compatible signaling of AAC-PS&quot;, GF_ARG_BOOL, 0, &amp;import_flags, GF_IMPORT_PS_IMPLICIT, ARG_BIT_MASK),
<span class="lineNum">     691 </span>            :         MP4BOX_ARG(&quot;psx&quot;, &quot;non-backward compatible signaling of AAC-PS&quot;, GF_ARG_BOOL, 0, &amp;import_flags, GF_IMPORT_PS_EXPLICIT, ARG_BIT_MASK),
<span class="lineNum">     692 </span>            :         MP4BOX_ARG(&quot;ovsbr&quot;, &quot;oversample SBR import (SBR AAC, PS AAC and oversampled SBR cannot be detected at import time)&quot;, GF_ARG_BOOL, 0, &amp;import_flags, GF_IMPORT_OVSBR, ARG_BIT_MASK),
<span class="lineNum">     693 </span>            :         MP4BOX_ARG(&quot;fps&quot;, &quot;force frame rate for video and SUB subtitles import to the given value, expressed as a number, as `TS-inc` or `TS/inc`.  \nNote: For raw H263 import, default FPS is `15`, otherwise `25`. This is ignored for ISOBMFF import, use `:rescale` option for that&quot;, GF_ARG_STRING, 0, parse_fps, 0, ARG_IS_FUN),
<span class="lineNum">     694 </span>            :         MP4BOX_ARG(&quot;mpeg4&quot;, &quot;force MPEG-4 sample descriptions when possible. For AAC, forces MPEG-4 AAC signaling even if MPEG-2&quot;, GF_ARG_BOOL, 0, &amp;import_flags, GF_IMPORT_FORCE_MPEG4, ARG_BIT_MASK),
<span class="lineNum">     695 </span>            :         MP4BOX_ARG(&quot;agg&quot;, &quot;aggregate N audio frames in 1 sample (3GP media only, maximum value is 15)&quot;, GF_ARG_INT, 0, &amp;agg_samples, 0, 0),
<span class="lineNum">     696 </span>            :         {0}
<span class="lineNum">     697 </span>            : };
<span class="lineNum">     698 </span>            : 
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span>            : static MP4BoxArg m4b_imp_fileopt_args [] = {
<span class="lineNum">     701 </span>            :         GF_DEF_ARG(&quot;dur&quot;, NULL, &quot;`XC` import only the specified duration from the media. Value can be:\n&quot;
<span class="lineNum">     702 </span>            :                 &quot;  - positive float: specifies duration in seconds\n&quot;
<span class="lineNum">     703 </span>            :                 &quot;  - fraction: specifies duration as NUM/DEN fraction\n&quot;
<span class="lineNum">     704 </span>            :                 &quot;  - negative integer: specifies duration in number of coded frames&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     705 </span>            :         GF_DEF_ARG(&quot;start&quot;, NULL, &quot;`C` target start time in source media, may not be supported depending on the source&quot;, NULL, NULL, GF_ARG_DOUBLE, 0),
<span class="lineNum">     706 </span>            :         GF_DEF_ARG(&quot;lang&quot;, NULL, &quot;`S` set imported media language code&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     707 </span>            :         GF_DEF_ARG(&quot;delay&quot;, NULL, &quot;`S` set imported media initial delay (&gt;0) or initial skip (&lt;0) in ms or as fractional seconds (`N/D`)&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     708 </span>            :         GF_DEF_ARG(&quot;par&quot;, NULL, &quot;`S` set visual pixel aspect ratio (see [-par](MP4B_GEN) )&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     709 </span>            :         GF_DEF_ARG(&quot;clap&quot;, NULL, &quot;`S` set visual clean aperture (see [-clap](MP4B_GEN) )&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     710 </span>            :         GF_DEF_ARG(&quot;mx&quot;, NULL, &quot;`S` set track matrix (see [-mx](MP4B_GEN) )&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     711 </span>            :         GF_DEF_ARG(&quot;name&quot;, NULL, &quot;`S` set track handler name&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     712 </span>            :         GF_DEF_ARG(&quot;ext&quot;, NULL, &quot;override file extension when importing&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     713 </span>            :         GF_DEF_ARG(&quot;hdlr&quot;, NULL, &quot;`S` set track handler type to the given code point (4CC)&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     714 </span>            :         GF_DEF_ARG(&quot;tkhd&quot;, NULL, &quot;`S` set track header flags has hex integer. Use `tkhd+=FLAGS` to add flags and `tkhd-=FLAGS` to remove flags&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     715 </span>            :         GF_DEF_ARG(&quot;disable&quot;, NULL, &quot;`S` disable imported track(s), use `disable=no` to force enabling a disabled track&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     716 </span>            :         GF_DEF_ARG(&quot;group&quot;, NULL, &quot;`S` add the track as part of the G alternate group. If G is 0, the first available GroupID will be picked&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     717 </span>            :         GF_DEF_ARG(&quot;fps&quot;, NULL, &quot;same as [-fps]()&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     718 </span>            :         GF_DEF_ARG(&quot;rap&quot;, NULL, &quot;`DS` import only RAP samples&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     719 </span>            :         GF_DEF_ARG(&quot;refs&quot;, NULL, &quot;`DS` import only reference pictures&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     720 </span>            :         GF_DEF_ARG(&quot;trailing&quot;, NULL, &quot;keep trailing 0-bytes in AVC/HEVC samples&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     721 </span>            :         GF_DEF_ARG(&quot;agg&quot;, NULL, &quot;`X` same as [-agg]()&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     722 </span>            :         GF_DEF_ARG(&quot;dref&quot;, NULL, &quot;`XC` same as [-dref]()&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     723 </span>            :         GF_DEF_ARG(&quot;keep_refs&quot;, NULL, &quot;`C` keep track reference when importing a single track&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     724 </span>            :         GF_DEF_ARG(&quot;nodrop&quot;, NULL, &quot;same as [-nodrop]()&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     725 </span>            :         GF_DEF_ARG(&quot;packed&quot;, NULL, &quot;`X` same as [-packed]()&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     726 </span>            :         GF_DEF_ARG(&quot;sbr&quot;, NULL, &quot;same as [-sbr]()&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     727 </span>            :         GF_DEF_ARG(&quot;sbrx&quot;, NULL, &quot;same as [-sbrx]()&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     728 </span>            :         GF_DEF_ARG(&quot;ovsbr&quot;, NULL, &quot;same as [-ovsbr]()&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     729 </span>            :         GF_DEF_ARG(&quot;ps&quot;, NULL, &quot;same as [-ps]()&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     730 </span>            :         GF_DEF_ARG(&quot;psx&quot;, NULL, &quot;same as [-psx]()&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     731 </span>            :         GF_DEF_ARG(&quot;asemode&quot;, NULL, &quot;`XS` set the mode to create the AudioSampleEntry. Value can be:\n&quot;
<span class="lineNum">     732 </span>            :                 &quot;  - v0-bs: use MPEG AudioSampleEntry v0 and the channel count from the bitstream (even if greater than 2) - default\n&quot;
<span class="lineNum">     733 </span>            :                 &quot;  - v0-2: use MPEG AudioSampleEntry v0 and the channel count is forced to 2\n&quot;
<span class="lineNum">     734 </span>            :                 &quot;  - v1: use MPEG AudioSampleEntry v1 and the channel count from the bitstream\n&quot;
<span class="lineNum">     735 </span>            :                 &quot;  - v1-qt: use QuickTime Sound Sample Description Version 1 and the channel count from the bitstream (even if greater than 2). This will also trigger using alis data references instead of url, even for non-audio tracks&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     736 </span>            :         GF_DEF_ARG(&quot;audio_roll&quot;, NULL, &quot;`S` add a roll sample group with roll_distance `N` for audio tracks&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     737 </span>            :         GF_DEF_ARG(&quot;roll&quot;, NULL, &quot;`S` add a roll sample group with roll_distance `N`&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     738 </span>            :         GF_DEF_ARG(&quot;proll&quot;, NULL, &quot;`S` add a preroll sample group with roll_distance `N`&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     739 </span>            :         GF_DEF_ARG(&quot;mpeg4&quot;, NULL, &quot;`X` same as [-mpeg4]() option&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     740 </span>            :         GF_DEF_ARG(&quot;nosei&quot;, NULL, &quot;discard all SEI messages during import&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     741 </span>            :         GF_DEF_ARG(&quot;svc&quot;, NULL, &quot;import SVC/LHVC with explicit signaling (no AVC base compatibility)&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     742 </span>            :         GF_DEF_ARG(&quot;nosvc&quot;, NULL, &quot;discard SVC/LHVC data when importing&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     743 </span>            :         GF_DEF_ARG(&quot;svcmode&quot;, NULL, &quot;`DS` set SVC/LHVC import mode. Value can be:\n&quot;
<span class="lineNum">     744 </span>            :                 &quot;  - split: each layer is in its own track\n&quot;
<span class="lineNum">     745 </span>            :                 &quot;  - merge: all layers are merged in a single track\n&quot;
<span class="lineNum">     746 </span>            :                 &quot;  - splitbase: all layers are merged in a track, and the AVC base in another\n&quot;
<span class="lineNum">     747 </span>            :                 &quot;  - splitnox: each layer is in its own track, and no extractors are written\n&quot;
<span class="lineNum">     748 </span>            :                 &quot;  - splitnoxib: each layer is in its own track, no extractors are written, using inband param set signaling&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     749 </span>            :         GF_DEF_ARG(&quot;temporal&quot;, NULL, &quot;`DS` set HEVC/LHVC temporal sublayer import mode. Value can be:\n&quot;
<span class="lineNum">     750 </span>            :                 &quot;  - split: each sublayer is in its own track\n&quot;
<span class="lineNum">     751 </span>            :                 &quot;  - splitbase: all sublayers are merged in a track, and the HEVC base in another\n&quot;
<span class="lineNum">     752 </span>            :                 &quot;  - splitnox: each layer is in its own track, and no extractors are written&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     753 </span>            :         GF_DEF_ARG(&quot;subsamples&quot;, NULL, &quot;add SubSample information for AVC+SVC&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     754 </span>            :         GF_DEF_ARG(&quot;deps&quot;, NULL, &quot;import sample dependency information for AVC and HEVC&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     755 </span>            :         GF_DEF_ARG(&quot;ccst&quot;, NULL, &quot;`S` add default HEIF ccst box to visual sample entry&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     756 </span>            :         GF_DEF_ARG(&quot;forcesync&quot;, NULL, &quot;force non IDR samples with I slices (OpenGOP or GDR) to be marked as sync points\n&quot;
<span class="lineNum">     757 </span>            :                 &quot;Warning: RESULTING FILE IS NOT COMPLIANT WITH THE SPEC but will fix seeking in most players&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     758 </span>            :         GF_DEF_ARG(&quot;xps_inband&quot;, NULL, &quot;`XC` set xPS inband for AVC/H264 and HEVC (for reverse operation, re-import from raw media)&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     759 </span>            :         GF_DEF_ARG(&quot;xps_inbandx&quot;, NULL, &quot;`XC` same as xps_inband and also keep first xPS in sample description&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     760 </span>            :         GF_DEF_ARG(&quot;au_delim&quot;, NULL, &quot;keep AU delimiter NAL units in the imported file&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     761 </span>            :         GF_DEF_ARG(&quot;max_lid&quot;, NULL, &quot;set HEVC max layer ID to be imported to `N` (by default imports all layers)&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     762 </span>            :         GF_DEF_ARG(&quot;max_tid&quot;, NULL, &quot;set HEVC max temporal ID to be imported to `N` (by default imports all temporal sublayers)&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     763 </span>            :         GF_DEF_ARG(&quot;tiles&quot;, NULL, &quot;`S` add HEVC tiles signaling and NALU maps without splitting the tiles into different tile tracks&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     764 </span>            :         GF_DEF_ARG(&quot;split_tiles&quot;, NULL, &quot;`DS` split HEVC tiles into different tile tracks, one tile (or all tiles of one slice) per track&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     765 </span>            :         GF_DEF_ARG(&quot;negctts&quot;, NULL, &quot;`S` use negative CTS-DTS offsets (ISO4 brand). Use `negctts=no` to force using positive offset on existing track&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     766 </span>            :         GF_DEF_ARG(&quot;chap&quot;, NULL, &quot;`S` specify the track is a chapter track&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     767 </span>            :         GF_DEF_ARG(&quot;chapter&quot;, NULL, &quot;`S` add a single chapter (old nero format) with given name lasting the entire file&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     768 </span>            :         GF_DEF_ARG(&quot;chapfile&quot;, NULL, &quot;`S` add a chapter file (old nero format)&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     769 </span>            :         GF_DEF_ARG(&quot;layout&quot;, NULL, &quot;`S` specify the track layout as `WxH[xXxY][xLAYER]`. If `W` (resp `H`) is 0, the max width (resp height) of the tracks in the file are used&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     770 </span>            :         GF_DEF_ARG(&quot;rescale&quot;, NULL, &quot;`S` force media timescale to TS  (int or fraction) and change the media duration&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     771 </span>            :         GF_DEF_ARG(&quot;sampdur&quot;, NULL, &quot;`S` force all samples duration (`D`) or sample durations and media timescale (`D/TS`), used to patch CFR files with broken timings&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     772 </span>            :         GF_DEF_ARG(&quot;timescale&quot;, NULL, &quot;`S` set imported media timescale to TS&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     773 </span>            :         GF_DEF_ARG(&quot;moovts&quot;, NULL, &quot;`S` set movie timescale to TS. A negative value picks the media timescale of the first track imported&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     774 </span>            :         GF_DEF_ARG(&quot;noedit&quot;, NULL, &quot;`XS` do not set edit list when importing B-frames video tracks&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     775 </span>            :         GF_DEF_ARG(&quot;rvc&quot;, NULL, &quot;`S` set RVC configuration for the media&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     776 </span>            :         GF_DEF_ARG(&quot;fmt&quot;, NULL, &quot;override format detection with given format - disable data probing and force `ext` option on source&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     777 </span>            :         GF_DEF_ARG(&quot;profile&quot;, NULL, &quot;`S` override AVC profile. Integer value, or `high444`, `high`, `extended`, `main`, `baseline`&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     778 </span>            :         GF_DEF_ARG(&quot;level&quot;, NULL, &quot;`S` override AVC level, if value &lt; 6, interpreted as decimal expression&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     779 </span>            :         GF_DEF_ARG(&quot;compat&quot;, NULL, &quot;`S` force the profile compatibility flags for the H.264 content&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     780 </span>            :         GF_DEF_ARG(&quot;novpsext&quot;, NULL, &quot;remove VPS extensions from HEVC VPS&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     781 </span>            :         GF_DEF_ARG(&quot;keepav1t&quot;, NULL, &quot;keep AV1 temporal delimiter OBU in samples, might help if source file had losses&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     782 </span>            :         GF_DEF_ARG(&quot;font&quot;, NULL, &quot;specify font name for text import (default `Serif`)&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     783 </span>            :         GF_DEF_ARG(&quot;size&quot;, NULL, &quot;specify font size for text import (default `18`)&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     784 </span>            :         GF_DEF_ARG(&quot;text_layout&quot;, NULL, &quot;specify the track text layout as WxHxXxY\n&quot;
<span class="lineNum">     785 </span>            :                 &quot;  - if W (resp H) = 0: the max width (resp height) of the tracks in the file are used\n&quot;
<span class="lineNum">     786 </span>            :                 &quot;  - if Y=-1: the layout is moved to the bottom of the track area\n&quot;
<span class="lineNum">     787 </span>            :                 &quot;  - X and Y can be omitted: `:layout=WxH`&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     788 </span>            :         GF_DEF_ARG(&quot;swf-global&quot;, NULL, &quot;all SWF defines are placed in first scene replace rather than when needed&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     789 </span>            :         GF_DEF_ARG(&quot;swf-no-ctrl&quot;, NULL, &quot;use a single stream for movie control and dictionary (this will disable ActionScript)&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     790 </span>            :         GF_DEF_ARG(&quot;swf-no-text&quot;, NULL, &quot;remove all SWF text&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     791 </span>            :         GF_DEF_ARG(&quot;swf-no-font&quot;, NULL, &quot;remove all embedded SWF Fonts (local playback host fonts used)&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     792 </span>            :         GF_DEF_ARG(&quot;swf-no-line&quot;, NULL, &quot;remove all lines from SWF shapes&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     793 </span>            :         GF_DEF_ARG(&quot;swf-no-grad&quot;, NULL, &quot;remove all gradients from SWF shapes&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     794 </span>            :         GF_DEF_ARG(&quot;swf-quad&quot;, NULL, &quot;use quadratic bezier curves instead of cubic ones&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     795 </span>            :         GF_DEF_ARG(&quot;swf-xlp&quot;, NULL, &quot;support for lines transparency and scalability&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     796 </span>            :         GF_DEF_ARG(&quot;swf-ic2d&quot;, NULL, &quot;use indexed curve 2D hardcoded proto&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     797 </span>            :         GF_DEF_ARG(&quot;swf-same-app&quot;, NULL, &quot;appearance nodes are reused&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     798 </span>            :         GF_DEF_ARG(&quot;swf-flatten&quot;, NULL, &quot;complementary angle below which 2 lines are merged, `0` means no flattening&quot;, NULL, NULL, GF_ARG_DOUBLE, 0),
<span class="lineNum">     799 </span>            :         GF_DEF_ARG(&quot;kind&quot;, NULL, &quot;`S` set kind for the track as `schemeURI=value`&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     800 </span>            :         GF_DEF_ARG(&quot;txtflags&quot;, NULL, &quot;set display flags (hexa number) of text track. Use `txtflags+=FLAGS` to add flags and `txtflags-=FLAGS` to remove flags&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     801 </span>            :         GF_DEF_ARG(&quot;rate&quot;, NULL, &quot;force average rate and max rate to VAL (in bps) in btrt box. If 0, removes btrt box&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     802 </span>            :         GF_DEF_ARG(&quot;stz2&quot;, NULL, &quot;`S` use compact size table (for low-bitrates)&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     803 </span>            :         GF_DEF_ARG(&quot;bitdepth&quot;, NULL, &quot;set bit depth to VAL for imported video content (default is 24)&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     804 </span>            :         GF_DEF_ARG(&quot;colr&quot;, NULL, &quot;`S` set color profile for imported video content (see ISO/IEC 23001-8). Value is formatted as:\n&quot;
<span class="lineNum">     805 </span>            :                 &quot;  - nclc,p,t,m: with p colour primary (int or string), t transfer characteristics (int or string) and m matrix coef (int or string)\n&quot;
<span class="lineNum">     806 </span>            :                 &quot;  - nclx,p,t,m,r: same as `nclx` with r full range flag (`yes`, `on` or `no`, `off`)\n&quot;
<span class="lineNum">     807 </span>            :                 &quot;  - prof,path: with path indicating the file containing the ICC color profile\n&quot;
<span class="lineNum">     808 </span>            :                 &quot;  - rICC,path: with path indicating the file containing the restricted ICC color profile&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     809 </span>            :         GF_DEF_ARG(&quot;dv-profile&quot;, NULL, &quot;`S` set the Dolby Vision profile&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">     810 </span>            :         GF_DEF_ARG(&quot;fullrange&quot;, NULL, &quot;`S` force the video fullrange type in VUI for the AVC|H264 content (value `yes`, `on` or `no`, `off`)&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     811 </span>            :         GF_DEF_ARG(&quot;videofmt&quot;, NULL, &quot;`S` force the video format in VUI for AVC|H264 and HEVC content, value can be `component`, `pal`, `ntsc`, `secam`, `mac`, `undef`&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     812 </span>            :         GF_DEF_ARG(&quot;colorprim&quot;, NULL, &quot;`S` force the colour primaries in VUI for AVC|H264 and HEVC (int or string, cf `-h cicp`)&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     813 </span>            :         GF_DEF_ARG(&quot;colortfc&quot;, NULL, &quot;`S` force transfer characteristics in VUI for AVC|H264 and HEVC (int or string, cf `-h cicp`)&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     814 </span>            :         GF_DEF_ARG(&quot;colormx&quot;, NULL, &quot;`S` force the matrix coefficients in VUI for the AVC|H264 and HEVC content (int or string, cf `-h cicp`)&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     815 </span>            :         GF_DEF_ARG(&quot;tc&quot;, NULL, &quot;`S` inject a single QT timecode. Value is formatted as:\n&quot;
<span class="lineNum">     816 </span>            :                 &quot;  - [d]FPS[/FPS_den],h,m,s,f[,framespertick]: optional drop flag, framerate (integer or fractional), hours, minutes, seconds and frame number\n&quot;
<span class="lineNum">     817 </span>            :                 &quot;  - : `d` is an optional flag used to indicate that the counter is in drop-frame format\n&quot;
<span class="lineNum">     818 </span>            :                 &quot;  - : the `framespertick` is optional and defaults to round(framerate); it indicates the number of frames per counter tick&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     819 </span>            :         GF_DEF_ARG(&quot;edits&quot;, NULL, &quot;`S` override edit list, same syntax as [-edits]()&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     820 </span>            :         GF_DEF_ARG(&quot;lastsampdur&quot;, NULL, &quot;`S` set duration of the last sample. Value is formatted as:\n&quot;
<span class="lineNum">     821 </span>            :                 &quot;  - no value: use the previous sample duration\n&quot;
<span class="lineNum">     822 </span>            :                 &quot;  - integer: indicate the duration in milliseconds\n&quot;
<span class="lineNum">     823 </span>            :                 &quot;  - N/D: indicate the duration as fractional second&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">     824 </span>            :         GF_DEF_ARG(&quot;fstat&quot;, NULL, &quot;`C` print filter session stats after import&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     825 </span>            :         GF_DEF_ARG(&quot;fgraph&quot;, NULL, &quot;`C` print filter session graph after import&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">     826 </span>            :         {&quot;sopt:[OPTS]&quot;, NULL, &quot;set `OPTS` as additional arguments to source filter. `OPTS` can be any usual filter argument, see [filter doc `gpac -h doc`](Filters)&quot;},
<span class="lineNum">     827 </span>            :         {&quot;dopt:[OPTS]&quot;, NULL, &quot;`X` set `OPTS` as additional arguments to [destination filter](mp4mx). OPTS can be any usual filter argument, see [filter doc `gpac -h doc`](Filters)&quot;},
<span class="lineNum">     828 </span>            :         {&quot;@f1[:args][@fN:args]&quot;, NULL, &quot;set a filter chain to insert before the muxer. Each filter in the chain is formatted as a regular filter, see [filter doc `gpac -h doc`](Filters). A `@@` separator starts a new chain (see DASH help). The last filter in each chain shall not have any ID specified&quot;},
<span class="lineNum">     829 </span>            :         {0}
<a name="830"><span class="lineNum">     830 </span>            : };</a>
<span class="lineNum">     831 </span>            : 
<span class="lineNum">     832 </span><span class="lineCov">          4 : void PrintImportUsage()</span>
<span class="lineNum">     833 </span>            : {
<span class="lineNum">     834 </span>            :         u32 i;
<span class="lineNum">     835 </span>            : 
<span class="lineNum">     836 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# Importing Options\n&quot;</span>
<span class="lineNum">     837 </span>            :                 &quot;# File importing\n&quot;
<span class="lineNum">     838 </span>            :                 &quot;Syntax is [-add]() / [-cat]() `URL[#FRAGMENT][:opt1...:optN=val]`\n&quot;
<span class="lineNum">     839 </span>            :                 &quot;This process will create the destination file if not existing, and add the track(s) to it. If you wish to always create a new destination file, add [-new](MP4B_GEN).\n&quot;
<span class="lineNum">     840 </span>            :                 &quot;The supported input media types depend on your installation, check [filters documentation](Filters) for more info.\n&quot;
<span class="lineNum">     841 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     842 </span>            :                 &quot;To select a desired media track from a source, a fragment identifier '#' can be specified, before any other options. The following syntax is used:\n&quot;
<span class="lineNum">     843 </span>            :                 &quot;- `#video`: adds the first video track found in source\n&quot;
<span class="lineNum">     844 </span>            :                 &quot;- `#audio`: adds the first audio track found in source\n&quot;
<span class="lineNum">     845 </span>            :                 &quot;- `#auxv`: adds the first auxiliary video track found in source\n&quot;
<span class="lineNum">     846 </span>            :                 &quot;- `#pict`: adds the first picture track found in source\n&quot;
<span class="lineNum">     847 </span>            :                 &quot;- `#trackID=ID` or `#ID`: adds the specified track. For IsoMedia files, ID is the track ID. For other media files, ID is the value indicated by `MP4Box -info inputFile`\n&quot;
<span class="lineNum">     848 </span>            :                 &quot;- `#pid=ID`: number of desired PID for MPEG-2 TS sources\n&quot;
<span class="lineNum">     849 </span>            :                 &quot;- `#prog_id=ID`: number of desired program for MPEG-2 TS sources\n&quot;
<span class="lineNum">     850 </span>            :                 &quot;- `#program=NAME`: name of desired program for MPEG-2 TS sources\n&quot;
<span class="lineNum">     851 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     852 </span>            :                 &quot;By default all imports are performed sequentially, and final interleaving is done at the end; this however requires a temporary file holding original ISOBMF file (if any) and added files before creating the final output. Since this can become quite large, it is possible to add media to a new file without temporary storage, using [-flat](MP4B_GEN) option, but this disables media interleaving.\n&quot;
<span class="lineNum">     853 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     854 </span>            :                 &quot;If you wish to create an interleaved new file with no temporary storage, use the [-newfs](MP4B_GEN) option. The interleaving might not be as precise as when using [-new]() since it is dependent on muxer input scheduling (each execution might lead to a slightly different result). Additionally in this mode: \n&quot;
<span class="lineNum">     855 </span>            :                 &quot; - Some muxing options (marked with `X` below) will be activated for all inputs (e.g it is not possible to import one AVC track with `xps_inband` and another without).\n&quot;
<span class="lineNum">     856 </span>            :                 &quot; - Some muxing options (marked as `D` below) cannot be used as they require temporary storage for file edition.\n&quot;
<span class="lineNum">     857 </span>            :                 &quot; - Usage of [-cat]() is possible, but concatenated sources will not be interleaved in the output. If you wish to perform more complex cat/add operations without temp file, use a [playlist](flist).\n&quot;
<span class="lineNum">     858 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     859 </span>            :                 &quot;Source URL can be any URL supported by GPAC, not limited to local files.\n&quot;
<span class="lineNum">     860 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     861 </span>            :                 &quot;Note: When importing SRT or SUB files, MP4Box will choose default layout options to make the subtitle appear at the bottom of the video. You SHOULD NOT import such files before any video track is added to the destination file, otherwise the results will likely not be useful (default SRT/SUB importing uses default serif font, fontSize 18 and display size 400x60). For more details, check [TTXT doc](Subtitling-with-GPAC).\n&quot;
<span class="lineNum">     862 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     863 </span>            :                 &quot;When importing several tracks/sources in one pass, all options will be applied if relevant to each source. These options are set for all imported streams. If you need to specify these options per stream, set per-file options using the syntax `-add stream[:opt1:...:optN]`.\n&quot;
<span class="lineNum">     864 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     865 </span>            :                 &quot;The import file name may be set to empty or `self`, indicating that the import options should be applied to the destination file track(s).\n&quot;
<span class="lineNum">     866 </span>            :                 &quot;EX -add self:moovts=-1:noedit src.mp4\n&quot;
<span class="lineNum">     867 </span>            :                 &quot;This will apply `moovts` and `noedit` option to all tracks in src.mp4\n&quot;
<span class="lineNum">     868 </span>            :                 &quot;EX -add self#2:moovts=-1:noedit src.mp4\n&quot;
<span class="lineNum">     869 </span>            :                 &quot;This will apply `moovts` and `noedit` option to track with `ID=2` in src.mp4\n&quot;
<span class="lineNum">     870 </span>            :                 &quot;Only per-file options marked with a `S` are possible in this mode.\n&quot;
<span class="lineNum">     871 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     872 </span>            :                 &quot;When importing an ISOBMFF/QT file, only options marked as `C` or `S` can be used.\n&quot;
<span class="lineNum">     873 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     874 </span>            :                 &quot;Allowed per-file options:\n\n&quot;
<span class="lineNum">     875 </span>            :         );
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span>            :         i=0;
<span class="lineNum">     878 </span><span class="lineCov">        404 :         while (m4b_imp_fileopt_args[i].name) {</span>
<span class="lineNum">     879 </span><span class="lineCov">        396 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_imp_fileopt_args[i];</span>
<span class="lineNum">     880 </span><span class="lineCov">        396 :                 i++;</span>
<span class="lineNum">     881 </span><span class="lineCov">        396 :                 gf_sys_print_arg(helpout, help_flags | GF_PRINTARG_NO_DASH, arg, &quot;mp4box-import&quot;);</span>
<span class="lineNum">     882 </span>            :         }
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;\n&quot;</span>
<span class="lineNum">     885 </span>            :                 &quot;Note: `sopt`, `dopt` and `@f` must be placed after all other options.\n&quot;
<span class="lineNum">     886 </span>            :                 &quot;# Global import options\n&quot;
<span class="lineNum">     887 </span>            :         );
<span class="lineNum">     888 </span>            : 
<span class="lineNum">     889 </span>            :         i=0;
<span class="lineNum">     890 </span><span class="lineCov">         80 :         while (m4b_imp_args[i].name) {</span>
<span class="lineNum">     891 </span><span class="lineCov">         72 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_imp_args[i];</span>
<span class="lineNum">     892 </span><span class="lineCov">         72 :                 i++;</span>
<span class="lineNum">     893 </span><span class="lineCov">         72 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-import&quot;);</span>
<span class="lineNum">     894 </span>            :         }
<a name="895"><span class="lineNum">     895 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span><span class="lineCov">         25 : Bool mp4box_check_isom_fileopt(char *opt)</span>
<span class="lineNum">     898 </span>            : {
<span class="lineNum">     899 </span>            :         GF_GPACArg *arg = NULL;
<span class="lineNum">     900 </span>            :         u32 i=0;
<span class="lineNum">     901 </span>            : 
<span class="lineNum">     902 </span><span class="lineCov">       1147 :         while (m4b_imp_fileopt_args[i].name) {</span>
<span class="lineNum">     903 </span><span class="lineCov">       1122 :                 arg = (GF_GPACArg *) &amp;m4b_imp_fileopt_args[i];</span>
<span class="lineNum">     904 </span><span class="lineCov">       1122 :                 i++;</span>
<span class="lineNum">     905 </span><span class="lineCov">       1122 :                 if (!stricmp(arg-&gt;name, opt)) break;</span>
<span class="lineNum">     906 </span>            :                 arg = NULL;
<span class="lineNum">     907 </span>            :         }
<span class="lineNum">     908 </span><span class="lineCov">         25 :         if (!arg) {</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :                 fprintf(stderr, &quot;Option %s not described in doc, please report to GPAC devs!\n&quot;, opt);</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :                 return GF_FALSE;</span>
<span class="lineNum">     911 </span>            :         }
<span class="lineNum">     912 </span><span class="lineCov">         25 :         if (arg-&gt;description[0] != '`')</span>
<span class="lineNum">     913 </span>            :                 return GF_FALSE;
<span class="lineNum">     914 </span><span class="lineCov">         24 :         const char *d = arg-&gt;description+1;</span>
<span class="lineNum">     915 </span><span class="lineCov">         55 :         while (d[0] != '`') {</span>
<span class="lineNum">     916 </span><span class="lineCov">         31 :                 if (d[0]=='S') return GF_TRUE;</span>
<span class="lineNum">     917 </span><span class="lineCov">         11 :                 if (d[0]=='C') return GF_TRUE;</span>
<span class="lineNum">     918 </span><span class="lineCov">          7 :                 d++;</span>
<span class="lineNum">     919 </span>            :         }
<span class="lineNum">     920 </span>            :         return GF_FALSE;
<span class="lineNum">     921 </span>            : }
<span class="lineNum">     922 </span>            : 
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span>            : MP4BoxArg m4b_senc_args[] =
<span class="lineNum">     925 </span>            : {
<span class="lineNum">     926 </span>            :         MP4BOX_ARG(&quot;mp4&quot;, &quot;specify input file is for BIFS/LASeR encoding&quot;, GF_ARG_BOOL, 0, &amp;encode, 0, ARG_OPEN_EDIT),
<span class="lineNum">     927 </span>            :         MP4BOX_ARG(&quot;def&quot;, &quot;encode DEF names in BIFS&quot;, GF_ARG_BOOL, 0, &amp;smenc_opts.flags, GF_SM_ENCODE_USE_NAMES, ARG_BIT_MASK),
<span class="lineNum">     928 </span>            :         MP4BOX_ARG(&quot;sync&quot;, &quot;force BIFS sync sample generation every given time in ms (cannot be used with [-shadow]() or [-carousel]() )&quot;, GF_ARG_INT, 0, parse_senc_param, 0, ARG_IS_FUN),
<span class="lineNum">     929 </span>            :         MP4BOX_ARG(&quot;shadow&quot;, &quot;force BIFS sync shadow sample generation every given time in ms (cannot be used with [-sync]() or [-carousel]() )&quot;, GF_ARG_INT, 0, parse_senc_param, 1, ARG_IS_FUN),
<span class="lineNum">     930 </span>            :         MP4BOX_ARG(&quot;carousel&quot;, &quot;use BIFS carousel (cannot be used with [-sync]() or [-shadow]() )&quot;, GF_ARG_INT, 0, parse_senc_param, 2, ARG_IS_FUN),
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span>            :         MP4BOX_ARG(&quot;sclog&quot;, &quot;generate scene codec log file if available&quot;, GF_ARG_BOOL, 0, &amp;do_scene_log, 0, 0),
<span class="lineNum">     933 </span>            :         MP4BOX_ARG(&quot;ms&quot;, &quot;import tracks from the given file&quot;, GF_ARG_STRING, 0, &amp;mediaSource, 0, 0),
<span class="lineNum">     934 </span>            :         MP4BOX_ARG(&quot;ctx-in&quot;, &quot;specify initial context (MP4/BT/XMT) file for chunk processing. Input file must be a commands-only file&quot;, GF_ARG_STRING, 0, parse_senc_param, 5, ARG_IS_FUN),
<span class="lineNum">     935 </span>            :         MP4BOX_ARG(&quot;ctx-out&quot;, &quot;specify storage of updated context (MP4/BT/XMT) file for chunk processing, optional&quot;, GF_ARG_STRING, 0, &amp;output_ctx, 0, 0),
<span class="lineNum">     936 </span>            :         MP4BOX_ARG(&quot;resolution&quot;, &quot;resolution factor (-8 to 7, default 0) for LASeR encoding, and all coordinates are multiplied by `2^res` before truncation (LASeR encoding)&quot;, GF_ARG_INT, 0, &amp;smenc_opts.resolution, 0, 0),
<span class="lineNum">     937 </span>            :         MP4BOX_ARG(&quot;coord-bits&quot;, &quot;number of bits used for encoding truncated coordinates (0 to 31, default 12) (LASeR encoding)&quot;, GF_ARG_INT, 0, &amp;smenc_opts.coord_bits, 0, 0),
<span class="lineNum">     938 </span>            :         MP4BOX_ARG(&quot;scale-bits&quot;, &quot;extra bits used for encoding truncated scales (0 to 4, default 0) (LASeR encoding)&quot;, GF_ARG_INT, 0, &amp;smenc_opts.scale_bits, 0, 0),
<span class="lineNum">     939 </span>            :         MP4BOX_ARG(&quot;auto-quant&quot;, &quot;resolution is given as if using [-resolution]() but coord-bits and scale-bits are infered (LASeR encoding)&quot;, GF_ARG_INT, 0, parse_senc_param, 3, ARG_IS_FUN),
<span class="lineNum">     940 </span>            :         MP4BOX_ARG(&quot;global-quant&quot;, &quot;resolution is given as if using [-resolution]() but the res is inferred (BIFS encoding)&quot;, GF_ARG_INT, 0, parse_senc_param, 4, ARG_IS_FUN),
<span class="lineNum">     941 </span>            :         {0}
<span class="lineNum">     942 </span>            : };
<a name="943"><span class="lineNum">     943 </span>            : </a>
<span class="lineNum">     944 </span>            : 
<span class="lineNum">     945 </span><span class="lineCov">          4 : void PrintEncodeUsage()</span>
<span class="lineNum">     946 </span>            : {
<span class="lineNum">     947 </span>            :         u32 i=0;
<span class="lineNum">     948 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# MPEG-4 Scene Encoding Options\n&quot;</span>
<span class="lineNum">     949 </span>            :                 &quot;## General considerations\n&quot;
<span class="lineNum">     950 </span>            :                 &quot;MP4Box supports encoding and decoding of of BT, XMT, VRML and (partially) X3D formats int MPEG-4 BIFS, and encoding and decoding of XSR and SVG into MPEG-4 LASeR\n&quot;
<span class="lineNum">     951 </span>            :                 &quot;Any media track specified through a `MuxInfo` element will be imported in the resulting MP4 file.\n&quot;
<span class="lineNum">     952 </span>            :                 &quot;See https://wiki.gpac.io/MPEG-4-BIFS-Textual-Format and related pages.\n&quot;
<span class="lineNum">     953 </span>            :                 &quot;## Scene Random Access\n&quot;
<span class="lineNum">     954 </span>            :                 &quot;MP4Box can encode BIFS or LASeR streams and insert random access points at a given frequency. This is useful when packaging content for broadcast, where users will not turn in the scene at the same time. In MPEG-4 terminology, this is called the __scene carousel__.&quot;
<span class="lineNum">     955 </span>            :                 &quot;## BIFS Chunk Processing\n&quot;
<span class="lineNum">     956 </span>            :                 &quot;The BIFS chunk encoding mode alows encoding single BIFS access units from an initial context and a set of commands.\n&quot;
<span class="lineNum">     957 </span>            :                 &quot;The generated AUs are raw BIFS (not SL-packetized), in files called FILE-ESID-AUIDX.bifs, with FILE the basename of the input file.\n&quot;
<span class="lineNum">     958 </span>            :                 &quot;Commands with a timing of 0 in the input will modify the carousel version only (i.e. output context).\n&quot;
<span class="lineNum">     959 </span>            :                 &quot;Commands with a timing different from 0 in the input will generate new AUs.\n&quot;
<span class="lineNum">     960 </span>            :                 &quot;  \n&quot;
<span class="lineNum">     961 </span>            :                 &quot;Options:\n&quot;
<span class="lineNum">     962 </span>            :         );
<span class="lineNum">     963 </span>            : 
<span class="lineNum">     964 </span><span class="lineCov">         64 :         while (m4b_senc_args[i].name) {</span>
<span class="lineNum">     965 </span><span class="lineCov">         56 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_senc_args[i];</span>
<span class="lineNum">     966 </span><span class="lineCov">         56 :                 i++;</span>
<span class="lineNum">     967 </span><span class="lineCov">         56 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-senc&quot;);</span>
<span class="lineNum">     968 </span>            :         }
<span class="lineNum">     969 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">     970 </span>            : 
<span class="lineNum">     971 </span>            : MP4BoxArg m4b_crypt_args[] =
<span class="lineNum">     972 </span>            : {
<span class="lineNum">     973 </span>            :         MP4BOX_ARG(&quot;crypt&quot;, &quot;encrypt the input file using the given `CryptFile`&quot;, GF_ARG_STRING, 0, parse_cryp, 0, ARG_IS_FUN),
<span class="lineNum">     974 </span>            :         MP4BOX_ARG(&quot;decrypt&quot;, &quot;decrypt the input file, potentially using the given `CryptFile`. If `CryptFile` is not given, will fail if the key management system is not supported&quot;, GF_ARG_STRING, 0, parse_cryp, 1, ARG_IS_FUN | ARG_EMPTY),
<span class="lineNum">     975 </span>            :         MP4BOX_ARG_S(&quot;set-kms&quot;, &quot;tkID=kms_uri&quot;, &quot;change ISMA/OMA KMS location for a given track or for all tracks if `all=` is used&quot;, 0, parse_track_action, TRAC_ACTION_SET_KMS_URI, ARG_IS_FUN),
<span class="lineNum">     976 </span>            :         {0}
<a name="977"><span class="lineNum">     977 </span>            : };</a>
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span><span class="lineCov">          4 : void PrintEncryptUsage()</span>
<span class="lineNum">     980 </span>            : {
<span class="lineNum">     981 </span>            :         u32 i=0;
<span class="lineNum">     982 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# Encryption/Decryption Options\n&quot;</span>
<span class="lineNum">     983 </span>            :         &quot;MP4Box supports encryption and decryption of ISMA, OMA and CENC content, see [encryption filter `gpac -h cecrypt`](cecrypt).\n&quot;
<span class="lineNum">     984 </span>            :         &quot;It requires a specific XML file called `CryptFile`, whose syntax is available at https://wiki.gpac.io/Common-Encryption\n&quot;
<span class="lineNum">     985 </span>            :         &quot;Image files (HEIF) can also be crypted / decrypted, using CENC only.\n&quot;
<span class="lineNum">     986 </span>            :         &quot;  \n&quot;
<span class="lineNum">     987 </span>            :         &quot;Options:\n&quot;
<span class="lineNum">     988 </span>            :         );
<span class="lineNum">     989 </span><span class="lineCov">         20 :         while (m4b_crypt_args[i].name) {</span>
<span class="lineNum">     990 </span><span class="lineCov">         12 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_crypt_args[i];</span>
<span class="lineNum">     991 </span><span class="lineCov">         12 :                 i++;</span>
<span class="lineNum">     992 </span><span class="lineCov">         12 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-crypt&quot;);</span>
<span class="lineNum">     993 </span>            :         }
<span class="lineNum">     994 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">     995 </span>            : 
<span class="lineNum">     996 </span>            : MP4BoxArg m4b_hint_args[] =
<span class="lineNum">     997 </span>            : {
<span class="lineNum">     998 </span>            :         MP4BOX_ARG(&quot;hint&quot;, &quot;hint the file for RTP/RTSP&quot;, GF_ARG_BOOL, 0, &amp;do_hint, 0, ARG_OPEN_EDIT),
<span class="lineNum">     999 </span>            :         {&quot;mtu&quot;, NULL, &quot;specify RTP MTU (max size) in bytes (this includes 12 bytes RTP header)&quot;, &quot;1450&quot;, NULL, GF_ARG_INT, 0, &amp;MTUSize, 0, 0},
<span class="lineNum">    1000 </span>            :         MP4BOX_ARG(&quot;copy&quot;, &quot;copy media data to hint track rather than reference (speeds up server but takes much more space)&quot;, GF_ARG_BOOL, 0, &amp;HintCopy, 0, 0),
<span class="lineNum">    1001 </span>            :         MP4BOX_ARG_S(&quot;multi&quot;, &quot;[maxptime]&quot;, &quot;enable frame concatenation in RTP packets if possible (with max duration 100 ms or `maxptime` ms if given)&quot;, 0, parse_multi_rtp, 0, ARG_IS_FUN),
<span class="lineNum">    1002 </span>            :         {&quot;rate&quot;, NULL, &quot;specify rtp rate in Hz when no default for payload&quot;, &quot;90000&quot;, NULL, GF_ARG_INT, 0, &amp;rtp_rate, 0, 0},
<span class="lineNum">    1003 </span>            :         MP4BOX_ARG(&quot;mpeg4&quot;, &quot;force MPEG-4 generic payload whenever possible&quot;, GF_ARG_BOOL, 0, &amp;import_flags, GF_IMPORT_FORCE_MPEG4, ARG_BIT_MASK),
<span class="lineNum">    1004 </span>            :         MP4BOX_ARG(&quot;latm&quot;, &quot;force MPG4-LATM transport for AAC streams&quot;, GF_ARG_BOOL, 0, &amp;hint_flags, GP_RTP_PCK_USE_LATM_AAC, ARG_BIT_MASK),
<span class="lineNum">    1005 </span>            :         MP4BOX_ARG(&quot;static&quot;, &quot;enable static RTP payload IDs whenever possible (by default, dynamic payloads are always used)&quot;, GF_ARG_BOOL, 0, &amp;hint_flags, GP_RTP_PCK_USE_STATIC_ID, ARG_BIT_MASK),
<span class="lineNum">    1006 </span>            :         MP4BOX_ARG(&quot;add-sdp&quot;, &quot;add given SDP string to hint track (`tkID:string`) or movie (`string`)&quot;, GF_ARG_STRING, 0, parse_sdp_ext, 0, ARG_IS_FUN),
<span class="lineNum">    1007 </span>            :         MP4BOX_ARG(&quot;no-offset&quot;, &quot;signal no random offset for sequence number and timestamp (support will depend on server)&quot;, GF_ARG_BOOL, 0, &amp;hint_no_offset, 0, 0),
<span class="lineNum">    1008 </span>            :         MP4BOX_ARG(&quot;unhint&quot;, &quot;remove all hinting information from file&quot;, GF_ARG_BOOL, 0, &amp;remove_hint, 0, ARG_OPEN_EDIT),
<span class="lineNum">    1009 </span>            :         MP4BOX_ARG(&quot;group-single&quot;, &quot;put all tracks in a single hint group&quot;, GF_ARG_BOOL, 0, &amp;single_group, 0, 0),
<span class="lineNum">    1010 </span>            :         MP4BOX_ARG(&quot;ocr&quot;, &quot;force all MPEG-4 streams to be synchronized (MPEG-4 Systems only)&quot;, GF_ARG_BOOL, 0, &amp;force_ocr, 0, 0),
<span class="lineNum">    1011 </span>            :         MP4BOX_ARG(&quot;rap&quot;, &quot;signal random access points in RTP packets (MPEG-4 Systems)&quot;, GF_ARG_BOOL, 0, parse_rap_ref, 0, ARG_IS_FUN | ARG_EMPTY),
<span class="lineNum">    1012 </span>            :         MP4BOX_ARG(&quot;ts&quot;, &quot;signal AU Time Stamps in RTP packets (MPEG-4 Systems)&quot;, GF_ARG_BOOL, 0, &amp;hint_flags, GP_RTP_PCK_SIGNAL_TS, ARG_BIT_MASK),
<span class="lineNum">    1013 </span>            :         MP4BOX_ARG(&quot;size&quot;, &quot;signal AU size in RTP packets (MPEG-4 Systems)&quot;, GF_ARG_BOOL, 0, &amp;hint_flags, GP_RTP_PCK_SIGNAL_SIZE, ARG_BIT_MASK),
<span class="lineNum">    1014 </span>            :         MP4BOX_ARG(&quot;idx&quot;, &quot;signal AU sequence numbers in RTP packets (MPEG-4 Systems)&quot;, GF_ARG_BOOL, 0, &amp;hint_flags, GP_RTP_PCK_SIGNAL_AU_IDX, ARG_BIT_MASK),
<span class="lineNum">    1015 </span>            :         MP4BOX_ARG(&quot;iod&quot;, &quot;prevent systems tracks embedding in IOD (MPEG-4 Systems), not compatible with [-isma]()&quot;, GF_ARG_BOOL, 0, &amp;regular_iod, 0, 0),
<span class="lineNum">    1016 </span>            :         {0}
<a name="1017"><span class="lineNum">    1017 </span>            : };</a>
<span class="lineNum">    1018 </span>            : 
<span class="lineNum">    1019 </span><span class="lineCov">          4 : void PrintHintUsage()</span>
<span class="lineNum">    1020 </span>            : {
<span class="lineNum">    1021 </span>            :         u32 i=0;
<span class="lineNum">    1022 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# Hinting Options\n&quot;</span>
<span class="lineNum">    1023 </span>            :                 &quot;IsoMedia hinting consists in creating special tracks in the file that contain transport protocol specific information and optionally multiplexing information. These tracks are then used by the server to create the actual packets being sent over the network, in other words they provide the server with hints on how to build packets, hence their names `hint tracks`.\n&quot;
<span class="lineNum">    1024 </span>            :                 &quot;MP4Box supports creation of hint tracks for RTSP servers supporting these such as QuickTime Streaming Server, DarwinStreaming Server or 3GPP-compliant RTSP servers.\n&quot;
<span class="lineNum">    1025 </span>            :                 &quot;Note: GPAC streaming tools [rtp output](rtpout) and [rtsp server](rtspout) do not use hint tracks, they use on-the-fly packetization &quot;
<span class="lineNum">    1026 </span>            :                 &quot;from any media sources, not just MP4\n&quot;
<span class="lineNum">    1027 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    1028 </span>            :                 &quot;Options:\n&quot;
<span class="lineNum">    1029 </span>            :         );
<span class="lineNum">    1030 </span><span class="lineCov">         80 :         while (m4b_hint_args[i].name) {</span>
<span class="lineNum">    1031 </span><span class="lineCov">         72 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_hint_args[i];</span>
<span class="lineNum">    1032 </span><span class="lineCov">         72 :                 i++;</span>
<span class="lineNum">    1033 </span><span class="lineCov">         72 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-hint&quot;);</span>
<span class="lineNum">    1034 </span>            :         }
<span class="lineNum">    1035 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">    1036 </span>            : 
<span class="lineNum">    1037 </span>            : 
<span class="lineNum">    1038 </span>            : MP4BoxArg m4b_extr_args[] =
<span class="lineNum">    1039 </span>            : {
<span class="lineNum">    1040 </span>            :         MP4BOX_ARG(&quot;raw&quot;, &quot;extract given track in raw format when supported. Use `tkID:output=FileName` to set output file name&quot;, GF_ARG_STRING, 0, parse_track_dump, GF_EXPORT_NATIVE, ARG_IS_FUN),
<span class="lineNum">    1041 </span>            :         MP4BOX_ARG(&quot;raws&quot;, &quot;extract each sample of the given track to a file. Use `tkID:N` to extract the Nth sample&quot;, GF_ARG_STRING, 0, parse_track_dump, GF_EXPORT_RAW_SAMPLES, ARG_IS_FUN),
<span class="lineNum">    1042 </span>            :         MP4BOX_ARG(&quot;nhnt&quot;, &quot;extract given track to [NHNT](nhntr) format&quot;, GF_ARG_INT, 0, parse_track_dump, GF_EXPORT_NHNT, ARG_IS_FUN),
<span class="lineNum">    1043 </span>            :         MP4BOX_ARG(&quot;nhml&quot;, &quot;extract given track to [NHML](nhmlr) format. Use `tkID:full` for full NHML dump with all packet properties&quot;, GF_ARG_STRING, 0, parse_track_dump, GF_EXPORT_NHML, ARG_IS_FUN),
<span class="lineNum">    1044 </span>            :         MP4BOX_ARG(&quot;webvtt-raw&quot;, &quot;extract given track as raw media in WebVTT as metadata. Use `tkID:embedded` to include media data in the WebVTT file&quot;, GF_ARG_STRING, 0, parse_track_dump, GF_EXPORT_WEBVTT_META, ARG_IS_FUN),
<span class="lineNum">    1045 </span>            :         MP4BOX_ARG(&quot;single&quot;, &quot;extract given track to a new mp4 file&quot;, GF_ARG_INT, 0, parse_track_dump, GF_EXPORT_MP4, ARG_IS_FUN),
<span class="lineNum">    1046 </span>            :         MP4BOX_ARG(&quot;six&quot;, &quot;extract given track as raw media in **experimental** XML streaming instructions&quot;, GF_ARG_INT, 0, parse_track_dump, GF_EXPORT_SIX, ARG_IS_FUN),
<span class="lineNum">    1047 </span>            :         MP4BOX_ARG(&quot;mux&quot;, &quot;mux input to given destination&quot;, GF_ARG_STRING, 0, &amp;mux_name, 0, 0),
<span class="lineNum">    1048 </span>            :         MP4BOX_ARG(&quot;qcp&quot;, &quot;same as [-raw]() but defaults to QCP file for EVRC/SMV&quot;, GF_ARG_INT, 0, parse_track_dump, GF_EXPORT_NATIVE | GF_EXPORT_USE_QCP, ARG_IS_FUN),
<span class="lineNum">    1049 </span>            :         MP4BOX_ARG(&quot;saf&quot;, &quot;remux file to SAF multiplex&quot;, GF_ARG_BOOL, 0, &amp;do_saf, 0, 0),
<span class="lineNum">    1050 </span>            :         MP4BOX_ARG(&quot;dvbhdemux&quot;, &quot;demux DVB-H file into IP Datagrams sent on the network&quot;, GF_ARG_BOOL, 0, &amp;dvbhdemux, 0, 0),
<span class="lineNum">    1051 </span>            :         MP4BOX_ARG(&quot;raw-layer&quot;, &quot;same as [-raw]() but skips SVC/MVC/LHVC extractors when extracting&quot;, GF_ARG_INT, 0, parse_track_dump, GF_EXPORT_NATIVE | GF_EXPORT_SVC_LAYER, ARG_IS_FUN),
<span class="lineNum">    1052 </span>            :         MP4BOX_ARG(&quot;diod&quot;, &quot;extract file IOD in raw format&quot;, GF_ARG_BOOL, 0, &amp;dump_iod, 0, 0),
<span class="lineNum">    1053 </span>            :         MP4BOX_ARG(&quot;mpd&quot;, &quot;convert given HLS or smooth manifest (local or remote http) to MPD.  \nWarning: This is not compatible with other DASH options and does not convert associated segments&quot;, GF_ARG_STRING, 0, &amp;do_mpd_conv, 0, 0),
<span class="lineNum">    1054 </span>            :         {0}
<a name="1055"><span class="lineNum">    1055 </span>            : };</a>
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineCov">          4 : void PrintExtractUsage()</span>
<span class="lineNum">    1058 </span>            : {
<span class="lineNum">    1059 </span>            :         u32 i=0;
<span class="lineNum">    1060 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# Extracting Options\n&quot;</span>
<span class="lineNum">    1061 </span>            :         &quot;MP4Box can be used to extract media tracks from MP4 files. If you need to convert these tracks however, please check the [filters doc](Filters).\n&quot;
<span class="lineNum">    1062 </span>            :         &quot;  \n&quot;
<span class="lineNum">    1063 </span>            :         &quot;Options:\n&quot;
<span class="lineNum">    1064 </span>            :         );
<span class="lineNum">    1065 </span><span class="lineCov">         64 :         while (m4b_extr_args[i].name) {</span>
<span class="lineNum">    1066 </span><span class="lineCov">         56 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_extr_args[i];</span>
<span class="lineNum">    1067 </span><span class="lineCov">         56 :                 i++;</span>
<span class="lineNum">    1068 </span><span class="lineCov">         56 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-extract&quot;);</span>
<span class="lineNum">    1069 </span>            :         }
<span class="lineNum">    1070 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">    1071 </span>            : 
<span class="lineNum">    1072 </span>            : MP4BoxArg m4b_dump_args[] =
<span class="lineNum">    1073 </span>            : {
<span class="lineNum">    1074 </span>            :         MP4BOX_ARG(&quot;std&quot;, &quot;dump/write to stdout and assume stdout is opened in binary mode&quot;, GF_ARG_BOOL, 0, &amp;dump_std, 2, 0),
<span class="lineNum">    1075 </span>            :         MP4BOX_ARG(&quot;stdb&quot;, &quot;dump/write to stdout and try to reopen stdout in binary mode&quot;, GF_ARG_BOOL, 0, &amp;dump_std, 1, 0),
<span class="lineNum">    1076 </span>            :         MP4BOX_ARG(&quot;tracks&quot;, &quot;print the number of tracks on stdout&quot;, GF_ARG_BOOL, 0, &amp;get_nb_tracks, 0, 0),
<span class="lineNum">    1077 </span>            :         MP4BOX_ARG(&quot;info&quot;, &quot;print movie info (no parameter) or track info with specified ID&quot;, GF_ARG_STRING, 0, parse_file_info, 0, ARG_IS_FUN|ARG_EMPTY),
<span class="lineNum">    1078 </span>            :         MP4BOX_ARG(&quot;infon&quot;, &quot;print track info for given track number, 1 being the first track in the file&quot;, GF_ARG_STRING, 0, parse_file_info, 1, ARG_IS_FUN|ARG_EMPTY),
<span class="lineNum">    1079 </span>            :         MP4BOX_ARG_ALT(&quot;diso&quot;, &quot;dmp4&quot;, &quot;dump IsoMedia file boxes in XML output&quot;, GF_ARG_BOOL, 0, &amp;dump_isom, 1, 0),
<span class="lineNum">    1080 </span>            :         MP4BOX_ARG(&quot;dxml&quot;, &quot;dump IsoMedia file boxes and known track samples in XML output&quot;, GF_ARG_BOOL, 0, &amp;dump_isom, 2, 0),
<span class="lineNum">    1081 </span>            :         MP4BOX_ARG(&quot;disox&quot;, &quot;dump IsoMedia file boxes except sample tables in XML output&quot;, GF_ARG_BOOL, 0, &amp;dump_isom, 3, 0),
<span class="lineNum">    1082 </span>            :         MP4BOX_ARG(&quot;keep-ods&quot;, &quot;do not translate ISOM ODs and ESDs tags (debug purpose only)&quot;, GF_ARG_BOOL, 0, &amp;no_odf_conf, 0, 0),
<span class="lineNum">    1083 </span>            :         MP4BOX_ARG(&quot;bt&quot;, &quot;dump scene to BT format&quot;, GF_ARG_BOOL, 0, &amp;dump_mode, GF_SM_DUMP_BT, ARG_HAS_VALUE),
<span class="lineNum">    1084 </span>            :         MP4BOX_ARG(&quot;xmt&quot;, &quot;dump scene to XMT format&quot;, GF_ARG_BOOL, 0, &amp;dump_mode, GF_SM_DUMP_XMTA, 0),
<span class="lineNum">    1085 </span>            :         MP4BOX_ARG(&quot;wrl&quot;, &quot;dump scene to VRML format&quot;, GF_ARG_BOOL, 0, &amp;dump_mode, GF_SM_DUMP_VRML, 0),
<span class="lineNum">    1086 </span>            :         MP4BOX_ARG(&quot;x3d&quot;, &quot;dump scene to X3D XML format&quot;, GF_ARG_BOOL, 0, &amp;dump_mode, GF_SM_DUMP_X3D_XML, 0),
<span class="lineNum">    1087 </span>            :         MP4BOX_ARG(&quot;x3dv&quot;, &quot;dump scene to X3D VRML format&quot;, GF_ARG_BOOL, 0, &amp;dump_mode, GF_SM_DUMP_X3D_VRML, 0),
<span class="lineNum">    1088 </span>            :         MP4BOX_ARG(&quot;lsr&quot;, &quot;dump scene to LASeR XML (XSR) format&quot;, GF_ARG_BOOL, 0, &amp;dump_mode, GF_SM_DUMP_LASER, 0),
<span class="lineNum">    1089 </span>            :         MP4BOX_ARG(&quot;svg&quot;, &quot;dump scene to SVG&quot;, GF_ARG_BOOL, 0, &amp;dump_mode, GF_SM_DUMP_SVG, 0),
<span class="lineNum">    1090 </span>            :         MP4BOX_ARG(&quot;drtp&quot;, &quot;dump rtp hint samples structure to XML output&quot;, GF_ARG_BOOL, 0, &amp;dump_rtp, 0, 0),
<span class="lineNum">    1091 </span>            :         MP4BOX_ARG(&quot;dts&quot;, &quot;print sample timing, size and position in file to text output&quot;, GF_ARG_BOOL, 0, parse_dump_ts, 0, ARG_IS_FUN),
<span class="lineNum">    1092 </span>            :         MP4BOX_ARG(&quot;dtsx&quot;, &quot;same as [-dts]() but does not print offset&quot;, GF_ARG_BOOL, 0, &amp;dump_timestamps, 2, 0),
<span class="lineNum">    1093 </span>            :         MP4BOX_ARG(&quot;dtsc&quot;, &quot;same as [-dts]() but analyses each sample for duplicated dts/cts (__slow !__)&quot;, GF_ARG_BOOL, 0, &amp;dump_timestamps, 3, 0),
<span class="lineNum">    1094 </span>            :         MP4BOX_ARG(&quot;dtsxc&quot;, &quot;same as [-dtsc]() but does not print offset (__slow !__)&quot;, GF_ARG_BOOL, 0, &amp;dump_timestamps, 4, 0),
<span class="lineNum">    1095 </span>            :         MP4BOX_ARG(&quot;dnal&quot;, &quot;print NAL sample info of given track&quot;, GF_ARG_INT, 0, parse_dnal, 0, ARG_IS_FUN),
<span class="lineNum">    1096 </span>            :         MP4BOX_ARG(&quot;dnalc&quot;, &quot;print NAL sample info of given track, adding CRC for each nal&quot;, GF_ARG_INT, 0, parse_dnal, 1, ARG_IS_FUN),
<span class="lineNum">    1097 </span>            :         MP4BOX_ARG(&quot;dnald&quot;, &quot;print NAL sample info of given track without DTS and CTS info&quot;, GF_ARG_INT, 0, parse_dnal, 2, ARG_IS_FUN),
<span class="lineNum">    1098 </span>            :         MP4BOX_ARG(&quot;dnalx&quot;, &quot;print NAL sample info of given track without DTS and CTS info and adding CRC for each nal&quot;, GF_ARG_INT, 0, parse_dnal, 2|1, ARG_IS_FUN),
<span class="lineNum">    1099 </span>            :         MP4BOX_ARG(&quot;sdp&quot;, &quot;dump SDP description of hinted file&quot;, GF_ARG_BOOL, 0, &amp;print_sdp, 0, 0),
<span class="lineNum">    1100 </span>            :         MP4BOX_ARG(&quot;dsap&quot;, &quot;dump DASH SAP cues (see -cues) for a given track&quot;, GF_ARG_INT, 0, parse_dsap, 0, ARG_IS_FUN),
<span class="lineNum">    1101 </span>            :         MP4BOX_ARG(&quot;dsaps&quot;, &quot;same as [-dsap]() but only print sample number&quot;, GF_ARG_INT, 0, parse_dsap, 1, ARG_IS_FUN),
<span class="lineNum">    1102 </span>            :         MP4BOX_ARG(&quot;dsapc&quot;, &quot;same as [-dsap]() but only print CTS&quot;, GF_ARG_INT, 0, parse_dsap, 2, ARG_IS_FUN),
<span class="lineNum">    1103 </span>            :         MP4BOX_ARG(&quot;dsapd&quot;, &quot;same as [-dsap]() but only print DTS&quot;, GF_ARG_INT, 0, parse_dsap, 3, ARG_IS_FUN),
<span class="lineNum">    1104 </span>            :         MP4BOX_ARG(&quot;dsapp&quot;, &quot;same as [-dsap]() but only print presentation time&quot;, GF_ARG_INT, 4, parse_dsap, 4, ARG_IS_FUN),
<span class="lineNum">    1105 </span>            :         MP4BOX_ARG(&quot;dcr&quot;, &quot;dump ISMACryp samples structure to XML output&quot;, GF_ARG_BOOL, 0, &amp;dump_cr, 0, 0),
<span class="lineNum">    1106 </span>            :         MP4BOX_ARG(&quot;dump-cover&quot;, &quot;extract cover art&quot;, GF_ARG_BOOL, 0, &amp;dump_cart, 0, 0),
<span class="lineNum">    1107 </span>            :         MP4BOX_ARG(&quot;dump-chap&quot;, &quot;extract chapter file as TTXT format&quot;, GF_ARG_BOOL, 0, &amp;dump_chap, 1, 0),
<span class="lineNum">    1108 </span>            :         MP4BOX_ARG(&quot;dump-chap-ogg&quot;, &quot;extract chapter file as OGG format&quot;, GF_ARG_BOOL, 0, &amp;dump_chap, 2, 0),
<span class="lineNum">    1109 </span>            :         MP4BOX_ARG(&quot;dump-chap-zoom&quot;, &quot;extract chapter file as zoom format&quot;, GF_ARG_BOOL, 0, &amp;dump_chap, 3, 0),
<span class="lineNum">    1110 </span>            :         MP4BOX_ARG_S(&quot;dump-udta&quot;, &quot;[tkID:]4cc&quot;, &quot;extract user data for the given 4CC. If `tkID` is given, dumps from UDTA of the given track ID, otherwise moov is used&quot;, 0, parse_dump_udta, 0, ARG_IS_FUN),
<span class="lineNum">    1111 </span>            :         MP4BOX_ARG(&quot;mergevtt&quot;, &quot;merge vtt cues while dumping&quot;, GF_ARG_BOOL, 0, &amp;merge_vtt_cues, 0, 0),
<span class="lineNum">    1112 </span>            :         MP4BOX_ARG(&quot;ttxt&quot;, &quot;convert input subtitle to GPAC TTXT format if no parameter. Otherwise, dump given text track to GPAC TTXT format&quot;, GF_ARG_INT, 0, parse_ttxt, 0, ARG_IS_FUN),
<span class="lineNum">    1113 </span>            :         MP4BOX_ARG(&quot;srt&quot;, &quot;convert input subtitle to SRT format if no parameter. Otherwise, dump given text track to SRT format&quot;, GF_ARG_INT, 0, parse_ttxt, 1, ARG_IS_FUN),
<span class="lineNum">    1114 </span>            :         MP4BOX_ARG(&quot;stat&quot;, &quot;generate node/field statistics for scene&quot;, GF_ARG_BOOL, 0, &amp;stat_level, 1, 0),
<span class="lineNum">    1115 </span>            :         MP4BOX_ARG(&quot;stats&quot;, &quot;generate node/field statistics per Access Unit&quot;, GF_ARG_BOOL, 0, &amp;stat_level, 2, 0),
<span class="lineNum">    1116 </span>            :         MP4BOX_ARG(&quot;statx&quot;, &quot;generate node/field statistics for scene after each AU&quot;, GF_ARG_BOOL, 0, &amp;stat_level, 3, 0),
<span class="lineNum">    1117 </span>            :         MP4BOX_ARG(&quot;hash&quot;, &quot;generate SHA-1 Hash of the input file&quot;, GF_ARG_BOOL, 0, &amp;do_hash, 0, 0),
<span class="lineNum">    1118 </span>            :         MP4BOX_ARG(&quot;comp&quot;, &quot;replace with compressed version all top level box types given as parameter, formatted as `orig_4cc_1=comp_4cc_1[,orig_4cc_2=comp_4cc_2]`&quot;, GF_ARG_STRING, 0, parse_comp_box, 0, ARG_IS_FUN),
<span class="lineNum">    1119 </span>            :         MP4BOX_ARG(&quot;topcount&quot;, &quot;print to stdout the number of top-level boxes matching box types given as parameter, formatted as `4cc_1,4cc_2N`&quot;, GF_ARG_STRING, 0, parse_comp_box, 2, ARG_IS_FUN),
<span class="lineNum">    1120 </span>            :         MP4BOX_ARG(&quot;topsize&quot;, &quot;print to stdout the number of bytes of top-level boxes matching types given as parameter, formatted as `4cc_1,4cc_2N` or `all` for all boxes&quot;, GF_ARG_STRING, 0, parse_comp_box, 1, ARG_IS_FUN),
<span class="lineNum">    1121 </span>            :         MP4BOX_ARG(&quot;bin&quot;, &quot;convert input XML file using NHML bitstream syntax to binary&quot;, GF_ARG_BOOL, 0, &amp;do_bin_xml, 0, 0),
<span class="lineNum">    1122 </span>            :         MP4BOX_ARG(&quot;mpd-rip&quot;, &quot;fetch MPD and segment to disk&quot;, GF_ARG_BOOL, 0, &amp;do_mpd_rip, 0, 0),
<span class="lineNum">    1123 </span>            :         MP4BOX_ARG_S(&quot;udp-write&quot;, &quot;IP[:port]&quot;, &quot;write input name to UDP (default port 2345)&quot;, GF_FS_ARG_HINT_EXPERT, &amp;udp_dest, 0, 0),
<span class="lineNum">    1124 </span>            :         MP4BOX_ARG(&quot;raw-cat&quot;, &quot;raw concatenation of given file with input file&quot;, GF_ARG_STRING, GF_FS_ARG_HINT_EXPERT, &amp;raw_cat, 0, 0),
<span class="lineNum">    1125 </span>            :         MP4BOX_ARG(&quot;wget&quot;, &quot;fetch resource from http(s) URL&quot;, GF_ARG_STRING, GF_FS_ARG_HINT_EXPERT, &amp;do_wget, 0, 0),
<span class="lineNum">    1126 </span>            :         MP4BOX_ARG(&quot;dm2ts&quot;, &quot;dump timing of an input MPEG-2 TS stream sample timing&quot;, GF_ARG_BOOL, 0, &amp;dump_m2ts, 0, 0),
<span class="lineNum">    1127 </span>            :         {0}
<a name="1128"><span class="lineNum">    1128 </span>            : };</a>
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span><span class="lineCov">          4 : void PrintDumpUsage()</span>
<span class="lineNum">    1131 </span>            : {
<span class="lineNum">    1132 </span>            :         u32 i=0;
<span class="lineNum">    1133 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# File Dumping\n&quot;</span>
<span class="lineNum">    1134 </span>            :         &quot;  \n&quot;
<span class="lineNum">    1135 </span>            :         &quot;MP4Box has many dump functionalities, from simple track listing to more complete reporting of special tracks.\n&quot;
<span class="lineNum">    1136 </span>            :         &quot;  \n&quot;
<span class="lineNum">    1137 </span>            :         &quot;Options:\n&quot;
<span class="lineNum">    1138 </span>            :         );
<span class="lineNum">    1139 </span><span class="lineCov">        220 :         while (m4b_dump_args[i].name) {</span>
<span class="lineNum">    1140 </span><span class="lineCov">        212 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_dump_args[i];</span>
<span class="lineNum">    1141 </span><span class="lineCov">        212 :                 i++;</span>
<span class="lineNum">    1142 </span><span class="lineCov">        212 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-extract&quot;);</span>
<span class="lineNum">    1143 </span>            :         }
<span class="lineNum">    1144 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">    1145 </span>            : 
<span class="lineNum">    1146 </span>            : MP4BoxArg m4b_meta_args[] =
<span class="lineNum">    1147 </span>            : {
<span class="lineNum">    1148 </span>            :         MP4BOX_ARG_S(&quot;set-meta&quot;, &quot;ABCD[:tk=tkID]&quot;, &quot;set meta box type, with `ABCD` the four char meta type (NULL or 0 to remove meta)\n&quot;
<span class="lineNum">    1149 </span>            :                 &quot;- tk not set: use root (file) meta\n&quot;
<span class="lineNum">    1150 </span>            :                 &quot;- tkID == 0: use moov meta\n&quot;
<span class="lineNum">    1151 </span>            :                 &quot;- tkID != 0: use meta of given track&quot;, 0, parse_meta_args, META_ACTION_SET_TYPE, ARG_IS_FUN),
<span class="lineNum">    1152 </span>            :         MP4BOX_ARG(&quot;add-item&quot;, &quot;add resource to meta, with parameter syntax `file_path[:opt1:optN]`\n&quot;
<span class="lineNum">    1153 </span>            :                 &quot;- file_path `this` or `self`: item is the file itself\n&quot;
<span class="lineNum">    1154 </span>            :                 &quot;- tk=tkID: meta location (file, moov, track)\n&quot;
<span class="lineNum">    1155 </span>            :                 &quot;- name=str: item name\n&quot;
<span class="lineNum">    1156 </span>            :                 &quot;- type=itype: item 4cc type (not needed if mime is provided)\n&quot;
<span class="lineNum">    1157 </span>            :                 &quot;- mime=mtype: item mime type\n&quot;
<span class="lineNum">    1158 </span>            :                 &quot;- encoding=enctype: item content-encoding type\n&quot;
<span class="lineNum">    1159 </span>            :                 &quot;- id=ID: item ID\n&quot;
<span class="lineNum">    1160 </span>            :                 &quot;- ref=4cc,id: reference of type 4cc to an other item (can be set multiple times)\n&quot;
<span class="lineNum">    1161 </span>            :                 &quot;- group=id,type: indicate the id and type of an alternate group for this item&quot;
<span class="lineNum">    1162 </span>            :                 , GF_ARG_STRING, 0, parse_meta_args, META_ACTION_ADD_ITEM, ARG_IS_FUN),
<span class="lineNum">    1163 </span>            :         MP4BOX_ARG(&quot;add-image&quot;, &quot;add the given file as HEIF image item, with parameter syntax `file_path[:opt1:optN]`. If `filepath` is omitted, source is the input MP4 file\n&quot;
<span class="lineNum">    1164 </span>            :                 &quot;- name, id, ref: see [-add-item]()\n&quot;
<span class="lineNum">    1165 </span>            :                 &quot;- primary: indicate that this item should be the primary item\n&quot;
<span class="lineNum">    1166 </span>            :                 &quot;- time=t[-e][/i]: use the next sync sample after time t (float, in sec, default 0). A negative time imports ALL intra frames as items\n&quot;
<span class="lineNum">    1167 </span>            :                 &quot; - If `e` is set (float, in sec), import all sync samples between `t` and `e`\n&quot;
<span class="lineNum">    1168 </span>            :                 &quot; - If `i` is set (float, in sec), sets time increment between samples to import\n&quot;
<span class="lineNum">    1169 </span>            :                 &quot;- split_tiles: for an HEVC tiled image, each tile is stored as a separate item\n&quot;
<span class="lineNum">    1170 </span>            :                 &quot;- image-size=wxh: force setting the image size and ignoring the bitstream info, used for grid images also\n&quot;
<span class="lineNum">    1171 </span>            :                 &quot;- rotation=a: set the rotation angle for this image to 90*a degrees anti-clockwise\n&quot;
<span class="lineNum">    1172 </span>            :                 &quot;- mirror-axis=axis: set the mirror axis: vertical, horizontal\n&quot;
<span class="lineNum">    1173 </span>            :                 &quot;- clap=Wn,Wd,Hn,Hd,HOn,HOd,VOn,VOd: see track clap\n&quot;
<span class="lineNum">    1174 </span>            :                 &quot;- hidden: indicate that this image item should be hidden\n&quot;
<span class="lineNum">    1175 </span>            :                 &quot;- icc_path: path to icc data to add as color info\n&quot;
<span class="lineNum">    1176 </span>            :                 &quot;- alpha: indicate that the image is an alpha image (should use ref=auxl also)\n&quot;
<span class="lineNum">    1177 </span>            :                 &quot;- tk=tkID: indicate the track ID of the source sample. If 0, uses the first video track in the file\n&quot;
<span class="lineNum">    1178 </span>            :                 &quot;- samp=N: indicate the sample number of the source sample\n&quot;
<span class="lineNum">    1179 </span>            :                 &quot;- ref: do not copy the data but refer to the final sample location\n&quot;
<span class="lineNum">    1180 </span>            :                 &quot;- agrid[=AR]: creates an automatic grid from the image items present in the file, in their declaration order. The grid will **try to** have `AR` aspect ratio if specified (float), or the aspect ratio of the source otherwise. The grid will be the primary item and all other images will be hidden\n&quot;
<span class="lineNum">    1181 </span>            :                 &quot;- any other options will be passed as options to the media importer, see [-add]()&quot;
<span class="lineNum">    1182 </span>            :                 , GF_ARG_STRING, 0, parse_meta_args, META_ACTION_ADD_IMAGE_ITEM, ARG_IS_FUN),
<span class="lineNum">    1183 </span>            :         MP4BOX_ARG(&quot;add-image-grid&quot;, &quot;create an image grid item, with parameter syntax `grid[:opt1:optN]`\n&quot;
<span class="lineNum">    1184 </span>            :                 &quot;- image-grid-size=rxc: set the number of rows and columns of the grid\n&quot;
<span class="lineNum">    1185 </span>            :             &quot;- any other options from [-add-image]() can be used\n&quot;, GF_ARG_STRING, 0, parse_meta_args, META_ACTION_ADD_IMAGE_GRID, ARG_IS_FUN),
<span class="lineNum">    1186 </span>            :         MP4BOX_ARG_S_ALT(&quot;rem-item&quot;, &quot;rem-image&quot;, &quot;item_ID[:tk=tkID]&quot;, &quot;remove resource from meta&quot;, 0, parse_meta_args, META_ACTION_REM_ITEM, ARG_IS_FUN),
<span class="lineNum">    1187 </span>            :         MP4BOX_ARG_S(&quot;set-primary&quot;, &quot;item_ID[:tk=tkID]&quot;, &quot;set item as primary for meta&quot;, 0, parse_meta_args, META_ACTION_SET_PRIMARY_ITEM, ARG_IS_FUN),
<span class="lineNum">    1188 </span>            :         MP4BOX_ARG_S(&quot;set-xml&quot;, &quot;xml_file_path[:tk=tkID][:binary]&quot;, &quot;set meta XML data&quot;, 0, parse_meta_args, META_ACTION_SET_XML, ARG_IS_FUN),
<span class="lineNum">    1189 </span>            :         MP4BOX_ARG_S(&quot;rem-xml&quot;, &quot;[tk=tkID]&quot;, &quot;remove meta XML data&quot;, 0, parse_meta_args, META_ACTION_REM_XML, ARG_IS_FUN),
<span class="lineNum">    1190 </span>            :         MP4BOX_ARG_S(&quot;dump-xml&quot;, &quot;file_path[:tk=tkID]&quot;, &quot;dump meta XML to file&quot;, 0, parse_meta_args, META_ACTION_DUMP_XML, ARG_IS_FUN),
<span class="lineNum">    1191 </span>            :         MP4BOX_ARG_S(&quot;dump-item&quot;, &quot;item_ID[:tk=tkID][:path=fileName]&quot;, &quot;dump item to file&quot;, 0, parse_meta_args, META_ACTION_DUMP_ITEM, ARG_IS_FUN),
<span class="lineNum">    1192 </span>            :         MP4BOX_ARG(&quot;package&quot;, &quot;package input XML file into an ISO container, all media referenced except hyperlinks are added to file&quot;, GF_ARG_STRING, 0, &amp;pack_file, 0, 0),
<span class="lineNum">    1193 </span>            :         MP4BOX_ARG(&quot;mgt&quot;, &quot;package input XML file into an MPEG-U widget with ISO container, all files contained in the current folder are added to the widget package&quot;, GF_ARG_STRING, 0, parse_mpegu, 0, ARG_IS_FUN),
<span class="lineNum">    1194 </span>            :         {0}
<a name="1195"><span class="lineNum">    1195 </span>            : };</a>
<span class="lineNum">    1196 </span>            : 
<span class="lineNum">    1197 </span><span class="lineCov">          4 : void PrintMetaUsage()</span>
<span class="lineNum">    1198 </span>            : {
<span class="lineNum">    1199 </span>            :         u32 i=0;
<span class="lineNum">    1200 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# Meta and HEIF Options\n&quot;</span>
<span class="lineNum">    1201 </span>            :         &quot;IsoMedia files can be used as generic meta-data containers, for examples storing XML information and sample images for a movie. The resulting file may not always contain a movie as is the case with some HEIF files or MPEG-21 files.\n&quot;
<span class="lineNum">    1202 </span>            :         &quot;  \n&quot;
<span class="lineNum">    1203 </span>            :         &quot;These information can be stored at the file root level, as is the case for HEIF/IFF and MPEG-21 file formats, or at the movie or track level for a regular movie.&quot;
<span class="lineNum">    1204 </span>            :         &quot;  \n  \n&quot;);
<span class="lineNum">    1205 </span><span class="lineCov">         56 :         while (m4b_meta_args[i].name) {</span>
<span class="lineNum">    1206 </span><span class="lineCov">         48 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_meta_args[i];</span>
<span class="lineNum">    1207 </span><span class="lineCov">         48 :                 i++;</span>
<span class="lineNum">    1208 </span><span class="lineCov">         48 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-extract&quot;);</span>
<span class="lineNum">    1209 </span>            :         }
<span class="lineNum">    1210 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">    1211 </span>            : 
<span class="lineNum">    1212 </span>            : MP4BoxArg m4b_swf_args[] =
<span class="lineNum">    1213 </span>            : {
<span class="lineNum">    1214 </span>            :         MP4BOX_ARG(&quot;global&quot;, &quot;all SWF defines are placed in first scene replace rather than when needed&quot;, GF_ARG_BOOL, 0, &amp;swf_flags, GF_SM_SWF_STATIC_DICT, ARG_BIT_MASK),
<span class="lineNum">    1215 </span>            :         MP4BOX_ARG(&quot;no-ctrl&quot;, &quot;use a single stream for movie control and dictionary (this will disable ActionScript)&quot;, GF_ARG_BOOL, 0, &amp;swf_flags, GF_SM_SWF_SPLIT_TIMELINE, ARG_BIT_MASK_REM),
<span class="lineNum">    1216 </span>            :         MP4BOX_ARG(&quot;no-text&quot;, &quot;remove all SWF text&quot;, GF_ARG_BOOL, 0, &amp;swf_flags, GF_SM_SWF_NO_TEXT, ARG_BIT_MASK),
<span class="lineNum">    1217 </span>            :         MP4BOX_ARG(&quot;no-font&quot;, &quot;remove all embedded SWF Fonts (local playback host fonts used)&quot;, GF_ARG_BOOL, 0, &amp;swf_flags, GF_SM_SWF_NO_FONT, ARG_BIT_MASK),
<span class="lineNum">    1218 </span>            :         MP4BOX_ARG(&quot;no-line&quot;, &quot;remove all lines from SWF shapes&quot;, GF_ARG_BOOL, 0, &amp;swf_flags, GF_SM_SWF_NO_LINE, ARG_BIT_MASK),
<span class="lineNum">    1219 </span>            :         MP4BOX_ARG(&quot;no-grad&quot;, &quot;remove all gradients from swf shapes&quot;, GF_ARG_BOOL, 0, &amp;swf_flags, GF_SM_SWF_NO_GRADIENT, ARG_BIT_MASK),
<span class="lineNum">    1220 </span>            :         MP4BOX_ARG(&quot;quad&quot;, &quot;use quadratic bezier curves instead of cubic ones&quot;, GF_ARG_BOOL, 0, &amp;swf_flags, GF_SM_SWF_QUAD_CURVE, ARG_BIT_MASK),
<span class="lineNum">    1221 </span>            :         MP4BOX_ARG(&quot;xlp&quot;, &quot;support for lines transparency and scalability&quot;, GF_ARG_BOOL, 0, &amp;swf_flags, GF_SM_SWF_SCALABLE_LINE, ARG_BIT_MASK),
<span class="lineNum">    1222 </span>            :         MP4BOX_ARG(&quot;ic2d&quot;, &quot;use indexed curve 2D hardcoded proto&quot;, GF_ARG_BOOL, 0, &amp;swf_flags, GF_SM_SWF_USE_IC2D, ARG_BIT_MASK),
<span class="lineNum">    1223 </span>            :         MP4BOX_ARG(&quot;same-app&quot;, &quot;appearance nodes are reused&quot;, GF_ARG_BOOL, 0, &amp;swf_flags, GF_SM_SWF_REUSE_APPEARANCE, ARG_BIT_MASK),
<span class="lineNum">    1224 </span>            :         MP4BOX_ARG(&quot;flatten&quot;, &quot;complementary angle below which 2 lines are merged, value `0` means no flattening&quot;, GF_ARG_DOUBLE, 0, &amp;swf_flatten_angle, 0, 0),
<span class="lineNum">    1225 </span>            :         {0}
<a name="1226"><span class="lineNum">    1226 </span>            : };</a>
<span class="lineNum">    1227 </span>            : 
<span class="lineNum">    1228 </span><span class="lineCov">          4 : void PrintSWFUsage()</span>
<span class="lineNum">    1229 </span>            : {
<span class="lineNum">    1230 </span>            :         u32 i=0;
<span class="lineNum">    1231 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# SWF Importer Options\n&quot;</span>
<span class="lineNum">    1232 </span>            :                 &quot;\n&quot;
<span class="lineNum">    1233 </span>            :                 &quot;MP4Box can import simple Macromedia Flash files (\&quot;.SWF\&quot;)\n&quot;
<span class="lineNum">    1234 </span>            :                 &quot;You can specify a SWF input file with \'-bt\', \'-xmt\' and \'-mp4\' options\n&quot;
<span class="lineNum">    1235 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    1236 </span>            :                 &quot;Options:\n&quot;
<span class="lineNum">    1237 </span>            :         );
<span class="lineNum">    1238 </span><span class="lineCov">         52 :         while (m4b_swf_args[i].name) {</span>
<span class="lineNum">    1239 </span><span class="lineCov">         44 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_swf_args[i];</span>
<span class="lineNum">    1240 </span><span class="lineCov">         44 :                 i++;</span>
<span class="lineNum">    1241 </span><span class="lineCov">         44 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-extract&quot;);</span>
<span class="lineNum">    1242 </span>            :         }
<span class="lineNum">    1243 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">    1244 </span>            : 
<span class="lineNum">    1245 </span>            : MP4BoxArg m4b_liveenc_args[] =
<span class="lineNum">    1246 </span>            : {
<span class="lineNum">    1247 </span>            :         MP4BOX_ARG(&quot;live&quot;, &quot;enable live BIFS/LASeR encoder&quot;, GF_ARG_BOOL, 0, &amp;live_scene, 0, 0),
<span class="lineNum">    1248 </span>            :         GF_DEF_ARG(&quot;dst&quot;, NULL, &quot;destination IP&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">    1249 </span>            :         GF_DEF_ARG(&quot;port&quot;, NULL, &quot;destination port&quot;, &quot;7000&quot;, NULL, GF_ARG_INT, 0),
<span class="lineNum">    1250 </span>            :         GF_DEF_ARG(&quot;mtu&quot;, NULL, &quot;path MTU for RTP packets&quot;, &quot;1450&quot;, NULL, GF_ARG_INT, 0),
<span class="lineNum">    1251 </span>            :         GF_DEF_ARG(&quot;ifce&quot;, NULL, &quot;IP address of the physical interface to use&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">    1252 </span>            :         GF_DEF_ARG(&quot;ttl&quot;, NULL, &quot;time to live for multicast packets&quot;, &quot;1&quot;, NULL, GF_ARG_INT, 0),
<span class="lineNum">    1253 </span>            :         GF_DEF_ARG(&quot;sdp&quot;, NULL, &quot;output SDP file&quot;, &quot;session.sdp&quot;, NULL, GF_ARG_STRING, 0),
<span class="lineNum">    1254 </span>            :         GF_DEF_ARG(&quot;dims&quot;, NULL, &quot;turn on DIMS mode for SVG input&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">    1255 </span>            :         GF_DEF_ARG(&quot;no-rap&quot;, NULL, &quot;disable RAP sending and carousel generation&quot;, NULL, NULL, GF_ARG_BOOL, 0),
<span class="lineNum">    1256 </span>            :         GF_DEF_ARG(&quot;src&quot;, NULL, &quot;source of scene updates&quot;, NULL, NULL, GF_ARG_STRING, 0),
<span class="lineNum">    1257 </span>            :         GF_DEF_ARG(&quot;rap&quot;, NULL, &quot;duration in ms of base carousel; you can specify the RAP period of a single ESID (not in DIMS) using `ESID=X:time`&quot;, NULL, NULL, GF_ARG_INT, 0),
<span class="lineNum">    1258 </span>            :         {0}
<a name="1259"><span class="lineNum">    1259 </span>            : };</a>
<span class="lineNum">    1260 </span>            : 
<span class="lineNum">    1261 </span><span class="lineCov">          4 : void PrintLiveUsage()</span>
<span class="lineNum">    1262 </span>            : {
<span class="lineNum">    1263 </span>            :         u32 i=0;
<span class="lineNum">    1264 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;# Live Scene Encoder Options\n&quot;</span>
<span class="lineNum">    1265 </span>            :                 &quot;The options shall be specified as òpt_name=opt_val.\n&quot;
<span class="lineNum">    1266 </span>            :                 &quot;Options:\n&quot;
<span class="lineNum">    1267 </span>            :                 &quot;\n&quot;
<span class="lineNum">    1268 </span>            :         );
<span class="lineNum">    1269 </span><span class="lineCov">         52 :         while (m4b_liveenc_args[i].name) {</span>
<span class="lineNum">    1270 </span><span class="lineCov">         44 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_liveenc_args[i];</span>
<span class="lineNum">    1271 </span><span class="lineCov">         44 :                 i++;</span>
<span class="lineNum">    1272 </span><span class="lineCov">         44 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-extract&quot;);</span>
<span class="lineNum">    1273 </span>            :         }
<span class="lineNum">    1274 </span>            : 
<span class="lineNum">    1275 </span><span class="lineCov">          4 :         gf_sys_format_help(helpout, help_flags, &quot;  \n&quot;</span>
<span class="lineNum">    1276 </span>            :                 &quot;Runtime options:\n&quot;
<span class="lineNum">    1277 </span>            :                 &quot;- q: quits\n&quot;
<span class="lineNum">    1278 </span>            :                 &quot;- u: inputs some commands to be sent\n&quot;
<span class="lineNum">    1279 </span>            :                 &quot;- U: same as u but signals the updates as critical\n&quot;
<span class="lineNum">    1280 </span>            :                 &quot;- e: inputs some commands to be sent without being aggregated\n&quot;
<span class="lineNum">    1281 </span>            :                 &quot;- E: same as e but signals the updates as critical\n&quot;
<span class="lineNum">    1282 </span>            :                 &quot;- f: forces RAP sending\n&quot;
<span class="lineNum">    1283 </span>            :                 &quot;- F: forces RAP regeneration and sending\n&quot;
<span class="lineNum">    1284 </span>            :                 &quot;- p: dumps current scene\n&quot;
<span class="lineNum">    1285 </span>            :         );
<a name="1286"><span class="lineNum">    1286 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">    1287 </span>            : 
<span class="lineNum">    1288 </span><span class="lineCov">          1 : void PrintCoreUsage()</span>
<span class="lineNum">    1289 </span>            : {
<span class="lineNum">    1290 </span><span class="lineCov">          1 :         gf_sys_format_help(helpout, help_flags, &quot;# libgpac core options\n&quot;);</span>
<span class="lineNum">    1291 </span><span class="lineCov">          1 :         gf_sys_print_core_help(helpout, 0, GF_ARGMODE_ALL, 0);</span>
<a name="1292"><span class="lineNum">    1292 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    1293 </span>            : 
<span class="lineNum">    1294 </span><span class="lineCov">          3 : void PrintTags()</span>
<span class="lineNum">    1295 </span>            : {
<span class="lineNum">    1296 </span>            :         u32 i = 0;
<span class="lineNum">    1297 </span>            : 
<span class="lineNum">    1298 </span><span class="lineCov">          3 :         gf_sys_format_help(helpout, help_flags, &quot;# Tagging support\n&quot;</span>
<span class="lineNum">    1299 </span>            :         &quot;Tags are specified as a colon-separated list `tag_name=tag_value[:tag2=val2]`\n&quot;
<span class="lineNum">    1300 </span>            :         &quot;Setting a tag with no value or value `NULL` removes the tag.\n&quot;
<span class="lineNum">    1301 </span>            :         &quot;Special tag value `clear` (or `reset`) removes all tags.\n&quot;
<span class="lineNum">    1302 </span>            :         &quot;Unsupported tags can be added using their four character code as a tag name, and string value will be assumed.\n&quot;
<span class="lineNum">    1303 </span>            :         &quot;If the tag name length is 3, the prefix 0xA9 is used to create the four character code.\n&quot;
<span class="lineNum">    1304 </span>            :         &quot;  \n&quot;
<span class="lineNum">    1305 </span>            :         &quot;Tags can also be loaded from a text file using `-itags filename`. The file must be in UTF8 with:\n&quot;
<span class="lineNum">    1306 </span>            :         &quot;- lines starting with `tag_name=value` specify the start of a tag\n&quot;
<span class="lineNum">    1307 </span>            :         &quot;- other lines specify the remainder of the last declared tag\n&quot;
<span class="lineNum">    1308 </span>            :         &quot;  \n&quot;
<span class="lineNum">    1309 </span>            :         &quot;If tag name starts with `WM/`, the tag is added to `Xtra` box (WMA tag, string only).\n&quot;
<span class="lineNum">    1310 </span>            :         &quot;  \n&quot;
<span class="lineNum">    1311 </span>            :         &quot;Supported tag names, values, types, aliases:\n&quot;
<span class="lineNum">    1312 </span>            :         );
<span class="lineNum">    1313 </span>            : 
<span class="lineNum">    1314 </span><span class="lineCov">        189 :         while (1) {</span>
<span class="lineNum">    1315 </span><span class="lineCov">        192 :                 s32 type = gf_itags_get_type(i);</span>
<span class="lineNum">    1316 </span><span class="lineCov">        192 :                 if (type&lt;0) break;</span>
<span class="lineNum">    1317 </span><span class="lineCov">        189 :                 const char *name = gf_itags_get_name(i);</span>
<span class="lineNum">    1318 </span><span class="lineCov">        189 :                 u32 itag = gf_itags_get_itag(i);</span>
<span class="lineNum">    1319 </span><span class="lineCov">        189 :                 gf_sys_format_help(helpout, help_flags | GF_PRINTARG_HIGHLIGHT_FIRST , &quot;%s&quot;, name);</span>
<span class="lineNum">    1320 </span><span class="lineCov">        189 :                 gf_sys_format_help(helpout, help_flags, &quot; (%s) &quot;, gf_4cc_to_str(itag) );</span>
<span class="lineNum">    1321 </span><span class="lineCov">        189 :                 switch (type) {</span>
<span class="lineNum">    1322 </span><span class="lineCov">        150 :                 case GF_ITAG_STR:</span>
<span class="lineNum">    1323 </span><span class="lineCov">        150 :                         gf_sys_format_help(helpout, help_flags, &quot;string&quot;); break;</span>
<span class="lineNum">    1324 </span><span class="lineCov">         18 :                 case GF_ITAG_INT8:</span>
<span class="lineNum">    1325 </span>            :                 case GF_ITAG_INT16:
<span class="lineNum">    1326 </span>            :                 case GF_ITAG_INT32:
<span class="lineNum">    1327 </span>            :                 case GF_ITAG_INT64:
<span class="lineNum">    1328 </span><span class="lineCov">         18 :                         gf_sys_format_help(helpout, help_flags, &quot;integer&quot;); break;</span>
<span class="lineNum">    1329 </span><span class="lineCov">          6 :                 case GF_ITAG_FRAC6:</span>
<span class="lineNum">    1330 </span>            :                 case GF_ITAG_FRAC8:
<span class="lineNum">    1331 </span><span class="lineCov">          6 :                         gf_sys_format_help(helpout, help_flags, &quot;fraction (syntax: `A/B` or `A`, B will be 0)&quot;); break;</span>
<span class="lineNum">    1332 </span><span class="lineCov">          9 :                 case GF_ITAG_BOOL:</span>
<span class="lineNum">    1333 </span><span class="lineCov">          9 :                         gf_sys_format_help(helpout, help_flags, &quot;bool (`yes` or `no`)&quot;); break;</span>
<span class="lineNum">    1334 </span><span class="lineCov">          3 :                 case GF_ITAG_ID3_GENRE:</span>
<span class="lineNum">    1335 </span><span class="lineCov">          3 :                         gf_sys_format_help(helpout, help_flags, &quot;string (ID3 genre tag)&quot;); break;</span>
<span class="lineNum">    1336 </span><span class="lineCov">          3 :                 case GF_ITAG_FILE:</span>
<span class="lineNum">    1337 </span><span class="lineCov">          3 :                         gf_sys_format_help(helpout, help_flags, &quot;file path&quot;); break;</span>
<span class="lineNum">    1338 </span>            :                 }
<span class="lineNum">    1339 </span><span class="lineCov">        189 :                 name = gf_itags_get_alt_name(i);</span>
<span class="lineNum">    1340 </span><span class="lineCov">        189 :                 if (name) {</span>
<span class="lineNum">    1341 </span><span class="lineCov">         75 :                         gf_sys_format_help(helpout, help_flags, &quot; (`alias` %s)&quot;, name);</span>
<span class="lineNum">    1342 </span>            :                 }
<span class="lineNum">    1343 </span>            : 
<span class="lineNum">    1344 </span><span class="lineCov">        189 :                 gf_sys_format_help(helpout, help_flags, &quot;\n&quot;);</span>
<span class="lineNum">    1345 </span><span class="lineCov">        189 :                 i++;</span>
<span class="lineNum">    1346 </span>            :         }
<a name="1347"><span class="lineNum">    1347 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">    1348 </span>            : 
<span class="lineNum">    1349 </span><span class="lineCov">          2 : void PrintCICP()</span>
<span class="lineNum">    1350 </span>            : {
<span class="lineNum">    1351 </span>            :         u32 i;
<span class="lineNum">    1352 </span><span class="lineCov">          2 :         gf_sys_format_help(helpout, help_flags, &quot;# Video CICP (ISO/IEC 23091-2) Constants\n&quot;);</span>
<span class="lineNum">    1353 </span><span class="lineCov">          2 :         gf_sys_format_help(helpout, help_flags, &quot;CICP Color Primaries:\n&quot;);</span>
<span class="lineNum">    1354 </span><span class="lineCov">         48 :         for (i=0; i&lt;GF_CICP_PRIM_LAST; i++) {</span>
<span class="lineNum">    1355 </span><span class="lineCov">         46 :                 const char *name = gf_cicp_color_primaries_name(i);</span>
<span class="lineNum">    1356 </span><span class="lineCov">         46 :                 if (!name || !strcmp(name, &quot;unknwon&quot;)) continue;</span>
<span class="lineNum">    1357 </span><span class="lineCov">         28 :                 gf_sys_format_help(helpout, help_flags, &quot; - `%s` (value %d)\n&quot;, name, i);</span>
<span class="lineNum">    1358 </span>            :         }
<span class="lineNum">    1359 </span><span class="lineCov">          2 :         gf_sys_format_help(helpout, help_flags, &quot;  \nCICP Color Transfer Characteristics:\n&quot;);</span>
<span class="lineNum">    1360 </span><span class="lineCov">         40 :         for (i=0; i&lt;GF_CICP_TRANSFER_LAST; i++) {</span>
<span class="lineNum">    1361 </span><span class="lineCov">         38 :                 const char *name = gf_cicp_color_transfer_name(i);</span>
<span class="lineNum">    1362 </span><span class="lineCov">         38 :                 if (!name) continue;</span>
<span class="lineNum">    1363 </span><span class="lineCov">         38 :                 gf_sys_format_help(helpout, help_flags, &quot; - `%s` (value %d)\n&quot;, name, i);</span>
<span class="lineNum">    1364 </span>            :         }
<span class="lineNum">    1365 </span><span class="lineCov">          2 :         gf_sys_format_help(helpout, help_flags, &quot;  \nCICP Color Matrix Coefficients:\n&quot;);</span>
<span class="lineNum">    1366 </span><span class="lineCov">         26 :         for (i=0; i&lt;GF_CICP_MX_LAST; i++) {</span>
<span class="lineNum">    1367 </span><span class="lineCov">         24 :                 const char *name = gf_cicp_color_matrix_name(i);</span>
<span class="lineNum">    1368 </span><span class="lineCov">         24 :                 if (!name) continue;</span>
<span class="lineNum">    1369 </span><span class="lineCov">         24 :                 gf_sys_format_help(helpout, help_flags, &quot; - `%s` (value %d)\n&quot;, name, i);</span>
<span class="lineNum">    1370 </span>            :         }
<span class="lineNum">    1371 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">    1372 </span>            : 
<span class="lineNum">    1373 </span>            : MP4BoxArg m4b_usage_args[] =
<span class="lineNum">    1374 </span>            : {
<span class="lineNum">    1375 </span>            :         MP4BOX_ARG(&quot;h&quot;, &quot;print help\n&quot;
<span class="lineNum">    1376 </span>            :                 &quot;- general: general options help\n&quot;
<span class="lineNum">    1377 </span>            :                 &quot;- hint: hinting options help\n&quot;
<span class="lineNum">    1378 </span>            :                 &quot;- dash: DASH segmenter help\n&quot;
<span class="lineNum">    1379 </span>            :                 &quot;- split: split options help\n&quot;
<span class="lineNum">    1380 </span>            :                 &quot;- import: import options help\n&quot;
<span class="lineNum">    1381 </span>            :                 &quot;- encode: scene descrription encoding options help\n&quot;
<span class="lineNum">    1382 </span>            :                 &quot;- meta: meta (HEIF, MPEG-21) handling options help\n&quot;
<span class="lineNum">    1383 </span>            :                 &quot;- extract: extraction options help\n&quot;
<span class="lineNum">    1384 </span>            :                 &quot;- dump: dump options help\n&quot;
<span class="lineNum">    1385 </span>            :                 &quot;- swf: Flash (SWF) options help\n&quot;
<span class="lineNum">    1386 </span>            :                 &quot;- crypt: ISMA E&amp;A options help\n&quot;
<span class="lineNum">    1387 </span>            :                 &quot;- format: supported formats help\n&quot;
<span class="lineNum">    1388 </span>            :                 &quot;- live: BIFS streamer help\n&quot;
<span class="lineNum">    1389 </span>            :                 &quot;- core: libgpac core options\n&quot;
<span class="lineNum">    1390 </span>            :                 &quot;- all: print all the above help screens\n&quot;
<span class="lineNum">    1391 </span>            :                 &quot;- opts: print all options\n&quot;
<span class="lineNum">    1392 </span>            :                 &quot;- tags: print supported iTunes tags\n&quot;
<span class="lineNum">    1393 </span>            :                 &quot;- cicp: print various CICP code points\n&quot;
<span class="lineNum">    1394 </span>            :                 &quot;- VAL: search for option named `VAL` (without `-` or `--`) in MP4Box, libgpac core and all filters\n&quot;
<span class="lineNum">    1395 </span>            :                 , GF_ARG_STRING, 0, parse_help, 0, ARG_IS_FUN | ARG_EMPTY | ARG_PUSH_SYSARGS),
<span class="lineNum">    1396 </span>            :         MP4BOX_ARG(&quot;hx&quot;, &quot;look for given string in all possible options&quot;
<span class="lineNum">    1397 </span>            :                 , GF_ARG_STRING, 0, parse_help, 1, ARG_IS_FUN),
<span class="lineNum">    1398 </span>            :         MP4BOX_ARG(&quot;nodes&quot;, &quot;list supported MPEG4 nodes&quot;, GF_ARG_BOOL, 0, PrintBuiltInNodes, 0, ARG_IS_FUN),
<span class="lineNum">    1399 </span>            :         MP4BOX_ARG(&quot;nodex&quot;, &quot;list supported MPEG4 nodes and print nodes&quot;, GF_ARG_BOOL, 0, PrintBuiltInNodes, 1, ARG_IS_FUN),
<span class="lineNum">    1400 </span>            :         MP4BOX_ARG(&quot;node&quot;, &quot;get given MPEG4 node syntax and QP infolist&quot;, GF_ARG_STRING, 0, PrintNode, 0, ARG_IS_FUN),
<span class="lineNum">    1401 </span>            :         MP4BOX_ARG(&quot;xnodes&quot;, &quot;list supported X3D nodes&quot;, GF_ARG_BOOL, 0, PrintBuiltInNodes, 2, ARG_IS_FUN),
<span class="lineNum">    1402 </span>            :         MP4BOX_ARG(&quot;xnodex&quot;, &quot;list supported X3D nodes and print nodes&quot;, GF_ARG_BOOL, 0, PrintBuiltInNodes, 3, ARG_IS_FUN),
<span class="lineNum">    1403 </span>            :         MP4BOX_ARG(&quot;xnode&quot;, &quot;get given X3D node syntax&quot;, GF_ARG_STRING, 0, PrintNode, 1, ARG_IS_FUN),
<span class="lineNum">    1404 </span>            :         MP4BOX_ARG(&quot;snodes&quot;, &quot;list supported SVG nodes&quot;, GF_ARG_BOOL, 0, PrintBuiltInNodes, 4, ARG_IS_FUN),
<span class="lineNum">    1405 </span>            :         MP4BOX_ARG(&quot;languages&quot;, &quot;list supported ISO 639 languages&quot;, GF_ARG_BOOL, 0, PrintLanguages, 0, ARG_IS_FUN),
<span class="lineNum">    1406 </span>            :         MP4BOX_ARG(&quot;boxes&quot;, &quot;list all supported ISOBMF boxes and their syntax&quot;, GF_ARG_BOOL, 0, PrintBuiltInBoxes, 0, ARG_IS_FUN),
<span class="lineNum">    1407 </span>            :         MP4BOX_ARG(&quot;boxcov&quot;, &quot;perform coverage of box IO coode&quot;, GF_ARG_BOOL, GF_ARG_HINT_HIDE, PrintBuiltInBoxes, 1, ARG_IS_FUN|ARG_PUSH_SYSARGS),
<span class="lineNum">    1408 </span>            :         MP4BOX_ARG(&quot;fstat&quot;, &quot;print filter session statistics (import/export/encrypt/decrypt/dashing)&quot;, GF_ARG_BOOL, 0, &amp;fs_dump_flags, 1, ARG_BIT_MASK),
<span class="lineNum">    1409 </span>            :         MP4BOX_ARG(&quot;fgraph&quot;, &quot;print filter session graph (import/export/encrypt/decrypt/dashing)&quot;, GF_ARG_BOOL, 0, &amp;fs_dump_flags, 2, ARG_BIT_MASK),
<span class="lineNum">    1410 </span>            :         MP4BOX_ARG(&quot;v&quot;, &quot;verbose mode&quot;, GF_ARG_BOOL, 0, &amp;verbose, 0, ARG_INT_INC),
<span class="lineNum">    1411 </span>            :         MP4BOX_ARG(&quot;version&quot;, &quot;get build version&quot;, GF_ARG_BOOL, 0, print_version, 0, ARG_IS_FUN),
<span class="lineNum">    1412 </span>            :         MP4BOX_ARG(&quot;genmd&quot;, &quot;generate MD doc&quot;, GF_ARG_BOOL, GF_ARG_HINT_HIDE, parse_gendoc, 0, ARG_IS_FUN),
<span class="lineNum">    1413 </span>            :         MP4BOX_ARG(&quot;genman&quot;, &quot;generate man doc&quot;, GF_ARG_BOOL, GF_ARG_HINT_HIDE, parse_gendoc, 1, ARG_IS_FUN),
<span class="lineNum">    1414 </span>            :         MP4BOX_ARG_S(&quot;--&quot;, &quot;INPUT&quot;, &quot;escape option if INPUT starts with `-` character&quot;, 0, NULL, 0, 0),
<span class="lineNum">    1415 </span>            :         {0}
<a name="1416"><span class="lineNum">    1416 </span>            : };</a>
<span class="lineNum">    1417 </span>            : 
<span class="lineNum">    1418 </span><span class="lineCov">          3 : void PrintUsage()</span>
<span class="lineNum">    1419 </span>            : {
<span class="lineNum">    1420 </span>            :         u32 i=0;
<span class="lineNum">    1421 </span><span class="lineCov">          3 :         gf_sys_format_help(helpout, help_flags, &quot;MP4Box [option] input [option]\n&quot;</span>
<span class="lineNum">    1422 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    1423 </span>            :                 &quot;# General Options:\n&quot;
<span class="lineNum">    1424 </span>            :         );
<span class="lineNum">    1425 </span><span class="lineCov">         63 :         while (m4b_usage_args[i].name) {</span>
<span class="lineNum">    1426 </span><span class="lineCov">         57 :                 GF_GPACArg *arg = (GF_GPACArg *) &amp;m4b_usage_args[i];</span>
<span class="lineNum">    1427 </span><span class="lineCov">         57 :                 i++;</span>
<span class="lineNum">    1428 </span><span class="lineCov">         57 :                 gf_sys_print_arg(helpout, help_flags, arg, &quot;mp4box-general&quot;);</span>
<span class="lineNum">    1429 </span>            :         }
<span class="lineNum">    1430 </span><span class="lineCov">          3 : }</span>
<span class="lineNum">    1431 </span>            : 
<span class="lineNum">    1432 </span>            : /*
<span class="lineNum">    1433 </span>            :  *              END OF ARGS PARSING AND HELP
<span class="lineNum">    1434 </span>            :  */
<span class="lineNum">    1435 </span>            : 
<span class="lineNum">    1436 </span>            : 
<span class="lineNum">    1437 </span>            : enum
<span class="lineNum">    1438 </span>            : {
<span class="lineNum">    1439 </span>            :         SEARCH_ARG_EXACT,
<span class="lineNum">    1440 </span>            :         SEARCH_ARG_CLOSE,
<span class="lineNum">    1441 </span>            :         SEARCH_DESC,
<a name="1442"><span class="lineNum">    1442 </span>            : };</a>
<span class="lineNum">    1443 </span>            : 
<span class="lineNum">    1444 </span><span class="lineCov">       1336 : static Bool strstr_nocase(const char *text, const char *subtext, u32 subtext_len)</span>
<span class="lineNum">    1445 </span>            : {
<span class="lineNum">    1446 </span><span class="lineCov">       1336 :         if (!*text || !subtext || !subtext_len)</span>
<span class="lineNum">    1447 </span>            :                 return GF_FALSE;
<span class="lineNum">    1448 </span>            : 
<span class="lineNum">    1449 </span><span class="lineCov">     112202 :         while (*text) {</span>
<span class="lineNum">    1450 </span><span class="lineCov">     110871 :                 if (tolower(*text) == *subtext) {</span>
<span class="lineNum">    1451 </span><span class="lineCov">       1914 :                         if (!strnicmp(text, subtext, subtext_len))</span>
<span class="lineNum">    1452 </span>            :                                 return GF_TRUE;
<span class="lineNum">    1453 </span>            : 
<span class="lineNum">    1454 </span>            :                 }
<span class="lineNum">    1455 </span><span class="lineCov">     110866 :                 text++;</span>
<span class="lineNum">    1456 </span>            :         }
<span class="lineNum">    1457 </span>            :         return GF_FALSE;
<a name="1458"><span class="lineNum">    1458 </span>            : }</a>
<span class="lineNum">    1459 </span>            : 
<span class="lineNum">    1460 </span><span class="lineCov">         45 : static u32 PrintHelpForArgs(char *arg_name, MP4BoxArg *args, GF_GPACArg *_args, u32 search_type)</span>
<span class="lineNum">    1461 </span>            : {
<span class="lineNum">    1462 </span>            :         u32 res=0;
<span class="lineNum">    1463 </span>            :         u32 i=0;
<span class="lineNum">    1464 </span><span class="lineCov">         45 :         u32 alen = (u32) strlen(arg_name);</span>
<span class="lineNum">    1465 </span>            : 
<span class="lineNum">    1466 </span>            :         while (1) {
<span class="lineNum">    1467 </span>            :                 u32 flags=0;
<span class="lineNum">    1468 </span>            :                 GF_GPACArg *arg;
<span class="lineNum">    1469 </span>            :                 GF_GPACArg an_arg;
<span class="lineNum">    1470 </span>            :                 Bool do_match = GF_FALSE;
<span class="lineNum">    1471 </span><span class="lineCov">       1518 :                 if (args) {</span>
<span class="lineNum">    1472 </span><span class="lineCov">       1245 :                         if (!args[i].name)</span>
<span class="lineNum">    1473 </span>            :                                 break;
<span class="lineNum">    1474 </span>            :                         arg = (GF_GPACArg *) &amp;args[i];
<span class="lineNum">    1475 </span>            :                 } else {
<span class="lineNum">    1476 </span><span class="lineCov">        273 :                         if (!_args[i].name)</span>
<span class="lineNum">    1477 </span>            :                                 break;
<span class="lineNum">    1478 </span>            :                         arg = &amp;_args[i];
<span class="lineNum">    1479 </span>            :                 }
<span class="lineNum">    1480 </span>            : 
<span class="lineNum">    1481 </span><span class="lineCov">       1473 :                 if (args == m4b_imp_fileopt_args) {</span>
<span class="lineNum">    1482 </span>            :                         flags = GF_PRINTARG_COLON;
<span class="lineNum">    1483 </span><span class="lineCov">        297 :                         if (!strncmp(arg_name, arg-&gt;name, alen) &amp;&amp; ((arg-&gt;name[alen]==0) || (arg-&gt;name[alen]=='=')))</span>
<span class="lineNum">    1484 </span>            :                                 do_match = GF_TRUE;
<span class="lineNum">    1485 </span>            :                 }
<span class="lineNum">    1486 </span><span class="lineCov">       1176 :                 else if (!strcmp(arg_name, arg-&gt;name))</span>
<span class="lineNum">    1487 </span>            :                         do_match = GF_TRUE;
<span class="lineNum">    1488 </span><span class="lineCov">       1176 :                 else if ((alen &lt; (u32) strlen(arg-&gt;name)) &amp;&amp; (arg-&gt;name[alen]==' ') &amp;&amp; !strncmp(arg_name, arg-&gt;name, alen))</span>
<span class="lineNum">    1489 </span>            :                         do_match = GF_TRUE;
<span class="lineNum">    1490 </span>            : 
<span class="lineNum">    1491 </span><span class="lineCov">       1473 :                 if (arg_name[0] == '@')</span>
<span class="lineNum">    1492 </span>            :                         do_match = GF_TRUE;
<span class="lineNum">    1493 </span>            : 
<span class="lineNum">    1494 </span><span class="lineCov">       1473 :                 if ((search_type==SEARCH_ARG_EXACT) &amp;&amp; !do_match) {</span>
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :                         i++;</span>
<span class="lineNum">    1496 </span><span class="lineCov">       1462 :                         continue;</span>
<span class="lineNum">    1497 </span>            :                 }
<span class="lineNum">    1498 </span><span class="lineCov">       1473 :                 if ((search_type==SEARCH_ARG_CLOSE) &amp;&amp; !gf_sys_word_match(arg_name, arg-&gt;name)) {</span>
<span class="lineNum">    1499 </span><span class="lineCov">        972 :                         i++;</span>
<span class="lineNum">    1500 </span><span class="lineCov">        972 :                         continue;</span>
<span class="lineNum">    1501 </span>            :                 }
<span class="lineNum">    1502 </span><span class="lineCov">        501 :                 if ((search_type==SEARCH_DESC) &amp;&amp; !strstr_nocase(arg-&gt;description, arg_name, alen)) {</span>
<span class="lineNum">    1503 </span><span class="lineCov">        490 :                         i++;</span>
<span class="lineNum">    1504 </span><span class="lineCov">        490 :                         continue;</span>
<span class="lineNum">    1505 </span>            :                 }
<span class="lineNum">    1506 </span>            : 
<span class="lineNum">    1507 </span><span class="lineCov">         11 :                 an_arg = *arg;</span>
<span class="lineNum">    1508 </span><span class="lineCov">         11 :                 if (search_type!=SEARCH_ARG_EXACT) {</span>
<span class="lineNum">    1509 </span><span class="lineCov">         11 :                         an_arg.description = NULL;</span>
<span class="lineNum">    1510 </span><span class="lineCov">         11 :                         an_arg.type = GF_ARG_BOOL;</span>
<span class="lineNum">    1511 </span>            :                 }
<span class="lineNum">    1512 </span><span class="lineCov">         11 :                 gf_sys_print_arg(helpout, flags, (GF_GPACArg *) &amp;an_arg, &quot;&quot;);</span>
<span class="lineNum">    1513 </span><span class="lineCov">         11 :                 res++;</span>
<span class="lineNum">    1514 </span><span class="lineCov">         11 :                 i++;</span>
<span class="lineNum">    1515 </span>            :         }
<a name="1516"><span class="lineNum">    1516 </span><span class="lineCov">         45 :         return res;</span></a>
<span class="lineNum">    1517 </span>            : }
<span class="lineNum">    1518 </span><span class="lineCov">          3 : static Bool PrintHelpArg(char *arg_name, u32 search_type, GF_FilterSession *fs)</span>
<span class="lineNum">    1519 </span>            : {
<span class="lineNum">    1520 </span>            :         Bool first=GF_TRUE;
<span class="lineNum">    1521 </span>            :         GF_GPACArg an_arg;
<span class="lineNum">    1522 </span>            :         u32 i, count;
<span class="lineNum">    1523 </span>            :         u32 res = 0;
<span class="lineNum">    1524 </span><span class="lineCov">          3 :         u32 alen = (u32) strlen(arg_name);</span>
<span class="lineNum">    1525 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_gen_args, NULL, search_type);</span>
<span class="lineNum">    1526 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_split_args, NULL, search_type);</span>
<span class="lineNum">    1527 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_dash_args, NULL, search_type);</span>
<span class="lineNum">    1528 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_imp_args, NULL, search_type);</span>
<span class="lineNum">    1529 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_imp_fileopt_args, NULL, search_type);</span>
<span class="lineNum">    1530 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_senc_args, NULL, search_type);</span>
<span class="lineNum">    1531 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_crypt_args, NULL, search_type);</span>
<span class="lineNum">    1532 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_hint_args, NULL, search_type);</span>
<span class="lineNum">    1533 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_extr_args, NULL, search_type);</span>
<span class="lineNum">    1534 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_dump_args, NULL, search_type);</span>
<span class="lineNum">    1535 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_meta_args, NULL, search_type);</span>
<span class="lineNum">    1536 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_swf_args, NULL, search_type);</span>
<span class="lineNum">    1537 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_liveenc_args, NULL, search_type);</span>
<span class="lineNum">    1538 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, m4b_usage_args, NULL, search_type);</span>
<span class="lineNum">    1539 </span><span class="lineCov">          3 :         res += PrintHelpForArgs(arg_name, NULL, (GF_GPACArg *) gf_sys_get_options(), search_type);</span>
<span class="lineNum">    1540 </span>            : 
<span class="lineNum">    1541 </span><span class="lineCov">          3 :         if (!fs) return res;</span>
<span class="lineNum">    1542 </span>            : 
<span class="lineNum">    1543 </span>            :         memset(&amp;an_arg, 0, sizeof(GF_GPACArg));
<span class="lineNum">    1544 </span><span class="lineCov">          3 :         count = gf_fs_filters_registers_count(fs);</span>
<span class="lineNum">    1545 </span><span class="lineCov">        315 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1546 </span>            :                 u32 j=0;
<span class="lineNum">    1547 </span><span class="lineCov">        312 :                 const GF_FilterRegister *reg = gf_fs_get_filter_register(fs, i);</span>
<span class="lineNum">    1548 </span>            : 
<span class="lineNum">    1549 </span><span class="lineCov">       3159 :                 while (reg-&gt;args) {</span>
<span class="lineNum">    1550 </span>            :                         u32 len;
<span class="lineNum">    1551 </span><span class="lineCov">       2808 :                         const GF_FilterArgs *arg = &amp;reg-&gt;args[j];</span>
<span class="lineNum">    1552 </span><span class="lineCov">       2808 :                         if (!arg || !arg-&gt;arg_name) break;</span>
<span class="lineNum">    1553 </span><span class="lineCov">       2535 :                         j++;</span>
<span class="lineNum">    1554 </span><span class="lineCov">       2535 :                         if ((search_type==SEARCH_ARG_EXACT) &amp;&amp; strcmp(arg-&gt;arg_name, arg_name)) continue;</span>
<span class="lineNum">    1555 </span>            : 
<span class="lineNum">    1556 </span><span class="lineCov">       2535 :                         if ((search_type==SEARCH_ARG_CLOSE) &amp;&amp; !gf_sys_word_match(arg-&gt;arg_name, arg_name)) continue;</span>
<span class="lineNum">    1557 </span>            : 
<span class="lineNum">    1558 </span><span class="lineCov">        867 :                         if (search_type==SEARCH_DESC) {</span>
<span class="lineNum">    1559 </span><span class="lineCov">        845 :                                 if (!strstr_nocase(arg-&gt;arg_desc, arg_name, alen)) continue;</span>
<span class="lineNum">    1560 </span>            :                         }
<span class="lineNum">    1561 </span>            : 
<span class="lineNum">    1562 </span><span class="lineCov">         26 :                         an_arg.name = arg-&gt;arg_name;</span>
<span class="lineNum">    1563 </span><span class="lineCov">         26 :                         if (search_type==SEARCH_ARG_EXACT) {</span>
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 :                                 an_arg.description = arg-&gt;arg_desc;</span>
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :                                 switch (arg-&gt;arg_type) {</span>
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :                                 case GF_PROP_BOOL:</span>
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :                                         an_arg.type = GF_ARG_BOOL;</span>
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :                                 case GF_PROP_UINT:</span>
<span class="lineNum">    1570 </span>            :                                 case GF_PROP_SINT:
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :                                         an_arg.type = GF_ARG_INT;</span>
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :                                 case GF_PROP_DOUBLE:</span>
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :                                         an_arg.type = GF_ARG_DOUBLE;</span>
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1576 </span><span class="lineNoCov">          0 :                                 case GF_PROP_STRING_LIST:</span>
<span class="lineNum">    1577 </span>            :                                 case GF_PROP_UINT_LIST:
<span class="lineNum">    1578 </span>            :                                 case GF_PROP_SINT_LIST:
<span class="lineNum">    1579 </span>            :                                 case GF_PROP_VEC2I_LIST:
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :                                         an_arg.type = GF_ARG_STRINGS;</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :                                 case GF_PROP_4CC:</span>
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :                                         an_arg.type = GF_ARG_4CC;</span>
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :                                 case GF_PROP_4CC_LIST:</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :                                         an_arg.type = GF_ARG_4CCS;</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :                                 default:</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :                                         an_arg.type = GF_ARG_STRING;</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1591 </span>            :                                 }
<span class="lineNum">    1592 </span><span class="lineNoCov">          0 :                                 if (first) {</span>
<span class="lineNum">    1593 </span>            :                                         first = GF_FALSE;
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :                                         gf_sys_format_help(helpout, 0, &quot;\nGlobal filter session arguments. Syntax is `--arg` or `--arg=VAL`. `[F]` indicates filter name. See `gpac -h` and `gpac -h F` for more info.\n&quot;);</span>
<span class="lineNum">    1595 </span>            :                                 }
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :                                 fprintf(helpout, &quot;[%s]&quot;, reg-&gt;name);</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :                                 len = (u32)strlen(reg-&gt;name);</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :                                 while (len&lt;10) {</span>
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :                                         len++;</span>
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :                                         fprintf(helpout, &quot; &quot;);</span>
<span class="lineNum">    1601 </span>            :                                 }
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :                                 fprintf(helpout, &quot; &quot;);</span>
<span class="lineNum">    1603 </span>            :                         }
<span class="lineNum">    1604 </span>            : 
<span class="lineNum">    1605 </span><span class="lineCov">         26 :                         gf_sys_print_arg(helpout, GF_PRINTARG_ADD_DASH, &amp;an_arg, &quot;TEST&quot;);</span>
<span class="lineNum">    1606 </span><span class="lineCov">         26 :                         res++;</span>
<span class="lineNum">    1607 </span>            :                 }
<span class="lineNum">    1608 </span>            :         }
<span class="lineNum">    1609 </span><span class="lineCov">          3 :         if (res) return GF_TRUE;</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :         return GF_FALSE;</span>
<a name="1611"><span class="lineNum">    1611 </span>            : }</a>
<span class="lineNum">    1612 </span>            : 
<span class="lineNum">    1613 </span><span class="lineCov">          3 : static void PrintHelp(char *arg_name, Bool search_desc, Bool no_match)</span>
<span class="lineNum">    1614 </span>            : {
<span class="lineNum">    1615 </span>            :         GF_FilterSession *fs;
<span class="lineNum">    1616 </span>            :         Bool res;
<span class="lineNum">    1617 </span>            : 
<span class="lineNum">    1618 </span><span class="lineCov">          3 :         fs = gf_fs_new_defaults(0);</span>
<span class="lineNum">    1619 </span>            : 
<span class="lineNum">    1620 </span><span class="lineCov">          3 :         if (arg_name[0]=='-')</span>
<span class="lineNum">    1621 </span><span class="lineCov">          2 :                 arg_name++;</span>
<span class="lineNum">    1622 </span>            : 
<span class="lineNum">    1623 </span><span class="lineCov">          3 :         if (search_desc) {</span>
<span class="lineNum">    1624 </span><span class="lineCov">          1 :                 char *_arg_name = gf_strdup(arg_name);</span>
<span class="lineNum">    1625 </span><span class="lineCov">          1 :                 strlwr(_arg_name);</span>
<span class="lineNum">    1626 </span><span class="lineCov">          1 :                 GF_LOG(GF_LOG_INFO, GF_LOG_APP, (&quot;Possible options mentionning `%s`:\n&quot;, arg_name));</span>
<span class="lineNum">    1627 </span><span class="lineCov">          1 :                 PrintHelpArg(_arg_name, SEARCH_DESC, fs);</span>
<span class="lineNum">    1628 </span><span class="lineCov">          1 :                 gf_free(_arg_name);</span>
<span class="lineNum">    1629 </span>            :         } else {
<span class="lineNum">    1630 </span><span class="lineCov">          2 :                 res = no_match ? GF_FALSE : PrintHelpArg(arg_name, SEARCH_ARG_EXACT, fs);</span>
<span class="lineNum">    1631 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">    1632 </span><span class="lineCov">          2 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_APP, (&quot;Option -%s unknown, please check usage.\n&quot;, arg_name));</span>
<span class="lineNum">    1633 </span><span class="lineCov">          2 :                         GF_LOG(GF_LOG_INFO, GF_LOG_APP, (&quot;Possible options are:\n&quot;));</span>
<span class="lineNum">    1634 </span>            : 
<span class="lineNum">    1635 </span><span class="lineCov">          2 :                         PrintHelpArg(arg_name, SEARCH_ARG_CLOSE, fs);</span>
<span class="lineNum">    1636 </span>            :                 }
<span class="lineNum">    1637 </span>            :         }
<span class="lineNum">    1638 </span><span class="lineCov">          3 :         if (fs)</span>
<span class="lineNum">    1639 </span><span class="lineCov">          3 :                 gf_fs_del(fs);</span>
<span class="lineNum">    1640 </span><span class="lineCov">          3 : }</span>
<a name="1641"><span class="lineNum">    1641 </span>            : </a>
<span class="lineNum">    1642 </span>            : 
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 : u32 parse_sdp_ext(char *arg_val, u32 param)</span>
<span class="lineNum">    1644 </span>            : {
<span class="lineNum">    1645 </span>            :         char *id;
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :         sdp_lines = gf_realloc(sdp_lines, sizeof(SDPLine) * (nb_sdp_ex + 1));</span>
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :         if (!sdp_lines) return 2;</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :         id = strchr(arg_val, ':');</span>
<span class="lineNum">    1649 </span><span class="lineNoCov">          0 :         if (id) {</span>
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :                 id[0] = 0;</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :                 if (sscanf(arg_val, &quot;%u&quot;, &amp;sdp_lines[0].trackID) == 1) {</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :                         id[0] = ':';</span>
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :                         sdp_lines[nb_sdp_ex].line = id + 1;</span>
<span class="lineNum">    1654 </span>            :                 }
<span class="lineNum">    1655 </span>            :                 else {
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :                         id[0] = ':';</span>
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :                         sdp_lines[nb_sdp_ex].line = arg_val;</span>
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 :                         sdp_lines[nb_sdp_ex].trackID = 0;</span>
<span class="lineNum">    1659 </span>            :                 }
<span class="lineNum">    1660 </span>            :         }
<span class="lineNum">    1661 </span>            :         else {
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :                 sdp_lines[nb_sdp_ex].line = arg_val;</span>
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :                 sdp_lines[nb_sdp_ex].trackID = 0;</span>
<span class="lineNum">    1664 </span>            :         }
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :         open_edit = GF_TRUE;</span>
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :         nb_sdp_ex++;</span>
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :         return GF_FALSE;</span>
<span class="lineNum">    1668 </span>            : }
<span class="lineNum">    1669 </span>            : 
<a name="1670"><span class="lineNum">    1670 </span>            : </a>
<span class="lineNum">    1671 </span>            : #ifndef GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    1672 </span><span class="lineCov">        122 : static u32 parse_meta_args(char *opts, MetaActionType act_type)</span>
<span class="lineNum">    1673 </span>            : {
<span class="lineNum">    1674 </span>            :         MetaAction *meta;
<span class="lineNum">    1675 </span>            : 
<span class="lineNum">    1676 </span><span class="lineCov">        122 :         metas = gf_realloc(metas, sizeof(MetaAction) * (nb_meta_act + 1));</span>
<span class="lineNum">    1677 </span><span class="lineCov">        122 :         if (!metas) return 2;</span>
<span class="lineNum">    1678 </span><span class="lineCov">        122 :         meta = &amp;metas[nb_meta_act];</span>
<span class="lineNum">    1679 </span><span class="lineCov">        122 :         nb_meta_act ++;</span>
<span class="lineNum">    1680 </span>            : 
<span class="lineNum">    1681 </span>            :         memset(meta, 0, sizeof(MetaAction));
<span class="lineNum">    1682 </span><span class="lineCov">        122 :         meta-&gt;act_type = act_type;</span>
<span class="lineNum">    1683 </span><span class="lineCov">        122 :         meta-&gt;trackID = 0;</span>
<span class="lineNum">    1684 </span><span class="lineCov">        122 :         meta-&gt;root_meta = 1;</span>
<span class="lineNum">    1685 </span><span class="lineCov">        122 :         open_edit = GF_TRUE;</span>
<span class="lineNum">    1686 </span>            : 
<span class="lineNum">    1687 </span><span class="lineCov">        122 :         if (!opts) return 2;</span>
<span class="lineNum">    1688 </span>            : 
<span class="lineNum">    1689 </span><span class="lineCov">        122 :         if (act_type == META_ACTION_ADD_IMAGE_ITEM)</span>
<span class="lineNum">    1690 </span><span class="lineCov">         94 :                 has_add_image = GF_TRUE;</span>
<span class="lineNum">    1691 </span>            : 
<span class="lineNum">    1692 </span><span class="lineCov">        218 :         while (1) {</span>
<span class="lineNum">    1693 </span>            :                 char *next;
<span class="lineNum">    1694 </span>            :                 char *szSlot;
<span class="lineNum">    1695 </span><span class="lineCov">        340 :                 if (!opts || !opts[0]) return 0;</span>
<span class="lineNum">    1696 </span><span class="lineCov">        340 :                 if (opts[0]==':') opts += 1;</span>
<span class="lineNum">    1697 </span>            : 
<span class="lineNum">    1698 </span>            :                 szSlot = opts;
<span class="lineNum">    1699 </span><span class="lineCov">        340 :                 next = gf_url_colon_suffix(opts);</span>
<span class="lineNum">    1700 </span><span class="lineCov">        340 :                 if (next) next[0] = 0;</span>
<span class="lineNum">    1701 </span>            : 
<span class="lineNum">    1702 </span><span class="lineCov">        340 :                 if (!strnicmp(szSlot, &quot;tk=&quot;, 3)) {</span>
<span class="lineNum">    1703 </span><span class="lineCov">          1 :                         sscanf(szSlot, &quot;tk=%u&quot;, &amp;meta-&gt;trackID);</span>
<span class="lineNum">    1704 </span><span class="lineCov">          1 :                         meta-&gt;root_meta = 0;</span>
<span class="lineNum">    1705 </span>            :                 }
<span class="lineNum">    1706 </span><span class="lineCov">        339 :                 else if (!strnicmp(szSlot, &quot;id=&quot;, 3)) {</span>
<span class="lineNum">    1707 </span><span class="lineCov">        114 :                         meta-&gt;item_id = atoi(szSlot+3);</span>
<span class="lineNum">    1708 </span>            :                 }
<span class="lineNum">    1709 </span><span class="lineCov">        282 :                 else if (!strnicmp(szSlot, &quot;type=&quot;, 5)) {</span>
<span class="lineNum">    1710 </span><span class="lineNoCov">          0 :                         meta-&gt;item_type = GF_4CC(szSlot[5], szSlot[6], szSlot[7], szSlot[8]);</span>
<span class="lineNum">    1711 </span>            :                 }
<span class="lineNum">    1712 </span>            :                 //&quot;ref&quot; (without '=') is for data reference, &quot;ref=&quot; is for item references
<span class="lineNum">    1713 </span><span class="lineCov">        282 :                 else if (!strnicmp(szSlot, &quot;ref=&quot;, 4)) {</span>
<span class="lineNum">    1714 </span>            :                         char type[5];
<span class="lineNum">    1715 </span>            :                         MetaRef *ref;
<span class="lineNum">    1716 </span><span class="lineCov">         37 :                         if (!meta-&gt;item_refs) {</span>
<span class="lineNum">    1717 </span><span class="lineCov">          8 :                                 meta-&gt;item_refs = gf_list_new();</span>
<span class="lineNum">    1718 </span><span class="lineCov">          8 :                                 if (!meta-&gt;item_refs) return 2;</span>
<span class="lineNum">    1719 </span>            :                         }
<span class="lineNum">    1720 </span><span class="lineCov">         37 :                         GF_SAFEALLOC(ref, MetaRef);</span>
<span class="lineNum">    1721 </span><span class="lineCov">         37 :                         if (!ref) return 2;</span>
<span class="lineNum">    1722 </span><span class="lineCov">         37 :                         sscanf(szSlot, &quot;ref=%4s,%u&quot;, type, &amp;(ref-&gt;ref_item_id));</span>
<span class="lineNum">    1723 </span><span class="lineCov">         37 :                         ref-&gt;ref_type = GF_4CC(type[0], type[1], type[2], type[3]);</span>
<span class="lineNum">    1724 </span><span class="lineCov">         37 :                         gf_list_add(meta-&gt;item_refs, ref);</span>
<span class="lineNum">    1725 </span>            :                 }
<span class="lineNum">    1726 </span><span class="lineCov">        245 :                 else if (!strnicmp(szSlot, &quot;name=&quot;, 5)) {</span>
<span class="lineNum">    1727 </span><span class="lineCov">          2 :                         meta-&gt;szName = gf_strdup(szSlot+5);</span>
<span class="lineNum">    1728 </span>            :                 }
<span class="lineNum">    1729 </span><span class="lineCov">        243 :                 else if (!strnicmp(szSlot, &quot;path=&quot;, 5)) {</span>
<span class="lineNum">    1730 </span><span class="lineCov">          5 :                         meta-&gt;szPath = gf_strdup(szSlot+5);</span>
<span class="lineNum">    1731 </span>            :                 }
<span class="lineNum">    1732 </span><span class="lineCov">        238 :                 else if (!strnicmp(szSlot, &quot;mime=&quot;, 5)) {</span>
<span class="lineNum">    1733 </span><span class="lineCov">          4 :                         meta-&gt;item_type = GF_META_ITEM_TYPE_MIME;</span>
<span class="lineNum">    1734 </span><span class="lineCov">          4 :                         meta-&gt;mime_type = gf_strdup(szSlot+5);</span>
<span class="lineNum">    1735 </span>            :                 }
<span class="lineNum">    1736 </span><span class="lineCov">        234 :                 else if (!strnicmp(szSlot, &quot;encoding=&quot;, 9)) {</span>
<span class="lineNum">    1737 </span><span class="lineNoCov">          0 :                         meta-&gt;enc_type = gf_strdup(szSlot+9);</span>
<span class="lineNum">    1738 </span>            :                 }
<span class="lineNum">    1739 </span><span class="lineCov">        234 :                 else if (!strnicmp(szSlot, &quot;image-size=&quot;, 11)) {</span>
<span class="lineNum">    1740 </span><span class="lineCov">          7 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1741 </span><span class="lineCov">          3 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1742 </span><span class="lineCov">          3 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1743 </span>            :                         }
<span class="lineNum">    1744 </span><span class="lineCov">          7 :                         sscanf(szSlot+11, &quot;%dx%d&quot;, &amp;meta-&gt;image_props-&gt;width, &amp;meta-&gt;image_props-&gt;height);</span>
<span class="lineNum">    1745 </span>            :                 }
<span class="lineNum">    1746 </span><span class="lineCov">        227 :                 else if (!strnicmp(szSlot, &quot;image-grid-size=&quot;, 16)) {</span>
<span class="lineNum">    1747 </span><span class="lineCov">          7 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1748 </span><span class="lineNoCov">          0 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1749 </span>            :                         }
<span class="lineNum">    1750 </span><span class="lineCov">          7 :                         sscanf(szSlot+16, &quot;%dx%d&quot;, &amp;meta-&gt;image_props-&gt;num_grid_rows, &amp;meta-&gt;image_props-&gt;num_grid_columns);</span>
<span class="lineNum">    1751 </span>            :                 }
<span class="lineNum">    1752 </span><span class="lineCov">        220 :                 else if (!strnicmp(szSlot, &quot;image-pasp=&quot;, 11)) {</span>
<span class="lineNum">    1753 </span><span class="lineNoCov">          0 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1754 </span><span class="lineNoCov">          0 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1755 </span><span class="lineNoCov">          0 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1756 </span>            :                         }
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 :                         sscanf(szSlot+11, &quot;%dx%d&quot;, &amp;meta-&gt;image_props-&gt;hSpacing, &amp;meta-&gt;image_props-&gt;vSpacing);</span>
<span class="lineNum">    1758 </span>            :                 }
<span class="lineNum">    1759 </span><span class="lineCov">        220 :                 else if (!strnicmp(szSlot, &quot;image-rloc=&quot;, 11)) {</span>
<span class="lineNum">    1760 </span><span class="lineNoCov">          0 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1761 </span><span class="lineNoCov">          0 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1763 </span>            :                         }
<span class="lineNum">    1764 </span><span class="lineNoCov">          0 :                         sscanf(szSlot+11, &quot;%dx%d&quot;, &amp;meta-&gt;image_props-&gt;hOffset, &amp;meta-&gt;image_props-&gt;vOffset);</span>
<span class="lineNum">    1765 </span>            :                 }
<span class="lineNum">    1766 </span><span class="lineCov">        220 :                 else if (!strnicmp(szSlot, &quot;rotation=&quot;, 9)) {</span>
<span class="lineNum">    1767 </span><span class="lineCov">         12 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1768 </span><span class="lineCov">          9 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1769 </span><span class="lineCov">          9 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1770 </span>            :                         }
<span class="lineNum">    1771 </span><span class="lineCov">         24 :                         meta-&gt;image_props-&gt;angle = atoi(szSlot+9);</span>
<span class="lineNum">    1772 </span>            :                 }
<span class="lineNum">    1773 </span><span class="lineCov">        208 :                 else if (!strnicmp(szSlot, &quot;mirror-axis=&quot;, 12)) {</span>
<span class="lineNum">    1774 </span><span class="lineCov">          9 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1775 </span><span class="lineCov">          5 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1776 </span><span class="lineCov">          5 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1777 </span>            :                         }
<span class="lineNum">    1778 </span><span class="lineCov">          9 :                         meta-&gt;image_props-&gt;mirror = (!strnicmp(szSlot+12, &quot;vertical&quot;, 8) ? 1 : 2);</span>
<span class="lineNum">    1779 </span>            :                 }
<span class="lineNum">    1780 </span><span class="lineCov">        199 :                 else if (!strnicmp(szSlot, &quot;clap=&quot;, 5)) {</span>
<span class="lineNum">    1781 </span><span class="lineCov">         10 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1782 </span><span class="lineCov">          6 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1783 </span><span class="lineCov">          6 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1784 </span>            :                         }
<span class="lineNum">    1785 </span><span class="lineCov">         10 :                         sscanf(szSlot + 5, &quot;%d,%d,%d,%d,%d,%d,%d,%d&quot;, &amp;meta-&gt;image_props-&gt;clap_wnum, &amp;meta-&gt;image_props-&gt;clap_wden,</span>
<span class="lineNum">    1786 </span>            :                                            &amp;meta-&gt;image_props-&gt;clap_hnum, &amp;meta-&gt;image_props-&gt;clap_hden,
<span class="lineNum">    1787 </span>            :                                            &amp;meta-&gt;image_props-&gt;clap_honum, &amp;meta-&gt;image_props-&gt;clap_hoden,
<span class="lineNum">    1788 </span><span class="lineCov">         10 :                                            &amp;meta-&gt;image_props-&gt;clap_vonum, &amp;meta-&gt;image_props-&gt;clap_voden);</span>
<span class="lineNum">    1789 </span>            :                 }
<span class="lineNum">    1790 </span><span class="lineCov">        189 :                 else if (!stricmp(szSlot, &quot;hidden&quot;)) {</span>
<span class="lineNum">    1791 </span><span class="lineCov">          2 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1792 </span><span class="lineCov">          1 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1793 </span><span class="lineCov">          1 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1794 </span>            :                         }
<span class="lineNum">    1795 </span><span class="lineCov">          2 :                         meta-&gt;image_props-&gt;hidden = GF_TRUE;</span>
<span class="lineNum">    1796 </span>            :                 }
<span class="lineNum">    1797 </span><span class="lineCov">        187 :                 else if (!stricmp(szSlot, &quot;alpha&quot;)) {</span>
<span class="lineNum">    1798 </span><span class="lineCov">          1 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1799 </span><span class="lineCov">          1 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1800 </span><span class="lineCov">          1 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1801 </span>            :                         }
<span class="lineNum">    1802 </span><span class="lineCov">          1 :                         meta-&gt;image_props-&gt;alpha = GF_TRUE;</span>
<span class="lineNum">    1803 </span>            :                 }
<span class="lineNum">    1804 </span>            :                 //&quot;ref&quot; (without '=') is for data reference, &quot;ref=&quot; is for item references
<span class="lineNum">    1805 </span><span class="lineCov">        186 :                 else if (!stricmp(szSlot, &quot;ref&quot;)) {</span>
<span class="lineNum">    1806 </span><span class="lineCov">          1 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1807 </span><span class="lineCov">          1 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1808 </span><span class="lineCov">          1 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1809 </span>            :                         }
<span class="lineNum">    1810 </span><span class="lineCov">          1 :                         meta-&gt;image_props-&gt;use_reference = GF_TRUE;</span>
<span class="lineNum">    1811 </span>            :                 }
<span class="lineNum">    1812 </span><span class="lineCov">        185 :                 else if (!strnicmp(szSlot, &quot;time=&quot;, 5)) {</span>
<span class="lineNum">    1813 </span><span class="lineCov">         27 :                         Float s=0, e=0, step=0;</span>
<span class="lineNum">    1814 </span><span class="lineCov">         27 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1815 </span><span class="lineCov">         27 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1816 </span><span class="lineCov">         27 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1817 </span>            :                         }
<span class="lineNum">    1818 </span><span class="lineCov">         27 :                         if (sscanf(szSlot+5, &quot;%f-%f/%f&quot;, &amp;s, &amp;e, &amp;step)==3) {</span>
<span class="lineNum">    1819 </span><span class="lineCov">          1 :                                 meta-&gt;image_props-&gt;time = s;</span>
<span class="lineNum">    1820 </span><span class="lineCov">          1 :                                 meta-&gt;image_props-&gt;end_time = e;</span>
<span class="lineNum">    1821 </span><span class="lineCov">          1 :                                 meta-&gt;image_props-&gt;step_time = step;</span>
<span class="lineNum">    1822 </span><span class="lineCov">         26 :                         } else if (sscanf(szSlot+5, &quot;%f-%f&quot;, &amp;s, &amp;e)==2) {</span>
<span class="lineNum">    1823 </span><span class="lineCov">          3 :                                 meta-&gt;image_props-&gt;time = s;</span>
<span class="lineNum">    1824 </span><span class="lineCov">          3 :                                 meta-&gt;image_props-&gt;end_time = e;</span>
<span class="lineNum">    1825 </span><span class="lineCov">         23 :                         } else if (sscanf(szSlot+5, &quot;%f/%f&quot;, &amp;s, &amp;step)==2) {</span>
<span class="lineNum">    1826 </span><span class="lineCov">          1 :                                 meta-&gt;image_props-&gt;time = s;</span>
<span class="lineNum">    1827 </span><span class="lineCov">          1 :                                 meta-&gt;image_props-&gt;step_time = step;</span>
<span class="lineNum">    1828 </span><span class="lineCov">         22 :                         } else if (sscanf(szSlot+5, &quot;%f&quot;, &amp;s)==1) {</span>
<span class="lineNum">    1829 </span><span class="lineCov">         22 :                                 meta-&gt;image_props-&gt;time = s;</span>
<span class="lineNum">    1830 </span>            :                         }
<span class="lineNum">    1831 </span>            :                 }
<span class="lineNum">    1832 </span><span class="lineCov">        158 :                 else if (!strnicmp(szSlot, &quot;samp=&quot;, 5)) {</span>
<span class="lineNum">    1833 </span><span class="lineCov">          5 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1834 </span><span class="lineCov">          4 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1835 </span><span class="lineCov">          4 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1836 </span>            :                         }
<span class="lineNum">    1837 </span><span class="lineCov">         10 :                         meta-&gt;image_props-&gt;sample_num = atoi(szSlot+5);</span>
<span class="lineNum">    1838 </span><span class="lineCov">          5 :                         meta-&gt;root_meta = 1;</span>
<span class="lineNum">    1839 </span>            :                 }
<span class="lineNum">    1840 </span><span class="lineCov">        153 :                 else if (!strnicmp(szSlot, &quot;group=&quot;, 6)) {</span>
<span class="lineNum">    1841 </span>            :                         char type[5];
<span class="lineNum">    1842 </span><span class="lineNoCov">          0 :                         sscanf(szSlot, &quot;group=%4s,%u&quot;, type, &amp;meta-&gt;group_id);</span>
<span class="lineNum">    1843 </span><span class="lineNoCov">          0 :                         meta-&gt;group_type = GF_4CC(type[0], type[1], type[2], type[3]);</span>
<span class="lineNum">    1844 </span>            :                 }
<span class="lineNum">    1845 </span><span class="lineCov">        153 :                 else if (!stricmp(szSlot, &quot;split_tiles&quot;)) {</span>
<span class="lineNum">    1846 </span><span class="lineCov">          1 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1847 </span><span class="lineCov">          1 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1848 </span><span class="lineCov">          1 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1849 </span>            :                         }
<span class="lineNum">    1850 </span><span class="lineCov">          1 :                         meta-&gt;image_props-&gt;tile_mode = TILE_ITEM_ALL_BASE;</span>
<span class="lineNum">    1851 </span>            :                 }
<span class="lineNum">    1852 </span><span class="lineCov">        152 :                 else if (!stricmp(szSlot, &quot;dref&quot;)) {</span>
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :                         meta-&gt;use_dref = 1;</span>
<span class="lineNum">    1854 </span>            :                 }
<span class="lineNum">    1855 </span><span class="lineCov">        152 :                 else if (!stricmp(szSlot, &quot;primary&quot;)) {</span>
<span class="lineNum">    1856 </span><span class="lineCov">         28 :                         meta-&gt;primary = 1;</span>
<span class="lineNum">    1857 </span>            :                 }
<span class="lineNum">    1858 </span><span class="lineCov">        124 :                 else if (!stricmp(szSlot, &quot;binary&quot;)) {</span>
<span class="lineNum">    1859 </span><span class="lineNoCov">          0 :                         if (meta-&gt;act_type==META_ACTION_SET_XML) meta-&gt;act_type=META_ACTION_SET_BINARY_XML;</span>
<span class="lineNum">    1860 </span>            :                 }
<span class="lineNum">    1861 </span><span class="lineCov">        124 :                 else if (!strnicmp(szSlot, &quot;icc_path=&quot;, 9)) {</span>
<span class="lineNum">    1862 </span><span class="lineNoCov">          0 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1864 </span><span class="lineNoCov">          0 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1865 </span>            :                         }
<span class="lineNum">    1866 </span><span class="lineNoCov">          0 :                         strcpy(meta-&gt;image_props-&gt;iccPath, szSlot+9);</span>
<span class="lineNum">    1867 </span>            :                 }
<span class="lineNum">    1868 </span><span class="lineCov">        124 :                 else if (!stricmp(szSlot, &quot;agrid&quot;) || !strnicmp(szSlot, &quot;agrid=&quot;, 6)) {</span>
<span class="lineNum">    1869 </span><span class="lineCov">          2 :                         if (!meta-&gt;image_props) {</span>
<span class="lineNum">    1870 </span><span class="lineCov">          2 :                                 GF_SAFEALLOC(meta-&gt;image_props, GF_ImageItemProperties);</span>
<span class="lineNum">    1871 </span><span class="lineCov">          2 :                                 if (!meta-&gt;image_props) return 2;</span>
<span class="lineNum">    1872 </span>            :                         }
<span class="lineNum">    1873 </span><span class="lineCov">          2 :                         meta-&gt;image_props-&gt;auto_grid = GF_TRUE;</span>
<span class="lineNum">    1874 </span><span class="lineCov">          2 :                         if (!strnicmp(szSlot, &quot;agrid=&quot;, 6))</span>
<span class="lineNum">    1875 </span><span class="lineCov">          2 :                                 meta-&gt;image_props-&gt;auto_grid_ratio = atof(szSlot+6);</span>
<span class="lineNum">    1876 </span>            :                 }
<span class="lineNum">    1877 </span><span class="lineCov">        122 :                 else if (!strchr(szSlot, '=')) {</span>
<span class="lineNum">    1878 </span><span class="lineCov">        117 :                         switch (meta-&gt;act_type) {</span>
<span class="lineNum">    1879 </span><span class="lineCov">          4 :                         case META_ACTION_SET_TYPE:</span>
<span class="lineNum">    1880 </span><span class="lineCov">          4 :                                 if (!stricmp(szSlot, &quot;null&quot;) || !stricmp(szSlot, &quot;0&quot;)) meta-&gt;meta_4cc = 0;</span>
<span class="lineNum">    1881 </span><span class="lineCov">          4 :                                 else meta-&gt;meta_4cc = GF_4CC(szSlot[0], szSlot[1], szSlot[2], szSlot[3]);</span>
<span class="lineNum">    1882 </span>            :                                 break;
<span class="lineNum">    1883 </span><span class="lineCov">         97 :                         case META_ACTION_ADD_ITEM:</span>
<span class="lineNum">    1884 </span>            :                         case META_ACTION_ADD_IMAGE_ITEM:
<span class="lineNum">    1885 </span>            :                         case META_ACTION_SET_XML:
<span class="lineNum">    1886 </span>            :                         case META_ACTION_DUMP_XML:
<span class="lineNum">    1887 </span><span class="lineCov">         97 :                                 if (!strncmp(szSlot, &quot;dopt&quot;, 4) || !strncmp(szSlot, &quot;sopt&quot;, 4) || !strncmp(szSlot, &quot;@&quot;, 1)) {</span>
<span class="lineNum">    1888 </span><span class="lineCov">          1 :                                         if (next) next[0]=':';</span>
<span class="lineNum">    1889 </span>            :                                         next=NULL;
<span class="lineNum">    1890 </span>            :                                 }
<span class="lineNum">    1891 </span>            :                                 //cat as -add arg
<span class="lineNum">    1892 </span><span class="lineCov">         97 :                                 gf_dynstrcat(&amp;meta-&gt;szPath, szSlot, &quot;:&quot;);</span>
<span class="lineNum">    1893 </span><span class="lineCov">         97 :                                 if (!meta-&gt;szPath) return 2;</span>
<span class="lineNum">    1894 </span>            :                                 break;
<span class="lineNum">    1895 </span>            :                         case META_ACTION_REM_ITEM:
<span class="lineNum">    1896 </span>            :                         case META_ACTION_SET_PRIMARY_ITEM:
<span class="lineNum">    1897 </span>            :                         case META_ACTION_DUMP_ITEM:
<span class="lineNum">    1898 </span><span class="lineCov">          9 :                                 meta-&gt;item_id = atoi(szSlot);</span>
<span class="lineNum">    1899 </span><span class="lineCov">          9 :                                 break;</span>
<span class="lineNum">    1900 </span>            :                         default:
<span class="lineNum">    1901 </span>            :                                 break;
<span class="lineNum">    1902 </span>            :                         }
<span class="lineNum">    1903 </span><span class="lineCov">          5 :                 }</span>
<span class="lineNum">    1904 </span><span class="lineCov">        340 :                 if (!next) break;</span>
<span class="lineNum">    1905 </span><span class="lineCov">        218 :                 opts += strlen(szSlot);</span>
<span class="lineNum">    1906 </span><span class="lineCov">        218 :                 next[0] = ':';</span>
<span class="lineNum">    1907 </span>            :         }
<span class="lineNum">    1908 </span>            :         return 0;
<span class="lineNum">    1909 </span>            : }
<span class="lineNum">    1910 </span>            : #endif //GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    1911 </span>            : 
<a name="1912"><span class="lineNum">    1912 </span>            : </a>
<span class="lineNum">    1913 </span>            : #ifndef GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    1914 </span><span class="lineCov">          4 : static Bool parse_tsel_args(char *opts, TSELActionType act)</span>
<span class="lineNum">    1915 </span>            : {
<span class="lineNum">    1916 </span>            :         GF_ISOTrackID refTrackID = 0;
<span class="lineNum">    1917 </span>            :         Bool has_switch_id;
<span class="lineNum">    1918 </span>            :         u32 switch_id = 0;
<span class="lineNum">    1919 </span>            :         u32 criteria[30];
<span class="lineNum">    1920 </span>            :         u32 nb_criteria = 0;
<span class="lineNum">    1921 </span>            :         TSELAction *tsel_act;
<span class="lineNum">    1922 </span>            :         char szSlot[1024];
<span class="lineNum">    1923 </span>            : 
<span class="lineNum">    1924 </span>            :         has_switch_id = 0;
<span class="lineNum">    1925 </span>            : 
<span class="lineNum">    1926 </span><span class="lineCov">          4 :         if (!opts) return 0;</span>
<span class="lineNum">    1927 </span><span class="lineCov">         10 :         while (1) {</span>
<span class="lineNum">    1928 </span>            :                 char *next;
<span class="lineNum">    1929 </span><span class="lineCov">         14 :                 if (!opts || !opts[0]) return 0;</span>
<span class="lineNum">    1930 </span><span class="lineCov">         10 :                 if (opts[0]==':') opts += 1;</span>
<span class="lineNum">    1931 </span>            :                 strcpy(szSlot, opts);
<span class="lineNum">    1932 </span><span class="lineCov">         10 :                 next = gf_url_colon_suffix(szSlot);</span>
<span class="lineNum">    1933 </span><span class="lineCov">         10 :                 if (next) next[0] = 0;</span>
<span class="lineNum">    1934 </span>            : 
<span class="lineNum">    1935 </span>            : 
<span class="lineNum">    1936 </span><span class="lineCov">         10 :                 if (!strnicmp(szSlot, &quot;refTrack=&quot;, 9)) refTrackID = atoi(szSlot+9);</span>
<span class="lineNum">    1937 </span><span class="lineCov">         10 :                 else if (!strnicmp(szSlot, &quot;switchID=&quot;, 9)) {</span>
<span class="lineNum">    1938 </span><span class="lineCov">          2 :                         if (atoi(szSlot+9)&lt;0) {</span>
<span class="lineNum">    1939 </span>            :                                 switch_id = 0;
<span class="lineNum">    1940 </span>            :                                 has_switch_id = 0;
<span class="lineNum">    1941 </span>            :                         } else {
<span class="lineNum">    1942 </span><span class="lineCov">          2 :                                 switch_id = atoi(szSlot+9);</span>
<span class="lineNum">    1943 </span>            :                                 has_switch_id = 1;
<span class="lineNum">    1944 </span>            :                         }
<span class="lineNum">    1945 </span>            :                 }
<span class="lineNum">    1946 </span><span class="lineCov">          8 :                 else if (!strnicmp(szSlot, &quot;switchID&quot;, 8)) {</span>
<span class="lineNum">    1947 </span>            :                         switch_id = 0;
<span class="lineNum">    1948 </span>            :                         has_switch_id = 1;
<span class="lineNum">    1949 </span>            :                 }
<span class="lineNum">    1950 </span><span class="lineCov">          8 :                 else if (!strnicmp(szSlot, &quot;criteria=&quot;, 9)) {</span>
<span class="lineNum">    1951 </span>            :                         u32 j=9;
<span class="lineNum">    1952 </span>            :                         nb_criteria = 0;
<span class="lineNum">    1953 </span><span class="lineCov">          4 :                         while (j+3&lt;strlen(szSlot)) {</span>
<span class="lineNum">    1954 </span><span class="lineCov">          2 :                                 criteria[nb_criteria] = GF_4CC(szSlot[j], szSlot[j+1], szSlot[j+2], szSlot[j+3]);</span>
<span class="lineNum">    1955 </span><span class="lineCov">          2 :                                 j+=5;</span>
<span class="lineNum">    1956 </span><span class="lineCov">          2 :                                 nb_criteria++;</span>
<span class="lineNum">    1957 </span>            :                         }
<span class="lineNum">    1958 </span>            :                 }
<span class="lineNum">    1959 </span><span class="lineCov">          6 :                 else if (!strnicmp(szSlot, &quot;trackID=&quot;, 8) || !strchr(szSlot, '=') ) {</span>
<span class="lineNum">    1960 </span><span class="lineCov">          6 :                         tsel_acts = gf_realloc(tsel_acts, sizeof(TSELAction) * (nb_tsel_acts + 1));</span>
<span class="lineNum">    1961 </span><span class="lineCov">          6 :                         if (!tsel_acts) return 2;</span>
<span class="lineNum">    1962 </span>            : 
<span class="lineNum">    1963 </span><span class="lineCov">          6 :                         tsel_act = &amp;tsel_acts[nb_tsel_acts];</span>
<span class="lineNum">    1964 </span><span class="lineCov">          6 :                         nb_tsel_acts++;</span>
<span class="lineNum">    1965 </span>            : 
<span class="lineNum">    1966 </span>            :                         memset(tsel_act, 0, sizeof(TSELAction));
<span class="lineNum">    1967 </span><span class="lineCov">          6 :                         tsel_act-&gt;act_type = act;</span>
<span class="lineNum">    1968 </span><span class="lineCov">         12 :                         tsel_act-&gt;trackID = strchr(szSlot, '=') ? atoi(szSlot+8) : atoi(szSlot);</span>
<span class="lineNum">    1969 </span><span class="lineCov">          6 :                         tsel_act-&gt;refTrackID = refTrackID;</span>
<span class="lineNum">    1970 </span><span class="lineCov">          6 :                         tsel_act-&gt;switchGroupID = switch_id;</span>
<span class="lineNum">    1971 </span><span class="lineCov">          6 :                         tsel_act-&gt;is_switchGroup = has_switch_id;</span>
<span class="lineNum">    1972 </span><span class="lineCov">          6 :                         tsel_act-&gt;nb_criteria = nb_criteria;</span>
<span class="lineNum">    1973 </span><span class="lineCov">          6 :                         memcpy(tsel_act-&gt;criteria, criteria, sizeof(u32)*nb_criteria);</span>
<span class="lineNum">    1974 </span>            : 
<span class="lineNum">    1975 </span><span class="lineCov">          6 :                         if (!refTrackID)</span>
<span class="lineNum">    1976 </span>            :                                 refTrackID = tsel_act-&gt;trackID;
<span class="lineNum">    1977 </span>            : 
<span class="lineNum">    1978 </span><span class="lineCov">          6 :                         open_edit = GF_TRUE;</span>
<span class="lineNum">    1979 </span>            :                 }
<span class="lineNum">    1980 </span><span class="lineCov">         10 :                 opts += strlen(szSlot);</span>
<span class="lineNum">    1981 </span>            :         }
<span class="lineNum">    1982 </span>            :         return 0;
<span class="lineNum">    1983 </span>            : }
<span class="lineNum">    1984 </span>            : #endif // GPAC_DISABLE_ISOM_WRITE
<a name="1985"><span class="lineNum">    1985 </span>            : </a>
<span class="lineNum">    1986 </span>            : 
<span class="lineNum">    1987 </span><span class="lineCov">        209 : GF_DashSegmenterInput *set_dash_input(GF_DashSegmenterInput *dash_inputs, char *name, u32 *nb_dash_inputs)</span>
<span class="lineNum">    1988 </span>            : {
<span class="lineNum">    1989 </span>            :         GF_DashSegmenterInput *di;
<span class="lineNum">    1990 </span>            :         Bool skip_rep_id = GF_FALSE;
<span class="lineNum">    1991 </span><span class="lineCov">        209 :         char *other_opts = NULL;</span>
<span class="lineNum">    1992 </span><span class="lineCov">        209 :         char *sep = gf_url_colon_suffix(name);</span>
<span class="lineNum">    1993 </span>            : 
<span class="lineNum">    1994 </span><span class="lineCov">        209 :         dash_inputs = gf_realloc(dash_inputs, sizeof(GF_DashSegmenterInput) * (*nb_dash_inputs + 1) );</span>
<span class="lineNum">    1995 </span><span class="lineCov">        209 :         memset(&amp;dash_inputs[*nb_dash_inputs], 0, sizeof(GF_DashSegmenterInput) );</span>
<span class="lineNum">    1996 </span><span class="lineCov">        209 :         di = &amp;dash_inputs[*nb_dash_inputs];</span>
<span class="lineNum">    1997 </span><span class="lineCov">        209 :         (*nb_dash_inputs)++;</span>
<span class="lineNum">    1998 </span>            : 
<span class="lineNum">    1999 </span><span class="lineCov">        209 :         if (sep) {</span>
<span class="lineNum">    2000 </span>            :                 char *opts, *first_opt;
<span class="lineNum">    2001 </span>            :                 first_opt = sep;
<span class="lineNum">    2002 </span><span class="lineCov">         48 :                 opts = sep+1;</span>
<span class="lineNum">    2003 </span><span class="lineCov">        114 :                 while (opts) {</span>
<span class="lineNum">    2004 </span><span class="lineCov">         66 :                         sep = gf_url_colon_suffix(opts);</span>
<span class="lineNum">    2005 </span><span class="lineCov">         66 :                         if (sep &amp;&amp; !strncmp(sep, &quot;://&quot;, 3) &amp;&amp; strncmp(sep, &quot;:@&quot;, 2)) sep = gf_url_colon_suffix(sep+3);</span>
<span class="lineNum">    2006 </span><span class="lineCov">         66 :                         if (sep) sep[0] = 0;</span>
<span class="lineNum">    2007 </span>            : 
<span class="lineNum">    2008 </span><span class="lineCov">         66 :                         if (!strnicmp(opts, &quot;id=&quot;, 3)) {</span>
<span class="lineNum">    2009 </span><span class="lineCov">         11 :                                 if (!stricmp(opts+3, &quot;NULL&quot;))</span>
<span class="lineNum">    2010 </span>            :                                         skip_rep_id = GF_TRUE;
<span class="lineNum">    2011 </span>            :                                 else
<span class="lineNum">    2012 </span><span class="lineCov">         11 :                                         di-&gt;representationID = gf_strdup(opts+3);</span>
<span class="lineNum">    2013 </span>            :                                 /*we allow the same repID to be set to force muxed representations*/
<span class="lineNum">    2014 </span>            :                         }
<span class="lineNum">    2015 </span><span class="lineCov">         55 :                         else if (!strnicmp(opts, &quot;dur=&quot;, 4)) gf_parse_lfrac(opts+4, &amp;di-&gt;media_duration);</span>
<span class="lineNum">    2016 </span><span class="lineCov">         36 :                         else if (!strnicmp(opts, &quot;period=&quot;, 7)) di-&gt;periodID = gf_strdup(opts+7);</span>
<span class="lineNum">    2017 </span><span class="lineCov">         29 :                         else if (!strnicmp(opts, &quot;BaseURL=&quot;, 8)) {</span>
<span class="lineNum">    2018 </span><span class="lineCov">          1 :                                 di-&gt;baseURL = (char **)gf_realloc(di-&gt;baseURL, (di-&gt;nb_baseURL+1)*sizeof(char *));</span>
<span class="lineNum">    2019 </span><span class="lineCov">          1 :                                 di-&gt;baseURL[di-&gt;nb_baseURL] = gf_strdup(opts+8);</span>
<span class="lineNum">    2020 </span><span class="lineCov">          1 :                                 di-&gt;nb_baseURL++;</span>
<span class="lineNum">    2021 </span><span class="lineCov">         40 :                         } else if (!strnicmp(opts, &quot;bandwidth=&quot;, 10)) di-&gt;bandwidth = atoi(opts+10);</span>
<span class="lineNum">    2022 </span><span class="lineCov">         16 :                         else if (!strnicmp(opts, &quot;role=&quot;, 5)) {</span>
<span class="lineNum">    2023 </span><span class="lineNoCov">          0 :                                 di-&gt;roles = gf_realloc(di-&gt;roles, sizeof (char *) * (di-&gt;nb_roles+1));</span>
<span class="lineNum">    2024 </span><span class="lineNoCov">          0 :                                 di-&gt;roles[di-&gt;nb_roles] = gf_strdup(opts+5);</span>
<span class="lineNum">    2025 </span><span class="lineNoCov">          0 :                                 di-&gt;nb_roles++;</span>
<span class="lineNum">    2026 </span><span class="lineCov">         16 :                         } else if (!strnicmp(opts, &quot;desc&quot;, 4)) {</span>
<span class="lineNum">    2027 </span>            :                                 u32 *nb_descs=NULL;
<span class="lineNum">    2028 </span>            :                                 char ***descs=NULL;
<span class="lineNum">    2029 </span>            :                                 u32 opt_offset=0;
<span class="lineNum">    2030 </span>            :                                 u32 len;
<span class="lineNum">    2031 </span><span class="lineCov">         10 :                                 if (!strnicmp(opts, &quot;desc_p=&quot;, 7)) {</span>
<span class="lineNum">    2032 </span><span class="lineCov">          3 :                                         nb_descs = &amp;di-&gt;nb_p_descs;</span>
<span class="lineNum">    2033 </span><span class="lineCov">          3 :                                         descs = &amp;di-&gt;p_descs;</span>
<span class="lineNum">    2034 </span>            :                                         opt_offset = 7;
<span class="lineNum">    2035 </span><span class="lineCov">          7 :                                 } else if (!strnicmp(opts, &quot;desc_as=&quot;, 8)) {</span>
<span class="lineNum">    2036 </span><span class="lineCov">          6 :                                         nb_descs = &amp;di-&gt;nb_as_descs;</span>
<span class="lineNum">    2037 </span><span class="lineCov">          6 :                                         descs = &amp;di-&gt;as_descs;</span>
<span class="lineNum">    2038 </span>            :                                         opt_offset = 8;
<span class="lineNum">    2039 </span><span class="lineCov">          1 :                                 } else if (!strnicmp(opts, &quot;desc_as_c=&quot;, 8)) {</span>
<span class="lineNum">    2040 </span><span class="lineNoCov">          0 :                                         nb_descs = &amp;di-&gt;nb_as_c_descs;</span>
<span class="lineNum">    2041 </span><span class="lineNoCov">          0 :                                         descs = &amp;di-&gt;as_c_descs;</span>
<span class="lineNum">    2042 </span>            :                                         opt_offset = 10;
<span class="lineNum">    2043 </span><span class="lineCov">          1 :                                 } else if (!strnicmp(opts, &quot;desc_rep=&quot;, 8)) {</span>
<span class="lineNum">    2044 </span><span class="lineCov">          1 :                                         nb_descs = &amp;di-&gt;nb_rep_descs;</span>
<span class="lineNum">    2045 </span><span class="lineCov">          1 :                                         descs = &amp;di-&gt;rep_descs;</span>
<span class="lineNum">    2046 </span>            :                                         opt_offset = 9;
<span class="lineNum">    2047 </span>            :                                 }
<span class="lineNum">    2048 </span><span class="lineCov">         10 :                                 if (opt_offset) {</span>
<span class="lineNum">    2049 </span><span class="lineCov">         10 :                                         (*nb_descs)++;</span>
<span class="lineNum">    2050 </span><span class="lineCov">         10 :                                         opts += opt_offset;</span>
<span class="lineNum">    2051 </span><span class="lineCov">         10 :                                         len = (u32) strlen(opts);</span>
<span class="lineNum">    2052 </span><span class="lineCov">         10 :                                         (*descs) = (char **)gf_realloc((*descs), (*nb_descs)*sizeof(char *));</span>
<span class="lineNum">    2053 </span><span class="lineCov">         10 :                                         (*descs)[(*nb_descs)-1] = (char *)gf_malloc((len+1)*sizeof(char));</span>
<span class="lineNum">    2054 </span><span class="lineCov">         10 :                                         memcpy((*descs)[(*nb_descs)-1], opts, len);</span>
<span class="lineNum">    2055 </span><span class="lineCov">         10 :                                         (*descs)[(*nb_descs)-1][len] = 0;</span>
<span class="lineNum">    2056 </span>            :                                 }
<span class="lineNum">    2057 </span>            : 
<span class="lineNum">    2058 </span>            :                         }
<span class="lineNum">    2059 </span><span class="lineCov">          6 :                         else if (!strnicmp(opts, &quot;xlink=&quot;, 6)) di-&gt;xlink = gf_strdup(opts+6);</span>
<span class="lineNum">    2060 </span><span class="lineCov">          5 :                         else if (!strnicmp(opts, &quot;sscale&quot;, 6)) di-&gt;sscale = GF_TRUE;</span>
<span class="lineNum">    2061 </span><span class="lineCov">          3 :                         else if (!strnicmp(opts, &quot;pdur=&quot;, 5)) gf_parse_frac(opts+5, &amp;di-&gt;period_duration);</span>
<span class="lineNum">    2062 </span><span class="lineCov">          2 :                         else if (!strnicmp(opts, &quot;period_duration=&quot;, 16)) gf_parse_frac(opts+16, &amp;di-&gt;period_duration);</span>
<span class="lineNum">    2063 </span><span class="lineCov">          2 :                         else if (!strnicmp(opts, &quot;ddur=&quot;, 5)) gf_parse_frac(opts+5, &amp;di-&gt;dash_duration);</span>
<span class="lineNum">    2064 </span><span class="lineCov">          2 :                         else if (!strnicmp(opts, &quot;duration=&quot;, 9)) gf_parse_frac(opts+9, &amp;di-&gt;dash_duration);</span>
<span class="lineNum">    2065 </span><span class="lineCov">          2 :                         else if (!strnicmp(opts, &quot;asID=&quot;, 5)) di-&gt;asID = atoi(opts+5);</span>
<span class="lineNum">    2066 </span><span class="lineCov">          2 :                         else if (!strnicmp(opts, &quot;sn=&quot;, 3)) di-&gt;startNumber = atoi(opts+3);</span>
<span class="lineNum">    2067 </span><span class="lineCov">          2 :                         else if (!strnicmp(opts, &quot;tpl=&quot;, 4)) di-&gt;seg_template = gf_strdup(opts+4);</span>
<span class="lineNum">    2068 </span><span class="lineCov">          2 :                         else if (!strnicmp(opts, &quot;hls=&quot;, 4)) di-&gt;hls_pl = gf_strdup(opts+4);</span>
<span class="lineNum">    2069 </span><span class="lineCov">          2 :                         else if (!strnicmp(opts, &quot;trackID=&quot;, 8)) di-&gt;track_id = atoi(opts+8);</span>
<span class="lineNum">    2070 </span><span class="lineCov">          2 :                         else if (!strnicmp(opts, &quot;@&quot;, 1)) {</span>
<span class="lineNum">    2071 </span><span class="lineCov">          2 :                                 Bool old_syntax = (opts[1]=='@') ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2072 </span><span class="lineCov">          2 :                                 if (sep) sep[0] = ':';</span>
<span class="lineNum">    2073 </span><span class="lineCov">          2 :                                 di-&gt;filter_chain = gf_strdup(opts + (old_syntax ? 2 : 1) );</span>
<span class="lineNum">    2074 </span>            :                                 sep = NULL;
<span class="lineNum">    2075 </span><span class="lineCov">          2 :                                 if (!old_syntax &amp;&amp; (strstr(di-&gt;filter_chain, &quot;@@&quot;)!=NULL)) {</span>
<span class="lineNum">    2076 </span>            :                                         skip_rep_id = GF_TRUE;
<span class="lineNum">    2077 </span>            :                                 }
<span class="lineNum">    2078 </span>            :                         } else {
<span class="lineNum">    2079 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;other_opts, opts, &quot;:&quot;);</span>
<span class="lineNum">    2080 </span>            :                         }
<span class="lineNum">    2081 </span>            : 
<span class="lineNum">    2082 </span><span class="lineCov">         64 :                         if (!sep) break;</span>
<span class="lineNum">    2083 </span><span class="lineCov">         18 :                         sep[0] = ':';</span>
<span class="lineNum">    2084 </span><span class="lineCov">         18 :                         opts = sep+1;</span>
<span class="lineNum">    2085 </span>            :                 }
<span class="lineNum">    2086 </span><span class="lineCov">         48 :                 first_opt[0] = '\0';</span>
<span class="lineNum">    2087 </span>            :         }
<span class="lineNum">    2088 </span><span class="lineCov">        209 :         di-&gt;file_name = name;</span>
<span class="lineNum">    2089 </span><span class="lineCov">        209 :         di-&gt;source_opts = other_opts;</span>
<span class="lineNum">    2090 </span>            : 
<span class="lineNum">    2091 </span><span class="lineCov">        209 :         if (!skip_rep_id &amp;&amp; !di-&gt;representationID) {</span>
<span class="lineNum">    2092 </span>            :                 char szRep[100];
<span class="lineNum">    2093 </span><span class="lineCov">        197 :                 sprintf(szRep, &quot;%d&quot;, *nb_dash_inputs);</span>
<span class="lineNum">    2094 </span><span class="lineCov">        197 :                 di-&gt;representationID = gf_strdup(szRep);</span>
<span class="lineNum">    2095 </span>            :         }
<span class="lineNum">    2096 </span>            : 
<span class="lineNum">    2097 </span><span class="lineCov">        209 :         return dash_inputs;</span>
<a name="2098"><span class="lineNum">    2098 </span>            : }</a>
<span class="lineNum">    2099 </span>            : 
<span class="lineNum">    2100 </span><span class="lineCov">        165 : static Bool create_new_track_action(char *arg_val, u32 act_type, u32 dump_type)</span>
<span class="lineNum">    2101 </span>            : {
<span class="lineNum">    2102 </span>            :         TrackAction *tka;
<span class="lineNum">    2103 </span>            :         char *param = arg_val;
<span class="lineNum">    2104 </span><span class="lineCov">        165 :         tracks = (TrackAction *)gf_realloc(tracks, sizeof(TrackAction) * (nb_track_act+1));</span>
<span class="lineNum">    2105 </span><span class="lineCov">        165 :         if (!tracks) return GF_FALSE;</span>
<span class="lineNum">    2106 </span>            : 
<span class="lineNum">    2107 </span><span class="lineCov">        165 :         tka = &amp; tracks[nb_track_act];</span>
<span class="lineNum">    2108 </span><span class="lineCov">        165 :         nb_track_act++;</span>
<span class="lineNum">    2109 </span>            : 
<span class="lineNum">    2110 </span>            :         memset(tka, 0, sizeof(TrackAction) );
<span class="lineNum">    2111 </span><span class="lineCov">        165 :         tka-&gt;act_type = act_type;</span>
<span class="lineNum">    2112 </span><span class="lineCov">        165 :         tka-&gt;dump_type = dump_type;</span>
<span class="lineNum">    2113 </span><span class="lineCov">        165 :         if (act_type != TRAC_ACTION_RAW_EXTRACT) {</span>
<span class="lineNum">    2114 </span><span class="lineCov">        100 :                 open_edit = GF_TRUE;</span>
<span class="lineNum">    2115 </span><span class="lineCov">        100 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    2116 </span>            :         }
<span class="lineNum">    2117 </span>            : 
<span class="lineNum">    2118 </span><span class="lineCov">        165 :         if ((act_type==TRAC_ACTION_SET_ID) || (act_type==TRAC_ACTION_SWAP_ID)) {</span>
<span class="lineNum">    2119 </span><span class="lineCov">          2 :                 if (sscanf(param, &quot;%d:%u&quot;, &amp;tka-&gt;trackID, &amp;tka-&gt;newTrackID) != 2) {</span>
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Bad format for -set-track-id - expecting \&quot;id1:id2\&quot; got \&quot;%s\&quot;\n&quot;, param));</span>
<span class="lineNum">    2121 </span>            :                         return GF_FALSE;
<span class="lineNum">    2122 </span>            :                 }
<span class="lineNum">    2123 </span>            :                 return GF_TRUE;
<span class="lineNum">    2124 </span>            :         }
<span class="lineNum">    2125 </span><span class="lineCov">        163 :         if (act_type==TRAC_ACTION_SET_PAR) {</span>
<span class="lineNum">    2126 </span>            :                 char *ext;
<span class="lineNum">    2127 </span><span class="lineCov">         12 :                 ext = strchr(param, '=');</span>
<span class="lineNum">    2128 </span><span class="lineCov">         12 :                 if (!ext) {</span>
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track par - expecting tkID=none or tkID=PAR_NUM:PAR_DEN got %s\n&quot;, param));</span>
<span class="lineNum">    2130 </span>            :                         return GF_FALSE;
<span class="lineNum">    2131 </span>            :                 }
<span class="lineNum">    2132 </span><span class="lineCov">         12 :                 ext[0] = 0;</span>
<span class="lineNum">    2133 </span><span class="lineCov">         12 :                 tka-&gt;trackID = atoi(param);</span>
<span class="lineNum">    2134 </span><span class="lineCov">         12 :                 ext[0] = '=';</span>
<span class="lineNum">    2135 </span>            : 
<span class="lineNum">    2136 </span><span class="lineCov">         12 :                 if (!stricmp(ext+1, &quot;none&quot;))</span>
<span class="lineNum">    2137 </span><span class="lineCov">          3 :                         tka-&gt;par_num = tka-&gt;par_den = 0;</span>
<span class="lineNum">    2138 </span><span class="lineCov">          9 :                 else if (!stricmp(ext+1, &quot;auto&quot;)) {</span>
<span class="lineNum">    2139 </span><span class="lineCov">          3 :                         tka-&gt;par_num = tka-&gt;par_den = -1;</span>
<span class="lineNum">    2140 </span><span class="lineCov">          3 :                         tka-&gt;force_par = 1;</span>
<span class="lineNum">    2141 </span>            :                 }
<span class="lineNum">    2142 </span><span class="lineCov">          6 :                 else if (!stricmp(ext+1, &quot;force&quot;)) {</span>
<span class="lineNum">    2143 </span><span class="lineNoCov">          0 :                         tka-&gt;par_num = tka-&gt;par_den = 1;</span>
<span class="lineNum">    2144 </span><span class="lineNoCov">          0 :                         tka-&gt;force_par = 1;</span>
<span class="lineNum">    2145 </span>            :                 }
<span class="lineNum">    2146 </span>            :                 else {
<span class="lineNum">    2147 </span><span class="lineCov">          6 :                         if (ext[1]=='w') {</span>
<span class="lineNum">    2148 </span><span class="lineCov">          3 :                                 tka-&gt;rewrite_bs = 1;</span>
<span class="lineNum">    2149 </span>            :                                 ext++;
<span class="lineNum">    2150 </span>            :                         }
<span class="lineNum">    2151 </span><span class="lineCov">          6 :                         if (sscanf(ext+1, &quot;%d:%d&quot;, &amp;tka-&gt;par_num, &amp;tka-&gt;par_den) != 2) {</span>
<span class="lineNum">    2152 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track par - expecting tkID=PAR_NUM:PAR_DEN got %s\n&quot;, param));</span>
<span class="lineNum">    2153 </span>            :                                 return GF_FALSE;
<span class="lineNum">    2154 </span>            :                         }
<span class="lineNum">    2155 </span>            :                 }
<span class="lineNum">    2156 </span>            :                 return GF_TRUE;
<span class="lineNum">    2157 </span>            :         }
<span class="lineNum">    2158 </span><span class="lineCov">        151 :         if (act_type==TRAC_ACTION_SET_CLAP) {</span>
<span class="lineNum">    2159 </span><span class="lineCov">          2 :                 char *ext = strchr(param, '=');</span>
<span class="lineNum">    2160 </span><span class="lineCov">          2 :                 if (!ext) {</span>
<span class="lineNum">    2161 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track clap - expecting tkID=none or tkID=Wn,Wd,Hn,Hd,HOn,HOd,VOn,VOd got %s\n&quot;, param));</span>
<span class="lineNum">    2162 </span>            :                         return GF_FALSE;
<span class="lineNum">    2163 </span>            :                 }
<span class="lineNum">    2164 </span><span class="lineCov">          2 :                 ext[0] = 0;</span>
<span class="lineNum">    2165 </span><span class="lineCov">          2 :                 tka-&gt;trackID = atoi(param);</span>
<span class="lineNum">    2166 </span><span class="lineCov">          2 :                 ext[0] = '=';</span>
<span class="lineNum">    2167 </span><span class="lineCov">          2 :                 if (stricmp(ext + 1, &quot;none&quot;)) {</span>
<span class="lineNum">    2168 </span><span class="lineCov">          2 :                         if (sscanf(ext + 1, &quot;%d,%d,%d,%d,%d,%d,%d,%d&quot;, &amp;tka-&gt;clap_wnum, &amp;tka-&gt;clap_wden, &amp;tka-&gt;clap_hnum, &amp;tka-&gt;clap_hden, &amp;tka-&gt;clap_honum, &amp;tka-&gt;clap_hoden, &amp;tka-&gt;clap_vonum, &amp;tka-&gt;clap_voden) != 8) {</span>
<span class="lineNum">    2169 </span>            : 
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track clap - expecting tkID=none or tkID=Wn,Wd,Hn,Hd,HOn,HOd,VOn,VOd got %s\n&quot;, param));</span>
<span class="lineNum">    2171 </span>            :                                 return GF_FALSE;
<span class="lineNum">    2172 </span>            :                         }
<span class="lineNum">    2173 </span>            :                 }
<span class="lineNum">    2174 </span>            :                 return GF_TRUE;
<span class="lineNum">    2175 </span>            :         }
<span class="lineNum">    2176 </span>            : 
<span class="lineNum">    2177 </span><span class="lineCov">        149 :         if (act_type==TRAC_ACTION_SET_MX) {</span>
<span class="lineNum">    2178 </span><span class="lineNoCov">          0 :                 char *ext = strchr(param, '=');</span>
<span class="lineNum">    2179 </span><span class="lineNoCov">          0 :                 if (!ext) {</span>
<span class="lineNum">    2180 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track matrix - expecting ID=none or ID=M1:M2:M3:M4:M5:M6:M7:M8:M9 got %s\n&quot;, param));</span>
<span class="lineNum">    2181 </span>            :                         return GF_FALSE;
<span class="lineNum">    2182 </span>            :                 }
<span class="lineNum">    2183 </span><span class="lineNoCov">          0 :                 ext[0] = 0;</span>
<span class="lineNum">    2184 </span><span class="lineNoCov">          0 :                 tka-&gt;trackID = atoi(param);</span>
<span class="lineNum">    2185 </span><span class="lineNoCov">          0 :                 ext[0] = '=';</span>
<span class="lineNum">    2186 </span><span class="lineNoCov">          0 :                 if (!stricmp(ext + 1, &quot;none&quot;)) {</span>
<span class="lineNum">    2187 </span><span class="lineNoCov">          0 :                         memset(tka-&gt;mx, 0, sizeof(s32)*9);</span>
<span class="lineNum">    2188 </span><span class="lineNoCov">          0 :                         tka-&gt;mx[0] = tka-&gt;mx[4] = tka-&gt;mx[8] = 1;</span>
<span class="lineNum">    2189 </span>            :                 } else {
<span class="lineNum">    2190 </span>            :                         s32 res;
<span class="lineNum">    2191 </span><span class="lineNoCov">          0 :                         if (strstr(ext+1, &quot;0x&quot;)) {</span>
<span class="lineNum">    2192 </span><span class="lineNoCov">          0 :                                 res = sscanf(ext + 1, &quot;0x%d:0x%d:0x%d:0x%d:0x%d:0x%d:0x%d:0x%d:0x%d&quot;, &amp;tka-&gt;mx[0], &amp;tka-&gt;mx[1], &amp;tka-&gt;mx[2], &amp;tka-&gt;mx[3], &amp;tka-&gt;mx[4], &amp;tka-&gt;mx[5], &amp;tka-&gt;mx[6], &amp;tka-&gt;mx[7], &amp;tka-&gt;mx[8]);</span>
<span class="lineNum">    2193 </span>            :                         } else {
<span class="lineNum">    2194 </span><span class="lineNoCov">          0 :                                 res = sscanf(ext + 1, &quot;%d:%d:%d:%d:%d:%d:%d:%d:%d&quot;, &amp;tka-&gt;mx[0], &amp;tka-&gt;mx[1], &amp;tka-&gt;mx[2], &amp;tka-&gt;mx[3], &amp;tka-&gt;mx[4], &amp;tka-&gt;mx[5], &amp;tka-&gt;mx[6], &amp;tka-&gt;mx[7], &amp;tka-&gt;mx[8]);</span>
<span class="lineNum">    2195 </span>            :                         }
<span class="lineNum">    2196 </span><span class="lineNoCov">          0 :                         if (res != 9) {</span>
<span class="lineNum">    2197 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track matrix - expecting ID=none or ID=M1:M2:M3:M4:M5:M6:M7:M8:M9 got %s\n&quot;, param));</span>
<span class="lineNum">    2198 </span>            :                                 return GF_FALSE;
<span class="lineNum">    2199 </span>            :                         }
<span class="lineNum">    2200 </span>            :                 }
<span class="lineNum">    2201 </span>            :                 return GF_TRUE;
<span class="lineNum">    2202 </span>            :         }
<span class="lineNum">    2203 </span><span class="lineCov">        149 :         if (act_type==TRAC_ACTION_SET_EDITS) {</span>
<span class="lineNum">    2204 </span><span class="lineCov">          1 :                 char *ext = strchr(param, '=');</span>
<span class="lineNum">    2205 </span><span class="lineCov">          1 :                 if (!ext) {</span>
<span class="lineNum">    2206 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track edits - expecting ID=EDITS got %s\n&quot;, param));</span>
<span class="lineNum">    2207 </span>            :                         return GF_FALSE;
<span class="lineNum">    2208 </span>            :                 }
<span class="lineNum">    2209 </span><span class="lineCov">          1 :                 ext[0] = 0;</span>
<span class="lineNum">    2210 </span><span class="lineCov">          1 :                 tka-&gt;trackID = atoi(param);</span>
<span class="lineNum">    2211 </span><span class="lineCov">          1 :                 ext[0] = '=';</span>
<span class="lineNum">    2212 </span><span class="lineCov">          1 :                 tka-&gt;string = gf_strdup(ext+1);</span>
<span class="lineNum">    2213 </span><span class="lineCov">          1 :                 return GF_TRUE;</span>
<span class="lineNum">    2214 </span>            :         }
<span class="lineNum">    2215 </span><span class="lineCov">        148 :         if (act_type==TRAC_ACTION_SET_LANGUAGE) {</span>
<span class="lineNum">    2216 </span><span class="lineCov">         11 :                 char *ext = strchr(param, '=');</span>
<span class="lineNum">    2217 </span><span class="lineCov">         11 :                 if (!strnicmp(param, &quot;all=&quot;, 4)) {</span>
<span class="lineNum">    2218 </span><span class="lineCov">          4 :                         strncpy(tka-&gt;lang, param + 4, 10-1);</span>
<span class="lineNum">    2219 </span>            :                 }
<span class="lineNum">    2220 </span><span class="lineCov">          7 :                 else if (!ext) {</span>
<span class="lineNum">    2221 </span><span class="lineCov">          3 :                         strncpy(tka-&gt;lang, param, 10-1);</span>
<span class="lineNum">    2222 </span>            :                 } else {
<span class="lineNum">    2223 </span><span class="lineCov">          4 :                         strncpy(tka-&gt;lang, ext + 1, 10-1);</span>
<span class="lineNum">    2224 </span><span class="lineCov">          4 :                         ext[0] = 0;</span>
<span class="lineNum">    2225 </span><span class="lineCov">          4 :                         tka-&gt;trackID = atoi(param);</span>
<span class="lineNum">    2226 </span><span class="lineCov">          4 :                         ext[0] = '=';</span>
<span class="lineNum">    2227 </span>            :                 }
<span class="lineNum">    2228 </span>            :                 return GF_TRUE;
<span class="lineNum">    2229 </span>            :         }
<span class="lineNum">    2230 </span><span class="lineCov">        137 :         if ((act_type==TRAC_ACTION_SET_KIND) || (act_type==TRAC_ACTION_REM_KIND)) {</span>
<span class="lineNum">    2231 </span>            :                 char *ext;
<span class="lineNum">    2232 </span>            :                 char *scheme_start = NULL;
<span class="lineNum">    2233 </span>            : 
<span class="lineNum">    2234 </span>            :                 //extract trackID
<span class="lineNum">    2235 </span><span class="lineCov">         53 :                 if (!strnicmp(param, &quot;all=&quot;, 4)) {</span>
<span class="lineNum">    2236 </span><span class="lineCov">         20 :                         scheme_start = param + 4;</span>
<span class="lineNum">    2237 </span>            :                 } else {
<span class="lineNum">    2238 </span><span class="lineCov">         33 :                         ext = strchr(param, '=');</span>
<span class="lineNum">    2239 </span><span class="lineCov">         33 :                         if (ext) {</span>
<span class="lineNum">    2240 </span><span class="lineCov">         21 :                                 ext[0] = 0;</span>
<span class="lineNum">    2241 </span><span class="lineCov">         21 :                                 if (sscanf(param, &quot;%d&quot;, &amp;tka-&gt;trackID) == 1) {</span>
<span class="lineNum">    2242 </span><span class="lineCov">         12 :                                         scheme_start = ext + 1;</span>
<span class="lineNum">    2243 </span>            :                                 } else {
<span class="lineNum">    2244 </span>            :                                         scheme_start = param;
<span class="lineNum">    2245 </span>            :                                 }
<span class="lineNum">    2246 </span><span class="lineCov">         21 :                                 ext[0] = '=';</span>
<span class="lineNum">    2247 </span>            :                         } else {
<span class="lineNum">    2248 </span>            :                                 scheme_start = param;
<span class="lineNum">    2249 </span>            :                         }
<span class="lineNum">    2250 </span>            :                 }
<span class="lineNum">    2251 </span>            : 
<span class="lineNum">    2252 </span>            :                 //extract scheme and value - if not, remove kind
<span class="lineNum">    2253 </span><span class="lineCov">         53 :                 if (!scheme_start || !scheme_start[0]) {</span>
<span class="lineNum">    2254 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Missing kind scheme - expecting ID=schemeURI=value got %s\n&quot;, param));</span>
<span class="lineNum">    2255 </span>            :                         return GF_FALSE;
<span class="lineNum">    2256 </span>            :                 } else {
<span class="lineNum">    2257 </span><span class="lineCov">         53 :                         ext = strchr(scheme_start, '=');</span>
<span class="lineNum">    2258 </span><span class="lineCov">         53 :                         if (!ext) {</span>
<span class="lineNum">    2259 </span><span class="lineCov">         33 :                                 tka-&gt;kind_scheme = gf_strdup(scheme_start);</span>
<span class="lineNum">    2260 </span>            :                         } else {
<span class="lineNum">    2261 </span><span class="lineCov">         20 :                                 ext[0] = 0;</span>
<span class="lineNum">    2262 </span><span class="lineCov">         20 :                                 tka-&gt;kind_scheme = gf_strdup(scheme_start);</span>
<span class="lineNum">    2263 </span><span class="lineCov">         20 :                                 ext[0] = '=';</span>
<span class="lineNum">    2264 </span><span class="lineCov">         20 :                                 tka-&gt;kind_value = gf_strdup(ext + 1);</span>
<span class="lineNum">    2265 </span>            :                         }
<span class="lineNum">    2266 </span>            :                 }
<span class="lineNum">    2267 </span>            :                 return GF_TRUE;
<span class="lineNum">    2268 </span>            :         }
<span class="lineNum">    2269 </span><span class="lineCov">         84 :         if (act_type==TRAC_ACTION_SET_DELAY) {</span>
<span class="lineNum">    2270 </span><span class="lineCov">          1 :                 char *ext = strchr(param, '=');</span>
<span class="lineNum">    2271 </span><span class="lineCov">          1 :                 if (!ext) {</span>
<span class="lineNum">    2272 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track delay - expecting tkID=DLAY got %s\n&quot;, param));</span>
<span class="lineNum">    2273 </span>            :                         return GF_FALSE;
<span class="lineNum">    2274 </span>            :                 }
<span class="lineNum">    2275 </span><span class="lineCov">          1 :                 ext[0] = 0;</span>
<span class="lineNum">    2276 </span><span class="lineCov">          1 :                 tka-&gt;trackID = atoi(param);</span>
<span class="lineNum">    2277 </span><span class="lineCov">          1 :                 ext[0] = '=';</span>
<span class="lineNum">    2278 </span><span class="lineCov">          1 :                 if (sscanf(ext+1, &quot;%d/%u&quot;, &amp;tka-&gt;delay.num, &amp;tka-&gt;delay.den) != 2) {</span>
<span class="lineNum">    2279 </span><span class="lineCov">          1 :                         tka-&gt;delay.num = atoi(ext + 1);</span>
<span class="lineNum">    2280 </span><span class="lineCov">          1 :                         tka-&gt;delay.den = 1000;</span>
<span class="lineNum">    2281 </span>            :                 }
<span class="lineNum">    2282 </span>            :                 return GF_TRUE;
<span class="lineNum">    2283 </span>            :         }
<span class="lineNum">    2284 </span><span class="lineCov">         83 :         if (act_type==TRAC_ACTION_REFERENCE) {</span>
<span class="lineNum">    2285 </span><span class="lineCov">          1 :                 char *ext = strchr(param, '=');</span>
<span class="lineNum">    2286 </span><span class="lineCov">          1 :                 if (!ext) ext = strchr(param, ':');</span>
<span class="lineNum">    2287 </span><span class="lineCov">          1 :                 if (!ext) {</span>
<span class="lineNum">    2288 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track reference - expecting tkID:XXXX:refID got %s\n&quot;, param));</span>
<span class="lineNum">    2289 </span>            :                         return GF_FALSE;
<span class="lineNum">    2290 </span>            :                 }
<span class="lineNum">    2291 </span><span class="lineCov">          1 :                 ext[0] = 0;</span>
<span class="lineNum">    2292 </span><span class="lineCov">          1 :                 tka-&gt;trackID = atoi(param);</span>
<span class="lineNum">    2293 </span><span class="lineCov">          1 :                 ext[0] = '=';</span>
<span class="lineNum">    2294 </span>            : 
<span class="lineNum">    2295 </span><span class="lineCov">          1 :                 char *ext2 = strchr(ext, ':');</span>
<span class="lineNum">    2296 </span><span class="lineCov">          1 :                 if (!ext2) {</span>
<span class="lineNum">    2297 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track reference - expecting tkID:XXXX:refID got %s\n&quot;, param));</span>
<span class="lineNum">    2298 </span>            :                         return GF_FALSE;
<span class="lineNum">    2299 </span>            :                 }
<span class="lineNum">    2300 </span><span class="lineCov">          1 :                 ext2[0] = 0;</span>
<span class="lineNum">    2301 </span><span class="lineCov">          1 :                 strncpy(tka-&gt;lang, ext+1, 9);</span>
<span class="lineNum">    2302 </span><span class="lineCov">          1 :                 ext2[0] = ':';</span>
<span class="lineNum">    2303 </span><span class="lineCov">          2 :                 tka-&gt;newTrackID = (s32) atoi(ext2 + 1);</span>
<span class="lineNum">    2304 </span><span class="lineCov">          1 :                 return GF_TRUE;</span>
<span class="lineNum">    2305 </span>            :         }
<span class="lineNum">    2306 </span><span class="lineCov">         82 :         if (act_type==TRAC_ACTION_SET_HANDLER_NAME) {</span>
<span class="lineNum">    2307 </span><span class="lineCov">          1 :                 char *ext = strchr(param, '=');</span>
<span class="lineNum">    2308 </span><span class="lineCov">          1 :                 if (!ext) {</span>
<span class="lineNum">    2309 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Bad format for track name - expecting tkID=name got %s\n&quot;, param));</span>
<span class="lineNum">    2310 </span>            :                         return GF_FALSE;
<span class="lineNum">    2311 </span>            :                 }
<span class="lineNum">    2312 </span><span class="lineCov">          1 :                 ext[0] = 0;</span>
<span class="lineNum">    2313 </span><span class="lineCov">          1 :                 tka-&gt;trackID = atoi(param);</span>
<span class="lineNum">    2314 </span><span class="lineCov">          1 :                 ext[0] = '=';</span>
<span class="lineNum">    2315 </span><span class="lineCov">          1 :                 tka-&gt;hdl_name = ext + 1;</span>
<span class="lineNum">    2316 </span><span class="lineCov">          1 :                 return GF_TRUE;</span>
<span class="lineNum">    2317 </span>            :         }
<span class="lineNum">    2318 </span><span class="lineCov">         81 :         if (act_type==TRAC_ACTION_SET_KMS_URI) {</span>
<span class="lineNum">    2319 </span><span class="lineCov">          5 :                 char *ext = strchr(param, '=');</span>
<span class="lineNum">    2320 </span>            : 
<span class="lineNum">    2321 </span><span class="lineCov">          5 :                 if (!strnicmp(param, &quot;all=&quot;, 4)) {</span>
<span class="lineNum">    2322 </span><span class="lineNoCov">          0 :                         tka-&gt;kms = param + 4;</span>
<span class="lineNum">    2323 </span><span class="lineCov">          5 :                 } else if (!ext) {</span>
<span class="lineNum">    2324 </span><span class="lineCov">          5 :                         tka-&gt;kms = param;</span>
<span class="lineNum">    2325 </span>            :                 } else {
<span class="lineNum">    2326 </span><span class="lineNoCov">          0 :                         tka-&gt;kms = ext + 1;</span>
<span class="lineNum">    2327 </span><span class="lineNoCov">          0 :                         ext[0] = 0;</span>
<span class="lineNum">    2328 </span><span class="lineNoCov">          0 :                         tka-&gt;trackID = atoi(param);</span>
<span class="lineNum">    2329 </span><span class="lineNoCov">          0 :                         ext[0] = '=';</span>
<span class="lineNum">    2330 </span>            :                 }
<span class="lineNum">    2331 </span>            :                 return GF_TRUE;
<span class="lineNum">    2332 </span>            :         }
<span class="lineNum">    2333 </span><span class="lineCov">         76 :         if ((act_type==TRAC_ACTION_SET_TIME) || (act_type==TRAC_ACTION_SET_MEDIA_TIME)) {</span>
<span class="lineNum">    2334 </span>            :                 struct tm time;
<span class="lineNum">    2335 </span><span class="lineCov">          1 :                 char *ext = strchr(arg_val, '=');</span>
<span class="lineNum">    2336 </span><span class="lineCov">          1 :                 if (ext) {</span>
<span class="lineNum">    2337 </span><span class="lineNoCov">          0 :                         ext[0] = 0;</span>
<span class="lineNum">    2338 </span><span class="lineNoCov">          0 :                         tka-&gt;trackID = atoi(arg_val);</span>
<span class="lineNum">    2339 </span><span class="lineNoCov">          0 :                         ext[0] = '=';</span>
<span class="lineNum">    2340 </span><span class="lineNoCov">          0 :                         arg_val = ext+1;</span>
<span class="lineNum">    2341 </span>            :                 }
<span class="lineNum">    2342 </span>            :                 memset(&amp;time, 0, sizeof(struct tm));
<span class="lineNum">    2343 </span><span class="lineCov">          1 :                 sscanf(arg_val, &quot;%d/%d/%d-%d:%d:%d&quot;, &amp;time.tm_mday, &amp;time.tm_mon, &amp;time.tm_year, &amp;time.tm_hour, &amp;time.tm_min, &amp;time.tm_sec);</span>
<span class="lineNum">    2344 </span><span class="lineCov">          1 :                 time.tm_isdst = 0;</span>
<span class="lineNum">    2345 </span><span class="lineCov">          1 :                 time.tm_year -= 1900;</span>
<span class="lineNum">    2346 </span><span class="lineCov">          1 :                 time.tm_mon -= 1;</span>
<span class="lineNum">    2347 </span><span class="lineCov">          1 :                 tka-&gt;time = 2082758400;</span>
<span class="lineNum">    2348 </span><span class="lineCov">          1 :                 tka-&gt;time += mktime(&amp;time);</span>
<span class="lineNum">    2349 </span>            :                 return GF_TRUE;
<span class="lineNum">    2350 </span>            :         }
<span class="lineNum">    2351 </span>            : 
<span class="lineNum">    2352 </span><span class="lineCov">        171 :         while (param) {</span>
<span class="lineNum">    2353 </span><span class="lineCov">         96 :                 param = gf_url_colon_suffix(param);</span>
<span class="lineNum">    2354 </span><span class="lineCov">         96 :                 if (param) {</span>
<span class="lineNum">    2355 </span><span class="lineCov">         21 :                         *param = 0;</span>
<span class="lineNum">    2356 </span><span class="lineCov">         21 :                         param++;</span>
<span class="lineNum">    2357 </span>            : #ifndef GPAC_DISABLE_MEDIA_EXPORT
<span class="lineNum">    2358 </span><span class="lineCov">         21 :                         if (!strncmp(&quot;vttnomerge&quot;, param, 10)) {</span>
<span class="lineNum">    2359 </span><span class="lineNoCov">          0 :                                 tka-&gt;dump_type |= GF_EXPORT_WEBVTT_NOMERGE;</span>
<span class="lineNum">    2360 </span><span class="lineCov">         21 :                         } else if (!strncmp(&quot;layer&quot;, param, 5)) {</span>
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :                                 tka-&gt;dump_type |= GF_EXPORT_SVC_LAYER;</span>
<span class="lineNum">    2362 </span><span class="lineCov">         21 :                         } else if (!strncmp(&quot;full&quot;, param, 4)) {</span>
<span class="lineNum">    2363 </span><span class="lineCov">          1 :                                 tka-&gt;dump_type |= GF_EXPORT_NHML_FULL;</span>
<span class="lineNum">    2364 </span><span class="lineCov">         20 :                         } else if (!strncmp(&quot;embedded&quot;, param, 8)) {</span>
<span class="lineNum">    2365 </span><span class="lineNoCov">          0 :                                 tka-&gt;dump_type |= GF_EXPORT_WEBVTT_META_EMBEDDED;</span>
<span class="lineNum">    2366 </span><span class="lineCov">         20 :                         } else if (!strncmp(&quot;output=&quot;, param, 7)) {</span>
<span class="lineNum">    2367 </span><span class="lineCov">          1 :                                 tka-&gt;out_name = gf_strdup(param+7);</span>
<span class="lineNum">    2368 </span><span class="lineCov">         19 :                         } else if (!strncmp(&quot;src=&quot;, param, 4)) {</span>
<span class="lineNum">    2369 </span><span class="lineCov">          3 :                                 tka-&gt;src_name = gf_strdup(param+4);</span>
<span class="lineNum">    2370 </span><span class="lineCov">         16 :                         } else if (!strncmp(&quot;str=&quot;, param, 4)) {</span>
<span class="lineNum">    2371 </span><span class="lineCov">          1 :                                 tka-&gt;string = gf_strdup(param+4);</span>
<span class="lineNum">    2372 </span><span class="lineCov">         15 :                         } else if (!strncmp(&quot;box=&quot;, param, 4)) {</span>
<span class="lineNum">    2373 </span><span class="lineCov">          1 :                                 tka-&gt;src_name = gf_strdup(param+4);</span>
<span class="lineNum">    2374 </span><span class="lineCov">          1 :                                 tka-&gt;sample_num = 1;</span>
<span class="lineNum">    2375 </span><span class="lineCov">         14 :                         } else if (!strncmp(&quot;type=&quot;, param, 4)) {</span>
<span class="lineNum">    2376 </span><span class="lineCov">          5 :                                 tka-&gt;udta_type = GF_4CC(param[5], param[6], param[7], param[8]);</span>
<span class="lineNum">    2377 </span><span class="lineCov">          9 :                         } else if (tka-&gt;dump_type == GF_EXPORT_RAW_SAMPLES) {</span>
<span class="lineNum">    2378 </span><span class="lineCov">          1 :                                 tka-&gt;sample_num = atoi(param);</span>
<span class="lineNum">    2379 </span>            :                         }
<span class="lineNum">    2380 </span>            : #endif
<span class="lineNum">    2381 </span>            :                 }
<span class="lineNum">    2382 </span>            :         }
<span class="lineNum">    2383 </span><span class="lineCov">         75 :         if (arg_val) {</span>
<span class="lineNum">    2384 </span><span class="lineCov">         75 :                 if (!strcmp(arg_val, &quot;*&quot;)) {</span>
<span class="lineNum">    2385 </span><span class="lineNoCov">          0 :                         tka-&gt;trackID = (u32) -1;</span>
<span class="lineNum">    2386 </span>            :                 } else {
<span class="lineNum">    2387 </span><span class="lineCov">         75 :                         if (act_type==TRAC_ACTION_RAW_EXTRACT) {</span>
<span class="lineNum">    2388 </span><span class="lineCov">         65 :                                 if (!strncmp(arg_val, &quot;video&quot;, 5)) {</span>
<span class="lineNum">    2389 </span><span class="lineNoCov">          0 :                                         arg_val += 5;</span>
<span class="lineNum">    2390 </span><span class="lineNoCov">          0 :                                         tka-&gt;dump_track_type = 1;</span>
<span class="lineNum">    2391 </span>            :                                 }
<span class="lineNum">    2392 </span><span class="lineCov">         65 :                                 else if (!strncmp(arg_val, &quot;audio&quot;, 5)) {</span>
<span class="lineNum">    2393 </span><span class="lineNoCov">          0 :                                         arg_val += 5;</span>
<span class="lineNum">    2394 </span><span class="lineNoCov">          0 :                                         tka-&gt;dump_track_type = 2;</span>
<span class="lineNum">    2395 </span>            :                                 }
<span class="lineNum">    2396 </span>            :                         }
<span class="lineNum">    2397 </span><span class="lineCov">         75 :                         if (arg_val[0])</span>
<span class="lineNum">    2398 </span><span class="lineCov">         75 :                                 tka-&gt;trackID = atoi(arg_val);</span>
<span class="lineNum">    2399 </span>            :                 }
<span class="lineNum">    2400 </span>            :         }
<span class="lineNum">    2401 </span>            :         return GF_TRUE;
<a name="2402"><span class="lineNum">    2402 </span>            : }</a>
<span class="lineNum">    2403 </span>            : 
<span class="lineNum">    2404 </span><span class="lineCov">         65 : u32 parse_track_dump(char *arg, u32 dump_type)</span>
<span class="lineNum">    2405 </span>            : {
<span class="lineNum">    2406 </span><span class="lineCov">         65 :         if (!create_new_track_action(arg, TRAC_ACTION_RAW_EXTRACT, dump_type))</span>
<span class="lineNum">    2407 </span>            :                 return 2;
<span class="lineNum">    2408 </span><span class="lineCov">         65 :         track_dump_type = dump_type;</span>
<a name="2409"><span class="lineNum">    2409 </span><span class="lineCov">         65 :         return 0;</span></a>
<span class="lineNum">    2410 </span>            : }
<span class="lineNum">    2411 </span><span class="lineCov">         98 : u32 parse_track_action(char *arg, u32 act_type)</span>
<span class="lineNum">    2412 </span>            : {
<span class="lineNum">    2413 </span><span class="lineCov">        100 :         if (!create_new_track_action(arg, act_type, 0)) {</span>
<span class="lineNum">    2414 </span>            :                 return 2;
<span class="lineNum">    2415 </span>            :         }
<span class="lineNum">    2416 </span><span class="lineCov">         98 :         return 0;</span>
<a name="2417"><span class="lineNum">    2417 </span>            : }</a>
<span class="lineNum">    2418 </span>            : 
<span class="lineNum">    2419 </span><span class="lineCov">          2 : u32 parse_comp_box(char *arg_val, u32 opt)</span>
<span class="lineNum">    2420 </span>            : {
<span class="lineNum">    2421 </span><span class="lineCov">          2 :         compress_top_boxes = arg_val;</span>
<span class="lineNum">    2422 </span><span class="lineCov">          2 :         size_top_box = opt;</span>
<a name="2423"><span class="lineNum">    2423 </span><span class="lineCov">          2 :         return 0;</span></a>
<span class="lineNum">    2424 </span>            : }
<span class="lineNum">    2425 </span><span class="lineCov">         21 : u32 parse_dnal(char *arg_val, u32 opt)</span>
<span class="lineNum">    2426 </span>            : {
<span class="lineNum">    2427 </span><span class="lineCov">         21 :         dump_nal = atoi(arg_val);</span>
<span class="lineNum">    2428 </span><span class="lineCov">         21 :         dump_nal_type = opt;</span>
<a name="2429"><span class="lineNum">    2429 </span><span class="lineCov">         21 :         return 0;</span></a>
<span class="lineNum">    2430 </span>            : }
<span class="lineNum">    2431 </span><span class="lineCov">          5 : u32 parse_dsap(char *arg_val, u32 opt)</span>
<span class="lineNum">    2432 </span>            : {
<span class="lineNum">    2433 </span><span class="lineCov">          5 :         dump_saps = atoi(arg_val);</span>
<span class="lineNum">    2434 </span><span class="lineCov">          5 :         dump_saps_mode = opt;</span>
<span class="lineNum">    2435 </span><span class="lineCov">          5 :         return 0;</span>
<a name="2436"><span class="lineNum">    2436 </span>            : }</a>
<span class="lineNum">    2437 </span>            : 
<span class="lineNum">    2438 </span><span class="lineCov">          3 : u32 parse_bs_switch(char *arg_val, u32 opt)</span>
<span class="lineNum">    2439 </span>            : {
<span class="lineNum">    2440 </span><span class="lineCov">          3 :         if (!stricmp(arg_val, &quot;no&quot;) || !stricmp(arg_val, &quot;off&quot;)) bitstream_switching_mode = GF_DASH_BSMODE_NONE;</span>
<span class="lineNum">    2441 </span><span class="lineCov">          1 :         else if (!stricmp(arg_val, &quot;merge&quot;))  bitstream_switching_mode = GF_DASH_BSMODE_MERGED;</span>
<span class="lineNum">    2442 </span><span class="lineCov">          1 :         else if (!stricmp(arg_val, &quot;multi&quot;))  bitstream_switching_mode = GF_DASH_BSMODE_MULTIPLE_ENTRIES;</span>
<span class="lineNum">    2443 </span><span class="lineCov">          1 :         else if (!stricmp(arg_val, &quot;single&quot;))  bitstream_switching_mode = GF_DASH_BSMODE_SINGLE;</span>
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 :         else if (!stricmp(arg_val, &quot;inband&quot;))  bitstream_switching_mode = GF_DASH_BSMODE_INBAND;</span>
<span class="lineNum">    2445 </span>            :         else {
<span class="lineNum">    2446 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Unrecognized bitstream switching mode \&quot;%s\&quot; - please check usage\n&quot;, arg_val));</span>
<span class="lineNum">    2447 </span>            :                 return 2;
<span class="lineNum">    2448 </span>            :         }
<span class="lineNum">    2449 </span>            :         return 0;
<a name="2450"><span class="lineNum">    2450 </span>            : }</a>
<span class="lineNum">    2451 </span>            : 
<span class="lineNum">    2452 </span><span class="lineNoCov">          0 : u32 parse_cp_loc(char *arg_val, u32 opt)</span>
<span class="lineNum">    2453 </span>            : {
<span class="lineNum">    2454 </span><span class="lineNoCov">          0 :         if (!strcmp(arg_val, &quot;both&quot;)) cp_location_mode = GF_DASH_CPMODE_BOTH;</span>
<span class="lineNum">    2455 </span><span class="lineNoCov">          0 :         else if (!strcmp(arg_val, &quot;as&quot;)) cp_location_mode = GF_DASH_CPMODE_ADAPTATION_SET;</span>
<span class="lineNum">    2456 </span><span class="lineNoCov">          0 :         else if (!strcmp(arg_val, &quot;rep&quot;)) cp_location_mode = GF_DASH_CPMODE_REPRESENTATION;</span>
<span class="lineNum">    2457 </span>            :         else {
<span class="lineNum">    2458 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Unrecognized ContentProtection loction mode \&quot;%s\&quot; - please check usage\n&quot;, arg_val));</span>
<span class="lineNum">    2459 </span>            :                 return 2;
<span class="lineNum">    2460 </span>            :         }
<span class="lineNum">    2461 </span>            :         return 0;
<a name="2462"><span class="lineNum">    2462 </span>            : }</a>
<span class="lineNum">    2463 </span>            : 
<span class="lineNum">    2464 </span><span class="lineNoCov">          0 : u32 parse_pssh(char *arg_val, u32 opt)</span>
<span class="lineNum">    2465 </span>            : {
<span class="lineNum">    2466 </span><span class="lineNoCov">          0 :         if (!strcmp(arg_val, &quot;f&quot;)) pssh_mode = GF_DASH_PSSH_MOOF;</span>
<span class="lineNum">    2467 </span><span class="lineNoCov">          0 :         else if (!strcmp(arg_val, &quot;v&quot;)) pssh_mode = GF_DASH_PSSH_MOOV;</span>
<span class="lineNum">    2468 </span><span class="lineNoCov">          0 :         else if (!strcmp(arg_val, &quot;m&quot;)) pssh_mode = GF_DASH_PSSH_MPD;</span>
<span class="lineNum">    2469 </span><span class="lineNoCov">          0 :         else if (!strcmp(arg_val, &quot;mf&quot;) || !strcmp(arg_val, &quot;fm&quot;)) pssh_mode = GF_DASH_PSSH_MOOF_MPD;</span>
<span class="lineNum">    2470 </span><span class="lineNoCov">          0 :         else if (!strcmp(arg_val, &quot;mv&quot;) || !strcmp(arg_val, &quot;vm&quot;)) pssh_mode = GF_DASH_PSSH_MOOV_MPD;</span>
<span class="lineNum">    2471 </span><span class="lineNoCov">          0 :         else pssh_mode = GF_DASH_PSSH_MOOV;</span>
<a name="2472"><span class="lineNum">    2472 </span><span class="lineNoCov">          0 :         return 0;</span></a>
<span class="lineNum">    2473 </span>            : }
<span class="lineNum">    2474 </span><span class="lineNoCov">          0 : u32 parse_sdtp(char *arg_val, u32 opt)</span>
<span class="lineNum">    2475 </span>            : {
<span class="lineNum">    2476 </span><span class="lineNoCov">          0 :         if (!stricmp(arg_val, &quot;both&quot;)) sdtp_in_traf = 2;</span>
<span class="lineNum">    2477 </span><span class="lineNoCov">          0 :         else if (!stricmp(arg_val, &quot;sdtp&quot;)) sdtp_in_traf = 1;</span>
<span class="lineNum">    2478 </span><span class="lineNoCov">          0 :         else sdtp_in_traf = 0;</span>
<span class="lineNum">    2479 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="2480"><span class="lineNum">    2480 </span>            : }</a>
<span class="lineNum">    2481 </span>            : 
<span class="lineNum">    2482 </span><span class="lineCov">         20 : u32 parse_rap_ref(char *arg_val, u32 opt)</span>
<span class="lineNum">    2483 </span>            : {
<span class="lineNum">    2484 </span><span class="lineCov">         20 :         if (arg_val) {</span>
<span class="lineNum">    2485 </span><span class="lineCov">          2 :                 if (sscanf(arg_val, &quot;%d&quot;, &amp;trackID) == 1) {</span>
<span class="lineNum">    2486 </span><span class="lineCov">          2 :                         parse_track_action(arg_val, opt ? TRAC_ACTION_REM_NON_REFS : TRAC_ACTION_REM_NON_RAP);</span>
<span class="lineNum">    2487 </span>            :                 }
<span class="lineNum">    2488 </span>            :         }
<span class="lineNum">    2489 </span><span class="lineCov">         20 :         hint_flags |= GP_RTP_PCK_SIGNAL_RAP;</span>
<span class="lineNum">    2490 </span><span class="lineCov">         20 :         seg_at_rap = 1;</span>
<a name="2491"><span class="lineNum">    2491 </span><span class="lineCov">         20 :         return 0;</span></a>
<span class="lineNum">    2492 </span>            : }
<span class="lineNum">    2493 </span><span class="lineCov">         15 : u32 parse_store_mode(char *arg_val, u32 opt)</span>
<span class="lineNum">    2494 </span>            : {
<span class="lineNum">    2495 </span><span class="lineCov">         15 :         do_save = GF_TRUE;</span>
<span class="lineNum">    2496 </span><span class="lineCov">         15 :         if ((opt == 0) || (opt == 1)) {</span>
<span class="lineNum">    2497 </span><span class="lineCov">          6 :                 interleaving_time = atof(arg_val) / 1000;</span>
<span class="lineNum">    2498 </span><span class="lineCov">          6 :                 if (!interleaving_time) do_flat = 2;</span>
<span class="lineNum">    2499 </span><span class="lineCov">          6 :                 open_edit = GF_TRUE;</span>
<span class="lineNum">    2500 </span><span class="lineCov">          6 :                 no_inplace = GF_TRUE;</span>
<span class="lineNum">    2501 </span><span class="lineCov">          6 :                 if (opt==1) old_interleave = 1;</span>
<span class="lineNum">    2502 </span><span class="lineCov">          9 :         } else if (opt==2) {</span>
<span class="lineNum">    2503 </span><span class="lineCov">          8 :                 interleaving_time = atof(arg_val);</span>
<span class="lineNum">    2504 </span><span class="lineCov">          8 :                 do_frag = GF_TRUE;</span>
<span class="lineNum">    2505 </span>            :         } else {
<span class="lineNum">    2506 </span><span class="lineCov">          1 :                 force_new = 2;</span>
<span class="lineNum">    2507 </span><span class="lineCov">          1 :                 interleaving_time = 0.5;</span>
<span class="lineNum">    2508 </span><span class="lineCov">          1 :                 do_flat = 1;</span>
<span class="lineNum">    2509 </span>            :         }
<a name="2510"><span class="lineNum">    2510 </span><span class="lineCov">         15 :         return 0;</span></a>
<span class="lineNum">    2511 </span>            : }
<span class="lineNum">    2512 </span><span class="lineCov">          1 : u32 parse_base_url(char *arg_val, u32 opt)</span>
<span class="lineNum">    2513 </span>            : {
<span class="lineNum">    2514 </span><span class="lineCov">          1 :         mpd_base_urls = gf_realloc(mpd_base_urls, (nb_mpd_base_urls + 1)*sizeof(char**));</span>
<span class="lineNum">    2515 </span><span class="lineCov">          1 :         if (!mpd_base_urls) return 2;</span>
<span class="lineNum">    2516 </span><span class="lineCov">          1 :         mpd_base_urls[nb_mpd_base_urls] = arg_val;</span>
<span class="lineNum">    2517 </span><span class="lineCov">          1 :         nb_mpd_base_urls++;</span>
<a name="2518"><span class="lineNum">    2518 </span><span class="lineCov">          1 :         return 0;</span></a>
<span class="lineNum">    2519 </span>            : }
<span class="lineNum">    2520 </span><span class="lineNoCov">          0 : u32 parse_multi_rtp(char *arg_val, u32 opt)</span>
<span class="lineNum">    2521 </span>            : {
<span class="lineNum">    2522 </span><span class="lineNoCov">          0 :         hint_flags |= GP_RTP_PCK_USE_MULTI;</span>
<span class="lineNum">    2523 </span><span class="lineNoCov">          0 :         if (arg_val)</span>
<span class="lineNum">    2524 </span><span class="lineNoCov">          0 :                 max_ptime = atoi(arg_val);</span>
<span class="lineNum">    2525 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    2526 </span>            : }
<a name="2527"><span class="lineNum">    2527 </span>            : </a>
<span class="lineNum">    2528 </span>            : 
<span class="lineNum">    2529 </span><span class="lineCov">          7 : u32 parse_senc_param(char *arg_val, u32 opt)</span>
<span class="lineNum">    2530 </span>            : {
<span class="lineNum">    2531 </span><span class="lineCov">          7 :         switch (opt) {</span>
<span class="lineNum">    2532 </span><span class="lineCov">          3 :         case 0: //-sync</span>
<span class="lineNum">    2533 </span><span class="lineCov">          3 :                 smenc_opts.flags |= GF_SM_ENCODE_RAP_INBAND;</span>
<span class="lineNum">    2534 </span><span class="lineCov">          3 :                 smenc_opts.rap_freq = atoi(arg_val);</span>
<span class="lineNum">    2535 </span><span class="lineCov">          3 :                 break;</span>
<span class="lineNum">    2536 </span><span class="lineCov">          3 :         case 1: //-shadow</span>
<span class="lineNum">    2537 </span><span class="lineCov">          3 :                 smenc_opts.flags &amp;= ~GF_SM_ENCODE_RAP_INBAND;</span>
<span class="lineNum">    2538 </span><span class="lineCov">          3 :                 smenc_opts.flags |= GF_SM_ENCODE_RAP_SHADOW;</span>
<span class="lineNum">    2539 </span><span class="lineCov">          3 :                 smenc_opts.rap_freq = atoi(arg_val);</span>
<span class="lineNum">    2540 </span><span class="lineCov">          3 :                 break;</span>
<span class="lineNum">    2541 </span><span class="lineNoCov">          0 :         case 2: //-carousel</span>
<span class="lineNum">    2542 </span><span class="lineNoCov">          0 :                 smenc_opts.flags &amp;= ~(GF_SM_ENCODE_RAP_INBAND | GF_SM_ENCODE_RAP_SHADOW);</span>
<span class="lineNum">    2543 </span><span class="lineNoCov">          0 :                 smenc_opts.rap_freq = atoi(arg_val);</span>
<span class="lineNum">    2544 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2545 </span>            :         case 3: //-auto-quant
<span class="lineNum">    2546 </span><span class="lineNoCov">          0 :                 smenc_opts.resolution = atoi(arg_val);</span>
<span class="lineNum">    2547 </span><span class="lineNoCov">          0 :                 smenc_opts.auto_quant = 1;</span>
<span class="lineNum">    2548 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2549 </span>            :         case 4: //-global-quant
<span class="lineNum">    2550 </span><span class="lineNoCov">          0 :                 smenc_opts.resolution = atoi(arg_val);</span>
<span class="lineNum">    2551 </span><span class="lineNoCov">          0 :                 smenc_opts.auto_quant = 2;</span>
<span class="lineNum">    2552 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2553 </span><span class="lineCov">          1 :         case 5: //-ctx-in or -inctx</span>
<span class="lineNum">    2554 </span><span class="lineCov">          1 :                 chunk_mode = GF_TRUE;</span>
<span class="lineNum">    2555 </span><span class="lineCov">          1 :                 input_ctx = arg_val;</span>
<span class="lineNum">    2556 </span>            :         }
<a name="2557"><span class="lineNum">    2557 </span><span class="lineCov">          7 :         return 0;</span></a>
<span class="lineNum">    2558 </span>            : }
<span class="lineNum">    2559 </span><span class="lineCov">        222 : u32 parse_cryp(char *arg_val, u32 opt)</span>
<span class="lineNum">    2560 </span>            : {
<span class="lineNum">    2561 </span><span class="lineCov">        222 :         open_edit = GF_TRUE;</span>
<span class="lineNum">    2562 </span><span class="lineCov">        222 :         if (!opt) {</span>
<span class="lineNum">    2563 </span><span class="lineCov">        115 :                 crypt = 1;</span>
<span class="lineNum">    2564 </span><span class="lineCov">        115 :                 drm_file = arg_val;</span>
<span class="lineNum">    2565 </span>            :                 open_edit = GF_TRUE;
<span class="lineNum">    2566 </span><span class="lineCov">        115 :                 return 0;</span>
<span class="lineNum">    2567 </span>            :         }
<span class="lineNum">    2568 </span><span class="lineCov">        107 :         crypt = 2;</span>
<span class="lineNum">    2569 </span><span class="lineCov">        107 :         if (arg_val &amp;&amp; get_file_type_by_ext(arg_val) != 1) {</span>
<span class="lineNum">    2570 </span><span class="lineCov">        100 :                 drm_file = arg_val;</span>
<span class="lineNum">    2571 </span><span class="lineCov">        100 :                 return 0;</span>
<span class="lineNum">    2572 </span>            :         }
<span class="lineNum">    2573 </span>            :         return 3;
<a name="2574"><span class="lineNum">    2574 </span>            : }</a>
<span class="lineNum">    2575 </span>            : 
<span class="lineNum">    2576 </span><span class="lineCov">        155 : u32 parse_dash_profile(char *arg_val, u32 opt)</span>
<span class="lineNum">    2577 </span>            : {
<span class="lineNum">    2578 </span><span class="lineCov">        155 :         if (!stricmp(arg_val, &quot;live&quot;) || !stricmp(arg_val, &quot;simple&quot;)) dash_profile = GF_DASH_PROFILE_LIVE;</span>
<span class="lineNum">    2579 </span><span class="lineCov">         21 :         else if (!stricmp(arg_val, &quot;onDemand&quot;)) dash_profile = GF_DASH_PROFILE_ONDEMAND;</span>
<span class="lineNum">    2580 </span><span class="lineCov">         10 :         else if (!stricmp(arg_val, &quot;hbbtv1.5:live&quot;) || !stricmp(arg_val, &quot;hbbtv1.5.live&quot;))</span>
<span class="lineNum">    2581 </span><span class="lineNoCov">          0 :                 dash_profile = GF_DASH_PROFILE_HBBTV_1_5_ISOBMF_LIVE;</span>
<span class="lineNum">    2582 </span><span class="lineCov">         10 :         else if (!stricmp(arg_val, &quot;dashavc264:live&quot;) || !stricmp(arg_val, &quot;dashavc264.live&quot;))</span>
<span class="lineNum">    2583 </span><span class="lineCov">          3 :                 dash_profile = GF_DASH_PROFILE_AVC264_LIVE;</span>
<span class="lineNum">    2584 </span><span class="lineCov">          7 :         else if (!stricmp(arg_val, &quot;dashavc264:onDemand&quot;) || !stricmp(arg_val, &quot;dashavc264.onDemand&quot;))</span>
<span class="lineNum">    2585 </span><span class="lineCov">          2 :                 dash_profile = GF_DASH_PROFILE_AVC264_ONDEMAND;</span>
<span class="lineNum">    2586 </span><span class="lineCov">          5 :         else if (!stricmp(arg_val, &quot;dashif.ll&quot;)) dash_profile = GF_DASH_PROFILE_DASHIF_LL;</span>
<span class="lineNum">    2587 </span><span class="lineCov">          5 :         else if (!stricmp(arg_val, &quot;main&quot;)) dash_profile = GF_DASH_PROFILE_MAIN;</span>
<span class="lineNum">    2588 </span><span class="lineNoCov">          0 :         else if (!stricmp(arg_val, &quot;full&quot;)) dash_profile = GF_DASH_PROFILE_FULL;</span>
<span class="lineNum">    2589 </span>            :         else {
<span class="lineNum">    2590 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Unrecognized DASH profile \&quot;%s\&quot; - please check usage\n&quot;, arg_val));</span>
<span class="lineNum">    2591 </span>            :                 return 2;
<span class="lineNum">    2592 </span>            :         }
<span class="lineNum">    2593 </span>            :         return 0;
<a name="2594"><span class="lineNum">    2594 </span>            : }</a>
<span class="lineNum">    2595 </span>            : 
<span class="lineNum">    2596 </span><span class="lineNoCov">          0 : u32 parse_fps(char *arg_val, u32 opt)</span>
<span class="lineNum">    2597 </span>            : {
<span class="lineNum">    2598 </span>            :         u32 ticks, dts_inc;
<span class="lineNum">    2599 </span><span class="lineNoCov">          0 :         if (!strcmp(arg_val, &quot;auto&quot;)) {</span>
<span class="lineNum">    2600 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_WARNING, (&quot;Warning, fps=auto option is deprecated\n&quot;));</span>
<span class="lineNum">    2601 </span>            :         }
<span class="lineNum">    2602 </span><span class="lineNoCov">          0 :         else if ((sscanf(arg_val, &quot;%u-%u&quot;, &amp;ticks, &amp;dts_inc)==2) || (sscanf(arg_val, &quot;%u/%u&quot;, &amp;ticks, &amp;dts_inc)==2) ) {</span>
<span class="lineNum">    2603 </span><span class="lineNoCov">          0 :                 if (!dts_inc) dts_inc = 1;</span>
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 :                 import_fps.num = ticks;</span>
<span class="lineNum">    2605 </span><span class="lineNoCov">          0 :                 import_fps.den = dts_inc;</span>
<span class="lineNum">    2606 </span>            :         } else {
<span class="lineNum">    2607 </span><span class="lineNoCov">          0 :                 gf_parse_frac(arg_val, &amp;import_fps);</span>
<span class="lineNum">    2608 </span>            :         }
<span class="lineNum">    2609 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="2610"><span class="lineNum">    2610 </span>            : }</a>
<span class="lineNum">    2611 </span>            : 
<span class="lineNum">    2612 </span><span class="lineCov">          8 : u32 parse_split(char *arg_val, u32 opt)</span>
<span class="lineNum">    2613 </span>            : {
<span class="lineNum">    2614 </span><span class="lineCov">          8 :         switch (opt) {</span>
<span class="lineNum">    2615 </span>            :         case 0://-split
<span class="lineNum">    2616 </span><span class="lineCov">          2 :                 split_duration = atof(arg_val);</span>
<span class="lineNum">    2617 </span><span class="lineCov">          2 :                 if (split_duration &lt; 0) split_duration = 0;</span>
<span class="lineNum">    2618 </span><span class="lineCov">          2 :                 split_size = 0;</span>
<span class="lineNum">    2619 </span><span class="lineCov">          2 :                 break;</span>
<span class="lineNum">    2620 </span><span class="lineNoCov">          0 :         case 1: //-split-rap, -splitr</span>
<span class="lineNum">    2621 </span><span class="lineNoCov">          0 :                 split_duration = -1;</span>
<span class="lineNum">    2622 </span><span class="lineNoCov">          0 :                 split_size = -1;</span>
<span class="lineNum">    2623 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2624 </span>            :         case 2: //-split-size, -splits
<span class="lineNum">    2625 </span><span class="lineCov">          2 :                 split_size = (u32)atoi(arg_val);</span>
<span class="lineNum">    2626 </span><span class="lineCov">          2 :                 split_duration = 0;</span>
<span class="lineNum">    2627 </span><span class="lineCov">          2 :                 break;</span>
<span class="lineNum">    2628 </span><span class="lineCov">          4 :         case 3: //-split-chunk, -splitx</span>
<span class="lineNum">    2629 </span>            :         case 4: //-splitz
<span class="lineNum">    2630 </span>            :         case 5: //-splitg
<span class="lineNum">    2631 </span>            :         case 6: //-splitf
<span class="lineNum">    2632 </span><span class="lineCov">          4 :                 adjust_split_end = opt-3;</span>
<span class="lineNum">    2633 </span><span class="lineCov">          4 :                 if (!strstr(arg_val, &quot;:&quot;) &amp;&amp; !strstr(arg_val, &quot;-&quot;)) {</span>
<span class="lineNum">    2634 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Chunk extraction usage: \&quot;-split* start:end\&quot; expressed in seconds\n&quot;));</span>
<span class="lineNum">    2635 </span>            :                         return 2;
<span class="lineNum">    2636 </span>            :                 }
<span class="lineNum">    2637 </span><span class="lineCov">          4 :                 if (strstr(arg_val, &quot;end&quot;)) {</span>
<span class="lineNum">    2638 </span><span class="lineNoCov">          0 :                         if (strstr(arg_val, &quot;end-&quot;)) {</span>
<span class="lineNum">    2639 </span><span class="lineNoCov">          0 :                                 Double dur_end=0;</span>
<span class="lineNum">    2640 </span><span class="lineNoCov">          0 :                                 sscanf(arg_val, &quot;%lf:end-%lf&quot;, &amp;split_start, &amp;dur_end);</span>
<span class="lineNum">    2641 </span><span class="lineNoCov">          0 :                                 split_duration = -2 - dur_end;</span>
<span class="lineNum">    2642 </span>            :                         } else {
<span class="lineNum">    2643 </span><span class="lineNoCov">          0 :                                 sscanf(arg_val, &quot;%lf:end&quot;, &amp;split_start);</span>
<span class="lineNum">    2644 </span><span class="lineNoCov">          0 :                                 split_duration = -2;</span>
<span class="lineNum">    2645 </span>            :                         }
<span class="lineNum">    2646 </span>            :                 } else {
<span class="lineNum">    2647 </span><span class="lineCov">          4 :                         split_range_str = arg_val;</span>
<span class="lineNum">    2648 </span>            :                 }
<span class="lineNum">    2649 </span><span class="lineCov">          4 :                 split_size = 0;</span>
<span class="lineNum">    2650 </span><span class="lineCov">          4 :                 break;</span>
<span class="lineNum">    2651 </span>            :         }
<span class="lineNum">    2652 </span>            :         return 0;
<a name="2653"><span class="lineNum">    2653 </span>            : }</a>
<span class="lineNum">    2654 </span>            : 
<span class="lineNum">    2655 </span><span class="lineCov">         69 : u32 parse_brand(char *b, u32 opt)</span>
<span class="lineNum">    2656 </span>            : {
<span class="lineNum">    2657 </span><span class="lineCov">         69 :         open_edit = GF_TRUE;</span>
<span class="lineNum">    2658 </span><span class="lineCov">         69 :         switch (opt) {</span>
<span class="lineNum">    2659 </span><span class="lineCov">          2 :         case 0: //-brand</span>
<span class="lineNum">    2660 </span><span class="lineCov">          2 :                 major_brand = GF_4CC(b[0], b[1], b[2], b[3]);</span>
<span class="lineNum">    2661 </span><span class="lineCov">          2 :                 if (b[4] == ':') {</span>
<span class="lineNum">    2662 </span><span class="lineCov">          1 :                         if (!strncmp(b+5, &quot;0x&quot;, 2))</span>
<span class="lineNum">    2663 </span><span class="lineNoCov">          0 :                                 sscanf(b+5, &quot;0x%x&quot;, &amp;minor_version);</span>
<span class="lineNum">    2664 </span>            :                         else
<span class="lineNum">    2665 </span><span class="lineCov">          1 :                                 minor_version = atoi(b + 5);</span>
<span class="lineNum">    2666 </span>            :                 }
<span class="lineNum">    2667 </span>            :                 break;
<span class="lineNum">    2668 </span><span class="lineCov">         65 :         case 1: //-ab</span>
<span class="lineNum">    2669 </span><span class="lineCov">         65 :                 brand_add = (u32*)gf_realloc(brand_add, sizeof(u32) * (nb_alt_brand_add + 1));</span>
<span class="lineNum">    2670 </span><span class="lineCov">         65 :                 if (!brand_add) return 2;</span>
<span class="lineNum">    2671 </span><span class="lineCov">         65 :                 brand_add[nb_alt_brand_add] = GF_4CC(b[0], b[1], b[2], b[3]);</span>
<span class="lineNum">    2672 </span><span class="lineCov">         65 :                 nb_alt_brand_add++;</span>
<span class="lineNum">    2673 </span><span class="lineCov">         65 :                 break;</span>
<span class="lineNum">    2674 </span><span class="lineCov">          2 :         case 2: //-rb</span>
<span class="lineNum">    2675 </span><span class="lineCov">          2 :                 brand_rem = (u32*)gf_realloc(brand_rem, sizeof(u32) * (nb_alt_brand_rem + 1));</span>
<span class="lineNum">    2676 </span><span class="lineCov">          2 :                 if (!brand_rem) return 2;</span>
<span class="lineNum">    2677 </span><span class="lineCov">          2 :                 brand_rem[nb_alt_brand_rem] = GF_4CC(b[0], b[1], b[2], b[3]);</span>
<span class="lineNum">    2678 </span><span class="lineCov">          2 :                 nb_alt_brand_rem++;</span>
<span class="lineNum">    2679 </span><span class="lineCov">          2 :                 break;</span>
<span class="lineNum">    2680 </span>            :         }
<span class="lineNum">    2681 </span>            :         return 0;
<a name="2682"><span class="lineNum">    2682 </span>            : }</a>
<span class="lineNum">    2683 </span>            : 
<span class="lineNum">    2684 </span><span class="lineCov">          1 : u32 parse_mpegu(char *arg_val, u32 opt)</span>
<span class="lineNum">    2685 </span>            : {
<span class="lineNum">    2686 </span><span class="lineCov">          1 :         pack_file = arg_val;</span>
<span class="lineNum">    2687 </span><span class="lineCov">          1 :         pack_wgt = GF_TRUE;</span>
<span class="lineNum">    2688 </span><span class="lineCov">          1 :         return 0;</span>
<a name="2689"><span class="lineNum">    2689 </span>            : }</a>
<span class="lineNum">    2690 </span>            : 
<span class="lineNum">    2691 </span><span class="lineCov">        251 : u32 parse_file_info(char *arg_val, u32 opt)</span>
<span class="lineNum">    2692 </span>            : {
<span class="lineNum">    2693 </span><span class="lineCov">        251 :         print_info = opt ? 2 : 1;</span>
<span class="lineNum">    2694 </span><span class="lineCov">        251 :         if (arg_val) {</span>
<span class="lineNum">    2695 </span><span class="lineCov">        251 :                 if (sscanf(arg_val, &quot;%u&quot;, &amp;info_track_id) == 1) {</span>
<span class="lineNum">    2696 </span>            :                         char szTk[20];
<span class="lineNum">    2697 </span><span class="lineCov">          4 :                         sprintf(szTk, &quot;%u&quot;, info_track_id);</span>
<span class="lineNum">    2698 </span><span class="lineCov">          4 :                         if (strcmp(szTk, arg_val)) info_track_id = 0;</span>
<span class="lineNum">    2699 </span>            :                 }
<span class="lineNum">    2700 </span><span class="lineCov">        251 :                 if (!info_track_id) return 3;</span>
<span class="lineNum">    2701 </span>            :         }
<a name="2702"><span class="lineNum">    2702 </span>            :         return 0;</a>
<span class="lineNum">    2703 </span>            : }
<span class="lineNum">    2704 </span><span class="lineCov">          6 : u32 parse_boxpatch(char *arg_val, u32 opt)</span>
<span class="lineNum">    2705 </span>            : {
<span class="lineNum">    2706 </span><span class="lineCov">          6 :         box_patch_filename = arg_val;</span>
<span class="lineNum">    2707 </span><span class="lineCov">          6 :         char *sep = strchr(box_patch_filename, '=');</span>
<span class="lineNum">    2708 </span><span class="lineCov">          6 :         if (sep) {</span>
<span class="lineNum">    2709 </span><span class="lineNoCov">          0 :                 sep[0] = 0;</span>
<span class="lineNum">    2710 </span><span class="lineNoCov">          0 :                 box_patch_trackID = atoi(box_patch_filename);</span>
<span class="lineNum">    2711 </span><span class="lineNoCov">          0 :                 sep[0] = '=';</span>
<span class="lineNum">    2712 </span><span class="lineNoCov">          0 :                 box_patch_filename = sep+1;</span>
<span class="lineNum">    2713 </span>            :         }
<span class="lineNum">    2714 </span><span class="lineCov">          6 :         open_edit = GF_TRUE;</span>
<a name="2715"><span class="lineNum">    2715 </span><span class="lineCov">          6 :         return 0;</span></a>
<span class="lineNum">    2716 </span>            : }
<span class="lineNum">    2717 </span><span class="lineNoCov">          0 : u32 parse_compress(char *arg_val, u32 opt)</span>
<span class="lineNum">    2718 </span>            : {
<span class="lineNum">    2719 </span><span class="lineNoCov">          0 :         compress_moov = opt ? 2 : 1;</span>
<span class="lineNum">    2720 </span><span class="lineNoCov">          0 :         open_edit = GF_TRUE;</span>
<span class="lineNum">    2721 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    2722 </span>            : }
<a name="2723"><span class="lineNum">    2723 </span>            : </a>
<span class="lineNum">    2724 </span>            : 
<span class="lineNum">    2725 </span><span class="lineCov">          2 : u32 parse_dump_udta(char *code, u32 opt)</span>
<span class="lineNum">    2726 </span>            : {
<span class="lineNum">    2727 </span>            :         char *sep;
<span class="lineNum">    2728 </span><span class="lineCov">          2 :         sep = strchr(code, ':');</span>
<span class="lineNum">    2729 </span><span class="lineCov">          2 :         if (sep) {</span>
<span class="lineNum">    2730 </span><span class="lineCov">          1 :                 sep[0] = 0;</span>
<span class="lineNum">    2731 </span><span class="lineCov">          1 :                 dump_udta_track = atoi(code);</span>
<span class="lineNum">    2732 </span><span class="lineCov">          1 :                 sep[0] = ':';</span>
<span class="lineNum">    2733 </span><span class="lineCov">          1 :                 code = sep + 1;</span>
<span class="lineNum">    2734 </span>            :         }
<span class="lineNum">    2735 </span>            : 
<span class="lineNum">    2736 </span><span class="lineCov">          2 :         if (strlen(code) == 4) {</span>
<span class="lineNum">    2737 </span><span class="lineCov">          2 :                 dump_udta_type = GF_4CC(code[0], code[1], code[2], code[3]);</span>
<span class="lineNum">    2738 </span><span class="lineNoCov">          0 :         } else if (strlen(code) == 8) {</span>
<span class="lineNum">    2739 </span>            :                 // hex representation on 8 chars
<span class="lineNum">    2740 </span>            :                 u32 hex1, hex2, hex3, hex4;
<span class="lineNum">    2741 </span><span class="lineNoCov">          0 :                 if (sscanf(code, &quot;%02x%02x%02x%02x&quot;, &amp;hex1, &amp;hex2, &amp;hex3, &amp;hex4) != 4) {</span>
<span class="lineNum">    2742 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;udta code is either a 4CC or 8 hex chars for non-printable 4CC\n&quot;));</span>
<span class="lineNum">    2743 </span><span class="lineNoCov">          0 :                         return 2;</span>
<span class="lineNum">    2744 </span>            :                 }
<span class="lineNum">    2745 </span><span class="lineNoCov">          0 :                 dump_udta_type = GF_4CC(hex1, hex2, hex3, hex4);</span>
<span class="lineNum">    2746 </span>            :         } else {
<span class="lineNum">    2747 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;udta code is either a 4CC or 8 hex chars for non-printable 4CC\n&quot;));</span>
<span class="lineNum">    2748 </span>            :                 return 2;
<span class="lineNum">    2749 </span>            :         }
<span class="lineNum">    2750 </span>            :         return 0;
<a name="2751"><span class="lineNum">    2751 </span>            : }</a>
<span class="lineNum">    2752 </span>            : 
<span class="lineNum">    2753 </span><span class="lineCov">         63 : u32 parse_dump_ts(char *arg_val, u32 opt)</span>
<span class="lineNum">    2754 </span>            : {
<span class="lineNum">    2755 </span><span class="lineCov">         63 :         dump_timestamps = 1;</span>
<span class="lineNum">    2756 </span><span class="lineCov">         63 :         if (arg_val) {</span>
<span class="lineNum">    2757 </span><span class="lineNoCov">          0 :                 if (isdigit(arg_val[0])) {</span>
<span class="lineNum">    2758 </span><span class="lineNoCov">          0 :                         program_number = atoi(arg_val);</span>
<span class="lineNum">    2759 </span>            :                 } else {
<span class="lineNum">    2760 </span>            :                         return 3;
<span class="lineNum">    2761 </span>            :                 }
<span class="lineNum">    2762 </span>            :         }
<span class="lineNum">    2763 </span>            :         return 0;
<a name="2764"><span class="lineNum">    2764 </span>            : }</a>
<span class="lineNum">    2765 </span>            : 
<span class="lineNum">    2766 </span><span class="lineCov">          8 : u32 parse_ttxt(char *arg_val, u32 opt)</span>
<span class="lineNum">    2767 </span>            : {
<span class="lineNum">    2768 </span><span class="lineCov">          8 :         if (opt) //-srt</span>
<span class="lineNum">    2769 </span><span class="lineCov">          4 :                 dump_srt = GF_TRUE;</span>
<span class="lineNum">    2770 </span>            :         else
<span class="lineNum">    2771 </span><span class="lineCov">          4 :                 dump_ttxt = GF_TRUE;</span>
<span class="lineNum">    2772 </span>            : 
<span class="lineNum">    2773 </span><span class="lineCov">          8 :         import_subtitle = 1;</span>
<span class="lineNum">    2774 </span><span class="lineCov">          8 :         trackID = 0;</span>
<span class="lineNum">    2775 </span>            : 
<span class="lineNum">    2776 </span><span class="lineCov">          8 :         if (arg_val &amp;&amp; (!strcmp(arg_val, &quot;*&quot;) || !strcmp(arg_val, &quot;@&quot;) || !strcmp(arg_val, &quot;all&quot;)) ) {</span>
<span class="lineNum">    2777 </span><span class="lineNoCov">          0 :                 trackID = (u32)-1;</span>
<span class="lineNum">    2778 </span><span class="lineCov">          8 :         } else if (arg_val) {</span>
<span class="lineNum">    2779 </span><span class="lineCov">          8 :                 if (sscanf(arg_val, &quot;%u&quot;, &amp;trackID) == 1) {</span>
<span class="lineNum">    2780 </span>            :                         char szTk[20];
<span class="lineNum">    2781 </span><span class="lineCov">          4 :                         sprintf(szTk, &quot;%d&quot;, trackID);</span>
<span class="lineNum">    2782 </span><span class="lineCov">          4 :                         if (strcmp(szTk, arg_val))</span>
<span class="lineNum">    2783 </span><span class="lineNoCov">          0 :                                 trackID = 0;</span>
<span class="lineNum">    2784 </span>            :                 }
<span class="lineNum">    2785 </span><span class="lineCov">          8 :                 if (!trackID) return 3;</span>
<span class="lineNum">    2786 </span>            :         }
<span class="lineNum">    2787 </span>            :         return 0;
<a name="2788"><span class="lineNum">    2788 </span>            : }</a>
<span class="lineNum">    2789 </span>            : 
<span class="lineNum">    2790 </span><span class="lineCov">          8 : u32 parse_dashlive(char *arg, char *arg_val, u32 opt)</span>
<span class="lineNum">    2791 </span>            : {
<span class="lineNum">    2792 </span><span class="lineCov">          8 :         dash_mode = opt ? GF_DASH_DYNAMIC_DEBUG : GF_DASH_DYNAMIC;</span>
<span class="lineNum">    2793 </span><span class="lineCov">          8 :         dash_live = 1;</span>
<span class="lineNum">    2794 </span><span class="lineCov">          8 :         if (arg[10] == '=') {</span>
<span class="lineNum">    2795 </span><span class="lineNoCov">          0 :                 dash_ctx_file = arg + 11;</span>
<span class="lineNum">    2796 </span>            :         }
<span class="lineNum">    2797 </span><span class="lineCov">          8 :         dash_duration = atof(arg_val);</span>
<span class="lineNum">    2798 </span><span class="lineCov">          8 :         return 0;</span>
<a name="2799"><span class="lineNum">    2799 </span>            : }</a>
<span class="lineNum">    2800 </span>            : 
<span class="lineNum">    2801 </span><span class="lineCov">         19 : u32 parse_help(char *arg_val, u32 opt)</span>
<span class="lineNum">    2802 </span>            : {
<span class="lineNum">    2803 </span><span class="lineCov">         19 :         if (!arg_val) PrintUsage();</span>
<span class="lineNum">    2804 </span><span class="lineCov">         16 :         else if (opt) PrintHelp(arg_val, GF_TRUE, GF_FALSE);</span>
<span class="lineNum">    2805 </span><span class="lineCov">         15 :         else if (!strcmp(arg_val, &quot;general&quot;)) PrintGeneralUsage();</span>
<span class="lineNum">    2806 </span><span class="lineCov">         14 :         else if (!strcmp(arg_val, &quot;extract&quot;)) PrintExtractUsage();</span>
<span class="lineNum">    2807 </span><span class="lineCov">         13 :         else if (!strcmp(arg_val, &quot;split&quot;)) PrintSplitUsage();</span>
<span class="lineNum">    2808 </span><span class="lineCov">         13 :         else if (!strcmp(arg_val, &quot;dash&quot;)) PrintDASHUsage();</span>
<span class="lineNum">    2809 </span><span class="lineCov">         12 :         else if (!strcmp(arg_val, &quot;dump&quot;)) PrintDumpUsage();</span>
<span class="lineNum">    2810 </span><span class="lineCov">         11 :         else if (!strcmp(arg_val, &quot;import&quot;)) PrintImportUsage();</span>
<span class="lineNum">    2811 </span><span class="lineCov">         10 :         else if (!strcmp(arg_val, &quot;format&quot;)) {</span>
<span class="lineNum">    2812 </span><span class="lineCov">          1 :                 M4_LOG(GF_LOG_WARNING, (&quot;deprecated, see [filters documentation](Filters)\n&quot;));</span>
<span class="lineNum">    2813 </span>            :         }
<span class="lineNum">    2814 </span><span class="lineCov">          9 :         else if (!strcmp(arg_val, &quot;hint&quot;)) PrintHintUsage();</span>
<span class="lineNum">    2815 </span><span class="lineCov">          8 :         else if (!strcmp(arg_val, &quot;encode&quot;)) PrintEncodeUsage();</span>
<span class="lineNum">    2816 </span><span class="lineCov">          7 :         else if (!strcmp(arg_val, &quot;crypt&quot;)) PrintEncryptUsage();</span>
<span class="lineNum">    2817 </span><span class="lineCov">          6 :         else if (!strcmp(arg_val, &quot;meta&quot;)) PrintMetaUsage();</span>
<span class="lineNum">    2818 </span><span class="lineCov">          5 :         else if (!strcmp(arg_val, &quot;swf&quot;)) PrintSWFUsage();</span>
<span class="lineNum">    2819 </span>            : #if !defined(GPAC_DISABLE_STREAMING) &amp;&amp; !defined(GPAC_DISABLE_SENG)
<span class="lineNum">    2820 </span><span class="lineCov">          4 :         else if (!strcmp(arg_val, &quot;rtp&quot;)) {</span>
<span class="lineNum">    2821 </span><span class="lineCov">          1 :                 M4_LOG(GF_LOG_WARNING, (&quot;RTP streaming deprecated in MP4Box, use gpac application\n&quot;));</span>
<span class="lineNum">    2822 </span>            :         }
<span class="lineNum">    2823 </span><span class="lineCov">          3 :         else if (!strcmp(arg_val, &quot;live&quot;)) PrintLiveUsage();</span>
<span class="lineNum">    2824 </span>            : #endif
<span class="lineNum">    2825 </span><span class="lineCov">          2 :         else if (!strcmp(arg_val, &quot;core&quot;)) PrintCoreUsage();</span>
<span class="lineNum">    2826 </span><span class="lineCov">          2 :         else if (!strcmp(arg_val, &quot;tags&quot;)) PrintTags();</span>
<span class="lineNum">    2827 </span><span class="lineCov">          2 :         else if (!strcmp(arg_val, &quot;cicp&quot;)) PrintCICP();</span>
<span class="lineNum">    2828 </span><span class="lineCov">          1 :         else if (!strcmp(arg_val, &quot;all&quot;)) {</span>
<span class="lineNum">    2829 </span><span class="lineCov">          1 :                 PrintGeneralUsage();</span>
<span class="lineNum">    2830 </span><span class="lineCov">          1 :                 PrintExtractUsage();</span>
<span class="lineNum">    2831 </span><span class="lineCov">          1 :                 PrintDASHUsage();</span>
<span class="lineNum">    2832 </span><span class="lineCov">          1 :                 PrintSplitUsage();</span>
<span class="lineNum">    2833 </span><span class="lineCov">          1 :                 PrintDumpUsage();</span>
<span class="lineNum">    2834 </span><span class="lineCov">          1 :                 PrintImportUsage();</span>
<span class="lineNum">    2835 </span><span class="lineCov">          1 :                 PrintHintUsage();</span>
<span class="lineNum">    2836 </span><span class="lineCov">          1 :                 PrintEncodeUsage();</span>
<span class="lineNum">    2837 </span><span class="lineCov">          1 :                 PrintEncryptUsage();</span>
<span class="lineNum">    2838 </span><span class="lineCov">          1 :                 PrintMetaUsage();</span>
<span class="lineNum">    2839 </span><span class="lineCov">          1 :                 PrintSWFUsage();</span>
<span class="lineNum">    2840 </span>            : #if !defined(GPAC_DISABLE_STREAMING) &amp;&amp; !defined(GPAC_DISABLE_SENG)
<span class="lineNum">    2841 </span><span class="lineCov">          1 :                 PrintLiveUsage();</span>
<span class="lineNum">    2842 </span>            : #endif
<span class="lineNum">    2843 </span><span class="lineCov">          1 :                 PrintCoreUsage();</span>
<span class="lineNum">    2844 </span><span class="lineCov">          1 :                 PrintTags();</span>
<span class="lineNum">    2845 </span><span class="lineCov">          1 :                 PrintCICP();</span>
<span class="lineNum">    2846 </span><span class="lineNoCov">          0 :         } else if (!strcmp(arg_val, &quot;opts&quot;)) {</span>
<span class="lineNum">    2847 </span><span class="lineNoCov">          0 :                 PrintHelp(&quot;@&quot;, GF_FALSE, GF_FALSE);</span>
<span class="lineNum">    2848 </span>            :         } else {
<span class="lineNum">    2849 </span><span class="lineNoCov">          0 :                 PrintHelp(arg_val, GF_FALSE, GF_FALSE);</span>
<span class="lineNum">    2850 </span>            :         }
<span class="lineNum">    2851 </span><span class="lineCov">         19 :         return 1;</span>
<a name="2852"><span class="lineNum">    2852 </span>            : }</a>
<span class="lineNum">    2853 </span>            : 
<span class="lineNum">    2854 </span><span class="lineCov">          2 : u32 parse_gendoc(char *name, u32 opt)</span>
<span class="lineNum">    2855 </span>            : {
<span class="lineNum">    2856 </span>            :         u32 i=0;
<span class="lineNum">    2857 </span>            :         //gen MD
<span class="lineNum">    2858 </span><span class="lineCov">          2 :         if (!opt) {</span>
<span class="lineNum">    2859 </span><span class="lineCov">          1 :                 help_flags = GF_PRINTARG_MD | GF_PRINTARG_IS_APP;</span>
<span class="lineNum">    2860 </span><span class="lineCov">          1 :                 helpout = gf_fopen(&quot;mp4box-gen-opts.md&quot;, &quot;w&quot;);</span>
<span class="lineNum">    2861 </span>            : 
<span class="lineNum">    2862 </span>            :                 fprintf(helpout, &quot;[**HOME**](Home) » [**MP4Box**](MP4Box) » General&quot;);
<span class="lineNum">    2863 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;&lt;!-- automatically generated - do not edit, patch gpac/applications/mp4box/main.c --&gt;\n&quot;);</span>
<span class="lineNum">    2864 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;# Syntax\n&quot;);</span>
<span class="lineNum">    2865 </span><span class="lineCov">          1 :                 gf_sys_format_help(helpout, help_flags, &quot;MP4Box [option] input [option] [other_dash_inputs]\n&quot;</span>
<span class="lineNum">    2866 </span>            :                         &quot;  \n&quot;
<span class="lineNum">    2867 </span>            :                 );
<span class="lineNum">    2868 </span><span class="lineCov">          1 :                 PrintGeneralUsage();</span>
<span class="lineNum">    2869 </span><span class="lineCov">          1 :                 PrintEncryptUsage();</span>
<span class="lineNum">    2870 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;# Help Options\n&quot;);</span>
<span class="lineNum">    2871 </span><span class="lineCov">         20 :                 while (m4b_usage_args[i].name) {</span>
<span class="lineNum">    2872 </span><span class="lineCov">         19 :                         GF_GPACArg *g_arg = (GF_GPACArg *) &amp;m4b_usage_args[i];</span>
<span class="lineNum">    2873 </span><span class="lineCov">         19 :                         i++;</span>
<span class="lineNum">    2874 </span><span class="lineCov">         19 :                         gf_sys_print_arg(helpout, help_flags, g_arg, &quot;mp4box-general&quot;);</span>
<span class="lineNum">    2875 </span>            :                 }
<span class="lineNum">    2876 </span>            : 
<span class="lineNum">    2877 </span><span class="lineCov">          1 :                 gf_fclose(helpout);</span>
<span class="lineNum">    2878 </span>            : 
<span class="lineNum">    2879 </span><span class="lineCov">          1 :                 helpout = gf_fopen(&quot;mp4box-import-opts.md&quot;, &quot;w&quot;);</span>
<span class="lineNum">    2880 </span>            :                 fprintf(helpout, &quot;[**HOME**](Home) » [**MP4Box**](MP4Box) » Media Import&quot;);
<span class="lineNum">    2881 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;&lt;!-- automatically generated - do not edit, patch gpac/applications/mp4box/main.c --&gt;\n&quot;);</span>
<span class="lineNum">    2882 </span><span class="lineCov">          1 :                 PrintImportUsage();</span>
<span class="lineNum">    2883 </span><span class="lineCov">          1 :                 gf_fclose(helpout);</span>
<span class="lineNum">    2884 </span>            : 
<span class="lineNum">    2885 </span><span class="lineCov">          1 :                 helpout = gf_fopen(&quot;mp4box-dash-opts.md&quot;, &quot;w&quot;);</span>
<span class="lineNum">    2886 </span>            :                 fprintf(helpout, &quot;[**HOME**](Home) » [**MP4Box**](MP4Box) » Media DASH&quot;);
<span class="lineNum">    2887 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;&lt;!-- automatically generated - do not edit, patch gpac/applications/mp4box/main.c --&gt;\n&quot;);</span>
<span class="lineNum">    2888 </span><span class="lineCov">          1 :                 PrintDASHUsage();</span>
<span class="lineNum">    2889 </span><span class="lineCov">          1 :                 gf_fclose(helpout);</span>
<span class="lineNum">    2890 </span>            : 
<span class="lineNum">    2891 </span><span class="lineCov">          1 :                 helpout = gf_fopen(&quot;mp4box-dump-opts.md&quot;, &quot;w&quot;);</span>
<span class="lineNum">    2892 </span>            :                 fprintf(helpout, &quot;[**HOME**](Home) » [**MP4Box**](MP4Box) » Media Dump and Export&quot;);
<span class="lineNum">    2893 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;&lt;!-- automatically generated - do not edit, patch gpac/applications/mp4box/main.c --&gt;\n&quot;);</span>
<span class="lineNum">    2894 </span><span class="lineCov">          1 :                 PrintExtractUsage();</span>
<span class="lineNum">    2895 </span><span class="lineCov">          1 :                 PrintDumpUsage();</span>
<span class="lineNum">    2896 </span><span class="lineCov">          1 :                 PrintSplitUsage();</span>
<span class="lineNum">    2897 </span><span class="lineCov">          1 :                 gf_fclose(helpout);</span>
<span class="lineNum">    2898 </span>            : 
<span class="lineNum">    2899 </span><span class="lineCov">          1 :                 helpout = gf_fopen(&quot;mp4box-meta-opts.md&quot;, &quot;w&quot;);</span>
<span class="lineNum">    2900 </span>            :                 fprintf(helpout, &quot;[**HOME**](Home) » [**MP4Box**](MP4Box) » Meta and HEIF/IFF&quot;);
<span class="lineNum">    2901 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;&lt;!-- automatically generated - do not edit, patch gpac/applications/mp4box/main.c --&gt;\n&quot;);</span>
<span class="lineNum">    2902 </span><span class="lineCov">          1 :                 PrintMetaUsage();</span>
<span class="lineNum">    2903 </span><span class="lineCov">          1 :                 gf_fclose(helpout);</span>
<span class="lineNum">    2904 </span>            : 
<span class="lineNum">    2905 </span>            : 
<span class="lineNum">    2906 </span><span class="lineCov">          1 :                 helpout = gf_fopen(&quot;mp4box-scene-opts.md&quot;, &quot;w&quot;);</span>
<span class="lineNum">    2907 </span>            :                 fprintf(helpout, &quot;[**HOME**](Home) » [**MP4Box**](MP4Box) » Scene Description&quot;);
<span class="lineNum">    2908 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;&lt;!-- automatically generated - do not edit, patch gpac/applications/mp4box/main.c --&gt;\n&quot;);</span>
<span class="lineNum">    2909 </span><span class="lineCov">          1 :                 PrintEncodeUsage();</span>
<span class="lineNum">    2910 </span>            : #if !defined(GPAC_DISABLE_STREAMING) &amp;&amp; !defined(GPAC_DISABLE_SENG)
<span class="lineNum">    2911 </span><span class="lineCov">          1 :                 PrintLiveUsage();</span>
<span class="lineNum">    2912 </span>            : #endif
<span class="lineNum">    2913 </span><span class="lineCov">          1 :                 PrintSWFUsage();</span>
<span class="lineNum">    2914 </span><span class="lineCov">          1 :                 gf_fclose(helpout);</span>
<span class="lineNum">    2915 </span>            : 
<span class="lineNum">    2916 </span><span class="lineCov">          1 :                 helpout = gf_fopen(&quot;mp4box-other-opts.md&quot;, &quot;w&quot;);</span>
<span class="lineNum">    2917 </span>            :                 fprintf(helpout, &quot;[**HOME**](Home) » [**MP4Box**](MP4Box) » Other Features&quot;);
<span class="lineNum">    2918 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;&lt;!-- automatically generated - do not edit, patch gpac/applications/mp4box/main.c --&gt;\n&quot;);</span>
<span class="lineNum">    2919 </span><span class="lineCov">          1 :                 PrintHintUsage();</span>
<span class="lineNum">    2920 </span><span class="lineCov">          1 :                 PrintTags();</span>
<span class="lineNum">    2921 </span><span class="lineCov">          1 :                 gf_fclose(helpout);</span>
<span class="lineNum">    2922 </span>            :         }
<span class="lineNum">    2923 </span>            :         //gen man
<span class="lineNum">    2924 </span>            :         else {
<span class="lineNum">    2925 </span><span class="lineCov">          1 :                 help_flags = GF_PRINTARG_MAN;</span>
<span class="lineNum">    2926 </span><span class="lineCov">          1 :                 helpout = gf_fopen(&quot;mp4box.1&quot;, &quot;w&quot;);</span>
<span class="lineNum">    2927 </span>            : 
<span class="lineNum">    2928 </span>            : 
<span class="lineNum">    2929 </span>            :                 fprintf(helpout, &quot;.TH MP4Box 1 2019 MP4Box GPAC\n&quot;);
<span class="lineNum">    2930 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;.\n.SH NAME\n.LP\nMP4Box \\- GPAC command-line media packager\n.SH SYNOPSIS\n.LP\n.B MP4Box\n.RI [options] \\ [file] \\ [options]\n.br\n.\n&quot;);</span>
<span class="lineNum">    2931 </span>            : 
<span class="lineNum">    2932 </span><span class="lineCov">          1 :                 PrintGeneralUsage();</span>
<span class="lineNum">    2933 </span><span class="lineCov">          1 :                 PrintExtractUsage();</span>
<span class="lineNum">    2934 </span><span class="lineCov">          1 :                 PrintDASHUsage();</span>
<span class="lineNum">    2935 </span><span class="lineCov">          1 :                 PrintSplitUsage();</span>
<span class="lineNum">    2936 </span><span class="lineCov">          1 :                 PrintDumpUsage();</span>
<span class="lineNum">    2937 </span><span class="lineCov">          1 :                 PrintImportUsage();</span>
<span class="lineNum">    2938 </span><span class="lineCov">          1 :                 PrintHintUsage();</span>
<span class="lineNum">    2939 </span><span class="lineCov">          1 :                 PrintEncodeUsage();</span>
<span class="lineNum">    2940 </span><span class="lineCov">          1 :                 PrintEncryptUsage();</span>
<span class="lineNum">    2941 </span><span class="lineCov">          1 :                 PrintMetaUsage();</span>
<span class="lineNum">    2942 </span><span class="lineCov">          1 :                 PrintSWFUsage();</span>
<span class="lineNum">    2943 </span><span class="lineCov">          1 :                 PrintTags();</span>
<span class="lineNum">    2944 </span>            : #if !defined(GPAC_DISABLE_STREAMING) &amp;&amp; !defined(GPAC_DISABLE_SENG)
<span class="lineNum">    2945 </span><span class="lineCov">          1 :                 PrintLiveUsage();</span>
<span class="lineNum">    2946 </span>            : #endif
<span class="lineNum">    2947 </span>            : 
<span class="lineNum">    2948 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;.SH EXAMPLES\n.TP\nBasic and advanced examples are available at https://wiki.gpac.io/MP4Box\n&quot;);</span>
<span class="lineNum">    2949 </span><span class="lineCov">          1 :                 fprintf(helpout, &quot;.SH MORE\n.LP\nAuthors: GPAC developers, see git repo history (-log)\n&quot;</span>
<span class="lineNum">    2950 </span>            :                 &quot;.br\nFor bug reports, feature requests, more information and source code, visit https://github.com/gpac/gpac\n&quot;
<span class="lineNum">    2951 </span>            :                 &quot;.br\nbuild: %s\n&quot;
<span class="lineNum">    2952 </span>            :                 &quot;.br\nCopyright: %s\n.br\n&quot;
<span class="lineNum">    2953 </span>            :                 &quot;.SH SEE ALSO\n&quot;
<span class="lineNum">    2954 </span>            :                 &quot;.LP\ngpac(1), MP4Client(1)\n&quot;, gf_gpac_version(), gf_gpac_copyright());
<span class="lineNum">    2955 </span>            : 
<span class="lineNum">    2956 </span><span class="lineCov">          1 :                 gf_fclose(helpout);</span>
<span class="lineNum">    2957 </span>            :         }
<span class="lineNum">    2958 </span><span class="lineCov">          2 :         return 1;</span>
<span class="lineNum">    2959 </span>            : }
<a name="2960"><span class="lineNum">    2960 </span>            : </a>
<span class="lineNum">    2961 </span>            : static Bool arg_parse_res = 0;
<span class="lineNum">    2962 </span><span class="lineCov">     242165 : u32 mp4box_parse_single_arg_class(int argc, char **argv, char *arg, u32 *arg_index, MP4BoxArg *arg_class)</span>
<span class="lineNum">    2963 </span>            : {
<span class="lineNum">    2964 </span>            :         MP4BoxArg *arg_desc = NULL;
<span class="lineNum">    2965 </span>            :         char *arg_val = NULL;
<span class="lineNum">    2966 </span>            :         u32 i=0;
<span class="lineNum">    2967 </span><span class="lineCov">    6063339 :         while (arg_class[i].name) {</span>
<span class="lineNum">    2968 </span>            :                 arg_desc = (MP4BoxArg *) &amp;arg_class[i];
<span class="lineNum">    2969 </span><span class="lineCov">    5592468 :                 i++;</span>
<span class="lineNum">    2970 </span>            : 
<span class="lineNum">    2971 </span>            : #ifdef TEST_ARGS
<span class="lineNum">    2972 </span>            :                 char *sep = strchr(arg_desc-&gt;name, ' ');
<span class="lineNum">    2973 </span>            :                 if (sep) {
<span class="lineNum">    2974 </span>            :                         M4_LOG(GF_LOG_ERROR, (&quot;Invalid arg %s, space not allowed\n&quot;, arg_desc-&gt;name));
<span class="lineNum">    2975 </span>            :                         exit(1);
<span class="lineNum">    2976 </span>            :                 }
<span class="lineNum">    2977 </span>            : #endif
<span class="lineNum">    2978 </span><span class="lineCov">    5592468 :                 if (!strcmp(arg_desc-&gt;name, arg+1))</span>
<span class="lineNum">    2979 </span>            :                         break;
<span class="lineNum">    2980 </span><span class="lineCov">    5579015 :                 if (arg_desc-&gt;altname &amp;&amp; !strcmp(arg_desc-&gt;altname, arg+1))</span>
<span class="lineNum">    2981 </span>            :                         break;
<span class="lineNum">    2982 </span>            : 
<span class="lineNum">    2983 </span><span class="lineCov">    5579009 :                 if (arg_desc-&gt;parse_flags &amp; ARG_IS_FUN2) {</span>
<span class="lineNum">    2984 </span><span class="lineCov">      41490 :                         if (!strncmp(arg_desc-&gt;name, arg+1, strlen(arg_desc-&gt;name) ))</span>
<span class="lineNum">    2985 </span>            :                                 break;
<span class="lineNum">    2986 </span>            :                 }
<span class="lineNum">    2987 </span>            :                 arg_desc = NULL;
<span class="lineNum">    2988 </span>            :         }
<span class="lineNum">    2989 </span><span class="lineCov">     242165 :         if (!arg_desc)</span>
<span class="lineNum">    2990 </span>            :                 return GF_FALSE;
<span class="lineNum">    2991 </span>            : 
<span class="lineNum">    2992 </span><span class="lineCov">      13459 :         if (arg_desc-&gt;parse_flags &amp; ARG_OPEN_EDIT) open_edit = GF_TRUE;</span>
<span class="lineNum">    2993 </span><span class="lineCov">      13459 :         if (arg_desc-&gt;parse_flags &amp; ARG_NEED_SAVE) do_save = GF_TRUE;</span>
<span class="lineNum">    2994 </span><span class="lineCov">      13459 :         if (arg_desc-&gt;parse_flags &amp; ARG_NO_INPLACE) no_inplace = GF_TRUE;</span>
<span class="lineNum">    2995 </span>            : 
<span class="lineNum">    2996 </span><span class="lineCov">      13459 :         if (arg_desc-&gt;type != GF_ARG_BOOL) {</span>
<span class="lineNum">    2997 </span>            :                 Bool has_next = GF_TRUE;
<span class="lineNum">    2998 </span><span class="lineCov">       2638 :                 if (*arg_index + 1 == (u32) argc)</span>
<span class="lineNum">    2999 </span>            :                         has_next = GF_FALSE;
<span class="lineNum">    3000 </span><span class="lineCov">       2635 :                 else if (argv[*arg_index + 1][0] == '-') {</span>
<span class="lineNum">    3001 </span>            :                         s32 v;
<span class="lineNum">    3002 </span><span class="lineCov">         10 :                         if (sscanf(argv[*arg_index + 1], &quot;%d&quot;, &amp;v)!=1)</span>
<span class="lineNum">    3003 </span>            :                                 has_next = GF_FALSE;
<span class="lineNum">    3004 </span>            :                 }
<span class="lineNum">    3005 </span><span class="lineCov">          6 :                 if (!has_next &amp;&amp; ! (arg_desc-&gt;parse_flags &amp; ARG_EMPTY) ) {</span>
<span class="lineNum">    3006 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Missing argument value for %s - please check usage\n&quot;, arg));</span>
<span class="lineNum">    3007 </span><span class="lineNoCov">          0 :                         arg_parse_res = 2;</span>
<span class="lineNum">    3008 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">    3009 </span>            :                 }
<span class="lineNum">    3010 </span>            : 
<span class="lineNum">    3011 </span><span class="lineCov">       2638 :                 if (has_next &amp;&amp; (arg_desc-&gt;parse_flags &amp; ARG_EMPTY) &amp;&amp; (arg_desc-&gt;type==GF_ARG_INT)) {</span>
<span class="lineNum">    3012 </span>            :                         s32 ival;
<span class="lineNum">    3013 </span><span class="lineCov">         17 :                         if (sscanf(argv[*arg_index + 1], &quot;%d&quot;, &amp;ival) != 1) {</span>
<span class="lineNum">    3014 </span>            :                                 has_next = GF_FALSE;
<span class="lineNum">    3015 </span>            :                                 arg_val = NULL;
<span class="lineNum">    3016 </span>            :                         }
<span class="lineNum">    3017 </span>            :                 }
<span class="lineNum">    3018 </span><span class="lineCov">       2623 :                 if (has_next) {</span>
<span class="lineNum">    3019 </span><span class="lineCov">       2617 :                         has_next_arg = GF_TRUE;</span>
<span class="lineNum">    3020 </span><span class="lineCov">       2617 :                         *arg_index += 1;</span>
<span class="lineNum">    3021 </span><span class="lineCov">       2617 :                         arg_val = argv[*arg_index];</span>
<span class="lineNum">    3022 </span>            :                 }
<span class="lineNum">    3023 </span>            :         }
<span class="lineNum">    3024 </span><span class="lineCov">      13459 :         if (!arg_desc-&gt;arg_ptr) return GF_TRUE;</span>
<span class="lineNum">    3025 </span>            : 
<span class="lineNum">    3026 </span><span class="lineCov">       8977 :         if (arg_desc-&gt;parse_flags &amp; (ARG_IS_FUN|ARG_IS_FUN2) ) {</span>
<span class="lineNum">    3027 </span>            :                 u32 res;
<span class="lineNum">    3028 </span><span class="lineCov">       1186 :                 if (arg_desc-&gt;parse_flags &amp; ARG_PUSH_SYSARGS)</span>
<span class="lineNum">    3029 </span><span class="lineCov">         19 :                         gf_sys_set_args(argc, (const char**) argv);</span>
<span class="lineNum">    3030 </span>            : 
<span class="lineNum">    3031 </span><span class="lineCov">       1186 :                 if (arg_desc-&gt;parse_flags &amp; ARG_IS_FUN) {</span>
<span class="lineNum">    3032 </span><span class="lineCov">       1178 :                         parse_arg_fun fun = (parse_arg_fun) arg_desc-&gt;arg_ptr;</span>
<span class="lineNum">    3033 </span><span class="lineCov">       1178 :                         res = fun(arg_val, arg_desc-&gt;argv_val);</span>
<span class="lineNum">    3034 </span>            :                 } else {
<span class="lineNum">    3035 </span><span class="lineCov">          8 :                         parse_arg_fun2 fun2 = (parse_arg_fun2) arg_desc-&gt;arg_ptr;</span>
<span class="lineNum">    3036 </span><span class="lineCov">          8 :                         res = fun2(arg, arg_val, arg_desc-&gt;argv_val);</span>
<span class="lineNum">    3037 </span>            :                 }
<span class="lineNum">    3038 </span>            :                 //rewind, not our arg
<span class="lineNum">    3039 </span><span class="lineCov">       1186 :                 if ((res==3) &amp;&amp; argv) {</span>
<span class="lineNum">    3040 </span><span class="lineCov">        258 :                         *arg_index -= 1;</span>
<span class="lineNum">    3041 </span>            :                         res = 0;
<span class="lineNum">    3042 </span>            :                 }
<span class="lineNum">    3043 </span><span class="lineCov">       1186 :                 arg_parse_res = res;</span>
<span class="lineNum">    3044 </span><span class="lineCov">       1186 :                 return GF_TRUE;</span>
<span class="lineNum">    3045 </span>            :         }
<span class="lineNum">    3046 </span>            : 
<span class="lineNum">    3047 </span><span class="lineCov">       7791 :         if (arg_desc-&gt;parse_flags &amp; ARG_INT_INC) {</span>
<span class="lineNum">    3048 </span><span class="lineCov">        502 :                 * (u32 *) arg_desc-&gt;arg_ptr += 1;</span>
<span class="lineNum">    3049 </span><span class="lineCov">        502 :                 return GF_TRUE;</span>
<span class="lineNum">    3050 </span>            :         }
<span class="lineNum">    3051 </span>            : 
<span class="lineNum">    3052 </span><span class="lineCov">       7289 :         if (arg_desc-&gt;type == GF_ARG_BOOL) {</span>
<span class="lineNum">    3053 </span><span class="lineCov">       6266 :                 if (!arg_desc-&gt;parse_flags) {</span>
<span class="lineNum">    3054 </span><span class="lineCov">       6101 :                         if (arg_desc-&gt;argv_val) {</span>
<span class="lineNum">    3055 </span><span class="lineCov">       2852 :                                 * (u32 *) arg_desc-&gt;arg_ptr = arg_desc-&gt;argv_val;</span>
<span class="lineNum">    3056 </span>            :                         } else {
<span class="lineNum">    3057 </span><span class="lineCov">       3249 :                                 * (Bool *) arg_desc-&gt;arg_ptr = GF_TRUE;</span>
<span class="lineNum">    3058 </span>            :                         }
<span class="lineNum">    3059 </span><span class="lineCov">        165 :                 } else if (arg_desc-&gt;parse_flags &amp; ARG_BOOL_REV) {</span>
<span class="lineNum">    3060 </span><span class="lineNoCov">          0 :                         * (Bool *) arg_desc-&gt;arg_ptr = GF_FALSE;</span>
<span class="lineNum">    3061 </span><span class="lineCov">        165 :                 } else if (arg_desc-&gt;parse_flags &amp; ARG_HAS_VALUE) {</span>
<span class="lineNum">    3062 </span><span class="lineCov">          7 :                         * (u32 *) arg_desc-&gt;arg_ptr = 0;</span>
<span class="lineNum">    3063 </span><span class="lineCov">        158 :                 } else if (arg_desc-&gt;parse_flags &amp; ARG_BIT_MASK) {</span>
<span class="lineNum">    3064 </span><span class="lineCov">         10 :                         * (u32 *) arg_desc-&gt;arg_ptr |= arg_desc-&gt;argv_val;</span>
<span class="lineNum">    3065 </span><span class="lineCov">        148 :                 } else if (arg_desc-&gt;parse_flags &amp; ARG_BIT_MASK_REM) {</span>
<span class="lineNum">    3066 </span><span class="lineCov">          2 :                         * (u32 *) arg_desc-&gt;arg_ptr &amp;= ~arg_desc-&gt;argv_val;</span>
<span class="lineNum">    3067 </span><span class="lineCov">        146 :                 } else if (arg_desc-&gt;argv_val) {</span>
<span class="lineNum">    3068 </span><span class="lineCov">          8 :                         * (u32 *) arg_desc-&gt;arg_ptr = arg_desc-&gt;argv_val;</span>
<span class="lineNum">    3069 </span>            :                 } else {
<span class="lineNum">    3070 </span><span class="lineCov">        138 :                         * (u32 *) arg_desc-&gt;arg_ptr = GF_TRUE;</span>
<span class="lineNum">    3071 </span>            :                 }
<span class="lineNum">    3072 </span>            :                 return GF_TRUE;
<span class="lineNum">    3073 </span>            :         }
<span class="lineNum">    3074 </span>            : 
<span class="lineNum">    3075 </span><span class="lineCov">       1023 :         if (arg_desc-&gt;type == GF_ARG_STRING) {</span>
<span class="lineNum">    3076 </span><span class="lineCov">        812 :                 if (arg_desc-&gt;parse_flags &amp; ARG_IS_4CC) {</span>
<span class="lineNum">    3077 </span><span class="lineNoCov">          0 :                         u32 alen = arg_val ? (u32) strlen(arg_val) : 0;</span>
<span class="lineNum">    3078 </span><span class="lineNoCov">          0 :                         if ((alen&lt;3) || (alen&gt;4)) {</span>
<span class="lineNum">    3079 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Value for %s must be a 4CC, %s is not - please check usage\n&quot;, arg, arg_val));</span>
<span class="lineNum">    3080 </span><span class="lineNoCov">          0 :                                 arg_parse_res = 2;</span>
<span class="lineNum">    3081 </span><span class="lineNoCov">          0 :                                 return GF_TRUE;</span>
<span class="lineNum">    3082 </span>            :                         }
<span class="lineNum">    3083 </span><span class="lineNoCov">          0 :                         * (u32 *) arg_desc-&gt;arg_ptr = GF_4CC(arg_val[0], arg_val[1], arg_val[2], arg_val[3]);</span>
<span class="lineNum">    3084 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">    3085 </span>            :                 }
<span class="lineNum">    3086 </span>            : 
<span class="lineNum">    3087 </span><span class="lineCov">        812 :                 * (char **) arg_desc-&gt;arg_ptr = arg_val;</span>
<span class="lineNum">    3088 </span><span class="lineCov">        812 :                 return GF_TRUE;</span>
<span class="lineNum">    3089 </span>            :         }
<span class="lineNum">    3090 </span><span class="lineCov">        211 :         if (!arg_val) {</span>
<span class="lineNum">    3091 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Missing value for %s - please check usage\n&quot;, arg));</span>
<span class="lineNum">    3092 </span><span class="lineNoCov">          0 :                 arg_parse_res = 2;</span>
<span class="lineNum">    3093 </span><span class="lineNoCov">          0 :                 return GF_TRUE;</span>
<span class="lineNum">    3094 </span>            :         }
<span class="lineNum">    3095 </span>            : 
<span class="lineNum">    3096 </span><span class="lineCov">        211 :         if (arg_desc-&gt;type == GF_ARG_DOUBLE) {</span>
<span class="lineNum">    3097 </span>            :                 Double v = atof(arg_val);
<span class="lineNum">    3098 </span><span class="lineCov">        192 :                 if (arg_desc-&gt;parse_flags &amp; ARG_DIV_1000) {</span>
<span class="lineNum">    3099 </span><span class="lineNoCov">          0 :                         v /= 1000;</span>
<span class="lineNum">    3100 </span>            :                 }
<span class="lineNum">    3101 </span><span class="lineCov">        192 :                 if ((arg_desc-&gt;parse_flags &amp; ARG_NON_ZERO) &amp;&amp; !v) {</span>
<span class="lineNum">    3102 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Value for %s shall not be 0 - please check usage\n&quot;, arg));</span>
<span class="lineNum">    3103 </span><span class="lineNoCov">          0 :                         arg_parse_res = 2;</span>
<span class="lineNum">    3104 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">    3105 </span>            :                 }
<span class="lineNum">    3106 </span><span class="lineCov">        192 :                 * (Double *) arg_desc-&gt;arg_ptr = v;</span>
<span class="lineNum">    3107 </span><span class="lineCov">        192 :                 return GF_TRUE;</span>
<span class="lineNum">    3108 </span>            :         }
<span class="lineNum">    3109 </span>            : 
<span class="lineNum">    3110 </span><span class="lineCov">         19 :         if (arg_desc-&gt;type != GF_ARG_INT) {</span>
<span class="lineNum">    3111 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Unsupported argument type for %s - please report to gpac devs\n&quot;, arg));</span>
<span class="lineNum">    3112 </span><span class="lineNoCov">          0 :                 arg_parse_res = 2;</span>
<span class="lineNum">    3113 </span><span class="lineNoCov">          0 :                 return GF_TRUE;</span>
<span class="lineNum">    3114 </span>            :         }
<span class="lineNum">    3115 </span><span class="lineCov">         19 :         if (arg_desc-&gt;parse_flags &amp; ARG_64BITS) {</span>
<span class="lineNum">    3116 </span>            :                 u64 v;
<span class="lineNum">    3117 </span><span class="lineNoCov">          0 :                 sscanf(arg_val, LLU, &amp;v);</span>
<span class="lineNum">    3118 </span><span class="lineNoCov">          0 :                 if (arg_desc-&gt;parse_flags &amp; ARG_DIV_1000) {</span>
<span class="lineNum">    3119 </span><span class="lineNoCov">          0 :                         v /= 1000;</span>
<span class="lineNum">    3120 </span>            :                 }
<span class="lineNum">    3121 </span><span class="lineNoCov">          0 :                 if ((arg_desc-&gt;parse_flags &amp; ARG_NON_ZERO) &amp;&amp; !v) {</span>
<span class="lineNum">    3122 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Value for %s shall not be 0 - please check usage\n&quot;, arg));</span>
<span class="lineNum">    3123 </span><span class="lineNoCov">          0 :                         arg_parse_res = 2;</span>
<span class="lineNum">    3124 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">    3125 </span>            :                 }
<span class="lineNum">    3126 </span><span class="lineNoCov">          0 :                 * (u64 *) arg_desc-&gt;arg_ptr = v;</span>
<span class="lineNum">    3127 </span>            :         } else {
<span class="lineNum">    3128 </span><span class="lineCov">         19 :                 u32 v = atoi(arg_val);</span>
<span class="lineNum">    3129 </span><span class="lineCov">         19 :                 if (arg_desc-&gt;parse_flags &amp; ARG_DIV_1000) {</span>
<span class="lineNum">    3130 </span><span class="lineNoCov">          0 :                         v /= 1000;</span>
<span class="lineNum">    3131 </span>            :                 }
<span class="lineNum">    3132 </span><span class="lineCov">         19 :                 if ((arg_desc-&gt;parse_flags &amp; ARG_NON_ZERO) &amp;&amp; !v) {</span>
<span class="lineNum">    3133 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Value for %s shall not be 0 - please check usage\n&quot;, arg));</span>
<span class="lineNum">    3134 </span><span class="lineNoCov">          0 :                         arg_parse_res = 2;</span>
<span class="lineNum">    3135 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">    3136 </span>            :                 }
<span class="lineNum">    3137 </span><span class="lineCov">         19 :                 * (s32 *) arg_desc-&gt;arg_ptr = v;</span>
<span class="lineNum">    3138 </span>            :         }
<span class="lineNum">    3139 </span>            :         return GF_TRUE;
<a name="3140"><span class="lineNum">    3140 </span>            : }</a>
<span class="lineNum">    3141 </span>            : 
<span class="lineNum">    3142 </span><span class="lineCov">      26923 : Bool mp4box_parse_single_arg(int argc, char **argv, char *arg, u32 *arg_index)</span>
<span class="lineNum">    3143 </span>            : {
<span class="lineNum">    3144 </span><span class="lineCov">      26923 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_gen_args)) return GF_TRUE;</span>
<span class="lineNum">    3145 </span><span class="lineCov">      20930 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_split_args)) return GF_TRUE;</span>
<span class="lineNum">    3146 </span><span class="lineCov">      20922 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_dash_args)) return GF_TRUE;</span>
<span class="lineNum">    3147 </span><span class="lineCov">      20486 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_imp_args)) return GF_TRUE;</span>
<span class="lineNum">    3148 </span><span class="lineCov">      19982 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_senc_args)) return GF_TRUE;</span>
<span class="lineNum">    3149 </span><span class="lineCov">      19937 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_crypt_args)) return GF_TRUE;</span>
<span class="lineNum">    3150 </span><span class="lineCov">      19710 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_hint_args)) return GF_TRUE;</span>
<span class="lineNum">    3151 </span><span class="lineCov">      19607 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_extr_args)) return GF_TRUE;</span>
<span class="lineNum">    3152 </span><span class="lineCov">      19537 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_dump_args)) return GF_TRUE;</span>
<span class="lineNum">    3153 </span><span class="lineCov">      13630 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_meta_args)) return GF_TRUE;</span>
<span class="lineNum">    3154 </span><span class="lineCov">      13506 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_swf_args)) return GF_TRUE;</span>
<span class="lineNum">    3155 </span><span class="lineCov">      13498 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_liveenc_args)) return GF_TRUE;</span>
<span class="lineNum">    3156 </span><span class="lineCov">      13497 :         if (mp4box_parse_single_arg_class(argc, argv, arg, arg_index, m4b_usage_args)) return GF_TRUE;</span>
<span class="lineNum">    3157 </span>            : 
<span class="lineNum">    3158 </span><span class="lineCov">      13464 :         return GF_FALSE;</span>
<span class="lineNum">    3159 </span>            : }
<a name="3160"><span class="lineNum">    3160 </span>            : </a>
<span class="lineNum">    3161 </span>            : 
<span class="lineNum">    3162 </span><span class="lineCov">       4485 : u32 mp4box_parse_args(int argc, char **argv)</span>
<span class="lineNum">    3163 </span>            : {
<span class="lineNum">    3164 </span>            :         u32 i;
<span class="lineNum">    3165 </span>            :         /*parse our args*/
<span class="lineNum">    3166 </span><span class="lineCov">      40334 :         for (i = 1; i &lt; (u32)argc; i++) {</span>
<span class="lineNum">    3167 </span><span class="lineCov">      35887 :                 char *arg = argv[i];</span>
<span class="lineNum">    3168 </span>            :                 /*input file(s)*/
<span class="lineNum">    3169 </span><span class="lineCov">      35887 :                 if ((arg[0] != '-') || !stricmp(arg, &quot;--&quot;)) {</span>
<span class="lineNum">    3170 </span>            :                         char *arg_val = arg;
<span class="lineNum">    3171 </span><span class="lineCov">       4477 :                         if (!stricmp(arg, &quot;--&quot;)) {</span>
<span class="lineNum">    3172 </span><span class="lineNoCov">          0 :                                 if (i+1==(u32)argc) {</span>
<span class="lineNum">    3173 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_ERROR, (&quot;Missing arg for `--` - please check usage\n&quot;));</span>
<span class="lineNum">    3174 </span>            :                                         return 2;
<span class="lineNum">    3175 </span>            :                                 }
<span class="lineNum">    3176 </span><span class="lineNoCov">          0 :                                 has_next_arg = GF_TRUE;</span>
<span class="lineNum">    3177 </span><span class="lineNoCov">          0 :                                 arg_val = argv[i + 1];</span>
<span class="lineNum">    3178 </span><span class="lineNoCov">          0 :                                 i++;</span>
<span class="lineNum">    3179 </span>            :                         }
<span class="lineNum">    3180 </span><span class="lineCov">       4477 :                         if (argc &lt; 3) {</span>
<span class="lineNum">    3181 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Error - only one input file found as argument, please check usage\n&quot;));</span>
<span class="lineNum">    3182 </span>            :                                 return 2;
<span class="lineNum">    3183 </span>            :                         }
<span class="lineNum">    3184 </span><span class="lineCov">       4477 :                         else if (inName) {</span>
<span class="lineNum">    3185 </span><span class="lineCov">         33 :                                 if (dash_duration) {</span>
<span class="lineNum">    3186 </span><span class="lineCov">         33 :                                         if (!nb_dash_inputs) {</span>
<span class="lineNum">    3187 </span><span class="lineCov">         27 :                                                 dash_inputs = set_dash_input(dash_inputs, inName, &amp;nb_dash_inputs);</span>
<span class="lineNum">    3188 </span>            :                                         }
<span class="lineNum">    3189 </span><span class="lineCov">         33 :                                         dash_inputs = set_dash_input(dash_inputs, arg_val, &amp;nb_dash_inputs);</span>
<span class="lineNum">    3190 </span>            :                                 }
<span class="lineNum">    3191 </span>            :                                 else {
<span class="lineNum">    3192 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_ERROR, (&quot;Error - 2 input names specified, please check usage\n&quot;));</span>
<span class="lineNum">    3193 </span>            :                                         return 2;
<span class="lineNum">    3194 </span>            :                                 }
<span class="lineNum">    3195 </span>            :                         }
<span class="lineNum">    3196 </span>            :                         else {
<span class="lineNum">    3197 </span><span class="lineCov">       4444 :                                 inName = arg_val;</span>
<span class="lineNum">    3198 </span>            :                         }
<span class="lineNum">    3199 </span>            :                 }
<span class="lineNum">    3200 </span>            :                 //all deprecated options
<span class="lineNum">    3201 </span><span class="lineCov">      31410 :                 else if (!stricmp(arg, &quot;-grab-ts&quot;) || !stricmp(arg, &quot;-atsc&quot;) || !stricmp(arg, &quot;-rtp&quot;)) {</span>
<span class="lineNum">    3202 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Deprecated fuctionnality `%s` - use gpac application\n&quot;, arg));</span>
<span class="lineNum">    3203 </span>            :                         return 2;
<span class="lineNum">    3204 </span>            :                 }
<span class="lineNum">    3205 </span><span class="lineCov">      31410 :                 else if (!stricmp(arg, &quot;-write-buffer&quot;)) {</span>
<span class="lineNum">    3206 </span><span class="lineCov">          1 :                         M4_LOG(GF_LOG_WARNING, (&quot;`%s` option deprecated, use `-bs-cache-size`&quot;, arg));</span>
<span class="lineNum">    3207 </span><span class="lineCov">          1 :                         gf_opts_set_key(&quot;temp&quot;, &quot;bs-cache-size&quot;, argv[i + 1]);</span>
<span class="lineNum">    3208 </span><span class="lineCov">          1 :                         i++;</span>
<span class="lineNum">    3209 </span>            :                 }
<span class="lineNum">    3210 </span><span class="lineCov">      31409 :                 else if (!stricmp(arg, &quot;-pssh-moof&quot;)) {</span>
<span class="lineNum">    3211 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;`-pssh-moof` option deprecated , use `-pssh` option\n&quot;));</span>
<span class="lineNum">    3212 </span>            :                         return 2;
<span class="lineNum">    3213 </span>            :                 }
<span class="lineNum">    3214 </span><span class="lineCov">      31409 :                 else if (!stricmp(arg, &quot;-tag-list&quot;)) {</span>
<span class="lineNum">    3215 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;`-tag-list` option deprecated, use `-h tags`\n&quot;));</span>
<span class="lineNum">    3216 </span>            :                         return 2;
<span class="lineNum">    3217 </span>            :                 }
<span class="lineNum">    3218 </span><span class="lineCov">      31409 :                 else if (!stricmp(arg, &quot;-aviraw&quot;)) {</span>
<span class="lineNum">    3219 </span><span class="lineCov">          4 :                         M4_LOG(GF_LOG_ERROR, (&quot;`-aviraw` option deprecated, use `-raw`\n&quot;));</span>
<span class="lineNum">    3220 </span>            :                         return 2;
<span class="lineNum">    3221 </span>            :                 }
<span class="lineNum">    3222 </span><span class="lineCov">      31405 :                 else if (!stricmp(arg, &quot;-avi&quot;)) {</span>
<span class="lineNum">    3223 </span><span class="lineCov">          1 :                         M4_LOG(GF_LOG_ERROR, (&quot;`-avi` option deprecated, use `-mux`\n&quot;));</span>
<span class="lineNum">    3224 </span>            :                         return 2;
<span class="lineNum">    3225 </span>            :                 }
<span class="lineNum">    3226 </span><span class="lineCov">      31404 :                 else if (!strncmp(arg, &quot;-p=&quot;, 3)) {</span>
<span class="lineNum">    3227 </span><span class="lineCov">       4481 :                         continue;</span>
<span class="lineNum">    3228 </span>            :                 }
<span class="lineNum">    3229 </span>            : 
<span class="lineNum">    3230 </span>            :                 //parse argument
<span class="lineNum">    3231 </span><span class="lineCov">      26923 :                 else if (mp4box_parse_single_arg(argc, argv, arg, &amp;i)) {</span>
<span class="lineNum">    3232 </span><span class="lineCov">      13459 :                         if (arg_parse_res)</span>
<span class="lineNum">    3233 </span><span class="lineCov">         30 :                                 return mp4box_cleanup(arg_parse_res);</span>
<span class="lineNum">    3234 </span>            :                 }
<span class="lineNum">    3235 </span>            :                 //not a MP4Box arg
<span class="lineNum">    3236 </span>            :                 else {
<span class="lineNum">    3237 </span><span class="lineCov">      13464 :                         u32 res = gf_sys_is_gpac_arg(arg);</span>
<span class="lineNum">    3238 </span><span class="lineCov">      13464 :                         if (res==0) {</span>
<span class="lineNum">    3239 </span><span class="lineCov">          2 :                                 PrintHelp(arg, GF_FALSE, GF_TRUE);</span>
<span class="lineNum">    3240 </span><span class="lineCov">          2 :                                 return 2;</span>
<span class="lineNum">    3241 </span><span class="lineCov">      13462 :                         } else if (res==2) {</span>
<span class="lineNum">    3242 </span><span class="lineCov">          1 :                                 i++;</span>
<span class="lineNum">    3243 </span>            :                         }
<span class="lineNum">    3244 </span>            :                 }
<span class="lineNum">    3245 </span>            :                 //live scene encoder does not use the unified parsing and should be moved as a scene encoder filter
<span class="lineNum">    3246 </span><span class="lineCov">      31369 :                 if (live_scene) return 0;</span>
<span class="lineNum">    3247 </span>            :         }
<span class="lineNum">    3248 </span>            :         return 0;
<span class="lineNum">    3249 </span>            : }
<span class="lineNum">    3250 </span>            : 
<span class="lineNum">    3251 </span>            : /*
<span class="lineNum">    3252 </span>            :         END OF OPTION PARSING CODE
<span class="lineNum">    3253 </span>            : */
<span class="lineNum">    3254 </span>            : 
<a name="3255"><span class="lineNum">    3255 </span>            : </a>
<span class="lineNum">    3256 </span>            : 
<span class="lineNum">    3257 </span><span class="lineCov">      12474 : void scene_coding_log(void *cbk, GF_LOG_Level log_level, GF_LOG_Tool log_tool, const char *fmt, va_list vlist)</span>
<span class="lineNum">    3258 </span>            : {
<span class="lineNum">    3259 </span>            :         FILE *logs = cbk;
<span class="lineNum">    3260 </span><span class="lineCov">      12474 :         if (log_tool != GF_LOG_CODING) return;</span>
<span class="lineNum">    3261 </span>            :         vfprintf(logs, fmt, vlist);
<span class="lineNum">    3262 </span><span class="lineCov">      12453 :         fflush(logs);</span>
<span class="lineNum">    3263 </span>            : }
<span class="lineNum">    3264 </span>            : 
<span class="lineNum">    3265 </span>            : 
<span class="lineNum">    3266 </span>            : #ifndef GPAC_DISABLE_ISOM_HINTING
<span class="lineNum">    3267 </span>            : 
<span class="lineNum">    3268 </span>            : /*
<span class="lineNum">    3269 </span>            :                 MP4 File Hinting
<a name="3270"><span class="lineNum">    3270 </span>            : */</a>
<span class="lineNum">    3271 </span>            : 
<span class="lineNum">    3272 </span><span class="lineCov">          5 : void SetupClockReferences(GF_ISOFile *file)</span>
<span class="lineNum">    3273 </span>            : {
<span class="lineNum">    3274 </span>            :         u32 i, count, ocr_id;
<span class="lineNum">    3275 </span><span class="lineCov">          5 :         count = gf_isom_get_track_count(file);</span>
<span class="lineNum">    3276 </span><span class="lineCov">          5 :         if (count==1) return;</span>
<span class="lineNum">    3277 </span>            :         ocr_id = 0;
<span class="lineNum">    3278 </span><span class="lineCov">         15 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    3279 </span><span class="lineCov">         12 :                 if (!gf_isom_is_track_in_root_od(file, i+1)) continue;</span>
<span class="lineNum">    3280 </span><span class="lineCov">          2 :                 ocr_id = gf_isom_get_track_id(file, i+1);</span>
<span class="lineNum">    3281 </span><span class="lineCov">          2 :                 break;</span>
<span class="lineNum">    3282 </span>            :         }
<span class="lineNum">    3283 </span>            :         /*doesn't look like MP4*/
<span class="lineNum">    3284 </span><span class="lineCov">          5 :         if (!ocr_id) return;</span>
<span class="lineNum">    3285 </span><span class="lineCov">         10 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    3286 </span><span class="lineCov">          8 :                 GF_ESD *esd = gf_isom_get_esd(file, i+1, 1);</span>
<span class="lineNum">    3287 </span><span class="lineCov">          8 :                 if (esd) {</span>
<span class="lineNum">    3288 </span><span class="lineCov">          8 :                         esd-&gt;OCRESID = ocr_id;</span>
<span class="lineNum">    3289 </span><span class="lineCov">          8 :                         gf_isom_change_mpeg4_description(file, i+1, 1, esd);</span>
<span class="lineNum">    3290 </span><span class="lineCov">          8 :                         gf_odf_desc_del((GF_Descriptor *) esd);</span>
<span class="lineNum">    3291 </span>            :                 }
<span class="lineNum">    3292 </span>            :         }
<span class="lineNum">    3293 </span>            : }
<span class="lineNum">    3294 </span>            : 
<span class="lineNum">    3295 </span>            : /*base RTP payload type used (you can specify your own types if needed)*/
<a name="3296"><span class="lineNum">    3296 </span>            : #define BASE_PAYT               96</a>
<span class="lineNum">    3297 </span>            : 
<span class="lineNum">    3298 </span><span class="lineCov">         56 : GF_Err HintFile(GF_ISOFile *file, u32 MTUSize, u32 max_ptime, u32 rtp_rate, u32 base_flags, Bool copy_data, Bool interleave, Bool regular_iod, Bool single_group, Bool hint_no_offset)</span>
<span class="lineNum">    3299 </span>            : {
<span class="lineNum">    3300 </span>            :         GF_ESD *esd;
<span class="lineNum">    3301 </span>            :         GF_InitialObjectDescriptor *iod;
<span class="lineNum">    3302 </span>            :         u32 i, val, res, streamType;
<span class="lineNum">    3303 </span>            :         u32 sl_mode, prev_ocr, single_ocr, nb_done, tot_bw, bw, flags, spec_type;
<span class="lineNum">    3304 </span>            :         GF_Err e;
<span class="lineNum">    3305 </span>            :         char szPayload[30];
<span class="lineNum">    3306 </span>            :         GF_RTPHinter *hinter;
<span class="lineNum">    3307 </span>            :         Bool copy, has_iod, single_av;
<span class="lineNum">    3308 </span>            :         u8 init_payt = BASE_PAYT;
<span class="lineNum">    3309 </span>            :         u32 mtype;
<span class="lineNum">    3310 </span>            :         GF_SDP_IODProfile iod_mode = GF_SDP_IOD_NONE;
<span class="lineNum">    3311 </span>            :         u32 media_group = 0;
<span class="lineNum">    3312 </span>            :         u8 media_prio = 0;
<span class="lineNum">    3313 </span>            : 
<span class="lineNum">    3314 </span>            :         tot_bw = 0;
<span class="lineNum">    3315 </span>            :         prev_ocr = 0;
<span class="lineNum">    3316 </span>            :         single_ocr = 1;
<span class="lineNum">    3317 </span>            : 
<span class="lineNum">    3318 </span>            :         has_iod = 1;
<span class="lineNum">    3319 </span><span class="lineCov">         56 :         iod = (GF_InitialObjectDescriptor *) gf_isom_get_root_od(file);</span>
<span class="lineNum">    3320 </span><span class="lineCov">         56 :         if (!iod) has_iod = 0;</span>
<span class="lineNum">    3321 </span>            :         else {
<span class="lineNum">    3322 </span><span class="lineCov">         31 :                 if (!gf_list_count(iod-&gt;ESDescriptors)) has_iod = 0;</span>
<span class="lineNum">    3323 </span><span class="lineCov">         31 :                 gf_odf_desc_del((GF_Descriptor *) iod);</span>
<span class="lineNum">    3324 </span>            :         }
<span class="lineNum">    3325 </span>            : 
<span class="lineNum">    3326 </span><span class="lineCov">         56 :         spec_type = gf_isom_guess_specification(file);</span>
<span class="lineNum">    3327 </span><span class="lineCov">         56 :         single_av = single_group ? 1 : gf_isom_is_single_av(file);</span>
<span class="lineNum">    3328 </span>            : 
<span class="lineNum">    3329 </span>            :         /*first make sure we use a systems track as base OCR*/
<span class="lineNum">    3330 </span><span class="lineCov">        173 :         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    3331 </span><span class="lineCov">         66 :                 res = gf_isom_get_media_type(file, i+1);</span>
<span class="lineNum">    3332 </span><span class="lineCov">         66 :                 if ((res==GF_ISOM_MEDIA_SCENE) || (res==GF_ISOM_MEDIA_OD)) {</span>
<span class="lineNum">    3333 </span><span class="lineCov">          5 :                         if (gf_isom_is_track_in_root_od(file, i+1)) {</span>
<span class="lineNum">    3334 </span><span class="lineCov">          5 :                                 gf_isom_set_default_sync_track(file, i+1);</span>
<span class="lineNum">    3335 </span><span class="lineCov">          5 :                                 break;</span>
<span class="lineNum">    3336 </span>            :                         }
<span class="lineNum">    3337 </span>            :                 }
<span class="lineNum">    3338 </span>            :         }
<span class="lineNum">    3339 </span>            : 
<span class="lineNum">    3340 </span>            :         nb_done = 0;
<span class="lineNum">    3341 </span><span class="lineCov">        210 :         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    3342 </span>            :                 sl_mode = base_flags;
<span class="lineNum">    3343 </span>            :                 copy = copy_data;
<span class="lineNum">    3344 </span>            :                 /*skip emty tracks (mainly MPEG-4 interaction streams...*/
<span class="lineNum">    3345 </span><span class="lineCov">        155 :                 if (!gf_isom_get_sample_count(file, i+1)) continue;</span>
<span class="lineNum">    3346 </span><span class="lineCov">        151 :                 if (!gf_isom_is_track_enabled(file, i+1)) {</span>
<span class="lineNum">    3347 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_INFO, (&quot;Track ID %d disabled - skipping hint\n&quot;, gf_isom_get_track_id(file, i+1) ));</span>
<span class="lineNum">    3348 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    3349 </span>            :                 }
<span class="lineNum">    3350 </span>            : 
<span class="lineNum">    3351 </span><span class="lineCov">        151 :                 mtype = gf_isom_get_media_type(file, i+1);</span>
<span class="lineNum">    3352 </span><span class="lineCov">        151 :                 switch (mtype) {</span>
<span class="lineNum">    3353 </span><span class="lineCov">         32 :                 case GF_ISOM_MEDIA_VISUAL:</span>
<span class="lineNum">    3354 </span><span class="lineCov">         32 :                         if (single_av) {</span>
<span class="lineNum">    3355 </span>            :                                 media_group = 2;
<span class="lineNum">    3356 </span>            :                                 media_prio = 2;
<span class="lineNum">    3357 </span>            :                         }
<span class="lineNum">    3358 </span>            :                         break;
<span class="lineNum">    3359 </span><span class="lineNoCov">          0 :         case GF_ISOM_MEDIA_AUXV:</span>
<span class="lineNum">    3360 </span><span class="lineNoCov">          0 :             if (single_av) {</span>
<span class="lineNum">    3361 </span>            :                 media_group = 2;
<span class="lineNum">    3362 </span>            :                 media_prio = 3;
<span class="lineNum">    3363 </span>            :             }
<span class="lineNum">    3364 </span>            :             break;
<span class="lineNum">    3365 </span><span class="lineNoCov">          0 :         case GF_ISOM_MEDIA_PICT:</span>
<span class="lineNum">    3366 </span><span class="lineNoCov">          0 :             if (single_av) {</span>
<span class="lineNum">    3367 </span>            :                 media_group = 2;
<span class="lineNum">    3368 </span>            :                 media_prio = 4;
<span class="lineNum">    3369 </span>            :             }
<span class="lineNum">    3370 </span>            :             break;
<span class="lineNum">    3371 </span><span class="lineCov">         29 :                 case GF_ISOM_MEDIA_AUDIO:</span>
<span class="lineNum">    3372 </span><span class="lineCov">         29 :                         if (single_av) {</span>
<span class="lineNum">    3373 </span>            :                                 media_group = 2;
<span class="lineNum">    3374 </span>            :                                 media_prio = 1;
<span class="lineNum">    3375 </span>            :                         }
<span class="lineNum">    3376 </span>            :                         break;
<span class="lineNum">    3377 </span><span class="lineCov">         73 :                 case GF_ISOM_MEDIA_HINT:</span>
<span class="lineNum">    3378 </span><span class="lineCov">         73 :                         continue;</span>
<span class="lineNum">    3379 </span><span class="lineCov">         17 :                 default:</span>
<span class="lineNum">    3380 </span>            :                         /*no hinting of systems track on isma*/
<span class="lineNum">    3381 </span><span class="lineCov">         17 :                         if (spec_type==GF_ISOM_BRAND_ISMA) continue;</span>
<span class="lineNum">    3382 </span>            :                 }
<span class="lineNum">    3383 </span><span class="lineCov">         78 :                 mtype = gf_isom_get_media_subtype(file, i+1, 1);</span>
<span class="lineNum">    3384 </span><span class="lineCov">         78 :                 if ((mtype==GF_ISOM_SUBTYPE_MPEG4) || (mtype==GF_ISOM_SUBTYPE_MPEG4_CRYP) ) mtype = gf_isom_get_mpeg4_subtype(file, i+1, 1);</span>
<span class="lineNum">    3385 </span>            : 
<span class="lineNum">    3386 </span><span class="lineCov">         78 :                 if (!single_av) {</span>
<span class="lineNum">    3387 </span>            :                         /*one media per group only (we should prompt user for group selection)*/
<span class="lineNum">    3388 </span><span class="lineCov">         13 :                         media_group ++;</span>
<span class="lineNum">    3389 </span>            :                         media_prio = 1;
<span class="lineNum">    3390 </span>            :                 }
<span class="lineNum">    3391 </span>            : 
<span class="lineNum">    3392 </span>            :                 streamType = 0;
<span class="lineNum">    3393 </span><span class="lineCov">         78 :                 esd = gf_isom_get_esd(file, i+1, 1);</span>
<span class="lineNum">    3394 </span><span class="lineCov">         78 :                 if (esd &amp;&amp; esd-&gt;decoderConfig) {</span>
<span class="lineNum">    3395 </span><span class="lineCov">         69 :                         streamType = esd-&gt;decoderConfig-&gt;streamType;</span>
<span class="lineNum">    3396 </span><span class="lineCov">         69 :                         if (!prev_ocr) {</span>
<span class="lineNum">    3397 </span><span class="lineCov">         47 :                                 prev_ocr = esd-&gt;OCRESID;</span>
<span class="lineNum">    3398 </span><span class="lineCov">         47 :                                 if (!esd-&gt;OCRESID) prev_ocr = esd-&gt;ESID;</span>
<span class="lineNum">    3399 </span><span class="lineCov">         22 :                         } else if (esd-&gt;OCRESID &amp;&amp; prev_ocr != esd-&gt;OCRESID) {</span>
<span class="lineNum">    3400 </span>            :                                 single_ocr = 0;
<span class="lineNum">    3401 </span>            :                         }
<span class="lineNum">    3402 </span>            :                         /*OD MUST BE WITHOUT REFERENCES*/
<span class="lineNum">    3403 </span><span class="lineCov">         69 :                         if (streamType==1) copy = 1;</span>
<span class="lineNum">    3404 </span>            :                 }
<span class="lineNum">    3405 </span><span class="lineCov">         78 :                 gf_odf_desc_del((GF_Descriptor *) esd);</span>
<span class="lineNum">    3406 </span>            : 
<span class="lineNum">    3407 </span><span class="lineCov">         78 :                 if (!regular_iod &amp;&amp; gf_isom_is_track_in_root_od(file, i+1)) {</span>
<span class="lineNum">    3408 </span>            :                         /*single AU - check if base64 would fit in ESD (consider 33% overhead of base64), otherwise stream*/
<span class="lineNum">    3409 </span><span class="lineCov">         10 :                         if (gf_isom_get_sample_count(file, i+1)==1) {</span>
<span class="lineNum">    3410 </span><span class="lineCov">          4 :                                 GF_ISOSample *samp = gf_isom_get_sample(file, i+1, 1, &amp;val);</span>
<span class="lineNum">    3411 </span><span class="lineCov">          4 :                                 if (streamType &amp;&amp; samp) {</span>
<span class="lineNum">    3412 </span><span class="lineCov">          4 :                                         res = gf_hinter_can_embbed_data(samp-&gt;data, samp-&gt;dataLength, streamType);</span>
<span class="lineNum">    3413 </span>            :                                 } else {
<span class="lineNum">    3414 </span>            :                                         /*not a system track, we shall hint it*/
<span class="lineNum">    3415 </span>            :                                         res = 0;
<span class="lineNum">    3416 </span>            :                                 }
<span class="lineNum">    3417 </span><span class="lineCov">          4 :                                 if (samp) gf_isom_sample_del(&amp;samp);</span>
<span class="lineNum">    3418 </span><span class="lineCov">          4 :                                 if (res) continue;</span>
<span class="lineNum">    3419 </span>            :                         }
<span class="lineNum">    3420 </span>            :                 }
<span class="lineNum">    3421 </span><span class="lineCov">         74 :                 if (interleave) sl_mode |= GP_RTP_PCK_USE_INTERLEAVING;</span>
<span class="lineNum">    3422 </span>            : 
<span class="lineNum">    3423 </span><span class="lineCov">         74 :                 hinter = gf_hinter_track_new(file, i+1, MTUSize, max_ptime, rtp_rate, sl_mode, init_payt, copy, media_group, media_prio, &amp;e);</span>
<span class="lineNum">    3424 </span>            : 
<span class="lineNum">    3425 </span><span class="lineCov">         74 :                 if (!hinter) {</span>
<span class="lineNum">    3426 </span><span class="lineCov">          1 :                         if (e) {</span>
<span class="lineNum">    3427 </span><span class="lineCov">          1 :                                 M4_LOG(nb_done ? GF_LOG_WARNING : GF_LOG_ERROR, (&quot;Cannot create hinter (%s)\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    3428 </span><span class="lineCov">          1 :                                 if (!nb_done) return e;</span>
<span class="lineNum">    3429 </span>            :                         }
<span class="lineNum">    3430 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    3431 </span>            :                 }
<span class="lineNum">    3432 </span>            : 
<span class="lineNum">    3433 </span><span class="lineCov">         73 :                 if (hint_no_offset)</span>
<span class="lineNum">    3434 </span><span class="lineCov">          1 :                         gf_hinter_track_force_no_offsets(hinter);</span>
<span class="lineNum">    3435 </span>            : 
<span class="lineNum">    3436 </span><span class="lineCov">         73 :                 bw = gf_hinter_track_get_bandwidth(hinter);</span>
<span class="lineNum">    3437 </span><span class="lineCov">         73 :                 tot_bw += bw;</span>
<span class="lineNum">    3438 </span><span class="lineCov">         73 :                 flags = gf_hinter_track_get_flags(hinter);</span>
<span class="lineNum">    3439 </span>            : 
<span class="lineNum">    3440 </span>            :                 //set extraction mode for AVC/SVC
<span class="lineNum">    3441 </span><span class="lineCov">         73 :                 gf_isom_set_nalu_extract_mode(file, i+1, GF_ISOM_NALU_EXTRACT_LAYER_ONLY);</span>
<span class="lineNum">    3442 </span>            : 
<span class="lineNum">    3443 </span><span class="lineCov">         73 :                 gf_hinter_track_get_payload_name(hinter, szPayload);</span>
<span class="lineNum">    3444 </span><span class="lineCov">         73 :                 M4_LOG(GF_LOG_INFO, (&quot;Hinting track ID %d - Type \&quot;%s:%s\&quot; (%s) - BW %d kbps\n&quot;, gf_isom_get_track_id(file, i+1), gf_4cc_to_str(mtype), gf_4cc_to_str(mtype), szPayload, bw));</span>
<span class="lineNum">    3445 </span><span class="lineCov">         73 :                 if (flags &amp; GP_RTP_PCK_SYSTEMS_CAROUSEL) M4_LOG(GF_LOG_INFO, (&quot;\tMPEG-4 Systems stream carousel enabled\n&quot;));</span>
<span class="lineNum">    3446 </span><span class="lineCov">         73 :                 e = gf_hinter_track_process(hinter);</span>
<span class="lineNum">    3447 </span>            : 
<span class="lineNum">    3448 </span><span class="lineCov">         73 :                 if (!e) e = gf_hinter_track_finalize(hinter, has_iod);</span>
<span class="lineNum">    3449 </span><span class="lineCov">         73 :                 gf_hinter_track_del(hinter);</span>
<span class="lineNum">    3450 </span>            : 
<span class="lineNum">    3451 </span><span class="lineCov">         73 :                 if (e) {</span>
<span class="lineNum">    3452 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Error while hinting (%s)\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    3453 </span><span class="lineNoCov">          0 :                         if (!nb_done) return e;</span>
<span class="lineNum">    3454 </span>            :                 }
<span class="lineNum">    3455 </span><span class="lineCov">         73 :                 init_payt++;</span>
<span class="lineNum">    3456 </span><span class="lineCov">         73 :                 nb_done ++;</span>
<span class="lineNum">    3457 </span>            :         }
<span class="lineNum">    3458 </span>            : 
<span class="lineNum">    3459 </span><span class="lineCov">         55 :         if (has_iod) {</span>
<span class="lineNum">    3460 </span>            :                 iod_mode = GF_SDP_IOD_ISMA;
<span class="lineNum">    3461 </span><span class="lineCov">          5 :                 if (regular_iod) iod_mode = GF_SDP_IOD_REGULAR;</span>
<span class="lineNum">    3462 </span>            :         } else {
<span class="lineNum">    3463 </span>            :                 iod_mode = GF_SDP_IOD_NONE;
<span class="lineNum">    3464 </span>            :         }
<span class="lineNum">    3465 </span><span class="lineCov">         55 :         gf_hinter_finalize(file, iod_mode, tot_bw);</span>
<span class="lineNum">    3466 </span>            : 
<span class="lineNum">    3467 </span><span class="lineCov">         55 :         if (!single_ocr)</span>
<span class="lineNum">    3468 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_WARNING, (&quot;Warning: at least 2 timelines found in the file\nThis may not be supported by servers/players\n\n&quot;));</span>
<span class="lineNum">    3469 </span>            : 
<span class="lineNum">    3470 </span>            :         return GF_OK;
<span class="lineNum">    3471 </span>            : }
<span class="lineNum">    3472 </span>            : 
<span class="lineNum">    3473 </span>            : #endif /*GPAC_DISABLE_ISOM_HINTING*/
<span class="lineNum">    3474 </span>            : 
<a name="3475"><span class="lineNum">    3475 </span>            : #if !defined(GPAC_DISABLE_ISOM_WRITE) &amp;&amp; !defined(GPAC_DISABLE_AV_PARSERS)</a>
<span class="lineNum">    3476 </span>            : 
<span class="lineNum">    3477 </span><span class="lineCov">         62 : static void check_media_profile(GF_ISOFile *file, u32 track)</span>
<span class="lineNum">    3478 </span>            : {
<span class="lineNum">    3479 </span>            :         u8 PL;
<span class="lineNum">    3480 </span><span class="lineCov">         62 :         GF_ESD *esd = gf_isom_get_esd(file, track, 1);</span>
<span class="lineNum">    3481 </span><span class="lineCov">         62 :         if (!esd) return;</span>
<span class="lineNum">    3482 </span>            : 
<span class="lineNum">    3483 </span><span class="lineCov">         43 :         switch (esd-&gt;decoderConfig-&gt;streamType) {</span>
<span class="lineNum">    3484 </span><span class="lineCov">         42 :         case 0x04:</span>
<span class="lineNum">    3485 </span><span class="lineCov">         42 :                 PL = gf_isom_get_pl_indication(file, GF_ISOM_PL_VISUAL);</span>
<span class="lineNum">    3486 </span><span class="lineCov">         42 :                 if (esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_MPEG4_PART2) {</span>
<span class="lineNum">    3487 </span>            :                         GF_M4VDecSpecInfo vdsi;
<span class="lineNum">    3488 </span><span class="lineNoCov">          0 :                         gf_m4v_get_config(esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data, esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;dataLength, &amp;vdsi);</span>
<span class="lineNum">    3489 </span><span class="lineNoCov">          0 :                         if (vdsi.VideoPL &gt; PL) gf_isom_set_pl_indication(file, GF_ISOM_PL_VISUAL, vdsi.VideoPL);</span>
<span class="lineNum">    3490 </span><span class="lineCov">         42 :                 } else if ((esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_AVC) || (esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_SVC)) {</span>
<span class="lineNum">    3491 </span><span class="lineCov">          8 :                         gf_isom_set_pl_indication(file, GF_ISOM_PL_VISUAL, 0x15);</span>
<span class="lineNum">    3492 </span><span class="lineCov">         34 :                 } else if (!PL) {</span>
<span class="lineNum">    3493 </span><span class="lineCov">          5 :                         gf_isom_set_pl_indication(file, GF_ISOM_PL_VISUAL, 0xFE);</span>
<span class="lineNum">    3494 </span>            :                 }
<span class="lineNum">    3495 </span>            :                 break;
<span class="lineNum">    3496 </span><span class="lineCov">          1 :         case 0x05:</span>
<span class="lineNum">    3497 </span><span class="lineCov">          1 :                 PL = gf_isom_get_pl_indication(file, GF_ISOM_PL_AUDIO);</span>
<span class="lineNum">    3498 </span><span class="lineCov">          1 :                 switch (esd-&gt;decoderConfig-&gt;objectTypeIndication) {</span>
<span class="lineNum">    3499 </span><span class="lineCov">          1 :                 case GF_CODECID_AAC_MPEG2_MP:</span>
<span class="lineNum">    3500 </span>            :                 case GF_CODECID_AAC_MPEG2_LCP:
<span class="lineNum">    3501 </span>            :                 case GF_CODECID_AAC_MPEG2_SSRP:
<span class="lineNum">    3502 </span>            :                 case GF_CODECID_AAC_MPEG4:
<span class="lineNum">    3503 </span>            :                 {
<span class="lineNum">    3504 </span>            :                         GF_M4ADecSpecInfo adsi;
<span class="lineNum">    3505 </span><span class="lineCov">          1 :                         gf_m4a_get_config(esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data, esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;dataLength, &amp;adsi);</span>
<span class="lineNum">    3506 </span><span class="lineCov">          1 :                         if (adsi.audioPL &gt; PL) gf_isom_set_pl_indication(file, GF_ISOM_PL_AUDIO, adsi.audioPL);</span>
<span class="lineNum">    3507 </span>            :                 }
<span class="lineNum">    3508 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    3509 </span><span class="lineNoCov">          0 :                 default:</span>
<span class="lineNum">    3510 </span><span class="lineNoCov">          0 :                         if (!PL) gf_isom_set_pl_indication(file, GF_ISOM_PL_AUDIO, 0xFE);</span>
<span class="lineNum">    3511 </span>            :                 }
<span class="lineNum">    3512 </span>            :                 break;
<span class="lineNum">    3513 </span>            :         }
<a name="3514"><span class="lineNum">    3514 </span><span class="lineCov">         43 :         gf_odf_desc_del((GF_Descriptor *) esd);</span></a>
<span class="lineNum">    3515 </span>            : }
<span class="lineNum">    3516 </span><span class="lineCov">        341 : void remove_systems_tracks(GF_ISOFile *file)</span>
<span class="lineNum">    3517 </span>            : {
<span class="lineNum">    3518 </span>            :         u32 i, count;
<span class="lineNum">    3519 </span>            : 
<span class="lineNum">    3520 </span><span class="lineCov">        341 :         count = gf_isom_get_track_count(file);</span>
<span class="lineNum">    3521 </span><span class="lineCov">        341 :         if (count==1) return;</span>
<span class="lineNum">    3522 </span>            : 
<span class="lineNum">    3523 </span>            :         /*force PL rewrite*/
<span class="lineNum">    3524 </span><span class="lineCov">         14 :         gf_isom_set_pl_indication(file, GF_ISOM_PL_VISUAL, 0);</span>
<span class="lineNum">    3525 </span><span class="lineCov">         14 :         gf_isom_set_pl_indication(file, GF_ISOM_PL_AUDIO, 0);</span>
<span class="lineNum">    3526 </span><span class="lineCov">         14 :         gf_isom_set_pl_indication(file, GF_ISOM_PL_OD, 1);      /*the lib always remove IOD when no profiles are specified..*/</span>
<span class="lineNum">    3527 </span>            : 
<span class="lineNum">    3528 </span><span class="lineCov">         88 :         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    3529 </span><span class="lineCov">         74 :                 switch (gf_isom_get_media_type(file, i+1)) {</span>
<span class="lineNum">    3530 </span><span class="lineCov">         62 :                 case GF_ISOM_MEDIA_VISUAL:</span>
<span class="lineNum">    3531 </span>            :         case GF_ISOM_MEDIA_AUXV:
<span class="lineNum">    3532 </span>            :         case GF_ISOM_MEDIA_PICT:
<span class="lineNum">    3533 </span>            :                 case GF_ISOM_MEDIA_AUDIO:
<span class="lineNum">    3534 </span>            :                 case GF_ISOM_MEDIA_TEXT:
<span class="lineNum">    3535 </span>            :                 case GF_ISOM_MEDIA_SUBT:
<span class="lineNum">    3536 </span><span class="lineCov">         62 :                         gf_isom_remove_track_from_root_od(file, i+1);</span>
<span class="lineNum">    3537 </span><span class="lineCov">         62 :                         check_media_profile(file, i+1);</span>
<span class="lineNum">    3538 </span><span class="lineCov">         62 :                         break;</span>
<span class="lineNum">    3539 </span>            :                 /*only remove real systems tracks (eg, delaing with scene description &amp; presentation)
<span class="lineNum">    3540 </span>            :                 but keep meta &amp; all unknown tracks*/
<span class="lineNum">    3541 </span><span class="lineCov">          1 :                 case GF_ISOM_MEDIA_SCENE:</span>
<span class="lineNum">    3542 </span><span class="lineCov">          1 :                         switch (gf_isom_get_media_subtype(file, i+1, 1)) {</span>
<span class="lineNum">    3543 </span><span class="lineNoCov">          0 :                         case GF_ISOM_MEDIA_DIMS:</span>
<span class="lineNum">    3544 </span><span class="lineNoCov">          0 :                                 gf_isom_remove_track_from_root_od(file, i+1);</span>
<span class="lineNum">    3545 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">    3546 </span>            :                         default:
<span class="lineNum">    3547 </span>            :                                 break;
<span class="lineNum">    3548 </span>            :                         }
<span class="lineNum">    3549 </span><span class="lineCov">          2 :                 case GF_ISOM_MEDIA_OD:</span>
<span class="lineNum">    3550 </span>            :                 case GF_ISOM_MEDIA_OCR:
<span class="lineNum">    3551 </span>            :                 case GF_ISOM_MEDIA_MPEGJ:
<span class="lineNum">    3552 </span><span class="lineCov">          2 :                         gf_isom_remove_track(file, i+1);</span>
<span class="lineNum">    3553 </span><span class="lineCov">          2 :                         i--;</span>
<span class="lineNum">    3554 </span><span class="lineCov">          2 :                         break;</span>
<span class="lineNum">    3555 </span>            :                 default:
<span class="lineNum">    3556 </span>            :                         break;
<span class="lineNum">    3557 </span>            :                 }
<span class="lineNum">    3558 </span>            :         }
<span class="lineNum">    3559 </span>            :         /*none required*/
<span class="lineNum">    3560 </span><span class="lineCov">         14 :         if (!gf_isom_get_pl_indication(file, GF_ISOM_PL_AUDIO)) gf_isom_set_pl_indication(file, GF_ISOM_PL_AUDIO, 0xFF);</span>
<span class="lineNum">    3561 </span><span class="lineCov">         14 :         if (!gf_isom_get_pl_indication(file, GF_ISOM_PL_VISUAL)) gf_isom_set_pl_indication(file, GF_ISOM_PL_VISUAL, 0xFF);</span>
<span class="lineNum">    3562 </span>            : 
<span class="lineNum">    3563 </span><span class="lineCov">         14 :         gf_isom_set_pl_indication(file, GF_ISOM_PL_OD, 0xFF);</span>
<span class="lineNum">    3564 </span><span class="lineCov">         14 :         gf_isom_set_pl_indication(file, GF_ISOM_PL_SCENE, 0xFF);</span>
<span class="lineNum">    3565 </span><span class="lineCov">         14 :         gf_isom_set_pl_indication(file, GF_ISOM_PL_GRAPHICS, 0xFF);</span>
<span class="lineNum">    3566 </span><span class="lineCov">         14 :         gf_isom_set_pl_indication(file, GF_ISOM_PL_INLINE, 0);</span>
<span class="lineNum">    3567 </span>            : }
<span class="lineNum">    3568 </span>            : 
<a name="3569"><span class="lineNum">    3569 </span>            : #endif /*!defined(GPAC_DISABLE_ISOM_WRITE) &amp;&amp; !defined(GPAC_DISABLE_AV_PARSERS)*/</a>
<span class="lineNum">    3570 </span>            : 
<span class="lineNum">    3571 </span><span class="lineCov">       1227 : GF_FileType get_file_type_by_ext(char *inName)</span>
<span class="lineNum">    3572 </span>            : {
<span class="lineNum">    3573 </span>            :         GF_FileType type = GF_FILE_TYPE_NOT_SUPPORTED;
<span class="lineNum">    3574 </span><span class="lineCov">       1227 :         char *ext = strrchr(inName, '.');</span>
<span class="lineNum">    3575 </span><span class="lineCov">       1227 :         if (ext) {</span>
<span class="lineNum">    3576 </span>            :                 char *sep;
<span class="lineNum">    3577 </span><span class="lineCov">       1227 :                 if (!strcmp(ext, &quot;.gz&quot;)) ext = strrchr(ext-1, '.');</span>
<span class="lineNum">    3578 </span><span class="lineCov">       1227 :                 ext+=1;</span>
<span class="lineNum">    3579 </span><span class="lineCov">       1227 :                 sep = strchr(ext, '.');</span>
<span class="lineNum">    3580 </span><span class="lineCov">       1227 :                 if (sep) sep[0] = 0;</span>
<span class="lineNum">    3581 </span>            : 
<span class="lineNum">    3582 </span><span class="lineCov">       1227 :                 if (!stricmp(ext, &quot;mp4&quot;) || !stricmp(ext, &quot;3gp&quot;) || !stricmp(ext, &quot;mov&quot;) || !stricmp(ext, &quot;3g2&quot;) || !stricmp(ext, &quot;3gs&quot;)) {</span>
<span class="lineNum">    3583 </span>            :                         type = GF_FILE_TYPE_ISO_MEDIA;
<span class="lineNum">    3584 </span><span class="lineCov">        373 :                 } else if (!stricmp(ext, &quot;bt&quot;) || !stricmp(ext, &quot;wrl&quot;) || !stricmp(ext, &quot;x3dv&quot;)) {</span>
<span class="lineNum">    3585 </span>            :                         type = GF_FILE_TYPE_BT_WRL_X3DV;
<span class="lineNum">    3586 </span><span class="lineCov">        367 :                 } else if (!stricmp(ext, &quot;xmt&quot;) || !stricmp(ext, &quot;x3d&quot;)) {</span>
<span class="lineNum">    3587 </span>            :                         type = GF_FILE_TYPE_XMT_X3D;
<span class="lineNum">    3588 </span><span class="lineCov">        365 :                 } else if (!stricmp(ext, &quot;lsr&quot;) || !stricmp(ext, &quot;saf&quot;)) {</span>
<span class="lineNum">    3589 </span>            :                         type = GF_FILE_TYPE_LSR_SAF;
<span class="lineNum">    3590 </span><span class="lineCov">        363 :                 } else if (!stricmp(ext, &quot;svg&quot;) || !stricmp(ext, &quot;xsr&quot;) || !stricmp(ext, &quot;xml&quot;)) {</span>
<span class="lineNum">    3591 </span>            :                         type = GF_FILE_TYPE_SVG;
<span class="lineNum">    3592 </span><span class="lineCov">        225 :                 } else if (!stricmp(ext, &quot;swf&quot;)) {</span>
<span class="lineNum">    3593 </span>            :                         type = GF_FILE_TYPE_SWF;
<span class="lineNum">    3594 </span><span class="lineCov">        223 :                 } else if (!stricmp(ext, &quot;jp2&quot;)) {</span>
<span class="lineNum">    3595 </span><span class="lineCov">          1 :                         if (sep) sep[0] = '.';</span>
<span class="lineNum">    3596 </span>            :                         return GF_FILE_TYPE_NOT_SUPPORTED;
<span class="lineNum">    3597 </span>            :                 }
<span class="lineNum">    3598 </span>            :                 else type = GF_FILE_TYPE_NOT_SUPPORTED;
<span class="lineNum">    3599 </span>            : 
<span class="lineNum">    3600 </span><span class="lineCov">       1226 :                 if (sep) sep[0] = '.';</span>
<span class="lineNum">    3601 </span>            :         }
<span class="lineNum">    3602 </span>            : 
<span class="lineNum">    3603 </span>            : 
<span class="lineNum">    3604 </span>            :         /*try open file in read mode*/
<span class="lineNum">    3605 </span><span class="lineCov">       1226 :         if (!type &amp;&amp; gf_isom_probe_file(inName)) type = GF_FILE_TYPE_ISO_MEDIA;</span>
<span class="lineNum">    3606 </span>            :         return type;
<span class="lineNum">    3607 </span>            : }
<span class="lineNum">    3608 </span>            : 
<a name="3609"><span class="lineNum">    3609 </span>            : </a>
<span class="lineNum">    3610 </span>            : #ifndef GPAC_DISABLE_CORE_TOOLS
<span class="lineNum">    3611 </span><span class="lineCov">          1 : static GF_Err xml_bs_to_bin(char *inName, char *outName, u32 dump_std)</span>
<span class="lineNum">    3612 </span>            : {
<span class="lineNum">    3613 </span>            :         GF_Err e;
<span class="lineNum">    3614 </span>            :         GF_XMLNode *root;
<span class="lineNum">    3615 </span><span class="lineCov">          1 :         u8 *data = NULL;</span>
<span class="lineNum">    3616 </span>            :         u32 data_size;
<span class="lineNum">    3617 </span>            : 
<span class="lineNum">    3618 </span><span class="lineCov">          1 :         GF_DOMParser *dom = gf_xml_dom_new();</span>
<span class="lineNum">    3619 </span><span class="lineCov">          1 :         e = gf_xml_dom_parse(dom, inName, NULL, NULL);</span>
<span class="lineNum">    3620 </span><span class="lineCov">          1 :         if (e) {</span>
<span class="lineNum">    3621 </span><span class="lineNoCov">          0 :                 gf_xml_dom_del(dom);</span>
<span class="lineNum">    3622 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Failed to parse XML file: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    3623 </span>            :                 return e;
<span class="lineNum">    3624 </span>            :         }
<span class="lineNum">    3625 </span><span class="lineCov">          1 :         root = gf_xml_dom_get_root_idx(dom, 0);</span>
<span class="lineNum">    3626 </span><span class="lineCov">          1 :         if (!root) {</span>
<span class="lineNum">    3627 </span><span class="lineNoCov">          0 :                 gf_xml_dom_del(dom);</span>
<span class="lineNum">    3628 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    3629 </span>            :         }
<span class="lineNum">    3630 </span>            : 
<span class="lineNum">    3631 </span><span class="lineCov">          1 :         e = gf_xml_parse_bit_sequence(root, inName, &amp;data, &amp;data_size);</span>
<span class="lineNum">    3632 </span><span class="lineCov">          1 :         gf_xml_dom_del(dom);</span>
<span class="lineNum">    3633 </span>            : 
<span class="lineNum">    3634 </span><span class="lineCov">          1 :         if (e) {</span>
<span class="lineNum">    3635 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Failed to parse binary sequence: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    3636 </span>            :                 return e;
<span class="lineNum">    3637 </span>            :         }
<span class="lineNum">    3638 </span>            : 
<span class="lineNum">    3639 </span><span class="lineCov">          1 :         if (dump_std) {</span>
<span class="lineNum">    3640 </span><span class="lineNoCov">          0 :                 gf_fwrite(data, data_size, stdout);</span>
<span class="lineNum">    3641 </span>            :         } else {
<span class="lineNum">    3642 </span>            :                 FILE *t;
<span class="lineNum">    3643 </span>            :                 char szFile[GF_MAX_PATH];
<span class="lineNum">    3644 </span><span class="lineCov">          1 :                 if (outName) {</span>
<span class="lineNum">    3645 </span>            :                         strcpy(szFile, outName);
<span class="lineNum">    3646 </span>            :                 } else {
<span class="lineNum">    3647 </span>            :                         strcpy(szFile, inName);
<span class="lineNum">    3648 </span>            :                         strcat(szFile, &quot;.bin&quot;);
<span class="lineNum">    3649 </span>            :                 }
<span class="lineNum">    3650 </span><span class="lineCov">          1 :                 t = gf_fopen(szFile, &quot;wb&quot;);</span>
<span class="lineNum">    3651 </span><span class="lineCov">          1 :                 if (!t) {</span>
<span class="lineNum">    3652 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Failed to open file %s\n&quot;, szFile));</span>
<span class="lineNum">    3653 </span>            :                         e = GF_IO_ERR;
<span class="lineNum">    3654 </span>            :                 } else {
<span class="lineNum">    3655 </span><span class="lineCov">          1 :                         if (gf_fwrite(data, data_size, t) != data_size) {</span>
<span class="lineNum">    3656 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Failed to write output to file %s\n&quot;, szFile));</span>
<span class="lineNum">    3657 </span>            :                                 e = GF_IO_ERR;
<span class="lineNum">    3658 </span>            :                         }
<span class="lineNum">    3659 </span><span class="lineCov">          1 :                         gf_fclose(t);</span>
<span class="lineNum">    3660 </span>            :                 }
<span class="lineNum">    3661 </span>            :         }
<span class="lineNum">    3662 </span><span class="lineCov">          1 :         gf_free(data);</span>
<span class="lineNum">    3663 </span><span class="lineCov">          1 :         return e;</span>
<span class="lineNum">    3664 </span>            : }
<a name="3665"><span class="lineNum">    3665 </span>            : #endif /*GPAC_DISABLE_CORE_TOOLS*/</a>
<span class="lineNum">    3666 </span>            : 
<span class="lineNum">    3667 </span><span class="lineCov">          1 : static u64 do_size_top_boxes(char *inName, char *compress_top_boxes, u32 mode)</span>
<span class="lineNum">    3668 </span>            : {
<span class="lineNum">    3669 </span>            :         FILE *in;
<span class="lineNum">    3670 </span>            :         u64 top_size = 0;
<span class="lineNum">    3671 </span>            :         Bool do_all = GF_FALSE;
<span class="lineNum">    3672 </span>            :         GF_BitStream *bs_in;
<span class="lineNum">    3673 </span><span class="lineCov">          1 :         if (!compress_top_boxes) return GF_BAD_PARAM;</span>
<span class="lineNum">    3674 </span><span class="lineCov">          1 :         if (!strcmp(compress_top_boxes, &quot;all&quot;) || !strcmp(compress_top_boxes, &quot;*&quot;) || !strcmp(compress_top_boxes, &quot;@&quot;))</span>
<span class="lineNum">    3675 </span>            :                 do_all = GF_TRUE;
<span class="lineNum">    3676 </span>            : 
<span class="lineNum">    3677 </span><span class="lineCov">          1 :         in = gf_fopen(inName, &quot;rb&quot;);</span>
<span class="lineNum">    3678 </span><span class="lineCov">          1 :         if (!in) return GF_URL_ERROR;</span>
<span class="lineNum">    3679 </span><span class="lineCov">          1 :         bs_in = gf_bs_from_file(in, GF_BITSTREAM_READ);</span>
<span class="lineNum">    3680 </span><span class="lineCov">         27 :         while (gf_bs_available(bs_in)) {</span>
<span class="lineNum">    3681 </span>            :                 const char *stype;
<span class="lineNum">    3682 </span>            :                 u32 hdr_size = 8;
<span class="lineNum">    3683 </span><span class="lineCov">         25 :                 u64 lsize = gf_bs_read_u32(bs_in);</span>
<span class="lineNum">    3684 </span><span class="lineCov">         25 :                 u32 type = gf_bs_read_u32(bs_in);</span>
<span class="lineNum">    3685 </span>            : 
<span class="lineNum">    3686 </span><span class="lineCov">         25 :                 if (lsize==1) {</span>
<span class="lineNum">    3687 </span><span class="lineNoCov">          0 :                         lsize = gf_bs_read_u64(bs_in);</span>
<span class="lineNum">    3688 </span>            :                         hdr_size = 16;
<span class="lineNum">    3689 </span><span class="lineCov">         25 :                 } else if (lsize==0) {</span>
<span class="lineNum">    3690 </span><span class="lineNoCov">          0 :                         lsize = gf_bs_available(bs_in) + 8;</span>
<span class="lineNum">    3691 </span>            :                 }
<span class="lineNum">    3692 </span><span class="lineCov">         25 :                 stype = gf_4cc_to_str(type);</span>
<span class="lineNum">    3693 </span><span class="lineCov">         25 :                 if (do_all || strstr(compress_top_boxes, stype)) {</span>
<span class="lineNum">    3694 </span>            :                         //only count boxes
<span class="lineNum">    3695 </span><span class="lineCov">         11 :                         if (mode==2) {</span>
<span class="lineNum">    3696 </span><span class="lineNoCov">          0 :                                 top_size += 1;</span>
<span class="lineNum">    3697 </span>            :                         } else {
<span class="lineNum">    3698 </span><span class="lineCov">         11 :                                 top_size += lsize;</span>
<span class="lineNum">    3699 </span>            :                         }
<span class="lineNum">    3700 </span>            :                 }
<span class="lineNum">    3701 </span><span class="lineCov">         25 :                 gf_bs_skip_bytes(bs_in, lsize - hdr_size);</span>
<span class="lineNum">    3702 </span>            :         }
<span class="lineNum">    3703 </span><span class="lineCov">          1 :         gf_bs_del(bs_in);</span>
<span class="lineNum">    3704 </span><span class="lineCov">          1 :         gf_fclose(in);</span>
<span class="lineNum">    3705 </span><span class="lineCov">          1 :         return top_size;</span>
<span class="lineNum">    3706 </span>            : 
<a name="3707"><span class="lineNum">    3707 </span>            : }</a>
<span class="lineNum">    3708 </span>            : 
<span class="lineNum">    3709 </span><span class="lineCov">          1 : static GF_Err do_compress_top_boxes(char *inName, char *outName)</span>
<span class="lineNum">    3710 </span>            : {
<span class="lineNum">    3711 </span>            :         FILE *in, *out;
<span class="lineNum">    3712 </span>            :         u8 *buf;
<span class="lineNum">    3713 </span>            :         u32 buf_alloc, comp_size;
<span class="lineNum">    3714 </span>            :         s32 bytes_comp=0;
<span class="lineNum">    3715 </span>            :         s32 bytes_uncomp=0;
<span class="lineNum">    3716 </span>            :         GF_Err e = GF_OK;
<span class="lineNum">    3717 </span>            :         u64 source_size, dst_size;
<span class="lineNum">    3718 </span>            :         u32 orig_box_overhead;
<span class="lineNum">    3719 </span>            :         u32 final_box_overhead;
<span class="lineNum">    3720 </span>            :         u32 nb_added_box_bytes=0;
<span class="lineNum">    3721 </span>            :         Bool has_mov = GF_FALSE;
<span class="lineNum">    3722 </span><span class="lineCov">          1 :         Bool replace_all = !strcmp(compress_top_boxes, &quot;*&quot;);</span>
<span class="lineNum">    3723 </span>            :         GF_BitStream *bs_in, *bs_out;
<span class="lineNum">    3724 </span>            : 
<span class="lineNum">    3725 </span><span class="lineCov">          1 :         if (!outName) {</span>
<span class="lineNum">    3726 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Missing output file name\n&quot;));</span>
<span class="lineNum">    3727 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    3728 </span>            :         }
<span class="lineNum">    3729 </span>            : 
<span class="lineNum">    3730 </span><span class="lineCov">          1 :         in = gf_fopen(inName, &quot;rb&quot;);</span>
<span class="lineNum">    3731 </span><span class="lineCov">          1 :         if (!in) return GF_URL_ERROR;</span>
<span class="lineNum">    3732 </span><span class="lineCov">          1 :         out = gf_fopen(outName, &quot;wb&quot;);</span>
<span class="lineNum">    3733 </span><span class="lineCov">          1 :         if (!out) return GF_IO_ERR;</span>
<span class="lineNum">    3734 </span>            : 
<span class="lineNum">    3735 </span>            :         buf_alloc = 4096;
<span class="lineNum">    3736 </span><span class="lineCov">          1 :         buf = gf_malloc(buf_alloc);</span>
<span class="lineNum">    3737 </span>            : 
<span class="lineNum">    3738 </span><span class="lineCov">          1 :         bs_in = gf_bs_from_file(in, GF_BITSTREAM_READ);</span>
<span class="lineNum">    3739 </span><span class="lineCov">          1 :         source_size = gf_bs_get_size(bs_in);</span>
<span class="lineNum">    3740 </span>            : 
<span class="lineNum">    3741 </span><span class="lineCov">          1 :         bs_out = gf_bs_from_file(out, GF_BITSTREAM_WRITE);</span>
<span class="lineNum">    3742 </span>            : 
<span class="lineNum">    3743 </span>            :         orig_box_overhead = 0;
<span class="lineNum">    3744 </span>            :         final_box_overhead = 0;
<span class="lineNum">    3745 </span><span class="lineCov">         27 :         while (gf_bs_available(bs_in)) {</span>
<span class="lineNum">    3746 </span><span class="lineCov">         25 :                 u32 size = gf_bs_read_u32(bs_in);</span>
<span class="lineNum">    3747 </span><span class="lineCov">         25 :                 u32 type = gf_bs_read_u32(bs_in);</span>
<span class="lineNum">    3748 </span><span class="lineCov">         25 :                 const char *b4cc = gf_4cc_to_str(type);</span>
<span class="lineNum">    3749 </span><span class="lineCov">         25 :                 const u8 *replace = (const u8 *) strstr(compress_top_boxes, b4cc);</span>
<span class="lineNum">    3750 </span><span class="lineCov">         25 :                 if (!strcmp(b4cc, &quot;moov&quot;)) has_mov = GF_TRUE;</span>
<span class="lineNum">    3751 </span>            : 
<span class="lineNum">    3752 </span><span class="lineCov">         25 :                 if (!replace &amp;&amp; !replace_all) {</span>
<span class="lineNum">    3753 </span><span class="lineCov">         14 :                         gf_bs_write_u32(bs_out, size);</span>
<span class="lineNum">    3754 </span><span class="lineCov">         14 :                         gf_bs_write_u32(bs_out, type);</span>
<span class="lineNum">    3755 </span>            : 
<span class="lineNum">    3756 </span><span class="lineCov">         14 :                         size-=8;</span>
<span class="lineNum">    3757 </span><span class="lineCov">        103 :                         while (size) {</span>
<span class="lineNum">    3758 </span>            :                                 u32 nbytes = size;
<span class="lineNum">    3759 </span><span class="lineCov">         75 :                                 if (nbytes&gt;buf_alloc) nbytes=buf_alloc;</span>
<span class="lineNum">    3760 </span><span class="lineCov">         75 :                                 gf_bs_read_data(bs_in, buf, nbytes);</span>
<span class="lineNum">    3761 </span><span class="lineCov">         75 :                                 gf_bs_write_data(bs_out, buf, nbytes);</span>
<span class="lineNum">    3762 </span><span class="lineCov">         75 :                                 size-=nbytes;</span>
<span class="lineNum">    3763 </span>            :                         }
<span class="lineNum">    3764 </span><span class="lineCov">         14 :                         continue;</span>
<span class="lineNum">    3765 </span>            :                 }
<span class="lineNum">    3766 </span><span class="lineCov">         11 :                 orig_box_overhead += size;</span>
<span class="lineNum">    3767 </span>            : 
<span class="lineNum">    3768 </span><span class="lineCov">         11 :                 size-=8;</span>
<span class="lineNum">    3769 </span>            : 
<span class="lineNum">    3770 </span><span class="lineCov">         11 :                 if (size&gt;buf_alloc) {</span>
<span class="lineNum">    3771 </span>            :                         buf_alloc = size;
<span class="lineNum">    3772 </span><span class="lineNoCov">          0 :                         buf = gf_realloc(buf, buf_alloc);</span>
<span class="lineNum">    3773 </span>            :                 }
<span class="lineNum">    3774 </span><span class="lineCov">         11 :                 gf_bs_read_data(bs_in, buf, size);</span>
<span class="lineNum">    3775 </span>            : 
<span class="lineNum">    3776 </span><span class="lineCov">         11 :                 replace+=5;</span>
<span class="lineNum">    3777 </span>            : 
<span class="lineNum">    3778 </span><span class="lineCov">         11 :                 comp_size = buf_alloc;</span>
<span class="lineNum">    3779 </span>            : 
<span class="lineNum">    3780 </span><span class="lineCov">         11 :                 e = gf_gz_compress_payload(&amp;buf, size, &amp;comp_size);</span>
<span class="lineNum">    3781 </span><span class="lineCov">         11 :                 if (e) break;</span>
<span class="lineNum">    3782 </span>            : 
<span class="lineNum">    3783 </span><span class="lineCov">         11 :                 if (comp_size&gt;buf_alloc) {</span>
<span class="lineNum">    3784 </span>            :                         buf_alloc = comp_size;
<span class="lineNum">    3785 </span>            :                 }
<span class="lineNum">    3786 </span><span class="lineCov">         11 :                 bytes_uncomp += size;</span>
<span class="lineNum">    3787 </span><span class="lineCov">         11 :                 bytes_comp += comp_size;</span>
<span class="lineNum">    3788 </span>            : 
<span class="lineNum">    3789 </span>            :                 //write size
<span class="lineNum">    3790 </span><span class="lineCov">         11 :                 gf_bs_write_u32(bs_out, comp_size+8);</span>
<span class="lineNum">    3791 </span>            :                 //write type
<span class="lineNum">    3792 </span><span class="lineCov">         11 :                 gf_bs_write_data(bs_out, replace, 4);</span>
<span class="lineNum">    3793 </span>            :                 //write data
<span class="lineNum">    3794 </span><span class="lineCov">         11 :                 gf_bs_write_data(bs_out, buf, comp_size);</span>
<span class="lineNum">    3795 </span>            : 
<span class="lineNum">    3796 </span><span class="lineCov">         11 :                 final_box_overhead += 8+comp_size;</span>
<span class="lineNum">    3797 </span>            :         }
<span class="lineNum">    3798 </span><span class="lineCov">          1 :         dst_size = gf_bs_get_position(bs_out);</span>
<span class="lineNum">    3799 </span>            : 
<span class="lineNum">    3800 </span><span class="lineCov">          1 :         if (buf) gf_free(buf);</span>
<span class="lineNum">    3801 </span><span class="lineCov">          1 :         gf_bs_del(bs_in);</span>
<span class="lineNum">    3802 </span><span class="lineCov">          1 :         gf_bs_del(bs_out);</span>
<span class="lineNum">    3803 </span><span class="lineCov">          1 :         gf_fclose(in);</span>
<span class="lineNum">    3804 </span><span class="lineCov">          1 :         gf_fclose(out);</span>
<span class="lineNum">    3805 </span><span class="lineCov">          1 :         if (e) {</span>
<span class="lineNum">    3806 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Error compressing: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    3807 </span>            :                 return e;
<span class="lineNum">    3808 </span>            :         }
<span class="lineNum">    3809 </span>            : 
<span class="lineNum">    3810 </span><span class="lineCov">          1 :         if (has_mov) {</span>
<span class="lineNum">    3811 </span>            :                 u32 i, nb_tracks, nb_samples;
<span class="lineNum">    3812 </span>            :                 GF_ISOFile *mov;
<span class="lineNum">    3813 </span>            :                 Double rate, new_rate, duration;
<span class="lineNum">    3814 </span>            : 
<span class="lineNum">    3815 </span><span class="lineCov">          1 :                 mov = gf_isom_open(inName, GF_ISOM_OPEN_READ, NULL);</span>
<span class="lineNum">    3816 </span><span class="lineCov">          1 :                 duration = (Double) gf_isom_get_duration(mov);</span>
<span class="lineNum">    3817 </span><span class="lineCov">          1 :                 duration /= gf_isom_get_timescale(mov);</span>
<span class="lineNum">    3818 </span>            : 
<span class="lineNum">    3819 </span>            :                 nb_samples = 0;
<span class="lineNum">    3820 </span><span class="lineCov">          1 :                 nb_tracks = gf_isom_get_track_count(mov);</span>
<span class="lineNum">    3821 </span><span class="lineCov">          4 :                 for (i=0; i&lt;nb_tracks; i++) {</span>
<span class="lineNum">    3822 </span><span class="lineCov">          2 :                         nb_samples += gf_isom_get_sample_count(mov, i+1);</span>
<span class="lineNum">    3823 </span>            :                 }
<span class="lineNum">    3824 </span><span class="lineCov">          1 :                 gf_isom_close(mov);</span>
<span class="lineNum">    3825 </span>            : 
<span class="lineNum">    3826 </span><span class="lineCov">          1 :                 rate = (Double) source_size;</span>
<span class="lineNum">    3827 </span><span class="lineCov">          1 :                 rate /= duration;</span>
<span class="lineNum">    3828 </span><span class="lineCov">          1 :                 rate /= 1000;</span>
<span class="lineNum">    3829 </span>            : 
<span class="lineNum">    3830 </span><span class="lineCov">          1 :                 new_rate = (Double) dst_size;</span>
<span class="lineNum">    3831 </span><span class="lineCov">          1 :                 new_rate /= duration;</span>
<span class="lineNum">    3832 </span><span class="lineCov">          1 :                 new_rate /= 1000;</span>
<span class="lineNum">    3833 </span>            : 
<span class="lineNum">    3834 </span>            : 
<span class="lineNum">    3835 </span><span class="lineCov">          1 :                 fprintf(stderr, &quot;Log format:\nname\torig\tcomp\tgain\tadded_bytes\torate\tcrate\tsamples\tduration\tobbps\tcbbps\n&quot;);</span>
<span class="lineNum">    3836 </span><span class="lineCov">          1 :                 fprintf(stdout, &quot;%s\t%d\t%d\t%g\t%d\t%g\t%g\t%d\t%g\t%g\t%g\n&quot;, inName, bytes_uncomp, bytes_comp, ((Double)(bytes_uncomp-bytes_comp)*100)/bytes_uncomp, nb_added_box_bytes, rate, new_rate, nb_samples, duration, ((Double)orig_box_overhead)/nb_samples, ((Double)final_box_overhead)/nb_samples );</span>
<span class="lineNum">    3837 </span>            : 
<span class="lineNum">    3838 </span><span class="lineCov">          1 :                 fprintf(stderr, &quot;%s Compressing top-level boxes saved %d bytes out of %d (reduced by %g %%) additional bytes %d original rate %g kbps new rate %g kbps, orig %g box bytes/sample final %g bytes/sample\n&quot;, inName, bytes_uncomp-bytes_comp, bytes_uncomp, ((Double)(bytes_uncomp-bytes_comp)*100)/bytes_uncomp, nb_added_box_bytes, rate, new_rate, ((Double)orig_box_overhead)/nb_samples, ((Double)final_box_overhead)/nb_samples );</span>
<span class="lineNum">    3839 </span>            : 
<span class="lineNum">    3840 </span>            :         } else {
<span class="lineNum">    3841 </span><span class="lineNoCov">          0 :                 fprintf(stderr, &quot;Log format:\nname\torig\tcomp\tgain\tadded_bytes\n&quot;);</span>
<span class="lineNum">    3842 </span><span class="lineNoCov">          0 :                 fprintf(stdout, &quot;%s\t%d\t%d\t%g\t%d\n&quot;, inName, bytes_uncomp, bytes_comp, ((Double) (bytes_uncomp - bytes_comp)*100)/(bytes_uncomp), nb_added_box_bytes);</span>
<span class="lineNum">    3843 </span>            : 
<span class="lineNum">    3844 </span><span class="lineNoCov">          0 :                 fprintf(stderr, &quot;%s Compressing top-level boxes saved %d bytes out of %d (reduced by %g %%) additional bytes %d\n&quot;, inName, bytes_uncomp-bytes_comp, bytes_uncomp, ((Double)(bytes_uncomp-bytes_comp)*100)/bytes_uncomp, nb_added_box_bytes);</span>
<span class="lineNum">    3845 </span>            : 
<span class="lineNum">    3846 </span>            :         }
<span class="lineNum">    3847 </span>            :         return GF_OK;
<a name="3848"><span class="lineNum">    3848 </span>            : }</a>
<span class="lineNum">    3849 </span>            : 
<span class="lineNum">    3850 </span><span class="lineCov">       2686 : static GF_Err hash_file(char *name, u32 dump_std)</span>
<span class="lineNum">    3851 </span>            : {
<span class="lineNum">    3852 </span>            :         u32 i;
<span class="lineNum">    3853 </span>            :         u8 hash[20];
<span class="lineNum">    3854 </span><span class="lineCov">       2686 :         GF_Err e = gf_media_get_file_hash(name, hash);</span>
<span class="lineNum">    3855 </span><span class="lineCov">       2686 :         if (e) return e;</span>
<span class="lineNum">    3856 </span><span class="lineCov">       2676 :         if (dump_std==2) {</span>
<span class="lineNum">    3857 </span><span class="lineCov">       2676 :                 gf_fwrite(hash, 20, stdout);</span>
<span class="lineNum">    3858 </span><span class="lineNoCov">          0 :         } else if (dump_std==1) {</span>
<span class="lineNum">    3859 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;20; i++) fprintf(stdout, &quot;%02X&quot;, hash[i]);</span>
<span class="lineNum">    3860 </span>            :         }
<span class="lineNum">    3861 </span><span class="lineCov">       2676 :         fprintf(stderr, &quot;File hash (SHA-1): &quot;);</span>
<span class="lineNum">    3862 </span><span class="lineCov">      56196 :         for (i=0; i&lt;20; i++) fprintf(stderr, &quot;%02X&quot;, hash[i]);</span>
<span class="lineNum">    3863 </span><span class="lineCov">       2676 :         fprintf(stderr, &quot;\n&quot;);</span>
<span class="lineNum">    3864 </span>            : 
<span class="lineNum">    3865 </span><span class="lineCov">       2676 :         return GF_OK;</span>
<a name="3866"><span class="lineNum">    3866 </span>            : }</a>
<span class="lineNum">    3867 </span>            : 
<span class="lineNum">    3868 </span><span class="lineNoCov">          0 : static u32 do_raw_cat()</span>
<span class="lineNum">    3869 </span>            : {
<span class="lineNum">    3870 </span>            :         char chunk[4096];
<span class="lineNum">    3871 </span>            :         FILE *fin, *fout;
<span class="lineNum">    3872 </span>            :         s64 to_copy, done;
<span class="lineNum">    3873 </span><span class="lineNoCov">          0 :         fin = gf_fopen(raw_cat, &quot;rb&quot;);</span>
<span class="lineNum">    3874 </span><span class="lineNoCov">          0 :         if (!fin) return mp4box_cleanup(1);</span>
<span class="lineNum">    3875 </span>            : 
<span class="lineNum">    3876 </span><span class="lineNoCov">          0 :         fout = gf_fopen(inName, &quot;a+b&quot;);</span>
<span class="lineNum">    3877 </span><span class="lineNoCov">          0 :         if (!fout) {</span>
<span class="lineNum">    3878 </span><span class="lineNoCov">          0 :                 gf_fclose(fin);</span>
<span class="lineNum">    3879 </span><span class="lineNoCov">          0 :                 return mp4box_cleanup(1);</span>
<span class="lineNum">    3880 </span>            :         }
<span class="lineNum">    3881 </span><span class="lineNoCov">          0 :         gf_fseek(fin, 0, SEEK_END);</span>
<span class="lineNum">    3882 </span><span class="lineNoCov">          0 :         to_copy = gf_ftell(fin);</span>
<span class="lineNum">    3883 </span><span class="lineNoCov">          0 :         gf_fseek(fin, 0, SEEK_SET);</span>
<span class="lineNum">    3884 </span>            :         done = 0;
<span class="lineNum">    3885 </span>            :         while (1) {
<span class="lineNum">    3886 </span><span class="lineNoCov">          0 :                 u32 nb_bytes = (u32) gf_fread(chunk, 4096, fin);</span>
<span class="lineNum">    3887 </span><span class="lineNoCov">          0 :                 gf_fwrite(chunk, nb_bytes, fout);</span>
<span class="lineNum">    3888 </span><span class="lineNoCov">          0 :                 done += nb_bytes;</span>
<span class="lineNum">    3889 </span><span class="lineNoCov">          0 :                 fprintf(stderr, &quot;Appending file %s - %02.2f done\r&quot;, raw_cat, 100.0*done/to_copy);</span>
<span class="lineNum">    3890 </span><span class="lineNoCov">          0 :                 if (done &gt;= to_copy) break;</span>
<span class="lineNum">    3891 </span>            :         }
<span class="lineNum">    3892 </span><span class="lineNoCov">          0 :         gf_fclose(fin);</span>
<span class="lineNum">    3893 </span><span class="lineNoCov">          0 :         gf_fclose(fout);</span>
<span class="lineNum">    3894 </span><span class="lineNoCov">          0 :         return mp4box_cleanup(0);</span>
<a name="3895"><span class="lineNum">    3895 </span>            : }</a>
<span class="lineNum">    3896 </span>            : 
<span class="lineNum">    3897 </span><span class="lineNoCov">          0 : static u32 do_write_udp()</span>
<span class="lineNum">    3898 </span>            : {
<span class="lineNum">    3899 </span>            :         GF_Err e;
<span class="lineNum">    3900 </span><span class="lineNoCov">          0 :         GF_Socket *sock = gf_sk_new(GF_SOCK_TYPE_UDP);</span>
<span class="lineNum">    3901 </span>            :         u16 port = 2345;
<span class="lineNum">    3902 </span><span class="lineNoCov">          0 :         char *sep = strrchr(udp_dest, ':');</span>
<span class="lineNum">    3903 </span><span class="lineNoCov">          0 :         if (sep) {</span>
<span class="lineNum">    3904 </span><span class="lineNoCov">          0 :                 sep[0] = 0;</span>
<span class="lineNum">    3905 </span><span class="lineNoCov">          0 :                 port = atoi(sep+1);</span>
<span class="lineNum">    3906 </span>            :         }
<span class="lineNum">    3907 </span><span class="lineNoCov">          0 :         e = gf_sk_bind( sock, &quot;127.0.0.1&quot;, 0, udp_dest, port, 0);</span>
<span class="lineNum">    3908 </span><span class="lineNoCov">          0 :         if (sep) sep[0] = ':';</span>
<span class="lineNum">    3909 </span><span class="lineNoCov">          0 :         if (e) {</span>
<span class="lineNum">    3910 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Failed to bind socket to %s: %s\n&quot;, udp_dest, gf_error_to_string(e) ));</span>
<span class="lineNum">    3911 </span>            :         } else {
<span class="lineNum">    3912 </span><span class="lineNoCov">          0 :                 e = gf_sk_send(sock, (u8 *) inName, (u32)strlen(inName));</span>
<span class="lineNum">    3913 </span><span class="lineNoCov">          0 :                 if (e)</span>
<span class="lineNum">    3914 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Failed to send datagram: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    3915 </span>            :         }
<span class="lineNum">    3916 </span><span class="lineNoCov">          0 :         gf_sk_del(sock);</span>
<span class="lineNum">    3917 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    3918 </span>            : }
<a name="3919"><span class="lineNum">    3919 </span>            : </a>
<span class="lineNum">    3920 </span>            : #ifndef GPAC_DISABLE_MPD
<span class="lineNum">    3921 </span><span class="lineCov">          3 : static u32 convert_mpd()</span>
<span class="lineNum">    3922 </span>            : {
<span class="lineNum">    3923 </span>            :         GF_Err e;
<span class="lineNum">    3924 </span>            :         Bool remote = GF_FALSE;
<span class="lineNum">    3925 </span>            :         GF_MPD *mpd;
<span class="lineNum">    3926 </span><span class="lineCov">          3 :         char *mpd_base_url = NULL;</span>
<span class="lineNum">    3927 </span><span class="lineCov">          3 :         if (!strnicmp(inName, &quot;http://&quot;, 7) || !strnicmp(inName, &quot;https://&quot;, 8)) {</span>
<span class="lineNum">    3928 </span>            : #if !defined(GPAC_DISABLE_CORE_TOOLS)
<span class="lineNum">    3929 </span><span class="lineNoCov">          0 :                 e = gf_dm_wget(inName, &quot;tmp_main.m3u8&quot;, 0, 0, &amp;mpd_base_url);</span>
<span class="lineNum">    3930 </span><span class="lineNoCov">          0 :                 if (e != GF_OK) {</span>
<span class="lineNum">    3931 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Cannot retrieve M3U8 (%s): %s\n&quot;, inName, gf_error_to_string(e)));</span>
<span class="lineNum">    3932 </span><span class="lineNoCov">          0 :                         if (mpd_base_url) gf_free(mpd_base_url);</span>
<span class="lineNum">    3933 </span><span class="lineNoCov">          0 :                         return mp4box_cleanup(1);</span>
<span class="lineNum">    3934 </span>            :                 }
<span class="lineNum">    3935 </span>            :                 remote = GF_TRUE;
<span class="lineNum">    3936 </span>            : #else
<span class="lineNum">    3937 </span>            :                 gf_free(mpd_base_url);
<span class="lineNum">    3938 </span>            :                 M4_LOG(GF_LOG_ERROR, (&quot;HTTP Downloader disabled in this build\n&quot;));
<span class="lineNum">    3939 </span>            :                 return mp4box_cleanup(1);
<span class="lineNum">    3940 </span>            : #endif
<span class="lineNum">    3941 </span>            : 
<span class="lineNum">    3942 </span><span class="lineNoCov">          0 :                 if (outName)</span>
<span class="lineNum">    3943 </span>            :                         strcpy(outfile, outName);
<span class="lineNum">    3944 </span>            :                 else {
<span class="lineNum">    3945 </span><span class="lineNoCov">          0 :                         const char *sep = gf_file_basename(inName);</span>
<span class="lineNum">    3946 </span><span class="lineNoCov">          0 :                         char *ext = gf_file_ext_start(sep);</span>
<span class="lineNum">    3947 </span><span class="lineNoCov">          0 :                         if (ext) ext[0] = 0;</span>
<span class="lineNum">    3948 </span>            :                         sprintf(outfile, &quot;%s.mpd&quot;, sep);
<span class="lineNum">    3949 </span><span class="lineNoCov">          0 :                         if (ext) ext[0] = '.';</span>
<span class="lineNum">    3950 </span>            :                 }
<span class="lineNum">    3951 </span>            :         } else {
<span class="lineNum">    3952 </span><span class="lineCov">          3 :                 if (outName)</span>
<span class="lineNum">    3953 </span>            :                         strcpy(outfile, outName);
<span class="lineNum">    3954 </span>            :                 else {
<span class="lineNum">    3955 </span><span class="lineNoCov">          0 :                         char *dst = strdup(inName);</span>
<span class="lineNum">    3956 </span><span class="lineNoCov">          0 :                         char *ext = strstr(dst, &quot;.m3u8&quot;);</span>
<span class="lineNum">    3957 </span><span class="lineNoCov">          0 :                         if (ext) ext[0] = 0;</span>
<span class="lineNum">    3958 </span>            :                         sprintf(outfile, &quot;%s.mpd&quot;, dst);
<span class="lineNum">    3959 </span><span class="lineNoCov">          0 :                         gf_free(dst);</span>
<span class="lineNum">    3960 </span>            :                 }
<span class="lineNum">    3961 </span>            :         }
<span class="lineNum">    3962 </span>            : 
<span class="lineNum">    3963 </span><span class="lineCov">          3 :         mpd = gf_mpd_new();</span>
<span class="lineNum">    3964 </span><span class="lineCov">          3 :         if (!mpd) {</span>
<span class="lineNum">    3965 </span>            :                 e = GF_OUT_OF_MEM;
<span class="lineNum">    3966 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;[DASH] Error: MPD creation problem %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    3967 </span><span class="lineNoCov">          0 :                 mp4box_cleanup(1);</span>
<span class="lineNum">    3968 </span>            :         }
<span class="lineNum">    3969 </span><span class="lineCov">          3 :         FILE *f = gf_fopen(remote ? &quot;tmp_main.m3u8&quot; : inName, &quot;r&quot;);</span>
<span class="lineNum">    3970 </span>            :         u32 manif_type = 0;
<span class="lineNum">    3971 </span><span class="lineCov">          3 :         if (f) {</span>
<span class="lineNum">    3972 </span>            :                 char szDATA[1000];
<span class="lineNum">    3973 </span>            :                 s32 read;
<span class="lineNum">    3974 </span><span class="lineCov">          3 :                 szDATA[999]=0;</span>
<span class="lineNum">    3975 </span><span class="lineCov">          3 :                 read = (s32) gf_fread(szDATA, 999, f);</span>
<span class="lineNum">    3976 </span><span class="lineCov">          3 :                 if (read&lt;0) read = 0;</span>
<span class="lineNum">    3977 </span><span class="lineCov">          3 :                 szDATA[read]=0;</span>
<span class="lineNum">    3978 </span><span class="lineCov">          3 :                 gf_fclose(f);</span>
<span class="lineNum">    3979 </span><span class="lineCov">          3 :                 if (strstr(szDATA, &quot;SmoothStreamingMedia&quot;))</span>
<span class="lineNum">    3980 </span>            :                         manif_type = 2;
<span class="lineNum">    3981 </span><span class="lineCov">          2 :                 else if (strstr(szDATA, &quot;#EXTM3U&quot;))</span>
<span class="lineNum">    3982 </span>            :                         manif_type = 1;
<span class="lineNum">    3983 </span>            :         }
<span class="lineNum">    3984 </span>            : 
<span class="lineNum">    3985 </span>            :         if (manif_type==1) {
<span class="lineNum">    3986 </span><span class="lineCov">          2 :                 e = gf_m3u8_to_mpd(remote ? &quot;tmp_main.m3u8&quot; : inName, mpd_base_url ? mpd_base_url : inName, outfile, 0, &quot;video/mp2t&quot;, GF_TRUE, use_url_template, segment_timeline, NULL, mpd, GF_TRUE, GF_TRUE);</span>
<span class="lineNum">    3987 </span><span class="lineCov">          1 :         } else if (manif_type==2) {</span>
<span class="lineNum">    3988 </span><span class="lineCov">          1 :                 e = gf_mpd_smooth_to_mpd(remote ? &quot;tmp_main.m3u8&quot; : inName, mpd, mpd_base_url ? mpd_base_url : inName);</span>
<span class="lineNum">    3989 </span>            :         } else {
<span class="lineNum">    3990 </span>            :                 e = GF_NOT_SUPPORTED;
<span class="lineNum">    3991 </span>            :         }
<span class="lineNum">    3992 </span><span class="lineCov">          3 :         if (!e)</span>
<span class="lineNum">    3993 </span><span class="lineCov">          3 :                 gf_mpd_write_file(mpd, outfile);</span>
<span class="lineNum">    3994 </span>            : 
<span class="lineNum">    3995 </span><span class="lineCov">          3 :         if (mpd)</span>
<span class="lineNum">    3996 </span><span class="lineCov">          3 :                 gf_mpd_del(mpd);</span>
<span class="lineNum">    3997 </span><span class="lineCov">          3 :         if (mpd_base_url)</span>
<span class="lineNum">    3998 </span><span class="lineNoCov">          0 :                 gf_free(mpd_base_url);</span>
<span class="lineNum">    3999 </span>            : 
<span class="lineNum">    4000 </span><span class="lineCov">          3 :         if (remote) {</span>
<span class="lineNum">    4001 </span><span class="lineNoCov">          0 :                 gf_file_delete(&quot;tmp_main.m3u8&quot;);</span>
<span class="lineNum">    4002 </span>            :         }
<span class="lineNum">    4003 </span><span class="lineCov">          3 :         if (e != GF_OK) {</span>
<span class="lineNum">    4004 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Error converting %s (%s) to MPD (%s): %s\n&quot;, (manif_type==1) ? &quot;HLS&quot; : &quot;Smooth&quot;,  inName, outfile, gf_error_to_string(e)));</span>
<span class="lineNum">    4005 </span><span class="lineNoCov">          0 :                 return mp4box_cleanup(1);</span>
<span class="lineNum">    4006 </span>            :         } else {
<span class="lineNum">    4007 </span><span class="lineCov">          3 :                 M4_LOG(GF_LOG_INFO, (&quot;Done converting %s (%s) to MPD (%s)\n&quot;, (manif_type==1) ? &quot;HLS&quot; : &quot;Smooth&quot;,  inName, outfile));</span>
<span class="lineNum">    4008 </span><span class="lineCov">          3 :                 return mp4box_cleanup(0);</span>
<span class="lineNum">    4009 </span>            :         }
<span class="lineNum">    4010 </span>            : }
<a name="4011"><span class="lineNum">    4011 </span>            : #endif</a>
<span class="lineNum">    4012 </span>            : 
<span class="lineNum">    4013 </span><span class="lineCov">          6 : static u32 do_import_sub()</span>
<span class="lineNum">    4014 </span>            : {
<span class="lineNum">    4015 </span>            :         /* We import the subtitle file,
<span class="lineNum">    4016 </span>            :            i.e. we parse it and store the content as samples of a 3GPP Timed Text track in an ISO file,
<span class="lineNum">    4017 </span>            :            possibly for later export (e.g. when converting SRT to TTXT, ...) */
<span class="lineNum">    4018 </span>            : #ifndef GPAC_DISABLE_MEDIA_IMPORT
<span class="lineNum">    4019 </span>            :         GF_Err e;
<span class="lineNum">    4020 </span>            :         GF_MediaImporter import;
<span class="lineNum">    4021 </span>            :         /* Prepare the importer */
<span class="lineNum">    4022 </span><span class="lineCov">          6 :         file = gf_isom_open(&quot;ttxt_convert&quot;, GF_ISOM_OPEN_WRITE, NULL);</span>
<span class="lineNum">    4023 </span><span class="lineCov">          6 :         if (timescale &amp;&amp; file) gf_isom_set_timescale(file, timescale);</span>
<span class="lineNum">    4024 </span>            : 
<span class="lineNum">    4025 </span>            :         memset(&amp;import, 0, sizeof(GF_MediaImporter));
<span class="lineNum">    4026 </span><span class="lineCov">          6 :         import.dest = file;</span>
<span class="lineNum">    4027 </span><span class="lineCov">          6 :         import.in_name = inName;</span>
<span class="lineNum">    4028 </span>            :         /* Start the import */
<span class="lineNum">    4029 </span><span class="lineCov">          6 :         e = gf_media_import(&amp;import);</span>
<span class="lineNum">    4030 </span><span class="lineCov">          6 :         if (e) {</span>
<span class="lineNum">    4031 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Error importing %s: %s\n&quot;, inName, gf_error_to_string(e)));</span>
<span class="lineNum">    4032 </span><span class="lineNoCov">          0 :                 gf_isom_delete(file);</span>
<span class="lineNum">    4033 </span><span class="lineNoCov">          0 :                 gf_file_delete(&quot;ttxt_convert&quot;);</span>
<span class="lineNum">    4034 </span><span class="lineNoCov">          0 :                 return mp4box_cleanup(1);</span>
<span class="lineNum">    4035 </span>            :         }
<span class="lineNum">    4036 </span>            :         /* Prepare the export */
<span class="lineNum">    4037 </span><span class="lineCov">          6 :         strcpy(outfile, inName);</span>
<span class="lineNum">    4038 </span><span class="lineCov">          6 :         if (strchr(outfile, '.')) {</span>
<span class="lineNum">    4039 </span><span class="lineCov">         20 :                 while (outfile[strlen(outfile)-1] != '.') outfile[strlen(outfile)-1] = 0;</span>
<span class="lineNum">    4040 </span><span class="lineCov">          6 :                 outfile[strlen(outfile)-1] = 0;</span>
<span class="lineNum">    4041 </span>            :         }
<span class="lineNum">    4042 </span>            : #ifndef GPAC_DISABLE_ISOM_DUMP
<span class="lineNum">    4043 </span>            :         /* Start the export of the track #1, in the appropriate dump type, indicating it's a conversion */
<span class="lineNum">    4044 </span><span class="lineCov">         24 :         dump_isom_timed_text(file, gf_isom_get_track_id(file, 1),</span>
<span class="lineNum">    4045 </span><span class="lineCov">         12 :                                                   dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE,</span>
<span class="lineNum">    4046 </span>            :                                                   GF_TRUE,
<span class="lineNum">    4047 </span><span class="lineCov">         10 :                                                   (import_subtitle==2) ? GF_TEXTDUMPTYPE_SVG : (dump_srt ? GF_TEXTDUMPTYPE_SRT : GF_TEXTDUMPTYPE_TTXT));</span>
<span class="lineNum">    4048 </span>            : #endif
<span class="lineNum">    4049 </span>            :         /* Clean the importer */
<span class="lineNum">    4050 </span><span class="lineCov">          6 :         gf_isom_delete(file);</span>
<span class="lineNum">    4051 </span><span class="lineCov">          6 :         gf_file_delete(&quot;ttxt_convert&quot;);</span>
<span class="lineNum">    4052 </span>            :         if (e) {
<span class="lineNum">    4053 </span>            :                 M4_LOG(GF_LOG_ERROR, (&quot;Error converting %s: %s\n&quot;, inName, gf_error_to_string(e)));
<span class="lineNum">    4054 </span>            :                 return mp4box_cleanup(1);
<span class="lineNum">    4055 </span>            :         }
<span class="lineNum">    4056 </span><span class="lineCov">          6 :         return mp4box_cleanup(0);</span>
<span class="lineNum">    4057 </span>            : #else
<span class="lineNum">    4058 </span>            :         M4_LOG(GF_LOG_ERROR, (&quot;Feature not supported\n&quot;));
<span class="lineNum">    4059 </span>            :         return mp4box_cleanup(1);
<span class="lineNum">    4060 </span>            : #endif
<span class="lineNum">    4061 </span>            : }
<a name="4062"><span class="lineNum">    4062 </span>            : </a>
<span class="lineNum">    4063 </span>            : #if !defined(GPAC_DISABLE_MEDIA_IMPORT) &amp;&amp; !defined(GPAC_DISABLE_ISOM_WRITE)
<span class="lineNum">    4064 </span><span class="lineCov">        455 : static u32 do_add_cat(int argc, char **argv)</span>
<span class="lineNum">    4065 </span>            : {
<span class="lineNum">    4066 </span>            :         GF_Err e;
<span class="lineNum">    4067 </span>            :         u32 i, ipass, nb_pass = 1;
<span class="lineNum">    4068 </span><span class="lineCov">        455 :         char *mux_args=NULL;</span>
<span class="lineNum">    4069 </span>            :         GF_FilterSession *fs = NULL;
<span class="lineNum">    4070 </span><span class="lineCov">        455 :         if (nb_add) {</span>
<span class="lineNum">    4071 </span>            : 
<span class="lineNum">    4072 </span>            :                 GF_ISOOpenMode open_mode = GF_ISOM_OPEN_EDIT;
<span class="lineNum">    4073 </span><span class="lineCov">        446 :                 if (force_new) {</span>
<span class="lineNum">    4074 </span><span class="lineCov">        445 :                         open_mode = (do_flat || (force_new==2)) ? GF_ISOM_OPEN_WRITE : GF_ISOM_WRITE_EDIT;</span>
<span class="lineNum">    4075 </span>            :                 } else {
<span class="lineNum">    4076 </span><span class="lineCov">          1 :                         FILE *test = gf_fopen(inName, &quot;rb&quot;);</span>
<span class="lineNum">    4077 </span><span class="lineCov">          1 :                         if (!test) {</span>
<span class="lineNum">    4078 </span><span class="lineCov">          1 :                                 open_mode = (do_flat) ? GF_ISOM_OPEN_WRITE : GF_ISOM_WRITE_EDIT;</span>
<span class="lineNum">    4079 </span><span class="lineCov">          1 :                                 if (!outName) outName = inName;</span>
<span class="lineNum">    4080 </span>            :                         } else {
<span class="lineNum">    4081 </span><span class="lineNoCov">          0 :                                 gf_fclose(test);</span>
<span class="lineNum">    4082 </span><span class="lineNoCov">          0 :                                 if (! gf_isom_probe_file(inName) ) {</span>
<span class="lineNum">    4083 </span><span class="lineNoCov">          0 :                                         open_mode = (do_flat) ? GF_ISOM_OPEN_WRITE : GF_ISOM_WRITE_EDIT;</span>
<span class="lineNum">    4084 </span><span class="lineNoCov">          0 :                                         if (!outName) outName = inName;</span>
<span class="lineNum">    4085 </span>            :                                 }
<span class="lineNum">    4086 </span>            :                         }
<span class="lineNum">    4087 </span>            :                 }
<span class="lineNum">    4088 </span><span class="lineCov">        446 :                 open_edit = do_flat ? GF_FALSE : GF_TRUE;</span>
<span class="lineNum">    4089 </span><span class="lineCov">        446 :                 file = gf_isom_open(inName, open_mode, NULL);</span>
<span class="lineNum">    4090 </span><span class="lineCov">        446 :                 if (!file) {</span>
<span class="lineNum">    4091 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Cannot open destination file %s: %s\n&quot;, inName, gf_error_to_string(gf_isom_last_error(NULL)) ));</span>
<span class="lineNum">    4092 </span><span class="lineNoCov">          0 :                         return mp4box_cleanup(1);</span>
<span class="lineNum">    4093 </span>            :                 }
<span class="lineNum">    4094 </span>            : 
<span class="lineNum">    4095 </span><span class="lineCov">        446 :                 if (freeze_box_order)</span>
<span class="lineNum">    4096 </span><span class="lineCov">          4 :                         gf_isom_freeze_order(file);</span>
<span class="lineNum">    4097 </span>            : 
<span class="lineNum">    4098 </span><span class="lineCov">        446 :                 if (do_flat) {</span>
<span class="lineNum">    4099 </span><span class="lineCov">          2 :                         if (major_brand)</span>
<span class="lineNum">    4100 </span><span class="lineNoCov">          0 :                                 gf_isom_set_brand_info(file, major_brand, minor_version);</span>
<span class="lineNum">    4101 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;nb_alt_brand_add; i++) {</span>
<span class="lineNum">    4102 </span><span class="lineNoCov">          0 :                                 gf_isom_modify_alternate_brand(file, brand_add[i], GF_TRUE);</span>
<span class="lineNum">    4103 </span><span class="lineNoCov">          0 :                                 do_save = GF_TRUE;</span>
<span class="lineNum">    4104 </span>            :                         }
<span class="lineNum">    4105 </span>            : 
<span class="lineNum">    4106 </span><span class="lineCov">          2 :                         if (!major_brand &amp;&amp; !nb_alt_brand_add &amp;&amp; has_add_image) {</span>
<span class="lineNum">    4107 </span><span class="lineNoCov">          0 :                                 gf_isom_modify_alternate_brand(file, GF_ISOM_BRAND_MIF1, GF_TRUE);</span>
<span class="lineNum">    4108 </span>            :                         }
<span class="lineNum">    4109 </span>            :                 }
<span class="lineNum">    4110 </span>            :         }
<span class="lineNum">    4111 </span>            : 
<span class="lineNum">    4112 </span><span class="lineCov">        455 :         if (file &amp;&amp; keep_utc &amp;&amp; open_edit) {</span>
<span class="lineNum">    4113 </span><span class="lineNoCov">          0 :                 gf_isom_keep_utc_times(file, 1);</span>
<span class="lineNum">    4114 </span>            :         }
<span class="lineNum">    4115 </span>            : 
<span class="lineNum">    4116 </span><span class="lineCov">        455 :         if (do_flat &amp;&amp; interleaving_time) {</span>
<span class="lineNum">    4117 </span>            :                 char szSubArg[100];
<span class="lineNum">    4118 </span><span class="lineCov">          1 :                 gf_isom_set_storage_mode(file, GF_ISOM_STORE_FASTSTART);</span>
<span class="lineNum">    4119 </span><span class="lineCov">          1 :                 do_flat = 2;</span>
<span class="lineNum">    4120 </span>            :                 nb_pass = 2;
<span class="lineNum">    4121 </span><span class="lineCov">          1 :                 fs = gf_fs_new_defaults(0);</span>
<span class="lineNum">    4122 </span><span class="lineCov">          1 :                 if (!fs) {</span>
<span class="lineNum">    4123 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Error creating filter session\n&quot;));</span>
<span class="lineNum">    4124 </span><span class="lineNoCov">          0 :                         gf_isom_delete(file);</span>
<span class="lineNum">    4125 </span><span class="lineNoCov">          0 :                         return mp4box_cleanup(1);</span>
<span class="lineNum">    4126 </span>            :                 }
<span class="lineNum">    4127 </span>            : 
<span class="lineNum">    4128 </span>            :                 //mux args
<span class="lineNum">    4129 </span><span class="lineCov">          1 :                 gf_dynstrcat(&amp;mux_args, &quot;mp4mx:importer:store=fstart&quot;, &quot;:&quot;);</span>
<span class="lineNum">    4130 </span>            : 
<span class="lineNum">    4131 </span><span class="lineCov">          1 :                 sprintf(szSubArg, &quot;file=%p&quot;, file);</span>
<span class="lineNum">    4132 </span><span class="lineCov">          1 :                 gf_dynstrcat(&amp;mux_args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    4133 </span><span class="lineCov">          1 :                 sprintf(szSubArg, &quot;cdur=%g&quot;, interleaving_time);</span>
<span class="lineNum">    4134 </span><span class="lineCov">          1 :                 gf_dynstrcat(&amp;mux_args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    4135 </span>            :         }
<span class="lineNum">    4136 </span>            : 
<span class="lineNum">    4137 </span><span class="lineCov">        908 :         for (ipass=0; ipass&lt;nb_pass; ipass++) {</span>
<span class="lineNum">    4138 </span>            :                 u32 tk_idx = 1;
<span class="lineNum">    4139 </span><span class="lineCov">       8932 :                 for (i=0; i&lt;(u32) argc; i++) {</span>
<span class="lineNum">    4140 </span><span class="lineCov">       4241 :                         char *margs=NULL;</span>
<span class="lineNum">    4141 </span><span class="lineCov">       4241 :                         if (!strcmp(argv[i], &quot;-add&quot;)) {</span>
<span class="lineNum">    4142 </span><span class="lineCov">        488 :                                 char *src = argv[i+1];</span>
<span class="lineNum">    4143 </span>            : 
<span class="lineNum">    4144 </span><span class="lineCov">        977 :                                 while (src) {</span>
<span class="lineNum">    4145 </span>            :                                         char *loc_src = src;
<span class="lineNum">    4146 </span>            :                                         char *sep = NULL;
<span class="lineNum">    4147 </span><span class="lineNoCov">          0 :                                         while (1) {</span>
<span class="lineNum">    4148 </span>            :                                                 char *opt_sep;
<span class="lineNum">    4149 </span><span class="lineCov">        489 :                                                 sep = strchr(loc_src, '+');</span>
<span class="lineNum">    4150 </span><span class="lineCov">        489 :                                                 if (!sep) break;</span>
<span class="lineNum">    4151 </span>            : 
<span class="lineNum">    4152 </span><span class="lineCov">          1 :                                                 sep[0] = 0;</span>
<span class="lineNum">    4153 </span><span class="lineCov">          1 :                                                 if (strstr(src, &quot;://&quot;))</span>
<span class="lineNum">    4154 </span>            :                                                         break;
<span class="lineNum">    4155 </span>            : 
<span class="lineNum">    4156 </span><span class="lineCov">          1 :                                                 opt_sep = gf_url_colon_suffix(src);</span>
<span class="lineNum">    4157 </span><span class="lineCov">          1 :                                                 if (opt_sep)</span>
<span class="lineNum">    4158 </span><span class="lineNoCov">          0 :                                                         opt_sep[0] = 0;</span>
<span class="lineNum">    4159 </span><span class="lineCov">          1 :                                                 if (gf_file_exists(src)) {</span>
<span class="lineNum">    4160 </span><span class="lineCov">          1 :                                                         if (opt_sep)</span>
<span class="lineNum">    4161 </span><span class="lineNoCov">          0 :                                                                 opt_sep[0] = ':';</span>
<span class="lineNum">    4162 </span>            :                                                         break;
<span class="lineNum">    4163 </span>            :                                                 }
<span class="lineNum">    4164 </span><span class="lineNoCov">          0 :                                                 if (opt_sep)</span>
<span class="lineNum">    4165 </span><span class="lineNoCov">          0 :                                                         opt_sep[0] = ':';</span>
<span class="lineNum">    4166 </span>            : 
<span class="lineNum">    4167 </span><span class="lineNoCov">          0 :                                                 sep[0] = '+';</span>
<span class="lineNum">    4168 </span><span class="lineNoCov">          0 :                                                 loc_src = sep+1;</span>
<span class="lineNum">    4169 </span>            :                                         }
<span class="lineNum">    4170 </span>            : 
<span class="lineNum">    4171 </span><span class="lineCov">        489 :                                         e = import_file(file, src, import_flags, import_fps, agg_samples, fs, (fs &amp;&amp; (ipass==0)) ? &amp;margs : NULL, tk_idx);</span>
<span class="lineNum">    4172 </span><span class="lineCov">        489 :                                         tk_idx++;</span>
<span class="lineNum">    4173 </span>            : 
<span class="lineNum">    4174 </span><span class="lineCov">        489 :                                         if (margs) {</span>
<span class="lineNum">    4175 </span><span class="lineNoCov">          0 :                                                 gf_dynstrcat(&amp;mux_args, margs, &quot;:&quot;);</span>
<span class="lineNum">    4176 </span><span class="lineNoCov">          0 :                                                 gf_free(margs);</span>
<span class="lineNum">    4177 </span>            :                                         }
<span class="lineNum">    4178 </span>            : 
<span class="lineNum">    4179 </span><span class="lineCov">        489 :                                         if (e) {</span>
<span class="lineNum">    4180 </span><span class="lineCov">          3 :                                                 M4_LOG(GF_LOG_ERROR, (&quot;Error importing %s: %s\n&quot;, argv[i+1], gf_error_to_string(e)));</span>
<span class="lineNum">    4181 </span><span class="lineCov">          3 :                                                 gf_isom_delete(file);</span>
<span class="lineNum">    4182 </span><span class="lineCov">          3 :                                                 if (fs)</span>
<span class="lineNum">    4183 </span><span class="lineNoCov">          0 :                                                         gf_fs_del(fs);</span>
<span class="lineNum">    4184 </span><span class="lineCov">          6 :                                                 return mp4box_cleanup(1);</span>
<span class="lineNum">    4185 </span>            :                                         }
<span class="lineNum">    4186 </span><span class="lineCov">        486 :                                         if (sep) {</span>
<span class="lineNum">    4187 </span><span class="lineCov">          1 :                                                 sep[0] = '+';</span>
<span class="lineNum">    4188 </span><span class="lineCov">          1 :                                                 src = sep+1;</span>
<span class="lineNum">    4189 </span>            :                                         } else {
<span class="lineNum">    4190 </span>            :                                                 break;
<span class="lineNum">    4191 </span>            :                                         }
<span class="lineNum">    4192 </span>            :                                 }
<span class="lineNum">    4193 </span>            :                                 i++;
<span class="lineNum">    4194 </span><span class="lineCov">       3753 :                         } else if (!strcmp(argv[i], &quot;-cat&quot;) || !strcmp(argv[i], &quot;-catx&quot;) || !strcmp(argv[i], &quot;-catpl&quot;)) {</span>
<span class="lineNum">    4195 </span><span class="lineCov">         16 :                                 if (nb_pass == 2) {</span>
<span class="lineNum">    4196 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_ERROR, (&quot;Cannot cat files when using -newfs mode\n&quot;));</span>
<span class="lineNum">    4197 </span><span class="lineNoCov">          0 :                                         return mp4box_cleanup(1);</span>
<span class="lineNum">    4198 </span>            :                                 }
<span class="lineNum">    4199 </span><span class="lineCov">         16 :                                 if (!file) {</span>
<span class="lineNum">    4200 </span>            :                                         u8 open_mode = GF_ISOM_OPEN_EDIT;
<span class="lineNum">    4201 </span><span class="lineCov">          9 :                                         if (force_new) {</span>
<span class="lineNum">    4202 </span><span class="lineCov">          6 :                                                 open_mode = (do_flat) ? GF_ISOM_OPEN_WRITE : GF_ISOM_WRITE_EDIT;</span>
<span class="lineNum">    4203 </span>            :                                         } else {
<span class="lineNum">    4204 </span><span class="lineCov">          3 :                                                 FILE *test = gf_fopen(inName, &quot;rb&quot;);</span>
<span class="lineNum">    4205 </span><span class="lineCov">          3 :                                                 if (!test) {</span>
<span class="lineNum">    4206 </span><span class="lineNoCov">          0 :                                                         open_mode = (do_flat) ? GF_ISOM_OPEN_WRITE : GF_ISOM_WRITE_EDIT;</span>
<span class="lineNum">    4207 </span><span class="lineNoCov">          0 :                                                         if (!outName) outName = inName;</span>
<span class="lineNum">    4208 </span>            :                                                 }
<span class="lineNum">    4209 </span><span class="lineCov">          3 :                                                 else gf_fclose(test);</span>
<span class="lineNum">    4210 </span>            :                                         }
<span class="lineNum">    4211 </span>            : 
<span class="lineNum">    4212 </span><span class="lineCov">          9 :                                         open_edit = GF_TRUE;</span>
<span class="lineNum">    4213 </span><span class="lineCov">          9 :                                         file = gf_isom_open(inName, open_mode, NULL);</span>
<span class="lineNum">    4214 </span><span class="lineCov">          9 :                                         if (!file) {</span>
<span class="lineNum">    4215 </span><span class="lineNoCov">          0 :                                                 M4_LOG(GF_LOG_ERROR, (&quot;Cannot open destination file %s: %s\n&quot;, inName, gf_error_to_string(gf_isom_last_error(NULL)) ));</span>
<span class="lineNum">    4216 </span><span class="lineNoCov">          0 :                                                 return mp4box_cleanup(1);</span>
<span class="lineNum">    4217 </span>            :                                         }
<span class="lineNum">    4218 </span>            :                                 }
<span class="lineNum">    4219 </span>            : 
<span class="lineNum">    4220 </span><span class="lineCov">         16 :                                 e = cat_isomedia_file(file, argv[i+1], import_flags, import_fps, agg_samples, force_cat, align_cat, !strcmp(argv[i], &quot;-catx&quot;) ? GF_TRUE : GF_FALSE, !strcmp(argv[i], &quot;-catpl&quot;) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    4221 </span><span class="lineCov">         16 :                                 if (e) {</span>
<span class="lineNum">    4222 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_ERROR, (&quot;Error appending %s: %s\n&quot;, argv[i+1], gf_error_to_string(e)));</span>
<span class="lineNum">    4223 </span><span class="lineNoCov">          0 :                                         gf_isom_delete(file);</span>
<span class="lineNum">    4224 </span><span class="lineNoCov">          0 :                                         return mp4box_cleanup(1);</span>
<span class="lineNum">    4225 </span>            :                                 }
<span class="lineNum">    4226 </span>            :                                 i++;
<span class="lineNum">    4227 </span>            :                         }
<span class="lineNum">    4228 </span>            :                 }
<span class="lineNum">    4229 </span><span class="lineCov">        453 :                 if ((nb_pass == 2) &amp;&amp; !ipass) {</span>
<span class="lineNum">    4230 </span><span class="lineCov">          1 :                         GF_Filter *mux_filter = gf_fs_load_filter(fs, mux_args, NULL);</span>
<span class="lineNum">    4231 </span><span class="lineCov">          1 :                         gf_free(mux_args);</span>
<span class="lineNum">    4232 </span><span class="lineCov">          1 :                         if (!mux_filter) {</span>
<span class="lineNum">    4233 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Error loadin isobmff mux filter\n&quot;));</span>
<span class="lineNum">    4234 </span><span class="lineNoCov">          0 :                                 gf_isom_delete(file);</span>
<span class="lineNum">    4235 </span><span class="lineNoCov">          0 :                                 gf_fs_del(fs);</span>
<span class="lineNum">    4236 </span><span class="lineNoCov">          0 :                                 return mp4box_cleanup(1);</span>
<span class="lineNum">    4237 </span>            :                         }
<span class="lineNum">    4238 </span>            : 
<span class="lineNum">    4239 </span><span class="lineCov">          1 :                         e = gf_fs_run(fs);</span>
<span class="lineNum">    4240 </span><span class="lineCov">          1 :                         if (e==GF_EOS) e = GF_OK;</span>
<span class="lineNum">    4241 </span>            : 
<span class="lineNum">    4242 </span><span class="lineNoCov">          0 :                         if (!e) e = gf_fs_get_last_connect_error(fs);</span>
<span class="lineNum">    4243 </span><span class="lineCov">          1 :                         if (!e) e = gf_fs_get_last_process_error(fs);</span>
<span class="lineNum">    4244 </span>            : 
<span class="lineNum">    4245 </span><span class="lineCov">          1 :                         if (e) {</span>
<span class="lineNum">    4246 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Error importing sources: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    4247 </span><span class="lineNoCov">          0 :                                 gf_isom_delete(file);</span>
<span class="lineNum">    4248 </span><span class="lineNoCov">          0 :                                 gf_fs_del(fs);</span>
<span class="lineNum">    4249 </span><span class="lineNoCov">          0 :                                 return mp4box_cleanup(1);</span>
<span class="lineNum">    4250 </span>            :                         }
<span class="lineNum">    4251 </span>            :                 }
<span class="lineNum">    4252 </span>            :         }
<span class="lineNum">    4253 </span><span class="lineCov">        452 :         if (fs) {</span>
<span class="lineNum">    4254 </span><span class="lineCov">          1 :                 gf_fs_print_non_connected(fs);</span>
<span class="lineNum">    4255 </span><span class="lineCov">          1 :                 if (fs_dump_flags &amp; 1) gf_fs_print_stats(fs);</span>
<span class="lineNum">    4256 </span><span class="lineCov">          1 :                 if (fs_dump_flags &amp; 2) gf_fs_print_connections(fs);</span>
<span class="lineNum">    4257 </span><span class="lineCov">          1 :                 gf_fs_del(fs);</span>
<span class="lineNum">    4258 </span>            :         }
<span class="lineNum">    4259 </span>            : 
<span class="lineNum">    4260 </span>            :         /*unless explicitly asked, remove all systems tracks*/
<span class="lineNum">    4261 </span>            : #ifndef GPAC_DISABLE_AV_PARSERS
<span class="lineNum">    4262 </span><span class="lineCov">        452 :         if (!keep_sys_tracks) remove_systems_tracks(file);</span>
<span class="lineNum">    4263 </span>            : #endif
<span class="lineNum">    4264 </span><span class="lineCov">        452 :         do_save = GF_TRUE;</span>
<span class="lineNum">    4265 </span>            : 
<span class="lineNum">    4266 </span><span class="lineCov">        452 :         return 0;</span>
<span class="lineNum">    4267 </span>            : }
<span class="lineNum">    4268 </span>            : #endif /*!GPAC_DISABLE_MEDIA_IMPORT &amp;&amp; !GPAC_DISABLE_ISOM_WRITE*/
<span class="lineNum">    4269 </span>            : 
<a name="4270"><span class="lineNum">    4270 </span>            : </a>
<span class="lineNum">    4271 </span>            : #if !defined(GPAC_DISABLE_ISOM_WRITE) &amp;&amp; !defined(GPAC_DISABLE_SCENE_ENCODER) &amp;&amp; !defined(GPAC_DISABLE_MEDIA_IMPORT)
<span class="lineNum">    4272 </span><span class="lineCov">         33 : static GF_Err do_scene_encode()</span>
<span class="lineNum">    4273 </span>            : {
<span class="lineNum">    4274 </span>            :         GF_Err e;
<span class="lineNum">    4275 </span>            :         FILE *logs = NULL;
<span class="lineNum">    4276 </span><span class="lineCov">         33 :         if (do_scene_log) {</span>
<span class="lineNum">    4277 </span>            :                 char alogfile[GF_MAX_PATH];
<span class="lineNum">    4278 </span><span class="lineCov">          4 :                 strcpy(alogfile, inName);</span>
<span class="lineNum">    4279 </span><span class="lineCov">          4 :                 if (strchr(alogfile, '.')) {</span>
<span class="lineNum">    4280 </span><span class="lineCov">          9 :                         while (alogfile[strlen(alogfile)-1] != '.') alogfile[strlen(alogfile)-1] = 0;</span>
<span class="lineNum">    4281 </span><span class="lineCov">          4 :                         alogfile[strlen(alogfile)-1] = 0;</span>
<span class="lineNum">    4282 </span>            :                 }
<span class="lineNum">    4283 </span>            :                 strcat(alogfile, &quot;_enc.logs&quot;);
<span class="lineNum">    4284 </span><span class="lineCov">          4 :                 logs = gf_fopen(alogfile, &quot;wt&quot;);</span>
<span class="lineNum">    4285 </span>            :         }
<span class="lineNum">    4286 </span><span class="lineCov">         33 :         strcpy(outfile, outName ? outName : inName);</span>
<span class="lineNum">    4287 </span><span class="lineCov">         33 :         if (strchr(outfile, '.')) {</span>
<span class="lineNum">    4288 </span><span class="lineCov">         83 :                 while (outfile[strlen(outfile)-1] != '.') outfile[strlen(outfile)-1] = 0;</span>
<span class="lineNum">    4289 </span><span class="lineCov">         33 :                 outfile[strlen(outfile)-1] = 0;</span>
<span class="lineNum">    4290 </span>            :         }
<span class="lineNum">    4291 </span>            :         strcat(outfile, &quot;.mp4&quot;);
<span class="lineNum">    4292 </span><span class="lineCov">         33 :         file = gf_isom_open(outfile, GF_ISOM_WRITE_EDIT, NULL);</span>
<span class="lineNum">    4293 </span><span class="lineCov">         33 :         smenc_opts.mediaSource = mediaSource ? mediaSource : outfile;</span>
<span class="lineNum">    4294 </span><span class="lineCov">         33 :         e = EncodeFile(inName, file, &amp;smenc_opts, logs);</span>
<span class="lineNum">    4295 </span><span class="lineCov">         33 :         if (logs) gf_fclose(logs);</span>
<span class="lineNum">    4296 </span><span class="lineCov">         33 :         if (e) return e;</span>
<span class="lineNum">    4297 </span><span class="lineCov">         33 :         do_save = GF_TRUE;</span>
<span class="lineNum">    4298 </span><span class="lineCov">         33 :         if (do_saf) {</span>
<span class="lineNum">    4299 </span><span class="lineCov">          1 :                 do_save = GF_FALSE;</span>
<span class="lineNum">    4300 </span><span class="lineCov">          1 :                 open_edit = GF_FALSE;</span>
<span class="lineNum">    4301 </span>            :         }
<span class="lineNum">    4302 </span>            :         return GF_OK;
<span class="lineNum">    4303 </span>            : }
<span class="lineNum">    4304 </span>            : #endif //!defined(GPAC_DISABLE_ISOM_WRITE) &amp;&amp; !defined(GPAC_DISABLE_SCENE_ENCODER) &amp;&amp; !defined(GPAC_DISABLE_MEDIA_IMPORT)
<a name="4305"><span class="lineNum">    4305 </span>            : </a>
<span class="lineNum">    4306 </span>            : 
<span class="lineNum">    4307 </span><span class="lineCov">        176 : static GF_Err do_dash()</span>
<span class="lineNum">    4308 </span>            : {
<span class="lineNum">    4309 </span>            :         GF_Err e;
<span class="lineNum">    4310 </span>            :         u32 i;
<span class="lineNum">    4311 </span>            :         Bool del_file = GF_FALSE;
<span class="lineNum">    4312 </span>            :         char szMPD[GF_MAX_PATH], *sep;
<span class="lineNum">    4313 </span>            :         char szStateFile[GF_MAX_PATH];
<span class="lineNum">    4314 </span>            :         Bool dyn_state_file = GF_FALSE;
<span class="lineNum">    4315 </span>            :         u32 do_abort = 0;
<span class="lineNum">    4316 </span><span class="lineCov">        176 :         GF_DASHSegmenter *dasher=NULL;</span>
<span class="lineNum">    4317 </span>            : 
<span class="lineNum">    4318 </span><span class="lineCov">        176 :         if (crypt) {</span>
<span class="lineNum">    4319 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;MP4Box cannot use -crypt and -dash in the same pass. Please encrypt your content first, or specify encryption filters on dash sources.\n&quot;));</span>
<span class="lineNum">    4320 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    4321 </span>            :         }
<span class="lineNum">    4322 </span>            : 
<span class="lineNum">    4323 </span><span class="lineCov">        176 :         strcpy(outfile, outName ? outName : gf_url_get_resource_name(inName) );</span>
<span class="lineNum">    4324 </span><span class="lineCov">        176 :         sep = strrchr(outfile, '.');</span>
<span class="lineNum">    4325 </span><span class="lineCov">        176 :         if (sep) sep[0] = 0;</span>
<span class="lineNum">    4326 </span><span class="lineCov">        176 :         if (!outName) strcat(outfile, &quot;_dash&quot;);</span>
<span class="lineNum">    4327 </span>            :         strcpy(szMPD, outfile);
<span class="lineNum">    4328 </span><span class="lineCov">        176 :         if (outName &amp;&amp; sep) {</span>
<span class="lineNum">    4329 </span><span class="lineCov">        176 :                 sep[0] = '.';</span>
<span class="lineNum">    4330 </span>            :                 strcat(szMPD, sep);
<span class="lineNum">    4331 </span>            :         } else {
<span class="lineNum">    4332 </span>            :                 strcat(szMPD, &quot;.mpd&quot;);
<span class="lineNum">    4333 </span>            :         }
<span class="lineNum">    4334 </span>            : 
<span class="lineNum">    4335 </span><span class="lineCov">        176 :         if ((dash_subduration&gt;0) &amp;&amp; (dash_duration &gt; dash_subduration)) {</span>
<span class="lineNum">    4336 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_WARNING, (&quot;Warning: -subdur parameter (%g s) should be greater than segment duration (%g s), using segment duration instead\n&quot;, dash_subduration, dash_duration));</span>
<span class="lineNum">    4337 </span><span class="lineNoCov">          0 :                 dash_subduration = dash_duration;</span>
<span class="lineNum">    4338 </span>            :         }
<span class="lineNum">    4339 </span>            : 
<span class="lineNum">    4340 </span><span class="lineCov">        176 :         if (dash_mode &amp;&amp; dash_live)</span>
<span class="lineNum">    4341 </span><span class="lineCov">          8 :                 M4_LOG(GF_LOG_INFO, (&quot;Live DASH-ing - press 'q' to quit, 's' to save context and quit\n&quot;));</span>
<span class="lineNum">    4342 </span>            : 
<span class="lineNum">    4343 </span><span class="lineCov">        183 :         if (!dash_ctx_file &amp;&amp; dash_live) {</span>
<span class="lineNum">    4344 </span>            :                 u32 r1;
<span class="lineNum">    4345 </span><span class="lineCov">          7 :                 u64 add = (u64) (intptr_t) &amp;dasher;</span>
<span class="lineNum">    4346 </span><span class="lineCov">          7 :                 add ^= gf_net_get_utc();</span>
<span class="lineNum">    4347 </span><span class="lineCov">          7 :                 r1 = (u32) add ^ (u32) (add/0xFFFFFFFF);</span>
<span class="lineNum">    4348 </span><span class="lineCov">          7 :                 r1 ^= gf_rand();</span>
<span class="lineNum">    4349 </span><span class="lineCov">          7 :                 sprintf(szStateFile, &quot;%s/dasher_%X.xml&quot;, gf_get_default_cache_directory(), r1 );</span>
<span class="lineNum">    4350 </span><span class="lineCov">          7 :                 dash_ctx_file = szStateFile;</span>
<span class="lineNum">    4351 </span>            :                 dyn_state_file = GF_TRUE;
<span class="lineNum">    4352 </span><span class="lineCov">        169 :         } else if (dash_ctx_file) {</span>
<span class="lineNum">    4353 </span><span class="lineCov">          7 :                 if (force_new)</span>
<span class="lineNum">    4354 </span><span class="lineNoCov">          0 :                         gf_file_delete(dash_ctx_file);</span>
<span class="lineNum">    4355 </span>            :         }
<span class="lineNum">    4356 </span>            : 
<span class="lineNum">    4357 </span><span class="lineCov">        176 :         if (dash_profile==GF_DASH_PROFILE_AUTO)</span>
<span class="lineNum">    4358 </span><span class="lineCov">         21 :                 dash_profile = dash_mode ? GF_DASH_PROFILE_LIVE : GF_DASH_PROFILE_FULL;</span>
<span class="lineNum">    4359 </span>            : 
<span class="lineNum">    4360 </span><span class="lineCov">        176 :         if (!dash_mode) {</span>
<span class="lineNum">    4361 </span><span class="lineCov">        165 :                 time_shift_depth = 0;</span>
<span class="lineNum">    4362 </span><span class="lineCov">        165 :                 mpd_update_time = 0;</span>
<span class="lineNum">    4363 </span><span class="lineCov">         11 :         } else if ((dash_profile&gt;=GF_DASH_PROFILE_MAIN) &amp;&amp; !use_url_template &amp;&amp; !mpd_update_time) {</span>
<span class="lineNum">    4364 </span>            :                 /*use a default MPD update of dash_duration sec*/
<span class="lineNum">    4365 </span><span class="lineNoCov">          0 :                 mpd_update_time = (Double) (dash_subduration ? dash_subduration : dash_duration);</span>
<span class="lineNum">    4366 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_INFO, (&quot;Using default MPD refresh of %g seconds\n&quot;, mpd_update_time));</span>
<span class="lineNum">    4367 </span>            :         }
<span class="lineNum">    4368 </span>            : 
<span class="lineNum">    4369 </span><span class="lineCov">        176 :         if (file &amp;&amp; do_save) {</span>
<span class="lineNum">    4370 </span><span class="lineNoCov">          0 :                 gf_isom_close(file);</span>
<span class="lineNum">    4371 </span><span class="lineNoCov">          0 :                 file = NULL;</span>
<span class="lineNum">    4372 </span>            :                 del_file = GF_TRUE;
<span class="lineNum">    4373 </span>            :         }
<span class="lineNum">    4374 </span>            : 
<span class="lineNum">    4375 </span>            :         /*setup dash*/
<span class="lineNum">    4376 </span><span class="lineCov">        176 :         dasher = gf_dasher_new(szMPD, dash_profile, NULL, dash_scale, dash_ctx_file);</span>
<span class="lineNum">    4377 </span><span class="lineCov">        176 :         if (!dasher) {</span>
<span class="lineNum">    4378 </span><span class="lineNoCov">          0 :                 return mp4box_cleanup(1);</span>
<span class="lineNum">    4379 </span>            :         }
<span class="lineNum">    4380 </span><span class="lineCov">        176 :         e = gf_dasher_set_info(dasher, dash_title, cprt, dash_more_info, dash_source, NULL);</span>
<span class="lineNum">    4381 </span><span class="lineCov">        176 :         if (e) {</span>
<span class="lineNum">    4382 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;DASH Error: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    4383 </span><span class="lineNoCov">          0 :                 gf_dasher_del(dasher);</span>
<span class="lineNum">    4384 </span><span class="lineNoCov">          0 :                 return e;</span>
<span class="lineNum">    4385 </span>            :         }
<span class="lineNum">    4386 </span>            : 
<span class="lineNum">    4387 </span><span class="lineCov">        176 :         gf_dasher_set_start_date(dasher, dash_start_date);</span>
<span class="lineNum">    4388 </span><span class="lineCov">        176 :         gf_dasher_set_location(dasher, dash_source);</span>
<span class="lineNum">    4389 </span><span class="lineCov">        177 :         for (i=0; i &lt; nb_mpd_base_urls; i++) {</span>
<span class="lineNum">    4390 </span><span class="lineCov">          1 :                 e = gf_dasher_add_base_url(dasher, mpd_base_urls[i]);</span>
<span class="lineNum">    4391 </span><span class="lineCov">          1 :                 if (e) {</span>
<span class="lineNum">    4392 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;DASH Error: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    4393 </span><span class="lineNoCov">          0 :                         gf_dasher_del(dasher);</span>
<span class="lineNum">    4394 </span><span class="lineNoCov">          0 :                         return e;</span>
<span class="lineNum">    4395 </span>            :                 }
<span class="lineNum">    4396 </span>            :         }
<span class="lineNum">    4397 </span>            : 
<span class="lineNum">    4398 </span><span class="lineCov">        176 :         if (segment_timeline &amp;&amp; !use_url_template) {</span>
<span class="lineNum">    4399 </span><span class="lineCov">          5 :                 M4_LOG(GF_LOG_WARNING, (&quot;DASH Warning: using -segment-timeline with no -url-template. Forcing URL template.\n&quot;));</span>
<span class="lineNum">    4400 </span><span class="lineCov">          5 :                 use_url_template = GF_TRUE;</span>
<span class="lineNum">    4401 </span>            :         }
<span class="lineNum">    4402 </span>            : 
<span class="lineNum">    4403 </span><span class="lineCov">        176 :         e = gf_dasher_enable_url_template(dasher, (Bool) use_url_template, seg_name, seg_ext, init_seg_ext);</span>
<span class="lineNum">    4404 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_enable_segment_timeline(dasher, segment_timeline);</span>
<span class="lineNum">    4405 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_enable_single_segment(dasher, single_segment);</span>
<span class="lineNum">    4406 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_enable_single_file(dasher, single_file);</span>
<span class="lineNum">    4407 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_switch_mode(dasher, bitstream_switching_mode);</span>
<span class="lineNum">    4408 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_durations(dasher, dash_duration, interleaving_time, dash_subduration);</span>
<span class="lineNum">    4409 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_enable_rap_splitting(dasher, seg_at_rap, frag_at_rap);</span>
<span class="lineNum">    4410 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_segment_marker(dasher, segment_marker);</span>
<span class="lineNum">    4411 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_enable_sidx(dasher, (subsegs_per_sidx&gt;=0) ? 1 : 0, (u32) subsegs_per_sidx, daisy_chain_sidx, use_ssix);</span>
<span class="lineNum">    4412 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_dynamic_mode(dasher, dash_mode, mpd_update_time, time_shift_depth, mpd_live_duration);</span>
<span class="lineNum">    4413 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_min_buffer(dasher, min_buffer);</span>
<span class="lineNum">    4414 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_ast_offset(dasher, ast_offset_ms);</span>
<span class="lineNum">    4415 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_enable_memory_fragmenting(dasher, memory_frags);</span>
<span class="lineNum">    4416 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_initial_isobmf(dasher, initial_moof_sn, initial_tfdt);</span>
<span class="lineNum">    4417 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_configure_isobmf_default(dasher, no_fragments_defaults, pssh_mode, samplegroups_in_traf, single_traf_per_moof, tfdt_per_traf, mvex_after_traks, sdtp_in_traf);</span>
<span class="lineNum">    4418 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_enable_utc_ref(dasher, insert_utc);</span>
<span class="lineNum">    4419 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_enable_real_time(dasher, frag_real_time);</span>
<span class="lineNum">    4420 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_content_protection_location_mode(dasher, cp_location_mode);</span>
<span class="lineNum">    4421 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_profile_extension(dasher, dash_profile_extension);</span>
<span class="lineNum">    4422 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_enable_cached_inputs(dasher, no_cache);</span>
<span class="lineNum">    4423 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_enable_loop_inputs(dasher, ! no_loop);</span>
<span class="lineNum">    4424 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_split_mode(dasher, dash_split_mode);</span>
<span class="lineNum">    4425 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_last_segment_merge(dasher, merge_last_seg);</span>
<span class="lineNum">    4426 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_set_hls_clock(dasher, hls_clock);</span>
<span class="lineNum">    4427 </span><span class="lineCov">        176 :         if (!e &amp;&amp; dash_cues) e = gf_dasher_set_cues(dasher, dash_cues, strict_cues);</span>
<span class="lineNum">    4428 </span><span class="lineCov">        176 :         if (!e) e = gf_dasher_print_session_info(dasher, fs_dump_flags);</span>
<span class="lineNum">    4429 </span><span class="lineCov">        176 :         if (!e)  e = gf_dasher_keep_source_utc(dasher, keep_utc);</span>
<span class="lineNum">    4430 </span>            : 
<span class="lineNum">    4431 </span><span class="lineCov">        209 :         for (i=0; i &lt; nb_dash_inputs; i++) {</span>
<span class="lineNum">    4432 </span><span class="lineCov">        209 :                 if (!e) e = gf_dasher_add_input(dasher, &amp;dash_inputs[i]);</span>
<span class="lineNum">    4433 </span>            :         }
<span class="lineNum">    4434 </span><span class="lineCov">        176 :         if (e) {</span>
<span class="lineNum">    4435 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;DASH Setup Error: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    4436 </span><span class="lineNoCov">          0 :                 gf_dasher_del(dasher);</span>
<span class="lineNum">    4437 </span><span class="lineNoCov">          0 :                 return e;</span>
<span class="lineNum">    4438 </span>            :         }
<span class="lineNum">    4439 </span>            : 
<span class="lineNum">    4440 </span><span class="lineCov">        176 :         dash_cumulated_time=0;</span>
<span class="lineNum">    4441 </span>            : 
<span class="lineNum">    4442 </span>            :         while (1) {
<span class="lineNum">    4443 </span><span class="lineCov">        193 :                 if (run_for &amp;&amp; (dash_cumulated_time &gt;= run_for)) {</span>
<span class="lineNum">    4444 </span><span class="lineCov">          8 :                         M4_LOG(GF_LOG_INFO, (&quot;Done running, computing static MPD\n&quot;));</span>
<span class="lineNum">    4445 </span>            :                         do_abort = 3;
<span class="lineNum">    4446 </span>            :                 }
<span class="lineNum">    4447 </span>            : 
<span class="lineNum">    4448 </span><span class="lineCov">        193 :                 dash_prev_time=gf_sys_clock();</span>
<span class="lineNum">    4449 </span><span class="lineCov">        193 :                 if (do_abort&gt;=2) {</span>
<span class="lineNum">    4450 </span><span class="lineCov">          8 :                         e = gf_dasher_set_dynamic_mode(dasher, GF_DASH_DYNAMIC_LAST, 0, time_shift_depth, mpd_live_duration);</span>
<span class="lineNum">    4451 </span>            :                 }
<span class="lineNum">    4452 </span>            : 
<span class="lineNum">    4453 </span><span class="lineCov">        193 :                 if (!e) e = gf_dasher_process(dasher);</span>
<span class="lineNum">    4454 </span><span class="lineCov">        193 :                 if (!dash_live &amp;&amp; (e==GF_EOS) ) {</span>
<span class="lineNum">    4455 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_INFO, (&quot;Nothing to dash, too early ...\n&quot;));</span>
<span class="lineNum">    4456 </span>            :                         e = GF_OK;
<span class="lineNum">    4457 </span>            :                 }
<span class="lineNum">    4458 </span>            : 
<span class="lineNum">    4459 </span><span class="lineCov">        193 :                 if (do_abort)</span>
<span class="lineNum">    4460 </span>            :                         break;
<span class="lineNum">    4461 </span>            : 
<span class="lineNum">    4462 </span>            :                 //this happens when reading file while writing them (local playback of the live session ...)
<span class="lineNum">    4463 </span><span class="lineCov">        185 :                 if (dash_live &amp;&amp; (e==GF_IO_ERR) ) {</span>
<span class="lineNum">    4464 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_WARNING, (&quot;Error dashing file (%s) but continuing ...\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    4465 </span>            :                         e = GF_OK;
<span class="lineNum">    4466 </span>            :                 }
<span class="lineNum">    4467 </span>            : 
<span class="lineNum">    4468 </span><span class="lineCov">        185 :                 if (e) break;</span>
<span class="lineNum">    4469 </span>            : 
<span class="lineNum">    4470 </span><span class="lineCov">        183 :                 if (dash_live) {</span>
<span class="lineNum">    4471 </span><span class="lineCov">         17 :                         u64 ms_in_session=0;</span>
<span class="lineNum">    4472 </span><span class="lineCov">         17 :                         u32 slept = gf_sys_clock();</span>
<span class="lineNum">    4473 </span><span class="lineCov">         17 :                         u32 sleep_for = gf_dasher_next_update_time(dasher, &amp;ms_in_session);</span>
<span class="lineNum">    4474 </span><span class="lineCov">         17 :                         M4_LOG(GF_LOG_INFO, (&quot;Next generation scheduled in %u ms (DASH time &quot;LLU&quot; ms)\r&quot;, sleep_for, ms_in_session));</span>
<span class="lineNum">    4475 </span><span class="lineCov">         17 :                         if (run_for &amp;&amp; (ms_in_session&gt;=run_for)) {</span>
<span class="lineNum">    4476 </span><span class="lineCov">          7 :                                 dash_cumulated_time = 1+run_for;</span>
<span class="lineNum">    4477 </span><span class="lineCov">          7 :                                 continue;</span>
<span class="lineNum">    4478 </span>            :                         }
<span class="lineNum">    4479 </span>            : 
<span class="lineNum">    4480 </span>            :                         while (1) {
<span class="lineNum">    4481 </span><span class="lineCov">      70429 :                                 if (gf_prompt_has_input()) {</span>
<span class="lineNum">    4482 </span><span class="lineNoCov">          0 :                                         char c = (char) gf_prompt_get_char();</span>
<span class="lineNum">    4483 </span><span class="lineNoCov">          0 :                                         if (c=='X') {</span>
<span class="lineNum">    4484 </span>            :                                                 do_abort = 1;
<span class="lineNum">    4485 </span>            :                                                 break;
<span class="lineNum">    4486 </span>            :                                         }
<span class="lineNum">    4487 </span><span class="lineNoCov">          0 :                                         if (c=='q') {</span>
<span class="lineNum">    4488 </span>            :                                                 do_abort = 2;
<span class="lineNum">    4489 </span>            :                                                 break;
<span class="lineNum">    4490 </span>            :                                         }
<span class="lineNum">    4491 </span><span class="lineNoCov">          0 :                                         if (c=='s') {</span>
<span class="lineNum">    4492 </span>            :                                                 do_abort = 3;
<span class="lineNum">    4493 </span>            :                                                 break;
<span class="lineNum">    4494 </span>            :                                         }
<span class="lineNum">    4495 </span>            :                                 }
<span class="lineNum">    4496 </span>            : 
<span class="lineNum">    4497 </span><span class="lineCov">      70429 :                                 if (dash_mode == GF_DASH_DYNAMIC_DEBUG) {</span>
<span class="lineNum">    4498 </span>            :                                         break;
<span class="lineNum">    4499 </span>            :                                 }
<span class="lineNum">    4500 </span><span class="lineCov">      70429 :                                 if (!sleep_for) break;</span>
<span class="lineNum">    4501 </span>            : 
<span class="lineNum">    4502 </span><span class="lineCov">      70429 :                                 gf_sleep(sleep_for/10);</span>
<span class="lineNum">    4503 </span><span class="lineCov">      70429 :                                 sleep_for = gf_dasher_next_update_time(dasher, NULL);</span>
<span class="lineNum">    4504 </span><span class="lineCov">      70429 :                                 if (sleep_for&lt;=1) {</span>
<span class="lineNum">    4505 </span><span class="lineCov">         10 :                                         dash_now_time=gf_sys_clock();</span>
<span class="lineNum">    4506 </span><span class="lineCov">         10 :                                         dash_cumulated_time+=(dash_now_time-dash_prev_time);</span>
<span class="lineNum">    4507 </span><span class="lineCov">         10 :                                         M4_LOG(GF_LOG_INFO, (&quot;Slept for %d ms before generation, dash cumulated time %d\n&quot;, dash_now_time - slept, dash_cumulated_time));</span>
<span class="lineNum">    4508 </span>            :                                         break;
<span class="lineNum">    4509 </span>            :                                 }
<span class="lineNum">    4510 </span>            :                         }
<span class="lineNum">    4511 </span>            :                 } else {
<span class="lineNum">    4512 </span>            :                         break;
<span class="lineNum">    4513 </span>            :                 }
<span class="lineNum">    4514 </span>            :         }
<span class="lineNum">    4515 </span>            : 
<span class="lineNum">    4516 </span><span class="lineCov">        176 :         gf_dasher_del(dasher);</span>
<span class="lineNum">    4517 </span>            : 
<span class="lineNum">    4518 </span><span class="lineCov">        176 :         if (!run_for &amp;&amp; dash_ctx_file &amp;&amp; (do_abort==3) &amp;&amp; (dyn_state_file) &amp;&amp; !gf_sys_is_test_mode() ) {</span>
<span class="lineNum">    4519 </span>            :                 char szName[1024];
<span class="lineNum">    4520 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_INFO, (&quot;Enter file name to save dash context:\n&quot;));</span>
<span class="lineNum">    4521 </span><span class="lineNoCov">          0 :                 if (scanf(&quot;%1023s&quot;, szName) == 1) {</span>
<span class="lineNum">    4522 </span><span class="lineNoCov">          0 :                         gf_file_move(dash_ctx_file, szName);</span>
<span class="lineNum">    4523 </span>            :                 }
<span class="lineNum">    4524 </span>            :         }
<span class="lineNum">    4525 </span><span class="lineCov">        176 :         if (e) M4_LOG(GF_LOG_ERROR, (&quot;Error DASHing file: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    4526 </span><span class="lineCov">        176 :         if (file) gf_isom_delete(file);</span>
<span class="lineNum">    4527 </span><span class="lineCov">        176 :         if (del_file)</span>
<span class="lineNum">    4528 </span><span class="lineNoCov">          0 :                 gf_file_delete(inName);</span>
<span class="lineNum">    4529 </span>            : 
<span class="lineNum">    4530 </span>            :         return e;
<span class="lineNum">    4531 </span>            : }
<a name="4532"><span class="lineNum">    4532 </span>            : </a>
<span class="lineNum">    4533 </span>            : 
<span class="lineNum">    4534 </span><span class="lineNoCov">          0 : static GF_Err do_export_tracks_non_isobmf()</span>
<span class="lineNum">    4535 </span>            : {
<span class="lineNum">    4536 </span>            :         u32 i;
<span class="lineNum">    4537 </span>            : 
<span class="lineNum">    4538 </span>            :         GF_MediaExporter mdump;
<span class="lineNum">    4539 </span>            :         char szFile[GF_MAX_PATH+24];
<span class="lineNum">    4540 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;nb_track_act; i++) {</span>
<span class="lineNum">    4541 </span>            :                 GF_Err e;
<span class="lineNum">    4542 </span><span class="lineNoCov">          0 :                 TrackAction *tka = &amp;tracks[i];</span>
<span class="lineNum">    4543 </span><span class="lineNoCov">          0 :                 if (tka-&gt;act_type != TRAC_ACTION_RAW_EXTRACT) continue;</span>
<span class="lineNum">    4544 </span>            :                 memset(&amp;mdump, 0, sizeof(mdump));
<span class="lineNum">    4545 </span><span class="lineNoCov">          0 :                 mdump.in_name = inName;</span>
<span class="lineNum">    4546 </span><span class="lineNoCov">          0 :                 mdump.flags = tka-&gt;dump_type;</span>
<span class="lineNum">    4547 </span><span class="lineNoCov">          0 :                 mdump.trackID = tka-&gt;trackID;</span>
<span class="lineNum">    4548 </span><span class="lineNoCov">          0 :                 mdump.track_type = tka-&gt;dump_track_type;</span>
<span class="lineNum">    4549 </span><span class="lineNoCov">          0 :                 mdump.sample_num = tka-&gt;sample_num;</span>
<span class="lineNum">    4550 </span>            : 
<span class="lineNum">    4551 </span><span class="lineNoCov">          0 :                 if (dump_std) {</span>
<span class="lineNum">    4552 </span><span class="lineNoCov">          0 :                         mdump.out_name = &quot;std&quot;;</span>
<span class="lineNum">    4553 </span>            :                 }
<span class="lineNum">    4554 </span><span class="lineNoCov">          0 :                 else if (outName) {</span>
<span class="lineNum">    4555 </span><span class="lineNoCov">          0 :                         mdump.out_name = outName;</span>
<span class="lineNum">    4556 </span><span class="lineNoCov">          0 :                         mdump.flags |= GF_EXPORT_MERGE;</span>
<span class="lineNum">    4557 </span><span class="lineNoCov">          0 :                 } else if (nb_track_act&gt;1) {</span>
<span class="lineNum">    4558 </span>            :                         sprintf(szFile, &quot;%s_track%d&quot;, outfile, mdump.trackID);
<span class="lineNum">    4559 </span><span class="lineNoCov">          0 :                         mdump.out_name = szFile;</span>
<span class="lineNum">    4560 </span>            :                 } else {
<span class="lineNum">    4561 </span><span class="lineNoCov">          0 :                         mdump.out_name = outfile;</span>
<span class="lineNum">    4562 </span>            :                 }
<span class="lineNum">    4563 </span><span class="lineNoCov">          0 :                 mdump.print_stats_graph = fs_dump_flags;</span>
<span class="lineNum">    4564 </span><span class="lineNoCov">          0 :                 e = gf_media_export(&amp;mdump);</span>
<span class="lineNum">    4565 </span><span class="lineNoCov">          0 :                 if (e) return e;</span>
<span class="lineNum">    4566 </span>            :         }
<span class="lineNum">    4567 </span>            :         return GF_OK;
<span class="lineNum">    4568 </span>            : }
<a name="4569"><span class="lineNum">    4569 </span>            : </a>
<span class="lineNum">    4570 </span>            : 
<span class="lineNum">    4571 </span><span class="lineCov">          1 : static GF_Err do_dump_iod()</span>
<span class="lineNum">    4572 </span>            : {
<span class="lineNum">    4573 </span>            :         GF_Err e = GF_OK;
<span class="lineNum">    4574 </span><span class="lineCov">          1 :         GF_InitialObjectDescriptor *iod = (GF_InitialObjectDescriptor *)gf_isom_get_root_od(file);</span>
<span class="lineNum">    4575 </span><span class="lineCov">          1 :         if (!iod) {</span>
<span class="lineNum">    4576 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_WARNING, (&quot;File %s has no IOD\n&quot;, inName));</span>
<span class="lineNum">    4577 </span>            :         } else {
<span class="lineNum">    4578 </span>            :                 char szName[GF_MAX_PATH+10];
<span class="lineNum">    4579 </span>            :                 FILE *iodf;
<span class="lineNum">    4580 </span>            :                 sprintf(szName, &quot;%s.iod&quot;, outfile);
<span class="lineNum">    4581 </span><span class="lineCov">          1 :                 iodf = gf_fopen(szName, &quot;wb&quot;);</span>
<span class="lineNum">    4582 </span><span class="lineCov">          1 :                 if (!iodf) {</span>
<span class="lineNum">    4583 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Cannot open destination %s\n&quot;, szName));</span>
<span class="lineNum">    4584 </span>            :                         e = GF_IO_ERR;
<span class="lineNum">    4585 </span>            :                 } else {
<span class="lineNum">    4586 </span>            :                         u8 *desc;
<span class="lineNum">    4587 </span>            :                         u32 size;
<span class="lineNum">    4588 </span><span class="lineCov">          1 :                         GF_BitStream *bs = gf_bs_from_file(iodf, GF_BITSTREAM_WRITE);</span>
<span class="lineNum">    4589 </span><span class="lineCov">          1 :                         if (gf_odf_desc_write((GF_Descriptor *)iod, &amp;desc, &amp;size)==GF_OK) {</span>
<span class="lineNum">    4590 </span><span class="lineCov">          1 :                                 gf_fwrite(desc, size, iodf);</span>
<span class="lineNum">    4591 </span><span class="lineCov">          1 :                                 gf_free(desc);</span>
<span class="lineNum">    4592 </span>            :                         } else {
<span class="lineNum">    4593 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Error writing IOD %s\n&quot;, szName));</span>
<span class="lineNum">    4594 </span>            :                                 e = GF_IO_ERR;
<span class="lineNum">    4595 </span>            :                         }
<span class="lineNum">    4596 </span><span class="lineCov">          1 :                         gf_bs_del(bs);</span>
<span class="lineNum">    4597 </span><span class="lineCov">          1 :                         gf_fclose(iodf);</span>
<span class="lineNum">    4598 </span>            :                 }
<span class="lineNum">    4599 </span><span class="lineCov">          1 :                 gf_odf_desc_del((GF_Descriptor*)iod);</span>
<span class="lineNum">    4600 </span>            :         }
<span class="lineNum">    4601 </span><span class="lineCov">          1 :         return e;</span>
<a name="4602"><span class="lineNum">    4602 </span>            : }</a>
<span class="lineNum">    4603 </span>            : 
<span class="lineNum">    4604 </span><span class="lineCov">         63 : static GF_Err do_export_tracks()</span>
<span class="lineNum">    4605 </span>            : {
<span class="lineNum">    4606 </span>            :         GF_Err e;
<span class="lineNum">    4607 </span>            :         u32 i;
<span class="lineNum">    4608 </span>            :         char szFile[GF_MAX_PATH+24];
<span class="lineNum">    4609 </span>            :         GF_MediaExporter mdump;
<span class="lineNum">    4610 </span><span class="lineCov">        126 :         for (i=0; i&lt;nb_track_act; i++) {</span>
<span class="lineNum">    4611 </span>            :                 u32 j;
<span class="lineNum">    4612 </span><span class="lineCov">         63 :                 TrackAction *tka = &amp;tracks[i];</span>
<span class="lineNum">    4613 </span><span class="lineCov">         63 :                 if (tka-&gt;act_type != TRAC_ACTION_RAW_EXTRACT) continue;</span>
<span class="lineNum">    4614 </span>            :                 memset(&amp;mdump, 0, sizeof(mdump));
<span class="lineNum">    4615 </span><span class="lineCov">         63 :                 mdump.file = file;</span>
<span class="lineNum">    4616 </span><span class="lineCov">         63 :                 mdump.flags = tka-&gt;dump_type;</span>
<span class="lineNum">    4617 </span><span class="lineCov">         63 :                 mdump.trackID = tka-&gt;trackID;</span>
<span class="lineNum">    4618 </span><span class="lineCov">         63 :                 mdump.sample_num = tka-&gt;sample_num;</span>
<span class="lineNum">    4619 </span><span class="lineCov">         63 :                 if (tka-&gt;out_name) {</span>
<span class="lineNum">    4620 </span><span class="lineCov">          1 :                         mdump.out_name = tka-&gt;out_name;</span>
<span class="lineNum">    4621 </span><span class="lineCov">         62 :                 } else if (outName) {</span>
<span class="lineNum">    4622 </span><span class="lineCov">         34 :                         mdump.out_name = outName;</span>
<span class="lineNum">    4623 </span><span class="lineCov">         34 :                         mdump.flags |= GF_EXPORT_MERGE;</span>
<span class="lineNum">    4624 </span>            :                         /*don't infer extension on user-given filename*/
<span class="lineNum">    4625 </span><span class="lineCov">         34 :                         mdump.flags |= GF_EXPORT_NO_FILE_EXT;</span>
<span class="lineNum">    4626 </span><span class="lineCov">         28 :                 } else if (mdump.trackID) {</span>
<span class="lineNum">    4627 </span>            :                         sprintf(szFile, &quot;%s_track%d&quot;, outfile, mdump.trackID);
<span class="lineNum">    4628 </span><span class="lineCov">         28 :                         mdump.out_name = szFile;</span>
<span class="lineNum">    4629 </span>            :                 } else {
<span class="lineNum">    4630 </span>            :                         sprintf(szFile, &quot;%s_export&quot;, outfile);
<span class="lineNum">    4631 </span><span class="lineNoCov">          0 :                         mdump.out_name = szFile;</span>
<span class="lineNum">    4632 </span>            :                 }
<span class="lineNum">    4633 </span><span class="lineCov">         63 :                 if (tka-&gt;trackID==(u32) -1) {</span>
<span class="lineNum">    4634 </span><span class="lineNoCov">          0 :                         for (j=0; j&lt;gf_isom_get_track_count(file); j++) {</span>
<span class="lineNum">    4635 </span><span class="lineNoCov">          0 :                                 mdump.trackID = gf_isom_get_track_id(file, j+1);</span>
<span class="lineNum">    4636 </span>            :                                 sprintf(szFile, &quot;%s_track%d&quot;, outfile, mdump.trackID);
<span class="lineNum">    4637 </span><span class="lineNoCov">          0 :                                 mdump.out_name = szFile;</span>
<span class="lineNum">    4638 </span><span class="lineNoCov">          0 :                                 mdump.print_stats_graph = fs_dump_flags;</span>
<span class="lineNum">    4639 </span><span class="lineNoCov">          0 :                                 e = gf_media_export(&amp;mdump);</span>
<span class="lineNum">    4640 </span><span class="lineNoCov">          0 :                                 if (e) return e;</span>
<span class="lineNum">    4641 </span>            :                         }
<span class="lineNum">    4642 </span>            :                 } else {
<span class="lineNum">    4643 </span><span class="lineCov">         63 :                         mdump.print_stats_graph = fs_dump_flags;</span>
<span class="lineNum">    4644 </span><span class="lineCov">         63 :                         e = gf_media_export(&amp;mdump);</span>
<span class="lineNum">    4645 </span><span class="lineCov">         63 :                         if (e) return e;</span>
<span class="lineNum">    4646 </span>            :                 }
<span class="lineNum">    4647 </span>            :         }
<span class="lineNum">    4648 </span>            :         return GF_OK;
<a name="4649"><span class="lineNum">    4649 </span>            : }</a>
<span class="lineNum">    4650 </span>            : 
<span class="lineNum">    4651 </span><span class="lineCov">       4177 : static GF_Err do_meta_act()</span>
<span class="lineNum">    4652 </span>            : {
<span class="lineNum">    4653 </span>            :         u32 i;
<span class="lineNum">    4654 </span><span class="lineCov">       4299 :         for (i=0; i&lt;nb_meta_act; i++) {</span>
<span class="lineNum">    4655 </span>            :                 GF_Err e = GF_OK;
<span class="lineNum">    4656 </span>            :                 u32 tk = 0;
<span class="lineNum">    4657 </span>            : #ifndef GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    4658 </span>            :                 Bool self_ref;
<span class="lineNum">    4659 </span>            : #endif
<span class="lineNum">    4660 </span><span class="lineCov">        122 :                 MetaAction *meta = &amp;metas[i];</span>
<span class="lineNum">    4661 </span>            : 
<span class="lineNum">    4662 </span><span class="lineCov">        122 :                 if (meta-&gt;trackID) tk = gf_isom_get_track_by_id(file, meta-&gt;trackID);</span>
<span class="lineNum">    4663 </span>            : 
<span class="lineNum">    4664 </span><span class="lineCov">        122 :                 switch (meta-&gt;act_type) {</span>
<span class="lineNum">    4665 </span>            : #ifndef GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    4666 </span><span class="lineCov">          4 :                 case META_ACTION_SET_TYPE:</span>
<span class="lineNum">    4667 </span>            :                         /*note: we don't handle file brand modification, this is an author stuff and cannot be guessed from meta type*/
<span class="lineNum">    4668 </span><span class="lineCov">          4 :                         e = gf_isom_set_meta_type(file, meta-&gt;root_meta, tk, meta-&gt;meta_4cc);</span>
<span class="lineNum">    4669 </span><span class="lineCov">          4 :                         gf_isom_modify_alternate_brand(file, GF_ISOM_BRAND_ISO2, GF_TRUE);</span>
<span class="lineNum">    4670 </span><span class="lineCov">          4 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4671 </span><span class="lineCov">          4 :                         break;</span>
<span class="lineNum">    4672 </span><span class="lineCov">          4 :                 case META_ACTION_ADD_ITEM:</span>
<span class="lineNum">    4673 </span><span class="lineCov">          4 :                         self_ref = !stricmp(meta-&gt;szPath, &quot;NULL&quot;) || !stricmp(meta-&gt;szPath, &quot;this&quot;) || !stricmp(meta-&gt;szPath, &quot;self&quot;);</span>
<span class="lineNum">    4674 </span><span class="lineCov">         16 :                         e = gf_isom_add_meta_item(file, meta-&gt;root_meta, tk, self_ref, self_ref ? NULL : meta-&gt;szPath,</span>
<span class="lineNum">    4675 </span><span class="lineCov">          4 :                                                   meta-&gt;szName,</span>
<span class="lineNum">    4676 </span>            :                                                   meta-&gt;item_id,
<span class="lineNum">    4677 </span>            :                                                                           meta-&gt;item_type,
<span class="lineNum">    4678 </span><span class="lineCov">          4 :                                                   meta-&gt;mime_type,</span>
<span class="lineNum">    4679 </span><span class="lineCov">          4 :                                                   meta-&gt;enc_type,</span>
<span class="lineNum">    4680 </span><span class="lineCov">          4 :                                                   meta-&gt;use_dref ? meta-&gt;szPath : NULL,  NULL,</span>
<span class="lineNum">    4681 </span>            :                                                   meta-&gt;image_props);
<span class="lineNum">    4682 </span><span class="lineCov">          4 :                         if (meta-&gt;item_refs &amp;&amp; gf_list_count(meta-&gt;item_refs)) {</span>
<span class="lineNum">    4683 </span>            :                                 u32 ref_i;
<span class="lineNum">    4684 </span><span class="lineNoCov">          0 :                                 for (ref_i = 0; ref_i &lt; gf_list_count(meta-&gt;item_refs); ref_i++) {</span>
<span class="lineNum">    4685 </span><span class="lineNoCov">          0 :                                         MetaRef *ref_entry = gf_list_get(meta-&gt;item_refs, ref_i);</span>
<span class="lineNum">    4686 </span><span class="lineNoCov">          0 :                                         e = gf_isom_meta_add_item_ref(file, meta-&gt;root_meta, tk, meta-&gt;item_id, ref_entry-&gt;ref_item_id, ref_entry-&gt;ref_type, NULL);</span>
<span class="lineNum">    4687 </span>            :                                 }
<span class="lineNum">    4688 </span>            :                         }
<span class="lineNum">    4689 </span><span class="lineCov">          4 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4690 </span><span class="lineCov">          4 :                         break;</span>
<span class="lineNum">    4691 </span><span class="lineCov">         94 :                 case META_ACTION_ADD_IMAGE_ITEM:</span>
<span class="lineNum">    4692 </span>            :                 {
<span class="lineNum">    4693 </span><span class="lineCov">         94 :                         u32 old_tk_count = gf_isom_get_track_count(file);</span>
<span class="lineNum">    4694 </span>            :                         u32 src_tk_id = 1;
<span class="lineNum">    4695 </span><span class="lineCov">         94 :                         GF_Fraction _frac = {0,0};</span>
<span class="lineNum">    4696 </span><span class="lineCov">         94 :                         GF_ISOFile *fsrc = file;</span>
<span class="lineNum">    4697 </span>            :                         self_ref = GF_FALSE;
<span class="lineNum">    4698 </span>            : 
<span class="lineNum">    4699 </span>            :                         tk = 0;
<span class="lineNum">    4700 </span><span class="lineCov">         94 :                         if (meta-&gt;image_props &amp;&amp; meta-&gt;image_props-&gt;auto_grid) {</span>
<span class="lineNum">    4701 </span>            :                                 e = GF_OK;
<span class="lineNum">    4702 </span>            :                                 self_ref = GF_TRUE;
<span class="lineNum">    4703 </span><span class="lineCov">         92 :                         } else if (!meta-&gt;szPath || (meta-&gt;image_props &amp;&amp; meta-&gt;image_props-&gt;sample_num &amp;&amp; meta-&gt;image_props-&gt;use_reference)) {</span>
<span class="lineNum">    4704 </span>            :                                 e = GF_OK;
<span class="lineNum">    4705 </span>            :                                 self_ref = GF_TRUE;
<span class="lineNum">    4706 </span><span class="lineCov">          2 :                                 src_tk_id = meta-&gt;trackID;</span>
<span class="lineNum">    4707 </span>            :                         } else if (meta-&gt;szPath) {
<span class="lineNum">    4708 </span><span class="lineCov">         90 :                                 if (meta-&gt;image_props &amp;&amp; gf_isom_probe_file(meta-&gt;szPath) &amp;&amp; !meta-&gt;image_props-&gt;tile_mode) {</span>
<span class="lineNum">    4709 </span><span class="lineCov">         13 :                                         meta-&gt;image_props-&gt;src_file = gf_isom_open(meta-&gt;szPath, GF_ISOM_OPEN_READ, NULL);</span>
<span class="lineNum">    4710 </span><span class="lineCov">         13 :                                         e = gf_isom_last_error(meta-&gt;image_props-&gt;src_file);</span>
<span class="lineNum">    4711 </span><span class="lineCov">         13 :                                         fsrc = meta-&gt;image_props-&gt;src_file;</span>
<span class="lineNum">    4712 </span>            :                                 } else {
<span class="lineNum">    4713 </span><span class="lineCov">         77 :                                         e = import_file(file, meta-&gt;szPath, 0, _frac, 0, NULL, NULL, 0);</span>
<span class="lineNum">    4714 </span>            :                                 }
<span class="lineNum">    4715 </span>            :                         } else {
<span class="lineNum">    4716 </span>            :                                 M4_LOG(GF_LOG_ERROR, (&quot;Missing file name to import\n&quot;));
<span class="lineNum">    4717 </span>            :                                 e = GF_BAD_PARAM;
<span class="lineNum">    4718 </span>            :                         }
<span class="lineNum">    4719 </span><span class="lineCov">         94 :                         if (e == GF_OK) {</span>
<span class="lineNum">    4720 </span><span class="lineCov">         94 :                                 u32 meta_type = gf_isom_get_meta_type(file, meta-&gt;root_meta, tk);</span>
<span class="lineNum">    4721 </span><span class="lineCov">         94 :                                 if (!meta_type) {</span>
<span class="lineNum">    4722 </span><span class="lineCov">         51 :                                         e = gf_isom_set_meta_type(file, meta-&gt;root_meta, tk, GF_META_ITEM_TYPE_PICT);</span>
<span class="lineNum">    4723 </span>            :                                 } else {
<span class="lineNum">    4724 </span><span class="lineCov">         43 :                                         if (meta_type != GF_META_ITEM_TYPE_PICT) {</span>
<span class="lineNum">    4725 </span><span class="lineNoCov">          0 :                                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;Warning: file already has a root 'meta' box of type %s\n&quot;, gf_4cc_to_str(meta_type)));</span>
<span class="lineNum">    4726 </span>            :                                                 e = GF_BAD_PARAM;
<span class="lineNum">    4727 </span>            :                                         }
<span class="lineNum">    4728 </span>            :                                 }
<span class="lineNum">    4729 </span><span class="lineCov">         94 :                                 if (e == GF_OK) {</span>
<span class="lineNum">    4730 </span><span class="lineCov">         94 :                                         if (!meta-&gt;item_id) {</span>
<span class="lineNum">    4731 </span><span class="lineCov">         54 :                                                 e = gf_isom_meta_get_next_item_id(file, meta-&gt;root_meta, tk, &amp;meta-&gt;item_id);</span>
<span class="lineNum">    4732 </span>            :                                         }
<span class="lineNum">    4733 </span><span class="lineCov">         94 :                                         if (e == GF_OK) {</span>
<span class="lineNum">    4734 </span><span class="lineCov">         94 :                                                 if (!src_tk_id) {</span>
<span class="lineNum">    4735 </span>            :                                                         u32 j;
<span class="lineNum">    4736 </span><span class="lineCov">          1 :                                                         for (j=0; j&lt;gf_isom_get_track_count(fsrc); j++) {</span>
<span class="lineNum">    4737 </span><span class="lineCov">          1 :                                                                 if (gf_isom_is_video_handler_type (gf_isom_get_media_type(fsrc, j+1))) {</span>
<span class="lineNum">    4738 </span><span class="lineCov">          1 :                                                                         src_tk_id = gf_isom_get_track_id(fsrc, j+1);</span>
<span class="lineNum">    4739 </span><span class="lineCov">          1 :                                                                         break;</span>
<span class="lineNum">    4740 </span>            :                                                                 }
<span class="lineNum">    4741 </span>            :                                                         }
<span class="lineNum">    4742 </span>            : 
<span class="lineNum">    4743 </span><span class="lineCov">          1 :                                                         if (!src_tk_id) {</span>
<span class="lineNum">    4744 </span><span class="lineNoCov">          0 :                                                                 M4_LOG(GF_LOG_ERROR, (&quot;No video track in file, cannot add image from track\n&quot;));</span>
<span class="lineNum">    4745 </span>            :                                                                 e = GF_BAD_PARAM;
<span class="lineNum">    4746 </span><span class="lineNoCov">          0 :                                                                 break;</span>
<span class="lineNum">    4747 </span>            :                                                         }
<span class="lineNum">    4748 </span>            :                                                 }
<span class="lineNum">    4749 </span>            : 
<span class="lineNum">    4750 </span><span class="lineCov">         94 :                                                 e = gf_isom_iff_create_image_item_from_track(file, meta-&gt;root_meta, tk, src_tk_id, meta-&gt;szName, meta-&gt;item_id, meta-&gt;image_props, NULL);</span>
<span class="lineNum">    4751 </span><span class="lineCov">         94 :                                                 if (e == GF_OK &amp;&amp; meta-&gt;primary) {</span>
<span class="lineNum">    4752 </span><span class="lineCov">         21 :                                                         e = gf_isom_set_meta_primary_item(file, meta-&gt;root_meta, tk, meta-&gt;item_id);</span>
<span class="lineNum">    4753 </span>            :                                                 }
<span class="lineNum">    4754 </span><span class="lineCov">         94 :                                                 if (e == GF_OK &amp;&amp; meta-&gt;item_refs &amp;&amp; gf_list_count(meta-&gt;item_refs)) {</span>
<span class="lineNum">    4755 </span>            :                                                         u32 ref_i;
<span class="lineNum">    4756 </span><span class="lineCov">          1 :                                                         for (ref_i = 0; ref_i &lt; gf_list_count(meta-&gt;item_refs); ref_i++) {</span>
<span class="lineNum">    4757 </span><span class="lineCov">          1 :                                                                 MetaRef *ref_entry = gf_list_get(meta-&gt;item_refs, ref_i);</span>
<span class="lineNum">    4758 </span><span class="lineCov">          1 :                                                                 e = gf_isom_meta_add_item_ref(file, meta-&gt;root_meta, tk, meta-&gt;item_id, ref_entry-&gt;ref_item_id, ref_entry-&gt;ref_type, NULL);</span>
<span class="lineNum">    4759 </span>            :                                                         }
<span class="lineNum">    4760 </span>            :                                                 }
<span class="lineNum">    4761 </span><span class="lineCov">         94 :                                                 if (e == GF_OK &amp;&amp; meta-&gt;group_type) {</span>
<span class="lineNum">    4762 </span><span class="lineNoCov">          0 :                                                         e = gf_isom_meta_add_item_group(file, meta-&gt;root_meta, tk, meta-&gt;item_id, meta-&gt;group_id, meta-&gt;group_type);</span>
<span class="lineNum">    4763 </span>            :                                                 }
<span class="lineNum">    4764 </span>            :                                         }
<span class="lineNum">    4765 </span>            :                                 }
<span class="lineNum">    4766 </span>            :                         }
<span class="lineNum">    4767 </span><span class="lineCov">         94 :                         if (meta-&gt;image_props &amp;&amp; meta-&gt;image_props-&gt;src_file) {</span>
<span class="lineNum">    4768 </span><span class="lineCov">         13 :                                 gf_isom_delete(meta-&gt;image_props-&gt;src_file);</span>
<span class="lineNum">    4769 </span><span class="lineCov">         13 :                                 meta-&gt;image_props-&gt;src_file = NULL;</span>
<span class="lineNum">    4770 </span><span class="lineCov">         81 :                         } else if (!self_ref) {</span>
<span class="lineNum">    4771 </span><span class="lineCov">         77 :                                 gf_isom_remove_track(file, old_tk_count+1);</span>
<span class="lineNum">    4772 </span><span class="lineCov">         77 :                                 if (do_flat) {</span>
<span class="lineNum">    4773 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_ERROR, (&quot;Warning: -flat storage cannot be used when using -add-image on external file\n&quot;));</span>
<span class="lineNum">    4774 </span>            :                                         e = GF_NOT_SUPPORTED;
<span class="lineNum">    4775 </span>            :                                 }
<span class="lineNum">    4776 </span>            :                         }
<span class="lineNum">    4777 </span><span class="lineCov">         94 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4778 </span>            :                 }
<span class="lineNum">    4779 </span><span class="lineCov">         94 :                         break;</span>
<span class="lineNum">    4780 </span><span class="lineCov">          7 :                 case META_ACTION_ADD_IMAGE_GRID:</span>
<span class="lineNum">    4781 </span>            :                 {
<span class="lineNum">    4782 </span><span class="lineCov">          7 :                         u32 meta_type = gf_isom_get_meta_type(file, meta-&gt;root_meta, tk);</span>
<span class="lineNum">    4783 </span>            :                         e = GF_OK;
<span class="lineNum">    4784 </span><span class="lineCov">          7 :                         if (!meta_type) {</span>
<span class="lineNum">    4785 </span><span class="lineCov">          7 :                                 e = gf_isom_set_meta_type(file, meta-&gt;root_meta, tk, GF_META_ITEM_TYPE_PICT);</span>
<span class="lineNum">    4786 </span>            :                         } else {
<span class="lineNum">    4787 </span><span class="lineNoCov">          0 :                                 if (meta_type != GF_META_ITEM_TYPE_PICT) {</span>
<span class="lineNum">    4788 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;Warning: file already has a root 'meta' box of type %s\n&quot;, gf_4cc_to_str(meta_type)));</span>
<span class="lineNum">    4789 </span>            :                                         e = GF_BAD_PARAM;
<span class="lineNum">    4790 </span>            :                                 }
<span class="lineNum">    4791 </span>            :                         }
<span class="lineNum">    4792 </span><span class="lineCov">          7 :                         if (e == GF_OK) {</span>
<span class="lineNum">    4793 </span><span class="lineCov">          7 :                                 if (!meta-&gt;item_id) {</span>
<span class="lineNum">    4794 </span><span class="lineNoCov">          0 :                                         e = gf_isom_meta_get_next_item_id(file, meta-&gt;root_meta, tk, &amp;meta-&gt;item_id);</span>
<span class="lineNum">    4795 </span>            :                                 }
<span class="lineNum">    4796 </span><span class="lineCov">          7 :                                 if (e == GF_OK) {</span>
<span class="lineNum">    4797 </span><span class="lineCov">         14 :                                         e = gf_isom_iff_create_image_grid_item(file, meta-&gt;root_meta, tk,</span>
<span class="lineNum">    4798 </span><span class="lineCov">          7 :                                                         meta-&gt;szName &amp;&amp; strlen(meta-&gt;szName) ? meta-&gt;szName : NULL,</span>
<span class="lineNum">    4799 </span>            :                                                         meta-&gt;item_id,
<span class="lineNum">    4800 </span>            :                                                         meta-&gt;image_props);
<span class="lineNum">    4801 </span><span class="lineCov">          7 :                                         if (e == GF_OK &amp;&amp; meta-&gt;primary) {</span>
<span class="lineNum">    4802 </span><span class="lineCov">          7 :                                                 e = gf_isom_set_meta_primary_item(file, meta-&gt;root_meta, tk, meta-&gt;item_id);</span>
<span class="lineNum">    4803 </span>            :                                         }
<span class="lineNum">    4804 </span><span class="lineCov">          7 :                                         if (e == GF_OK &amp;&amp; meta-&gt;item_refs &amp;&amp; gf_list_count(meta-&gt;item_refs)) {</span>
<span class="lineNum">    4805 </span>            :                                                 u32 ref_i;
<span class="lineNum">    4806 </span><span class="lineCov">         36 :                                                 for (ref_i = 0; ref_i &lt; gf_list_count(meta-&gt;item_refs); ref_i++) {</span>
<span class="lineNum">    4807 </span><span class="lineCov">         36 :                                                         MetaRef *ref_entry = gf_list_get(meta-&gt;item_refs, ref_i);</span>
<span class="lineNum">    4808 </span><span class="lineCov">         36 :                                                         e = gf_isom_meta_add_item_ref(file, meta-&gt;root_meta, tk, meta-&gt;item_id, ref_entry-&gt;ref_item_id, ref_entry-&gt;ref_type, NULL);</span>
<span class="lineNum">    4809 </span>            :                                                 }
<span class="lineNum">    4810 </span>            :                                         }
<span class="lineNum">    4811 </span>            :                                 }
<span class="lineNum">    4812 </span>            :                         }
<span class="lineNum">    4813 </span><span class="lineCov">          7 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4814 </span>            :                 }
<span class="lineNum">    4815 </span><span class="lineCov">          7 :                         break;</span>
<span class="lineNum">    4816 </span><span class="lineCov">          4 :                 case META_ACTION_REM_ITEM:</span>
<span class="lineNum">    4817 </span><span class="lineCov">          4 :                         e = gf_isom_remove_meta_item(file, meta-&gt;root_meta, tk, meta-&gt;item_id);</span>
<span class="lineNum">    4818 </span><span class="lineCov">          4 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4819 </span><span class="lineCov">          4 :                         break;</span>
<span class="lineNum">    4820 </span><span class="lineCov">          1 :                 case META_ACTION_SET_PRIMARY_ITEM:</span>
<span class="lineNum">    4821 </span><span class="lineCov">          1 :                         e = gf_isom_set_meta_primary_item(file, meta-&gt;root_meta, tk, meta-&gt;item_id);</span>
<span class="lineNum">    4822 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4823 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    4824 </span><span class="lineCov">          1 :                 case META_ACTION_SET_XML:</span>
<span class="lineNum">    4825 </span>            :                 case META_ACTION_SET_BINARY_XML:
<span class="lineNum">    4826 </span><span class="lineCov">          1 :                         e = gf_isom_set_meta_xml(file, meta-&gt;root_meta, tk, meta-&gt;szPath, NULL, 0, (meta-&gt;act_type==META_ACTION_SET_BINARY_XML) ? 1 : 0);</span>
<span class="lineNum">    4827 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4828 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    4829 </span><span class="lineCov">          1 :                 case META_ACTION_REM_XML:</span>
<span class="lineNum">    4830 </span><span class="lineCov">          1 :                         if (gf_isom_get_meta_item_count(file, meta-&gt;root_meta, tk)) {</span>
<span class="lineNum">    4831 </span><span class="lineNoCov">          0 :                                 e = gf_isom_remove_meta_xml(file, meta-&gt;root_meta, tk);</span>
<span class="lineNum">    4832 </span><span class="lineNoCov">          0 :                                 do_save = GF_TRUE;</span>
<span class="lineNum">    4833 </span>            :                         } else {
<span class="lineNum">    4834 </span><span class="lineCov">          1 :                                 M4_LOG(GF_LOG_WARNING, (&quot;No meta box in input file\n&quot;));</span>
<span class="lineNum">    4835 </span>            :                                 e = GF_OK;
<span class="lineNum">    4836 </span>            :                         }
<span class="lineNum">    4837 </span>            :                         break;
<span class="lineNum">    4838 </span><span class="lineCov">          5 :                 case META_ACTION_DUMP_ITEM:</span>
<span class="lineNum">    4839 </span><span class="lineCov">          5 :                         if (gf_isom_get_meta_item_count(file, meta-&gt;root_meta, tk)) {</span>
<span class="lineNum">    4840 </span><span class="lineCov">          5 :                                 e = gf_isom_extract_meta_item(file, meta-&gt;root_meta, tk, meta-&gt;item_id, meta-&gt;szPath &amp;&amp; strlen(meta-&gt;szPath) ? meta-&gt;szPath : NULL);</span>
<span class="lineNum">    4841 </span>            :                         } else {
<span class="lineNum">    4842 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_WARNING, (&quot;No meta box in input file\n&quot;));</span>
<span class="lineNum">    4843 </span>            :                                 e = GF_OK;
<span class="lineNum">    4844 </span>            :                         }
<span class="lineNum">    4845 </span>            :                         break;
<span class="lineNum">    4846 </span>            : #endif // GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    4847 </span>            : 
<span class="lineNum">    4848 </span><span class="lineCov">          1 :                 case META_ACTION_DUMP_XML:</span>
<span class="lineNum">    4849 </span><span class="lineCov">          1 :                         if (gf_isom_has_meta_xml(file, meta-&gt;root_meta, tk)) {</span>
<span class="lineNum">    4850 </span><span class="lineCov">          1 :                                 e = gf_isom_extract_meta_xml(file, meta-&gt;root_meta, tk, meta-&gt;szPath, NULL);</span>
<span class="lineNum">    4851 </span>            :                         } else {
<span class="lineNum">    4852 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_WARNING, (&quot;No meta box in input file\n&quot;));</span>
<span class="lineNum">    4853 </span>            :                                 e = GF_OK;
<span class="lineNum">    4854 </span>            :                         }
<span class="lineNum">    4855 </span>            :                         break;
<span class="lineNum">    4856 </span>            :                 default:
<span class="lineNum">    4857 </span>            :                         break;
<span class="lineNum">    4858 </span>            :                 }
<span class="lineNum">    4859 </span><span class="lineCov">        122 :                 if (meta-&gt;item_refs) {</span>
<span class="lineNum">    4860 </span><span class="lineCov">         45 :                         while (gf_list_count(meta-&gt;item_refs)) {</span>
<span class="lineNum">    4861 </span><span class="lineCov">         37 :                                 gf_free(gf_list_pop_back(meta-&gt;item_refs));</span>
<span class="lineNum">    4862 </span>            :                         }
<span class="lineNum">    4863 </span><span class="lineCov">          8 :                         gf_list_del(meta-&gt;item_refs);</span>
<span class="lineNum">    4864 </span><span class="lineCov">          8 :                         meta-&gt;item_refs = NULL;</span>
<span class="lineNum">    4865 </span>            :                 }
<span class="lineNum">    4866 </span><span class="lineCov">        122 :                 if (meta-&gt;image_props) {</span>
<span class="lineNum">    4867 </span><span class="lineCov">         60 :                         gf_free(meta-&gt;image_props);</span>
<span class="lineNum">    4868 </span><span class="lineCov">         60 :                         meta-&gt;image_props = NULL;</span>
<span class="lineNum">    4869 </span>            :                 }
<span class="lineNum">    4870 </span><span class="lineCov">        122 :                 if (e) return e;</span>
<span class="lineNum">    4871 </span>            :         }
<span class="lineNum">    4872 </span>            :         return GF_OK;
<a name="4873"><span class="lineNum">    4873 </span>            : }</a>
<span class="lineNum">    4874 </span>            : 
<span class="lineNum">    4875 </span><span class="lineCov">        971 : static GF_Err do_tsel_act()</span>
<span class="lineNum">    4876 </span>            : {
<span class="lineNum">    4877 </span>            :         u32 i;
<span class="lineNum">    4878 </span>            :         GF_Err e;
<span class="lineNum">    4879 </span><span class="lineCov">        977 :         for (i=0; i&lt;nb_tsel_acts; i++) {</span>
<span class="lineNum">    4880 </span><span class="lineCov">          6 :                 switch (tsel_acts[i].act_type) {</span>
<span class="lineNum">    4881 </span><span class="lineCov">          4 :                 case TSEL_ACTION_SET_PARAM:</span>
<span class="lineNum">    4882 </span><span class="lineCov">         22 :                         e = gf_isom_set_track_switch_parameter(file,</span>
<span class="lineNum">    4883 </span><span class="lineCov">          4 :                                                                gf_isom_get_track_by_id(file, tsel_acts[i].trackID),</span>
<span class="lineNum">    4884 </span><span class="lineCov">          6 :                                                                tsel_acts[i].refTrackID ? gf_isom_get_track_by_id(file, tsel_acts[i].refTrackID) : 0,</span>
<span class="lineNum">    4885 </span><span class="lineCov">          4 :                                                                tsel_acts[i].is_switchGroup ? 1 : 0,</span>
<span class="lineNum">    4886 </span>            :                                                                &amp;tsel_acts[i].switchGroupID,
<span class="lineNum">    4887 </span><span class="lineCov">          4 :                                                                tsel_acts[i].criteria, tsel_acts[i].nb_criteria);</span>
<span class="lineNum">    4888 </span><span class="lineCov">          4 :                         if (e == GF_BAD_PARAM) {</span>
<span class="lineNum">    4889 </span>            :                                 u32 alternateGroupID, nb_groups;
<span class="lineNum">    4890 </span><span class="lineNoCov">          0 :                                 gf_isom_get_track_switch_group_count(file, gf_isom_get_track_by_id(file, tsel_acts[i].trackID), &amp;alternateGroupID, &amp;nb_groups);</span>
<span class="lineNum">    4891 </span><span class="lineNoCov">          0 :                                 if (alternateGroupID) {</span>
<span class="lineNum">    4892 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_ERROR, (&quot;Error - for adding more tracks to group, using: -group-add -refTrack=ID1:[criteria:]trackID=ID2\n&quot;));</span>
<span class="lineNum">    4893 </span>            :                                 } else {
<span class="lineNum">    4894 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_ERROR, (&quot;Error - for creating a new grouping information, using -group-add -trackID=ID1:[criteria:]trackID=ID2\n&quot;));</span>
<span class="lineNum">    4895 </span>            :                                 }
<span class="lineNum">    4896 </span>            :                         }
<span class="lineNum">    4897 </span><span class="lineCov">          4 :                         if (e) return e;</span>
<span class="lineNum">    4898 </span><span class="lineCov">          4 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4899 </span><span class="lineCov">          4 :                         break;</span>
<span class="lineNum">    4900 </span><span class="lineCov">          1 :                 case TSEL_ACTION_REMOVE_TSEL:</span>
<span class="lineNum">    4901 </span><span class="lineCov">          1 :                         e = gf_isom_reset_track_switch_parameter(file, gf_isom_get_track_by_id(file, tsel_acts[i].trackID), 0);</span>
<span class="lineNum">    4902 </span><span class="lineCov">          1 :                         if (e) return e;</span>
<span class="lineNum">    4903 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4904 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    4905 </span><span class="lineCov">          1 :                 case TSEL_ACTION_REMOVE_ALL_TSEL_IN_GROUP:</span>
<span class="lineNum">    4906 </span><span class="lineCov">          1 :                         e = gf_isom_reset_track_switch_parameter(file, gf_isom_get_track_by_id(file, tsel_acts[i].trackID), 1);</span>
<span class="lineNum">    4907 </span><span class="lineCov">          1 :                         if (e) return e;</span>
<span class="lineNum">    4908 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4909 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    4910 </span>            :                 default:
<span class="lineNum">    4911 </span>            :                         break;
<span class="lineNum">    4912 </span>            :                 }
<span class="lineNum">    4913 </span>            :         }
<span class="lineNum">    4914 </span>            :         return GF_OK;
<a name="4915"><span class="lineNum">    4915 </span>            : }</a>
<span class="lineNum">    4916 </span>            : 
<span class="lineNum">    4917 </span><span class="lineCov">          1 : static void do_ipod_conv()</span>
<span class="lineNum">    4918 </span>            : {
<span class="lineNum">    4919 </span>            :         u32 i, ipod_major_brand = 0;
<span class="lineNum">    4920 </span><span class="lineCov">          1 :         M4_LOG(GF_LOG_INFO, (&quot;Setting up iTunes/iPod file\n&quot;));</span>
<span class="lineNum">    4921 </span>            : 
<span class="lineNum">    4922 </span><span class="lineCov">          3 :         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    4923 </span><span class="lineCov">          2 :                 u32 mType = gf_isom_get_media_type(file, i+1);</span>
<span class="lineNum">    4924 </span><span class="lineCov">          2 :                 switch (mType) {</span>
<span class="lineNum">    4925 </span><span class="lineCov">          1 :                 case GF_ISOM_MEDIA_VISUAL:</span>
<span class="lineNum">    4926 </span>            :                 case GF_ISOM_MEDIA_AUXV:
<span class="lineNum">    4927 </span>            :                 case GF_ISOM_MEDIA_PICT:
<span class="lineNum">    4928 </span>            :                         ipod_major_brand = GF_ISOM_BRAND_M4V;
<span class="lineNum">    4929 </span><span class="lineCov">          1 :                         gf_isom_set_ipod_compatible(file, i+1);</span>
<span class="lineNum">    4930 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    4931 </span><span class="lineCov">          1 :                 case GF_ISOM_MEDIA_AUDIO:</span>
<span class="lineNum">    4932 </span><span class="lineCov">          1 :                         if (!ipod_major_brand) ipod_major_brand = GF_ISOM_BRAND_M4A;</span>
<span class="lineNum">    4933 </span><span class="lineCov">          1 :                         else gf_isom_modify_alternate_brand(file, GF_ISOM_BRAND_M4A, GF_TRUE);</span>
<span class="lineNum">    4934 </span>            :                         break;
<span class="lineNum">    4935 </span><span class="lineNoCov">          0 :                 case GF_ISOM_MEDIA_TEXT:</span>
<span class="lineNum">    4936 </span>            :                         /*this is a text track track*/
<span class="lineNum">    4937 </span><span class="lineNoCov">          0 :                         if (gf_isom_get_media_subtype(file, i+1, 1) == GF_ISOM_SUBTYPE_TX3G) {</span>
<span class="lineNum">    4938 </span>            :                                 Bool is_chap = 0;
<span class="lineNum">    4939 </span>            :                                 u32 j;
<span class="lineNum">    4940 </span><span class="lineNoCov">          0 :                                 for (j=0; j&lt;gf_isom_get_track_count(file); j++) {</span>
<span class="lineNum">    4941 </span><span class="lineNoCov">          0 :                                         s32 count = gf_isom_get_reference_count(file, j+1, GF_ISOM_REF_CHAP);</span>
<span class="lineNum">    4942 </span><span class="lineNoCov">          0 :                                         if (count&gt;0) {</span>
<span class="lineNum">    4943 </span>            :                                                 u32 tk, k;
<span class="lineNum">    4944 </span><span class="lineNoCov">          0 :                                                 for (k=0; k&lt;(u32) count; k++) {</span>
<span class="lineNum">    4945 </span><span class="lineNoCov">          0 :                                                         gf_isom_get_reference(file, j+1, GF_ISOM_REF_CHAP, k+1, &amp;tk);</span>
<span class="lineNum">    4946 </span><span class="lineNoCov">          0 :                                                         if (tk==i+1) {</span>
<span class="lineNum">    4947 </span>            :                                                                 is_chap = 1;
<span class="lineNum">    4948 </span>            :                                                                 break;
<span class="lineNum">    4949 </span>            :                                                         }
<span class="lineNum">    4950 </span>            :                                                 }
<span class="lineNum">    4951 </span><span class="lineNoCov">          0 :                                                 if (is_chap) break;</span>
<span class="lineNum">    4952 </span>            :                                         }
<span class="lineNum">    4953 </span><span class="lineNoCov">          0 :                                         if (is_chap) break;</span>
<span class="lineNum">    4954 </span>            :                                 }
<span class="lineNum">    4955 </span>            :                                 /*this is a subtitle track*/
<span class="lineNum">    4956 </span><span class="lineNoCov">          0 :                                 if (!is_chap)</span>
<span class="lineNum">    4957 </span><span class="lineNoCov">          0 :                                         gf_isom_set_media_type(file, i+1, GF_ISOM_MEDIA_SUBT);</span>
<span class="lineNum">    4958 </span>            :                         }
<span class="lineNum">    4959 </span>            :                         break;
<span class="lineNum">    4960 </span>            :                 }
<span class="lineNum">    4961 </span>            :         }
<span class="lineNum">    4962 </span><span class="lineCov">          1 :         gf_isom_set_brand_info(file, ipod_major_brand, 1);</span>
<span class="lineNum">    4963 </span><span class="lineCov">          1 :         gf_isom_modify_alternate_brand(file, GF_ISOM_BRAND_MP42, GF_TRUE);</span>
<span class="lineNum">    4964 </span><span class="lineCov">          1 :         do_save = GF_TRUE;</span>
<a name="4965"><span class="lineNum">    4965 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    4966 </span>            : 
<span class="lineNum">    4967 </span><span class="lineCov">        971 : static GF_Err do_track_act()</span>
<span class="lineNum">    4968 </span>            : {
<span class="lineNum">    4969 </span>            :         u32 j;
<span class="lineNum">    4970 </span><span class="lineCov">       1070 :         for (j=0; j&lt;nb_track_act; j++) {</span>
<span class="lineNum">    4971 </span>            :                 u32 i;
<span class="lineNum">    4972 </span>            :                 GF_Err e = GF_OK;
<span class="lineNum">    4973 </span><span class="lineCov">        100 :                 TrackAction *tka = &amp;tracks[j];</span>
<span class="lineNum">    4974 </span><span class="lineCov">        100 :                 u32 track = tka-&gt;trackID ? gf_isom_get_track_by_id(file, tka-&gt;trackID) : 0;</span>
<span class="lineNum">    4975 </span>            : 
<span class="lineNum">    4976 </span><span class="lineCov">        100 :                 timescale = gf_isom_get_timescale(file);</span>
<span class="lineNum">    4977 </span><span class="lineCov">        100 :                 switch (tka-&gt;act_type) {</span>
<span class="lineNum">    4978 </span><span class="lineCov">          1 :                 case TRAC_ACTION_REM_TRACK:</span>
<span class="lineNum">    4979 </span><span class="lineCov">          1 :                         e = gf_isom_remove_track(file, track);</span>
<span class="lineNum">    4980 </span><span class="lineCov">          1 :                         if (e) {</span>
<span class="lineNum">    4981 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Error Removing track ID %d: %s\n&quot;, tka-&gt;trackID, gf_error_to_string(e)));</span>
<span class="lineNum">    4982 </span>            :                         } else {
<span class="lineNum">    4983 </span><span class="lineCov">          1 :                                 M4_LOG(GF_LOG_INFO, (&quot;Removing track ID %d\n&quot;, tka-&gt;trackID));</span>
<span class="lineNum">    4984 </span>            :                         }
<span class="lineNum">    4985 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4986 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    4987 </span>            :                 case TRAC_ACTION_SET_LANGUAGE:
<span class="lineNum">    4988 </span><span class="lineCov">         22 :                         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    4989 </span><span class="lineCov">         22 :                                 if (track &amp;&amp; (track != i+1)) continue;</span>
<span class="lineNum">    4990 </span><span class="lineCov">         18 :                                 e = gf_isom_set_media_language(file, i+1, tka-&gt;lang);</span>
<span class="lineNum">    4991 </span><span class="lineCov">         18 :                                 if (e) return e;</span>
<span class="lineNum">    4992 </span><span class="lineCov">         18 :                                 do_save = GF_TRUE;</span>
<span class="lineNum">    4993 </span>            :                         }
<span class="lineNum">    4994 </span><span class="lineCov">         11 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    4995 </span><span class="lineCov">         11 :                         break;</span>
<span class="lineNum">    4996 </span>            :                 case TRAC_ACTION_SET_KIND:
<span class="lineNum">    4997 </span><span class="lineCov">         62 :                         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    4998 </span><span class="lineCov">         62 :                                 if (track &amp;&amp; (track != i+1)) continue;</span>
<span class="lineNum">    4999 </span><span class="lineCov">         56 :                                 e = gf_isom_add_track_kind(file, i+1, tka-&gt;kind_scheme, tka-&gt;kind_value);</span>
<span class="lineNum">    5000 </span><span class="lineCov">         56 :                                 if (e) return e;</span>
<span class="lineNum">    5001 </span><span class="lineCov">         56 :                                 do_save = GF_TRUE;</span>
<span class="lineNum">    5002 </span>            :                         }
<span class="lineNum">    5003 </span><span class="lineCov">         31 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5004 </span><span class="lineCov">         31 :                         break;</span>
<span class="lineNum">    5005 </span>            :                 case TRAC_ACTION_REM_KIND:
<span class="lineNum">    5006 </span><span class="lineCov">         44 :                         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    5007 </span><span class="lineCov">         44 :                                 if (track &amp;&amp; (track != i+1)) continue;</span>
<span class="lineNum">    5008 </span><span class="lineCov">         38 :                                 e = gf_isom_remove_track_kind(file, i+1, tka-&gt;kind_scheme, tka-&gt;kind_value);</span>
<span class="lineNum">    5009 </span><span class="lineCov">         38 :                                 if (e) return e;</span>
<span class="lineNum">    5010 </span><span class="lineCov">         38 :                                 do_save = GF_TRUE;</span>
<span class="lineNum">    5011 </span>            :                         }
<span class="lineNum">    5012 </span><span class="lineCov">         22 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5013 </span><span class="lineCov">         22 :                         break;</span>
<span class="lineNum">    5014 </span><span class="lineCov">          1 :                 case TRAC_ACTION_SET_DELAY:</span>
<span class="lineNum">    5015 </span><span class="lineCov">          1 :                         if (tka-&gt;delay.num &amp;&amp; tka-&gt;delay.den) {</span>
<span class="lineNum">    5016 </span>            :                                 u64 tk_dur;
<span class="lineNum">    5017 </span>            : 
<span class="lineNum">    5018 </span><span class="lineCov">          1 :                                 e = gf_isom_remove_edits(file, track);</span>
<span class="lineNum">    5019 </span><span class="lineCov">          1 :                                 if (e) return e;</span>
<span class="lineNum">    5020 </span><span class="lineNoCov">          0 :                                 tk_dur = gf_isom_get_track_duration(file, track);</span>
<span class="lineNum">    5021 </span><span class="lineNoCov">          0 :                                 if (gf_isom_get_edits_count(file, track))</span>
<span class="lineNum">    5022 </span><span class="lineNoCov">          0 :                                         do_save = GF_TRUE;</span>
<span class="lineNum">    5023 </span><span class="lineNoCov">          0 :                                 if (tka-&gt;delay.num&gt;0) {</span>
<span class="lineNum">    5024 </span>            :                                         //cast to u64, delay_ms * timescale can be quite big before / 1000
<span class="lineNum">    5025 </span><span class="lineNoCov">          0 :                                         e = gf_isom_append_edit(file, track, ((u64) tka-&gt;delay.num) * timescale / tka-&gt;delay.den, 0, GF_ISOM_EDIT_EMPTY);</span>
<span class="lineNum">    5026 </span><span class="lineNoCov">          0 :                                         if (e) return e;</span>
<span class="lineNum">    5027 </span><span class="lineNoCov">          0 :                                         e = gf_isom_append_edit(file, track, tk_dur, 0, GF_ISOM_EDIT_NORMAL);</span>
<span class="lineNum">    5028 </span><span class="lineNoCov">          0 :                                         if (e) return e;</span>
<span class="lineNum">    5029 </span><span class="lineNoCov">          0 :                                         do_save = GF_TRUE;</span>
<span class="lineNum">    5030 </span>            :                                 } else {
<span class="lineNum">    5031 </span>            :                                         //cast to u64, delay_ms * timescale can be quite big before / 1000
<span class="lineNum">    5032 </span><span class="lineNoCov">          0 :                                         u64 to_skip = ((u64) -tka-&gt;delay.num) * timescale / tka-&gt;delay.den;</span>
<span class="lineNum">    5033 </span><span class="lineNoCov">          0 :                                         if (to_skip&lt;tk_dur) {</span>
<span class="lineNum">    5034 </span>            :                                                 //cast to u64, delay_ms * timescale can be quite big before / 1000
<span class="lineNum">    5035 </span><span class="lineNoCov">          0 :                                                 u64 media_time = ((u64) -tka-&gt;delay.num) * gf_isom_get_media_timescale(file, track) / tka-&gt;delay.den;</span>
<span class="lineNum">    5036 </span><span class="lineNoCov">          0 :                                                 e = gf_isom_append_edit(file, track, tk_dur-to_skip, media_time, GF_ISOM_EDIT_NORMAL);</span>
<span class="lineNum">    5037 </span><span class="lineNoCov">          0 :                                                 if (e) return e;</span>
<span class="lineNum">    5038 </span><span class="lineNoCov">          0 :                                                 do_save = GF_TRUE;</span>
<span class="lineNum">    5039 </span>            :                                         } else {
<span class="lineNum">    5040 </span><span class="lineNoCov">          0 :                                                 M4_LOG(GF_LOG_WARNING, (&quot;Warning: request negative delay longer than track duration - ignoring\n&quot;));</span>
<span class="lineNum">    5041 </span>            :                                         }
<span class="lineNum">    5042 </span>            :                                 }
<span class="lineNum">    5043 </span><span class="lineNoCov">          0 :                         } else if (gf_isom_get_edits_count(file, track)) {</span>
<span class="lineNum">    5044 </span><span class="lineNoCov">          0 :                                 e = gf_isom_remove_edits(file, track);</span>
<span class="lineNum">    5045 </span><span class="lineNoCov">          0 :                                 if (e) return e;</span>
<span class="lineNum">    5046 </span><span class="lineNoCov">          0 :                                 do_save = GF_TRUE;</span>
<span class="lineNum">    5047 </span>            :                         }
<span class="lineNum">    5048 </span>            :                         break;
<span class="lineNum">    5049 </span>            :                 case TRAC_ACTION_SET_KMS_URI:
<span class="lineNum">    5050 </span><span class="lineCov">          5 :                         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    5051 </span><span class="lineCov">          5 :                                 if (track &amp;&amp; (track != i+1)) continue;</span>
<span class="lineNum">    5052 </span><span class="lineCov">          5 :                                 if (!gf_isom_is_media_encrypted(file, i+1, 1)) continue;</span>
<span class="lineNum">    5053 </span><span class="lineCov">          5 :                                 if (!gf_isom_is_ismacryp_media(file, i+1, 1)) continue;</span>
<span class="lineNum">    5054 </span><span class="lineCov">          5 :                                 e = gf_isom_change_ismacryp_protection(file, i+1, 1, NULL, (char *) tka-&gt;kms);</span>
<span class="lineNum">    5055 </span><span class="lineCov">          5 :                                 if (e) return e;</span>
<span class="lineNum">    5056 </span><span class="lineCov">          5 :                                 do_save = GF_TRUE;</span>
<span class="lineNum">    5057 </span>            :                         }
<span class="lineNum">    5058 </span>            :                         break;
<span class="lineNum">    5059 </span><span class="lineCov">          1 :                 case TRAC_ACTION_SET_ID:</span>
<span class="lineNum">    5060 </span><span class="lineCov">          1 :                         if (!tka-&gt;trackID &amp;&amp; (gf_isom_get_track_count(file) == 1)) {</span>
<span class="lineNum">    5061 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_WARNING, (&quot;Warning: track id is not specified, but file has only one track - assume that you want to change id for this track\n&quot;));</span>
<span class="lineNum">    5062 </span>            :                                 track = 1;
<span class="lineNum">    5063 </span>            :                         }
<span class="lineNum">    5064 </span><span class="lineCov">          1 :                         if (track) {</span>
<span class="lineNum">    5065 </span>            :                                 u32 newTrack;
<span class="lineNum">    5066 </span><span class="lineCov">          1 :                                 newTrack = gf_isom_get_track_by_id(file, tka-&gt;newTrackID);</span>
<span class="lineNum">    5067 </span><span class="lineCov">          1 :                                 if (newTrack != 0) {</span>
<span class="lineNum">    5068 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_WARNING, (&quot;Cannot set track id with value %d because a track already exists - ignoring&quot;, tka-&gt;newTrackID));</span>
<span class="lineNum">    5069 </span>            :                                 } else {
<span class="lineNum">    5070 </span><span class="lineCov">          1 :                                         e = gf_isom_set_track_id(file, track, tka-&gt;newTrackID);</span>
<span class="lineNum">    5071 </span><span class="lineCov">          1 :                                         if (e) return e;</span>
<span class="lineNum">    5072 </span><span class="lineCov">          1 :                                         do_save = GF_TRUE;</span>
<span class="lineNum">    5073 </span>            :                                 }
<span class="lineNum">    5074 </span>            :                         } else {
<span class="lineNum">    5075 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_WARNING, (&quot;Error: Cannot change id for track %d because it does not exist - ignoring&quot;, tka-&gt;trackID));</span>
<span class="lineNum">    5076 </span>            :                         }
<span class="lineNum">    5077 </span>            :                         break;
<span class="lineNum">    5078 </span><span class="lineCov">          1 :                 case TRAC_ACTION_SWAP_ID:</span>
<span class="lineNum">    5079 </span><span class="lineCov">          1 :                         if (track) {</span>
<span class="lineNum">    5080 </span>            :                                 u32 tk1, tk2;
<span class="lineNum">    5081 </span><span class="lineCov">          1 :                                 tk1 = gf_isom_get_track_by_id(file, tka-&gt;trackID);</span>
<span class="lineNum">    5082 </span><span class="lineCov">          1 :                                 tk2 = gf_isom_get_track_by_id(file, tka-&gt;newTrackID);</span>
<span class="lineNum">    5083 </span><span class="lineCov">          1 :                                 if (!tk1 || !tk2) {</span>
<span class="lineNum">    5084 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_WARNING, (&quot;Error: Cannot swap track IDs because not existing - ignoring&quot;));</span>
<span class="lineNum">    5085 </span>            :                                 } else {
<span class="lineNum">    5086 </span><span class="lineCov">          1 :                                         e = gf_isom_set_track_id(file, tk2, 0);</span>
<span class="lineNum">    5087 </span><span class="lineCov">          1 :                                         if (e) return e;</span>
<span class="lineNum">    5088 </span><span class="lineCov">          1 :                                         e = gf_isom_set_track_id(file, tk1, tka-&gt;newTrackID);</span>
<span class="lineNum">    5089 </span><span class="lineCov">          1 :                                         if (e) return e;</span>
<span class="lineNum">    5090 </span><span class="lineCov">          1 :                                         e = gf_isom_set_track_id(file, tk2, tka-&gt;trackID);</span>
<span class="lineNum">    5091 </span><span class="lineCov">          1 :                                         if (e) return e;</span>
<span class="lineNum">    5092 </span><span class="lineCov">          1 :                                         do_save = GF_TRUE;</span>
<span class="lineNum">    5093 </span>            :                                 }
<span class="lineNum">    5094 </span>            :                         } else {
<span class="lineNum">    5095 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_WARNING, (&quot;Error: Cannot change id for track %d because it does not exist - ignoring&quot;, tka-&gt;trackID));</span>
<span class="lineNum">    5096 </span>            :                         }
<span class="lineNum">    5097 </span>            :                         break;
<span class="lineNum">    5098 </span><span class="lineCov">         12 :                 case TRAC_ACTION_SET_PAR:</span>
<span class="lineNum">    5099 </span><span class="lineCov">         12 :                         e = gf_media_change_par(file, track, tka-&gt;par_num, tka-&gt;par_den, tka-&gt;force_par, tka-&gt;rewrite_bs);</span>
<span class="lineNum">    5100 </span><span class="lineCov">         12 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5101 </span><span class="lineCov">         12 :                         break;</span>
<span class="lineNum">    5102 </span><span class="lineCov">          2 :                 case TRAC_ACTION_SET_CLAP:</span>
<span class="lineNum">    5103 </span><span class="lineCov">          2 :                         e = gf_isom_set_clean_aperture(file, track, 1, tka-&gt;clap_wnum, tka-&gt;clap_wden, tka-&gt;clap_hnum, tka-&gt;clap_hden, tka-&gt;clap_honum, tka-&gt;clap_hoden, tka-&gt;clap_vonum, tka-&gt;clap_voden);</span>
<span class="lineNum">    5104 </span><span class="lineCov">          2 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5105 </span><span class="lineCov">          2 :                         break;</span>
<span class="lineNum">    5106 </span><span class="lineNoCov">          0 :                 case TRAC_ACTION_SET_MX:</span>
<span class="lineNum">    5107 </span><span class="lineNoCov">          0 :                         e = gf_isom_set_track_matrix(file, track, tka-&gt;mx);</span>
<span class="lineNum">    5108 </span><span class="lineNoCov">          0 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5109 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    5110 </span><span class="lineCov">          1 :                 case TRAC_ACTION_SET_HANDLER_NAME:</span>
<span class="lineNum">    5111 </span><span class="lineCov">          1 :                         e = gf_isom_set_handler_name(file, track, tka-&gt;hdl_name);</span>
<span class="lineNum">    5112 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5113 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    5114 </span><span class="lineCov">          1 :                 case TRAC_ACTION_ENABLE:</span>
<span class="lineNum">    5115 </span><span class="lineCov">          1 :                         if (!gf_isom_is_track_enabled(file, track)) {</span>
<span class="lineNum">    5116 </span><span class="lineCov">          1 :                                 e = gf_isom_set_track_enabled(file, track, GF_TRUE);</span>
<span class="lineNum">    5117 </span><span class="lineCov">          1 :                                 do_save = GF_TRUE;</span>
<span class="lineNum">    5118 </span>            :                         }
<span class="lineNum">    5119 </span>            :                         break;
<span class="lineNum">    5120 </span><span class="lineCov">          1 :                 case TRAC_ACTION_DISABLE:</span>
<span class="lineNum">    5121 </span><span class="lineCov">          1 :                         if (gf_isom_is_track_enabled(file, track)) {</span>
<span class="lineNum">    5122 </span><span class="lineCov">          1 :                                 e = gf_isom_set_track_enabled(file, track, GF_FALSE);</span>
<span class="lineNum">    5123 </span><span class="lineCov">          1 :                                 do_save = GF_TRUE;</span>
<span class="lineNum">    5124 </span>            :                         }
<span class="lineNum">    5125 </span>            :                         break;
<span class="lineNum">    5126 </span><span class="lineCov">          1 :                 case TRAC_ACTION_REFERENCE:</span>
<span class="lineNum">    5127 </span><span class="lineCov">          1 :                         e = gf_isom_set_track_reference(file, track, GF_4CC(tka-&gt;lang[0], tka-&gt;lang[1], tka-&gt;lang[2], tka-&gt;lang[3]), tka-&gt;newTrackID);</span>
<span class="lineNum">    5128 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5129 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    5130 </span><span class="lineCov">          1 :                 case TRAC_ACTION_REM_NON_RAP:</span>
<span class="lineNum">    5131 </span><span class="lineCov">          1 :                         e = gf_media_remove_non_rap(file, track, GF_FALSE);</span>
<span class="lineNum">    5132 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5133 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    5134 </span><span class="lineCov">          1 :                 case TRAC_ACTION_REM_NON_REFS:</span>
<span class="lineNum">    5135 </span><span class="lineCov">          1 :                         e = gf_media_remove_non_rap(file, track, GF_TRUE);</span>
<span class="lineNum">    5136 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5137 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    5138 </span><span class="lineCov">          5 :                 case TRAC_ACTION_SET_UDTA:</span>
<span class="lineNum">    5139 </span><span class="lineCov">          5 :                         e = set_file_udta(file, track, tka-&gt;udta_type, tka-&gt;string ? tka-&gt;string : tka-&gt;src_name , tka-&gt;sample_num ? GF_TRUE : GF_FALSE, tka-&gt;string ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    5140 </span><span class="lineCov">          5 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5141 </span><span class="lineCov">          5 :                         break;</span>
<span class="lineNum">    5142 </span><span class="lineCov">          1 :                 case TRAC_ACTION_SET_EDITS:</span>
<span class="lineNum">    5143 </span><span class="lineCov">          1 :                         e = apply_edits(file, track, tka-&gt;string);</span>
<span class="lineNum">    5144 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5145 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    5146 </span><span class="lineCov">          1 :                 case TRAC_ACTION_SET_TIME:</span>
<span class="lineNum">    5147 </span><span class="lineCov">          1 :                         if (!tka-&gt;trackID) {</span>
<span class="lineNum">    5148 </span><span class="lineCov">          1 :                                 e = gf_isom_set_creation_time(file, tka-&gt;time, tka-&gt;time);</span>
<span class="lineNum">    5149 </span><span class="lineCov">          1 :                                 if (e) return e;</span>
<span class="lineNum">    5150 </span><span class="lineCov">          5 :                                 for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    5151 </span><span class="lineCov">          4 :                                         e = gf_isom_set_track_creation_time(file, i+1, tka-&gt;time, tka-&gt;time);</span>
<span class="lineNum">    5152 </span><span class="lineCov">          4 :                                         if (e) return e;</span>
<span class="lineNum">    5153 </span>            :                                 }
<span class="lineNum">    5154 </span>            :                         } else {
<span class="lineNum">    5155 </span><span class="lineNoCov">          0 :                                 e = gf_isom_set_track_creation_time(file, track, tka-&gt;time, tka-&gt;time);</span>
<span class="lineNum">    5156 </span>            :                         }
<span class="lineNum">    5157 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5158 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    5159 </span>            :                 case TRAC_ACTION_SET_MEDIA_TIME:
<span class="lineNum">    5160 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    5161 </span><span class="lineNoCov">          0 :                                 if (track &amp;&amp; (track != i+1)) continue;</span>
<span class="lineNum">    5162 </span><span class="lineNoCov">          0 :                                 e = gf_isom_set_media_creation_time(file, i+1, tka-&gt;time, tka-&gt;time);</span>
<span class="lineNum">    5163 </span><span class="lineNoCov">          0 :                                 if (e) return e;</span>
<span class="lineNum">    5164 </span>            :                         }
<span class="lineNum">    5165 </span><span class="lineNoCov">          0 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5166 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    5167 </span>            :                 default:
<span class="lineNum">    5168 </span>            :                         break;
<span class="lineNum">    5169 </span>            :                 }
<span class="lineNum">    5170 </span><span class="lineCov">         99 :                 if (e) return e;</span>
<span class="lineNum">    5171 </span>            :         }
<span class="lineNum">    5172 </span>            :         return GF_OK;
<a name="5173"><span class="lineNum">    5173 </span>            : }</a>
<span class="lineNum">    5174 </span>            : 
<span class="lineNum">    5175 </span><span class="lineCov">          1 : static GF_Err do_itunes_tag()</span>
<span class="lineNum">    5176 </span>            : {
<span class="lineNum">    5177 </span>            :         GF_Err e;
<span class="lineNum">    5178 </span><span class="lineCov">          1 :         char *itunes_data = NULL;</span>
<span class="lineNum">    5179 </span><span class="lineCov">          1 :         char *tags = itunes_tags;</span>
<span class="lineNum">    5180 </span>            : 
<span class="lineNum">    5181 </span><span class="lineCov">          1 :         if (gf_file_exists(itunes_tags)) {</span>
<span class="lineNum">    5182 </span>            :                 u32 len;
<span class="lineNum">    5183 </span><span class="lineNoCov">          0 :                 e = gf_file_load_data(itunes_tags, (u8 **) &amp;itunes_data, &amp;len);</span>
<span class="lineNum">    5184 </span><span class="lineNoCov">          0 :                 if (e) return e;;</span>
<span class="lineNum">    5185 </span><span class="lineNoCov">          0 :                 tags = itunes_data;</span>
<span class="lineNum">    5186 </span>            :         }
<span class="lineNum">    5187 </span>            : 
<span class="lineNum">    5188 </span><span class="lineCov">          2 :         while (tags) {</span>
<span class="lineNum">    5189 </span>            :                 char *val;
<span class="lineNum">    5190 </span>            :                 Bool clear = GF_FALSE;
<span class="lineNum">    5191 </span>            :                 Bool is_wma = GF_FALSE;
<span class="lineNum">    5192 </span>            :                 u32 tlen, tagtype=0, itag = 0;
<span class="lineNum">    5193 </span>            :                 s32 tag_idx=-1;
<span class="lineNum">    5194 </span><span class="lineCov">          2 :                 char *sep = itunes_data ? strchr(tags, '\n') : gf_url_colon_suffix(tags);</span>
<span class="lineNum">    5195 </span><span class="lineCov">          2 :                 while (sep) {</span>
<span class="lineNum">    5196 </span><span class="lineCov">          1 :                         char *eq = strchr(sep+1, '=');</span>
<span class="lineNum">    5197 </span><span class="lineCov">          1 :                         if (eq) eq[0] = 0;</span>
<span class="lineNum">    5198 </span><span class="lineCov">          1 :                         s32 next_tag_idx = gf_itags_find_by_name(sep+1);</span>
<span class="lineNum">    5199 </span><span class="lineCov">          1 :                         if ((next_tag_idx&lt;0) &amp;&amp; strlen(sep+1)==4)</span>
<span class="lineNum">    5200 </span>            :                                 next_tag_idx = 0;
<span class="lineNum">    5201 </span>            : 
<span class="lineNum">    5202 </span><span class="lineCov">          1 :                         if (eq) eq[0] = '=';</span>
<span class="lineNum">    5203 </span><span class="lineCov">          1 :                         if (next_tag_idx&gt;=0) {</span>
<span class="lineNum">    5204 </span><span class="lineCov">          1 :                                 sep[0] = 0;</span>
<span class="lineNum">    5205 </span><span class="lineCov">          1 :                                 break;</span>
<span class="lineNum">    5206 </span>            :                         }
<span class="lineNum">    5207 </span><span class="lineNoCov">          0 :                         sep = itunes_data ? strchr(sep+1, '\n') : gf_url_colon_suffix(sep+1);</span>
<span class="lineNum">    5208 </span>            :                 }
<span class="lineNum">    5209 </span><span class="lineCov">          2 :                 val = strchr(tags, '=');</span>
<span class="lineNum">    5210 </span><span class="lineCov">          2 :                 if (val) val[0] = 0;</span>
<span class="lineNum">    5211 </span><span class="lineCov">          2 :                 if (!strcmp(tags, &quot;clear&quot;) || !strcmp(tags, &quot;reset&quot;)) {</span>
<span class="lineNum">    5212 </span>            :                         clear = GF_TRUE;
<span class="lineNum">    5213 </span><span class="lineCov">          2 :                 } else if (!strncmp(tags, &quot;WM/&quot;, 3) ) {</span>
<span class="lineNum">    5214 </span>            :                         is_wma = GF_TRUE;
<span class="lineNum">    5215 </span>            :                 } else {
<span class="lineNum">    5216 </span><span class="lineCov">          2 :                         tag_idx = gf_itags_find_by_name(tags);</span>
<span class="lineNum">    5217 </span><span class="lineCov">          2 :                         if (tag_idx&lt;0) {</span>
<span class="lineNum">    5218 </span><span class="lineNoCov">          0 :                                 if (strlen(tags)==4) {</span>
<span class="lineNum">    5219 </span><span class="lineNoCov">          0 :                                         itag = GF_4CC(tags[0], tags[1], tags[2], tags[3]);</span>
<span class="lineNum">    5220 </span>            :                                         tagtype = GF_ITAG_STR;
<span class="lineNum">    5221 </span><span class="lineNoCov">          0 :                                 } else if (strlen(tags)==3) {</span>
<span class="lineNum">    5222 </span><span class="lineNoCov">          0 :                                         itag = GF_4CC(0xA9, tags[0], tags[1], tags[2]);</span>
<span class="lineNum">    5223 </span>            :                                         tagtype = GF_ITAG_STR;
<span class="lineNum">    5224 </span>            :                                 }
<span class="lineNum">    5225 </span>            :                         }
<span class="lineNum">    5226 </span>            :                 }
<span class="lineNum">    5227 </span><span class="lineCov">          2 :                 if (val) {</span>
<span class="lineNum">    5228 </span><span class="lineCov">          2 :                         val[0] = '=';</span>
<span class="lineNum">    5229 </span><span class="lineCov">          2 :                         val++;</span>
<span class="lineNum">    5230 </span>            :                 }
<span class="lineNum">    5231 </span><span class="lineCov">          2 :                 if (!itag &amp;&amp; !clear &amp;&amp; !is_wma) {</span>
<span class="lineNum">    5232 </span><span class="lineCov">          2 :                         if (tag_idx&lt;0) {</span>
<span class="lineNum">    5233 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_WARNING, (&quot;Invalid iTune tag name \&quot;%s\&quot; - ignoring\n&quot;, tags));</span>
<span class="lineNum">    5234 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    5235 </span>            :                         }
<span class="lineNum">    5236 </span><span class="lineCov">          2 :                         itag = gf_itags_get_itag(tag_idx);</span>
<span class="lineNum">    5237 </span><span class="lineCov">          2 :                         tagtype = gf_itags_get_type(tag_idx);</span>
<span class="lineNum">    5238 </span>            :                 }
<span class="lineNum">    5239 </span><span class="lineCov">          2 :                 if (!val || (val[0]==':') || !val[0] || !stricmp(val, &quot;NULL&quot;) ) val = NULL;</span>
<span class="lineNum">    5240 </span>            : 
<span class="lineNum">    5241 </span><span class="lineCov">          2 :                 tlen = val ? (u32) strlen(val) : 0;</span>
<span class="lineNum">    5242 </span><span class="lineCov">          2 :                 if (clear) {</span>
<span class="lineNum">    5243 </span><span class="lineNoCov">          0 :                         e = gf_isom_apple_set_tag(file, GF_ISOM_ITUNE_RESET, NULL, 0, 0, 0);</span>
<span class="lineNum">    5244 </span>            :                 }
<span class="lineNum">    5245 </span><span class="lineCov">          2 :                 else if (is_wma) {</span>
<span class="lineNum">    5246 </span><span class="lineNoCov">          0 :                         if (val) val[-1] = 0;</span>
<span class="lineNum">    5247 </span><span class="lineNoCov">          0 :                         e = gf_isom_wma_set_tag(file, tags, val);</span>
<span class="lineNum">    5248 </span><span class="lineNoCov">          0 :                         if (val) val[-1] = '=';</span>
<span class="lineNum">    5249 </span>            :                 }
<span class="lineNum">    5250 </span><span class="lineCov">          2 :                 else if (val &amp;&amp; (tagtype==GF_ITAG_FILE)) {</span>
<span class="lineNum">    5251 </span><span class="lineCov">          1 :                         u32 flen = (u32) strlen(val);</span>
<span class="lineNum">    5252 </span><span class="lineCov">          1 :                         u8 *d=NULL;</span>
<span class="lineNum">    5253 </span><span class="lineCov">          1 :                         while (flen &amp;&amp; val[flen-1]=='\n') flen--;</span>
<span class="lineNum">    5254 </span><span class="lineCov">          1 :                         val[flen] = 0;</span>
<span class="lineNum">    5255 </span><span class="lineCov">          1 :                         e = gf_file_load_data(val, (u8 **) &amp;d, &amp;tlen);</span>
<span class="lineNum">    5256 </span><span class="lineCov">          1 :                         val[flen] = '\n';</span>
<span class="lineNum">    5257 </span>            : 
<span class="lineNum">    5258 </span><span class="lineCov">          1 :                         if (!e)</span>
<span class="lineNum">    5259 </span><span class="lineCov">          1 :                                 e = gf_isom_apple_set_tag(file, itag, d, tlen, 0, 0);</span>
<span class="lineNum">    5260 </span>            : 
<span class="lineNum">    5261 </span><span class="lineCov">          1 :                         if (d) gf_free(d);</span>
<span class="lineNum">    5262 </span>            :                 } else {
<span class="lineNum">    5263 </span><span class="lineCov">          1 :                         e = gf_isom_apple_set_tag(file, itag, (u8 *) val, tlen, 0, 0);</span>
<span class="lineNum">    5264 </span>            :                 }
<span class="lineNum">    5265 </span><span class="lineCov">          2 :                 if (e) {</span>
<span class="lineNum">    5266 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Error assigning tag %s: %s\n&quot;, tags, gf_error_to_string(e) ));</span>
<span class="lineNum">    5267 </span>            :                 }
<span class="lineNum">    5268 </span>            : 
<span class="lineNum">    5269 </span><span class="lineCov">          2 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    5270 </span>            : 
<span class="lineNum">    5271 </span><span class="lineCov">          2 :                 if (sep) {</span>
<span class="lineNum">    5272 </span><span class="lineCov">          1 :                         sep[0] = itunes_data ? '\n' : ':';</span>
<span class="lineNum">    5273 </span><span class="lineCov">          1 :                         tags = sep+1;</span>
<span class="lineNum">    5274 </span>            :                 } else {
<span class="lineNum">    5275 </span>            :                         tags = NULL;
<span class="lineNum">    5276 </span>            :                 }
<span class="lineNum">    5277 </span>            :         }
<span class="lineNum">    5278 </span><span class="lineCov">          1 :         if (itunes_data) gf_free(itunes_data);</span>
<span class="lineNum">    5279 </span>            :         return GF_OK;
<span class="lineNum">    5280 </span>            : }
<a name="5281"><span class="lineNum">    5281 </span>            : </a>
<span class="lineNum">    5282 </span>            : #if !defined(GPAC_DISABLE_ISOM_HINTING) &amp;&amp; !defined(GPAC_DISABLE_SENG)
<span class="lineNum">    5283 </span><span class="lineCov">        743 : static void set_sdp_ext()</span>
<span class="lineNum">    5284 </span>            : {
<span class="lineNum">    5285 </span>            :         u32 i, j;
<span class="lineNum">    5286 </span><span class="lineCov">        743 :         for (i=0; i&lt;nb_sdp_ex; i++) {</span>
<span class="lineNum">    5287 </span><span class="lineNoCov">          0 :                 if (sdp_lines[i].trackID) {</span>
<span class="lineNum">    5288 </span><span class="lineNoCov">          0 :                         u32 track = gf_isom_get_track_by_id(file, sdp_lines[i].trackID);</span>
<span class="lineNum">    5289 </span><span class="lineNoCov">          0 :                         if (gf_isom_get_media_type(file, track)!=GF_ISOM_MEDIA_HINT) {</span>
<span class="lineNum">    5290 </span>            :                                 s32 ref_count;
<span class="lineNum">    5291 </span><span class="lineNoCov">          0 :                                 u32 k, count = gf_isom_get_track_count(file);</span>
<span class="lineNum">    5292 </span><span class="lineNoCov">          0 :                                 for (j=0; j&lt;count; j++) {</span>
<span class="lineNum">    5293 </span><span class="lineNoCov">          0 :                                         if (gf_isom_get_media_type(file, j+1)!=GF_ISOM_MEDIA_HINT) continue;</span>
<span class="lineNum">    5294 </span><span class="lineNoCov">          0 :                                         ref_count = gf_isom_get_reference_count(file, j+1, GF_ISOM_REF_HINT);</span>
<span class="lineNum">    5295 </span><span class="lineNoCov">          0 :                                         if (ref_count&lt;0) continue;</span>
<span class="lineNum">    5296 </span><span class="lineNoCov">          0 :                                         for (k=0; k&lt;(u32) ref_count; k++) {</span>
<span class="lineNum">    5297 </span>            :                                                 u32 refTk;
<span class="lineNum">    5298 </span><span class="lineNoCov">          0 :                                                 if (gf_isom_get_reference(file, j+1, GF_ISOM_REF_HINT, k+1, &amp;refTk)) continue;</span>
<span class="lineNum">    5299 </span><span class="lineNoCov">          0 :                                                 if (refTk==track) {</span>
<span class="lineNum">    5300 </span>            :                                                         track = j+1;
<span class="lineNum">    5301 </span>            :                                                         j=count;
<span class="lineNum">    5302 </span><span class="lineNoCov">          0 :                                                         break;</span>
<span class="lineNum">    5303 </span>            :                                                 }
<span class="lineNum">    5304 </span>            :                                         }
<span class="lineNum">    5305 </span>            :                                 }
<span class="lineNum">    5306 </span>            :                         }
<span class="lineNum">    5307 </span><span class="lineNoCov">          0 :                         gf_isom_sdp_add_track_line(file, track, sdp_lines[i].line);</span>
<span class="lineNum">    5308 </span><span class="lineNoCov">          0 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5309 </span>            :                 } else {
<span class="lineNum">    5310 </span><span class="lineNoCov">          0 :                         gf_isom_sdp_add_line(file, sdp_lines[i].line);</span>
<span class="lineNum">    5311 </span><span class="lineNoCov">          0 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    5312 </span>            :                 }
<span class="lineNum">    5313 </span>            :         }
<span class="lineNum">    5314 </span><span class="lineCov">        743 : }</span>
<a name="5315"><span class="lineNum">    5315 </span>            : #endif /*!defined(GPAC_DISABLE_ISOM_HINTING) &amp;&amp; !defined(GPAC_DISABLE_SENG)*/</a>
<span class="lineNum">    5316 </span>            : 
<span class="lineNum">    5317 </span><span class="lineNoCov">          0 : static GF_Err do_remux_file()</span>
<span class="lineNum">    5318 </span>            : {
<span class="lineNum">    5319 </span>            :         GF_MediaExporter mdump;
<span class="lineNum">    5320 </span>            :         memset(&amp;mdump, 0, sizeof(GF_MediaExporter));
<span class="lineNum">    5321 </span><span class="lineNoCov">          0 :         mdump.in_name = inName;</span>
<span class="lineNum">    5322 </span><span class="lineNoCov">          0 :         mdump.out_name = mux_name;</span>
<span class="lineNum">    5323 </span><span class="lineNoCov">          0 :         mdump.flags = GF_EXPORT_REMUX;</span>
<span class="lineNum">    5324 </span><span class="lineNoCov">          0 :         mdump.print_stats_graph = fs_dump_flags;</span>
<span class="lineNum">    5325 </span><span class="lineNoCov">          0 :         return gf_media_export(&amp;mdump);</span>
<a name="5326"><span class="lineNum">    5326 </span>            : }</a>
<span class="lineNum">    5327 </span>            : 
<span class="lineNum">    5328 </span><span class="lineCov">       4515 : static u32 mp4box_cleanup(u32 ret_code) {</span>
<span class="lineNum">    5329 </span><span class="lineCov">       4515 :         if (mpd_base_urls) {</span>
<span class="lineNum">    5330 </span><span class="lineCov">          1 :                 gf_free(mpd_base_urls);</span>
<span class="lineNum">    5331 </span><span class="lineCov">          1 :                 mpd_base_urls = NULL;</span>
<span class="lineNum">    5332 </span>            :         }
<span class="lineNum">    5333 </span><span class="lineCov">       4515 :         if (sdp_lines) {</span>
<span class="lineNum">    5334 </span><span class="lineNoCov">          0 :                 gf_free(sdp_lines);</span>
<span class="lineNum">    5335 </span><span class="lineNoCov">          0 :                 sdp_lines = NULL;</span>
<span class="lineNum">    5336 </span>            :         }
<span class="lineNum">    5337 </span><span class="lineCov">       4515 :         if (metas) {</span>
<span class="lineNum">    5338 </span>            :                 u32 i;
<span class="lineNum">    5339 </span><span class="lineCov">        122 :                 for (i=0; i&lt;nb_meta_act; i++) {</span>
<span class="lineNum">    5340 </span><span class="lineCov">        122 :                         if (metas[i].enc_type) gf_free(metas[i].enc_type);</span>
<span class="lineNum">    5341 </span><span class="lineCov">        122 :                         if (metas[i].mime_type) gf_free(metas[i].mime_type);</span>
<span class="lineNum">    5342 </span><span class="lineCov">        122 :                         if (metas[i].szName) gf_free(metas[i].szName);</span>
<span class="lineNum">    5343 </span><span class="lineCov">        122 :                         if (metas[i].szPath) gf_free(metas[i].szPath);</span>
<span class="lineNum">    5344 </span>            :                 }
<span class="lineNum">    5345 </span><span class="lineCov">         75 :                 gf_free(metas);</span>
<span class="lineNum">    5346 </span><span class="lineCov">         75 :                 metas = NULL;</span>
<span class="lineNum">    5347 </span>            :         }
<span class="lineNum">    5348 </span><span class="lineCov">       4515 :         if (tracks) {</span>
<span class="lineNum">    5349 </span>            :                 u32 i;
<span class="lineNum">    5350 </span><span class="lineCov">        165 :                 for (i = 0; i&lt;nb_track_act; i++) {</span>
<span class="lineNum">    5351 </span><span class="lineCov">        165 :                         if (tracks[i].out_name)</span>
<span class="lineNum">    5352 </span><span class="lineCov">          1 :                                 gf_free(tracks[i].out_name);</span>
<span class="lineNum">    5353 </span><span class="lineCov">        165 :                         if (tracks[i].src_name)</span>
<span class="lineNum">    5354 </span><span class="lineCov">          4 :                                 gf_free(tracks[i].src_name);</span>
<span class="lineNum">    5355 </span><span class="lineCov">        165 :                         if (tracks[i].string)</span>
<span class="lineNum">    5356 </span><span class="lineCov">          2 :                                 gf_free(tracks[i].string);</span>
<span class="lineNum">    5357 </span><span class="lineCov">        165 :                         if (tracks[i].kind_scheme)</span>
<span class="lineNum">    5358 </span><span class="lineCov">         53 :                                 gf_free(tracks[i].kind_scheme);</span>
<span class="lineNum">    5359 </span><span class="lineCov">        165 :                         if (tracks[i].kind_value)</span>
<span class="lineNum">    5360 </span><span class="lineCov">         20 :                                 gf_free(tracks[i].kind_value);</span>
<span class="lineNum">    5361 </span>            :                 }
<span class="lineNum">    5362 </span><span class="lineCov">        165 :                 gf_free(tracks);</span>
<span class="lineNum">    5363 </span><span class="lineCov">        165 :                 tracks = NULL;</span>
<span class="lineNum">    5364 </span>            :         }
<span class="lineNum">    5365 </span><span class="lineCov">       4515 :         if (tsel_acts) {</span>
<span class="lineNum">    5366 </span><span class="lineCov">          3 :                 gf_free(tsel_acts);</span>
<span class="lineNum">    5367 </span><span class="lineCov">          3 :                 tsel_acts = NULL;</span>
<span class="lineNum">    5368 </span>            :         }
<span class="lineNum">    5369 </span><span class="lineCov">       4515 :         if (brand_add) {</span>
<span class="lineNum">    5370 </span><span class="lineCov">         44 :                 gf_free(brand_add);</span>
<span class="lineNum">    5371 </span><span class="lineCov">         44 :                 brand_add = NULL;</span>
<span class="lineNum">    5372 </span>            :         }
<span class="lineNum">    5373 </span><span class="lineCov">       4515 :         if (brand_rem) {</span>
<span class="lineNum">    5374 </span><span class="lineCov">          2 :                 gf_free(brand_rem);</span>
<span class="lineNum">    5375 </span><span class="lineCov">          2 :                 brand_rem = NULL;</span>
<span class="lineNum">    5376 </span>            :         }
<span class="lineNum">    5377 </span><span class="lineCov">       4515 :         if (dash_inputs) {</span>
<span class="lineNum">    5378 </span>            :                 u32 i, j;
<span class="lineNum">    5379 </span><span class="lineCov">        209 :                 for (i = 0; i&lt;nb_dash_inputs; i++) {</span>
<span class="lineNum">    5380 </span><span class="lineCov">        209 :                         GF_DashSegmenterInput *di = &amp;dash_inputs[i];</span>
<span class="lineNum">    5381 </span><span class="lineCov">        209 :                         if (di-&gt;nb_baseURL) {</span>
<span class="lineNum">    5382 </span><span class="lineCov">          1 :                                 for (j = 0; j&lt;di-&gt;nb_baseURL; j++) {</span>
<span class="lineNum">    5383 </span><span class="lineCov">          1 :                                         gf_free(di-&gt;baseURL[j]);</span>
<span class="lineNum">    5384 </span>            :                                 }
<span class="lineNum">    5385 </span><span class="lineCov">          1 :                                 gf_free(di-&gt;baseURL);</span>
<span class="lineNum">    5386 </span>            :                         }
<span class="lineNum">    5387 </span><span class="lineCov">        209 :                         if (di-&gt;rep_descs) {</span>
<span class="lineNum">    5388 </span><span class="lineCov">          1 :                                 for (j = 0; j&lt;di-&gt;nb_rep_descs; j++) {</span>
<span class="lineNum">    5389 </span><span class="lineCov">          1 :                                         gf_free(di-&gt;rep_descs[j]);</span>
<span class="lineNum">    5390 </span>            :                                 }
<span class="lineNum">    5391 </span><span class="lineCov">          1 :                                 gf_free(di-&gt;rep_descs);</span>
<span class="lineNum">    5392 </span>            :                         }
<span class="lineNum">    5393 </span><span class="lineCov">        209 :                         if (di-&gt;as_descs) {</span>
<span class="lineNum">    5394 </span><span class="lineCov">          6 :                                 for (j = 0; j&lt;di-&gt;nb_as_descs; j++) {</span>
<span class="lineNum">    5395 </span><span class="lineCov">          6 :                                         gf_free(di-&gt;as_descs[j]);</span>
<span class="lineNum">    5396 </span>            :                                 }
<span class="lineNum">    5397 </span><span class="lineCov">          6 :                                 gf_free(di-&gt;as_descs);</span>
<span class="lineNum">    5398 </span>            :                         }
<span class="lineNum">    5399 </span><span class="lineCov">        209 :                         if (di-&gt;as_c_descs) {</span>
<span class="lineNum">    5400 </span><span class="lineNoCov">          0 :                                 for (j = 0; j&lt;di-&gt;nb_as_c_descs; j++) {</span>
<span class="lineNum">    5401 </span><span class="lineNoCov">          0 :                                         gf_free(di-&gt;as_c_descs[j]);</span>
<span class="lineNum">    5402 </span>            :                                 }
<span class="lineNum">    5403 </span><span class="lineNoCov">          0 :                                 gf_free(di-&gt;as_c_descs);</span>
<span class="lineNum">    5404 </span>            :                         }
<span class="lineNum">    5405 </span><span class="lineCov">        209 :                         if (di-&gt;p_descs) {</span>
<span class="lineNum">    5406 </span><span class="lineCov">          3 :                                 for (j = 0; j&lt;di-&gt;nb_p_descs; j++) {</span>
<span class="lineNum">    5407 </span><span class="lineCov">          3 :                                         gf_free(di-&gt;p_descs[j]);</span>
<span class="lineNum">    5408 </span>            :                                 }
<span class="lineNum">    5409 </span><span class="lineCov">          3 :                                 gf_free(di-&gt;p_descs);</span>
<span class="lineNum">    5410 </span>            :                         }
<span class="lineNum">    5411 </span><span class="lineCov">        209 :                         if (di-&gt;representationID) gf_free(di-&gt;representationID);</span>
<span class="lineNum">    5412 </span><span class="lineCov">        209 :                         if (di-&gt;periodID) gf_free(di-&gt;periodID);</span>
<span class="lineNum">    5413 </span><span class="lineCov">        209 :                         if (di-&gt;xlink) gf_free(di-&gt;xlink);</span>
<span class="lineNum">    5414 </span><span class="lineCov">        209 :                         if (di-&gt;seg_template) gf_free(di-&gt;seg_template);</span>
<span class="lineNum">    5415 </span><span class="lineCov">        209 :                         if (di-&gt;hls_pl) gf_free(di-&gt;hls_pl);</span>
<span class="lineNum">    5416 </span><span class="lineCov">        209 :                         if (di-&gt;source_opts) gf_free(di-&gt;source_opts);</span>
<span class="lineNum">    5417 </span><span class="lineCov">        209 :                         if (di-&gt;filter_chain) gf_free(di-&gt;filter_chain);</span>
<span class="lineNum">    5418 </span>            : 
<span class="lineNum">    5419 </span><span class="lineCov">        209 :                         if (di-&gt;roles) {</span>
<span class="lineNum">    5420 </span><span class="lineNoCov">          0 :                                 for (j = 0; j&lt;di-&gt;nb_roles; j++) {</span>
<span class="lineNum">    5421 </span><span class="lineNoCov">          0 :                                         gf_free(di-&gt;roles[j]);</span>
<span class="lineNum">    5422 </span>            :                                 }
<span class="lineNum">    5423 </span><span class="lineNoCov">          0 :                                 gf_free(di-&gt;roles);</span>
<span class="lineNum">    5424 </span>            :                         }
<span class="lineNum">    5425 </span>            :                 }
<span class="lineNum">    5426 </span><span class="lineCov">        176 :                 gf_free(dash_inputs);</span>
<span class="lineNum">    5427 </span><span class="lineCov">        176 :                 dash_inputs = NULL;</span>
<span class="lineNum">    5428 </span>            :         }
<span class="lineNum">    5429 </span><span class="lineCov">       4515 :         if (logfile) gf_fclose(logfile);</span>
<span class="lineNum">    5430 </span><span class="lineCov">       4515 :         gf_sys_close();</span>
<span class="lineNum">    5431 </span><span class="lineCov">       4515 :         return ret_code;</span>
<span class="lineNum">    5432 </span>            : }
<span class="lineNum">    5433 </span>            : 
<a name="5434"><span class="lineNum">    5434 </span>            : </a>
<span class="lineNum">    5435 </span>            : 
<span class="lineNum">    5436 </span><span class="lineCov">       4485 : int mp4boxMain(int argc, char **argv)</span>
<span class="lineNum">    5437 </span>            : {
<span class="lineNum">    5438 </span>            :         u32 i, j;
<span class="lineNum">    5439 </span>            :         const char *gpac_profile = &quot;0&quot;;
<span class="lineNum">    5440 </span>            :         GF_Err e = GF_OK;
<span class="lineNum">    5441 </span>            : 
<span class="lineNum">    5442 </span>            : #ifdef TEST_ARGS
<span class="lineNum">    5443 </span>            :         i=0;
<span class="lineNum">    5444 </span>            :         mp4box_parse_single_arg(argc, argv, &quot;&quot;, &amp;i);
<span class="lineNum">    5445 </span>            : #endif
<span class="lineNum">    5446 </span>            : 
<span class="lineNum">    5447 </span><span class="lineCov">      17935 :         for (i = 1; i &lt; (u32) argc ; i++) {</span>
<span class="lineNum">    5448 </span><span class="lineCov">      17932 :                 if (!strcmp(argv[i], &quot;-mem-track&quot;) || !strcmp(argv[i], &quot;-mem-track-stack&quot;)) {</span>
<span class="lineNum">    5449 </span>            : #ifdef GPAC_MEMORY_TRACKING
<span class="lineNum">    5450 </span><span class="lineCov">       4482 :             mem_track = !strcmp(argv[i], &quot;-mem-track-stack&quot;) ? GF_MemTrackerBackTrace : GF_MemTrackerSimple;</span>
<span class="lineNum">    5451 </span>            : #else
<span class="lineNum">    5452 </span>            :                         M4_LOG(GF_LOG_WARNING, (&quot;WARNING - GPAC not compiled with Memory Tracker - ignoring \&quot;%s\&quot;\n&quot;, argv[i]));
<span class="lineNum">    5453 </span>            : #endif
<span class="lineNum">    5454 </span><span class="lineCov">       4482 :                         break;</span>
<span class="lineNum">    5455 </span>            :                 }
<span class="lineNum">    5456 </span><span class="lineCov">      13450 :                 else if (!strcmp(argv[i], &quot;-p&quot;)) {</span>
<span class="lineNum">    5457 </span><span class="lineNoCov">          0 :                         if (i+1&lt;(u32) argc)</span>
<span class="lineNum">    5458 </span><span class="lineNoCov">          0 :                                 gpac_profile = argv[i+1];</span>
<span class="lineNum">    5459 </span>            :                         else {
<span class="lineNum">    5460 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Bad argument for -p, expecting profile name but no more args\n&quot;));</span>
<span class="lineNum">    5461 </span>            :                                 return 1;
<span class="lineNum">    5462 </span>            :                         }
<span class="lineNum">    5463 </span>            :                 }
<span class="lineNum">    5464 </span><span class="lineCov">      13450 :                 else if (!strncmp(argv[i], &quot;-p=&quot;, 3))</span>
<span class="lineNum">    5465 </span><span class="lineNoCov">          0 :                         gpac_profile = argv[i]+3;</span>
<span class="lineNum">    5466 </span>            :         }
<span class="lineNum">    5467 </span>            : 
<span class="lineNum">    5468 </span>            : #ifdef _TWO_DIGIT_EXPONENT
<span class="lineNum">    5469 </span>            :         _set_output_format(_TWO_DIGIT_EXPONENT);
<span class="lineNum">    5470 </span>            : #endif
<span class="lineNum">    5471 </span>            : 
<span class="lineNum">    5472 </span>            :         /*init libgpac*/
<span class="lineNum">    5473 </span><span class="lineCov">       4485 :         gf_sys_init(mem_track, gpac_profile);</span>
<span class="lineNum">    5474 </span><span class="lineCov">       4485 :         if (argc &lt; 2) {</span>
<span class="lineNum">    5475 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Not enough arguments - check usage with -h\n&quot;));</span>
<span class="lineNum">    5476 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_INFO, (&quot;MP4Box - GPAC version %s\n&quot;</span>
<span class="lineNum">    5477 </span>            :                 &quot;%s\n&quot;, gf_gpac_version(), gf_gpac_copyright_cite() ));
<span class="lineNum">    5478 </span><span class="lineNoCov">          0 :                 gf_sys_close();</span>
<span class="lineNum">    5479 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    5480 </span>            :         }
<span class="lineNum">    5481 </span>            : 
<span class="lineNum">    5482 </span><span class="lineCov">       4485 :         helpout = stdout;</span>
<span class="lineNum">    5483 </span>            : 
<span class="lineNum">    5484 </span><span class="lineCov">       4485 :         i = mp4box_parse_args(argc, argv);</span>
<span class="lineNum">    5485 </span><span class="lineCov">       4485 :         if (i) {</span>
<span class="lineNum">    5486 </span><span class="lineCov">         37 :                 return mp4box_cleanup(i - 1);</span>
<span class="lineNum">    5487 </span>            :         }
<span class="lineNum">    5488 </span>            : #if !defined(GPAC_DISABLE_STREAMING) &amp;&amp; !defined(GPAC_DISABLE_SENG)
<span class="lineNum">    5489 </span><span class="lineCov">       4448 :         if (live_scene) {</span>
<span class="lineNum">    5490 </span><span class="lineCov">          1 :                 int ret = live_session(argc, argv);</span>
<span class="lineNum">    5491 </span><span class="lineCov">          1 :                 return mp4box_cleanup(ret);</span>
<span class="lineNum">    5492 </span>            :         }
<span class="lineNum">    5493 </span>            : #endif
<span class="lineNum">    5494 </span>            : 
<span class="lineNum">    5495 </span><span class="lineCov">       4447 :         if (!dash_duration &amp;&amp; interleaving_time &amp;&amp; do_frag)</span>
<span class="lineNum">    5496 </span><span class="lineCov">          4 :                 interleaving_time /= 1000;</span>
<span class="lineNum">    5497 </span>            : 
<span class="lineNum">    5498 </span><span class="lineCov">       4447 :         if (do_mpd_conv) inName = do_mpd_conv;</span>
<span class="lineNum">    5499 </span>            : 
<span class="lineNum">    5500 </span><span class="lineCov">       4447 :         if (import_flags &amp; GF_IMPORT_FORCE_MPEG4)</span>
<span class="lineNum">    5501 </span><span class="lineNoCov">          0 :                 hint_flags |= GP_RTP_PCK_FORCE_MPEG4;</span>
<span class="lineNum">    5502 </span>            : 
<span class="lineNum">    5503 </span><span class="lineCov">       4447 :         if (!inName &amp;&amp; dump_std)</span>
<span class="lineNum">    5504 </span><span class="lineNoCov">          0 :                 inName = &quot;std&quot;;</span>
<span class="lineNum">    5505 </span>            : 
<span class="lineNum">    5506 </span><span class="lineCov">       4447 :         if (!dash_duration &amp;&amp; cprt)</span>
<span class="lineNum">    5507 </span><span class="lineCov">          1 :                 open_edit = GF_TRUE;</span>
<span class="lineNum">    5508 </span>            : 
<span class="lineNum">    5509 </span><span class="lineCov">       4447 :         if (!inName) {</span>
<span class="lineNum">    5510 </span><span class="lineNoCov">          0 :                 if (has_next_arg) {</span>
<span class="lineNum">    5511 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Broken argument specifier or file name missing - check usage with -h\n&quot;));</span>
<span class="lineNum">    5512 </span>            :                 } else {
<span class="lineNum">    5513 </span><span class="lineNoCov">          0 :                         PrintUsage();</span>
<span class="lineNum">    5514 </span>            :                 }
<span class="lineNum">    5515 </span><span class="lineNoCov">          0 :                 return mp4box_cleanup(1);</span>
<span class="lineNum">    5516 </span>            :         }
<span class="lineNum">    5517 </span><span class="lineCov">       4447 :         if (!strcmp(inName, &quot;std&quot;)) dump_std = 2;</span>
<span class="lineNum">    5518 </span><span class="lineCov">       4447 :         if (!strcmp(inName, &quot;stdb&quot;)) {</span>
<span class="lineNum">    5519 </span><span class="lineNoCov">          0 :                 inName = &quot;std&quot;;</span>
<span class="lineNum">    5520 </span><span class="lineNoCov">          0 :                 dump_std = 1;</span>
<span class="lineNum">    5521 </span>            :         }
<span class="lineNum">    5522 </span>            : 
<span class="lineNum">    5523 </span><span class="lineCov">       4447 :         if (!interleaving_time) {</span>
<span class="lineNum">    5524 </span>            :                 /*by default use single fragment per dash segment*/
<span class="lineNum">    5525 </span><span class="lineCov">       4434 :                 if (dash_duration)</span>
<span class="lineNum">    5526 </span><span class="lineCov">        172 :                         interleaving_time = dash_duration;</span>
<span class="lineNum">    5527 </span><span class="lineCov">       4262 :                 else if (!do_flat) {</span>
<span class="lineNum">    5528 </span><span class="lineCov">       4258 :                         interleaving_time = DEFAULT_INTERLEAVING_IN_SEC;</span>
<span class="lineNum">    5529 </span>            :                 }
<span class="lineNum">    5530 </span>            :         }
<span class="lineNum">    5531 </span>            : 
<span class="lineNum">    5532 </span><span class="lineCov">       4447 :         if (dump_std)</span>
<span class="lineNum">    5533 </span><span class="lineCov">       2686 :                 outName = &quot;std&quot;;</span>
<span class="lineNum">    5534 </span>            : 
<span class="lineNum">    5535 </span><span class="lineCov">       4447 :         if (dump_std==2) {</span>
<span class="lineNum">    5536 </span>            : #ifdef WIN32
<span class="lineNum">    5537 </span>            :                 if ( _setmode(_fileno(stdout), _O_BINARY) == -1 )
<span class="lineNum">    5538 </span>            : #else
<span class="lineNum">    5539 </span><span class="lineCov">       2686 :                 if ( freopen(NULL, &quot;wb&quot;, stdout) == NULL)</span>
<span class="lineNum">    5540 </span>            : #endif
<span class="lineNum">    5541 </span>            :                 {
<span class="lineNum">    5542 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Fatal error: cannot reopen stdout in binary mode.\n&quot;));</span>
<span class="lineNum">    5543 </span><span class="lineNoCov">          0 :                         return mp4box_cleanup(1);</span>
<span class="lineNum">    5544 </span>            :                 }
<span class="lineNum">    5545 </span>            :         }
<span class="lineNum">    5546 </span>            : 
<span class="lineNum">    5547 </span><span class="lineCov">       4447 :         GF_LOG_Level level = verbose ? GF_LOG_DEBUG : GF_LOG_INFO;</span>
<span class="lineNum">    5548 </span><span class="lineCov">       4447 :         gf_log_set_tool_level(GF_LOG_CONTAINER, level);</span>
<span class="lineNum">    5549 </span><span class="lineCov">       4447 :         gf_log_set_tool_level(GF_LOG_SCENE, level);</span>
<span class="lineNum">    5550 </span><span class="lineCov">       4447 :         gf_log_set_tool_level(GF_LOG_PARSER, level);</span>
<span class="lineNum">    5551 </span><span class="lineCov">       4447 :         gf_log_set_tool_level(GF_LOG_AUTHOR, level);</span>
<span class="lineNum">    5552 </span><span class="lineCov">       4447 :         gf_log_set_tool_level(GF_LOG_CODING, level);</span>
<span class="lineNum">    5553 </span><span class="lineCov">       4447 :         gf_log_set_tool_level(GF_LOG_DASH, level);</span>
<span class="lineNum">    5554 </span>            : #ifdef GPAC_MEMORY_TRACKING
<span class="lineNum">    5555 </span><span class="lineCov">       4447 :         if (mem_track)</span>
<span class="lineNum">    5556 </span><span class="lineCov">       4445 :                 gf_log_set_tool_level(GF_LOG_MEMORY, level);</span>
<span class="lineNum">    5557 </span>            : #endif
<span class="lineNum">    5558 </span>            : 
<span class="lineNum">    5559 </span><span class="lineCov">       4447 :         e = gf_sys_set_args(argc, (const char **) argv);</span>
<span class="lineNum">    5560 </span><span class="lineCov">       4447 :         if (e) {</span>
<span class="lineNum">    5561 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Error assigning libgpac arguments: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    5562 </span><span class="lineNoCov">          0 :                 return mp4box_cleanup(1);</span>
<span class="lineNum">    5563 </span>            :         }
<span class="lineNum">    5564 </span>            : 
<span class="lineNum">    5565 </span><span class="lineCov">       4447 :         if (raw_cat)</span>
<span class="lineNum">    5566 </span><span class="lineNoCov">          0 :                 return do_raw_cat();</span>
<span class="lineNum">    5567 </span>            : 
<span class="lineNum">    5568 </span><span class="lineCov">       4447 :         if (compress_top_boxes) {</span>
<span class="lineNum">    5569 </span><span class="lineCov">          2 :                 if (size_top_box) {</span>
<span class="lineNum">    5570 </span><span class="lineCov">          1 :                         u64 top_size = do_size_top_boxes(inName, compress_top_boxes, size_top_box);</span>
<span class="lineNum">    5571 </span><span class="lineCov">          1 :                         fprintf(stdout, LLU&quot;\n&quot;, top_size);</span>
<span class="lineNum">    5572 </span><span class="lineCov">          1 :                         return mp4box_cleanup(e ? 1 : 0);</span>
<span class="lineNum">    5573 </span>            :                 } else {
<span class="lineNum">    5574 </span><span class="lineCov">          1 :                         e = do_compress_top_boxes(inName, outName);</span>
<span class="lineNum">    5575 </span><span class="lineCov">          1 :                         return mp4box_cleanup(e ? 1 : 0);</span>
<span class="lineNum">    5576 </span>            :                 }
<span class="lineNum">    5577 </span>            :         }
<span class="lineNum">    5578 </span>            : 
<span class="lineNum">    5579 </span><span class="lineCov">       4445 :         if (do_mpd_rip) {</span>
<span class="lineNum">    5580 </span><span class="lineCov">          1 :                 e = rip_mpd(inName, outName);</span>
<span class="lineNum">    5581 </span><span class="lineCov">          1 :                 return mp4box_cleanup(e ? 1 : 0);</span>
<span class="lineNum">    5582 </span>            :         }
<span class="lineNum">    5583 </span>            : 
<span class="lineNum">    5584 </span>            : #ifndef GPAC_DISABLE_CORE_TOOLS
<span class="lineNum">    5585 </span><span class="lineCov">       4444 :         if (do_wget != NULL) {</span>
<span class="lineNum">    5586 </span><span class="lineCov">          4 :                 e = gf_dm_wget(do_wget, inName, 0, 0, NULL);</span>
<span class="lineNum">    5587 </span><span class="lineCov">          4 :                 if (e != GF_OK) {</span>
<span class="lineNum">    5588 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Cannot retrieve %s: %s\n&quot;, do_wget, gf_error_to_string(e) ));</span>
<span class="lineNum">    5589 </span><span class="lineNoCov">          0 :                         return mp4box_cleanup(1);</span>
<span class="lineNum">    5590 </span>            :                 }
<span class="lineNum">    5591 </span><span class="lineCov">          4 :                 return mp4box_cleanup(0);</span>
<span class="lineNum">    5592 </span>            :         }
<span class="lineNum">    5593 </span>            : #endif
<span class="lineNum">    5594 </span>            : 
<span class="lineNum">    5595 </span><span class="lineCov">       4440 :         if (udp_dest)</span>
<span class="lineNum">    5596 </span><span class="lineNoCov">          0 :                 return do_write_udp();</span>
<span class="lineNum">    5597 </span>            : 
<span class="lineNum">    5598 </span>            : #ifndef GPAC_DISABLE_MPD
<span class="lineNum">    5599 </span><span class="lineCov">       4440 :         if (do_mpd_conv)</span>
<span class="lineNum">    5600 </span><span class="lineCov">          3 :                 return convert_mpd();</span>
<span class="lineNum">    5601 </span>            : #endif
<span class="lineNum">    5602 </span>            : 
<span class="lineNum">    5603 </span><span class="lineCov">       4437 :         if (dash_duration &amp;&amp; !nb_dash_inputs) {</span>
<span class="lineNum">    5604 </span><span class="lineCov">        149 :                 dash_inputs = set_dash_input(dash_inputs, inName, &amp;nb_dash_inputs);</span>
<span class="lineNum">    5605 </span>            :         }
<span class="lineNum">    5606 </span>            : 
<span class="lineNum">    5607 </span><span class="lineCov">       4437 :         if (do_saf &amp;&amp; !encode) {</span>
<span class="lineNum">    5608 </span><span class="lineCov">          1 :                 switch (get_file_type_by_ext(inName)) {</span>
<span class="lineNum">    5609 </span><span class="lineCov">          1 :                 case GF_FILE_TYPE_BT_WRL_X3DV:</span>
<span class="lineNum">    5610 </span>            :                 case GF_FILE_TYPE_XMT_X3D:
<span class="lineNum">    5611 </span>            :                 case GF_FILE_TYPE_SVG:
<span class="lineNum">    5612 </span><span class="lineCov">          1 :                         encode = GF_TRUE;</span>
<span class="lineNum">    5613 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    5614 </span>            :                 case GF_FILE_TYPE_NOT_SUPPORTED:
<span class="lineNum">    5615 </span>            :                 case GF_FILE_TYPE_ISO_MEDIA:
<span class="lineNum">    5616 </span>            :                 case GF_FILE_TYPE_SWF:
<span class="lineNum">    5617 </span>            :                 case GF_FILE_TYPE_LSR_SAF:
<span class="lineNum">    5618 </span>            :                         break;
<span class="lineNum">    5619 </span>            :                 }
<span class="lineNum">    5620 </span>            :         }
<span class="lineNum">    5621 </span>            : 
<span class="lineNum">    5622 </span>            : #ifndef GPAC_DISABLE_SCENE_DUMP
<span class="lineNum">    5623 </span><span class="lineCov">       4437 :         if (dump_mode == GF_SM_DUMP_SVG) {</span>
<span class="lineNum">    5624 </span><span class="lineCov">          3 :                 if (strstr(inName, &quot;.srt&quot;) || strstr(inName, &quot;.ttxt&quot;)) import_subtitle = 2;</span>
<span class="lineNum">    5625 </span>            :         }
<span class="lineNum">    5626 </span>            : #endif
<span class="lineNum">    5627 </span>            : 
<span class="lineNum">    5628 </span><span class="lineCov">       4437 :         if (import_subtitle &amp;&amp; !trackID)</span>
<span class="lineNum">    5629 </span><span class="lineCov">          6 :                 return do_import_sub();</span>
<span class="lineNum">    5630 </span>            : 
<span class="lineNum">    5631 </span>            : 
<span class="lineNum">    5632 </span>            : #if !defined(GPAC_DISABLE_MEDIA_IMPORT) &amp;&amp; !defined(GPAC_DISABLE_ISOM_WRITE)
<span class="lineNum">    5633 </span><span class="lineCov">       4431 :         if (nb_add || nb_cat) {</span>
<span class="lineNum">    5634 </span><span class="lineCov">        455 :                 u32 res = do_add_cat(argc, argv);</span>
<span class="lineNum">    5635 </span><span class="lineCov">        455 :                 if (res) return res;</span>
<span class="lineNum">    5636 </span>            :         }
<span class="lineNum">    5637 </span>            : #endif /*!GPAC_DISABLE_MEDIA_IMPORT &amp;&amp; !GPAC_DISABLE_ISOM_WRITE*/
<span class="lineNum">    5638 </span>            : 
<span class="lineNum">    5639 </span>            : #if !defined(GPAC_DISABLE_ISOM_WRITE) &amp;&amp; !defined(GPAC_DISABLE_SCENE_ENCODER) &amp;&amp; !defined(GPAC_DISABLE_MEDIA_IMPORT)
<span class="lineNum">    5640 </span><span class="lineCov">       3976 :         else if (chunk_mode) {</span>
<span class="lineNum">    5641 </span><span class="lineCov">          1 :                 if (!inName) {</span>
<span class="lineNum">    5642 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;chunk encoding syntax: [-outctx outDump] -inctx inScene auFile\n&quot;));</span>
<span class="lineNum">    5643 </span><span class="lineNoCov">          0 :                         return mp4box_cleanup(1);</span>
<span class="lineNum">    5644 </span>            :                 }
<span class="lineNum">    5645 </span><span class="lineCov">          1 :                 e = EncodeFileChunk(inName, outName ? outName : inName, input_ctx, output_ctx);</span>
<span class="lineNum">    5646 </span><span class="lineCov">          1 :                 if (e) {</span>
<span class="lineNum">    5647 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Error encoding chunk file %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    5648 </span><span class="lineNoCov">          0 :                         return mp4box_cleanup(1);</span>
<span class="lineNum">    5649 </span>            :                 }
<span class="lineNum">    5650 </span>            :                 goto exit;
<span class="lineNum">    5651 </span>            :         }
<span class="lineNum">    5652 </span>            : #endif // !defined(GPAC_DISABLE_ISOM_WRITE) &amp;&amp; !defined(GPAC_DISABLE_SCENE_ENCODER) &amp;&amp; !defined(GPAC_DISABLE_MEDIA_IMPORT)
<span class="lineNum">    5653 </span>            : 
<span class="lineNum">    5654 </span><span class="lineCov">       3975 :         else if (encode) {</span>
<span class="lineNum">    5655 </span>            : #if !defined(GPAC_DISABLE_ISOM_WRITE) &amp;&amp; !defined(GPAC_DISABLE_SCENE_ENCODER) &amp;&amp; !defined(GPAC_DISABLE_MEDIA_IMPORT)
<span class="lineNum">    5656 </span><span class="lineCov">         33 :                 e = do_scene_encode();</span>
<span class="lineNum">    5657 </span><span class="lineCov">         33 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5658 </span>            : #endif //!defined(GPAC_DISABLE_ISOM_WRITE) &amp;&amp; !defined(GPAC_DISABLE_SCENE_ENCODER) &amp;&amp; !defined(GPAC_DISABLE_MEDIA_IMPORT)
<span class="lineNum">    5659 </span>            :         }
<span class="lineNum">    5660 </span>            : 
<span class="lineNum">    5661 </span>            : #ifndef GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    5662 </span><span class="lineCov">       3942 :         else if (pack_file) {</span>
<span class="lineNum">    5663 </span><span class="lineCov">          2 :                 char *fileName = gf_url_colon_suffix(pack_file);</span>
<span class="lineNum">    5664 </span><span class="lineCov">          2 :                 if (fileName &amp;&amp; ((fileName - pack_file)==4)) {</span>
<span class="lineNum">    5665 </span><span class="lineCov">          1 :                         fileName[0] = 0;</span>
<span class="lineNum">    5666 </span><span class="lineCov">          1 :                         file = package_file(fileName + 1, pack_file, pack_wgt);</span>
<span class="lineNum">    5667 </span><span class="lineCov">          1 :                         fileName[0] = ':';</span>
<span class="lineNum">    5668 </span>            :                 } else {
<span class="lineNum">    5669 </span><span class="lineCov">          1 :                         file = package_file(pack_file, NULL, pack_wgt);</span>
<span class="lineNum">    5670 </span><span class="lineCov">          1 :                         if (!file) {</span>
<span class="lineNum">    5671 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Failed to package file\n&quot;));</span>
<span class="lineNum">    5672 </span><span class="lineNoCov">          0 :                                 return mp4box_cleanup(1);</span>
<span class="lineNum">    5673 </span>            :                         }
<span class="lineNum">    5674 </span>            :                 }
<span class="lineNum">    5675 </span><span class="lineCov">          2 :                 if (!outName) outName = inName;</span>
<span class="lineNum">    5676 </span><span class="lineCov">          2 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    5677 </span><span class="lineCov">          2 :                 open_edit = GF_TRUE;</span>
<span class="lineNum">    5678 </span>            :         }
<span class="lineNum">    5679 </span>            : #endif //GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    5680 </span>            : 
<span class="lineNum">    5681 </span><span class="lineCov">       4427 :         if (dash_duration) {</span>
<span class="lineNum">    5682 </span><span class="lineCov">        176 :                 e = do_dash();</span>
<span class="lineNum">    5683 </span><span class="lineCov">        176 :                 if (e) return mp4box_cleanup(1);</span>
<span class="lineNum">    5684 </span>            :                 goto exit;
<span class="lineNum">    5685 </span>            :         }
<span class="lineNum">    5686 </span>            : 
<span class="lineNum">    5687 </span>            :         //need to open input
<span class="lineNum">    5688 </span><span class="lineCov">       4251 :         if (!file &amp;&amp; !do_hash) {</span>
<span class="lineNum">    5689 </span><span class="lineCov">       1078 :                 FILE *st = gf_fopen(inName, &quot;rb&quot;);</span>
<span class="lineNum">    5690 </span>            :                 Bool file_exists = 0;
<span class="lineNum">    5691 </span>            :                 GF_ISOOpenMode omode;
<span class="lineNum">    5692 </span><span class="lineCov">       1078 :                 if (st) {</span>
<span class="lineNum">    5693 </span>            :                         file_exists = 1;
<span class="lineNum">    5694 </span><span class="lineCov">       1023 :                         gf_fclose(st);</span>
<span class="lineNum">    5695 </span>            :                 }
<span class="lineNum">    5696 </span><span class="lineCov">       1078 :                 switch (get_file_type_by_ext(inName)) {</span>
<span class="lineNum">    5697 </span><span class="lineCov">        938 :                 case 1:</span>
<span class="lineNum">    5698 </span><span class="lineCov">        938 :                         omode =  (u8) (force_new ? GF_ISOM_WRITE_EDIT : (open_edit ? GF_ISOM_OPEN_EDIT : ( ((dump_isom&gt;0) || print_info) ? GF_ISOM_OPEN_READ_DUMP : GF_ISOM_OPEN_READ) ) );</span>
<span class="lineNum">    5699 </span>            : 
<span class="lineNum">    5700 </span><span class="lineCov">        938 :                         if (crypt) {</span>
<span class="lineNum">    5701 </span>            :                                 //keep fragment signaling in moov
<span class="lineNum">    5702 </span>            :                                 omode = GF_ISOM_OPEN_READ;
<span class="lineNum">    5703 </span><span class="lineCov">        210 :                                 if (use_init_seg)</span>
<span class="lineNum">    5704 </span><span class="lineCov">          3 :                                         file = gf_isom_open(use_init_seg, GF_ISOM_OPEN_READ, NULL);</span>
<span class="lineNum">    5705 </span>            :                         }
<span class="lineNum">    5706 </span><span class="lineCov">        938 :                         if (!crypt &amp;&amp; use_init_seg) {</span>
<span class="lineNum">    5707 </span><span class="lineCov">          2 :                                 file = gf_isom_open(use_init_seg, GF_ISOM_OPEN_READ_DUMP, NULL);</span>
<span class="lineNum">    5708 </span><span class="lineCov">          2 :                                 if (file) {</span>
<span class="lineNum">    5709 </span><span class="lineCov">          2 :                                         e = gf_isom_open_segment(file, inName, 0, 0, 0);</span>
<span class="lineNum">    5710 </span><span class="lineCov">          2 :                                         if (e==GF_ISOM_INCOMPLETE_FILE) {</span>
<span class="lineNum">    5711 </span><span class="lineNoCov">          0 :                                                 M4_LOG(GF_LOG_WARNING, (&quot;Segment %s: %s\n&quot;, inName, gf_error_to_string(e) ));</span>
<span class="lineNum">    5712 </span><span class="lineCov">          2 :                                         } else if (e) {</span>
<span class="lineNum">    5713 </span><span class="lineNoCov">          0 :                                                 M4_LOG(GF_LOG_ERROR, (&quot;Error opening segment %s: %s\n&quot;, inName, gf_error_to_string(e) ));</span>
<span class="lineNum">    5714 </span><span class="lineNoCov">          0 :                                                 gf_isom_delete(file);</span>
<span class="lineNum">    5715 </span><span class="lineNoCov">          0 :                                                 file = NULL;</span>
<span class="lineNum">    5716 </span>            :                                         }
<span class="lineNum">    5717 </span>            :                                 }
<span class="lineNum">    5718 </span>            :                         }
<span class="lineNum">    5719 </span><span class="lineCov">        938 :                         if (!file)</span>
<span class="lineNum">    5720 </span><span class="lineCov">        933 :                                 file = gf_isom_open(inName, omode, NULL);</span>
<span class="lineNum">    5721 </span>            : 
<span class="lineNum">    5722 </span><span class="lineCov">        938 :                         if (!file &amp;&amp; (gf_isom_last_error(NULL) == GF_ISOM_INCOMPLETE_FILE) &amp;&amp; !open_edit) {</span>
<span class="lineNum">    5723 </span>            :                                 u64 missing_bytes;
<span class="lineNum">    5724 </span><span class="lineNoCov">          0 :                                 gf_isom_open_progressive(inName, 0, 0, GF_FALSE, &amp;file, &amp;missing_bytes);</span>
<span class="lineNum">    5725 </span><span class="lineNoCov">          0 :                                 if (missing_bytes)</span>
<span class="lineNum">    5726 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_ERROR, (&quot;Truncated file - missing &quot;LLD&quot; bytes\n&quot;, missing_bytes));</span>
<span class="lineNum">    5727 </span>            :                         }
<span class="lineNum">    5728 </span>            : 
<span class="lineNum">    5729 </span><span class="lineCov">        938 :                         if (!file) {</span>
<span class="lineNum">    5730 </span><span class="lineCov">          2 :                                 if (open_edit &amp;&amp; nb_meta_act) {</span>
<span class="lineNum">    5731 </span><span class="lineNoCov">          0 :                                         file = gf_isom_open(inName, GF_ISOM_WRITE_EDIT, NULL);</span>
<span class="lineNum">    5732 </span><span class="lineNoCov">          0 :                                         if (!outName &amp;&amp; file) outName = inName;</span>
<span class="lineNum">    5733 </span>            :                                 }
<span class="lineNum">    5734 </span>            : 
<span class="lineNum">    5735 </span><span class="lineCov">          2 :                                 if (!file) {</span>
<span class="lineNum">    5736 </span><span class="lineCov">          2 :                                         M4_LOG(GF_LOG_ERROR, (&quot;Error opening file %s: %s\n&quot;, inName, gf_error_to_string(gf_isom_last_error(NULL))));</span>
<span class="lineNum">    5737 </span><span class="lineCov">          2 :                                         return mp4box_cleanup(1);</span>
<span class="lineNum">    5738 </span>            :                                 }
<span class="lineNum">    5739 </span>            :                         }
<span class="lineNum">    5740 </span><span class="lineCov">        936 :                         if (freeze_box_order)</span>
<span class="lineNum">    5741 </span><span class="lineNoCov">          0 :                                 gf_isom_freeze_order(file);</span>
<span class="lineNum">    5742 </span>            :                         break;
<span class="lineNum">    5743 </span>            :                 /*allowed for bt&lt;-&gt;xmt*/
<span class="lineNum">    5744 </span>            :                 case 2:
<span class="lineNum">    5745 </span>            :                 case 3:
<span class="lineNum">    5746 </span>            :                 /*allowed for svg-&gt;lsr**/
<span class="lineNum">    5747 </span>            :                 case 4:
<span class="lineNum">    5748 </span>            :                 /*allowed for swf-&gt;bt, swf-&gt;xmt, swf-&gt;svg*/
<span class="lineNum">    5749 </span>            :                 case 5:
<span class="lineNum">    5750 </span>            :                         break;
<span class="lineNum">    5751 </span>            :                 /*used for .saf / .lsr dump*/
<span class="lineNum">    5752 </span><span class="lineCov">          1 :                 case 6:</span>
<span class="lineNum">    5753 </span>            : #ifndef GPAC_DISABLE_SCENE_DUMP
<span class="lineNum">    5754 </span><span class="lineCov">          1 :                         if ((dump_mode==GF_SM_DUMP_LASER) || (dump_mode==GF_SM_DUMP_SVG)) {</span>
<span class="lineNum">    5755 </span>            :                                 break;
<span class="lineNum">    5756 </span>            :                         }
<span class="lineNum">    5757 </span>            : #endif
<span class="lineNum">    5758 </span>            : 
<span class="lineNum">    5759 </span>            :                 default:
<span class="lineNum">    5760 </span><span class="lineCov">        115 :                         if (!open_edit &amp;&amp; file_exists &amp;&amp; !gf_isom_probe_file(inName) &amp;&amp; track_dump_type) {</span>
<span class="lineNum">    5761 </span>            :                         }
<span class="lineNum">    5762 </span>            : #ifndef GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    5763 </span><span class="lineCov">        115 :                         else if (!open_edit &amp;&amp; file_exists /* &amp;&amp; !gf_isom_probe_file(inName) */</span>
<span class="lineNum">    5764 </span>            : #ifndef GPAC_DISABLE_SCENE_DUMP
<span class="lineNum">    5765 </span><span class="lineCov">         62 :                                  &amp;&amp; dump_mode == GF_SM_DUMP_NONE</span>
<span class="lineNum">    5766 </span>            : #endif //GPAC_DISABLE_SCENE_DUMP
<span class="lineNum">    5767 </span>            :                                 ) {
<span class="lineNum">    5768 </span>            :                                 /*************************************************************************************************/
<span class="lineNum">    5769 </span>            : #ifndef GPAC_DISABLE_MEDIA_IMPORT
<span class="lineNum">    5770 </span><span class="lineCov">         62 :                                 if(dvbhdemux)</span>
<span class="lineNum">    5771 </span>            :                                 {
<span class="lineNum">    5772 </span>            :                                         GF_MediaImporter import;
<span class="lineNum">    5773 </span><span class="lineNoCov">          0 :                                         file = gf_isom_open(&quot;ttxt_convert&quot;, GF_ISOM_OPEN_WRITE, NULL);</span>
<span class="lineNum">    5774 </span>            :                                         memset(&amp;import, 0, sizeof(GF_MediaImporter));
<span class="lineNum">    5775 </span><span class="lineNoCov">          0 :                                         import.dest = file;</span>
<span class="lineNum">    5776 </span><span class="lineNoCov">          0 :                                         import.in_name = inName;</span>
<span class="lineNum">    5777 </span><span class="lineNoCov">          0 :                                         import.flags = GF_IMPORT_MPE_DEMUX;</span>
<span class="lineNum">    5778 </span><span class="lineNoCov">          0 :                                         e = gf_media_import(&amp;import);</span>
<span class="lineNum">    5779 </span><span class="lineNoCov">          0 :                                         if (e) {</span>
<span class="lineNum">    5780 </span><span class="lineNoCov">          0 :                                                 M4_LOG(GF_LOG_ERROR, (&quot;Error importing %s: %s\n&quot;, inName, gf_error_to_string(e)));</span>
<span class="lineNum">    5781 </span><span class="lineNoCov">          0 :                                                 gf_isom_delete(file);</span>
<span class="lineNum">    5782 </span><span class="lineNoCov">          0 :                                                 gf_file_delete(&quot;ttxt_convert&quot;);</span>
<span class="lineNum">    5783 </span><span class="lineNoCov">          0 :                                                 return mp4box_cleanup(1);</span>
<span class="lineNum">    5784 </span>            :                                         }
<span class="lineNum">    5785 </span>            :                                 }
<span class="lineNum">    5786 </span>            : #endif /*GPAC_DISABLE_MEDIA_IMPORT*/
<span class="lineNum">    5787 </span>            : 
<span class="lineNum">    5788 </span><span class="lineCov">         62 :                                 if (dump_m2ts) {</span>
<span class="lineNum">    5789 </span>            : #ifndef GPAC_DISABLE_MPEG2TS
<span class="lineNum">    5790 </span><span class="lineCov">          1 :                                         dump_mpeg2_ts(inName, outName, program_number);</span>
<span class="lineNum">    5791 </span>            : #endif
<span class="lineNum">    5792 </span><span class="lineCov">         61 :                                 } else if (dump_timestamps) {</span>
<span class="lineNum">    5793 </span>            : #ifndef GPAC_DISABLE_MPEG2TS
<span class="lineNum">    5794 </span><span class="lineNoCov">          0 :                                         dump_mpeg2_ts(inName, outName, program_number);</span>
<span class="lineNum">    5795 </span>            : #endif
<span class="lineNum">    5796 </span>            : #ifndef GPAC_DISABLE_CORE_TOOLS
<span class="lineNum">    5797 </span><span class="lineCov">         61 :                                 } else if (do_bin_xml) {</span>
<span class="lineNum">    5798 </span><span class="lineNoCov">          0 :                                         xml_bs_to_bin(inName, outName, dump_std);</span>
<span class="lineNum">    5799 </span>            : #endif
<span class="lineNum">    5800 </span><span class="lineCov">         61 :                                 } else if (do_hash) {</span>
<span class="lineNum">    5801 </span><span class="lineNoCov">          0 :                                         hash_file(inName, dump_std);</span>
<span class="lineNum">    5802 </span><span class="lineCov">         61 :                                 } else if (print_info) {</span>
<span class="lineNum">    5803 </span>            : #ifndef GPAC_DISABLE_MEDIA_IMPORT
<span class="lineNum">    5804 </span><span class="lineCov">         61 :                                         convert_file_info(inName, info_track_id);</span>
<span class="lineNum">    5805 </span>            : #endif
<span class="lineNum">    5806 </span>            :                                 } else {
<span class="lineNum">    5807 </span><span class="lineNoCov">          0 :                                         if (mux_name) {</span>
<span class="lineNum">    5808 </span><span class="lineNoCov">          0 :                                                 e = do_remux_file();</span>
<span class="lineNum">    5809 </span><span class="lineNoCov">          0 :                                                 if (e) goto err_exit;</span>
<span class="lineNum">    5810 </span><span class="lineNoCov">          0 :                                                 if (file) gf_isom_delete(file);</span>
<span class="lineNum">    5811 </span>            :                                                 goto exit;
<span class="lineNum">    5812 </span>            :                                         } else {
<span class="lineNum">    5813 </span><span class="lineNoCov">          0 :                                                 M4_LOG(GF_LOG_ERROR, (&quot;Input %s is not an MP4 file, operation not allowed\n&quot;, inName));</span>
<span class="lineNum">    5814 </span><span class="lineNoCov">          0 :                                                 return mp4box_cleanup(1);</span>
<span class="lineNum">    5815 </span>            :                                         }
<span class="lineNum">    5816 </span>            :                                 }
<span class="lineNum">    5817 </span>            :                                 goto exit;
<span class="lineNum">    5818 </span>            :                         }
<span class="lineNum">    5819 </span>            : #endif /*GPAC_DISABLE_ISOM_WRITE*/
<span class="lineNum">    5820 </span><span class="lineCov">         53 :                         else if (open_edit) {</span>
<span class="lineNum">    5821 </span><span class="lineCov">         53 :                                 file = gf_isom_open(inName, GF_ISOM_WRITE_EDIT, NULL);</span>
<span class="lineNum">    5822 </span><span class="lineCov">         53 :                                 if (!outName &amp;&amp; file) outName = inName;</span>
<span class="lineNum">    5823 </span><span class="lineNoCov">          0 :                         } else if (!file_exists) {</span>
<span class="lineNum">    5824 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Error %s file %s: %s\n&quot;, force_new ? &quot;creating&quot; : &quot;opening&quot;, inName, gf_error_to_string(GF_URL_ERROR)));</span>
<span class="lineNum">    5825 </span><span class="lineNoCov">          0 :                                 return mp4box_cleanup(1);</span>
<span class="lineNum">    5826 </span>            :                         } else {
<span class="lineNum">    5827 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Cannot open %s - extension not supported\n&quot;, inName));</span>
<span class="lineNum">    5828 </span><span class="lineNoCov">          0 :                                 return mp4box_cleanup(1);</span>
<span class="lineNum">    5829 </span>            :                         }
<span class="lineNum">    5830 </span>            :                 }
<span class="lineNum">    5831 </span>            :         }
<span class="lineNum">    5832 </span>            : 
<span class="lineNum">    5833 </span><span class="lineCov">       4187 :         if (high_dynamc_range_filename) {</span>
<span class="lineNum">    5834 </span><span class="lineCov">          1 :                 e = parse_high_dynamc_range_xml_desc(file, high_dynamc_range_filename);</span>
<span class="lineNum">    5835 </span><span class="lineCov">          1 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5836 </span>            :         }
<span class="lineNum">    5837 </span>            : 
<span class="lineNum">    5838 </span><span class="lineCov">       4187 :         if (file &amp;&amp; keep_utc) {</span>
<span class="lineNum">    5839 </span><span class="lineNoCov">          0 :                 gf_isom_keep_utc_times(file, 1);</span>
<span class="lineNum">    5840 </span>            :         }
<span class="lineNum">    5841 </span>            : 
<span class="lineNum">    5842 </span><span class="lineCov">       4187 :         if ( gf_strlcpy(outfile, outName ? outName : inName, sizeof(outfile)) &gt;= sizeof(outfile) ) {</span>
<span class="lineNum">    5843 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CORE, (&quot;Filename too long (limit is %d)\n&quot;, GF_MAX_PATH));</span>
<span class="lineNum">    5844 </span><span class="lineNoCov">          0 :                 return mp4box_cleanup(1);</span>
<span class="lineNum">    5845 </span>            :         }
<span class="lineNum">    5846 </span>            : 
<span class="lineNum">    5847 </span><span class="lineCov">       4187 :         char *szExt = gf_file_ext_start(outfile);</span>
<span class="lineNum">    5848 </span><span class="lineCov">       4187 :         if (szExt) {</span>
<span class="lineNum">    5849 </span>            :                 /*turn on 3GP saving*/
<span class="lineNum">    5850 </span><span class="lineCov">       1499 :                 if (!stricmp(szExt, &quot;.3gp&quot;) || !stricmp(szExt, &quot;.3gpp&quot;) || !stricmp(szExt, &quot;.3g2&quot;))</span>
<span class="lineNum">    5851 </span><span class="lineNoCov">          0 :                         conv_type = GF_ISOM_CONV_TYPE_3GPP;</span>
<span class="lineNum">    5852 </span><span class="lineCov">       1499 :                 else if (!stricmp(szExt, &quot;.m4a&quot;) || !stricmp(szExt, &quot;.m4v&quot;))</span>
<span class="lineNum">    5853 </span><span class="lineNoCov">          0 :                         conv_type = GF_ISOM_CONV_TYPE_IPOD;</span>
<span class="lineNum">    5854 </span><span class="lineCov">       1499 :                 else if (!stricmp(szExt, &quot;.psp&quot;))</span>
<span class="lineNum">    5855 </span><span class="lineNoCov">          0 :                         conv_type = GF_ISOM_CONV_TYPE_PSP;</span>
<span class="lineNum">    5856 </span><span class="lineCov">       1499 :                 else if (!stricmp(szExt, &quot;.mov&quot;) || !stricmp(szExt, &quot;.qt&quot;))</span>
<span class="lineNum">    5857 </span><span class="lineCov">          3 :                         conv_type = GF_ISOM_CONV_TYPE_MOV;</span>
<span class="lineNum">    5858 </span>            : 
<span class="lineNum">    5859 </span>            :                 //remove extension from outfile
<span class="lineNum">    5860 </span><span class="lineCov">       1499 :                 *szExt = 0;</span>
<span class="lineNum">    5861 </span>            :         }
<span class="lineNum">    5862 </span>            : 
<span class="lineNum">    5863 </span>            : #ifndef GPAC_DISABLE_MEDIA_EXPORT
<span class="lineNum">    5864 </span><span class="lineCov">       4187 :         if (!open_edit &amp;&amp; track_dump_type &amp;&amp; !gf_isom_probe_file(inName)) {</span>
<span class="lineNum">    5865 </span><span class="lineNoCov">          0 :                 e = do_export_tracks_non_isobmf();</span>
<span class="lineNum">    5866 </span><span class="lineNoCov">          0 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5867 </span>            :                 goto exit;
<span class="lineNum">    5868 </span>            :         }
<span class="lineNum">    5869 </span><span class="lineCov">       4187 :         if (mux_name) {</span>
<span class="lineNum">    5870 </span><span class="lineNoCov">          0 :                 e = do_remux_file();</span>
<span class="lineNum">    5871 </span><span class="lineNoCov">          0 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5872 </span><span class="lineNoCov">          0 :                 if (file) gf_isom_delete(file);</span>
<span class="lineNum">    5873 </span>            :                 goto exit;
<span class="lineNum">    5874 </span>            :         }
<span class="lineNum">    5875 </span>            : 
<span class="lineNum">    5876 </span>            : 
<span class="lineNum">    5877 </span>            : 
<span class="lineNum">    5878 </span>            : #endif /*GPAC_DISABLE_MEDIA_EXPORT*/
<span class="lineNum">    5879 </span>            : 
<span class="lineNum">    5880 </span>            : #ifndef GPAC_DISABLE_SCENE_DUMP
<span class="lineNum">    5881 </span><span class="lineCov">       4187 :         if (dump_mode != GF_SM_DUMP_NONE) {</span>
<span class="lineNum">    5882 </span><span class="lineCov">         17 :                 e = dump_isom_scene(inName, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE, dump_mode, do_scene_log, no_odf_conf);</span>
<span class="lineNum">    5883 </span><span class="lineCov">         17 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5884 </span>            :         }
<span class="lineNum">    5885 </span>            : #endif
<span class="lineNum">    5886 </span>            : 
<span class="lineNum">    5887 </span>            : #ifndef GPAC_DISABLE_SCENE_STATS
<span class="lineNum">    5888 </span><span class="lineCov">       4187 :         if (stat_level) dump_isom_scene_stats(inName, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE, stat_level);</span>
<span class="lineNum">    5889 </span>            : #endif
<span class="lineNum">    5890 </span>            : 
<span class="lineNum">    5891 </span>            : #ifndef GPAC_DISABLE_ISOM_HINTING
<span class="lineNum">    5892 </span><span class="lineCov">       4187 :         if (!do_hint &amp;&amp; print_sdp) dump_isom_sdp(file, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    5893 </span>            : #endif
<span class="lineNum">    5894 </span><span class="lineCov">       4187 :         if (get_nb_tracks) {</span>
<span class="lineNum">    5895 </span><span class="lineNoCov">          0 :                 fprintf(stdout, &quot;%d\n&quot;, gf_isom_get_track_count(file));</span>
<span class="lineNum">    5896 </span>            :         }
<span class="lineNum">    5897 </span><span class="lineCov">       4187 :         if (print_info) {</span>
<span class="lineNum">    5898 </span><span class="lineCov">        190 :                 if (!file) {</span>
<span class="lineNum">    5899 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Cannot print info on a non ISOM file (%s)\n&quot;, inName));</span>
<span class="lineNum">    5900 </span>            :                 } else {
<span class="lineNum">    5901 </span><span class="lineCov">        190 :                         if (info_track_id) DumpTrackInfo(file, info_track_id, 1, (print_info==2) ? GF_TRUE : GF_FALSE, GF_FALSE);</span>
<span class="lineNum">    5902 </span><span class="lineCov">        186 :                         else DumpMovieInfo(file);</span>
<span class="lineNum">    5903 </span>            :                 }
<span class="lineNum">    5904 </span>            :         }
<span class="lineNum">    5905 </span>            : #ifndef GPAC_DISABLE_ISOM_DUMP
<span class="lineNum">    5906 </span><span class="lineCov">       4187 :         if (dump_isom) {</span>
<span class="lineNum">    5907 </span><span class="lineCov">        117 :                 e = dump_isom_xml(file, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE, (dump_isom==2) ? GF_TRUE : GF_FALSE, merge_vtt_cues, use_init_seg ? GF_TRUE : GF_FALSE, (dump_isom==3) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    5908 </span><span class="lineCov">        117 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5909 </span>            :         }
<span class="lineNum">    5910 </span><span class="lineCov">       4187 :         if (dump_cr) dump_isom_ismacryp(file, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    5911 </span><span class="lineCov">       4187 :         if ((dump_ttxt || dump_srt) &amp;&amp; trackID) {</span>
<span class="lineNum">    5912 </span>            : 
<span class="lineNum">    5913 </span><span class="lineCov">          4 :                 if (trackID == (u32)-1) {</span>
<span class="lineNum">    5914 </span><span class="lineNoCov">          0 :                         for (j=0; j&lt;gf_isom_get_track_count(file); j++) {</span>
<span class="lineNum">    5915 </span><span class="lineNoCov">          0 :                                 trackID = gf_isom_get_track_id(file, j+1);</span>
<span class="lineNum">    5916 </span><span class="lineNoCov">          0 :                                 dump_isom_timed_text(file, trackID, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE,</span>
<span class="lineNum">    5917 </span><span class="lineNoCov">          0 :                                                                         GF_FALSE, dump_srt ? GF_TEXTDUMPTYPE_SRT : GF_TEXTDUMPTYPE_TTXT);</span>
<span class="lineNum">    5918 </span>            :                         }
<span class="lineNum">    5919 </span>            : 
<span class="lineNum">    5920 </span>            :                 }
<span class="lineNum">    5921 </span>            :                 else {
<span class="lineNum">    5922 </span><span class="lineCov">          4 :                         dump_isom_timed_text(file, trackID, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE,</span>
<span class="lineNum">    5923 </span><span class="lineCov">          4 :                                                                 GF_FALSE, dump_srt ? GF_TEXTDUMPTYPE_SRT : GF_TEXTDUMPTYPE_TTXT);</span>
<span class="lineNum">    5924 </span>            :                 }
<span class="lineNum">    5925 </span>            :         }
<span class="lineNum">    5926 </span>            : 
<span class="lineNum">    5927 </span>            : #ifndef GPAC_DISABLE_ISOM_HINTING
<span class="lineNum">    5928 </span><span class="lineCov">       4187 :         if (dump_rtp) dump_isom_rtp(file, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    5929 </span>            : #endif
<span class="lineNum">    5930 </span>            : 
<span class="lineNum">    5931 </span>            : #endif
<span class="lineNum">    5932 </span>            : 
<span class="lineNum">    5933 </span><span class="lineCov">       4187 :         if (dump_timestamps) dump_isom_timestamps(file, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE, dump_timestamps);</span>
<span class="lineNum">    5934 </span><span class="lineCov">       4187 :         if (dump_nal) dump_isom_nal(file, dump_nal, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE, dump_nal_type);</span>
<span class="lineNum">    5935 </span><span class="lineCov">       4187 :         if (dump_saps) dump_isom_saps(file, dump_saps, dump_saps_mode, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    5936 </span>            : 
<span class="lineNum">    5937 </span><span class="lineCov">       4187 :         if (do_hash) {</span>
<span class="lineNum">    5938 </span><span class="lineCov">       2686 :                 e = hash_file(inName, dump_std);</span>
<span class="lineNum">    5939 </span><span class="lineCov">       2686 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5940 </span>            :         }
<span class="lineNum">    5941 </span>            : #ifndef GPAC_DISABLE_CORE_TOOLS
<span class="lineNum">    5942 </span><span class="lineCov">       4177 :         if (do_bin_xml) {</span>
<span class="lineNum">    5943 </span><span class="lineCov">          1 :                 e = xml_bs_to_bin(inName, outName, dump_std);</span>
<span class="lineNum">    5944 </span><span class="lineCov">          1 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5945 </span>            :         }
<span class="lineNum">    5946 </span>            : #endif
<span class="lineNum">    5947 </span>            : 
<span class="lineNum">    5948 </span><span class="lineCov">       4177 :         if (dump_cart) dump_isom_cover_art(file, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    5949 </span><span class="lineCov">       4177 :         if (dump_chap) dump_isom_chapters(file, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE, dump_chap);</span>
<span class="lineNum">    5950 </span><span class="lineCov">       4177 :         if (dump_udta_type) dump_isom_udta(file, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE, dump_udta_type, dump_udta_track);</span>
<span class="lineNum">    5951 </span>            : 
<span class="lineNum">    5952 </span><span class="lineCov">       4177 :         if (dump_iod) {</span>
<span class="lineNum">    5953 </span><span class="lineCov">          1 :                 e = do_dump_iod();</span>
<span class="lineNum">    5954 </span><span class="lineCov">          1 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5955 </span>            :         }
<span class="lineNum">    5956 </span>            : 
<span class="lineNum">    5957 </span>            : #if !defined(GPAC_DISABLE_ISOM_WRITE) &amp;&amp; !defined(GPAC_DISABLE_MEDIA_IMPORT)
<span class="lineNum">    5958 </span><span class="lineCov">       4177 :         if (split_duration || split_size || split_range_str) {</span>
<span class="lineNum">    5959 </span><span class="lineCov">          8 :                 split_isomedia_file(file, split_duration, split_size, inName, interleaving_time, split_start, adjust_split_end, outName, seg_at_rap, split_range_str, fs_dump_flags);</span>
<span class="lineNum">    5960 </span>            : 
<span class="lineNum">    5961 </span>            :                 /*never save file when splitting is desired*/
<span class="lineNum">    5962 </span><span class="lineCov">          8 :                 open_edit = GF_FALSE;</span>
<span class="lineNum">    5963 </span><span class="lineCov">          8 :                 do_save = GF_FALSE;</span>
<span class="lineNum">    5964 </span>            :         }
<span class="lineNum">    5965 </span>            : #endif // !defined(GPAC_DISABLE_ISOM_WRITE) &amp;&amp; !defined(GPAC_DISABLE_MEDIA_IMPORT)
<span class="lineNum">    5966 </span>            : 
<span class="lineNum">    5967 </span>            : #ifndef GPAC_DISABLE_MEDIA_EXPORT
<span class="lineNum">    5968 </span><span class="lineCov">       4177 :         if (track_dump_type) {</span>
<span class="lineNum">    5969 </span><span class="lineCov">         63 :                 e = do_export_tracks();</span>
<span class="lineNum">    5970 </span><span class="lineCov">         63 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5971 </span><span class="lineCov">       4114 :         } else if (do_saf) {</span>
<span class="lineNum">    5972 </span>            :                 GF_MediaExporter mdump;
<span class="lineNum">    5973 </span>            :                 memset(&amp;mdump, 0, sizeof(mdump));
<span class="lineNum">    5974 </span><span class="lineCov">          1 :                 mdump.file = file;</span>
<span class="lineNum">    5975 </span><span class="lineCov">          1 :                 mdump.flags = GF_EXPORT_SAF;</span>
<span class="lineNum">    5976 </span><span class="lineCov">          1 :                 mdump.out_name = outfile;</span>
<span class="lineNum">    5977 </span><span class="lineCov">          1 :                 mdump.print_stats_graph = fs_dump_flags;</span>
<span class="lineNum">    5978 </span><span class="lineCov">          1 :                 e = gf_media_export(&amp;mdump);</span>
<span class="lineNum">    5979 </span><span class="lineCov">          1 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5980 </span>            :         }
<span class="lineNum">    5981 </span>            : #endif
<span class="lineNum">    5982 </span>            : 
<span class="lineNum">    5983 </span><span class="lineCov">       4177 :         e = do_meta_act();</span>
<span class="lineNum">    5984 </span><span class="lineCov">       4177 :         if (e) goto err_exit;</span>
<span class="lineNum">    5985 </span>            : 
<span class="lineNum">    5986 </span><span class="lineCov">       4177 :         if (!open_edit &amp;&amp; !do_save) {</span>
<span class="lineNum">    5987 </span><span class="lineCov">       3206 :                 if (file) gf_isom_delete(file);</span>
<span class="lineNum">    5988 </span>            :                 goto exit;
<span class="lineNum">    5989 </span>            :         }
<span class="lineNum">    5990 </span>            : 
<span class="lineNum">    5991 </span>            : 
<span class="lineNum">    5992 </span>            : #ifndef GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    5993 </span><span class="lineCov">        971 :         if (clean_groups) {</span>
<span class="lineNum">    5994 </span><span class="lineCov">          1 :                 e = gf_isom_reset_switch_parameters(file);</span>
<span class="lineNum">    5995 </span><span class="lineCov">          1 :                 if (e) goto err_exit;</span>
<span class="lineNum">    5996 </span><span class="lineCov">          1 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    5997 </span>            :         }
<span class="lineNum">    5998 </span>            : 
<span class="lineNum">    5999 </span>            : 
<span class="lineNum">    6000 </span><span class="lineCov">        971 :         e = do_tsel_act();</span>
<span class="lineNum">    6001 </span><span class="lineCov">        971 :         if (e) goto err_exit;</span>
<span class="lineNum">    6002 </span>            : 
<span class="lineNum">    6003 </span><span class="lineCov">        971 :         if (remove_sys_tracks) {</span>
<span class="lineNum">    6004 </span>            : #ifndef GPAC_DISABLE_AV_PARSERS
<span class="lineNum">    6005 </span><span class="lineCov">          1 :                 remove_systems_tracks(file);</span>
<span class="lineNum">    6006 </span>            : #endif
<span class="lineNum">    6007 </span><span class="lineCov">          1 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6008 </span><span class="lineCov">          1 :                 if (conv_type &lt; GF_ISOM_CONV_TYPE_ISMA_EX) conv_type = 0;</span>
<span class="lineNum">    6009 </span>            :         }
<span class="lineNum">    6010 </span><span class="lineCov">        971 :         if (remove_root_od) {</span>
<span class="lineNum">    6011 </span><span class="lineCov">          1 :                 gf_isom_remove_root_od(file);</span>
<span class="lineNum">    6012 </span><span class="lineCov">          1 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6013 </span>            :         }
<span class="lineNum">    6014 </span>            : #ifndef GPAC_DISABLE_ISOM_HINTING
<span class="lineNum">    6015 </span><span class="lineCov">        971 :         if (remove_hint) {</span>
<span class="lineNum">    6016 </span><span class="lineCov">         84 :                 for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    6017 </span><span class="lineCov">         84 :                         if (gf_isom_get_media_type(file, i+1) == GF_ISOM_MEDIA_HINT) {</span>
<span class="lineNum">    6018 </span><span class="lineCov">         42 :                                 M4_LOG(GF_LOG_INFO, (&quot;Removing hint track ID %d\n&quot;, gf_isom_get_track_id(file, i+1)));</span>
<span class="lineNum">    6019 </span><span class="lineCov">         42 :                                 gf_isom_remove_track(file, i+1);</span>
<span class="lineNum">    6020 </span><span class="lineCov">         42 :                                 i--;</span>
<span class="lineNum">    6021 </span>            :                         }
<span class="lineNum">    6022 </span>            :                 }
<span class="lineNum">    6023 </span><span class="lineCov">         41 :                 gf_isom_sdp_clean(file);</span>
<span class="lineNum">    6024 </span><span class="lineCov">         41 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6025 </span>            :         }
<span class="lineNum">    6026 </span>            : #endif // GPAC_DISABLE_ISOM_HINTING
<span class="lineNum">    6027 </span>            : 
<span class="lineNum">    6028 </span><span class="lineCov">        971 :         if (timescale &amp;&amp; (timescale != gf_isom_get_timescale(file))) {</span>
<span class="lineNum">    6029 </span><span class="lineCov">          1 :                 gf_isom_set_timescale(file, timescale);</span>
<span class="lineNum">    6030 </span><span class="lineCov">          1 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6031 </span>            :         }
<span class="lineNum">    6032 </span>            : 
<span class="lineNum">    6033 </span><span class="lineCov">        971 :         if (!encode) {</span>
<span class="lineNum">    6034 </span><span class="lineCov">        939 :                 if (!file) {</span>
<span class="lineNum">    6035 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_INFO, (&quot;Nothing to do - exiting\n&quot;));</span>
<span class="lineNum">    6036 </span>            :                         goto exit;
<span class="lineNum">    6037 </span>            :                 }
<span class="lineNum">    6038 </span><span class="lineCov">        939 :                 if (outName) {</span>
<span class="lineNum">    6039 </span>            :                         strcpy(outfile, outName);
<span class="lineNum">    6040 </span>            :                 } else {
<span class="lineNum">    6041 </span><span class="lineCov">        562 :                         const char *tmp_dir = gf_opts_get_key(&quot;core&quot;, &quot;tmp&quot;);</span>
<span class="lineNum">    6042 </span><span class="lineCov">        562 :                         char *rel_name = strrchr(inName, GF_PATH_SEPARATOR);</span>
<span class="lineNum">    6043 </span>            :                         if (!rel_name) rel_name = strrchr(inName, '/');
<span class="lineNum">    6044 </span>            : 
<span class="lineNum">    6045 </span>            :                         strcpy(outfile, &quot;&quot;);
<span class="lineNum">    6046 </span><span class="lineCov">        562 :                         if (tmp_dir) {</span>
<span class="lineNum">    6047 </span>            :                                 strcpy(outfile, tmp_dir);
<span class="lineNum">    6048 </span><span class="lineNoCov">          0 :                                 if (!strchr(&quot;\\/&quot;, tmp_dir[strlen(tmp_dir)-1])) strcat(outfile, &quot;/&quot;);</span>
<span class="lineNum">    6049 </span>            :                         }
<span class="lineNum">    6050 </span><span class="lineCov">        562 :                         if (!pack_file) strcat(outfile, &quot;out_&quot;);</span>
<span class="lineNum">    6051 </span><span class="lineCov">        562 :                         strcat(outfile, rel_name ? rel_name + 1 : inName);</span>
<span class="lineNum">    6052 </span>            : 
<span class="lineNum">    6053 </span><span class="lineCov">        562 :                         if (pack_file) {</span>
<span class="lineNum">    6054 </span>            :                                 strcpy(outfile, rel_name ? rel_name + 1 : inName);
<span class="lineNum">    6055 </span><span class="lineNoCov">          0 :                                 rel_name = strrchr(outfile, '.');</span>
<span class="lineNum">    6056 </span><span class="lineNoCov">          0 :                                 if (rel_name) rel_name[0] = 0;</span>
<span class="lineNum">    6057 </span>            :                                 strcat(outfile, &quot;.m21&quot;);
<span class="lineNum">    6058 </span>            :                         }
<span class="lineNum">    6059 </span>            :                 }
<span class="lineNum">    6060 </span>            : #ifndef GPAC_DISABLE_MEDIA_IMPORT
<span class="lineNum">    6061 </span><span class="lineCov">        939 :                 if ((conv_type == GF_ISOM_CONV_TYPE_ISMA) || (conv_type == GF_ISOM_CONV_TYPE_ISMA_EX)) {</span>
<span class="lineNum">    6062 </span><span class="lineCov">          5 :                         M4_LOG(GF_LOG_INFO, (&quot;Converting to ISMA Audio-Video MP4 file\n&quot;));</span>
<span class="lineNum">    6063 </span>            :                         /*keep ESIDs when doing ISMACryp*/
<span class="lineNum">    6064 </span><span class="lineCov">          5 :                         e = gf_media_make_isma(file, crypt ? 1 : 0, GF_FALSE, (conv_type==GF_ISOM_CONV_TYPE_ISMA_EX) ? 1 : 0);</span>
<span class="lineNum">    6065 </span><span class="lineCov">          5 :                         if (e) goto err_exit;</span>
<span class="lineNum">    6066 </span><span class="lineCov">          5 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    6067 </span>            :                 }
<span class="lineNum">    6068 </span><span class="lineCov">        939 :                 if (conv_type == GF_ISOM_CONV_TYPE_3GPP) {</span>
<span class="lineNum">    6069 </span><span class="lineCov">          1 :                         M4_LOG(GF_LOG_INFO, (&quot;Converting to 3GP file\n&quot;));</span>
<span class="lineNum">    6070 </span><span class="lineCov">          1 :                         e = gf_media_make_3gpp(file);</span>
<span class="lineNum">    6071 </span><span class="lineCov">          1 :                         if (e) goto err_exit;</span>
<span class="lineNum">    6072 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    6073 </span>            :                 }
<span class="lineNum">    6074 </span><span class="lineCov">        939 :                 if (conv_type == GF_ISOM_CONV_TYPE_PSP) {</span>
<span class="lineNum">    6075 </span><span class="lineCov">          1 :                         M4_LOG(GF_LOG_INFO, (&quot;Converting to PSP file\n&quot;));</span>
<span class="lineNum">    6076 </span><span class="lineCov">          1 :                         e = gf_media_make_psp(file);</span>
<span class="lineNum">    6077 </span><span class="lineCov">          1 :                         if (e) goto err_exit;</span>
<span class="lineNum">    6078 </span><span class="lineCov">          1 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    6079 </span>            :                 }
<span class="lineNum">    6080 </span><span class="lineCov">        939 :                 if (conv_type == GF_ISOM_CONV_TYPE_MOV) {</span>
<span class="lineNum">    6081 </span><span class="lineCov">          2 :                         e = gf_media_check_qt_prores(file);</span>
<span class="lineNum">    6082 </span><span class="lineCov">          2 :                         if (e) goto err_exit;</span>
<span class="lineNum">    6083 </span><span class="lineCov">          2 :                         do_save = GF_TRUE;</span>
<span class="lineNum">    6084 </span><span class="lineCov">          2 :                         if (interleaving_time) interleaving_time = 0.5;</span>
<span class="lineNum">    6085 </span>            :                 }
<span class="lineNum">    6086 </span>            : #endif /*GPAC_DISABLE_MEDIA_IMPORT*/
<span class="lineNum">    6087 </span><span class="lineCov">        939 :                 if (conv_type == GF_ISOM_CONV_TYPE_IPOD) {</span>
<span class="lineNum">    6088 </span><span class="lineCov">          1 :                         do_ipod_conv();</span>
<span class="lineNum">    6089 </span>            :                 }
<span class="lineNum">    6090 </span>            : 
<span class="lineNum">    6091 </span><span class="lineCov">         32 :         } else if (outName) {</span>
<span class="lineNum">    6092 </span>            :                 strcpy(outfile, outName);
<span class="lineNum">    6093 </span>            :         }
<span class="lineNum">    6094 </span>            : 
<span class="lineNum">    6095 </span><span class="lineCov">        971 :         e = do_track_act();</span>
<span class="lineNum">    6096 </span><span class="lineCov">        971 :         if (e) goto err_exit;</span>
<span class="lineNum">    6097 </span>            : 
<span class="lineNum">    6098 </span><span class="lineCov">        970 :         if (itunes_tags) {</span>
<span class="lineNum">    6099 </span><span class="lineCov">          1 :                 e = do_itunes_tag();</span>
<span class="lineNum">    6100 </span><span class="lineCov">          1 :                 if (e) goto err_exit;</span>
<span class="lineNum">    6101 </span>            :         }
<span class="lineNum">    6102 </span>            : 
<span class="lineNum">    6103 </span><span class="lineCov">        970 :         if (cprt) {</span>
<span class="lineNum">    6104 </span><span class="lineCov">          1 :                 e = gf_isom_set_copyright(file, &quot;und&quot;, cprt);</span>
<span class="lineNum">    6105 </span><span class="lineCov">          1 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6106 </span><span class="lineCov">          1 :                 if (e) goto err_exit;</span>
<span class="lineNum">    6107 </span>            :         }
<span class="lineNum">    6108 </span><span class="lineCov">        970 :         if (chap_file || chap_file_qt) {</span>
<span class="lineNum">    6109 </span>            : #ifndef GPAC_DISABLE_MEDIA_IMPORT
<span class="lineNum">    6110 </span>            :                 Bool chap_qt = GF_FALSE;
<span class="lineNum">    6111 </span><span class="lineNoCov">          0 :                 if (chap_file_qt) {</span>
<span class="lineNum">    6112 </span><span class="lineNoCov">          0 :                         chap_file = chap_file_qt;</span>
<span class="lineNum">    6113 </span>            :                         chap_qt = GF_TRUE;
<span class="lineNum">    6114 </span>            :                 }
<span class="lineNum">    6115 </span><span class="lineNoCov">          0 :                 e = gf_media_import_chapters(file, chap_file, import_fps, chap_qt);</span>
<span class="lineNum">    6116 </span><span class="lineNoCov">          0 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6117 </span>            : #else
<span class="lineNum">    6118 </span>            :                 M4_LOG(GF_LOG_WARNING, (&quot;Warning: GPAC compiled without Media Import, chapters can't be imported\n&quot;));
<span class="lineNum">    6119 </span>            :                 e = GF_NOT_SUPPORTED;
<span class="lineNum">    6120 </span>            : #endif
<span class="lineNum">    6121 </span><span class="lineNoCov">          0 :                 if (e) goto err_exit;</span>
<span class="lineNum">    6122 </span>            :         }
<span class="lineNum">    6123 </span>            : 
<span class="lineNum">    6124 </span><span class="lineCov">        970 :         if (major_brand) {</span>
<span class="lineNum">    6125 </span><span class="lineCov">          2 :                 gf_isom_set_brand_info(file, major_brand, minor_version);</span>
<span class="lineNum">    6126 </span><span class="lineCov">          2 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6127 </span>            :         }
<span class="lineNum">    6128 </span><span class="lineCov">         65 :         for (i=0; i&lt;nb_alt_brand_add; i++) {</span>
<span class="lineNum">    6129 </span><span class="lineCov">         65 :                 gf_isom_modify_alternate_brand(file, brand_add[i], GF_TRUE);</span>
<span class="lineNum">    6130 </span><span class="lineCov">         65 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6131 </span>            :         }
<span class="lineNum">    6132 </span><span class="lineCov">          2 :         for (i=0; i&lt;nb_alt_brand_rem; i++) {</span>
<span class="lineNum">    6133 </span><span class="lineCov">          2 :                 gf_isom_modify_alternate_brand(file, brand_rem[i], GF_FALSE);</span>
<span class="lineNum">    6134 </span><span class="lineCov">          2 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6135 </span>            :         }
<span class="lineNum">    6136 </span><span class="lineCov">        970 :         if (box_patch_filename) {</span>
<span class="lineNum">    6137 </span><span class="lineCov">          6 :                 e = gf_isom_apply_box_patch(file, box_patch_trackID, box_patch_filename, GF_FALSE);</span>
<span class="lineNum">    6138 </span><span class="lineCov">          6 :                 if (e) {</span>
<span class="lineNum">    6139 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Failed to apply box patch %s: %s\n&quot;, box_patch_filename, gf_error_to_string(e) ));</span>
<span class="lineNum">    6140 </span>            :                         goto err_exit;
<span class="lineNum">    6141 </span>            :                 }
<span class="lineNum">    6142 </span><span class="lineCov">          6 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6143 </span>            :         }
<span class="lineNum">    6144 </span>            : 
<span class="lineNum">    6145 </span>            : #ifndef GPAC_DISABLE_CRYPTO
<span class="lineNum">    6146 </span><span class="lineCov">        970 :         if (crypt) {</span>
<span class="lineNum">    6147 </span><span class="lineCov">        222 :                 if (!drm_file &amp;&amp; (crypt==1) ) {</span>
<span class="lineNum">    6148 </span><span class="lineNoCov">          0 :                         M4_LOG(GF_LOG_ERROR, (&quot;Missing DRM file location - usage '-%s drm_file input_file\n&quot;, (crypt==1) ? &quot;crypt&quot; : &quot;decrypt&quot;));</span>
<span class="lineNum">    6149 </span>            :                         e = GF_BAD_PARAM;
<span class="lineNum">    6150 </span>            :                         goto err_exit;
<span class="lineNum">    6151 </span>            :                 }
<span class="lineNum">    6152 </span><span class="lineCov">        222 :                 if (crypt == 1) {</span>
<span class="lineNum">    6153 </span><span class="lineCov">        115 :                         if (use_init_seg) {</span>
<span class="lineNum">    6154 </span><span class="lineCov">          2 :                                 e = gf_crypt_fragment(file, drm_file, outfile, inName, fs_dump_flags);</span>
<span class="lineNum">    6155 </span>            :                         } else {
<span class="lineNum">    6156 </span><span class="lineCov">        113 :                                 e = gf_crypt_file(file, drm_file, outfile, interleaving_time, fs_dump_flags);</span>
<span class="lineNum">    6157 </span>            :                         }
<span class="lineNum">    6158 </span><span class="lineCov">        107 :                 } else if (crypt ==2) {</span>
<span class="lineNum">    6159 </span><span class="lineCov">        107 :                         if (use_init_seg) {</span>
<span class="lineNum">    6160 </span><span class="lineCov">          1 :                                 e = gf_decrypt_fragment(file, drm_file, outfile, inName, fs_dump_flags);</span>
<span class="lineNum">    6161 </span>            :                         } else {
<span class="lineNum">    6162 </span><span class="lineCov">        106 :                                 e = gf_decrypt_file(file, drm_file, outfile, interleaving_time, fs_dump_flags);</span>
<span class="lineNum">    6163 </span>            :                         }
<span class="lineNum">    6164 </span>            :                 }
<span class="lineNum">    6165 </span><span class="lineCov">        222 :                 if (e) goto err_exit;</span>
<span class="lineNum">    6166 </span><span class="lineCov">        222 :                 do_save = outName ? GF_FALSE : GF_TRUE;</span>
<span class="lineNum">    6167 </span>            : 
<span class="lineNum">    6168 </span><span class="lineCov">        222 :                 if (!do_frag &amp;&amp; !do_hint &amp;&amp; !full_interleave &amp;&amp; !force_co64) {</span>
<span class="lineNum">    6169 </span>            :                         char szName[GF_MAX_PATH];
<span class="lineNum">    6170 </span><span class="lineCov">        222 :                         strcpy(szName, gf_isom_get_filename(file) );</span>
<span class="lineNum">    6171 </span><span class="lineCov">        222 :                         gf_isom_delete(file);</span>
<span class="lineNum">    6172 </span><span class="lineCov">        222 :                         file = NULL;</span>
<span class="lineNum">    6173 </span><span class="lineCov">        222 :                         if (!outName) {</span>
<span class="lineNum">    6174 </span><span class="lineCov">         12 :                                 e = gf_file_move(outfile, szName);</span>
<span class="lineNum">    6175 </span><span class="lineCov">         12 :                                 if (e) goto err_exit;</span>
<span class="lineNum">    6176 </span>            :                         }
<span class="lineNum">    6177 </span><span class="lineCov">        222 :                         goto exit;</span>
<span class="lineNum">    6178 </span>            :                 }
<span class="lineNum">    6179 </span>            :         }
<span class="lineNum">    6180 </span>            : #endif /*GPAC_DISABLE_CRYPTO*/
<span class="lineNum">    6181 </span>            : 
<span class="lineNum">    6182 </span>            : #ifndef GPAC_DISABLE_ISOM_FRAGMENTS
<span class="lineNum">    6183 </span><span class="lineCov">        748 :         if (do_frag) {</span>
<span class="lineNum">    6184 </span><span class="lineCov">          4 :                 if (!interleaving_time) interleaving_time = DEFAULT_INTERLEAVING_IN_SEC;</span>
<span class="lineNum">    6185 </span><span class="lineCov">          4 :                 if (do_hint) M4_LOG(GF_LOG_WARNING, (&quot;Warning: cannot hint and fragment - ignoring hint\n&quot;));</span>
<span class="lineNum">    6186 </span><span class="lineCov">          4 :                 M4_LOG(GF_LOG_INFO, (&quot;Fragmenting file (%.3f seconds fragments)\n&quot;, interleaving_time));</span>
<span class="lineNum">    6187 </span><span class="lineCov">          4 :                 e = gf_media_fragment_file(file, outfile, interleaving_time, use_mfra);</span>
<span class="lineNum">    6188 </span><span class="lineCov">          4 :                 if (e) M4_LOG(GF_LOG_ERROR, (&quot;Error while fragmenting file: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    6189 </span><span class="lineCov">          4 :                 if (!e &amp;&amp; !outName) {</span>
<span class="lineNum">    6190 </span><span class="lineCov">          1 :                         if (gf_file_exists(inName) &amp;&amp; gf_file_delete(inName)) {</span>
<span class="lineNum">    6191 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_INFO, (&quot;Error removing file %s\n&quot;, inName));</span>
<span class="lineNum">    6192 </span>            :                         }
<span class="lineNum">    6193 </span><span class="lineCov">          1 :                         else if (gf_file_move(outfile, inName)) {</span>
<span class="lineNum">    6194 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_INFO, (&quot;Error renaming file %s to %s\n&quot;, outfile, inName));</span>
<span class="lineNum">    6195 </span>            :                         }
<span class="lineNum">    6196 </span>            :                 }
<span class="lineNum">    6197 </span><span class="lineCov">          4 :                 if (e) goto err_exit;</span>
<span class="lineNum">    6198 </span><span class="lineCov">          4 :                 gf_isom_delete(file);</span>
<span class="lineNum">    6199 </span><span class="lineCov">          4 :                 goto exit;</span>
<span class="lineNum">    6200 </span>            :         }
<span class="lineNum">    6201 </span>            : #endif
<span class="lineNum">    6202 </span>            : 
<span class="lineNum">    6203 </span>            : #ifndef GPAC_DISABLE_ISOM_HINTING
<span class="lineNum">    6204 </span><span class="lineCov">        744 :         if (do_hint) {</span>
<span class="lineNum">    6205 </span><span class="lineCov">         56 :                 if (force_ocr) SetupClockReferences(file);</span>
<span class="lineNum">    6206 </span><span class="lineCov">         56 :                 MTUSize -= 12;</span>
<span class="lineNum">    6207 </span><span class="lineCov">         56 :                 e = HintFile(file, MTUSize, max_ptime, rtp_rate, hint_flags, HintCopy, hint_interleave, regular_iod, single_group, hint_no_offset);</span>
<span class="lineNum">    6208 </span><span class="lineCov">         56 :                 if (e) goto err_exit;</span>
<span class="lineNum">    6209 </span><span class="lineCov">         55 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6210 </span><span class="lineCov">         55 :                 if (print_sdp) dump_isom_sdp(file, dump_std ? NULL : (outName ? outName : outfile), outName ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    6211 </span>            :         }
<span class="lineNum">    6212 </span>            : #endif
<span class="lineNum">    6213 </span>            : 
<span class="lineNum">    6214 </span>            : #if !defined(GPAC_DISABLE_ISOM_HINTING) &amp;&amp; !defined(GPAC_DISABLE_SENG)
<span class="lineNum">    6215 </span><span class="lineCov">        743 :         set_sdp_ext();</span>
<span class="lineNum">    6216 </span>            : #endif /*!defined(GPAC_DISABLE_ISOM_HINTING) &amp;&amp; !defined(GPAC_DISABLE_SENG)*/
<span class="lineNum">    6217 </span>            : 
<span class="lineNum">    6218 </span><span class="lineCov">        743 :         if (force_co64)</span>
<span class="lineNum">    6219 </span><span class="lineCov">          1 :                 gf_isom_force_64bit_chunk_offset(file, GF_TRUE);</span>
<span class="lineNum">    6220 </span>            : 
<span class="lineNum">    6221 </span><span class="lineCov">        743 :         if (compress_moov)</span>
<span class="lineNum">    6222 </span><span class="lineNoCov">          0 :                 gf_isom_enable_compression(file, GF_ISOM_COMP_ALL, (compress_moov==2) ? GF_ISOM_COMP_WRAP_FTYPE : 0);</span>
<span class="lineNum">    6223 </span>            : 
<span class="lineNum">    6224 </span><span class="lineCov">        743 :         if (no_inplace)</span>
<span class="lineNum">    6225 </span><span class="lineCov">          8 :                 gf_isom_disable_inplace_rewrite(file);</span>
<span class="lineNum">    6226 </span>            : 
<span class="lineNum">    6227 </span><span class="lineCov">        743 :         if (moov_pading)</span>
<span class="lineNum">    6228 </span><span class="lineNoCov">          0 :                 gf_isom_set_inplace_padding(file, moov_pading);</span>
<span class="lineNum">    6229 </span>            : 
<span class="lineNum">    6230 </span><span class="lineCov">        743 :         if (outName) {</span>
<span class="lineNum">    6231 </span><span class="lineCov">        175 :                 gf_isom_set_final_name(file, outfile);</span>
<span class="lineNum">    6232 </span><span class="lineCov">        568 :         } else if (!encode &amp;&amp; !force_new &amp;&amp; !gf_isom_is_inplace_rewrite(file)) {</span>
<span class="lineNum">    6233 </span><span class="lineCov">         47 :                 gf_isom_set_final_name(file, outfile);</span>
<span class="lineNum">    6234 </span>            :         }
<span class="lineNum">    6235 </span>            : 
<span class="lineNum">    6236 </span><span class="lineCov">        743 :         Bool is_inplace = gf_isom_is_inplace_rewrite(file);</span>
<span class="lineNum">    6237 </span>            : 
<span class="lineNum">    6238 </span>            : 
<span class="lineNum">    6239 </span>            :         /*full interleave (sample-based) if just hinted*/
<span class="lineNum">    6240 </span><span class="lineCov">        743 :         if (full_interleave) {</span>
<span class="lineNum">    6241 </span><span class="lineCov">          1 :                 e = gf_isom_set_storage_mode(file, GF_ISOM_STORE_TIGHT);</span>
<span class="lineNum">    6242 </span><span class="lineCov">        742 :         } else if (do_flat) {</span>
<span class="lineNum">    6243 </span><span class="lineCov">          5 :                 e = gf_isom_set_storage_mode(file, (do_flat==1) ? GF_ISOM_STORE_FLAT : GF_ISOM_STORE_STREAMABLE);</span>
<span class="lineNum">    6244 </span><span class="lineCov">          5 :                 do_save = GF_TRUE;</span>
<span class="lineNum">    6245 </span>            :         }
<span class="lineNum">    6246 </span>            :         //do not set storage mode unless inplace rewrite is disabled , either by user or due to operations on file
<span class="lineNum">    6247 </span><span class="lineCov">        737 :         else if (!is_inplace) {</span>
<span class="lineNum">    6248 </span><span class="lineCov">        674 :                 e = gf_isom_make_interleave(file, interleaving_time);</span>
<span class="lineNum">    6249 </span><span class="lineCov">        674 :                 if (!e &amp;&amp; old_interleave) e = gf_isom_set_storage_mode(file, GF_ISOM_STORE_INTERLEAVED);</span>
<span class="lineNum">    6250 </span>            :         }
<span class="lineNum">    6251 </span>            : 
<span class="lineNum">    6252 </span><span class="lineCov">        743 :         if (e) goto err_exit;</span>
<span class="lineNum">    6253 </span>            : 
<span class="lineNum">    6254 </span>            : 
<span class="lineNum">    6255 </span><span class="lineCov">        743 :         if (do_save) {</span>
<span class="lineNum">    6256 </span>            : 
<span class="lineNum">    6257 </span><span class="lineCov">        736 :                 if (!gf_sys_is_quiet()) {</span>
<span class="lineNum">    6258 </span><span class="lineCov">          1 :                         if (outName) {</span>
<span class="lineNum">    6259 </span><span class="lineCov">          1 :                         } else if (encode || pack_file) {</span>
<span class="lineNum">    6260 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_INFO, (&quot;Saving to %s: &quot;, gf_isom_get_filename(file) ));</span>
<span class="lineNum">    6261 </span>            :                         } else {
<span class="lineNum">    6262 </span><span class="lineCov">          1 :                                 M4_LOG(GF_LOG_INFO, (&quot;Saving %s: &quot;, inName));</span>
<span class="lineNum">    6263 </span>            :                         }
<span class="lineNum">    6264 </span><span class="lineCov">          1 :                         if (is_inplace) {</span>
<span class="lineNum">    6265 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_INFO, (&quot;In-place rewrite\n&quot;));</span>
<span class="lineNum">    6266 </span><span class="lineCov">          1 :                         } else if (do_hint &amp;&amp; full_interleave) {</span>
<span class="lineNum">    6267 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_INFO, (&quot;Hinted file - Full Interleaving\n&quot;));</span>
<span class="lineNum">    6268 </span><span class="lineCov">          1 :                         } else if (full_interleave) {</span>
<span class="lineNum">    6269 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_INFO, (&quot;Full Interleaving\n&quot;));</span>
<span class="lineNum">    6270 </span><span class="lineCov">          1 :                         } else if ((force_new==2) &amp;&amp; interleaving_time) {</span>
<span class="lineNum">    6271 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_INFO, (&quot;Fast-start interleaved storage\n&quot;));</span>
<span class="lineNum">    6272 </span><span class="lineCov">          1 :                         } else if (do_flat || !interleaving_time) {</span>
<span class="lineNum">    6273 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_INFO, (&quot;Flat storage\n&quot;));</span>
<span class="lineNum">    6274 </span>            :                         } else {
<span class="lineNum">    6275 </span><span class="lineCov">          1 :                                 M4_LOG(GF_LOG_INFO, (&quot;%.3f secs Interleaving%s\n&quot;, interleaving_time, old_interleave ? &quot; - no drift control&quot; : &quot;&quot;));</span>
<span class="lineNum">    6276 </span>            :                         }
<span class="lineNum">    6277 </span>            :                 }
<span class="lineNum">    6278 </span>            : 
<span class="lineNum">    6279 </span><span class="lineCov">        736 :                 e = gf_isom_close(file);</span>
<span class="lineNum">    6280 </span><span class="lineCov">        736 :                 file = NULL;</span>
<span class="lineNum">    6281 </span>            : 
<span class="lineNum">    6282 </span><span class="lineCov">        736 :                 if (!e &amp;&amp; !outName &amp;&amp; !encode &amp;&amp; !force_new &amp;&amp; !pack_file &amp;&amp; !is_inplace) {</span>
<span class="lineNum">    6283 </span><span class="lineCov">         47 :                         if (gf_file_exists(inName)) {</span>
<span class="lineNum">    6284 </span><span class="lineCov">         47 :                                 e = gf_file_delete(inName);</span>
<span class="lineNum">    6285 </span><span class="lineCov">         47 :                                 if (e) {</span>
<span class="lineNum">    6286 </span><span class="lineNoCov">          0 :                                         M4_LOG(GF_LOG_ERROR, (&quot;Error removing file %s\n&quot;, inName));</span>
<span class="lineNum">    6287 </span>            :                                 }
<span class="lineNum">    6288 </span>            :                         }
<span class="lineNum">    6289 </span>            : 
<span class="lineNum">    6290 </span><span class="lineCov">         47 :                         e = gf_file_move(outfile, inName);</span>
<span class="lineNum">    6291 </span><span class="lineCov">         47 :                         if (e) {</span>
<span class="lineNum">    6292 </span><span class="lineNoCov">          0 :                                 M4_LOG(GF_LOG_ERROR, (&quot;Error renaming file %s to %s\n&quot;, outfile, inName));</span>
<span class="lineNum">    6293 </span>            :                         }
<span class="lineNum">    6294 </span>            :                 }
<span class="lineNum">    6295 </span>            :         } else {
<span class="lineNum">    6296 </span><span class="lineCov">          7 :                 gf_isom_delete(file);</span>
<span class="lineNum">    6297 </span>            :         }
<span class="lineNum">    6298 </span>            : 
<span class="lineNum">    6299 </span><span class="lineCov">        743 :         if (e) {</span>
<span class="lineNum">    6300 </span><span class="lineNoCov">          0 :                 M4_LOG(GF_LOG_ERROR, (&quot;Error: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    6301 </span>            :                 goto err_exit;
<span class="lineNum">    6302 </span>            :         }
<span class="lineNum">    6303 </span>            :         goto exit;
<span class="lineNum">    6304 </span>            : 
<span class="lineNum">    6305 </span>            : #else
<span class="lineNum">    6306 </span>            :         /*close libgpac*/
<span class="lineNum">    6307 </span>            :         gf_isom_delete(file);
<span class="lineNum">    6308 </span>            :         M4_LOG(GF_LOG_ERROR, (&quot;Error: Read-only version of MP4Box.\n&quot;));
<span class="lineNum">    6309 </span>            :         return mp4box_cleanup(1);
<span class="lineNum">    6310 </span>            : #endif //GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    6311 </span>            : 
<span class="lineNum">    6312 </span>            : 
<span class="lineNum">    6313 </span><span class="lineCov">         24 : err_exit:</span>
<span class="lineNum">    6314 </span>            :         /*close libgpac*/
<span class="lineNum">    6315 </span><span class="lineCov">         12 :         if (file) gf_isom_delete(file);</span>
<span class="lineNum">    6316 </span><span class="lineCov">         12 :         M4_LOG(GF_LOG_ERROR, (&quot;\n\tError: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    6317 </span><span class="lineCov">         12 :         return mp4box_cleanup(1);</span>
<span class="lineNum">    6318 </span>            : 
<span class="lineNum">    6319 </span><span class="lineCov">       4412 : exit:</span>
<span class="lineNum">    6320 </span><span class="lineCov">       4412 :         mp4box_cleanup(0);</span>
<span class="lineNum">    6321 </span>            : 
<span class="lineNum">    6322 </span>            : #ifdef GPAC_MEMORY_TRACKING
<span class="lineNum">    6323 </span><span class="lineCov">       4412 :         if (mem_track &amp;&amp; (gf_memory_size() || gf_file_handles_count() )) {</span>
<span class="lineNum">    6324 </span><span class="lineNoCov">          0 :                 gf_log_set_tool_level(GF_LOG_MEMORY, GF_LOG_INFO);</span>
<span class="lineNum">    6325 </span><span class="lineNoCov">          0 :                 gf_memory_print();</span>
<span class="lineNum">    6326 </span><span class="lineNoCov">          0 :                 return 2;</span>
<span class="lineNum">    6327 </span>            :         }
<span class="lineNum">    6328 </span>            : #endif
<span class="lineNum">    6329 </span>            :         return 0;
<span class="lineNum">    6330 </span>            : }
<a name="6331"><span class="lineNum">    6331 </span>            : </a>
<span class="lineNum">    6332 </span>            : 
<span class="lineNum">    6333 </span><span class="lineCov">       4485 : GF_MAIN_FUNC(mp4boxMain)</span>
<span class="lineNum">    6334 </span>            : 
<span class="lineNum">    6335 </span>            : 
<span class="lineNum">    6336 </span>            : #endif /*GPAC_DISABLE_ISOM*/
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - evg/raster3d.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">evg</a> - raster3d.c<span style="font-size: 80%;"> (source / <a href="raster3d.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">597</td>
            <td class="headerCovTableEntry">750</td>
            <td class="headerCovTableEntryMed">79.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">39</td>
            <td class="headerCovTableEntry">39</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            : *                       GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            : *
<span class="lineNum">       4 </span>            : *                       Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            : *                       Copyright (c) Telecom ParisTech 2019
<span class="lineNum">       6 </span>            : *                                       All rights reserved
<span class="lineNum">       7 </span>            : *
<span class="lineNum">       8 </span>            : *  This file is part of GPAC / software 3D rasterizer module
<span class="lineNum">       9 </span>            : *
<span class="lineNum">      10 </span>            : *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            : *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            : *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            : *  any later version.
<span class="lineNum">      14 </span>            : *
<span class="lineNum">      15 </span>            : *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            : *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            : *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            : *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            : *
<span class="lineNum">      20 </span>            : *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            : *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            : *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            : *
<span class="lineNum">      24 </span>            : *
<span class="lineNum">      25 </span>            : */
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : #include &quot;rast_soft.h&quot;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : #if defined(WIN32) &amp;&amp; !defined(__GNUC__)
<span class="lineNum">      32 </span>            : # include &lt;intrin.h&gt;
<span class="lineNum">      33 </span>            : # define GPAC_HAS_SSE2
<span class="lineNum">      34 </span>            : #else
<span class="lineNum">      35 </span>            : # ifdef __SSE2__
<span class="lineNum">      36 </span>            : #  include &lt;emmintrin.h&gt;
<span class="lineNum">      37 </span>            : #  define GPAC_HAS_SSE2
<span class="lineNum">      38 </span>            : # endif
<span class="lineNum">      39 </span>            : #endif
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : #ifdef GPAC_HAS_SSE2
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : static Float float_clamp(Float val, Float minval, Float maxval)
<span class="lineNum">      44 </span>            : {
<span class="lineNum">      45 </span>            :     _mm_store_ss( &amp;val, _mm_min_ss( _mm_max_ss(_mm_set_ss(val),_mm_set_ss(minval)), _mm_set_ss(maxval) ) );
<span class="lineNum">      46 </span>            :     return val;
<span class="lineNum">      47 </span>            : }
<span class="lineNum">      48 </span>            : #else
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span>            : #define float_clamp(_val, _minval, _maxval)\
<span class="lineNum">      51 </span>            :         (_val&lt;_minval) ? _minval : (_val&gt;_maxval) ? _maxval : _val;
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : #endif
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : static GFINLINE Bool evg3d_persp_divide(GF_Vec4 *pt)
<span class="lineNum">      58 </span>            : {
<span class="lineNum">      59 </span>            :         //perspective divide
<span class="lineNum">      60 </span><span class="lineCov">      49741 :         if (!pt-&gt;q) return GF_FALSE;</span>
<span class="lineNum">      61 </span><span class="lineCov">      49741 :         pt-&gt;q = gf_divfix(FIX_ONE, pt-&gt;q);</span>
<span class="lineNum">      62 </span><span class="lineCov">      49741 :         pt-&gt;x = gf_mulfix(pt-&gt;x, pt-&gt;q);</span>
<span class="lineNum">      63 </span><span class="lineCov">      49741 :         pt-&gt;y = gf_mulfix(pt-&gt;y, pt-&gt;q);</span>
<span class="lineNum">      64 </span><span class="lineCov">      49741 :         pt-&gt;z = gf_mulfix(pt-&gt;z, pt-&gt;q);</span>
<span class="lineNum">      65 </span>            :         return GF_TRUE;
<span class="lineNum">      66 </span>            : }
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            : static GFINLINE void evg_ndc_to_raster(GF_EVGSurface *surf, GF_Vec4 *pt, TPos *x, TPos *y)
<span class="lineNum">      69 </span>            : {
<span class="lineNum">      70 </span>            :         //from [-1, 1] to [0,2] to [0,1] to [0,vp_width] to [vp left, vp right]
<span class="lineNum">      71 </span><span class="lineCov">          5 :         pt-&gt;x = (pt-&gt;x + FIX_ONE) / 2 * surf-&gt;width;</span>
<span class="lineNum">      72 </span>            :         //idem but flip Y
<span class="lineNum">      73 </span><span class="lineCov">          5 :         pt-&gt;y = (FIX_ONE - (pt-&gt;y + FIX_ONE)/2) * surf-&gt;height;</span>
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span>            :         //move Z from [-1, 1] to [min_depth, max_depth]
<span class="lineNum">      76 </span><span class="lineCov">          5 :         pt-&gt;z += FIX_ONE;</span>
<span class="lineNum">      77 </span><span class="lineCov">          5 :         pt-&gt;z /= 2;</span>
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span>            : #ifdef GPAC_FIXED_POINT
<span class="lineNum">      80 </span>            :         *x = UPSCALE(pt-&gt;x);
<span class="lineNum">      81 </span>            :         *y = UPSCALE(pt-&gt;y);
<span class="lineNum">      82 </span>            : #else
<span class="lineNum">      83 </span><span class="lineCov">          5 :         *x = (s32) (pt-&gt;x * ONE_PIXEL);</span>
<span class="lineNum">      84 </span><span class="lineCov">          5 :         *y = (s32) (pt-&gt;y * ONE_PIXEL);</span>
<a name="85"><span class="lineNum">      85 </span>            : #endif</a>
<span class="lineNum">      86 </span>            : }
<span class="lineNum">      87 </span><span class="lineCov">      49736 : static GFINLINE void evg3d_ndc_to_raster(GF_EVGSurface *surf, GF_Vec4 *pt, TPos *x, TPos *y)</span>
<span class="lineNum">      88 </span>            : {
<span class="lineNum">      89 </span>            :         //from [-1, 1] to [0,2] to [0,1] to [0,vp_width] to [vp left, vp right]
<span class="lineNum">      90 </span><span class="lineCov">      49736 :         pt-&gt;x = (pt-&gt;x + FIX_ONE) / 2 * surf-&gt;ext3d-&gt;vp_w + surf-&gt;ext3d-&gt;vp_x;</span>
<span class="lineNum">      91 </span>            :         //idem but flip Y
<span class="lineNum">      92 </span><span class="lineCov">      49736 :         pt-&gt;y = (FIX_ONE - (pt-&gt;y + FIX_ONE)/2) * surf-&gt;ext3d-&gt;vp_h + surf-&gt;ext3d-&gt;vp_y;</span>
<span class="lineNum">      93 </span>            :         /*compute depth*/
<span class="lineNum">      94 </span><span class="lineCov">      49736 :         if (!surf-&gt;ext3d-&gt;clip_zero) {</span>
<span class="lineNum">      95 </span>            :                 //move Z from [-1, 1] to [min_depth, max_depth]
<span class="lineNum">      96 </span><span class="lineCov">       3636 :                 pt-&gt;z += FIX_ONE;</span>
<span class="lineNum">      97 </span><span class="lineCov">       3636 :                 pt-&gt;z /= 2;</span>
<span class="lineNum">      98 </span>            :         }
<span class="lineNum">      99 </span><span class="lineCov">      49736 :         pt-&gt;z = surf-&gt;ext3d-&gt;min_depth + pt-&gt;z * surf-&gt;ext3d-&gt;depth_range;</span>
<span class="lineNum">     100 </span>            : 
<span class="lineNum">     101 </span>            : #ifdef GPAC_FIXED_POINT
<span class="lineNum">     102 </span>            :         *x = UPSCALE(pt-&gt;x);
<span class="lineNum">     103 </span>            :         *y = UPSCALE(pt-&gt;y);
<span class="lineNum">     104 </span>            : #else
<span class="lineNum">     105 </span><span class="lineCov">      49736 :         *x = (s32) (pt-&gt;x * ONE_PIXEL);</span>
<span class="lineNum">     106 </span><span class="lineCov">      49736 :         *y = (s32) (pt-&gt;y * ONE_PIXEL);</span>
<span class="lineNum">     107 </span>            : #endif
<a name="108"><span class="lineNum">     108 </span><span class="lineCov">      49736 : }</span></a>
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span><span class="lineCov">       2703 : static GFINLINE int gray3d_move_to(EVG_Raster raster, TPos x, TPos y)</span>
<span class="lineNum">     111 </span>            : {
<span class="lineNum">     112 </span>            :         TCoord  ex, ey;
<span class="lineNum">     113 </span>            : 
<span class="lineNum">     114 </span>            :         /* record current cell, if any */
<span class="lineNum">     115 </span><span class="lineCov">       2703 :         gray_record_cell(raster);</span>
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span><span class="lineCov">       2703 :         ex = TRUNC(x);</span>
<span class="lineNum">     118 </span><span class="lineCov">       2703 :         ey = TRUNC(y);</span>
<span class="lineNum">     119 </span><span class="lineCov">       2703 :         if ( ex &lt; raster-&gt;min_ex ) ex = (TCoord)(raster-&gt;min_ex - 1);</span>
<span class="lineNum">     120 </span><span class="lineCov">       2703 :         raster-&gt;area    = 0;</span>
<span class="lineNum">     121 </span><span class="lineCov">       2703 :         raster-&gt;cover   = 0;</span>
<span class="lineNum">     122 </span><span class="lineCov">       2703 :         gray_set_cell( raster, ex, ey );</span>
<span class="lineNum">     123 </span><span class="lineCov">       2703 :         if (ey&lt;0) ey=0;</span>
<span class="lineNum">     124 </span><span class="lineCov">       2703 :         raster-&gt;last_ey = SUBPIXELS( ey );</span>
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span><span class="lineCov">       2703 :         raster-&gt;x = x;</span>
<span class="lineNum">     127 </span><span class="lineCov">       2703 :         raster-&gt;y = y;</span>
<span class="lineNum">     128 </span><span class="lineCov">       2703 :         return 0;</span>
<a name="129"><span class="lineNum">     129 </span>            : }</a>
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span><span class="lineCov">          1 : GF_Err evg_raster_render_path_3d(GF_EVGSurface *surf)</span>
<span class="lineNum">     132 </span>            : {
<span class="lineNum">     133 </span>            :         EVG_Vector   v_start;
<span class="lineNum">     134 </span>            :         int   n;         /* index of contour in outline     */
<span class="lineNum">     135 </span>            :         int   first;     /* index of first point in contour */
<span class="lineNum">     136 </span>            :         TPos _x, _y, _sx, _sy;
<span class="lineNum">     137 </span>            :         GF_Vec dir;
<span class="lineNum">     138 </span>            :         u32 li, size_y;
<span class="lineNum">     139 </span><span class="lineCov">          1 :         EVG_Raster raster = surf-&gt;raster;</span>
<span class="lineNum">     140 </span>            :         EVG_Outline *outline = &amp;surf-&gt;ftoutline;
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span><span class="lineCov">          1 :         raster-&gt;render_span  = (EVG_Raster_Span_Func) surf-&gt;gray_spans;</span>
<span class="lineNum">     143 </span><span class="lineCov">          1 :         raster-&gt;render_span_data = surf;</span>
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span>            :         /* Set up state in the raster object */
<span class="lineNum">     146 </span><span class="lineCov">          1 :         raster-&gt;min_ex = surf-&gt;clip_xMin;</span>
<span class="lineNum">     147 </span><span class="lineCov">          1 :         raster-&gt;min_ey = surf-&gt;clip_yMin;</span>
<span class="lineNum">     148 </span><span class="lineCov">          1 :         raster-&gt;max_ex = surf-&gt;clip_xMax;</span>
<span class="lineNum">     149 </span><span class="lineCov">          1 :         raster-&gt;max_ey = surf-&gt;clip_yMax;</span>
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span><span class="lineCov">          1 :         size_y = (u32) (raster-&gt;max_ey - raster-&gt;min_ey);</span>
<span class="lineNum">     153 </span><span class="lineCov">          1 :         if ((u32) raster-&gt;max_lines &lt; size_y) {</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :                 raster-&gt;scanlines = (AAScanline*)gf_realloc(raster-&gt;scanlines, sizeof(AAScanline)*size_y);</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :                 memset(&amp;raster-&gt;scanlines[raster-&gt;max_lines], 0, sizeof(AAScanline)*(size_y-raster-&gt;max_lines) );</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :                 raster-&gt;max_lines = size_y;</span>
<span class="lineNum">     157 </span>            :         }
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineCov">          1 :         raster-&gt;ex = (int) (raster-&gt;max_ex+1);</span>
<span class="lineNum">     160 </span><span class="lineCov">          1 :         raster-&gt;ey = (int) (raster-&gt;max_ey+1);</span>
<span class="lineNum">     161 </span><span class="lineCov">          1 :         raster-&gt;cover = 0;</span>
<span class="lineNum">     162 </span><span class="lineCov">          1 :         raster-&gt;area = 0;</span>
<span class="lineNum">     163 </span><span class="lineCov">          1 :         raster-&gt;first_scanline = raster-&gt;max_ey;</span>
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span>            :         dir.x = dir.y = 0;
<span class="lineNum">     166 </span>            :         dir.z = -FIX_ONE;
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span>            :         first = 0;
<span class="lineNum">     169 </span><span class="lineCov">          2 :         for ( n = 0; n &lt; outline-&gt;n_contours; n++ ) {</span>
<span class="lineNum">     170 </span>            :                 GF_Vec4 pt;
<span class="lineNum">     171 </span>            :                 EVG_Vector *point;
<span class="lineNum">     172 </span>            :                 EVG_Vector *limit;
<span class="lineNum">     173 </span>            :                 int  last;  /* index of last point in contour */
<span class="lineNum">     174 </span><span class="lineCov">          1 :                 last  = outline-&gt;contours[n];</span>
<span class="lineNum">     175 </span><span class="lineCov">          1 :                 limit = outline-&gt;points + last;</span>
<span class="lineNum">     176 </span><span class="lineCov">          1 :                 v_start = outline-&gt;points[first];</span>
<span class="lineNum">     177 </span>            :                 point = outline-&gt;points + first;
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineCov">          1 :                 pt.x = v_start.x;</span>
<span class="lineNum">     180 </span><span class="lineCov">          1 :                 pt.y = v_start.y;</span>
<span class="lineNum">     181 </span><span class="lineCov">          1 :                 pt.z = 0;</span>
<span class="lineNum">     182 </span><span class="lineCov">          1 :                 pt.q = 1;</span>
<span class="lineNum">     183 </span><span class="lineCov">          1 :                 gf_mx_apply_vec_4x4(&amp;surf-&gt;mx3d, &amp;pt);</span>
<span class="lineNum">     184 </span>            :                 if (!evg3d_persp_divide(&amp;pt)) {
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     186 </span>            :                 }
<span class="lineNum">     187 </span><span class="lineCov">          1 :                 evg_ndc_to_raster(surf, &amp;pt, &amp;_sx, &amp;_sy);</span>
<span class="lineNum">     188 </span><span class="lineCov">          1 :                 gray3d_move_to(raster, _sx, _sy);</span>
<span class="lineNum">     189 </span><span class="lineCov">          6 :                 while ( point &lt; limit ) {</span>
<span class="lineNum">     190 </span><span class="lineCov">          4 :                         point++;</span>
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span><span class="lineCov">          4 :                         pt.x = point-&gt;x;</span>
<span class="lineNum">     193 </span><span class="lineCov">          4 :                         pt.y = point-&gt;y;</span>
<span class="lineNum">     194 </span><span class="lineCov">          4 :                         pt.z = 0;</span>
<span class="lineNum">     195 </span><span class="lineCov">          4 :                         pt.q = 1;</span>
<span class="lineNum">     196 </span><span class="lineCov">          4 :                         gf_mx_apply_vec_4x4(&amp;surf-&gt;mx3d, &amp;pt);</span>
<span class="lineNum">     197 </span>            :                         if (!evg3d_persp_divide(&amp;pt)) {
<span class="lineNum">     198 </span>            :                                 break;
<span class="lineNum">     199 </span>            :                         }
<span class="lineNum">     200 </span><span class="lineCov">          4 :                         evg_ndc_to_raster(surf, &amp;pt, &amp;_x, &amp;_y);</span>
<span class="lineNum">     201 </span><span class="lineCov">          4 :                         gray_render_line(raster, _x, _y);</span>
<span class="lineNum">     202 </span>            :                 }
<span class="lineNum">     203 </span><span class="lineCov">          1 :                 gray_render_line(raster, _sx, _sy);</span>
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span><span class="lineCov">          1 :                 first = last + 1;</span>
<span class="lineNum">     206 </span>            :         }
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span><span class="lineCov">          1 :         gray_record_cell( raster );</span>
<span class="lineNum">     209 </span>            :         /* sort each scanline and render it*/
<span class="lineNum">     210 </span><span class="lineCov">         17 :         for (li=raster-&gt;first_scanline; li&lt;size_y; li++) {</span>
<span class="lineNum">     211 </span><span class="lineCov">         16 :                 AAScanline *sl = &amp;raster-&gt;scanlines[li];</span>
<span class="lineNum">     212 </span><span class="lineCov">         16 :                 if (sl-&gt;num) {</span>
<span class="lineNum">     213 </span><span class="lineCov">         16 :                         if (sl-&gt;num&gt;1) gray_quick_sort(sl-&gt;cells, sl-&gt;num);</span>
<span class="lineNum">     214 </span><span class="lineCov">         16 :                         gray_sweep_line(raster, sl, li, GF_TRUE);</span>
<span class="lineNum">     215 </span>            :                 }
<span class="lineNum">     216 </span>            :         }
<span class="lineNum">     217 </span><span class="lineCov">          1 :         return GF_OK;</span>
<span class="lineNum">     218 </span>            : }
<a name="219"><span class="lineNum">     219 </span>            : </a>
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span><span class="lineCov">    4812826 : Bool evg3d_get_fragment(GF_EVGSurface *surf, GF_EVGFragmentParam *frag_param, Bool *is_transparent)</span>
<span class="lineNum">     222 </span>            : {
<span class="lineNum">     223 </span><span class="lineCov">    4812826 :         surf-&gt;fill_col = 0;</span>
<span class="lineNum">     224 </span><span class="lineCov">    4812826 :         surf-&gt;fill_col_wide = 0;</span>
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span><span class="lineCov">    4812826 :         if (!surf-&gt;ext3d-&gt;frag_shader(surf-&gt;ext3d-&gt;frag_shader_udta, frag_param))</span>
<span class="lineNum">     227 </span>            :                 return GF_FALSE;
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span>            : #if 0
<span class="lineNum">     230 </span>            :         frag_param-&gt;color.x = float_clamp(frag_param-&gt;color.x, 0.0, 1.0);
<span class="lineNum">     231 </span>            :         frag_param-&gt;color.y = float_clamp(frag_param-&gt;color.y, 0.0, 1.0);
<span class="lineNum">     232 </span>            :         frag_param-&gt;color.z = float_clamp(frag_param-&gt;color.z, 0.0, 1.0);
<span class="lineNum">     233 </span>            :         frag_param-&gt;color.q = float_clamp(frag_param-&gt;color.q, 0.0, 1.0);
<span class="lineNum">     234 </span>            : #endif
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span><span class="lineCov">    4812826 :         if (frag_param-&gt;color.q&lt;1.0) *is_transparent = GF_TRUE;</span>
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span><span class="lineCov">    4812826 :         if (surf-&gt;not_8bits) {</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :                 surf-&gt;fill_col_wide = evg_make_col_wide((u16) frag_param-&gt;color.q*0xFFFF, (u16) frag_param-&gt;color.x*0xFFFF, (u16) frag_param-&gt;color.y*0xFFFF, (u16) frag_param-&gt;color.z*0xFFFF);</span>
<span class="lineNum">     240 </span>            :         } else {
<span class="lineNum">     241 </span><span class="lineCov">    4812826 :                 u8 a = (u8) (frag_param-&gt;color.q*255);</span>
<span class="lineNum">     242 </span><span class="lineCov">    4812826 :                 u8 r = (u8) (frag_param-&gt;color.x*255);</span>
<span class="lineNum">     243 </span><span class="lineCov">    4812826 :                 u8 g = (u8) (frag_param-&gt;color.y*255);</span>
<span class="lineNum">     244 </span><span class="lineCov">    4812826 :                 u8 b = (u8) (frag_param-&gt;color.z*255);</span>
<span class="lineNum">     245 </span><span class="lineCov">    4812826 :                 surf-&gt;fill_col = GF_COL_ARGB(a, r, g, b);</span>
<span class="lineNum">     246 </span>            :         }
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span><span class="lineCov">    4812826 :         if (surf-&gt;not_8bits) {</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :                 if (surf-&gt;yuv_type) {</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :                         if (frag_param-&gt;frag_valid==GF_EVG_FRAG_RGB) {</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :                                 surf-&gt;fill_col_wide = gf_evg_argb_to_ayuv_wide(surf, surf-&gt;fill_col_wide);</span>
<span class="lineNum">     252 </span>            :                         }
<span class="lineNum">     253 </span>            :                 } else {
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :                         if (frag_param-&gt;frag_valid==GF_EVG_FRAG_YUV) {</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :                                 surf-&gt;fill_col_wide = gf_evg_ayuv_to_argb_wide(surf, surf-&gt;fill_col_wide);</span>
<span class="lineNum">     256 </span>            :                         }
<span class="lineNum">     257 </span>            :                 }
<span class="lineNum">     258 </span>            :         } else {
<span class="lineNum">     259 </span><span class="lineCov">    4812826 :                 if (surf-&gt;yuv_type) {</span>
<span class="lineNum">     260 </span>            :                         /*RGB frag*/
<span class="lineNum">     261 </span><span class="lineCov">    1204487 :                         if (frag_param-&gt;frag_valid==GF_EVG_FRAG_RGB) {</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :                                 surf-&gt;fill_col = gf_evg_argb_to_ayuv(surf, surf-&gt;fill_col);</span>
<span class="lineNum">     263 </span>            :                         }
<span class="lineNum">     264 </span>            :                 } else {
<span class="lineNum">     265 </span><span class="lineCov">    3608339 :                         if (frag_param-&gt;frag_valid==GF_EVG_FRAG_YUV) {</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :                                 surf-&gt;fill_col = gf_evg_ayuv_to_argb(surf, surf-&gt;fill_col);</span>
<span class="lineNum">     267 </span>            :                         }
<span class="lineNum">     268 </span>            :                 }
<span class="lineNum">     269 </span>            :         }
<span class="lineNum">     270 </span>            :         return GF_TRUE;
<span class="lineNum">     271 </span>            : }
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span>            : static float edgeFunction(const GF_Vec4 *a, const GF_Vec4 *b, const GF_Vec4 *c)
<span class="lineNum">     274 </span>            : {
<span class="lineNum">     275 </span><span class="lineCov">       2812 :         return (c-&gt;x - a-&gt;x) * (b-&gt;y - a-&gt;y) - (c-&gt;y - a-&gt;y) * (b-&gt;x - a-&gt;x);</span>
<span class="lineNum">     276 </span>            : }
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span>            : static float edgeFunction_pre(const GF_Vec4 *a, const Float b_minus_a_x, const Float b_minus_a_y, const GF_Vec4 *c)
<span class="lineNum">     279 </span>            : {
<span class="lineNum">     280 </span><span class="lineCov">   14571291 :         return (c-&gt;x - a-&gt;x) * (b_minus_a_y) - (c-&gt;y - a-&gt;y) * (b_minus_a_x);</span>
<span class="lineNum">     281 </span>            : }
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span>            : typedef struct
<span class="lineNum">     284 </span>            : {
<span class="lineNum">     285 </span>            :         GF_EVGSurface *surf;
<span class="lineNum">     286 </span>            :         GF_EVGFragmentParam frag_param;
<a name="287"><span class="lineNum">     287 </span>            : } EVGFragCallback;</a>
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineCov">     239004 : static void push_patch_pixel(AAScanline *sl, s32 x, u32 col, u8 coverage, Float depth, Float write_depth, u32 idx1, u32 idx2)</span>
<span class="lineNum">     290 </span>            : {
<span class="lineNum">     291 </span>            :         u32 i;
<span class="lineNum">     292 </span>            :         PatchPixel *pp;
<span class="lineNum">     293 </span><span class="lineCov">    2605084 :         for (i=0; i&lt;sl-&gt;pnum; i++) {</span>
<span class="lineNum">     294 </span><span class="lineCov">    1137512 :                 if (sl-&gt;pixels[i].x&gt;x) break;</span>
<span class="lineNum">     295 </span><span class="lineCov">    1063544 :                 if (sl-&gt;pixels[i].x&lt;x) continue;</span>
<span class="lineNum">     296 </span><span class="lineCov">          6 :                 sl-&gt;pixels[i].color = col;</span>
<span class="lineNum">     297 </span><span class="lineCov">          6 :                 sl-&gt;pixels[i].cover = coverage;</span>
<span class="lineNum">     298 </span><span class="lineCov">          6 :                 sl-&gt;pixels[i].depth = depth;</span>
<span class="lineNum">     299 </span><span class="lineCov">          6 :                 sl-&gt;pixels[i].write_depth = write_depth;</span>
<span class="lineNum">     300 </span><span class="lineCov">          6 :                 sl-&gt;pixels[i].idx1 = idx1;</span>
<span class="lineNum">     301 </span><span class="lineCov">          6 :                 sl-&gt;pixels[i].idx2 = idx2;</span>
<span class="lineNum">     302 </span><span class="lineCov">          6 :                 return;</span>
<span class="lineNum">     303 </span>            :         }
<span class="lineNum">     304 </span><span class="lineCov">     238998 :         if (coverage==0xFF) return;</span>
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineCov">     238998 :         if (sl-&gt;pnum == sl-&gt;palloc) {</span>
<span class="lineNum">     307 </span><span class="lineCov">       2654 :                 sl-&gt;palloc += AA_CELL_STEP_ALLOC;</span>
<span class="lineNum">     308 </span><span class="lineCov">       2654 :                 sl-&gt;pixels = gf_realloc(sl-&gt;pixels, sizeof(PatchPixel) * sl-&gt;palloc);</span>
<span class="lineNum">     309 </span>            :         }
<span class="lineNum">     310 </span><span class="lineCov">     238998 :         if (i==sl-&gt;pnum) {</span>
<span class="lineNum">     311 </span><span class="lineCov">     165030 :                 pp = &amp;sl-&gt;pixels[sl-&gt;pnum];</span>
<span class="lineNum">     312 </span>            :         } else {
<span class="lineNum">     313 </span><span class="lineCov">      73968 :                 memmove(&amp;sl-&gt;pixels[i+1], &amp;sl-&gt;pixels[i], sizeof(PatchPixel)*(sl-&gt;pnum - i));</span>
<span class="lineNum">     314 </span><span class="lineCov">      73968 :                 pp = &amp;sl-&gt;pixels[i];</span>
<span class="lineNum">     315 </span>            :         }
<span class="lineNum">     316 </span><span class="lineCov">     238998 :         sl-&gt;pnum++;</span>
<span class="lineNum">     317 </span><span class="lineCov">     238998 :         pp-&gt;color = col;</span>
<span class="lineNum">     318 </span><span class="lineCov">     238998 :         pp-&gt;cover = coverage;</span>
<span class="lineNum">     319 </span><span class="lineCov">     238998 :         pp-&gt;x = x;</span>
<span class="lineNum">     320 </span><span class="lineCov">     238998 :         pp-&gt;depth = depth;</span>
<span class="lineNum">     321 </span><span class="lineCov">     238998 :         pp-&gt;write_depth = write_depth;</span>
<span class="lineNum">     322 </span><span class="lineCov">     238998 :         pp-&gt;idx1 = idx1;</span>
<span class="lineNum">     323 </span><span class="lineCov">     238998 :         pp-&gt;idx2 = idx2;</span>
<span class="lineNum">     324 </span>            : }
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span>            : static PatchPixel *get_patch_pixel(AAScanline *sl, s32 x)
<span class="lineNum">     327 </span>            : {
<span class="lineNum">     328 </span>            :         u32 i;
<span class="lineNum">     329 </span><span class="lineCov">    9502222 :         for (i=0; i&lt;sl-&gt;pnum; i++) {</span>
<span class="lineNum">     330 </span><span class="lineCov">   11817224 :                 if (sl-&gt;pixels[i].x&gt;x) break;</span>
<span class="lineNum">     331 </span><span class="lineCov">    9621543 :                 if (sl-&gt;pixels[i].x&lt;x) continue;</span>
<span class="lineNum">     332 </span>            :                 return &amp;sl-&gt;pixels[i];
<span class="lineNum">     333 </span>            :         }
<span class="lineNum">     334 </span>            :         return NULL;
<span class="lineNum">     335 </span>            : }
<a name="336"><span class="lineNum">     336 </span>            : </a>
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span><span class="lineCov">     113754 : static void remove_patch_pixel(AAScanline *sl, s32 x)</span>
<span class="lineNum">     339 </span>            : {
<span class="lineNum">     340 </span>            :         u32 i;
<span class="lineNum">     341 </span><span class="lineCov">     521942 :         for (i=0; i&lt;sl-&gt;pnum; i++) {</span>
<span class="lineNum">     342 </span><span class="lineCov">     317848 :                 if (sl-&gt;pixels[i].x&gt;x) break;</span>
<span class="lineNum">     343 </span><span class="lineCov">     317848 :                 if (sl-&gt;pixels[i].x&lt;x) continue;</span>
<span class="lineNum">     344 </span><span class="lineCov">     113754 :                 if (i+1&lt;sl-&gt;pnum)</span>
<span class="lineNum">     345 </span><span class="lineCov">     102983 :                         memmove(&amp;sl-&gt;pixels[i], &amp;sl-&gt;pixels[i+1], sizeof(PatchPixel)*(sl-&gt;pnum-i-1));</span>
<span class="lineNum">     346 </span><span class="lineCov">     113754 :                 sl-&gt;pnum--;</span>
<span class="lineNum">     347 </span>            :                 return;
<span class="lineNum">     348 </span>            :         }
<a name="349"><span class="lineNum">     349 </span>            : }</a>
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span><span class="lineCov">     121262 : void EVG3D_SpanFunc(int y, int count, EVG_Span *spans, void *user)</span>
<span class="lineNum">     352 </span>            : {
<span class="lineNum">     353 </span>            :         int i;
<span class="lineNum">     354 </span>            :         GF_Vec4 pix;
<span class="lineNum">     355 </span>            :         EVGFragCallback *fcbck = user;
<span class="lineNum">     356 </span><span class="lineCov">     121262 :         GF_EVGSurface *surf = fcbck-&gt;surf;</span>
<span class="lineNum">     357 </span><span class="lineCov">     121262 :         EVG_Surface3DExt *s3d = surf-&gt;ext3d;</span>
<span class="lineNum">     358 </span><span class="lineCov">     121262 :         GF_EVGFragmentParam *frag_param = &amp;fcbck-&gt;frag_param;</span>
<span class="lineNum">     359 </span><span class="lineCov">     121262 :         AAScanline *sl = &amp;surf-&gt;raster-&gt;scanlines[y];</span>
<span class="lineNum">     360 </span><span class="lineCov">     121262 :         Float *depth_line = s3d-&gt;depth_buffer ? &amp;s3d-&gt;depth_buffer[y*surf-&gt;width] : NULL;</span>
<span class="lineNum">     361 </span>            :         Float depth_buf_val;
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span>            :         pix.z=0;
<span class="lineNum">     364 </span>            :         pix.q=1;
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span><span class="lineCov">     818954 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     367 </span><span class="lineCov">     697692 :                 u8 coverage = spans[i].coverage;</span>
<span class="lineNum">     368 </span><span class="lineCov">     697692 :                 u32 j, len = spans[i].len;</span>
<span class="lineNum">     369 </span><span class="lineCov">     697692 :                 s32 sx = spans[i].x;</span>
<span class="lineNum">     370 </span><span class="lineCov">    5554789 :                 for (j=0; j&lt;len; j++) {</span>
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span><span class="lineCov">    4857097 :         Bool transparent=GF_FALSE;</span>
<span class="lineNum">     374 </span>            :         Float depth, bc1, bc2, bc3;
<span class="lineNum">     375 </span>            :         Bool full_cover=GF_TRUE;
<span class="lineNum">     376 </span>            :         Bool edge_merge=GF_FALSE;
<span class="lineNum">     377 </span><span class="lineCov">    4857097 :         s32 x = sx + j;</span>
<span class="lineNum">     378 </span>            :         PatchPixel *prev_partial = NULL;
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span>            :         /*no AA, force full opacity and test pixel/line below*/
<span class="lineNum">     381 </span><span class="lineCov">    4857097 :         if (s3d-&gt;disable_aa)</span>
<span class="lineNum">     382 </span>            :                 coverage = 0xFF;
<span class="lineNum">     383 </span><span class="lineCov">    4857097 :         else if (!s3d-&gt;mode2d)</span>
<span class="lineNum">     384 </span><span class="lineCov">    4484342 :                 prev_partial = get_patch_pixel(sl, x);</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineCov">    4857097 :         pix.x = (Float)x + 0.5f;</span>
<span class="lineNum">     387 </span><span class="lineCov">    4857097 :         pix.y = (Float)y + 0.5f;</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span><span class="lineCov">    4857097 :         if (s3d-&gt;prim_type==GF_EVG_POINTS) {</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :                 if (s3d-&gt;smooth_points) {</span>
<span class="lineNum">     391 </span>            :                         Float dx, dy;
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                         dx = (Float)x - s3d-&gt;s_v1.x;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                         dy = (Float)y - s3d-&gt;s_v1.y;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :                         dx *=dx;</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :                         dy *=dy;</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                         if (dx+dy &gt; s3d-&gt;pt_radius) {</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :                                 spans[i].coverage=0;</span>
<span class="lineNum">     398 </span><span class="lineCov">     287178 :                                 continue;</span>
<span class="lineNum">     399 </span>            :                         }
<span class="lineNum">     400 </span>            :                 }
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :                 depth = s3d-&gt;s_v1.z;</span>
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span>            :                 bc1 = bc2 = bc3 = 0;
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :                 if (coverage!=0xFF) {</span>
<span class="lineNum">     405 </span>            :                         full_cover = GF_FALSE;
<span class="lineNum">     406 </span>            :                 }
<span class="lineNum">     407 </span><span class="lineCov">    4857097 :         } else if (s3d-&gt;prim_type==GF_EVG_LINES) {</span>
<span class="lineNum">     408 </span>            :                 GF_Vec pt;
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :                 gf_vec_diff(pt, pix, s3d-&gt;s_v1);</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :                 bc1 = gf_vec_len(pt);</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :                 bc1 /= s3d-&gt;v1v2_length;</span>
<span class="lineNum">     413 </span>            :                 bc1 = float_clamp(bc1, 0, 1);
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :                 bc2 = FIX_ONE - bc1;</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :                 depth = s3d-&gt;s_v1.z * bc1 + s3d-&gt;s_v2.z * bc2;</span>
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span>            :                 bc3 = 0;
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :                 if (coverage!=0xFF) {</span>
<span class="lineNum">     419 </span>            :                         full_cover = GF_FALSE;
<span class="lineNum">     420 </span>            :                 }
<span class="lineNum">     421 </span>            :         } else {
<span class="lineNum">     422 </span><span class="lineCov">    4857097 :                 bc1 = edgeFunction_pre(&amp;s3d-&gt;s_v2, s3d-&gt;s3_m_s2_x, s3d-&gt;s3_m_s2_y, &amp;pix);</span>
<span class="lineNum">     423 </span><span class="lineCov">    4857097 :                 bc1 /= s3d-&gt;area;</span>
<span class="lineNum">     424 </span><span class="lineCov">    4857097 :                 bc2 = edgeFunction_pre(&amp;s3d-&gt;s_v3, s3d-&gt;s1_m_s3_x, s3d-&gt;s1_m_s3_y, &amp;pix);</span>
<span class="lineNum">     425 </span><span class="lineCov">    4857097 :                 bc2 /= s3d-&gt;area;</span>
<span class="lineNum">     426 </span><span class="lineCov">    4857097 :                 bc3 = edgeFunction_pre(&amp;s3d-&gt;s_v1, s3d-&gt;s2_m_s1_x, s3d-&gt;s2_m_s1_y, &amp;pix);</span>
<span class="lineNum">     427 </span><span class="lineCov">    4857097 :                 bc3 /= s3d-&gt;area;</span>
<span class="lineNum">     428 </span>            :                 //bc3 = 1.0 - bc1 - bc2;
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span>            :                 /* in antialiased mode, we don't need to test for bc1&gt;=0 &amp;&amp; bc2&gt;=0 &amp;&amp; bc3&gt;=0 (ie, is the pixel in the triangle),
<span class="lineNum">     431 </span>            :                 because we already know the point is in the triangle since we are called back
<span class="lineNum">     432 </span>            :                 in non-AA mode, coverage is forced to full pixel, and we check if we are or not in the triangle*/
<span class="lineNum">     433 </span><span class="lineCov">    4857097 :                 if (s3d-&gt;disable_aa)</span>
<span class="lineNum">     434 </span>            :                 {
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :                         if ((bc1&lt;0) || (bc2&lt;0) || (bc3&lt;0)) {</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :                                 spans[i].coverage=0;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     438 </span>            :                         }
<span class="lineNum">     439 </span>            :                 }
<span class="lineNum">     440 </span>            :                 /*if coverage is not full, we are on a line - recompute the weights assuming the pixel is exactly on the line*/
<span class="lineNum">     441 </span><span class="lineCov">    4857097 :                 else if (coverage!=0xFF) {</span>
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span>            :                 //results are not precise enough to give better results, we always clamp for now
<span class="lineNum">     444 </span>            : #if 0
<span class="lineNum">     445 </span>            :                         if (!s3d-&gt;backface_cull) {
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span>            : #if 0
<span class="lineNum">     448 </span>            :                                 //method 1, find a subpixel in a 5x5 grid belonging to the triangle
<span class="lineNum">     449 </span>            :                                 GF_Vec4 subp;
<span class="lineNum">     450 </span>            :                                 u32 k, l;
<span class="lineNum">     451 </span>            :                                 subp.q = 1;
<span class="lineNum">     452 </span>            :                                 subp.z = 0;
<span class="lineNum">     453 </span>            :                                 Bool subp_found=GF_FALSE;
<span class="lineNum">     454 </span>            :                                 for (k=0; k&lt;=4; k++) {
<span class="lineNum">     455 </span>            :                                         for (l=0; l&lt;=4; l++) {
<span class="lineNum">     456 </span>            :                                                 subp.x = (Float) x + 0.25*k;
<span class="lineNum">     457 </span>            :                                                 subp.y = (Float) x + 0.25*l;
<span class="lineNum">     458 </span>            :                                                 bc1 = edgeFunction_pre(&amp;s3d-&gt;s_v2, s3d-&gt;s3_m_s2_x, s3d-&gt;s3_m_s2_y, &amp;subp);
<span class="lineNum">     459 </span>            :                                                 bc1 /= s3d-&gt;area;
<span class="lineNum">     460 </span>            :                                                 bc2 = edgeFunction_pre(&amp;s3d-&gt;s_v3, s3d-&gt;s1_m_s3_x, s3d-&gt;s1_m_s3_y, &amp;subp);
<span class="lineNum">     461 </span>            :                                                 bc2 /= s3d-&gt;area;
<span class="lineNum">     462 </span>            :                                                 bc3 = 1.0 - bc1 - bc2;
<span class="lineNum">     463 </span>            :                                                 if ((bc1&lt;0) || (bc2&lt;0) || (bc3&lt;0)) continue;
<span class="lineNum">     464 </span>            :                                                 subp_found = GF_TRUE;
<span class="lineNum">     465 </span>            :                                                 break;
<span class="lineNum">     466 </span>            :                                         }
<span class="lineNum">     467 </span>            :                                 }
<span class="lineNum">     468 </span>            : //                              assert(subp_found);
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span>            : #else
<span class="lineNum">     471 </span>            :                                 //method 2, reproject point on triangle edges
<span class="lineNum">     472 </span>            :                                 GF_Vec pt;
<span class="lineNum">     473 </span>            :                                 u32 on_line = 0;
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span>            :                                 if ((bc1&lt;0) || (bc2&lt;0) || (bc3&lt;0)) {
<span class="lineNum">     476 </span>            :                                         if ((bc1&lt;0) &amp;&amp; (bc2&lt;0)) { bc3 = 1.0; bc1 = bc2 = 0; }
<span class="lineNum">     477 </span>            :                                         else if ((bc1&lt;0) &amp;&amp; (bc3&lt;0)) { bc2 = 1.0; bc1 = bc3 = 0; }
<span class="lineNum">     478 </span>            :                                         else if ((bc2&lt;0) &amp;&amp; (bc3&lt;0)) { bc1 = 1.0; bc2 = bc3 = 0; }
<span class="lineNum">     479 </span>            :                                         else if ((bc1&lt;=bc2) &amp;&amp; (bc1&lt;=bc3)) on_line = 3;
<span class="lineNum">     480 </span>            :                                         else if ((bc2&lt;=bc1) &amp;&amp; (bc2&lt;=bc3)) on_line = 2;
<span class="lineNum">     481 </span>            :                                         else if ((bc3&lt;=bc1) &amp;&amp; (bc3&lt;=bc2)) on_line = 1;
<span class="lineNum">     482 </span>            :                                 }
<span class="lineNum">     483 </span>            :                                 //project pixel center on line v2v3
<span class="lineNum">     484 </span>            :                                 if (on_line==3) {
<span class="lineNum">     485 </span>            :                                         bc1 = 0;
<span class="lineNum">     486 </span>            :                                         gf_vec_diff(pt, pix, s3d-&gt;s_v2);
<span class="lineNum">     487 </span>            :                                         pt.z=0;
<span class="lineNum">     488 </span>            :                                         bc2 = gf_vec_dot(pt, s3d-&gt;v2v3);
<span class="lineNum">     489 </span>            :                                         bc2 /= s3d-&gt;v2v3_length;
<span class="lineNum">     490 </span>            :                                         bc3 = float_clamp(bc2, 0, 1);
<span class="lineNum">     491 </span>            :                                         bc2 = FIX_ONE - bc3;
<span class="lineNum">     492 </span>            :                                 }
<span class="lineNum">     493 </span>            :                                 //project pixel center on line v1v3
<span class="lineNum">     494 </span>            :                                 else if (on_line==2) {
<span class="lineNum">     495 </span>            :                                         bc2 = 0;
<span class="lineNum">     496 </span>            :                                         gf_vec_diff(pt, pix, s3d-&gt;s_v1);
<span class="lineNum">     497 </span>            :                                         pt.z=0;
<span class="lineNum">     498 </span>            :                                         bc1 = gf_vec_dot(pt, s3d-&gt;v1v3);
<span class="lineNum">     499 </span>            :                                         bc1 /= s3d-&gt;v1v3_length;
<span class="lineNum">     500 </span>            :                                         bc3 = float_clamp(bc1, 0, 1);
<span class="lineNum">     501 </span>            :                                         bc1 = FIX_ONE - bc3;
<span class="lineNum">     502 </span>            :                                 }
<span class="lineNum">     503 </span>            :                                 //project pixel center on line v1v2
<span class="lineNum">     504 </span>            :                                 else if (on_line==1) {
<span class="lineNum">     505 </span>            :                                         bc3 = 0;
<span class="lineNum">     506 </span>            :                                         gf_vec_diff(pt, pix, s3d-&gt;s_v1);
<span class="lineNum">     507 </span>            :                                         pt.z=0;
<span class="lineNum">     508 </span>            :                                         bc1 = gf_vec_dot(pt, s3d-&gt;v1v2);
<span class="lineNum">     509 </span>            :                                         bc1 /= s3d-&gt;v1v2_length;
<span class="lineNum">     510 </span>            :                                         bc2 = float_clamp(bc1, 0, 1);
<span class="lineNum">     511 </span>            :                                         bc1 = FIX_ONE - bc2;
<span class="lineNum">     512 </span>            :                                 }
<span class="lineNum">     513 </span>            : #endif
<span class="lineNum">     514 </span>            : 
<span class="lineNum">     515 </span>            :                         } else
<span class="lineNum">     516 </span>            : #endif
<span class="lineNum">     517 </span><span class="lineCov">     541778 :                         if (!s3d-&gt;mode2d) {</span>
<span class="lineNum">     518 </span>            :                                 bc1 = float_clamp(bc1, 0, 1);
<span class="lineNum">     519 </span>            :                                 bc2 = float_clamp(bc2, 0, 1);
<span class="lineNum">     520 </span>            :                                 bc3 = float_clamp(bc3, 0, 1);
<span class="lineNum">     521 </span>            :                         }
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span>            :                         full_cover = GF_FALSE;
<span class="lineNum">     524 </span><span class="lineCov">     541778 :                         transparent = GF_TRUE;</span>
<span class="lineNum">     525 </span>            :                 }
<span class="lineNum">     526 </span><span class="lineCov">    4857097 :                 depth = s3d-&gt;s_v1.z * bc1 + s3d-&gt;s_v2.z * bc2 + s3d-&gt;s_v3.z * bc3;</span>
<span class="lineNum">     527 </span>            :         }
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span>            :         //clip by depth
<span class="lineNum">     530 </span><span class="lineCov">    4857097 :         if ((depth&lt;s3d-&gt;min_depth) || (depth&gt;s3d-&gt;max_depth)) {</span>
<span class="lineNum">     531 </span><span class="lineCov">       4692 :                 spans[i].coverage=0;</span>
<span class="lineNum">     532 </span><span class="lineCov">       4692 :                 continue;</span>
<span class="lineNum">     533 </span>            :         }
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span><span class="lineCov">    4852405 :         depth_buf_val = depth_line ? depth_line[x] : s3d-&gt;max_depth;</span>
<span class="lineNum">     536 </span><span class="lineCov">    4852405 :         if (prev_partial) {</span>
<span class="lineNum">     537 </span><span class="lineCov">     117663 :                 if ((spans[i].idx1==prev_partial-&gt;idx1)</span>
<span class="lineNum">     538 </span><span class="lineCov">     115892 :                         || (spans[i].idx1==prev_partial-&gt;idx2)</span>
<span class="lineNum">     539 </span><span class="lineCov">       1618 :                         || (spans[i].idx2==prev_partial-&gt;idx1)</span>
<span class="lineNum">     540 </span><span class="lineCov">       1110 :                         || (spans[i].idx2==prev_partial-&gt;idx2)</span>
<span class="lineNum">     541 </span>            :                 ) {
<span class="lineNum">     542 </span><span class="lineCov">     117657 :                         depth = prev_partial-&gt;depth;</span>
<span class="lineNum">     543 </span><span class="lineCov">     117657 :                         edge_merge = GF_TRUE;</span>
<span class="lineNum">     544 </span>            :                 } else {
<span class="lineNum">     545 </span>            :                         edge_merge = GF_FALSE;
<span class="lineNum">     546 </span><span class="lineCov">          6 :                         if (!s3d-&gt;depth_test(prev_partial-&gt;write_depth, depth_buf_val))</span>
<span class="lineNum">     547 </span><span class="lineCov">          6 :                                 depth_buf_val = prev_partial-&gt;write_depth;</span>
<span class="lineNum">     548 </span>            :                 }
<span class="lineNum">     549 </span>            :         }
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span>            : 
<span class="lineNum">     552 </span>            :         //do depth test except for edges
<span class="lineNum">     553 </span><span class="lineCov">    4852405 :         if (! edge_merge &amp;&amp; s3d-&gt;early_depth_test) {</span>
<span class="lineNum">     554 </span><span class="lineCov">    4734748 :                 if (! s3d-&gt;depth_test(depth_buf_val, depth)) {</span>
<span class="lineNum">     555 </span><span class="lineCov">      39579 :                         spans[i].coverage=0;</span>
<span class="lineNum">     556 </span><span class="lineCov">      39579 :                         continue;</span>
<span class="lineNum">     557 </span>            :                 }
<span class="lineNum">     558 </span>            :         }
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span><span class="lineCov">    4812826 :         frag_param-&gt;screen_x = pix.x;</span>
<span class="lineNum">     561 </span><span class="lineCov">    4812826 :         frag_param-&gt;screen_y = pix.y;</span>
<span class="lineNum">     562 </span>            :         //compute Z window coord
<span class="lineNum">     563 </span><span class="lineCov">    4812826 :         frag_param-&gt;screen_z = s3d-&gt;zw_factor * depth + s3d-&gt;zw_offset;</span>
<span class="lineNum">     564 </span><span class="lineCov">    4812826 :         frag_param-&gt;depth = depth;</span>
<span class="lineNum">     565 </span><span class="lineCov">    4812826 :         frag_param-&gt;color.q = 1.0;</span>
<span class="lineNum">     566 </span><span class="lineCov">    4812826 :         frag_param-&gt;frag_valid = 0;</span>
<span class="lineNum">     567 </span>            :         /*perspective corrected barycentric, eg bc1/q1, bc2/q2, bc3/q3 - we already have store 1/q in the perspective divide step*/
<span class="lineNum">     568 </span><span class="lineCov">    4812826 :         frag_param-&gt;pbc1 = bc1*s3d-&gt;s_v1.q;</span>
<span class="lineNum">     569 </span><span class="lineCov">    4812826 :         frag_param-&gt;pbc2 = bc2*s3d-&gt;s_v2.q;</span>
<span class="lineNum">     570 </span><span class="lineCov">    4812826 :         frag_param-&gt;pbc3 = bc3*s3d-&gt;s_v3.q;</span>
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span><span class="lineCov">    4812826 :         frag_param-&gt;persp_denum = frag_param-&gt;pbc1 + frag_param-&gt;pbc2 + frag_param-&gt;pbc3;</span>
<span class="lineNum">     573 </span>            : 
<span class="lineNum">     574 </span><span class="lineCov">    4812826 :         if (!evg3d_get_fragment(surf, frag_param, &amp;transparent)) {</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :                 spans[i].coverage=0;</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     577 </span>            :         }
<span class="lineNum">     578 </span><span class="lineCov">    4812826 :         if (!s3d-&gt;early_depth_test) {</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :                 if (! s3d-&gt;depth_test(depth_buf_val, frag_param-&gt;depth)) {</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :                         spans[i].coverage=0;</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     582 </span>            :                 }
<span class="lineNum">     583 </span>            :         }
<span class="lineNum">     584 </span>            :         //we overwrite a partial
<span class="lineNum">     585 </span><span class="lineCov">    4812826 :         if (prev_partial) {</span>
<span class="lineNum">     586 </span><span class="lineCov">     117663 :                 if (edge_merge) {</span>
<span class="lineNum">     587 </span><span class="lineCov">     117657 :                         u32 ncov = coverage;</span>
<span class="lineNum">     588 </span>            : 
<span class="lineNum">     589 </span><span class="lineCov">     117657 :                         ncov += prev_partial-&gt;cover;</span>
<span class="lineNum">     590 </span><span class="lineCov">     117657 :                         if (!s3d-&gt;depth_test(depth_buf_val, depth)) {</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :                                 remove_patch_pixel(sl, prev_partial-&gt;x);</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :                                 spans[i].coverage=0;</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     594 </span>            :                         }
<span class="lineNum">     595 </span><span class="lineCov">     117657 :                         if (ncov&gt;=0xFF) {</span>
<span class="lineNum">     596 </span><span class="lineCov">     113754 :                                 if (prev_partial-&gt;cover==0xFF) {</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :                                         spans[i].coverage=0;</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">     599 </span>            :                                 }
<span class="lineNum">     600 </span><span class="lineCov">     113754 :                                 remove_patch_pixel(sl, prev_partial-&gt;x);</span>
<span class="lineNum">     601 </span>            :                                 full_cover = GF_TRUE;
<span class="lineNum">     602 </span>            :                                 coverage = 0xFF;
<span class="lineNum">     603 </span>            :                         } else {
<span class="lineNum">     604 </span><span class="lineCov">       3903 :                                 prev_partial-&gt;cover = ncov;</span>
<span class="lineNum">     605 </span><span class="lineCov">       3903 :                                 prev_partial-&gt;color = surf-&gt;fill_col;</span>
<span class="lineNum">     606 </span><span class="lineCov">       3903 :                                 spans[i].coverage=0;</span>
<span class="lineNum">     607 </span><span class="lineCov">       3903 :                                 continue;</span>
<span class="lineNum">     608 </span>            :                         }
<span class="lineNum">     609 </span>            :                 }
<span class="lineNum">     610 </span><span class="lineCov">          6 :                 else if (s3d-&gt;depth_test(prev_partial-&gt;write_depth, depth)) {</span>
<span class="lineNum">     611 </span><span class="lineCov">          6 :                         prev_partial-&gt;write_depth = depth;</span>
<span class="lineNum">     612 </span>            :                 }
<span class="lineNum">     613 </span>            :         }
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span>            :         //partial coverage, store
<span class="lineNum">     616 </span><span class="lineCov">    4695169 :         if (!full_cover &amp;&amp; !s3d-&gt;mode2d) {</span>
<span class="lineNum">     617 </span><span class="lineCov">     239004 :                 push_patch_pixel(sl, x, surf-&gt;fill_col, coverage, depth, depth_buf_val, spans[i].idx1, spans[i].idx2);</span>
<span class="lineNum">     618 </span><span class="lineCov">     239004 :                 spans[i].coverage=0;</span>
<span class="lineNum">     619 </span><span class="lineCov">     239004 :                 continue;</span>
<span class="lineNum">     620 </span>            :         }
<span class="lineNum">     621 </span>            :         //full opacity, write
<span class="lineNum">     622 </span>            :         else {
<span class="lineNum">     623 </span><span class="lineCov">    4569919 :                 if (surf-&gt;fill_single) {</span>
<span class="lineNum">     624 </span><span class="lineCov">    3464500 :                         if (transparent) {</span>
<span class="lineNum">     625 </span><span class="lineCov">     228829 :                                 surf-&gt;fill_single_a(y, x, coverage, surf-&gt;fill_col, surf);</span>
<span class="lineNum">     626 </span>            :                         } else {
<span class="lineNum">     627 </span><span class="lineCov">    3235671 :                                 surf-&gt;fill_single(y, x, surf-&gt;fill_col, surf);</span>
<span class="lineNum">     628 </span>            :                         }
<span class="lineNum">     629 </span>            :                 } else {
<span class="lineNum">     630 </span><span class="lineCov">    1105419 :                         spans[i].coverage = 0xFF;</span>
<span class="lineNum">     631 </span><span class="lineCov">    1105419 :                         s3d-&gt;pix_vals[x] = surf-&gt;fill_col;</span>
<span class="lineNum">     632 </span>            :                 }
<span class="lineNum">     633 </span>            :         }
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span>            :         //write depth
<span class="lineNum">     636 </span><span class="lineCov">    4569919 :         if (s3d-&gt;run_write_depth)</span>
<span class="lineNum">     637 </span><span class="lineCov">    4561135 :                 depth_line[x] = frag_param-&gt;depth;</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            : 
<span class="lineNum">     640 </span>            :                 }       //end span.len loop
<span class="lineNum">     641 </span>            :         } //end spans count loop
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span><span class="lineCov">     121262 :         if (!surf-&gt;fill_single) {</span>
<span class="lineNum">     644 </span><span class="lineCov">      42186 :                 surf-&gt;gray_spans(y, count, spans, surf);</span>
<span class="lineNum">     645 </span>            :         }
<a name="646"><span class="lineNum">     646 </span><span class="lineCov">     121262 : }</span></a>
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span><span class="lineCov">       2812 : static GFINLINE Bool precompute_tri(EVG_Surface3DExt *s3d, EVGFragCallback *frag_ckck, TPos xmin, TPos xmax, TPos ymin, TPos ymax,</span>
<span class="lineNum">     649 </span>            :                                                                         TPos _x1, TPos _y1, TPos _x2, TPos _y2, TPos _x3, TPos _y3,
<span class="lineNum">     650 </span>            :                                                                         GF_Vec4 *s_pt1, GF_Vec4 *s_pt2, GF_Vec4 *s_pt3,
<span class="lineNum">     651 </span>            :                                                                         u32 vidx1, u32 vidx2, u32 vidx3
<span class="lineNum">     652 </span>            : )
<span class="lineNum">     653 </span>            : {
<span class="lineNum">     654 </span>            :         /*completely outside viewport*/
<span class="lineNum">     655 </span><span class="lineCov">       2812 :         if ((_x1&lt;xmin) &amp;&amp; (_x2&lt;xmin) &amp;&amp; (_x3&lt;xmin))</span>
<span class="lineNum">     656 </span>            :                 return GF_FALSE;
<span class="lineNum">     657 </span><span class="lineCov">       2812 :         if ((_y1&lt;ymin) &amp;&amp; (_y2&lt;ymin) &amp;&amp; (_y3&lt;ymin))</span>
<span class="lineNum">     658 </span>            :                 return GF_FALSE;
<span class="lineNum">     659 </span><span class="lineCov">       2812 :         if ((_x1&gt;=xmax) &amp;&amp; (_x2&gt;=xmax) &amp;&amp; (_x3&gt;=xmax))</span>
<span class="lineNum">     660 </span>            :                 return GF_FALSE;
<span class="lineNum">     661 </span><span class="lineCov">       2812 :         if ((_y1&gt;=ymax) &amp;&amp; (_y2&gt;=ymax) &amp;&amp; (_y3&gt;=ymax))</span>
<span class="lineNum">     662 </span>            :                 return GF_FALSE;
<span class="lineNum">     663 </span>            : 
<span class="lineNum">     664 </span><span class="lineCov">       5624 :         s3d-&gt;area = edgeFunction(s_pt1, s_pt2, s_pt3);</span>
<span class="lineNum">     665 </span>            : 
<span class="lineNum">     666 </span><span class="lineCov">       2812 :         s3d-&gt;s_v1 = *s_pt1;</span>
<span class="lineNum">     667 </span><span class="lineCov">       2812 :         s3d-&gt;s_v2 = *s_pt2;</span>
<span class="lineNum">     668 </span><span class="lineCov">       2812 :         s3d-&gt;s_v3 = *s_pt3;</span>
<span class="lineNum">     669 </span><span class="lineCov">       2812 :         frag_ckck-&gt;frag_param.idx1 = vidx1;</span>
<span class="lineNum">     670 </span><span class="lineCov">       2812 :         frag_ckck-&gt;frag_param.idx2 = vidx2;</span>
<span class="lineNum">     671 </span><span class="lineCov">       2812 :         frag_ckck-&gt;frag_param.idx3 = vidx3;</span>
<span class="lineNum">     672 </span>            : 
<span class="lineNum">     673 </span>            : 
<span class="lineNum">     674 </span>            :         //precompute a few things for this run
<span class="lineNum">     675 </span><span class="lineCov">       2812 :         s3d-&gt;s3_m_s2_x = s3d-&gt;s_v3.x - s3d-&gt;s_v2.x;</span>
<span class="lineNum">     676 </span><span class="lineCov">       2812 :         s3d-&gt;s3_m_s2_y = s3d-&gt;s_v3.y - s3d-&gt;s_v2.y;</span>
<span class="lineNum">     677 </span><span class="lineCov">       2812 :         s3d-&gt;s1_m_s3_x = s3d-&gt;s_v1.x - s3d-&gt;s_v3.x;</span>
<span class="lineNum">     678 </span><span class="lineCov">       2812 :         s3d-&gt;s1_m_s3_y = s3d-&gt;s_v1.y - s3d-&gt;s_v3.y;</span>
<span class="lineNum">     679 </span><span class="lineCov">       2812 :         s3d-&gt;s2_m_s1_x = s3d-&gt;s_v2.x - s3d-&gt;s_v1.x;</span>
<span class="lineNum">     680 </span><span class="lineCov">       2812 :         s3d-&gt;s2_m_s1_y = s3d-&gt;s_v2.y - s3d-&gt;s_v1.y;</span>
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span>            :         GF_Vec lv;
<span class="lineNum">     683 </span>            :         lv.z=0;
<span class="lineNum">     684 </span><span class="lineCov">       2812 :         gf_vec_diff(lv, *s_pt2, *s_pt1);</span>
<span class="lineNum">     685 </span><span class="lineCov">       2812 :         s3d-&gt;v1v2_length = gf_vec_len(lv);</span>
<span class="lineNum">     686 </span><span class="lineCov">       2812 :         gf_vec_norm(&amp;lv);</span>
<span class="lineNum">     687 </span><span class="lineCov">       2812 :         s3d-&gt;v1v2 = lv;</span>
<span class="lineNum">     688 </span><span class="lineCov">       2812 :         gf_vec_diff(lv, *s_pt3, *s_pt2);</span>
<span class="lineNum">     689 </span><span class="lineCov">       2812 :         s3d-&gt;v2v3_length = gf_vec_len(lv);</span>
<span class="lineNum">     690 </span><span class="lineCov">       2812 :         gf_vec_norm(&amp;lv);</span>
<span class="lineNum">     691 </span><span class="lineCov">       2812 :         s3d-&gt;v2v3 = lv;</span>
<span class="lineNum">     692 </span><span class="lineCov">       2812 :         gf_vec_diff(lv, *s_pt3, *s_pt1);</span>
<span class="lineNum">     693 </span><span class="lineCov">       2812 :         s3d-&gt;v1v3_length = gf_vec_len(lv);</span>
<span class="lineNum">     694 </span><span class="lineCov">       2812 :         gf_vec_norm(&amp;lv);</span>
<span class="lineNum">     695 </span><span class="lineCov">       2812 :         s3d-&gt;v1v3 = lv;</span>
<span class="lineNum">     696 </span>            : 
<span class="lineNum">     697 </span><span class="lineCov">       2812 :         return GF_TRUE;</span>
<a name="698"><span class="lineNum">     698 </span>            : }</a>
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span><span class="lineCov">        226 : GF_Err evg_raster_render3d(GF_EVGSurface *surf, u32 *indices, u32 nb_idx, Float *vertices, u32 nb_vertices, u32 nb_comp, GF_EVGPrimitiveType prim_type)</span>
<span class="lineNum">     701 </span>            : {
<span class="lineNum">     702 </span>            :         u32 i, li, size_y, nb_comp_1, idx_inc;
<span class="lineNum">     703 </span>            :         GF_Matrix projModeView;
<span class="lineNum">     704 </span>            :         EVG_Span span;
<span class="lineNum">     705 </span>            :         u32 is_strip_fan=0;
<span class="lineNum">     706 </span><span class="lineCov">        226 :         EVG_Raster raster = surf-&gt;raster;</span>
<span class="lineNum">     707 </span><span class="lineCov">        226 :         EVG_Surface3DExt *s3d = surf-&gt;ext3d;</span>
<span class="lineNum">     708 </span>            :         EVGFragCallback frag_ckck;
<span class="lineNum">     709 </span>            :         u32 first_patch, last_patch;
<span class="lineNum">     710 </span>            :         TPos xmin, xmax, ymin, ymax;
<span class="lineNum">     711 </span>            :         Bool glob_quad_done = GF_TRUE;
<span class="lineNum">     712 </span>            :         u32 prim_index=0;
<span class="lineNum">     713 </span>            :         GF_EVGVertexParam vparam;
<span class="lineNum">     714 </span>            :         int hpw=0;
<span class="lineNum">     715 </span>            :         int hlw=0;
<span class="lineNum">     716 </span><span class="lineCov">        226 :         if (!surf-&gt;ext3d-&gt;frag_shader) return GF_BAD_PARAM;</span>
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span><span class="lineCov">        226 :         raster-&gt;render_span  = (EVG_Raster_Span_Func) EVG3D_SpanFunc;</span>
<span class="lineNum">     719 </span><span class="lineCov">        226 :         raster-&gt;render_span_data = &amp;frag_ckck;</span>
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span>            :         /* Set up state in the raster object */
<span class="lineNum">     722 </span><span class="lineCov">        226 :         raster-&gt;min_ex = surf-&gt;clip_xMin;</span>
<span class="lineNum">     723 </span><span class="lineCov">        226 :         raster-&gt;min_ey = surf-&gt;clip_yMin;</span>
<span class="lineNum">     724 </span><span class="lineCov">        226 :         raster-&gt;max_ex = surf-&gt;clip_xMax;</span>
<span class="lineNum">     725 </span><span class="lineCov">        226 :         raster-&gt;max_ey = surf-&gt;clip_yMax;</span>
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span><span class="lineCov">        226 :         s3d-&gt;run_write_depth = s3d-&gt;depth_buffer ? s3d-&gt;write_depth : GF_FALSE;</span>
<span class="lineNum">     728 </span>            : 
<span class="lineNum">     729 </span><span class="lineCov">        226 :         size_y = (u32) (raster-&gt;max_ey - raster-&gt;min_ey);</span>
<span class="lineNum">     730 </span><span class="lineCov">        226 :         if (raster-&gt;max_lines &lt; size_y) {</span>
<span class="lineNum">     731 </span><span class="lineCov">         18 :                 raster-&gt;scanlines = (AAScanline*)gf_realloc(raster-&gt;scanlines, sizeof(AAScanline)*size_y);</span>
<span class="lineNum">     732 </span><span class="lineCov">         18 :                 memset(&amp;raster-&gt;scanlines[raster-&gt;max_lines], 0, sizeof(AAScanline)*(size_y-raster-&gt;max_lines) );</span>
<span class="lineNum">     733 </span><span class="lineCov">         18 :                 raster-&gt;max_lines = size_y;</span>
<span class="lineNum">     734 </span>            :         }
<span class="lineNum">     735 </span><span class="lineCov">     140220 :         for (li=0; li&lt;size_y; li++) {</span>
<span class="lineNum">     736 </span><span class="lineCov">     140220 :                 raster-&gt;scanlines[li].pnum = 0;</span>
<span class="lineNum">     737 </span>            :         }
<span class="lineNum">     738 </span>            :         first_patch = 0xFFFFFFFF;
<span class="lineNum">     739 </span>            :         last_patch = 0;
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span><span class="lineCov">        226 :         gf_mx_copy(projModeView, s3d-&gt;proj);</span>
<span class="lineNum">     742 </span><span class="lineCov">        226 :         gf_mx_add_matrix_4x4(&amp;projModeView, &amp;s3d-&gt;modelview);</span>
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span><span class="lineCov">        226 :         switch (prim_type) {</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :         case GF_EVG_LINE_STRIP:</span>
<span class="lineNum">     746 </span>            :                 is_strip_fan = 1;
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :         case GF_EVG_LINES:</span>
<span class="lineNum">     748 </span>            :                 idx_inc = 2;
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :                 hlw = (int) (s3d-&gt;line_size*ONE_PIXEL/2);</span>
<span class="lineNum">     750 </span>            :                 prim_type = GF_EVG_LINES;
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     752 </span>            :         case GF_EVG_TRIANGLES:
<span class="lineNum">     753 </span>            :                 idx_inc = 3;
<span class="lineNum">     754 </span>            :                 break;
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :         case GF_EVG_TRIANGLE_STRIP:</span>
<span class="lineNum">     756 </span>            :                 is_strip_fan = 1;
<span class="lineNum">     757 </span>            :                 idx_inc = 3;
<span class="lineNum">     758 </span>            :                 prim_type = GF_EVG_TRIANGLES;
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :         case GF_EVG_POLYGON:</span>
<span class="lineNum">     761 </span>            :         case GF_EVG_TRIANGLE_FAN:
<span class="lineNum">     762 </span>            :                 is_strip_fan = 2;
<span class="lineNum">     763 </span>            :                 idx_inc = 3;
<span class="lineNum">     764 </span>            :                 prim_type = GF_EVG_TRIANGLES;
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :         case GF_EVG_QUADS:</span>
<span class="lineNum">     767 </span>            :                 idx_inc = 4;
<span class="lineNum">     768 </span>            :                 glob_quad_done = GF_FALSE;
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :         case GF_EVG_QUAD_STRIP:</span>
<span class="lineNum">     771 </span>            :                 idx_inc = 4;
<span class="lineNum">     772 </span>            :                 glob_quad_done = GF_FALSE;
<span class="lineNum">     773 </span>            :                 is_strip_fan = 1;
<span class="lineNum">     774 </span>            :                 prim_type = GF_EVG_QUADS;
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :         default:</span>
<span class="lineNum">     777 </span>            :                 idx_inc = 1;
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :                 hpw = (int) (s3d-&gt;point_size*ONE_PIXEL/2);</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :                 s3d-&gt;pt_radius = (Float) (s3d-&gt;point_size*s3d-&gt;point_size) / 4;</span>
<span class="lineNum">     780 </span>            : 
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     782 </span>            :         }
<span class="lineNum">     783 </span><span class="lineCov">        226 :         if (!is_strip_fan &amp;&amp; (nb_idx % idx_inc))</span>
<span class="lineNum">     784 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span><span class="lineCov">        226 :         s3d-&gt;prim_type = prim_type;</span>
<span class="lineNum">     787 </span>            :         memset(&amp;frag_ckck, 0, sizeof(EVGFragCallback));
<span class="lineNum">     788 </span><span class="lineCov">        226 :         frag_ckck.surf = surf;</span>
<span class="lineNum">     789 </span><span class="lineCov">        226 :         frag_ckck.frag_param.ptype = prim_type;</span>
<span class="lineNum">     790 </span>            :         frag_ckck.frag_param.prim_index = 0;
<span class="lineNum">     791 </span>            : 
<span class="lineNum">     792 </span><span class="lineCov">        226 :         xmin = raster-&gt;min_ex * ONE_PIXEL;</span>
<span class="lineNum">     793 </span><span class="lineCov">        226 :         xmax = raster-&gt;max_ex * ONE_PIXEL;</span>
<span class="lineNum">     794 </span><span class="lineCov">        226 :         ymin = raster-&gt;min_ey * ONE_PIXEL;</span>
<span class="lineNum">     795 </span><span class="lineCov">        226 :         ymax = raster-&gt;max_ey * ONE_PIXEL;</span>
<span class="lineNum">     796 </span>            : 
<span class="lineNum">     797 </span>            :         //raster coordinates of points
<span class="lineNum">     798 </span><span class="lineCov">        226 :         TPos _x1=0, _y1=0, _x2=0, _y2=0, _x3=0, _y3=0, _x4=0, _y4=0, _prev_x2=0, _prev_y2=0;</span>
<span class="lineNum">     799 </span>            :         /*vertices in raster/window space: x and y are in pixel space, z is [min_depth, max_depth]*/
<span class="lineNum">     800 </span>            :         GF_Vec4 s_pt1, s_pt2, s_pt3, s_pt4, prev_s_pt2;
<span class="lineNum">     801 </span>            :         u32 idx1=0, idx2=0, idx3=0, idx4=0;
<span class="lineNum">     802 </span>            :         u32 vidx1=0, vidx2=0, vidx3=0, vidx4=0, prev_vidx2=0;
<span class="lineNum">     803 </span>            : 
<span class="lineNum">     804 </span>            :         memset(&amp;vparam, 0, sizeof(GF_EVGVertexParam));
<span class="lineNum">     805 </span><span class="lineCov">        226 :         vparam.ptype = prim_type;</span>
<span class="lineNum">     806 </span>            : 
<span class="lineNum">     807 </span><span class="lineCov">        226 :         nb_comp_1 = nb_comp-1;</span>
<span class="lineNum">     808 </span><span class="lineCov">       2938 :         for (i=0; i&lt;nb_idx; i += idx_inc) {</span>
<span class="lineNum">     809 </span>            :                 Bool quad_done = glob_quad_done;
<span class="lineNum">     810 </span>            :                 GF_Vec4 *vx = &amp;vparam.in_vertex;
<span class="lineNum">     811 </span>            : 
<span class="lineNum">     812 </span><span class="lineCov">       2712 :                 if (s3d-&gt;vert_shader) {</span>
<span class="lineNum">     813 </span><span class="lineCov">       1500 :                         vparam.prim_index = prim_index;</span>
<span class="lineNum">     814 </span>            :                 }
<span class="lineNum">     815 </span><span class="lineCov">       2712 :                 prim_index++;</span>
<span class="lineNum">     816 </span>            :                 
<span class="lineNum">     817 </span>            : #define GETVEC(_name, _idx)\
<span class="lineNum">     818 </span>            :                 vx-&gt;x = vertices[_idx];\
<span class="lineNum">     819 </span>            :                 vx-&gt;y = vertices[_idx+1];\
<span class="lineNum">     820 </span>            :                 if (_idx+nb_comp_1&gt;=nb_vertices) return GF_BAD_PARAM;\
<span class="lineNum">     821 </span>            :                 vx-&gt;z = (nb_comp&gt;2) ? vertices[_idx+2] : 0.0f;\
<span class="lineNum">     822 </span>            :                 vx-&gt;q = 1.0;\
<span class="lineNum">     823 </span>            :                 if (s3d-&gt;vert_shader) {\
<span class="lineNum">     824 </span>            :                         s3d-&gt;vert_shader(s3d-&gt;vert_shader_udta, &amp;vparam); \
<span class="lineNum">     825 </span>            :                         s_##_name = vparam.out_vertex;\
<span class="lineNum">     826 </span>            :                 } else {\
<span class="lineNum">     827 </span>            :                         s_##_name.x = vx-&gt;x;\
<span class="lineNum">     828 </span>            :                         s_##_name.y = vx-&gt;y;\
<span class="lineNum">     829 </span>            :                         s_##_name.z = vx-&gt;z;\
<span class="lineNum">     830 </span>            :                         s_##_name.q = 1;\
<span class="lineNum">     831 </span>            :                         gf_mx_apply_vec_4x4(&amp;projModeView, &amp;s_##_name);\
<span class="lineNum">     832 </span>            :                 }\
<span class="lineNum">     833 </span>            :                 if (!evg3d_persp_divide(&amp;s_##_name)) continue;\
<span class="lineNum">     834 </span>            : 
<span class="lineNum">     835 </span>            :                 /*get vertice, apply transform and perspective divide and translate to raster*/
<span class="lineNum">     836 </span><span class="lineCov">       2712 :                 if (is_strip_fan &amp;&amp; i) {</span>
<span class="lineNum">     837 </span>            :                         idx_inc=1;
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :                         if (prim_type==GF_EVG_LINES) {</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :                                 _x1 = _x2;</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :                                 _y1 = _y2;</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :                                 s_pt1 = s_pt2;</span>
<span class="lineNum">     842 </span>            :                                 vidx1 = vidx2;
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :                                 vidx2 = indices[i];</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :                                 idx2 = vidx2 * nb_comp;</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :                                 vparam.vertex_idx = vidx2;</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :                                 vparam.vertex_idx_in_prim = 1;</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :                                 GETVEC(pt2, idx2)</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :                                 evg3d_ndc_to_raster(surf, &amp;s_pt2, &amp;_x2, &amp;_y2);</span>
<span class="lineNum">     849 </span>            :                         }
<span class="lineNum">     850 </span>            :                         //triangle strip
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :                         else if (is_strip_fan==1) {</span>
<span class="lineNum">     852 </span>            :                                 /*triangle strip*/
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :                                 if (prim_type==GF_EVG_TRIANGLES) {</span>
<span class="lineNum">     854 </span>            :                                         /*swap v2 to v1 and v3 to v2*/
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :                                         _x1 = _x2;</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :                                         _y1 = _y2;</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :                                         s_pt1 = s_pt2;</span>
<span class="lineNum">     858 </span>            :                                         vidx1 = vidx2;
<span class="lineNum">     859 </span>            : 
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :                                         _x2 = _x3;</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :                                         _y2 = _y3;</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :                                         s_pt2 = s_pt3;</span>
<span class="lineNum">     863 </span>            :                                         vidx2 = vidx3;
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :                                         vidx3 = indices[i];</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :                                         idx3 = vidx3 * nb_comp;</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :                                         vparam.vertex_idx = vidx3;</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :                                         vparam.vertex_idx_in_prim = 2;</span>
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :                                         GETVEC(pt3, idx3)</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :                                         evg3d_ndc_to_raster(surf, &amp;s_pt3, &amp;_x3, &amp;_y3);</span>
<span class="lineNum">     871 </span>            :                                 }
<span class="lineNum">     872 </span>            :                                 //quad strip - since we draw [v1, v2, v3, v4] as 2 triangles [v1, v2, v3] and [v1, v3, v4]
<span class="lineNum">     873 </span>            :                                 // we only need to restore prev v2 as v1
<span class="lineNum">     874 </span>            :                                 else {
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :                                         _x1 = _prev_x2;</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :                                         _y1 = _prev_y2;</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :                                         s_pt1 = prev_s_pt2;</span>
<span class="lineNum">     878 </span>            :                                         vidx1 = prev_vidx2;
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :                                         vidx4 = indices[i];</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :                                         idx4 = vidx4 * nb_comp;</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :                                         vparam.vertex_idx = vidx4;</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :                                         vparam.vertex_idx_in_prim = 3;</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :                                         GETVEC(pt4, idx4)</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :                                         evg3d_ndc_to_raster(surf, &amp;s_pt4, &amp;_x4, &amp;_y4);</span>
<span class="lineNum">     886 </span>            :                                 }
<span class="lineNum">     887 </span>            :                         }
<span class="lineNum">     888 </span>            :                         //triangle fan
<span class="lineNum">     889 </span>            :                         else {
<span class="lineNum">     890 </span>            :                                 //keep center and move 3rd vertex as second
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :                                 _x2 = _x3;</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :                                 _y2 = _y3;</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :                                 s_pt2 = s_pt3;</span>
<span class="lineNum">     894 </span>            :                                 vidx2 = vidx3;
<span class="lineNum">     895 </span>            : 
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :                                 vidx3 = indices[i];</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :                                 idx3 = vidx3 * nb_comp;</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :                                 vparam.vertex_idx = vidx3;</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :                                 vparam.vertex_idx_in_prim = 2;</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :                                 GETVEC(pt3, idx3)</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :                                 evg3d_ndc_to_raster(surf, &amp;s_pt3, &amp;_x3, &amp;_y3);</span>
<span class="lineNum">     902 </span>            :                         }
<span class="lineNum">     903 </span>            :                 } else {
<span class="lineNum">     904 </span><span class="lineCov">       2712 :                         vidx1 = indices[i];</span>
<span class="lineNum">     905 </span><span class="lineCov">       2712 :                         idx1 = vidx1 * nb_comp;</span>
<span class="lineNum">     906 </span><span class="lineCov">       2712 :                         vparam.vertex_idx = vidx1;</span>
<span class="lineNum">     907 </span><span class="lineCov">       2712 :                         vparam.vertex_idx_in_prim = 0;</span>
<span class="lineNum">     908 </span><span class="lineCov">       2712 :                         GETVEC(pt1, idx1)</span>
<span class="lineNum">     909 </span><span class="lineCov">       2712 :                         evg3d_ndc_to_raster(surf, &amp;s_pt1, &amp;_x1, &amp;_y1);</span>
<span class="lineNum">     910 </span><span class="lineCov">       2712 :                         if (prim_type&gt;=GF_EVG_LINES) {</span>
<span class="lineNum">     911 </span><span class="lineCov">       2712 :                                 vidx2 = indices[i+1];</span>
<span class="lineNum">     912 </span><span class="lineCov">       2712 :                                 idx2 = vidx2 * nb_comp;</span>
<span class="lineNum">     913 </span><span class="lineCov">       2712 :                                 vparam.vertex_idx = vidx2;</span>
<span class="lineNum">     914 </span><span class="lineCov">       2712 :                                 vparam.vertex_idx_in_prim = 1;</span>
<span class="lineNum">     915 </span><span class="lineCov">       2712 :                                 GETVEC(pt2, idx2)</span>
<span class="lineNum">     916 </span><span class="lineCov">       2712 :                                 evg3d_ndc_to_raster(surf, &amp;s_pt2, &amp;_x2, &amp;_y2);</span>
<span class="lineNum">     917 </span><span class="lineCov">       2712 :                                 if (prim_type&gt;=GF_EVG_TRIANGLES) {</span>
<span class="lineNum">     918 </span><span class="lineCov">       2712 :                                         vidx3 = indices[i+2];</span>
<span class="lineNum">     919 </span><span class="lineCov">       2712 :                                         idx3 = vidx3 * nb_comp;</span>
<span class="lineNum">     920 </span><span class="lineCov">       2712 :                                         vparam.vertex_idx = vidx3;</span>
<span class="lineNum">     921 </span><span class="lineCov">       2712 :                                         vparam.vertex_idx_in_prim = 2;</span>
<span class="lineNum">     922 </span><span class="lineCov">       2712 :                                         GETVEC(pt3, idx3)</span>
<span class="lineNum">     923 </span><span class="lineCov">       2712 :                                         evg3d_ndc_to_raster(surf, &amp;s_pt3, &amp;_x3, &amp;_y3);</span>
<span class="lineNum">     924 </span><span class="lineCov">       2712 :                                         if (prim_type==GF_EVG_QUADS) {</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :                                                 vidx4 = indices[i+3];</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :                                                 idx4 = vidx4 * nb_comp;</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :                                                 vparam.vertex_idx = vidx4;</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :                                                 vparam.vertex_idx_in_prim = 3;</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :                                                 GETVEC(pt4, idx4)</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :                                                 evg3d_ndc_to_raster(surf, &amp;s_pt4, &amp;_x4, &amp;_y4);</span>
<span class="lineNum">     931 </span>            :                                         }
<span class="lineNum">     932 </span>            :                                 }
<span class="lineNum">     933 </span>            :                         }
<span class="lineNum">     934 </span>            :                 }
<span class="lineNum">     935 </span>            : #undef GETVEC
<span class="lineNum">     936 </span>            : 
<span class="lineNum">     937 </span><span class="lineCov">       2712 : restart_quad:</span>
<span class="lineNum">     938 </span><span class="lineCov">       2712 :                 raster-&gt;first_scanline = surf-&gt;height;</span>
<span class="lineNum">     939 </span><span class="lineCov">       2712 :                 raster-&gt;ex = (int) (raster-&gt;max_ex+1);</span>
<span class="lineNum">     940 </span><span class="lineCov">       2712 :                 raster-&gt;ey = (int) (raster-&gt;max_ey+1);</span>
<span class="lineNum">     941 </span><span class="lineCov">       2712 :                 raster-&gt;cover = 0;</span>
<span class="lineNum">     942 </span><span class="lineCov">       2712 :                 raster-&gt;area = 0;</span>
<span class="lineNum">     943 </span>            : 
<span class="lineNum">     944 </span>            : 
<span class="lineNum">     945 </span><span class="lineCov">       2712 :                 if (prim_type&gt;=GF_EVG_TRIANGLES) {</span>
<span class="lineNum">     946 </span>            : 
<span class="lineNum">     947 </span><span class="lineCov">       2712 :                         if (!precompute_tri(s3d, &amp;frag_ckck, xmin, xmax, ymin, ymax, _x1, _y1, _x2, _y2, _x3, _y3, &amp;s_pt1, &amp;s_pt2, &amp;s_pt3, vidx1, vidx2, vidx3))</span>
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     949 </span>            : 
<span class="lineNum">     950 </span>            :                         //check backcull
<span class="lineNum">     951 </span><span class="lineCov">       2712 :                         if (s3d-&gt;is_ccw) {</span>
<span class="lineNum">     952 </span><span class="lineCov">       2712 :                                 if (s3d-&gt;area&lt;0) {</span>
<span class="lineNum">     953 </span><span class="lineCov">       1610 :                                         if (s3d-&gt;backface_cull)</span>
<span class="lineNum">     954 </span><span class="lineCov">       1610 :                                                 continue;</span>
<span class="lineNum">     955 </span>            :                                 }
<span class="lineNum">     956 </span>            :                         } else {
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :                                 if (s3d-&gt;area&gt;0) {</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :                                         if (s3d-&gt;backface_cull)</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :                                                 continue;</span>
<span class="lineNum">     960 </span>            :                                 }
<span class="lineNum">     961 </span>            :                         }
<span class="lineNum">     962 </span>            :                 } else {
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :                         s3d-&gt;s_v1 = s_pt1;</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :                         frag_ckck.frag_param.idx1 = vidx1;</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :                         if (prim_type==GF_EVG_LINES) {</span>
<span class="lineNum">     966 </span>            :                                 GF_Vec lv;
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :                                 s3d-&gt;s_v2 = s_pt2;</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :                                 gf_vec_diff(lv, s_pt2, s_pt1);</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :                                 lv.z=0;</span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :                                 s3d-&gt;v1v2_length = gf_vec_len(lv);</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :                                 frag_ckck.frag_param.idx2 = vidx2;</span>
<span class="lineNum">     972 </span>            :                         }
<span class="lineNum">     973 </span>            :                 }
<span class="lineNum">     974 </span><span class="lineCov">       1102 :                 frag_ckck.frag_param.prim_index = prim_index-1;</span>
<span class="lineNum">     975 </span>            : 
<span class="lineNum">     976 </span><span class="lineCov">       1102 :                 if (prim_type==GF_EVG_POINTS) {</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :                         raster-&gt;idx1 = raster-&gt;idx2 = idx1;</span>
<span class="lineNum">     978 </span>            :                         //draw square
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :                         gray3d_move_to(raster, _x1-hpw, _y1-hpw);</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :                         gray_render_line(raster, _x1+hpw, _y1-hpw);</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :                         gray_render_line(raster, _x1+hpw, _y1+hpw);</span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :                         gray_render_line(raster, _x1-hpw, _y1+hpw);</span>
<span class="lineNum">     983 </span>            :                         //and close
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :                         gray_render_line(raster, _x1-hpw, _y1-hpw);</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :                         gray_record_cell( raster );</span>
<span class="lineNum">     986 </span><span class="lineCov">       1102 :                 } else if (prim_type==GF_EVG_LINES) {</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :                         raster-&gt;idx1 = idx1;</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :                         raster-&gt;idx2 = idx2;</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :                         gray3d_move_to(raster, _x1+hlw, _y1+hlw);</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :                         gray_render_line(raster, _x1-hlw, _y1-hlw);</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :                         gray_render_line(raster, _x2-hlw, _y2-hlw);</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :                         gray_render_line(raster, _x2+hlw, _y2+hlw);</span>
<span class="lineNum">     993 </span>            :                         //and close
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :                         gray_render_line(raster, _x1+hlw, _y1+hlw);</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :                         gray_record_cell( raster );</span>
<span class="lineNum">     996 </span>            :                 } else {
<span class="lineNum">     997 </span><span class="lineCov">       1102 :                         raster-&gt;idx1 = idx1;</span>
<span class="lineNum">     998 </span><span class="lineCov">       1102 :                         raster-&gt;idx2 = idx2;</span>
<span class="lineNum">     999 </span><span class="lineCov">       1102 :                         gray3d_move_to(raster, _x1, _y1);</span>
<span class="lineNum">    1000 </span><span class="lineCov">       1102 :                         gray_render_line(raster, _x2, _y2);</span>
<span class="lineNum">    1001 </span><span class="lineCov">       1102 :                         raster-&gt;idx1 = idx2;</span>
<span class="lineNum">    1002 </span><span class="lineCov">       1102 :                         raster-&gt;idx2 = idx3;</span>
<span class="lineNum">    1003 </span><span class="lineCov">       1102 :                         gray_render_line(raster, _x3, _y3);</span>
<span class="lineNum">    1004 </span>            : 
<span class="lineNum">    1005 </span>            :                         //and close
<span class="lineNum">    1006 </span><span class="lineCov">       1102 :                         raster-&gt;idx1 = idx3;</span>
<span class="lineNum">    1007 </span><span class="lineCov">       1102 :                         raster-&gt;idx2 = idx1;</span>
<span class="lineNum">    1008 </span><span class="lineCov">       1102 :                         gray_render_line(raster, _x1, _y1);</span>
<span class="lineNum">    1009 </span><span class="lineCov">       1102 :                         gray_record_cell( raster );</span>
<span class="lineNum">    1010 </span>            :                 }
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span>            :                 /* sort each scanline and render it*/
<span class="lineNum">    1013 </span><span class="lineCov">     113730 :                 for (li=raster-&gt;first_scanline; li&lt;size_y; li++) {</span>
<span class="lineNum">    1014 </span><span class="lineCov">     113726 :                         AAScanline *sl = &amp;raster-&gt;scanlines[li];</span>
<span class="lineNum">    1015 </span>            :                         //if nothing on this line, we are done for this primitive
<span class="lineNum">    1016 </span><span class="lineCov">     113726 :                         if (!sl-&gt;num) break;</span>
<span class="lineNum">    1017 </span>            : 
<span class="lineNum">    1018 </span><span class="lineCov">     112628 :                         if (sl-&gt;num&gt;1) gray_quick_sort(sl-&gt;cells, sl-&gt;num);</span>
<span class="lineNum">    1019 </span><span class="lineCov">     112628 :                         gray_sweep_line(raster, sl, li, GF_FALSE);</span>
<span class="lineNum">    1020 </span>            : 
<span class="lineNum">    1021 </span><span class="lineCov">     112628 :                         if (sl-&gt;pnum) {</span>
<span class="lineNum">    1022 </span><span class="lineCov">     111669 :                                 if (first_patch&gt;li) first_patch = li;</span>
<span class="lineNum">    1023 </span><span class="lineCov">     111669 :                                 if (last_patch&lt;li) last_patch = li;</span>
<span class="lineNum">    1024 </span>            :                         }
<span class="lineNum">    1025 </span>            :                 }
<span class="lineNum">    1026 </span><span class="lineCov">       1102 :                 if (!quad_done) {</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :                         if (is_strip_fan) {</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :                                 _prev_x2 = _x2;</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :                                 _prev_y2 = _y2;</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :                                 prev_s_pt2 = s_pt2;</span>
<span class="lineNum">    1031 </span>            :                                 prev_vidx2 = vidx2;
<span class="lineNum">    1032 </span>            :                         }
<span class="lineNum">    1033 </span>            :                         quad_done = GF_TRUE;
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :                         _x2 = _x3;</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :                         _y2 = _y3;</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :                         _x3 = _x4;</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :                         _y3 = _y4;</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :                         s_pt2 = s_pt3;</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :                         s_pt3 = s_pt4;</span>
<span class="lineNum">    1040 </span>            :                         vidx2 = vidx3;
<span class="lineNum">    1041 </span>            :                         vidx3 = vidx4;
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :                         s3d-&gt;s_v1 = s3d-&gt;s_v2;</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :                         s3d-&gt;s_v2 = s3d-&gt;s_v3;</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :                         goto restart_quad;</span>
<span class="lineNum">    1045 </span>            :                 }
<span class="lineNum">    1046 </span>            :         }
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span>            :         /*flush all partial fragments*/
<span class="lineNum">    1049 </span><span class="lineCov">        226 :         span.len = 0;</span>
<span class="lineNum">    1050 </span><span class="lineCov">      32090 :         for (li=first_patch; li&lt;=last_patch; li++) {</span>
<span class="lineNum">    1051 </span><span class="lineCov">      31864 :                 AAScanline *sl = &amp;raster-&gt;scanlines[li];</span>
<span class="lineNum">    1052 </span><span class="lineCov">      31864 :                 Float *depth_line = &amp;surf-&gt;ext3d-&gt;depth_buffer[li];</span>
<span class="lineNum">    1053 </span><span class="lineCov">     157108 :                 for (i=0; i&lt;sl-&gt;pnum; i++) {</span>
<span class="lineNum">    1054 </span><span class="lineCov">     125244 :                         PatchPixel *pi = &amp;sl-&gt;pixels[i];</span>
<span class="lineNum">    1055 </span>            : 
<span class="lineNum">    1056 </span><span class="lineCov">     125244 :                         if (pi-&gt;cover == 0xFF) continue;</span>
<span class="lineNum">    1057 </span><span class="lineCov">     125244 :                         if (!surf-&gt;ext3d-&gt;depth_test(pi-&gt;write_depth, pi-&gt;depth)) continue;</span>
<span class="lineNum">    1058 </span>            : 
<span class="lineNum">    1059 </span><span class="lineCov">     125244 :                         if (surf-&gt;fill_single) {</span>
<span class="lineNum">    1060 </span><span class="lineCov">      76878 :                                 surf-&gt;fill_single_a(li, pi-&gt;x, pi-&gt;cover, pi-&gt;color, surf);</span>
<span class="lineNum">    1061 </span>            :                         } else {
<span class="lineNum">    1062 </span><span class="lineCov">      48366 :                                 span.coverage = pi-&gt;cover;</span>
<span class="lineNum">    1063 </span><span class="lineCov">      48366 :                                 span.x = pi-&gt;x;</span>
<span class="lineNum">    1064 </span><span class="lineCov">      48366 :                                 surf-&gt;gray_spans(li, 1, &amp;span, surf);</span>
<span class="lineNum">    1065 </span>            :                         }
<span class="lineNum">    1066 </span><span class="lineCov">     125244 :                         if (surf-&gt;ext3d-&gt;run_write_depth)</span>
<span class="lineNum">    1067 </span><span class="lineCov">     124826 :                                 depth_line[pi-&gt;x] = pi-&gt;depth;</span>
<span class="lineNum">    1068 </span>            :                 }
<span class="lineNum">    1069 </span>            :         }
<span class="lineNum">    1070 </span>            :         return GF_OK;
<a name="1071"><span class="lineNum">    1071 </span>            : }</a>
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span><span class="lineCov">        100 : GF_Err evg_raster_render3d_path(GF_EVGSurface *surf, GF_Path *path, Float z)</span>
<span class="lineNum">    1074 </span>            : {
<span class="lineNum">    1075 </span>            : 
<span class="lineNum">    1076 </span>            :         EVG_Vector   v_start;
<span class="lineNum">    1077 </span>            :         int   n;         /* index of contour in outline     */
<span class="lineNum">    1078 </span>            :         int   first;     /* index of first point in contour */
<span class="lineNum">    1079 </span>            :         TPos _x, _y, _sx, _sy;
<span class="lineNum">    1080 </span>            :         u32 li, size_y;
<span class="lineNum">    1081 </span><span class="lineCov">        100 :         EVG_Raster raster = surf-&gt;raster;</span>
<span class="lineNum">    1082 </span>            :         EVG_Outline *outline;
<span class="lineNum">    1083 </span>            :         GF_Matrix projModeView;
<span class="lineNum">    1084 </span><span class="lineCov">        100 :         EVG_Surface3DExt *s3d = surf-&gt;ext3d;</span>
<span class="lineNum">    1085 </span>            :         EVGFragCallback frag_ckck;
<span class="lineNum">    1086 </span>            :         u32 xmin, xmax, ymin, ymax;
<span class="lineNum">    1087 </span>            :         GF_Err e;
<span class="lineNum">    1088 </span>            :         GF_Rect rc;
<span class="lineNum">    1089 </span>            : 
<span class="lineNum">    1090 </span><span class="lineCov">        100 :         if (!surf-&gt;ext3d-&gt;frag_shader) return GF_BAD_PARAM;</span>
<span class="lineNum">    1091 </span>            : 
<span class="lineNum">    1092 </span><span class="lineCov">        100 :         e = gf_evg_surface_set_path(surf, path);</span>
<span class="lineNum">    1093 </span><span class="lineCov">        100 :         if (e) return e;</span>
<span class="lineNum">    1094 </span>            : 
<span class="lineNum">    1095 </span>            :         outline = &amp;surf-&gt;ftoutline;
<span class="lineNum">    1096 </span>            : 
<span class="lineNum">    1097 </span><span class="lineCov">        100 :         raster-&gt;render_span  = (EVG_Raster_Span_Func) EVG3D_SpanFunc;</span>
<span class="lineNum">    1098 </span><span class="lineCov">        100 :         raster-&gt;render_span_data = &amp;frag_ckck;</span>
<span class="lineNum">    1099 </span>            : 
<span class="lineNum">    1100 </span>            :         /* Set up state in the raster object */
<span class="lineNum">    1101 </span><span class="lineCov">        100 :         raster-&gt;min_ex = surf-&gt;clip_xMin;</span>
<span class="lineNum">    1102 </span><span class="lineCov">        100 :         raster-&gt;min_ey = surf-&gt;clip_yMin;</span>
<span class="lineNum">    1103 </span><span class="lineCov">        100 :         raster-&gt;max_ex = surf-&gt;clip_xMax;</span>
<span class="lineNum">    1104 </span><span class="lineCov">        100 :         raster-&gt;max_ey = surf-&gt;clip_yMax;</span>
<span class="lineNum">    1105 </span><span class="lineCov">        100 :         s3d-&gt;run_write_depth = s3d-&gt;depth_buffer ? s3d-&gt;write_depth : GF_FALSE;</span>
<span class="lineNum">    1106 </span>            : 
<span class="lineNum">    1107 </span><span class="lineCov">        100 :         size_y = (u32) (raster-&gt;max_ey - raster-&gt;min_ey);</span>
<span class="lineNum">    1108 </span><span class="lineCov">        100 :         if (raster-&gt;max_lines &lt; size_y) {</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :                 raster-&gt;scanlines = (AAScanline*)gf_realloc(raster-&gt;scanlines, sizeof(AAScanline)*size_y);</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :                 memset(&amp;raster-&gt;scanlines[raster-&gt;max_lines], 0, sizeof(AAScanline)*(size_y-raster-&gt;max_lines) );</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :                 raster-&gt;max_lines = size_y;</span>
<span class="lineNum">    1112 </span>            :         }
<span class="lineNum">    1113 </span>            : 
<span class="lineNum">    1114 </span><span class="lineCov">        100 :         gf_mx_copy(projModeView, s3d-&gt;proj);</span>
<span class="lineNum">    1115 </span><span class="lineCov">        100 :         gf_mx_add_matrix_4x4(&amp;projModeView, &amp;s3d-&gt;modelview);</span>
<span class="lineNum">    1116 </span>            : 
<span class="lineNum">    1117 </span><span class="lineCov">        100 :         s3d-&gt;prim_type = GF_EVG_TRIANGLES;</span>
<span class="lineNum">    1118 </span>            :         memset(&amp;frag_ckck, 0, sizeof(EVGFragCallback));
<span class="lineNum">    1119 </span><span class="lineCov">        100 :         frag_ckck.surf = surf;</span>
<span class="lineNum">    1120 </span><span class="lineCov">        100 :         frag_ckck.frag_param.ptype = GF_EVG_TRIANGLES;</span>
<span class="lineNum">    1121 </span>            :         frag_ckck.frag_param.prim_index = 0;
<span class="lineNum">    1122 </span>            : 
<span class="lineNum">    1123 </span><span class="lineCov">        100 :         xmin = raster-&gt;min_ex * ONE_PIXEL;</span>
<span class="lineNum">    1124 </span><span class="lineCov">        100 :         xmax = raster-&gt;max_ex * ONE_PIXEL;</span>
<span class="lineNum">    1125 </span><span class="lineCov">        100 :         ymin = raster-&gt;min_ey * ONE_PIXEL;</span>
<span class="lineNum">    1126 </span><span class="lineCov">        100 :         ymax = raster-&gt;max_ey * ONE_PIXEL;</span>
<span class="lineNum">    1127 </span>            : 
<span class="lineNum">    1128 </span>            :         //raster coordinates of points
<span class="lineNum">    1129 </span>            :         TPos _x1, _y1, _x2, _y2, _x3, _y3;
<span class="lineNum">    1130 </span>            :         /*vertices in raster/window space: x and y are in pixel space, z is [min_depth, max_depth]*/
<span class="lineNum">    1131 </span>            :         GF_Vec4 s_pt1, s_pt2, s_pt3;
<span class="lineNum">    1132 </span>            : 
<span class="lineNum">    1133 </span>            :         /*get bounds, and compute interpolation from (top-left, top-right, bottom-right) vertices*/
<span class="lineNum">    1134 </span><span class="lineCov">        100 :         gf_path_get_bounds(path, &amp;rc);</span>
<span class="lineNum">    1135 </span><span class="lineCov">        100 :         s_pt1.x = rc.x; s_pt1.y = rc.y; s_pt1.z = z; s_pt1.q = 1;</span>
<span class="lineNum">    1136 </span><span class="lineCov">        100 :         s_pt2.x = rc.x + rc.width; s_pt2.y = rc.y; s_pt2.z = z; s_pt2.q = 1;</span>
<span class="lineNum">    1137 </span><span class="lineCov">        100 :         s_pt3.x = rc.x + rc.width; s_pt3.y = rc.y - rc.height ; s_pt3.z = z; s_pt3.q = 1;</span>
<span class="lineNum">    1138 </span>            : 
<span class="lineNum">    1139 </span><span class="lineCov">        100 :         gf_mx_apply_vec_4x4(&amp;projModeView, &amp;s_pt1);</span>
<span class="lineNum">    1140 </span>            :         evg3d_persp_divide(&amp;s_pt1);
<span class="lineNum">    1141 </span><span class="lineCov">        100 :         evg3d_ndc_to_raster(surf, &amp;s_pt1, &amp;_x1, &amp;_y1);</span>
<span class="lineNum">    1142 </span><span class="lineCov">        100 :         gf_mx_apply_vec_4x4(&amp;projModeView, &amp;s_pt2);</span>
<span class="lineNum">    1143 </span>            :         evg3d_persp_divide(&amp;s_pt2);
<span class="lineNum">    1144 </span><span class="lineCov">        100 :         evg3d_ndc_to_raster(surf, &amp;s_pt2, &amp;_x2, &amp;_y2);</span>
<span class="lineNum">    1145 </span><span class="lineCov">        100 :         gf_mx_apply_vec_4x4(&amp;projModeView, &amp;s_pt3);</span>
<span class="lineNum">    1146 </span>            :         evg3d_persp_divide(&amp;s_pt3);
<span class="lineNum">    1147 </span><span class="lineCov">        100 :         evg3d_ndc_to_raster(surf, &amp;s_pt3, &amp;_x3, &amp;_y3);</span>
<span class="lineNum">    1148 </span>            : 
<span class="lineNum">    1149 </span><span class="lineCov">        100 :         if (!precompute_tri(s3d, &amp;frag_ckck, xmin, xmax, ymin, ymax, _x1, _y1, _x2, _y2, _x3, _y3, &amp;s_pt1, &amp;s_pt2, &amp;s_pt3, 0, 1, 2))</span>
<span class="lineNum">    1150 </span>            :                 return GF_OK;
<span class="lineNum">    1151 </span>            : 
<span class="lineNum">    1152 </span><span class="lineCov">        100 :         s3d-&gt;mode2d = GF_TRUE;</span>
<span class="lineNum">    1153 </span>            :         first = 0;
<span class="lineNum">    1154 </span><span class="lineCov">       1700 :         for ( n = 0; n &lt; outline-&gt;n_contours; n++ ) {</span>
<span class="lineNum">    1155 </span>            :                 GF_Vec4 pt;
<span class="lineNum">    1156 </span>            :                 EVG_Vector *point;
<span class="lineNum">    1157 </span>            :                 EVG_Vector *limit;
<span class="lineNum">    1158 </span>            :                 int  last;  /* index of last point in contour */
<span class="lineNum">    1159 </span><span class="lineCov">       1600 :                 last  = outline-&gt;contours[n];</span>
<span class="lineNum">    1160 </span><span class="lineCov">       1600 :                 limit = outline-&gt;points + last;</span>
<span class="lineNum">    1161 </span><span class="lineCov">       1600 :                 v_start = outline-&gt;points[first];</span>
<span class="lineNum">    1162 </span>            :                 point = outline-&gt;points + first;
<span class="lineNum">    1163 </span>            : 
<span class="lineNum">    1164 </span><span class="lineCov">       1600 :                 pt.x = v_start.x;</span>
<span class="lineNum">    1165 </span><span class="lineCov">       1600 :                 pt.y = v_start.y;</span>
<span class="lineNum">    1166 </span><span class="lineCov">       1600 :                 pt.z = z;</span>
<span class="lineNum">    1167 </span><span class="lineCov">       1600 :                 pt.q = 1;</span>
<span class="lineNum">    1168 </span><span class="lineCov">       1600 :                 gf_mx_apply_vec_4x4(&amp;projModeView, &amp;pt);</span>
<span class="lineNum">    1169 </span>            :                 if (!evg3d_persp_divide(&amp;pt)) {
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1171 </span>            :                 }
<span class="lineNum">    1172 </span><span class="lineCov">       1600 :                 evg3d_ndc_to_raster(surf, &amp;pt, &amp;_sx, &amp;_sy);</span>
<span class="lineNum">    1173 </span><span class="lineCov">       1600 :                 gray3d_move_to(raster, _sx, _sy);</span>
<span class="lineNum">    1174 </span><span class="lineCov">      42900 :                 while ( point &lt; limit ) {</span>
<span class="lineNum">    1175 </span><span class="lineCov">      39700 :                         point++;</span>
<span class="lineNum">    1176 </span>            : 
<span class="lineNum">    1177 </span><span class="lineCov">      39700 :                         pt.x = point-&gt;x;</span>
<span class="lineNum">    1178 </span><span class="lineCov">      39700 :                         pt.y = point-&gt;y;</span>
<span class="lineNum">    1179 </span><span class="lineCov">      39700 :                         pt.z = z;</span>
<span class="lineNum">    1180 </span><span class="lineCov">      39700 :                         pt.q = 1;</span>
<span class="lineNum">    1181 </span><span class="lineCov">      39700 :                         gf_mx_apply_vec_4x4(&amp;projModeView, &amp;pt);</span>
<span class="lineNum">    1182 </span>            :                         if (!evg3d_persp_divide(&amp;pt)) {
<span class="lineNum">    1183 </span>            :                                 break;
<span class="lineNum">    1184 </span>            :                         }
<span class="lineNum">    1185 </span><span class="lineCov">      39700 :                         evg3d_ndc_to_raster(surf, &amp;pt, &amp;_x, &amp;_y);</span>
<span class="lineNum">    1186 </span><span class="lineCov">      39700 :                         gray_render_line(raster, _x, _y);</span>
<span class="lineNum">    1187 </span>            :                 }
<span class="lineNum">    1188 </span><span class="lineCov">       1600 :                 gray_render_line(raster, _sx, _sy);</span>
<span class="lineNum">    1189 </span>            : 
<span class="lineNum">    1190 </span><span class="lineCov">       1600 :                 first = last + 1;</span>
<span class="lineNum">    1191 </span>            :         }
<span class="lineNum">    1192 </span>            : 
<span class="lineNum">    1193 </span><span class="lineCov">        100 :         gray_record_cell( raster );</span>
<span class="lineNum">    1194 </span>            :         /* sort each scanline and render it*/
<span class="lineNum">    1195 </span><span class="lineCov">      35816 :         for (li=raster-&gt;first_scanline; li&lt;size_y; li++) {</span>
<span class="lineNum">    1196 </span><span class="lineCov">      35716 :                 AAScanline *sl = &amp;raster-&gt;scanlines[li];</span>
<span class="lineNum">    1197 </span><span class="lineCov">      35716 :                 if (sl-&gt;num) {</span>
<span class="lineNum">    1198 </span><span class="lineCov">       7237 :                         if (sl-&gt;num&gt;1) gray_quick_sort(sl-&gt;cells, sl-&gt;num);</span>
<span class="lineNum">    1199 </span><span class="lineCov">       7237 :                         gray_sweep_line(raster, sl, li, GF_TRUE);</span>
<span class="lineNum">    1200 </span>            :                 }
<span class="lineNum">    1201 </span>            :         }
<span class="lineNum">    1202 </span><span class="lineCov">        100 :         surf-&gt;ext3d-&gt;mode2d = GF_FALSE;</span>
<span class="lineNum">    1203 </span><span class="lineCov">        100 :         return GF_OK;</span>
<a name="1204"><span class="lineNum">    1204 </span>            : </a>
<span class="lineNum">    1205 </span>            : }
<span class="lineNum">    1206 </span><span class="lineCov">         19 : GF_Err evg_3d_resize(GF_EVGSurface *surf)</span>
<span class="lineNum">    1207 </span>            : {
<span class="lineNum">    1208 </span>            : /*      surf-&gt;ext3d-&gt;depth_buffer = gf_realloc(surf-&gt;ext3d-&gt;depth_buffer, sizeof(Float)*surf-&gt;width*surf-&gt;height);
<span class="lineNum">    1209 </span>            :         if (!surf-&gt;ext3d-&gt;depth_buffer) return GF_OUT_OF_MEM;
<span class="lineNum">    1210 </span>            : */
<span class="lineNum">    1211 </span><span class="lineCov">         19 :         surf-&gt;ext3d-&gt;depth_buffer = NULL;</span>
<span class="lineNum">    1212 </span>            : 
<span class="lineNum">    1213 </span><span class="lineCov">         19 :         if (!surf-&gt;ext3d-&gt;vp_w || !surf-&gt;ext3d-&gt;vp_h) {</span>
<span class="lineNum">    1214 </span><span class="lineCov">         19 :                 surf-&gt;ext3d-&gt;vp_x = 0;</span>
<span class="lineNum">    1215 </span><span class="lineCov">         19 :                 surf-&gt;ext3d-&gt;vp_y = 0;</span>
<span class="lineNum">    1216 </span><span class="lineCov">         19 :                 surf-&gt;ext3d-&gt;vp_w = surf-&gt;width;</span>
<span class="lineNum">    1217 </span><span class="lineCov">         19 :                 surf-&gt;ext3d-&gt;vp_h = surf-&gt;height;</span>
<span class="lineNum">    1218 </span>            :         }
<span class="lineNum">    1219 </span><span class="lineCov">         19 :         surf-&gt;ext3d-&gt;pix_vals = gf_realloc(surf-&gt;ext3d-&gt;pix_vals, sizeof(u32)*surf-&gt;width);</span>
<span class="lineNum">    1220 </span><span class="lineCov">         19 :         return GF_OK;</span>
<span class="lineNum">    1221 </span>            : }
<a name="1222"><span class="lineNum">    1222 </span>            : </a>
<span class="lineNum">    1223 </span>            : GF_EXPORT
<span class="lineNum">    1224 </span><span class="lineCov">        226 : GF_Err gf_evg_surface_clear_depth(GF_EVGSurface *surf, Float depth)</span>
<span class="lineNum">    1225 </span>            : {
<span class="lineNum">    1226 </span>            :         u32 i, lsize;
<span class="lineNum">    1227 </span>            :         Float *depths;
<span class="lineNum">    1228 </span>            :         u8 *depth_p;
<span class="lineNum">    1229 </span><span class="lineCov">        226 :         if (!surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1230 </span>            : 
<span class="lineNum">    1231 </span><span class="lineCov">        226 :         depths = surf-&gt;ext3d-&gt;depth_buffer;</span>
<span class="lineNum">    1232 </span><span class="lineCov">        226 :         if (!depths) return GF_OK; //GF_BAD_PARAM;</span>
<span class="lineNum">    1233 </span>            :         //copy first line
<span class="lineNum">    1234 </span><span class="lineCov">     196780 :         for (i=0; i&lt;surf-&gt;width; i++) {</span>
<span class="lineNum">    1235 </span><span class="lineCov">     196780 :                 depths[i] = depth;</span>
<span class="lineNum">    1236 </span>            :         }
<span class="lineNum">    1237 </span>            :         //copy first line
<span class="lineNum">    1238 </span><span class="lineCov">        226 :         depth_p = (u8 *) surf-&gt;ext3d-&gt;depth_buffer;</span>
<span class="lineNum">    1239 </span><span class="lineCov">        226 :         lsize = sizeof(Float) * surf-&gt;width;</span>
<span class="lineNum">    1240 </span><span class="lineCov">     140220 :         for (i=1; i&lt;surf-&gt;height; i++) {</span>
<span class="lineNum">    1241 </span><span class="lineCov">     139994 :                 u8 *depth_l = depth_p + i*lsize;</span>
<span class="lineNum">    1242 </span><span class="lineCov">     139994 :                 memcpy(depth_l, depth_p, lsize);</span>
<span class="lineNum">    1243 </span>            :         }
<span class="lineNum">    1244 </span>            :         return GF_OK;
<span class="lineNum">    1245 </span>            : }
<span class="lineNum">    1246 </span>            : 
<a name="1247"><span class="lineNum">    1247 </span>            : </a>
<span class="lineNum">    1248 </span>            : GF_EXPORT
<span class="lineNum">    1249 </span><span class="lineCov">        226 : GF_Err gf_evg_surface_viewport(GF_EVGSurface *surf, u32 x, u32 y, u32 w, u32 h)</span>
<span class="lineNum">    1250 </span>            : {
<span class="lineNum">    1251 </span><span class="lineCov">        226 :         if (!surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1252 </span><span class="lineCov">        226 :         surf-&gt;ext3d-&gt;vp_x = x;</span>
<span class="lineNum">    1253 </span><span class="lineCov">        226 :         surf-&gt;ext3d-&gt;vp_y = y;</span>
<span class="lineNum">    1254 </span><span class="lineCov">        226 :         surf-&gt;ext3d-&gt;vp_w = w;</span>
<span class="lineNum">    1255 </span><span class="lineCov">        226 :         surf-&gt;ext3d-&gt;vp_h = h;</span>
<span class="lineNum">    1256 </span><span class="lineCov">        226 :         return GF_OK;</span>
<a name="1257"><span class="lineNum">    1257 </span>            : }</a>
<span class="lineNum">    1258 </span>            : 
<span class="lineNum">    1259 </span><span class="lineCov">       9587 : static Bool depth_test_never(Float depth_buf_value, Float frag_value)</span>
<span class="lineNum">    1260 </span>            : {
<a name="1261"><span class="lineNum">    1261 </span><span class="lineCov">       9587 :         return GF_FALSE;</span></a>
<span class="lineNum">    1262 </span>            : }
<span class="lineNum">    1263 </span><span class="lineCov">      20010 : static Bool depth_test_always(Float depth_buf_value, Float frag_value)</span>
<span class="lineNum">    1264 </span>            : {
<a name="1265"><span class="lineNum">    1265 </span><span class="lineCov">      20010 :         return GF_TRUE;</span></a>
<span class="lineNum">    1266 </span>            : }
<span class="lineNum">    1267 </span><span class="lineCov">    4898457 : static Bool depth_test_less(Float depth_buf_value, Float frag_value)</span>
<span class="lineNum">    1268 </span>            : {
<span class="lineNum">    1269 </span><span class="lineCov">    4898457 :         if (frag_value&lt;depth_buf_value) return GF_TRUE;</span>
<a name="1270"><span class="lineNum">    1270 </span><span class="lineCov">      20411 :         return GF_FALSE;</span></a>
<span class="lineNum">    1271 </span>            : }
<span class="lineNum">    1272 </span><span class="lineCov">      10005 : static Bool depth_test_less_equal(Float depth_buf_value, Float frag_value)</span>
<span class="lineNum">    1273 </span>            : {
<span class="lineNum">    1274 </span><span class="lineCov">      10005 :         if (frag_value&lt;=depth_buf_value) return GF_TRUE;</span>
<a name="1275"><span class="lineNum">    1275 </span><span class="lineNoCov">          0 :         return GF_FALSE;</span></a>
<span class="lineNum">    1276 </span>            : }
<span class="lineNum">    1277 </span><span class="lineCov">       9587 : static Bool depth_test_equal(Float depth_buf_value, Float frag_value)</span>
<span class="lineNum">    1278 </span>            : {
<span class="lineNum">    1279 </span><span class="lineCov">       9587 :         if (frag_value==depth_buf_value) return GF_TRUE;</span>
<a name="1280"><span class="lineNum">    1280 </span><span class="lineCov">       9587 :         return GF_FALSE;</span></a>
<span class="lineNum">    1281 </span>            : }
<span class="lineNum">    1282 </span><span class="lineCov">      10005 : static Bool depth_test_greater(Float depth_buf_value, Float frag_value)</span>
<span class="lineNum">    1283 </span>            : {
<span class="lineNum">    1284 </span><span class="lineCov">      10005 :         if (frag_value&gt;depth_buf_value) return GF_TRUE;</span>
<a name="1285"><span class="lineNum">    1285 </span><span class="lineNoCov">          0 :         return GF_FALSE;</span></a>
<span class="lineNum">    1286 </span>            : }
<span class="lineNum">    1287 </span><span class="lineCov">      10005 : static Bool depth_test_greater_equal(Float depth_buf_value, Float frag_value)</span>
<span class="lineNum">    1288 </span>            : {
<span class="lineNum">    1289 </span><span class="lineCov">      10005 :         if (frag_value&gt;=depth_buf_value) return GF_TRUE;</span>
<a name="1290"><span class="lineNum">    1290 </span><span class="lineNoCov">          0 :         return GF_FALSE;</span></a>
<span class="lineNum">    1291 </span>            : }
<span class="lineNum">    1292 </span><span class="lineCov">      10005 : static Bool depth_test_not_equal(Float depth_buf_value, Float frag_value)</span>
<span class="lineNum">    1293 </span>            : {
<span class="lineNum">    1294 </span><span class="lineCov">      10005 :         if (frag_value==depth_buf_value) return GF_FALSE;</span>
<span class="lineNum">    1295 </span><span class="lineCov">      10005 :         return GF_TRUE;</span>
<span class="lineNum">    1296 </span>            : }
<a name="1297"><span class="lineNum">    1297 </span>            : </a>
<span class="lineNum">    1298 </span>            : GF_EXPORT
<span class="lineNum">    1299 </span><span class="lineCov">        226 : GF_Err gf_evg_set_depth_test(GF_EVGSurface *surf, GF_EVGDepthTest mode)</span>
<span class="lineNum">    1300 </span>            : {
<span class="lineNum">    1301 </span><span class="lineCov">        226 :         if (!surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1302 </span><span class="lineCov">        226 :         surf-&gt;ext3d-&gt;write_depth = GF_TRUE;</span>
<span class="lineNum">    1303 </span><span class="lineCov">        226 :         switch (mode) {</span>
<span class="lineNum">    1304 </span><span class="lineCov">          1 :         case GF_EVGDEPTH_NEVER:</span>
<span class="lineNum">    1305 </span><span class="lineCov">          1 :                 surf-&gt;ext3d-&gt;depth_test = depth_test_never;</span>
<span class="lineNum">    1306 </span><span class="lineCov">          1 :                 return GF_OK;</span>
<span class="lineNum">    1307 </span><span class="lineCov">          1 :         case GF_EVGDEPTH_ALWAYS:</span>
<span class="lineNum">    1308 </span><span class="lineCov">          1 :                 surf-&gt;ext3d-&gt;depth_test = depth_test_always;</span>
<span class="lineNum">    1309 </span><span class="lineCov">          1 :                 return GF_OK;</span>
<span class="lineNum">    1310 </span><span class="lineCov">          1 :         case GF_EVGDEPTH_EQUAL:</span>
<span class="lineNum">    1311 </span><span class="lineCov">          1 :                 surf-&gt;ext3d-&gt;depth_test = depth_test_equal;</span>
<span class="lineNum">    1312 </span><span class="lineCov">          1 :                 return GF_OK;</span>
<span class="lineNum">    1313 </span><span class="lineCov">          1 :         case GF_EVGDEPTH_NEQUAL:</span>
<span class="lineNum">    1314 </span><span class="lineCov">          1 :                 surf-&gt;ext3d-&gt;depth_test = depth_test_not_equal;</span>
<span class="lineNum">    1315 </span><span class="lineCov">          1 :                 return GF_OK;</span>
<span class="lineNum">    1316 </span><span class="lineCov">        218 :         case GF_EVGDEPTH_LESS:</span>
<span class="lineNum">    1317 </span><span class="lineCov">        218 :                 surf-&gt;ext3d-&gt;depth_test = depth_test_less;</span>
<span class="lineNum">    1318 </span><span class="lineCov">        218 :                 return GF_OK;</span>
<span class="lineNum">    1319 </span><span class="lineCov">          1 :         case GF_EVGDEPTH_LESS_EQUAL:</span>
<span class="lineNum">    1320 </span><span class="lineCov">          1 :                 surf-&gt;ext3d-&gt;depth_test = depth_test_less_equal;</span>
<span class="lineNum">    1321 </span><span class="lineCov">          1 :                 return GF_OK;</span>
<span class="lineNum">    1322 </span><span class="lineCov">          1 :         case GF_EVGDEPTH_GREATER:</span>
<span class="lineNum">    1323 </span><span class="lineCov">          1 :                 surf-&gt;ext3d-&gt;depth_test = depth_test_greater;</span>
<span class="lineNum">    1324 </span><span class="lineCov">          1 :                 return GF_OK;</span>
<span class="lineNum">    1325 </span><span class="lineCov">          1 :         case GF_EVGDEPTH_GREATER_EQUAL:</span>
<span class="lineNum">    1326 </span><span class="lineCov">          1 :                 surf-&gt;ext3d-&gt;depth_test = depth_test_greater_equal;</span>
<span class="lineNum">    1327 </span><span class="lineCov">          1 :                 return GF_OK;</span>
<span class="lineNum">    1328 </span><span class="lineCov">          1 :         case GF_EVGDEPTH_DISABLE:</span>
<span class="lineNum">    1329 </span><span class="lineCov">          1 :                 surf-&gt;ext3d-&gt;depth_test = depth_test_always;</span>
<span class="lineNum">    1330 </span><span class="lineCov">          1 :                 surf-&gt;ext3d-&gt;write_depth = GF_FALSE;</span>
<span class="lineNum">    1331 </span><span class="lineCov">          1 :                 return GF_OK;</span>
<span class="lineNum">    1332 </span>            :         }
<span class="lineNum">    1333 </span>            :         return GF_BAD_PARAM;
<span class="lineNum">    1334 </span>            : 
<a name="1335"><span class="lineNum">    1335 </span>            : }</a>
<span class="lineNum">    1336 </span>            : 
<span class="lineNum">    1337 </span><span class="lineCov">        164 : GF_Err evg_3d_update_depth_range(GF_EVGSurface *surf)</span>
<span class="lineNum">    1338 </span>            : {
<span class="lineNum">    1339 </span><span class="lineCov">        164 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1340 </span><span class="lineCov">        145 :         surf-&gt;ext3d-&gt;depth_range = surf-&gt;ext3d-&gt;max_depth - surf-&gt;ext3d-&gt;min_depth;</span>
<span class="lineNum">    1341 </span><span class="lineCov">        145 :         if (surf-&gt;ext3d-&gt;clip_zero) {</span>
<span class="lineNum">    1342 </span><span class="lineCov">        145 :                 surf-&gt;ext3d-&gt;zw_factor = surf-&gt;ext3d-&gt;depth_range;</span>
<span class="lineNum">    1343 </span><span class="lineCov">        145 :                 surf-&gt;ext3d-&gt;zw_offset = surf-&gt;ext3d-&gt;min_depth;</span>
<span class="lineNum">    1344 </span>            :         } else {
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :                 surf-&gt;ext3d-&gt;zw_factor = surf-&gt;ext3d-&gt;depth_range / 2;</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :                 surf-&gt;ext3d-&gt;zw_offset = (surf-&gt;ext3d-&gt;min_depth+surf-&gt;ext3d-&gt;max_depth)/2;</span>
<span class="lineNum">    1347 </span>            : 
<span class="lineNum">    1348 </span>            :         }
<span class="lineNum">    1349 </span>            :         return GF_OK;
<a name="1350"><span class="lineNum">    1350 </span>            : }</a>
<span class="lineNum">    1351 </span>            : 
<span class="lineNum">    1352 </span><span class="lineCov">     238255 : static void yuv_3d_fill_run(GF_EVGStencil *p, GF_EVGSurface *surf, s32 _x, s32 _y, u32 count)</span>
<span class="lineNum">    1353 </span>            : {
<span class="lineNum">    1354 </span><span class="lineCov">     238255 :         u32 *data = surf-&gt;stencil_pix_run;</span>
<span class="lineNum">    1355 </span><span class="lineCov">     238255 :         u32 *src = surf-&gt;ext3d-&gt;pix_vals + _x;</span>
<span class="lineNum">    1356 </span>            : 
<span class="lineNum">    1357 </span><span class="lineCov">     238255 :         memcpy(data, src, sizeof(u32)*count);</span>
<a name="1358"><span class="lineNum">    1358 </span><span class="lineCov">     238255 : }</span></a>
<span class="lineNum">    1359 </span>            : 
<span class="lineNum">    1360 </span><span class="lineCov">         19 : EVG_Surface3DExt *evg_init_3d_surface(GF_EVGSurface *surf)</span>
<span class="lineNum">    1361 </span>            : {
<span class="lineNum">    1362 </span>            :         EVG_Surface3DExt *ext3d;
<span class="lineNum">    1363 </span><span class="lineCov">         19 :         GF_SAFEALLOC(ext3d, EVG_Surface3DExt);</span>
<span class="lineNum">    1364 </span><span class="lineCov">         19 :         if (!ext3d) return NULL;</span>
<span class="lineNum">    1365 </span><span class="lineCov">         38 :         gf_mx_init(ext3d-&gt;proj);</span>
<span class="lineNum">    1366 </span><span class="lineCov">         38 :         gf_mx_init(ext3d-&gt;modelview);</span>
<span class="lineNum">    1367 </span><span class="lineCov">         19 :         ext3d-&gt;backface_cull = GF_TRUE;</span>
<span class="lineNum">    1368 </span><span class="lineCov">         19 :         ext3d-&gt;is_ccw = GF_TRUE;</span>
<span class="lineNum">    1369 </span><span class="lineCov">         19 :         ext3d-&gt;min_depth = 0;</span>
<span class="lineNum">    1370 </span><span class="lineCov">         19 :         ext3d-&gt;max_depth = FIX_ONE;</span>
<span class="lineNum">    1371 </span><span class="lineCov">         19 :         ext3d-&gt;depth_range = FIX_ONE;</span>
<span class="lineNum">    1372 </span><span class="lineCov">         19 :         ext3d-&gt;point_size = FIX_ONE;</span>
<span class="lineNum">    1373 </span><span class="lineCov">         19 :         ext3d-&gt;line_size = FIX_ONE;</span>
<span class="lineNum">    1374 </span><span class="lineCov">         19 :         ext3d-&gt;clip_zero = GF_FALSE;</span>
<span class="lineNum">    1375 </span><span class="lineCov">         19 :         ext3d-&gt;disable_aa = GF_FALSE;</span>
<span class="lineNum">    1376 </span><span class="lineCov">         19 :         ext3d-&gt;write_depth = GF_TRUE;</span>
<span class="lineNum">    1377 </span><span class="lineCov">         19 :         ext3d-&gt;early_depth_test = GF_TRUE;</span>
<span class="lineNum">    1378 </span><span class="lineCov">         19 :         ext3d-&gt;depth_test = depth_test_less;</span>
<span class="lineNum">    1379 </span><span class="lineCov">         19 :         ext3d-&gt;yuv_sten.fill_run = yuv_3d_fill_run;</span>
<span class="lineNum">    1380 </span><span class="lineCov">         19 :         evg_3d_update_depth_range(surf);</span>
<span class="lineNum">    1381 </span><span class="lineCov">         19 :         return ext3d;</span>
<span class="lineNum">    1382 </span>            : }
<span class="lineNum">    1383 </span>            : 
<a name="1384"><span class="lineNum">    1384 </span>            : </a>
<span class="lineNum">    1385 </span>            : 
<span class="lineNum">    1386 </span><span class="lineCov">        326 : GF_Err gf_evg_surface_set_fragment_shader(GF_EVGSurface *surf, gf_evg_fragment_shader shader, void *shader_udta)</span>
<span class="lineNum">    1387 </span>            : {
<span class="lineNum">    1388 </span><span class="lineCov">        326 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1389 </span><span class="lineCov">        326 :         surf-&gt;ext3d-&gt;frag_shader = shader;</span>
<span class="lineNum">    1390 </span><span class="lineCov">        326 :         surf-&gt;ext3d-&gt;frag_shader_udta = shader_udta;</span>
<span class="lineNum">    1391 </span><span class="lineCov">        326 :         return GF_OK;</span>
<a name="1392"><span class="lineNum">    1392 </span>            : }</a>
<span class="lineNum">    1393 </span>            : 
<span class="lineNum">    1394 </span><span class="lineCov">        326 : GF_Err gf_evg_surface_disable_early_depth(GF_EVGSurface *surf, Bool disable)</span>
<span class="lineNum">    1395 </span>            : {
<span class="lineNum">    1396 </span><span class="lineCov">        326 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1397 </span><span class="lineCov">        326 :         surf-&gt;ext3d-&gt;early_depth_test = !disable;</span>
<span class="lineNum">    1398 </span><span class="lineCov">        326 :         return GF_OK;</span>
<a name="1399"><span class="lineNum">    1399 </span>            : }</a>
<span class="lineNum">    1400 </span>            : 
<span class="lineNum">    1401 </span><span class="lineCov">        225 : GF_Err gf_evg_surface_set_vertex_shader(GF_EVGSurface *surf, gf_evg_vertex_shader shader, void *shader_udta)</span>
<span class="lineNum">    1402 </span>            : {
<span class="lineNum">    1403 </span><span class="lineCov">        225 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1404 </span><span class="lineCov">        225 :         surf-&gt;ext3d-&gt;vert_shader = shader;</span>
<span class="lineNum">    1405 </span><span class="lineCov">        225 :         surf-&gt;ext3d-&gt;vert_shader_udta = shader_udta;</span>
<span class="lineNum">    1406 </span><span class="lineCov">        225 :         return GF_OK;</span>
<a name="1407"><span class="lineNum">    1407 </span>            : }</a>
<span class="lineNum">    1408 </span>            : 
<span class="lineNum">    1409 </span><span class="lineCov">         10 : GF_Err gf_evg_surface_set_ccw(GF_EVGSurface *surf, Bool is_ccw)</span>
<span class="lineNum">    1410 </span>            : {
<span class="lineNum">    1411 </span><span class="lineCov">         10 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1412 </span><span class="lineCov">         10 :         surf-&gt;ext3d-&gt;is_ccw = is_ccw;</span>
<a name="1413"><span class="lineNum">    1413 </span><span class="lineCov">         10 :         return GF_OK;</span></a>
<span class="lineNum">    1414 </span>            : }
<span class="lineNum">    1415 </span><span class="lineCov">        226 : GF_Err gf_evg_surface_set_backcull(GF_EVGSurface *surf, Bool backcull)</span>
<span class="lineNum">    1416 </span>            : {
<span class="lineNum">    1417 </span><span class="lineCov">        226 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1418 </span><span class="lineCov">        226 :         surf-&gt;ext3d-&gt;backface_cull = backcull;</span>
<a name="1419"><span class="lineNum">    1419 </span><span class="lineCov">        226 :         return GF_OK;</span></a>
<span class="lineNum">    1420 </span>            : }
<span class="lineNum">    1421 </span><span class="lineCov">        226 : GF_Err gf_evg_surface_set_antialias(GF_EVGSurface *surf, Bool antialias)</span>
<span class="lineNum">    1422 </span>            : {
<span class="lineNum">    1423 </span><span class="lineCov">        226 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1424 </span><span class="lineCov">        226 :         surf-&gt;ext3d-&gt;disable_aa = antialias ? GF_FALSE : GF_TRUE;</span>
<a name="1425"><span class="lineNum">    1425 </span><span class="lineCov">        226 :         return GF_OK;</span></a>
<span class="lineNum">    1426 </span>            : }
<span class="lineNum">    1427 </span><span class="lineCov">         10 : GF_Err gf_evg_surface_set_min_depth(GF_EVGSurface *surf, Float min_depth)</span>
<span class="lineNum">    1428 </span>            : {
<span class="lineNum">    1429 </span><span class="lineCov">         10 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1430 </span><span class="lineCov">         10 :         surf-&gt;ext3d-&gt;min_depth = min_depth;</span>
<span class="lineNum">    1431 </span><span class="lineCov">         10 :         evg_3d_update_depth_range(surf);</span>
<a name="1432"><span class="lineNum">    1432 </span><span class="lineCov">         10 :         return GF_OK;</span></a>
<span class="lineNum">    1433 </span>            : }
<span class="lineNum">    1434 </span><span class="lineCov">         10 : GF_Err gf_evg_surface_set_max_depth(GF_EVGSurface *surf, Float max_depth)</span>
<span class="lineNum">    1435 </span>            : {
<span class="lineNum">    1436 </span><span class="lineCov">         10 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1437 </span><span class="lineCov">         10 :         surf-&gt;ext3d-&gt;max_depth = max_depth;</span>
<span class="lineNum">    1438 </span><span class="lineCov">         10 :         evg_3d_update_depth_range(surf);</span>
<span class="lineNum">    1439 </span><span class="lineCov">         10 :         return GF_OK;</span>
<a name="1440"><span class="lineNum">    1440 </span>            : }</a>
<span class="lineNum">    1441 </span>            : 
<span class="lineNum">    1442 </span><span class="lineCov">        125 : GF_Err gf_evg_surface_set_clip_zero(GF_EVGSurface *surf, Bool clip_zero)</span>
<span class="lineNum">    1443 </span>            : {
<span class="lineNum">    1444 </span><span class="lineCov">        125 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1445 </span><span class="lineCov">        125 :         surf-&gt;ext3d-&gt;clip_zero = clip_zero;</span>
<span class="lineNum">    1446 </span><span class="lineCov">        125 :         evg_3d_update_depth_range(surf);</span>
<span class="lineNum">    1447 </span><span class="lineCov">        125 :         return GF_OK;</span>
<a name="1448"><span class="lineNum">    1448 </span>            : }</a>
<span class="lineNum">    1449 </span>            : 
<span class="lineNum">    1450 </span><span class="lineCov">         10 : GF_Err gf_evg_surface_set_point_size(GF_EVGSurface *surf, Float size)</span>
<span class="lineNum">    1451 </span>            : {
<span class="lineNum">    1452 </span><span class="lineCov">         10 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1453 </span><span class="lineCov">         10 :         surf-&gt;ext3d-&gt;point_size = size;</span>
<a name="1454"><span class="lineNum">    1454 </span><span class="lineCov">         10 :         return GF_OK;</span></a>
<span class="lineNum">    1455 </span>            : }
<span class="lineNum">    1456 </span><span class="lineCov">         10 : GF_Err gf_evg_surface_set_line_size(GF_EVGSurface *surf, Float size)</span>
<span class="lineNum">    1457 </span>            : {
<span class="lineNum">    1458 </span><span class="lineCov">         10 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1459 </span><span class="lineCov">         10 :         surf-&gt;ext3d-&gt;line_size = size;</span>
<a name="1460"><span class="lineNum">    1460 </span><span class="lineCov">         10 :         return GF_OK;</span></a>
<span class="lineNum">    1461 </span>            : }
<span class="lineNum">    1462 </span><span class="lineCov">         10 : GF_Err gf_evg_surface_set_point_smooth(GF_EVGSurface *surf, Bool smooth)</span>
<span class="lineNum">    1463 </span>            : {
<span class="lineNum">    1464 </span><span class="lineCov">         10 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1465 </span><span class="lineCov">         10 :         surf-&gt;ext3d-&gt;smooth_points = smooth;</span>
<span class="lineNum">    1466 </span><span class="lineCov">         10 :         return GF_OK;</span>
<a name="1467"><span class="lineNum">    1467 </span>            : }</a>
<span class="lineNum">    1468 </span>            : 
<span class="lineNum">    1469 </span><span class="lineCov">         10 : GF_Err gf_evg_surface_write_depth(GF_EVGSurface *surf, Bool do_write)</span>
<span class="lineNum">    1470 </span>            : {
<span class="lineNum">    1471 </span><span class="lineCov">         10 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1472 </span><span class="lineCov">         10 :         surf-&gt;ext3d-&gt;write_depth = do_write;</span>
<a name="1473"><span class="lineNum">    1473 </span><span class="lineCov">         10 :         return GF_OK;</span></a>
<span class="lineNum">    1474 </span>            : }
<span class="lineNum">    1475 </span><span class="lineCov">         19 : GF_Err gf_evg_surface_set_depth_buffer(GF_EVGSurface *surf, Float *depth)</span>
<span class="lineNum">    1476 </span>            : {
<span class="lineNum">    1477 </span><span class="lineCov">         19 :         if (!surf || !surf-&gt;ext3d) return GF_BAD_PARAM;</span>
<span class="lineNum">    1478 </span><span class="lineCov">         19 :         surf-&gt;ext3d-&gt;depth_buffer = depth;</span>
<span class="lineNum">    1479 </span><span class="lineCov">         19 :         return GF_OK;</span>
<span class="lineNum">    1480 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - compositor/compositor_2d.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">compositor</a> - compositor_2d.c<span style="font-size: 80%;"> (source / <a href="compositor_2d.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">490</td>
            <td class="headerCovTableEntry">735</td>
            <td class="headerCovTableEntryLo">66.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">23</td>
            <td class="headerCovTableEntry">23</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2000-2020
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / Scene Compositor sub-project
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #include &quot;visual_manager.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;nodes_stacks.h&quot;
<span class="lineNum">      30 </span>            : #include &lt;gpac/options.h&gt;
<span class="lineNum">      31 </span>            : #include &quot;texturing.h&quot;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : #include &quot;gl_inc.h&quot;
<span class="lineNum">      34 </span>            : 
<a name="35"><span class="lineNum">      35 </span>            : </a>
<span class="lineNum">      36 </span>            : #ifndef GPAC_DISABLE_3D
<span class="lineNum">      37 </span><span class="lineCov">       1769 : void compositor_2d_hybgl_clear_surface(GF_VisualManager *visual, GF_IRect *rc, u32 BackColor, u32 is_offscreen_clear)</span>
<span class="lineNum">      38 </span>            : {
<span class="lineNum">      39 </span>            :         SFColor rgb;
<span class="lineNum">      40 </span><span class="lineCov">       1769 :         Fixed alpha = INT2FIX( GF_COL_A(BackColor) )/255;</span>
<span class="lineNum">      41 </span><span class="lineCov">       1769 :         if (!visual-&gt;is_attached) return;</span>
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span><span class="lineCov">       1769 :         if (!BackColor &amp;&amp; !visual-&gt;offscreen &amp;&amp; !is_offscreen_clear) {</span>
<span class="lineNum">      44 </span><span class="lineCov">        571 :                 if ( !(visual-&gt;compositor-&gt;init_flags &amp; GF_TERM_WINDOW_TRANSPARENT)) {</span>
<span class="lineNum">      45 </span><span class="lineCov">        571 :                         BackColor = visual-&gt;compositor-&gt;back_color &amp; 0x00FFFFFF;</span>
<span class="lineNum">      46 </span>            :                 }
<span class="lineNum">      47 </span>            :         }
<span class="lineNum">      48 </span><span class="lineCov">       1769 :         if (is_offscreen_clear) {</span>
<span class="lineNum">      49 </span><span class="lineCov">        996 :                 gf_evg_surface_clear(visual-&gt;raster_surface, rc, BackColor);</span>
<span class="lineNum">      50 </span>            :                 //if we clear the canvas with non-0 alpha, remember the area cleared in case we have to erase it later (overlapping bitmap)
<span class="lineNum">      51 </span>            :                 //if we clear dirty area of the canvas, remember the area to force gl flush 
<span class="lineNum">      52 </span><span class="lineCov">        996 :                 if (GF_COL_A(BackColor) || (is_offscreen_clear==2))</span>
<span class="lineNum">      53 </span>            :                 {
<span class="lineNum">      54 </span><span class="lineCov">        592 :                         ra_union_rect(&amp;visual-&gt;hybgl_drawn, rc);</span>
<span class="lineNum">      55 </span>            :                 }
<span class="lineNum">      56 </span>            :         } else {
<span class="lineNum">      57 </span><span class="lineCov">        773 :                 rgb.red = INT2FIX( GF_COL_R(BackColor) ) / 255;</span>
<span class="lineNum">      58 </span><span class="lineCov">        773 :                 rgb.green = INT2FIX( GF_COL_G(BackColor) )/255;</span>
<span class="lineNum">      59 </span><span class="lineCov">        773 :                 rgb.blue = INT2FIX( GF_COL_B(BackColor) )/255;</span>
<span class="lineNum">      60 </span><span class="lineCov">        773 :                 visual_3d_clear(visual, rgb , alpha);</span>
<span class="lineNum">      61 </span>            :         }
<span class="lineNum">      62 </span>            : }
<a name="63"><span class="lineNum">      63 </span>            : </a>
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span><span class="lineCov">       1963 : void compositor_2d_hybgl_flush_video(GF_Compositor *compositor, GF_IRect *area)</span>
<span class="lineNum">      66 </span>            : {
<span class="lineNum">      67 </span>            :         GF_TraverseState a_tr_state;
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span>            :         //check if texture data has changed - if so, mark texture to be updated
<span class="lineNum">      70 </span><span class="lineCov">       1963 :         if (compositor-&gt;traverse_state-&gt;immediate_draw) {</span>
<span class="lineNum">      71 </span>            :                 //nothing drawn, nothing to do
<span class="lineNum">      72 </span><span class="lineCov">        157 :                 if (!compositor-&gt;visual-&gt;hybgl_drawn.count) {</span>
<span class="lineNum">      73 </span><span class="lineCov">         11 :                         return;</span>
<span class="lineNum">      74 </span>            :                 }
<span class="lineNum">      75 </span>            :                 //nodes where drawn on canvas, push texture
<span class="lineNum">      76 </span><span class="lineCov">        146 :                 gf_sc_texture_set_data(compositor-&gt;hybgl_txh);</span>
<span class="lineNum">      77 </span>            :         } else {
<span class="lineNum">      78 </span>            :                 //nodes where drawn on canvas, push texture
<span class="lineNum">      79 </span><span class="lineCov">       1806 :                 if (compositor-&gt;visual-&gt;hybgl_drawn.count) {</span>
<span class="lineNum">      80 </span>            :                         //we could actually use texSubImage here, but we would need either to copy the data before pushing it or use current stride which will result in pushing too much data ...
<span class="lineNum">      81 </span><span class="lineCov">       1735 :                         gf_sc_texture_set_data(compositor-&gt;hybgl_txh);</span>
<span class="lineNum">      82 </span>            :                 }
<span class="lineNum">      83 </span>            :         }
<span class="lineNum">      84 </span>            :         //if no object drawn since the last flush, no need to draw the texture
<span class="lineNum">      85 </span><span class="lineCov">       1952 :         if (!compositor-&gt;visual-&gt;nb_objects_on_canvas_since_last_ogl_flush)</span>
<span class="lineNum">      86 </span>            :                 goto exit;
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            :         memset(&amp;a_tr_state, 0, sizeof(GF_TraverseState));
<span class="lineNum">      89 </span><span class="lineCov">       1774 :         a_tr_state.color_mat.identity = 1;</span>
<span class="lineNum">      90 </span><span class="lineCov">       1774 :         a_tr_state.visual = compositor-&gt;visual;</span>
<span class="lineNum">      91 </span><span class="lineCov">       1774 :         a_tr_state.camera = &amp;compositor-&gt;visual-&gt;camera;</span>
<span class="lineNum">      92 </span><span class="lineCov">       1774 :         gf_mx_init(a_tr_state.model_matrix);</span>
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span><span class="lineCov">       1774 :         visual_3d_set_state(compositor-&gt;visual, V3D_STATE_LIGHT, GF_FALSE);</span>
<span class="lineNum">      95 </span><span class="lineCov">       1774 :         visual_3d_enable_antialias(compositor-&gt;visual, GF_FALSE);</span>
<span class="lineNum">      96 </span><span class="lineCov">       1774 :         gf_sc_texture_set_blend_mode(compositor-&gt;hybgl_txh, TX_MODULATE);</span>
<span class="lineNum">      97 </span>            :         //visual_3d_set_material_2d_argb(compositor-&gt;visual, 0xFFFFFFFF);
<span class="lineNum">      98 </span><span class="lineCov">       1774 :         compositor-&gt;visual-&gt;has_material_2d = GF_FALSE;</span>
<span class="lineNum">      99 </span><span class="lineCov">       1774 :         a_tr_state.mesh_num_textures = gf_sc_texture_enable(compositor-&gt;hybgl_txh, NULL);</span>
<span class="lineNum">     100 </span><span class="lineCov">       1774 :         if (a_tr_state.mesh_num_textures ) {</span>
<span class="lineNum">     101 </span><span class="lineCov">       1774 :                 if (area) {</span>
<span class="lineNum">     102 </span>            :                         u32 i;
<span class="lineNum">     103 </span>            :                         Fixed umin, umax, vmin, vmax;
<span class="lineNum">     104 </span>            :                         SFVec2f size, orig;
<span class="lineNum">     105 </span><span class="lineCov">        740 :                         size.x = INT2FIX(area-&gt;width);</span>
<span class="lineNum">     106 </span><span class="lineCov">        740 :                         size.y = INT2FIX(area-&gt;height);</span>
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineCov">        740 :                         orig.x = INT2FIX(area-&gt;x);</span>
<span class="lineNum">     109 </span><span class="lineCov">        740 :                         orig.y = INT2FIX(area-&gt;y);</span>
<span class="lineNum">     110 </span><span class="lineCov">        740 :                         mesh_new_rectangle(compositor-&gt;hybgl_mesh, size, &amp;orig, GF_TRUE);</span>
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span><span class="lineCov">        740 :                         orig.x = INT2FIX(area-&gt;x) + INT2FIX(compositor-&gt;vp_width)/2;</span>
<span class="lineNum">     113 </span><span class="lineCov">        740 :                         orig.y = INT2FIX(compositor-&gt;vp_height)/2 - INT2FIX(area-&gt;y) + INT2FIX(area-&gt;height);</span>
<span class="lineNum">     114 </span>            :                         //set our coor texture so that we update only the right part of the canvas
<span class="lineNum">     115 </span><span class="lineCov">        740 :                         umin = gf_divfix(orig.x, INT2FIX(compositor-&gt;vp_width));</span>
<span class="lineNum">     116 </span><span class="lineCov">        740 :                         umax = gf_divfix(orig.x+size.x, INT2FIX(compositor-&gt;vp_width));</span>
<span class="lineNum">     117 </span><span class="lineCov">        740 :                         vmin = gf_divfix(orig.y-size.y, INT2FIX(compositor-&gt;vp_height));</span>
<span class="lineNum">     118 </span><span class="lineCov">        740 :                         vmax = gf_divfix(orig.y, INT2FIX(compositor-&gt;vp_height));</span>
<span class="lineNum">     119 </span>            : 
<span class="lineNum">     120 </span><span class="lineCov">       3700 :                         for (i=0; i&lt;compositor-&gt;hybgl_mesh-&gt;v_count; i++) {</span>
<span class="lineNum">     121 </span><span class="lineCov">       2960 :                                 if (compositor-&gt;hybgl_mesh-&gt;vertices[i].texcoords.x == FIX_ONE) {</span>
<span class="lineNum">     122 </span><span class="lineCov">       1480 :                                         compositor-&gt;hybgl_mesh-&gt;vertices[i].texcoords.x = umax;</span>
<span class="lineNum">     123 </span>            :                                 } else {
<span class="lineNum">     124 </span><span class="lineCov">       1480 :                                         compositor-&gt;hybgl_mesh-&gt;vertices[i].texcoords.x = umin;</span>
<span class="lineNum">     125 </span>            :                                 }
<span class="lineNum">     126 </span><span class="lineCov">       2960 :                                 if (compositor-&gt;hybgl_mesh-&gt;vertices[i].texcoords.y == FIX_ONE) {</span>
<span class="lineNum">     127 </span><span class="lineCov">       1480 :                                         compositor-&gt;hybgl_mesh-&gt;vertices[i].texcoords.y = vmax;</span>
<span class="lineNum">     128 </span>            :                                 } else {
<span class="lineNum">     129 </span><span class="lineCov">       1480 :                                         compositor-&gt;hybgl_mesh-&gt;vertices[i].texcoords.y = vmin;</span>
<span class="lineNum">     130 </span>            :                                 }
<span class="lineNum">     131 </span>            :                         }
<span class="lineNum">     132 </span>            :                 }
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span><span class="lineCov">       1774 :                 visual_3d_mesh_paint(&amp;a_tr_state, compositor-&gt;hybgl_mesh);</span>
<span class="lineNum">     135 </span><span class="lineCov">       1774 :                 gf_sc_texture_disable(compositor-&gt;hybgl_txh);</span>
<span class="lineNum">     136 </span>            : 
<span class="lineNum">     137 </span><span class="lineCov">       1774 :                 if (area) {</span>
<span class="lineNum">     138 </span>            :                         SFVec2f size;
<span class="lineNum">     139 </span><span class="lineCov">        740 :                         size.x = INT2FIX(compositor-&gt;vp_width);</span>
<span class="lineNum">     140 </span><span class="lineCov">        740 :                         size.y = INT2FIX(compositor-&gt;vp_height);</span>
<span class="lineNum">     141 </span><span class="lineCov">        740 :                         mesh_new_rectangle(compositor-&gt;hybgl_mesh, size, NULL, GF_TRUE);</span>
<span class="lineNum">     142 </span>            :                 }
<span class="lineNum">     143 </span>            :         }
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span><span class="lineCov">       3164 : exit:</span>
<span class="lineNum">     146 </span>            :         //in immediate mode always clear the canvas
<span class="lineNum">     147 </span><span class="lineCov">       1952 :         if (compositor-&gt;traverse_state-&gt;immediate_draw) {</span>
<span class="lineNum">     148 </span><span class="lineCov">        146 :                 compositor-&gt;visual-&gt;hybgl_drawn.count = 0;</span>
<span class="lineNum">     149 </span>            :                 //partial flush, reset
<span class="lineNum">     150 </span><span class="lineCov">        146 :                 if (area)</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :                         memset(compositor-&gt;hybgl_txh-&gt;data, 0, compositor-&gt;hybgl_txh-&gt;stride*compositor-&gt;hybgl_txh-&gt;height);</span>
<span class="lineNum">     152 </span>            :         }
<span class="lineNum">     153 </span>            :         //complete flush (end of frame)
<span class="lineNum">     154 </span><span class="lineCov">       1806 :         else if (!area) {</span>
<span class="lineNum">     155 </span><span class="lineCov">        915 :                 compositor-&gt;visual-&gt;hybgl_drawn.count = 0;</span>
<span class="lineNum">     156 </span>            :         }
<span class="lineNum">     157 </span><span class="lineCov">       1952 :         compositor-&gt;visual-&gt;nb_objects_on_canvas_since_last_ogl_flush = 0;</span>
<a name="158"><span class="lineNum">     158 </span>            : }</a>
<span class="lineNum">     159 </span>            : 
<span class="lineNum">     160 </span><span class="lineCov">        697 : Bool compositor_2d_hybgl_draw_bitmap(GF_VisualManager *visual, GF_TraverseState *tr_state, DrawableContext *ctx)</span>
<span class="lineNum">     161 </span>            : {
<span class="lineNum">     162 </span>            :         GF_Node *txtrans = NULL;
<span class="lineNum">     163 </span>            :         //for anything but background use regular routines
<span class="lineNum">     164 </span><span class="lineCov">        697 :         if (!(ctx-&gt;flags &amp; CTX_IS_BACKGROUND)) return GF_FALSE;</span>
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            : #ifndef GPAC_DISABLE_VRML
<span class="lineNum">     167 </span><span class="lineCov">        464 :         if (tr_state-&gt;appear ) txtrans = ((M_Appearance *)tr_state-&gt;appear)-&gt;textureTransform;</span>
<span class="lineNum">     168 </span>            : #endif
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span>            :         /*ignore texture transform for bitmap*/
<span class="lineNum">     171 </span><span class="lineCov">        464 :         tr_state-&gt;mesh_num_textures = gf_sc_texture_enable(ctx-&gt;aspect.fill_texture, txtrans);</span>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span><span class="lineCov">        464 :         if (tr_state-&gt;mesh_num_textures) {</span>
<span class="lineNum">     174 </span>            :                 SFVec2f size, orig;
<span class="lineNum">     175 </span><span class="lineCov">        442 :                 size.x = ctx-&gt;bi-&gt;unclip.width;</span>
<span class="lineNum">     176 </span><span class="lineCov">        442 :                 size.y = ctx-&gt;bi-&gt;unclip.height;</span>
<span class="lineNum">     177 </span><span class="lineCov">        442 :                 orig.x = ctx-&gt;bi-&gt;unclip.x ;</span>
<span class="lineNum">     178 </span><span class="lineCov">        442 :                 orig.y = ctx-&gt;bi-&gt;unclip.y;</span>
<span class="lineNum">     179 </span><span class="lineCov">        442 :                 mesh_new_rectangle(visual-&gt;compositor-&gt;hybgl_mesh_background, size, &amp;orig, GF_FALSE);</span>
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span><span class="lineCov">        442 :                 visual_3d_mesh_paint(tr_state, visual-&gt;compositor-&gt;hybgl_mesh_background);</span>
<span class="lineNum">     182 </span><span class="lineCov">        442 :                 gf_sc_texture_disable(ctx-&gt;aspect.fill_texture);</span>
<span class="lineNum">     183 </span><span class="lineCov">        442 :                 tr_state-&gt;mesh_num_textures = 0;</span>
<span class="lineNum">     184 </span>            :         }
<span class="lineNum">     185 </span>            :         return GF_TRUE;
<span class="lineNum">     186 </span>            : }
<span class="lineNum">     187 </span>            : #endif
<a name="188"><span class="lineNum">     188 </span>            : </a>
<span class="lineNum">     189 </span>            : #ifndef GPAC_DISABLE_3D
<span class="lineNum">     190 </span><span class="lineCov">        605 : void compositor_2d_reset_gl_auto(GF_Compositor *compositor)</span>
<span class="lineNum">     191 </span>            : {
<span class="lineNum">     192 </span><span class="lineCov">        605 :         if (compositor-&gt;hybgl_txh) {</span>
<span class="lineNum">     193 </span><span class="lineCov">         17 :                 if (compositor-&gt;hybgl_txh-&gt;data) {</span>
<span class="lineNum">     194 </span><span class="lineCov">         17 :                         gf_free(compositor-&gt;hybgl_txh-&gt;data);</span>
<span class="lineNum">     195 </span><span class="lineCov">         17 :                         compositor-&gt;hybgl_txh-&gt;data = NULL;</span>
<span class="lineNum">     196 </span>            :                 }
<span class="lineNum">     197 </span><span class="lineCov">         17 :                 if (compositor-&gt;hybgl_txh-&gt;tx_io)</span>
<span class="lineNum">     198 </span><span class="lineCov">         17 :                         gf_sc_texture_release(compositor-&gt;hybgl_txh);</span>
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span><span class="lineCov">         17 :                 gf_free(compositor-&gt;hybgl_txh);</span>
<span class="lineNum">     201 </span><span class="lineCov">         17 :                 compositor-&gt;hybgl_txh = NULL;</span>
<span class="lineNum">     202 </span>            :         }
<span class="lineNum">     203 </span><span class="lineCov">        605 :         if (compositor-&gt;hybgl_mesh) {</span>
<span class="lineNum">     204 </span><span class="lineCov">         17 :                 mesh_free(compositor-&gt;hybgl_mesh);</span>
<span class="lineNum">     205 </span><span class="lineCov">         17 :                 compositor-&gt;hybgl_mesh = NULL;</span>
<span class="lineNum">     206 </span>            :         }
<span class="lineNum">     207 </span><span class="lineCov">        605 :         if (compositor-&gt;hybgl_mesh_background) {</span>
<span class="lineNum">     208 </span><span class="lineCov">         17 :                 mesh_free(compositor-&gt;hybgl_mesh_background);</span>
<span class="lineNum">     209 </span><span class="lineCov">         17 :                 compositor-&gt;hybgl_mesh_background = NULL;</span>
<span class="lineNum">     210 </span>            :         }
<a name="211"><span class="lineNum">     211 </span><span class="lineCov">        605 : }</span></a>
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span><span class="lineCov">       1062 : static GF_Err compositor_2d_setup_opengl(GF_VisualManager *visual)</span>
<span class="lineNum">     214 </span>            : {
<span class="lineNum">     215 </span><span class="lineCov">       1062 :         GF_Compositor *compositor = visual-&gt;compositor;</span>
<span class="lineNum">     216 </span><span class="lineCov">       1062 :         visual-&gt;is_attached = GF_TRUE;</span>
<span class="lineNum">     217 </span>            : 
<span class="lineNum">     218 </span><span class="lineCov">       1062 :         visual_3d_setup(visual);</span>
<span class="lineNum">     219 </span><span class="lineCov">       1062 :         visual-&gt;compositor-&gt;traverse_state-&gt;camera = &amp;visual-&gt;camera;</span>
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span><span class="lineCov">       1062 :         glViewport(0, 0, compositor-&gt;vp_width, compositor-&gt;vp_height);</span>
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span><span class="lineCov">       1062 :         visual-&gt;camera.vp.x = visual-&gt;camera.vp.y = 0;</span>
<span class="lineNum">     225 </span><span class="lineCov">       1062 :         visual-&gt;camera.vp.width = visual-&gt;camera.width = INT2FIX(compositor-&gt;vp_width);</span>
<span class="lineNum">     226 </span><span class="lineCov">       1062 :         visual-&gt;camera.vp.height = visual-&gt;camera.height = INT2FIX(compositor-&gt;vp_height);</span>
<span class="lineNum">     227 </span><span class="lineCov">       1062 :         visual-&gt;camera.up.y = FIX_ONE;</span>
<span class="lineNum">     228 </span><span class="lineCov">       1062 :         visual-&gt;camera.end_zoom = FIX_ONE;</span>
<span class="lineNum">     229 </span><span class="lineCov">       1062 :         visual-&gt;camera.position.z = INT2FIX(1000);</span>
<span class="lineNum">     230 </span><span class="lineCov">       1062 :         visual-&gt;camera.flags = CAM_IS_DIRTY;</span>
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span><span class="lineCov">       1062 :         camera_update(&amp;visual-&gt;camera, NULL, visual-&gt;compositor-&gt;hybrid_opengl ? GF_TRUE : visual-&gt;center_coords);</span>
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span><span class="lineCov">       1062 :         visual_3d_projection_matrix_modified(visual);</span>
<span class="lineNum">     235 </span><span class="lineCov">       1062 :         return GF_OK;</span>
<span class="lineNum">     236 </span>            : }
<span class="lineNum">     237 </span>            : #endif
<span class="lineNum">     238 </span>            : 
<a name="239"><span class="lineNum">     239 </span>            : #ifndef GPAC_DISABLE_3D</a>
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span><span class="lineCov">       1062 : static GF_Err c2d_video_access_hybrid_opengl(GF_VisualManager *visual)</span>
<span class="lineNum">     242 </span>            : {
<span class="lineNum">     243 </span>            :         GF_Err e;
<span class="lineNum">     244 </span><span class="lineCov">       1062 :         GF_Compositor *compositor = visual-&gt;compositor;</span>
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span><span class="lineCov">       1062 :         if (!compositor-&gt;hybgl_txh) {</span>
<span class="lineNum">     247 </span><span class="lineCov">         18 :                 GF_SAFEALLOC(compositor-&gt;hybgl_txh, GF_TextureHandler);</span>
<span class="lineNum">     248 </span><span class="lineCov">         18 :                 if (!compositor-&gt;hybgl_txh) return GF_IO_ERR;</span>
<span class="lineNum">     249 </span><span class="lineCov">         18 :                 compositor-&gt;hybgl_txh-&gt;compositor = compositor;</span>
<span class="lineNum">     250 </span>            :         }
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span><span class="lineCov">       1062 :         if ((compositor-&gt;hybgl_txh-&gt;width != compositor-&gt;vp_width) || (compositor-&gt;hybgl_txh-&gt;height != compositor-&gt;vp_height)) {</span>
<span class="lineNum">     253 </span>            :                 SFVec2f size;
<span class="lineNum">     254 </span><span class="lineCov">         20 :                 compositor-&gt;hybgl_txh-&gt;data = (char*)gf_realloc(compositor-&gt;hybgl_txh-&gt;data, 4*compositor-&gt;vp_width*compositor-&gt;vp_height);</span>
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span><span class="lineCov">         20 :                 if (compositor-&gt;hybgl_txh-&gt;tx_io)</span>
<span class="lineNum">     257 </span><span class="lineCov">          2 :                         gf_sc_texture_release(compositor-&gt;hybgl_txh);</span>
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span><span class="lineCov">         20 :                 compositor-&gt;hybgl_txh-&gt;width = compositor-&gt;vp_width;</span>
<span class="lineNum">     260 </span><span class="lineCov">         20 :                 compositor-&gt;hybgl_txh-&gt;height = compositor-&gt;vp_height;</span>
<span class="lineNum">     261 </span><span class="lineCov">         20 :                 compositor-&gt;hybgl_txh-&gt;stride = 4*compositor-&gt;vp_width;</span>
<span class="lineNum">     262 </span><span class="lineCov">         20 :                 compositor-&gt;hybgl_txh-&gt;pixelformat = GF_PIXEL_RGBA;</span>
<span class="lineNum">     263 </span><span class="lineCov">         20 :                 compositor-&gt;hybgl_txh-&gt;transparent = GF_TRUE;</span>
<span class="lineNum">     264 </span><span class="lineCov">         20 :                 compositor-&gt;hybgl_txh-&gt;flags = GF_SR_TEXTURE_PRIVATE_MEDIA | GF_SR_TEXTURE_NO_GL_FLIP;</span>
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span><span class="lineCov">         20 :                 memset(compositor-&gt;hybgl_txh-&gt;data, 0, 4*compositor-&gt;hybgl_txh-&gt;width*compositor-&gt;hybgl_txh-&gt;height);</span>
<span class="lineNum">     267 </span><span class="lineCov">         20 :                 gf_sc_texture_allocate(compositor-&gt;hybgl_txh);</span>
<span class="lineNum">     268 </span><span class="lineCov">         20 :                 gf_sc_texture_set_data(compositor-&gt;hybgl_txh);</span>
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span><span class="lineCov">         20 :                 if (!compositor-&gt;hybgl_mesh)</span>
<span class="lineNum">     271 </span><span class="lineCov">         18 :                         compositor-&gt;hybgl_mesh = new_mesh();</span>
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span><span class="lineCov">         20 :                 if (!compositor-&gt;hybgl_mesh_background)</span>
<span class="lineNum">     274 </span><span class="lineCov">         18 :                         compositor-&gt;hybgl_mesh_background = new_mesh();</span>
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span><span class="lineCov">         20 :                 size.x = INT2FIX(compositor-&gt;vp_width);</span>
<span class="lineNum">     277 </span><span class="lineCov">         20 :                 size.y = INT2FIX(compositor-&gt;vp_height);</span>
<span class="lineNum">     278 </span><span class="lineCov">         20 :                 mesh_new_rectangle(compositor-&gt;hybgl_mesh, size, NULL, GF_TRUE);</span>
<span class="lineNum">     279 </span><span class="lineCov">         20 :                 mesh_new_rectangle(compositor-&gt;hybgl_mesh_background, size, NULL, GF_FALSE);</span>
<span class="lineNum">     280 </span>            :         }
<span class="lineNum">     281 </span><span class="lineCov">       1062 :         if (!compositor-&gt;hybgl_txh-&gt;data) return GF_IO_ERR;</span>
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span><span class="lineCov">       1062 :         if (visual-&gt;compositor-&gt;traverse_state-&gt;immediate_draw)</span>
<span class="lineNum">     284 </span><span class="lineCov">        126 :                 memset(compositor-&gt;hybgl_txh-&gt;data, 0, 4*compositor-&gt;hybgl_txh-&gt;width*compositor-&gt;hybgl_txh-&gt;height);</span>
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span><span class="lineCov">       1062 :         e = gf_evg_surface_attach_to_buffer(visual-&gt;raster_surface, compositor-&gt;hybgl_txh-&gt;data,</span>
<span class="lineNum">     287 </span>            :                 compositor-&gt;hybgl_txh-&gt;width,
<span class="lineNum">     288 </span>            :                 compositor-&gt;hybgl_txh-&gt;height,
<span class="lineNum">     289 </span>            :                 0,
<span class="lineNum">     290 </span><span class="lineCov">       1062 :                 compositor-&gt;hybgl_txh-&gt;width * 4,</span>
<span class="lineNum">     291 </span>            :                 (GF_PixelFormat) GF_PIXEL_RGBA);
<span class="lineNum">     292 </span><span class="lineCov">       1062 :         if (e) return e;</span>
<span class="lineNum">     293 </span><span class="lineCov">       1062 :         e = compositor_2d_setup_opengl(visual);</span>
<span class="lineNum">     294 </span><span class="lineCov">       1062 :         if (e) return e;</span>
<span class="lineNum">     295 </span><span class="lineCov">       1062 :         visual-&gt;ClearSurface = compositor_2d_hybgl_clear_surface;</span>
<span class="lineNum">     296 </span><span class="lineCov">       1062 :         visual-&gt;DrawBitmap = compositor_2d_hybgl_draw_bitmap;</span>
<span class="lineNum">     297 </span><span class="lineCov">       1062 :         return GF_OK;</span>
<span class="lineNum">     298 </span>            : }
<a name="299"><span class="lineNum">     299 </span>            : #endif</a>
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span><span class="lineCov">      13170 : static GF_Err c2d_get_video_access_normal(GF_VisualManager *visual)</span>
<span class="lineNum">     302 </span>            : {
<span class="lineNum">     303 </span>            :         GF_Err e;
<span class="lineNum">     304 </span><span class="lineCov">      13170 :         GF_Compositor *compositor = visual-&gt;compositor;</span>
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineCov">      13170 :         compositor-&gt;hw_locked = GF_FALSE;</span>
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span><span class="lineCov">      13170 :         e = compositor-&gt;video_out-&gt;LockBackBuffer(compositor-&gt;video_out, &amp;compositor-&gt;hw_surface, GF_TRUE);</span>
<span class="lineNum">     309 </span><span class="lineCov">      13170 :         if (e==GF_OK) {</span>
<span class="lineNum">     310 </span><span class="lineCov">      13170 :                 compositor-&gt;hw_locked = GF_TRUE;</span>
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span><span class="lineCov">      13170 :                 e = gf_evg_surface_attach_to_buffer(visual-&gt;raster_surface, compositor-&gt;hw_surface.video_buffer,</span>
<span class="lineNum">     313 </span>            :                         compositor-&gt;hw_surface.width,
<span class="lineNum">     314 </span>            :                         compositor-&gt;hw_surface.height,
<span class="lineNum">     315 </span>            :                         compositor-&gt;hw_surface.pitch_x,
<span class="lineNum">     316 </span>            :                         compositor-&gt;hw_surface.pitch_y,
<span class="lineNum">     317 </span><span class="lineCov">      13170 :                         (GF_PixelFormat) compositor-&gt;hw_surface.pixel_format);</span>
<span class="lineNum">     318 </span><span class="lineCov">      13170 :                 if (!e) {</span>
<span class="lineNum">     319 </span><span class="lineCov">      13170 :                         visual-&gt;is_attached = GF_TRUE;</span>
<span class="lineNum">     320 </span><span class="lineCov">      13170 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_COMPOSE, (&quot;[Compositor2D] Video surface memory attached to raster - w=%d h=%d pitch_x=%d pitch_y=%d\n&quot;, compositor-&gt;hw_surface.width, compositor-&gt;hw_surface.height, compositor-&gt;hw_surface.pitch_x, compositor-&gt;hw_surface.pitch_y));</span>
<span class="lineNum">     321 </span>            :                         return GF_OK;
<span class="lineNum">     322 </span>            :                 }
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_COMPOSE, (&quot;[Compositor2D] Cannot attach video surface memory to raster for pixel format %s: %s\n&quot;, gf_pixel_fmt_name(compositor-&gt;hw_surface.pixel_format), gf_error_to_string(e) ));</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :                 compositor-&gt;last_error = e;</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :                 compositor-&gt;video_out-&gt;LockBackBuffer(compositor-&gt;video_out, &amp;compositor-&gt;hw_surface, GF_FALSE);</span>
<span class="lineNum">     326 </span>            :         }
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :         compositor-&gt;hw_locked = GF_FALSE;</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :         visual-&gt;is_attached = GF_FALSE;</span>
<span class="lineNum">     329 </span>            :         /*if using BlitTexture, return OK to still be able to blit images*/
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :         if (compositor-&gt;video_out-&gt;BlitTexture) e = GF_OK;</span>
<span class="lineNum">     331 </span>            :         return e;
<a name="332"><span class="lineNum">     332 </span>            : }</a>
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span><span class="lineCov">      21062 : GF_Err compositor_2d_get_video_access(GF_VisualManager *visual)</span>
<span class="lineNum">     335 </span>            : {
<span class="lineNum">     336 </span><span class="lineCov">      21062 :         if (!visual-&gt;raster_surface) return GF_BAD_PARAM;</span>
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span>            : #ifndef GPAC_DISABLE_3D
<span class="lineNum">     339 </span><span class="lineCov">      21062 :         if (visual-&gt;compositor-&gt;hybrid_opengl) {</span>
<span class="lineNum">     340 </span><span class="lineCov">       1062 :                 return c2d_video_access_hybrid_opengl(visual);</span>
<span class="lineNum">     341 </span>            :         }
<span class="lineNum">     342 </span>            : #endif
<span class="lineNum">     343 </span>            :         //do nothing until asked to really attach
<span class="lineNum">     344 </span>            :         return GF_OK;
<a name="345"><span class="lineNum">     345 </span>            : }</a>
<span class="lineNum">     346 </span>            : 
<span class="lineNum">     347 </span><span class="lineCov">     759129 : Bool compositor_2d_check_attached(GF_VisualManager *visual)</span>
<span class="lineNum">     348 </span>            : {
<span class="lineNum">     349 </span><span class="lineCov">     759129 :         if (!visual-&gt;is_attached) {</span>
<span class="lineNum">     350 </span><span class="lineCov">      13170 :                 c2d_get_video_access_normal(visual);</span>
<span class="lineNum">     351 </span>            :         }
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span><span class="lineCov">     759129 :         return visual-&gt;is_attached;</span>
<a name="354"><span class="lineNum">     354 </span>            : }</a>
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineCov">       2057 : void compositor_2d_clear_surface(GF_VisualManager *visual, GF_IRect *rc, u32 BackColor, u32 offscreen_clear)</span>
<span class="lineNum">     357 </span>            : {
<span class="lineNum">     358 </span>            :         //visual not attached on main (direct video) visual, use texture bliting
<span class="lineNum">     359 </span><span class="lineCov">       2057 :         if (!visual-&gt;is_attached &amp;&amp; visual-&gt;compositor-&gt;video_out-&gt;Blit &amp;&amp; (visual-&gt;compositor-&gt;video_out-&gt;hw_caps &amp; GF_VIDEO_HW_HAS_RGB)) {</span>
<span class="lineNum">     360 </span>            :                 char data[12];
<span class="lineNum">     361 </span>            :                 GF_Err e;
<span class="lineNum">     362 </span>            :                 GF_VideoSurface video_src;
<span class="lineNum">     363 </span>            :                 GF_Window src_wnd, dst_wnd;
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :                 if (!BackColor &amp;&amp; !visual-&gt;offscreen) {</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :                         if ( !(visual-&gt;compositor-&gt;init_flags &amp; GF_TERM_WINDOW_TRANSPARENT)) {</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :                                 BackColor = visual-&gt;compositor-&gt;back_color;</span>
<span class="lineNum">     368 </span>            :                         }
<span class="lineNum">     369 </span>            :                 }
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                 data[0] = data[3] = data[6] = data[9] = GF_COL_R(BackColor);</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                 data[1] = data[4] = data[7] = data[10] = GF_COL_G(BackColor);</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :                 data[2] = data[5] = data[8] = data[11] = GF_COL_B(BackColor);</span>
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span>            :                 memset(&amp;video_src, 0, sizeof(GF_VideoSurface));
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :                 video_src.height = 2;</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :                 video_src.width = 2;</span>
<span class="lineNum">     378 </span>            :                 video_src.pitch_x = 0;
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :                 video_src.pitch_y = 6;</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :                 video_src.pixel_format = GF_PIXEL_RGB;</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :                 video_src.video_buffer = data;</span>
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :                 src_wnd.x = src_wnd.y = 0;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :                 src_wnd.w = src_wnd.h = 1;</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :                 if (rc) {</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :                         if (visual-&gt;center_coords) {</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :                                 dst_wnd.x = rc-&gt;x + visual-&gt;width/2;</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :                                 dst_wnd.y = visual-&gt;height/2 - rc-&gt;y;</span>
<span class="lineNum">     389 </span>            :                         } else {
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :                                 dst_wnd.x = rc-&gt;x;</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                                 dst_wnd.y = rc-&gt;y - visual-&gt;height/2;</span>
<span class="lineNum">     392 </span>            :                         }
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                         dst_wnd.w = rc-&gt;width;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :                         dst_wnd.h = rc-&gt;height;</span>
<span class="lineNum">     395 </span>            :                 } else {
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                         dst_wnd.x = dst_wnd.y = 0;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :                         dst_wnd.w = visual-&gt;width;</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :                         dst_wnd.h = visual-&gt;height;</span>
<span class="lineNum">     399 </span>            :                 }
<span class="lineNum">     400 </span>            : 
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :                 e = visual-&gt;compositor-&gt;video_out-&gt;Blit(visual-&gt;compositor-&gt;video_out, &amp;video_src, &amp;src_wnd, &amp;dst_wnd, 0);</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :                 if (e==GF_OK) return;</span>
<span class="lineNum">     403 </span>            :         }
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span><span class="lineCov">       2057 :         visual_2d_clear_surface(visual, rc, BackColor, offscreen_clear);</span>
<span class="lineNum">     406 </span>            : }
<span class="lineNum">     407 </span>            : 
<a name="408"><span class="lineNum">     408 </span>            : </a>
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span><span class="lineCov">      21062 : void compositor_2d_release_video_access(GF_VisualManager *visual)</span>
<span class="lineNum">     411 </span>            : {
<span class="lineNum">     412 </span><span class="lineCov">      21062 :         GF_Compositor *compositor = visual-&gt;compositor;</span>
<span class="lineNum">     413 </span><span class="lineCov">      21062 :         if (visual-&gt;is_attached) {</span>
<span class="lineNum">     414 </span><span class="lineCov">      14232 :                 visual-&gt;is_attached = GF_FALSE;</span>
<span class="lineNum">     415 </span>            :         }
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span>            : #ifndef GPAC_DISABLE_3D
<span class="lineNum">     418 </span><span class="lineCov">      21062 :         if (compositor-&gt;hybrid_opengl) {</span>
<span class="lineNum">     419 </span><span class="lineCov">       1062 :                 compositor_2d_hybgl_flush_video(compositor, NULL);</span>
<span class="lineNum">     420 </span><span class="lineCov">       1062 :                 return;</span>
<span class="lineNum">     421 </span>            :         }
<span class="lineNum">     422 </span>            : #endif //GPAC_DISABLE_3D
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineCov">      20000 :         if (compositor-&gt;hw_context) {</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :                 compositor-&gt;video_out-&gt;LockOSContext(compositor-&gt;video_out, GF_FALSE);</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :                 compositor-&gt;hw_context = NULL;</span>
<span class="lineNum">     427 </span><span class="lineCov">      20000 :         } else if (compositor-&gt;hw_locked) {</span>
<span class="lineNum">     428 </span><span class="lineCov">      13170 :                 compositor-&gt;video_out-&gt;LockBackBuffer(compositor-&gt;video_out, &amp;compositor-&gt;hw_surface, GF_FALSE);</span>
<span class="lineNum">     429 </span><span class="lineCov">      13170 :                 compositor-&gt;hw_locked = GF_FALSE;</span>
<span class="lineNum">     430 </span>            :         }
<a name="431"><span class="lineNum">     431 </span>            : }</a>
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span><span class="lineCov">      23676 : static void store_blit_times(GF_TextureHandler *txh, u32 push_time)</span>
<span class="lineNum">     434 </span>            : {
<span class="lineNum">     435 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">     436 </span>            :         u32 ck;
<span class="lineNum">     437 </span>            : #endif
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span><span class="lineCov">      23676 :         push_time = gf_sys_clock() - push_time;</span>
<span class="lineNum">     440 </span><span class="lineCov">      23676 :         txh-&gt;nb_frames ++;</span>
<span class="lineNum">     441 </span><span class="lineCov">      23676 :         txh-&gt;upload_time += push_time;</span>
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">     444 </span><span class="lineCov">      23676 :         gf_mo_get_object_time(txh-&gt;stream, &amp;ck);</span>
<span class="lineNum">     445 </span><span class="lineCov">      23676 :         if (ck&gt;txh-&gt;last_frame_time) {</span>
<span class="lineNum">     446 </span><span class="lineCov">       2987 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_COMPOSE, (&quot;[Compositor2D] Bliting frame (CTS %d) %d ms too late\n&quot;, txh-&gt;last_frame_time, ck - txh-&gt;last_frame_time ));</span>
<span class="lineNum">     447 </span>            :         }
<span class="lineNum">     448 </span>            : 
<span class="lineNum">     449 </span><span class="lineCov">      23676 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[2D Blitter] At %u Blit texture (CTS %u) %d ms after due date - blit in %d ms - average push time %d ms\n&quot;, ck, txh-&gt;last_frame_time, ck - txh-&gt;last_frame_time, push_time, txh-&gt;upload_time / txh-&gt;nb_frames));</span>
<span class="lineNum">     450 </span>            : #endif
<a name="451"><span class="lineNum">     451 </span><span class="lineCov">      23676 : }</span></a>
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span><span class="lineCov">      23875 : Bool compositor_texture_rectangles(GF_VisualManager *visual, GF_TextureHandler *txh, GF_IRect *clip, GF_Rect *unclip, GF_Window *src, GF_Window *dst, Bool *disable_blit, Bool *has_scale)</span>
<span class="lineNum">     454 </span>            : {
<span class="lineNum">     455 </span>            :         Fixed w_scale, h_scale, tmp;
<span class="lineNum">     456 </span>            :         u32 output_width, output_height;
<span class="lineNum">     457 </span><span class="lineCov">      23875 :         GF_IRect clipped_final = *clip;</span>
<span class="lineNum">     458 </span><span class="lineCov">      23875 :         GF_Rect final = *unclip;</span>
<span class="lineNum">     459 </span>            :         Bool use_blit;
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineCov">      23875 :         src-&gt;w = src-&gt;h = 0;</span>
<span class="lineNum">     462 </span><span class="lineCov">      23875 :         dst-&gt;w = dst-&gt;h = 0;</span>
<span class="lineNum">     463 </span><span class="lineCov">      23875 :         if (disable_blit) *disable_blit = GF_FALSE;</span>
<span class="lineNum">     464 </span><span class="lineCov">      23875 :         if (has_scale) *has_scale = GF_FALSE;</span>
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span><span class="lineCov">      23875 :         if (final.width&lt;=0 || final.height &lt;=0) return GF_FALSE;</span>
<span class="lineNum">     467 </span><span class="lineCov">      23875 :         if (txh-&gt;width==0 || txh-&gt;height==0) return GF_FALSE;</span>
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span><span class="lineCov">      23875 :         w_scale = final.width / txh-&gt;width;</span>
<span class="lineNum">     470 </span><span class="lineCov">      23875 :         h_scale = final.height / txh-&gt;height;</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span><span class="lineCov">      23875 :         if ((w_scale != FIX_ONE) || (h_scale!=FIX_ONE)) {</span>
<span class="lineNum">     473 </span><span class="lineCov">      23706 :                 if (has_scale) *has_scale = GF_TRUE;</span>
<span class="lineNum">     474 </span>            :         }
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineCov">      23875 :         if (visual-&gt;offscreen) {</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :                 output_width = visual-&gt;width;</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :                 output_height = visual-&gt;height;</span>
<span class="lineNum">     479 </span>            :         } else {
<span class="lineNum">     480 </span>            :                 /*use entire video surface for un-centering coord system*/
<span class="lineNum">     481 </span><span class="lineCov">      23875 :                 output_width = visual-&gt;compositor-&gt;vp_width;</span>
<span class="lineNum">     482 </span><span class="lineCov">      23875 :                 output_height = visual-&gt;compositor-&gt;vp_height;</span>
<span class="lineNum">     483 </span>            :         }
<span class="lineNum">     484 </span>            :         /*take care of pixel rounding for odd width/height and make sure we strictly draw in the clipped bounds*/
<span class="lineNum">     485 </span><span class="lineCov">      23875 :         if (visual-&gt;center_coords) {</span>
<span class="lineNum">     486 </span><span class="lineCov">      23532 :                 clipped_final.x += output_width / 2;</span>
<span class="lineNum">     487 </span><span class="lineCov">      23532 :                 final.x += INT2FIX( output_width / 2 );</span>
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span><span class="lineCov">      23532 :                 clipped_final.y = output_height/ 2 - clipped_final.y;</span>
<span class="lineNum">     490 </span><span class="lineCov">      23532 :                 final.y = INT2FIX( output_height / 2) - final.y;</span>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span>            :         } else {
<span class="lineNum">     493 </span><span class="lineCov">        343 :                 final.y -= final.height;</span>
<span class="lineNum">     494 </span><span class="lineCov">        343 :                 clipped_final.y -= clipped_final.height;</span>
<span class="lineNum">     495 </span>            :         }
<span class="lineNum">     496 </span>            : 
<span class="lineNum">     497 </span>            :         /*make sure we lie in the final rect (this is needed for directdraw mode)*/
<span class="lineNum">     498 </span><span class="lineCov">      23875 :         if (clipped_final.x&lt;0) {</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :                 clipped_final.width += clipped_final.x;</span>
<span class="lineNum">     500 </span>            :                 clipped_final.x = 0;
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :                 if (clipped_final.width &lt;= 0) return GF_FALSE;</span>
<span class="lineNum">     502 </span>            :         }
<span class="lineNum">     503 </span><span class="lineCov">      23875 :         if (clipped_final.y&lt;0) {</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                 clipped_final.height += clipped_final.y;</span>
<span class="lineNum">     505 </span>            :                 clipped_final.y = 0;
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :                 if (clipped_final.height &lt;= 0) return GF_FALSE;</span>
<span class="lineNum">     507 </span>            :         }
<span class="lineNum">     508 </span><span class="lineCov">      23875 :         if (clipped_final.x + clipped_final.width &gt; (s32) output_width) {</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :                 clipped_final.width = output_width - clipped_final.x;</span>
<span class="lineNum">     510 </span>            :                 clipped_final.x = output_width - clipped_final.width;
<span class="lineNum">     511 </span>            :         }
<span class="lineNum">     512 </span><span class="lineCov">      23875 :         if (clipped_final.y + clipped_final.height &gt; (s32) output_height) {</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :                 clipped_final.height = output_height - clipped_final.y;</span>
<span class="lineNum">     514 </span>            :                 clipped_final.y = output_height - clipped_final.height;
<span class="lineNum">     515 </span>            :         }
<span class="lineNum">     516 </span>            :         /*needed in direct drawing since clipping is not performed*/
<span class="lineNum">     517 </span><span class="lineCov">      23875 :         if (clipped_final.width&lt;=0 || clipped_final.height &lt;=0)</span>
<span class="lineNum">     518 </span>            :                 return GF_FALSE;
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span><span class="lineCov">      23875 :         if (clipped_final.width-1&gt;= FIX2INT(final.width) ) clipped_final.width = FIX2INT(final.width);</span>
<span class="lineNum">     521 </span><span class="lineCov">      23875 :         if (clipped_final.height-1&gt;= FIX2INT(final.height) ) clipped_final.height = FIX2INT(final.height);</span>
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span>            :         /*set dest window*/
<span class="lineNum">     524 </span><span class="lineCov">      23875 :         dst-&gt;x = (u32) clipped_final.x;</span>
<span class="lineNum">     525 </span><span class="lineCov">      23875 :         dst-&gt;y = (u32) clipped_final.y;</span>
<span class="lineNum">     526 </span><span class="lineCov">      23875 :         dst-&gt;w = (u32) clipped_final.width;</span>
<span class="lineNum">     527 </span><span class="lineCov">      23875 :         dst-&gt;h = (u32) clipped_final.height;</span>
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span><span class="lineCov">      23875 :         if (!dst-&gt;w || !dst-&gt;h) return GF_FALSE;</span>
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span>            : #ifdef GPAC_FIXED_POINT
<span class="lineNum">     532 </span>            : #define ROUND_FIX(_v)   \
<span class="lineNum">     533 </span>            :         _v = FIX2INT(tmp);
<span class="lineNum">     534 </span>            : #define CEILING(_v)     \
<span class="lineNum">     535 </span>            :         _v = FIX2INT(tmp);      \
<span class="lineNum">     536 </span>            :         if (INT2FIX(_v)!=tmp) _v++;
<span class="lineNum">     537 </span>            : #else
<span class="lineNum">     538 </span>            : #define ROUND_FIX(_v)   \
<span class="lineNum">     539 </span>            :         _v = FIX2INT(tmp);      \
<span class="lineNum">     540 </span>            :         tmp -= INT2FIX(_v);     \
<span class="lineNum">     541 </span>            :         if (tmp&gt;99*FIX_ONE/100) { _v++; tmp = 0; }   \
<span class="lineNum">     542 </span>            :         if (ABS(tmp) &gt; FIX_EPSILON) use_blit = 0;
<span class="lineNum">     543 </span>            : #define CEILING(_v)     \
<span class="lineNum">     544 </span>            :         _v = FIX2INT(tmp);      \
<span class="lineNum">     545 </span>            :         tmp -= INT2FIX(_v);     \
<span class="lineNum">     546 </span>            :         if (tmp&gt;0) { _v++; tmp = 0; }        \
<span class="lineNum">     547 </span>            :         if (ABS(tmp) &gt; FIX_EPSILON) use_blit = 0;
<span class="lineNum">     548 </span>            : #endif
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span>            :         use_blit = GF_TRUE;
<span class="lineNum">     551 </span>            : 
<span class="lineNum">     552 </span><span class="lineCov">      23875 :         if (txh-&gt;data &amp;&amp; !txh-&gt;size &amp;&amp; (txh-&gt;width==2) &amp;&amp; (txh-&gt;height==2) ) {</span>
<span class="lineNum">     553 </span><span class="lineCov">      16789 :                 src-&gt;x = src-&gt;y = 0;</span>
<span class="lineNum">     554 </span><span class="lineCov">      16789 :                 src-&gt;w = 1;</span>
<span class="lineNum">     555 </span><span class="lineCov">      16789 :                 src-&gt;h = 1;</span>
<span class="lineNum">     556 </span>            :         } else {
<span class="lineNum">     557 </span>            :                 /*compute SRC window*/
<span class="lineNum">     558 </span><span class="lineCov">       7086 :                 tmp = gf_divfix(INT2FIX(clipped_final.x) - final.x, w_scale);</span>
<span class="lineNum">     559 </span><span class="lineCov">       7086 :                 if (tmp&lt;0) tmp=0;</span>
<span class="lineNum">     560 </span><span class="lineCov">       7086 :                 CEILING(src-&gt;x);</span>
<span class="lineNum">     561 </span>            : 
<span class="lineNum">     562 </span><span class="lineCov">       7086 :                 tmp = gf_divfix(INT2FIX(clipped_final.y) - final.y, h_scale);</span>
<span class="lineNum">     563 </span><span class="lineCov">       7086 :                 if (tmp&lt;0) tmp=0;</span>
<span class="lineNum">     564 </span><span class="lineCov">       7086 :                 CEILING(src-&gt;y);</span>
<span class="lineNum">     565 </span>            : 
<span class="lineNum">     566 </span><span class="lineCov">       7086 :                 tmp = gf_divfix(INT2FIX(clip-&gt;width), w_scale);</span>
<span class="lineNum">     567 </span><span class="lineCov">       7086 :                 ROUND_FIX(src-&gt;w);</span>
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span><span class="lineCov">       7086 :                 tmp = gf_divfix(INT2FIX(clip-&gt;height), h_scale);</span>
<span class="lineNum">     570 </span><span class="lineCov">       7086 :                 ROUND_FIX(src-&gt;h);</span>
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span>            : 
<span class="lineNum">     573 </span><span class="lineCov">       7086 :                 if (src-&gt;w&gt;txh-&gt;width) src-&gt;w=txh-&gt;width;</span>
<span class="lineNum">     574 </span><span class="lineCov">       7086 :                 if (src-&gt;h&gt;txh-&gt;height) src-&gt;h=txh-&gt;height;</span>
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span><span class="lineCov">       7086 :                 if (!src-&gt;w || !src-&gt;h) return GF_FALSE;</span>
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span>            :                 /*make sure we lie in src bounds*/
<span class="lineNum">     579 </span><span class="lineCov">       7086 :                 if (src-&gt;x + src-&gt;w&gt;txh-&gt;width) src-&gt;w = txh-&gt;width - src-&gt;x;</span>
<span class="lineNum">     580 </span><span class="lineCov">       7086 :                 if (src-&gt;y + src-&gt;h&gt;txh-&gt;height) src-&gt;h = txh-&gt;height - src-&gt;y;</span>
<span class="lineNum">     581 </span>            :         }
<span class="lineNum">     582 </span>            : #undef ROUND_FIX
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span><span class="lineCov">      23875 :         if (disable_blit) *disable_blit = use_blit ? GF_FALSE : GF_TRUE;</span>
<span class="lineNum">     585 </span>            :         return GF_TRUE;
<a name="586"><span class="lineNum">     586 </span>            : }</a>
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span><span class="lineCov">      23875 : static Bool compositor_2d_draw_bitmap_ex(GF_VisualManager *visual, GF_TextureHandler *txh, DrawableContext *ctx, GF_IRect *clip, GF_Rect *unclip, u8 alpha, GF_TraverseState *tr_state, Bool force_soft_blt)</span>
<span class="lineNum">     589 </span>            : {
<span class="lineNum">     590 </span>            :         GF_VideoSurface video_src;
<span class="lineNum">     591 </span>            :         GF_Err e;
<span class="lineNum">     592 </span>            :         Bool use_soft_stretch, use_blit, flush_video, is_attached, has_scale;
<span class="lineNum">     593 </span>            :         u32 overlay_type;
<span class="lineNum">     594 </span>            :         GF_Window src_wnd, dst_wnd;
<span class="lineNum">     595 </span>            :         u32 output_width, output_height, hw_caps;
<span class="lineNum">     596 </span>            : 
<span class="lineNum">     597 </span>            : 
<span class="lineNum">     598 </span><span class="lineCov">      23875 :         if (!txh-&gt;data) return GF_TRUE;</span>
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span><span class="lineCov">      23875 :         if (!visual-&gt;compositor-&gt;has_size_info &amp;&amp; !(visual-&gt;compositor-&gt;msg_type &amp; GF_SR_CFG_OVERRIDE_SIZE)</span>
<span class="lineNum">     601 </span>            :                 &amp;&amp; (visual-&gt;compositor-&gt;override_size_flags &amp; 1)
<span class="lineNum">     602 </span><span class="lineCov">        356 :                 &amp;&amp; !(visual-&gt;compositor-&gt;override_size_flags &amp; 2)</span>
<span class="lineNum">     603 </span>            :            ) {
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :                 if ( (visual-&gt;compositor-&gt;scene_width &lt; txh-&gt;width)</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :                         || (visual-&gt;compositor-&gt;scene_height &lt; txh-&gt;height)) {</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :                         visual-&gt;compositor-&gt;scene_width = txh-&gt;width;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :                         visual-&gt;compositor-&gt;scene_height = txh-&gt;height;</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :                         visual-&gt;compositor-&gt;msg_type |= GF_SR_CFG_OVERRIDE_SIZE;</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">     610 </span>            :                 }
<span class="lineNum">     611 </span>            :         }
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span><span class="lineCov">      23875 :         if (!compositor_texture_rectangles(visual, txh, clip, unclip, &amp;src_wnd, &amp;dst_wnd, &amp;use_blit, &amp;has_scale)) return GF_TRUE;</span>
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span>            :         //blitter is disabled
<span class="lineNum">     616 </span><span class="lineCov">      23875 :         if (txh-&gt;flags &amp; GF_SR_TEXTURE_DISABLE_BLIT) return GF_FALSE;</span>
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span>            :         /*can we use hardware blitter ?*/
<span class="lineNum">     619 </span><span class="lineCov">      23792 :         hw_caps = visual-&gt;compositor-&gt;video_out-&gt;hw_caps;</span>
<span class="lineNum">     620 </span>            :         overlay_type = 0;
<span class="lineNum">     621 </span>            :         flush_video = GF_FALSE;
<span class="lineNum">     622 </span>            :         use_soft_stretch = GF_TRUE;
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span><span class="lineCov">      23792 :         output_width = visual-&gt;compositor-&gt;vp_width;</span>
<span class="lineNum">     625 </span><span class="lineCov">      23792 :         output_height = visual-&gt;compositor-&gt;vp_height;</span>
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span><span class="lineCov">      23792 :         if (visual-&gt;compositor-&gt;disable_hardware_blit) force_soft_blt = GF_TRUE;</span>
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span><span class="lineCov">      23792 :         if (!force_soft_blt) {</span>
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span>            :                 /*avoid partial redraw that don't come close to src pixels with the bliter, this leads to ugly artefacts -
<span class="lineNum">     632 </span>            :                 fall back to rasterizer*/
<span class="lineNum">     633 </span>            : //              if (!(ctx-&gt;flags &amp; CTX_TEXTURE_DIRTY) &amp;&amp; !use_blit &amp;&amp; (src_wnd.x || src_wnd.y) )
<span class="lineNum">     634 </span>            : //                      return 0;
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span><span class="lineCov">      23792 :                 switch (txh-&gt;pixelformat) {</span>
<span class="lineNum">     637 </span><span class="lineCov">      19732 :                 case GF_PIXEL_RGB:</span>
<span class="lineNum">     638 </span>            :                 case GF_PIXEL_BGR:
<span class="lineNum">     639 </span>            :                 case GF_PIXEL_RGBS:
<span class="lineNum">     640 </span>            :                 case GF_PIXEL_RGBD:
<span class="lineNum">     641 </span>            : //              case GF_PIXEL_RGB_555:
<span class="lineNum">     642 </span>            : //              case GF_PIXEL_RGB_565:
<span class="lineNum">     643 </span><span class="lineCov">      19732 :                         if ((alpha==0xFF) &amp;&amp; (hw_caps &amp; GF_VIDEO_HW_HAS_RGB)) {</span>
<span class="lineNum">     644 </span>            :                                 use_soft_stretch = GF_FALSE;
<span class="lineNum">     645 </span>            :                         }
<span class="lineNum">     646 </span><span class="lineCov">        147 :                         else if ((alpha!=0xFF) &amp;&amp; (hw_caps &amp; GF_VIDEO_HW_HAS_RGBA)) {</span>
<span class="lineNum">     647 </span>            :                                 use_soft_stretch = GF_FALSE;
<span class="lineNum">     648 </span>            :                         }
<span class="lineNum">     649 </span>            :                         break;
<span class="lineNum">     650 </span><span class="lineCov">        626 :                 case GF_PIXEL_ARGB:</span>
<span class="lineNum">     651 </span>            :                 case GF_PIXEL_RGBA:
<span class="lineNum">     652 </span>            :                 case GF_PIXEL_RGBAS:
<span class="lineNum">     653 </span>            :                 case GF_PIXEL_RGBDS:
<span class="lineNum">     654 </span><span class="lineCov">        626 :                         if (hw_caps &amp; GF_VIDEO_HW_HAS_RGBA)</span>
<span class="lineNum">     655 </span>            :                                 use_soft_stretch = GF_FALSE;
<span class="lineNum">     656 </span>            :                         break;
<span class="lineNum">     657 </span><span class="lineCov">       3434 :                 default:</span>
<span class="lineNum">     658 </span><span class="lineCov">       3434 :                         if (gf_pixel_fmt_is_yuv(txh-&gt;pixelformat)) {</span>
<span class="lineNum">     659 </span><span class="lineCov">       3413 :                                 if (hw_caps &amp; GF_VIDEO_HW_HAS_YUV) use_soft_stretch = GF_FALSE;</span>
<span class="lineNum">     660 </span><span class="lineCov">       3413 :                                 else if (hw_caps &amp; GF_VIDEO_HW_HAS_YUV_OVERLAY) overlay_type = 1;</span>
<span class="lineNum">     661 </span>            :                         }
<span class="lineNum">     662 </span>            :                         break;
<span class="lineNum">     663 </span>            :                 }
<span class="lineNum">     664 </span>            :                 /*disable based on settings*/
<span class="lineNum">     665 </span><span class="lineCov">      23792 :                 if (!visual-&gt;compositor-&gt;yuvhw</span>
<span class="lineNum">     666 </span><span class="lineCov">      23792 :                         || (ctx-&gt;col_mat || !visual-&gt;compositor-&gt;video_out-&gt;Blit)</span>
<span class="lineNum">     667 </span>            :                    ) {
<span class="lineNum">     668 </span>            :                         use_soft_stretch = GF_TRUE;
<span class="lineNum">     669 </span>            :                         overlay_type = 0;
<span class="lineNum">     670 </span>            :                 }
<span class="lineNum">     671 </span><span class="lineCov">      23792 :                 if (!visual-&gt;compositor-&gt;blitp &amp;&amp; ((src_wnd.w!=txh-&gt;width) || (src_wnd.h!=txh-&gt;height) )) {</span>
<span class="lineNum">     672 </span>            :                         use_soft_stretch = GF_TRUE;
<span class="lineNum">     673 </span>            :                 }
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span>            :                 /*disable HW color keying - not compatible with MPEG-4 MaterialKey*/
<span class="lineNum">     676 </span><span class="lineCov">      23792 :                 if (tr_state-&gt;col_key) {</span>
<span class="lineNum">     677 </span>            :                         use_soft_stretch = GF_TRUE;
<span class="lineNum">     678 </span>            :                         overlay_type = 0;
<span class="lineNum">     679 </span>            :                 }
<span class="lineNum">     680 </span>            : 
<span class="lineNum">     681 </span><span class="lineCov">      23671 :                 if (overlay_type) {</span>
<span class="lineNum">     682 </span>            :                         /*no more than one overlay is supported at the current time*/
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                         if (visual-&gt;overlays) {</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :                                 ctx-&gt;drawable-&gt;flags &amp;= ~DRAWABLE_IS_OVERLAY;</span>
<span class="lineNum">     685 </span>            :                                 overlay_type = 0;
<span class="lineNum">     686 </span>            :                         }
<span class="lineNum">     687 </span>            :                         /*direct draw or not last context: we must queue the overlay*/
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :                         else if (tr_state-&gt;immediate_draw || (ctx-&gt;next &amp;&amp; ctx-&gt;next-&gt;drawable)) {</span>
<span class="lineNum">     689 </span>            :                                 overlay_type = 2;
<span class="lineNum">     690 </span>            :                         }
<span class="lineNum">     691 </span>            :                         /*OK we can overlay this video - if full display, don't flush*/
<span class="lineNum">     692 </span>            :                         if (overlay_type==1) {
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :                                 if (dst_wnd.w==visual-&gt;compositor-&gt;display_width) flush_video = GF_FALSE;</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :                                 else if (dst_wnd.h==visual-&gt;compositor-&gt;display_height) flush_video = GF_FALSE;</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :                                 else flush_video = visual-&gt;has_modif;</span>
<span class="lineNum">     696 </span>            :                         }
<span class="lineNum">     697 </span>            :                         /*if no color keying, we cannot queue the overlay*/
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :                         else if (!visual-&gt;compositor-&gt;video_out-&gt;overlay_color_key) {</span>
<span class="lineNum">     699 </span>            :                                 overlay_type = 0;
<span class="lineNum">     700 </span>            :                         }
<span class="lineNum">     701 </span>            :                 }
<span class="lineNum">     702 </span>            :         }
<span class="lineNum">     703 </span>            : 
<span class="lineNum">     704 </span><span class="lineCov">      23792 :         if (has_scale &amp;&amp; !(hw_caps &amp; GF_VIDEO_HW_HAS_STRETCH) &amp;&amp; !overlay_type) {</span>
<span class="lineNum">     705 </span>            :                 use_soft_stretch = GF_TRUE;
<span class="lineNum">     706 </span>            :         }
<span class="lineNum">     707 </span>            : 
<span class="lineNum">     708 </span>            :         memset(&amp;video_src, 0, sizeof(GF_VideoSurface));
<span class="lineNum">     709 </span><span class="lineCov">      23792 :         video_src.height = txh-&gt;height;</span>
<span class="lineNum">     710 </span><span class="lineCov">      23792 :         video_src.width = txh-&gt;width;</span>
<span class="lineNum">     711 </span>            :         video_src.pitch_x = 0;
<span class="lineNum">     712 </span><span class="lineCov">      23792 :         if (!txh-&gt;stride)</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :                 gf_pixel_get_size_info(txh-&gt;pixelformat, txh-&gt;width, txh-&gt;height, NULL, &amp;txh-&gt;stride, NULL, NULL, NULL);</span>
<span class="lineNum">     714 </span><span class="lineCov">      23792 :         video_src.pitch_y = txh-&gt;stride;</span>
<span class="lineNum">     715 </span><span class="lineCov">      23792 :         video_src.pixel_format = txh-&gt;pixelformat;</span>
<span class="lineNum">     716 </span>            : #ifdef GF_SR_USE_DEPTH
<span class="lineNum">     717 </span><span class="lineCov">      23792 :         if (txh-&gt;pixelformat==GF_PIXEL_YUVD) video_src.pixel_format = GF_PIXEL_YUV;</span>
<span class="lineNum">     718 </span>            : #endif
<span class="lineNum">     719 </span><span class="lineCov">      23792 :         video_src.video_buffer = txh-&gt;data;</span>
<span class="lineNum">     720 </span><span class="lineCov">      23792 :         if (txh-&gt;frame_ifce) {</span>
<span class="lineNum">     721 </span>            :                 u32 stride;
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :                 if (!txh-&gt;frame_ifce-&gt;get_plane) return GF_FALSE;</span>
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :                 e = txh-&gt;frame_ifce-&gt;get_plane(txh-&gt;frame_ifce, 0, (const u8 **) &amp;video_src.video_buffer, &amp;video_src.pitch_y);</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :                 if (e) return GF_FALSE;</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :                 txh-&gt;frame_ifce-&gt;get_plane(txh-&gt;frame_ifce, 1, (const u8 **) video_src.u_ptr, &amp;stride);</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :                 txh-&gt;frame_ifce-&gt;get_plane(txh-&gt;frame_ifce, 2, (const u8 **) video_src.v_ptr, &amp;stride);</span>
<span class="lineNum">     728 </span>            :         }
<span class="lineNum">     729 </span><span class="lineCov">      23792 :         video_src.global_alpha = alpha;</span>
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span>            :         //overlay queing
<span class="lineNum">     732 </span><span class="lineCov">      23792 :         if (overlay_type==2) {</span>
<span class="lineNum">     733 </span>            :                 GF_IRect o_rc;
<span class="lineNum">     734 </span>            :                 GF_OverlayStack *ol, *first;
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span>            :                 /*queue overlay in order*/
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :                 GF_SAFEALLOC(ol, GF_OverlayStack);</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :                 if (!ol) {</span>
<span class="lineNum">     739 </span>            :                         return GF_FALSE;
<span class="lineNum">     740 </span>            :                 }
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :                 ol-&gt;ctx = ctx;</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :                 ol-&gt;dst = dst_wnd;</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :                 ol-&gt;src = src_wnd;</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :                 first = visual-&gt;overlays;</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :                 if (first) {</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :                         while (first-&gt;next) first = first-&gt;next;</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :                         first-&gt;next = ol;</span>
<span class="lineNum">     748 </span>            :                 } else {
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :                         visual-&gt;overlays = ol;</span>
<span class="lineNum">     750 </span>            :                 }
<span class="lineNum">     751 </span>            : 
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :                 if (visual-&gt;center_coords) {</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :                         o_rc.x = dst_wnd.x - output_width/2;</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :                         o_rc.y = output_height/2- dst_wnd.y;</span>
<span class="lineNum">     755 </span>            :                 } else {
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :                         o_rc.x = dst_wnd.x;</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :                         o_rc.y = dst_wnd.y + dst_wnd.h;</span>
<span class="lineNum">     758 </span>            :                 }
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :                 o_rc.width = dst_wnd.w;</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :                 o_rc.height = dst_wnd.h;</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :                 visual-&gt;ClearSurface(visual, &amp;o_rc, visual-&gt;compositor-&gt;video_out-&gt;overlay_color_key, GF_FALSE);</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :                 visual-&gt;has_overlays = GF_TRUE;</span>
<span class="lineNum">     764 </span>            :                 /*mark drawable as overlay*/
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :                 ctx-&gt;drawable-&gt;flags |= DRAWABLE_IS_OVERLAY;</span>
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span>            :                 /*prevents this context from being removed in direct draw mode by requesting a new one
<span class="lineNum">     768 </span>            :                 but not allocating it*/
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :                 if (tr_state-&gt;immediate_draw)</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :                         visual_2d_get_drawable_context(visual);</span>
<span class="lineNum">     771 </span>            : 
<span class="lineNum">     772 </span>            :                 return GF_TRUE;
<span class="lineNum">     773 </span>            :         }
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span>            :         //will pause clock if first HW load
<span class="lineNum">     776 </span><span class="lineCov">      23792 :         gf_sc_texture_check_pause_on_first_load(txh, GF_TRUE);</span>
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span><span class="lineCov">      23792 :         if (overlay_type) {</span>
<span class="lineNum">     779 </span>            :                 u32 push_time;
<span class="lineNum">     780 </span>            : 
<span class="lineNum">     781 </span>            :                 /*top level overlay*/
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :                 if (flush_video) {</span>
<span class="lineNum">     783 </span>            :                         GF_Window rc;
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :                         rc.x = rc.y = 0;</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :                         rc.w = visual-&gt;compositor-&gt;display_width;</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :                         rc.h = visual-&gt;compositor-&gt;display_height;</span>
<span class="lineNum">     787 </span>            : 
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :                         visual_2d_release_raster(visual);</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :                         visual-&gt;compositor-&gt;video_out-&gt;Flush(visual-&gt;compositor-&gt;video_out, &amp;rc);</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :                         visual_2d_init_raster(visual);</span>
<span class="lineNum">     791 </span>            :                 }
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :                 visual-&gt;compositor-&gt;skip_flush = 1;</span>
<span class="lineNum">     793 </span>            : 
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :                 push_time = gf_sys_clock();</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :                 e = visual-&gt;compositor-&gt;video_out-&gt;Blit(visual-&gt;compositor-&gt;video_out, &amp;video_src, &amp;src_wnd, &amp;dst_wnd, 1);</span>
<span class="lineNum">     796 </span>            : 
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :                 if (!e) {</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :                         store_blit_times(txh, push_time);</span>
<span class="lineNum">     799 </span>            :                         /*mark drawable as overlay*/
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :                         ctx-&gt;drawable-&gt;flags |= DRAWABLE_IS_OVERLAY;</span>
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :                         visual-&gt;has_overlays = GF_TRUE;</span>
<span class="lineNum">     802 </span>            : 
<span class="lineNum">     803 </span>            :                         //will resume clock if first HW load
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :                         gf_sc_texture_check_pause_on_first_load(txh, GF_FALSE);</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">     806 </span>            :                 }
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_COMPOSE, (&quot;[Compositor2D] Error during overlay blit - trying with soft one\n&quot;));</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :                 visual-&gt;compositor-&gt;skip_flush = GF_FALSE;</span>
<span class="lineNum">     809 </span>            :         }
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span>            :         /*most graphic cards can't perform bliting on locked surface - force unlock by releasing the hardware*/
<span class="lineNum">     812 </span><span class="lineCov">      23792 :         is_attached = visual-&gt;is_attached;</span>
<span class="lineNum">     813 </span><span class="lineCov">      23792 :         if (is_attached) visual_2d_release_raster(visual);</span>
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span><span class="lineCov">      23792 :         if (!use_soft_stretch) {</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :                 u32 push_time = gf_sys_clock();</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :                 e = visual-&gt;compositor-&gt;video_out-&gt;Blit(visual-&gt;compositor-&gt;video_out, &amp;video_src, &amp;src_wnd, &amp;dst_wnd, 0);</span>
<span class="lineNum">     818 </span>            : 
<span class="lineNum">     819 </span>            :                 /*HW pb, try soft*/
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :                 if (e) {</span>
<span class="lineNum">     821 </span>            :                         use_soft_stretch = GF_TRUE;
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :                         if (visual-&gt;compositor-&gt;video_memory==1) {</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_COMPOSE, (&quot;[Compositor2D] Error during hardware blit - will use soft one\n&quot;));</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :                                 visual-&gt;compositor-&gt;video_memory = 2;</span>
<span class="lineNum">     825 </span>            :                         }
<span class="lineNum">     826 </span>            :                         /*force a reconfigure of video output*/
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :                         else if (visual-&gt;compositor-&gt;video_memory!=2) {</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_COMPOSE, (&quot;[Compositor2D] Reconfiguring video output to use video memory\n&quot;));</span>
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :                                 visual-&gt;compositor-&gt;request_video_memory = GF_TRUE;</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :                                 visual-&gt;compositor-&gt;root_visual_setup = GF_FALSE;</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :                                 gf_sc_next_frame_state(visual-&gt;compositor, GF_SC_DRAW_FRAME);</span>
<span class="lineNum">     832 </span>            :                         }
<span class="lineNum">     833 </span>            :                 } else {
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :                         store_blit_times(txh, push_time);</span>
<span class="lineNum">     835 </span>            :                 }
<span class="lineNum">     836 </span>            :         }
<span class="lineNum">     837 </span>            : 
<span class="lineNum">     838 </span>            :         //will resume clock if first HW load
<span class="lineNum">     839 </span><span class="lineCov">      23792 :         gf_sc_texture_check_pause_on_first_load(txh, GF_FALSE);</span>
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span><span class="lineCov">      23792 :         if (use_soft_stretch) {</span>
<span class="lineNum">     842 </span>            :                 GF_VideoSurface backbuffer;
<span class="lineNum">     843 </span><span class="lineCov">      23792 :                 if (!visual-&gt;compositor-&gt;softblt) {</span>
<span class="lineNum">     844 </span><span class="lineCov">        116 :                         if (is_attached) visual_2d_init_raster(visual);</span>
<span class="lineNum">     845 </span><span class="lineCov">        116 :                         txh-&gt;flags |= GF_SR_TEXTURE_DISABLE_BLIT;</span>
<span class="lineNum">     846 </span><span class="lineCov">        345 :                         return GF_FALSE;</span>
<span class="lineNum">     847 </span>            :                 }
<span class="lineNum">     848 </span>            : 
<span class="lineNum">     849 </span><span class="lineCov">      23676 :                 e = visual-&gt;compositor-&gt;video_out-&gt;LockBackBuffer(visual-&gt;compositor-&gt;video_out, &amp;backbuffer, GF_TRUE);</span>
<span class="lineNum">     850 </span><span class="lineCov">      23676 :                 if (!e) {</span>
<span class="lineNum">     851 </span><span class="lineCov">      23676 :                         u32 push_time = gf_sys_clock();</span>
<span class="lineNum">     852 </span><span class="lineCov">      23676 :                         e = gf_stretch_bits(&amp;backbuffer, &amp;video_src, &amp;dst_wnd, &amp;src_wnd, alpha, GF_FALSE, tr_state-&gt;col_key, ctx-&gt;col_mat);</span>
<span class="lineNum">     853 </span><span class="lineCov">      23676 :                         store_blit_times(txh, push_time);</span>
<span class="lineNum">     854 </span><span class="lineCov">      23676 :                         visual-&gt;compositor-&gt;video_out-&gt;LockBackBuffer(visual-&gt;compositor-&gt;video_out, &amp;backbuffer, GF_FALSE);</span>
<span class="lineNum">     855 </span><span class="lineCov">      23676 :                         if (e) {</span>
<span class="lineNum">     856 </span><span class="lineCov">        113 :                                 if (e != GF_NOT_SUPPORTED) {</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_COMPOSE, (&quot;[Compositor2D] Cannot soft blit surface (error %s) - will try using software rasterizer\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :                                         visual-&gt;compositor-&gt;last_error = e;</span>
<span class="lineNum">     859 </span>            :                                 }
<span class="lineNum">     860 </span><span class="lineCov">        113 :                                 if (is_attached) visual_2d_init_raster(visual);</span>
<span class="lineNum">     861 </span><span class="lineCov">        113 :                                 txh-&gt;flags |= GF_SR_TEXTURE_DISABLE_BLIT;</span>
<span class="lineNum">     862 </span><span class="lineCov">        113 :                                 return GF_FALSE;</span>
<span class="lineNum">     863 </span>            :                         }
<span class="lineNum">     864 </span>            :                 } else {
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :                         if (e != GF_NOT_SUPPORTED) {</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_COMPOSE, (&quot;[Compositor2D] Cannot lock back buffer - Error %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :                                 visual-&gt;compositor-&gt;last_error = e;</span>
<span class="lineNum">     868 </span>            :                         }
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :                         if (is_attached) visual_2d_init_raster(visual);</span>
<span class="lineNum">     870 </span>            :                         return GF_FALSE;
<span class="lineNum">     871 </span>            :                 }
<span class="lineNum">     872 </span><span class="lineCov">      23563 :                 if (!visual-&gt;compositor-&gt;video_memory) {</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_INFO, GF_LOG_COMPOSE, (&quot;[Compositor2D] Reconfiguring video output to use video memory\n&quot;));</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :                         visual-&gt;compositor-&gt;video_memory = 1;</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :                         visual-&gt;compositor-&gt;root_visual_setup = GF_FALSE;</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :                         gf_sc_next_frame_state(visual-&gt;compositor, GF_SC_DRAW_FRAME);</span>
<span class="lineNum">     877 </span>            :                 }
<span class="lineNum">     878 </span>            :         }
<span class="lineNum">     879 </span><span class="lineCov">      23563 :         visual-&gt;has_modif = GF_TRUE;</span>
<span class="lineNum">     880 </span><span class="lineCov">      23563 :         if (is_attached) visual_2d_init_raster(visual);</span>
<span class="lineNum">     881 </span>            :         return GF_TRUE;
<span class="lineNum">     882 </span>            : }
<span class="lineNum">     883 </span>            : 
<a name="884"><span class="lineNum">     884 </span>            : </a>
<span class="lineNum">     885 </span>            : 
<span class="lineNum">     886 </span><span class="lineCov">      21925 : Bool compositor_2d_draw_bitmap(GF_VisualManager *visual, GF_TraverseState *tr_state, DrawableContext *ctx)</span>
<span class="lineNum">     887 </span>            : {
<span class="lineNum">     888 </span>            :         u8 alpha = 0xFF;
<span class="lineNum">     889 </span>            : 
<span class="lineNum">     890 </span><span class="lineCov">      21925 :         if (!ctx-&gt;aspect.fill_texture) return GF_TRUE;</span>
<span class="lineNum">     891 </span><span class="lineCov">      21925 :         if ((ctx-&gt;aspect.fill_texture == visual-&gt;compositor-&gt;passthrough_txh) &amp;&amp; visual-&gt;compositor-&gt;passthrough_inplace)</span>
<span class="lineNum">     892 </span>            :                 return GF_TRUE;
<span class="lineNum">     893 </span>            :         /*check if texture is ready - if not pretend we drew it*/
<span class="lineNum">     894 </span><span class="lineCov">      21896 :         if (!ctx-&gt;aspect.fill_texture-&gt;data) return GF_TRUE;</span>
<span class="lineNum">     895 </span><span class="lineCov">      21870 :         if (ctx-&gt;transform.m[0]&lt;0) return GF_FALSE;</span>
<span class="lineNum">     896 </span>            :         /*check if the &lt;0 value is due to a flip in he scene description or
<span class="lineNum">     897 </span>            :         due to bifs&lt;-&gt;svg... context switching*/
<span class="lineNum">     898 </span><span class="lineCov">      21870 :         if (ctx-&gt;transform.m[4]&lt;0) {</span>
<span class="lineNum">     899 </span><span class="lineCov">         11 :                 if (!(ctx-&gt;flags &amp; CTX_FLIPED_COORDS)) return GF_FALSE;</span>
<span class="lineNum">     900 </span>            :         } else {
<span class="lineNum">     901 </span><span class="lineCov">      21859 :                 if (ctx-&gt;flags &amp; CTX_FLIPED_COORDS) return GF_FALSE;</span>
<span class="lineNum">     902 </span>            :         }
<span class="lineNum">     903 </span><span class="lineCov">      21859 :         if (ctx-&gt;transform.m[1] || ctx-&gt;transform.m[3]) return GF_FALSE;</span>
<span class="lineNum">     904 </span>            : #ifndef GPAC_DISABLE_VRML
<span class="lineNum">     905 </span><span class="lineCov">      21599 :         if ((ctx-&gt;flags &amp; CTX_HAS_APPEARANCE) &amp;&amp; ctx-&gt;appear &amp;&amp; ((M_Appearance*)ctx-&gt;appear)-&gt;textureTransform)</span>
<span class="lineNum">     906 </span>            :                 return GF_FALSE;
<span class="lineNum">     907 </span>            : #endif
<span class="lineNum">     908 </span>            : 
<span class="lineNum">     909 </span><span class="lineCov">      20108 :         alpha = GF_COL_A(ctx-&gt;aspect.fill_color);</span>
<span class="lineNum">     910 </span>            :         /*THIS IS A HACK, will not work when setting filled=0, transparency and XLineProps*/
<span class="lineNum">     911 </span><span class="lineCov">      20108 :         if (!alpha) alpha = GF_COL_A(ctx-&gt;aspect.line_color);</span>
<span class="lineNum">     912 </span>            : 
<span class="lineNum">     913 </span><span class="lineCov">      20108 :         if (!alpha) return GF_TRUE;</span>
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span><span class="lineCov">      20108 :         switch (ctx-&gt;aspect.fill_texture-&gt;pixelformat) {</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :         case GF_PIXEL_YUVD:</span>
<span class="lineNum">     917 </span>            :         case GF_PIXEL_RGBD:
<span class="lineNum">     918 </span>            :         case GF_PIXEL_RGBDS:
<span class="lineNum">     919 </span>            : #ifndef GPAC_DISABLE_3D
<span class="lineNum">     920 </span>            :                 /*using OpenGL to render depth images*/
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :                 if (visual-&gt;compositor-&gt;depth_gl_type) {</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :                         gf_sc_set_option(visual-&gt;compositor, GF_OPT_USE_OPENGL, 2);</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">     924 </span>            :                 }
<span class="lineNum">     925 </span>            : #endif
<span class="lineNum">     926 </span>            :                 //fallthrought
<span class="lineNum">     927 </span>            :         default:
<span class="lineNum">     928 </span>            :                 break;
<span class="lineNum">     929 </span>            :         }
<span class="lineNum">     930 </span>            : 
<span class="lineNum">     931 </span>            :         /*direct drawing, no clippers */
<span class="lineNum">     932 </span><span class="lineCov">      20108 :         if (tr_state-&gt;immediate_draw) {</span>
<span class="lineNum">     933 </span><span class="lineCov">        254 :                 if (visual-&gt;compositor-&gt;video_out-&gt;BlitTexture) {</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :                         if (! visual-&gt;compositor-&gt;video_out-&gt;BlitTexture(visual-&gt;compositor-&gt;video_out, ctx-&gt;aspect.fill_texture, &amp;ctx-&gt;transform, &amp;ctx-&gt;bi-&gt;clip, alpha, tr_state-&gt;col_key</span>
<span class="lineNum">     935 </span>            : #ifdef GF_SR_USE_DEPTH
<span class="lineNum">     936 </span>            :                                 , ctx-&gt;depth_offset, ctx-&gt;depth_gain
<span class="lineNum">     937 </span>            : #else
<span class="lineNum">     938 </span>            :                                 , 0, 0
<span class="lineNum">     939 </span>            : #endif
<span class="lineNum">     940 </span>            :                                                                         ))
<span class="lineNum">     941 </span>            :                                 return GF_FALSE;
<span class="lineNum">     942 </span>            :                 } else {
<span class="lineNum">     943 </span><span class="lineCov">        254 :                         if (!compositor_2d_draw_bitmap_ex(visual, ctx-&gt;aspect.fill_texture, ctx, &amp;ctx-&gt;bi-&gt;clip, &amp;ctx-&gt;bi-&gt;unclip, alpha, tr_state, GF_FALSE))</span>
<span class="lineNum">     944 </span>            :                                 return GF_FALSE;
<span class="lineNum">     945 </span>            :                 }
<span class="lineNum">     946 </span>            :         }
<span class="lineNum">     947 </span>            :         /*draw bitmap for all dirty rects*/
<span class="lineNum">     948 </span>            :         else {
<span class="lineNum">     949 </span>            :                 u32 i;
<span class="lineNum">     950 </span>            :                 GF_IRect clip;
<span class="lineNum">     951 </span><span class="lineCov">      26780 :                 for (i=0; i&lt;tr_state-&gt;visual-&gt;to_redraw.count; i++) {</span>
<span class="lineNum">     952 </span>            :                         /*there's an opaque region above, don't draw*/
<span class="lineNum">     953 </span>            : #ifdef TRACK_OPAQUE_REGIONS
<span class="lineNum">     954 </span>            :                         if (tr_state-&gt;visual-&gt;draw_node_index &lt; tr_state-&gt;visual-&gt;to_redraw.list[i].opaque_node_index) continue;
<span class="lineNum">     955 </span>            : #endif
<span class="lineNum">     956 </span><span class="lineCov">      27014 :                         clip = ctx-&gt;bi-&gt;clip;</span>
<span class="lineNum">     957 </span><span class="lineCov">      27014 :                         gf_irect_intersect(&amp;clip, &amp;tr_state-&gt;visual-&gt;to_redraw.list[i].rect);</span>
<span class="lineNum">     958 </span><span class="lineCov">      27014 :                         if (clip.width &amp;&amp; clip.height) {</span>
<span class="lineNum">     959 </span><span class="lineCov">      23621 :                                 if (visual-&gt;compositor-&gt;video_out-&gt;BlitTexture) {</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :                                         if (!visual-&gt;compositor-&gt;video_out-&gt;BlitTexture(visual-&gt;compositor-&gt;video_out, ctx-&gt;aspect.fill_texture, &amp;ctx-&gt;transform, &amp;ctx-&gt;bi-&gt;clip, alpha, tr_state-&gt;col_key</span>
<span class="lineNum">     961 </span>            : #ifdef GF_SR_USE_DEPTH
<span class="lineNum">     962 </span>            :                                                 , ctx-&gt;depth_offset, ctx-&gt;depth_gain
<span class="lineNum">     963 </span>            : #else
<span class="lineNum">     964 </span>            :                                                 , 0, 0
<span class="lineNum">     965 </span>            : #endif
<span class="lineNum">     966 </span>            :                                                                                        ))
<span class="lineNum">     967 </span><span class="lineCov">        234 :                                                 return GF_FALSE;</span>
<span class="lineNum">     968 </span><span class="lineCov">      23621 :                                 } else if (!compositor_2d_draw_bitmap_ex(visual, ctx-&gt;aspect.fill_texture, ctx, &amp;clip, &amp;ctx-&gt;bi-&gt;unclip, alpha, tr_state, GF_FALSE)) {</span>
<span class="lineNum">     969 </span>            :                                         return GF_FALSE;
<span class="lineNum">     970 </span>            :                                 }
<span class="lineNum">     971 </span>            :                         }
<span class="lineNum">     972 </span>            :                 }
<span class="lineNum">     973 </span>            :         }
<span class="lineNum">     974 </span><span class="lineCov">      19796 :         ctx-&gt;aspect.fill_texture-&gt;flags |= GF_SR_TEXTURE_USED;</span>
<span class="lineNum">     975 </span><span class="lineCov">      19796 :         return GF_TRUE;</span>
<span class="lineNum">     976 </span>            : }
<a name="977"><span class="lineNum">     977 </span>            : </a>
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span><span class="lineCov">        584 : GF_Err compositor_2d_set_aspect_ratio(GF_Compositor *compositor)</span>
<span class="lineNum">     980 </span>            : {
<span class="lineNum">     981 </span>            :         u32 old_vp_width, old_vp_height;
<span class="lineNum">     982 </span>            :         Bool changed = GF_FALSE;
<span class="lineNum">     983 </span>            :         Double ratio;
<span class="lineNum">     984 </span>            :         GF_Event evt;
<span class="lineNum">     985 </span>            :         GF_Err e;
<span class="lineNum">     986 </span>            :         Fixed scaleX, scaleY;
<span class="lineNum">     987 </span>            : 
<span class="lineNum">     988 </span><span class="lineCov">        584 :         compositor-&gt;output_width = compositor-&gt;scene_width;</span>
<span class="lineNum">     989 </span><span class="lineCov">        584 :         compositor-&gt;output_height = compositor-&gt;scene_height;</span>
<span class="lineNum">     990 </span><span class="lineCov">        584 :         compositor-&gt;vp_x = compositor-&gt;vp_y = 0;</span>
<span class="lineNum">     991 </span>            :         scaleX = scaleY = FIX_ONE;
<span class="lineNum">     992 </span>            : 
<span class="lineNum">     993 </span><span class="lineCov">        584 :         old_vp_width = compositor-&gt;vp_width;</span>
<span class="lineNum">     994 </span><span class="lineCov">        584 :         old_vp_height = compositor-&gt;vp_height;</span>
<span class="lineNum">     995 </span>            : 
<span class="lineNum">     996 </span>            :         /*force complete clean*/
<span class="lineNum">     997 </span><span class="lineCov">        584 :         compositor-&gt;traverse_state-&gt;invalidate_all = GF_TRUE;</span>
<span class="lineNum">     998 </span>            : 
<span class="lineNum">     999 </span><span class="lineCov">        584 :         if (!compositor-&gt;has_size_info &amp;&amp; !(compositor-&gt;override_size_flags &amp; 2) ) {</span>
<span class="lineNum">    1000 </span><span class="lineCov">         28 :                 compositor-&gt;output_width = compositor-&gt;display_width;</span>
<span class="lineNum">    1001 </span><span class="lineCov">         28 :                 compositor-&gt;output_height = compositor-&gt;display_height;</span>
<span class="lineNum">    1002 </span><span class="lineCov">         28 :                 compositor-&gt;vp_width = compositor-&gt;visual-&gt;width = compositor-&gt;output_width;</span>
<span class="lineNum">    1003 </span><span class="lineCov">         28 :                 compositor-&gt;vp_height = compositor-&gt;visual-&gt;height = compositor-&gt;output_height;</span>
<span class="lineNum">    1004 </span>            :         } else {
<span class="lineNum">    1005 </span><span class="lineCov">        556 :                 if (compositor-&gt;rotate_mode % 2) {</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :                         compositor-&gt;vp_height = compositor-&gt;display_width;</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :                         compositor-&gt;vp_width = compositor-&gt;display_height;</span>
<span class="lineNum">    1008 </span>            :                 } else {
<span class="lineNum">    1009 </span><span class="lineCov">        556 :                         compositor-&gt;vp_width = compositor-&gt;display_width;</span>
<span class="lineNum">    1010 </span><span class="lineCov">        556 :                         compositor-&gt;vp_height = compositor-&gt;display_height;</span>
<span class="lineNum">    1011 </span>            :                 }
<span class="lineNum">    1012 </span>            : 
<span class="lineNum">    1013 </span><span class="lineCov">        556 :                 switch (compositor-&gt;aspect_ratio) {</span>
<span class="lineNum">    1014 </span>            :                 case GF_ASPECT_RATIO_FILL_SCREEN:
<span class="lineNum">    1015 </span>            :                         break;
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :                 case GF_ASPECT_RATIO_16_9:</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :                         compositor-&gt;vp_width = compositor-&gt;display_width;</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :                         compositor-&gt;vp_height = 9 * compositor-&gt;display_width / 16;</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :                         if (compositor-&gt;vp_height&gt;compositor-&gt;display_height) {</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :                                 compositor-&gt;vp_height = compositor-&gt;display_height;</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :                                 compositor-&gt;vp_width = 16 * compositor-&gt;display_height / 9;</span>
<span class="lineNum">    1022 </span>            :                         }
<span class="lineNum">    1023 </span>            :                         break;
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :                 case GF_ASPECT_RATIO_4_3:</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :                         compositor-&gt;vp_width = compositor-&gt;display_width;</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :                         compositor-&gt;vp_height = 3 * compositor-&gt;display_width / 4;</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :                         if (compositor-&gt;vp_height&gt;compositor-&gt;display_height) {</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :                                 compositor-&gt;vp_height = compositor-&gt;display_height;</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :                                 compositor-&gt;vp_width = 4 * compositor-&gt;display_height / 3;</span>
<span class="lineNum">    1030 </span>            :                         }
<span class="lineNum">    1031 </span>            :                         break;
<span class="lineNum">    1032 </span><span class="lineCov">        556 :                 default:</span>
<span class="lineNum">    1033 </span><span class="lineCov">        556 :                         ratio = compositor-&gt;scene_height;</span>
<span class="lineNum">    1034 </span><span class="lineCov">        556 :                         ratio /= compositor-&gt;scene_width;</span>
<span class="lineNum">    1035 </span><span class="lineCov">        556 :                         if (compositor-&gt;vp_width * ratio &gt; compositor-&gt;vp_height) {</span>
<span class="lineNum">    1036 </span><span class="lineCov">         21 :                                 compositor-&gt;vp_width = compositor-&gt;vp_height * compositor-&gt;scene_width;</span>
<span class="lineNum">    1037 </span><span class="lineCov">         21 :                                 compositor-&gt;vp_width /= compositor-&gt;scene_height;</span>
<span class="lineNum">    1038 </span>            :                         }
<span class="lineNum">    1039 </span>            :                         else {
<span class="lineNum">    1040 </span><span class="lineCov">        535 :                                 compositor-&gt;vp_height = compositor-&gt;vp_width * compositor-&gt;scene_height;</span>
<span class="lineNum">    1041 </span><span class="lineCov">        535 :                                 compositor-&gt;vp_height /= compositor-&gt;scene_width;</span>
<span class="lineNum">    1042 </span>            :                         }
<span class="lineNum">    1043 </span>            :                         break;
<span class="lineNum">    1044 </span>            :                 }
<span class="lineNum">    1045 </span><span class="lineCov">        556 :                 compositor-&gt;vp_x = (compositor-&gt;display_width - compositor-&gt;vp_width) / 2;</span>
<span class="lineNum">    1046 </span><span class="lineCov">        556 :                 compositor-&gt;vp_y = (compositor-&gt;display_height - compositor-&gt;vp_height) / 2;</span>
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span><span class="lineCov">        556 :                 scaleX = gf_divfix(INT2FIX(compositor-&gt;vp_width), INT2FIX(compositor-&gt;scene_width));</span>
<span class="lineNum">    1049 </span><span class="lineCov">        556 :                 if (!scaleX) scaleX = FIX_ONE;</span>
<span class="lineNum">    1050 </span><span class="lineCov">        556 :                 scaleY = gf_divfix(INT2FIX(compositor-&gt;vp_height), INT2FIX(compositor-&gt;scene_height));</span>
<span class="lineNum">    1051 </span><span class="lineCov">        556 :                 if (!scaleY) scaleY = FIX_ONE;</span>
<span class="lineNum">    1052 </span>            : 
<span class="lineNum">    1053 </span><span class="lineCov">        556 :                 if (!compositor-&gt;sz) {</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :                         compositor-&gt;output_width = compositor-&gt;scene_width;</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :                         compositor-&gt;output_height = compositor-&gt;scene_height;</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :                         compositor-&gt;vp_width = FIX2INT(gf_divfix(INT2FIX(compositor-&gt;display_width), scaleX));</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :                         compositor-&gt;vp_height = FIX2INT(gf_divfix(INT2FIX(compositor-&gt;display_height), scaleY));</span>
<span class="lineNum">    1058 </span>            : 
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :                         compositor-&gt;vp_x = (compositor-&gt;vp_width - compositor-&gt;output_width) / 2;</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :                         compositor-&gt;vp_y = (compositor-&gt;vp_height - compositor-&gt;output_height) / 2;</span>
<span class="lineNum">    1061 </span>            : 
<span class="lineNum">    1062 </span>            :                         scaleX = scaleY = FIX_ONE;
<span class="lineNum">    1063 </span>            :                 } else {
<span class="lineNum">    1064 </span><span class="lineCov">        556 :                         compositor-&gt;output_width = compositor-&gt;display_width;</span>
<span class="lineNum">    1065 </span><span class="lineCov">        556 :                         compositor-&gt;output_height = compositor-&gt;display_height;</span>
<span class="lineNum">    1066 </span><span class="lineCov">        556 :                         compositor-&gt;vp_width = compositor-&gt;display_width;</span>
<span class="lineNum">    1067 </span><span class="lineCov">        556 :                         compositor-&gt;vp_height = compositor-&gt;display_height;</span>
<span class="lineNum">    1068 </span>            :                 }
<span class="lineNum">    1069 </span><span class="lineCov">        556 :                 compositor-&gt;visual-&gt;width = compositor-&gt;output_width;</span>
<span class="lineNum">    1070 </span><span class="lineCov">        556 :                 compositor-&gt;visual-&gt;height = compositor-&gt;output_height;</span>
<span class="lineNum">    1071 </span>            :         }
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span>            :         /*resize hardware surface*/
<span class="lineNum">    1074 </span>            :         memset(&amp;evt, 0, sizeof(GF_Event));
<span class="lineNum">    1075 </span><span class="lineCov">        584 :         evt.type = GF_EVENT_VIDEO_SETUP;</span>
<span class="lineNum">    1076 </span><span class="lineCov">        584 :         evt.setup.width = compositor-&gt;vp_width;</span>
<span class="lineNum">    1077 </span><span class="lineCov">        584 :         evt.setup.height = compositor-&gt;vp_height;</span>
<span class="lineNum">    1078 </span>            :         evt.setup.use_opengl = GF_FALSE;
<span class="lineNum">    1079 </span><span class="lineCov">        584 :         evt.setup.disable_vsync = compositor-&gt;bench_mode ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1080 </span>            :         /*copy over settings*/
<span class="lineNum">    1081 </span><span class="lineCov">        584 :         evt.setup.system_memory = compositor-&gt;video_memory ? GF_FALSE : GF_TRUE;</span>
<span class="lineNum">    1082 </span><span class="lineCov">        584 :         if (compositor-&gt;request_video_memory) evt.setup.system_memory = GF_FALSE;</span>
<span class="lineNum">    1083 </span><span class="lineCov">        584 :         compositor-&gt;request_video_memory = GF_FALSE;</span>
<span class="lineNum">    1084 </span>            : 
<span class="lineNum">    1085 </span>            : #ifndef GPAC_DISABLE_3D
<span class="lineNum">    1086 </span><span class="lineCov">        584 :         if (compositor-&gt;hybrid_opengl) {</span>
<span class="lineNum">    1087 </span><span class="lineCov">         21 :                 evt.setup.use_opengl = GF_TRUE;</span>
<span class="lineNum">    1088 </span><span class="lineCov">         21 :                 evt.setup.system_memory = GF_FALSE;</span>
<span class="lineNum">    1089 </span><span class="lineCov">         21 :                 evt.setup.back_buffer = GF_TRUE;</span>
<span class="lineNum">    1090 </span>            :         }
<span class="lineNum">    1091 </span>            : #endif
<span class="lineNum">    1092 </span>            : 
<span class="lineNum">    1093 </span><span class="lineCov">        584 :         if (compositor-&gt;was_system_memory != evt.setup.system_memory) changed = GF_TRUE;</span>
<span class="lineNum">    1094 </span><span class="lineCov">         90 :         else if (old_vp_width != compositor-&gt;vp_width) changed = GF_TRUE;</span>
<span class="lineNum">    1095 </span><span class="lineCov">         88 :         else if (old_vp_height != compositor-&gt;vp_height) changed = GF_TRUE;</span>
<span class="lineNum">    1096 </span><span class="lineCov">         87 :         else if (compositor-&gt;is_opengl != evt.setup.use_opengl) changed = GF_TRUE;</span>
<span class="lineNum">    1097 </span>            : 
<span class="lineNum">    1098 </span>            : 
<span class="lineNum">    1099 </span>            :         if (changed) {
<span class="lineNum">    1100 </span><span class="lineCov">        497 :                 GF_LOG(GF_LOG_INFO, GF_LOG_COMPOSE, (&quot;[Compositor2D] Reconfiguring display size %d x %d - opengl %s - use %s memory\n&quot;, evt.setup.width, evt.setup.height,</span>
<span class="lineNum">    1101 </span>            :                                                      evt.setup.use_opengl ? &quot;yes&quot; : &quot;no&quot;, evt.setup.system_memory ? &quot;systems&quot; : &quot;video&quot;
<span class="lineNum">    1102 </span>            :                                                     ));
<span class="lineNum">    1103 </span>            : 
<span class="lineNum">    1104 </span><span class="lineCov">        497 :                 e = compositor-&gt;video_out-&gt;ProcessEvent(compositor-&gt;video_out, &amp;evt);</span>
<span class="lineNum">    1105 </span><span class="lineCov">        497 :                 if (e) {</span>
<span class="lineNum">    1106 </span>            : #ifndef GPAC_DISABLE_3D
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :                         if (!compositor-&gt;hybrid_opengl) {</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :                                 compositor-&gt;hybrid_opengl = GF_TRUE;</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_COMPOSE, (&quot;[Compositor2D] Failed to configure 2D output (%s) - retrying in OpenGL mode\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :                                 return compositor_2d_set_aspect_ratio(compositor);</span>
<span class="lineNum">    1111 </span>            :                         }
<span class="lineNum">    1112 </span>            : #endif
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :                         compositor-&gt;video_setup_failed = GF_TRUE;</span>
<span class="lineNum">    1114 </span>            :                         memset(&amp;evt, 0, sizeof(GF_Event));
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :                         evt.type = GF_EVENT_QUIT;</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :                         evt.message.error = e;</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :                         evt.message.message = &quot;Cannot setup video output&quot;;</span>
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :                         gf_sc_send_event(compositor, &amp;evt);</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :                         return e;</span>
<span class="lineNum">    1120 </span>            :                 }
<span class="lineNum">    1121 </span>            : 
<span class="lineNum">    1122 </span><span class="lineCov">        497 :                 compositor-&gt;is_opengl = evt.setup.use_opengl;</span>
<span class="lineNum">    1123 </span><span class="lineCov">        497 :                 compositor-&gt;was_system_memory = evt.setup.system_memory;</span>
<span class="lineNum">    1124 </span>            : 
<span class="lineNum">    1125 </span><span class="lineCov">        497 :                 if (evt.setup.use_opengl) {</span>
<span class="lineNum">    1126 </span><span class="lineCov">         21 :                         gf_opengl_init();</span>
<span class="lineNum">    1127 </span>            :                 }
<span class="lineNum">    1128 </span>            :         }
<span class="lineNum">    1129 </span><span class="lineCov">        584 :         if (compositor-&gt;has_size_info) {</span>
<span class="lineNum">    1130 </span><span class="lineCov">        556 :                 compositor-&gt;traverse_state-&gt;vp_size.x = INT2FIX(compositor-&gt;scene_width);</span>
<span class="lineNum">    1131 </span><span class="lineCov">        556 :                 compositor-&gt;traverse_state-&gt;vp_size.y = INT2FIX(compositor-&gt;scene_height);</span>
<span class="lineNum">    1132 </span>            :         } else {
<span class="lineNum">    1133 </span><span class="lineCov">         28 :                 compositor-&gt;traverse_state-&gt;vp_size.x = INT2FIX(compositor-&gt;output_width);</span>
<span class="lineNum">    1134 </span><span class="lineCov">         28 :                 compositor-&gt;traverse_state-&gt;vp_size.y = INT2FIX(compositor-&gt;output_height);</span>
<span class="lineNum">    1135 </span>            :         }
<span class="lineNum">    1136 </span><span class="lineCov">        584 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_COMPOSE, (&quot;[Compositor2D] Reconfigured display size %d x %d done\n&quot;, evt.setup.width, evt.setup.height));</span>
<span class="lineNum">    1137 </span>            : 
<span class="lineNum">    1138 </span>            :         /*set scale factor*/
<span class="lineNum">    1139 </span><span class="lineCov">        584 :         compositor_set_ar_scale(compositor, scaleX, scaleY);</span>
<span class="lineNum">    1140 </span><span class="lineCov">        584 :         return GF_OK;</span>
<a name="1141"><span class="lineNum">    1141 </span>            : }</a>
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span><span class="lineCov">        682 : void compositor_send_resize_event(GF_Compositor *compositor, GF_SceneGraph *subscene, Fixed old_z, Fixed old_tx, Fixed old_ty, Bool is_resize)</span>
<span class="lineNum">    1144 </span>            : {
<span class="lineNum">    1145 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    1146 </span>            :         GF_DOM_Event evt;
<span class="lineNum">    1147 </span>            :         u32 i;
<span class="lineNum">    1148 </span><span class="lineCov">        682 :         GF_SceneGraph *scene = (subscene ? subscene : compositor-&gt;scene);</span>
<span class="lineNum">    1149 </span><span class="lineCov">        682 :         GF_Node *root = gf_sg_get_root_node(scene);</span>
<span class="lineNum">    1150 </span>            :         /*if root node is not DOM, sent a resize event (for VRML/BIFS). Otherwise this must be handled
<span class="lineNum">    1151 </span>            :         by the composition code of the node*/
<span class="lineNum">    1152 </span><span class="lineCov">        682 :         if (!root || (gf_node_get_tag(root) &gt; GF_NODE_RANGE_LAST_VRML) )</span>
<span class="lineNum">    1153 </span><span class="lineCov">         28 :                 return;</span>
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span>            :         memset(&amp;evt, 0, sizeof(GF_DOM_Event));
<span class="lineNum">    1156 </span><span class="lineCov">        654 :         evt.prev_scale = compositor-&gt;scale_x*old_z;</span>
<span class="lineNum">    1157 </span><span class="lineCov">        654 :         evt.new_scale = compositor-&gt;scale_x*compositor-&gt;zoom;</span>
<span class="lineNum">    1158 </span><span class="lineCov">        654 :         evt.bubbles = 1;</span>
<span class="lineNum">    1159 </span>            : 
<span class="lineNum">    1160 </span><span class="lineCov">        654 :         if (is_resize) {</span>
<span class="lineNum">    1161 </span><span class="lineCov">        641 :                 evt.type = GF_EVENT_RESIZE;</span>
<span class="lineNum">    1162 </span><span class="lineCov">        641 :                 if (subscene == NULL) {</span>
<span class="lineNum">    1163 </span><span class="lineCov">        641 :                         evt.screen_rect.width = INT2FIX(compositor-&gt;display_width);</span>
<span class="lineNum">    1164 </span><span class="lineCov">        641 :                         evt.screen_rect.height = INT2FIX(compositor-&gt;display_height);</span>
<span class="lineNum">    1165 </span>            :                 } else {
<span class="lineNum">    1166 </span>            :                         u32 w, h;
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :                         gf_sg_get_scene_size_info(scene, &amp;w, &amp;h);</span>
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :                         evt.screen_rect.width = INT2FIX(w);</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :                         evt.screen_rect.height = INT2FIX(h);</span>
<span class="lineNum">    1170 </span>            :                 }
<span class="lineNum">    1171 </span><span class="lineCov">         13 :         } else if (evt.prev_scale == evt.new_scale) {</span>
<span class="lineNum">    1172 </span>            :                 /*cannot get params for scroll events*/
<span class="lineNum">    1173 </span><span class="lineCov">         13 :                 evt.type = GF_EVENT_SCROLL;</span>
<span class="lineNum">    1174 </span>            :         } else {
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :                 evt.screen_rect.x = INT2FIX(compositor-&gt;vp_x);</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :                 evt.screen_rect.y = INT2FIX(compositor-&gt;vp_y);</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :                 evt.screen_rect.width = INT2FIX(compositor-&gt;output_width);</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :                 evt.screen_rect.height = INT2FIX(compositor-&gt;output_height);</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :                 evt.prev_translate.x = old_tx;</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :                 evt.prev_translate.y = old_ty;</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :                 evt.new_translate.x = compositor-&gt;trans_x;</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :                 evt.new_translate.y = compositor-&gt;trans_y;</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :                 evt.type = GF_EVENT_ZOOM;</span>
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 :                 evt.bubbles = 0;</span>
<span class="lineNum">    1185 </span>            :         }
<span class="lineNum">    1186 </span><span class="lineCov">        654 :         gf_dom_event_fire(gf_sg_get_root_node(scene), &amp;evt);</span>
<span class="lineNum">    1187 </span>            : 
<span class="lineNum">    1188 </span><span class="lineCov">        654 :         i=0;</span>
<span class="lineNum">    1189 </span><span class="lineCov">       1308 :         while ((scene = (GF_SceneGraph*)gf_list_enum(compositor-&gt;extra_scenes, &amp;i))) {</span>
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :                 gf_dom_event_fire(gf_sg_get_root_node(scene), &amp;evt);</span>
<span class="lineNum">    1191 </span>            :         }
<span class="lineNum">    1192 </span>            : 
<a name="1193"><span class="lineNum">    1193 </span>            : #endif</a>
<span class="lineNum">    1194 </span>            : }
<span class="lineNum">    1195 </span><span class="lineCov">       3064 : void compositor_2d_set_user_transform(GF_Compositor *compositor, Fixed zoom, Fixed tx, Fixed ty, Bool is_resize)</span>
<span class="lineNum">    1196 </span>            : {
<span class="lineNum">    1197 </span>            :         Fixed ratio;
<span class="lineNum">    1198 </span>            :         Fixed old_tx, old_ty, old_z;
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span><span class="lineCov">       3064 :         gf_sc_lock(compositor, GF_TRUE);</span>
<span class="lineNum">    1201 </span>            :         old_tx = tx;
<span class="lineNum">    1202 </span>            :         old_ty = ty;
<span class="lineNum">    1203 </span><span class="lineCov">       3064 :         old_z = compositor-&gt;zoom;</span>
<span class="lineNum">    1204 </span>            : 
<span class="lineNum">    1205 </span><span class="lineCov">       3064 :         if (zoom &lt;= 0) zoom = FIX_ONE/1000;</span>
<span class="lineNum">    1206 </span><span class="lineCov">       3064 :         compositor-&gt;trans_x = tx;</span>
<span class="lineNum">    1207 </span><span class="lineCov">       3064 :         compositor-&gt;trans_y = ty;</span>
<span class="lineNum">    1208 </span>            : 
<span class="lineNum">    1209 </span><span class="lineCov">       3064 :         if (zoom != compositor-&gt;zoom) {</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :                 ratio = gf_divfix(zoom, compositor-&gt;zoom);</span>
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :                 compositor-&gt;trans_x = gf_mulfix(compositor-&gt;trans_x, ratio);</span>
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :                 compositor-&gt;trans_y = gf_mulfix(compositor-&gt;trans_y, ratio);</span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :                 compositor-&gt;zoom = zoom;</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :                 compositor-&gt;zoom_changed = GF_TRUE;</span>
<span class="lineNum">    1215 </span>            : 
<span class="lineNum">    1216 </span>            :                 /*recenter visual*/
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :                 if (!compositor-&gt;visual-&gt;center_coords) {</span>
<span class="lineNum">    1218 </span>            :                         Fixed c_x, c_y, nc_x, nc_y;
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :                         c_x = INT2FIX(compositor-&gt;display_width/2);</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :                         c_y = INT2FIX(compositor-&gt;display_height/2);</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :                         nc_x = gf_mulfix(c_x, ratio);</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :                         nc_y = gf_mulfix(c_y, ratio);</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :                         compositor-&gt;trans_x -= (nc_x-c_x);</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :                         compositor-&gt;trans_y -= (nc_y-c_y);</span>
<span class="lineNum">    1225 </span>            :                 }
<span class="lineNum">    1226 </span>            :         }
<span class="lineNum">    1227 </span><span class="lineCov">       6128 :         gf_mx2d_init(compositor-&gt;traverse_state-&gt;transform);</span>
<span class="lineNum">    1228 </span>            : 
<span class="lineNum">    1229 </span><span class="lineCov">       3064 :         switch (compositor-&gt;rotate_mode) {</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :         case 1:</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :                 gf_mx2d_add_rotation(&amp;compositor-&gt;traverse_state-&gt;transform, 0, 0, -GF_PI/2);</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :         case 2:</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :                 gf_mx2d_add_scale(&amp;compositor-&gt;traverse_state-&gt;transform, -1, -1);</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :         case 3:</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :                 gf_mx2d_add_rotation(&amp;compositor-&gt;traverse_state-&gt;transform, 0, 0, GF_PI/2);</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1239 </span>            :         }
<span class="lineNum">    1240 </span>            : 
<span class="lineNum">    1241 </span><span class="lineCov">       3064 :         gf_mx2d_add_scale(&amp;compositor-&gt;traverse_state-&gt;transform, gf_mulfix(compositor-&gt;zoom,compositor-&gt;scale_x), gf_mulfix(compositor-&gt;zoom,compositor-&gt;scale_y));</span>
<span class="lineNum">    1242 </span>            : 
<span class="lineNum">    1243 </span><span class="lineCov">       3064 :         gf_mx2d_add_translation(&amp;compositor-&gt;traverse_state-&gt;transform, compositor-&gt;trans_x, compositor-&gt;trans_y);</span>
<span class="lineNum">    1244 </span><span class="lineCov">       3064 :         if (compositor-&gt;rotation) gf_mx2d_add_rotation(&amp;compositor-&gt;traverse_state-&gt;transform, 0, 0, compositor-&gt;rotation);</span>
<span class="lineNum">    1245 </span>            : 
<span class="lineNum">    1246 </span><span class="lineCov">       3064 :         if (!compositor-&gt;visual-&gt;center_coords) {</span>
<span class="lineNum">    1247 </span><span class="lineCov">         84 :                 gf_mx2d_add_translation(&amp;compositor-&gt;traverse_state-&gt;transform, INT2FIX(compositor-&gt;vp_x), INT2FIX(compositor-&gt;vp_y));</span>
<span class="lineNum">    1248 </span>            :         }
<span class="lineNum">    1249 </span>            : 
<span class="lineNum">    1250 </span><span class="lineCov">       3064 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_COMPOSE, (&quot;[Compositor2D] Changing Zoom (%g) and Pan (%g %g)\n&quot;, FIX2FLT(compositor-&gt;zoom), FIX2FLT(compositor-&gt;trans_x) , FIX2FLT(compositor-&gt;trans_y)));</span>
<span class="lineNum">    1251 </span>            : 
<span class="lineNum">    1252 </span>            : 
<span class="lineNum">    1253 </span><span class="lineCov">       3064 :         gf_sc_next_frame_state(compositor, GF_SC_DRAW_FRAME);</span>
<span class="lineNum">    1254 </span><span class="lineCov">       3064 :         compositor-&gt;traverse_state-&gt;invalidate_all = GF_TRUE;</span>
<span class="lineNum">    1255 </span>            : 
<span class="lineNum">    1256 </span>            :         /*for zoom&amp;pan, send the event right away. For resize/scroll, wait for the frame to be drawn before sending it
<span class="lineNum">    1257 </span>            :         otherwise viewport info of SVG nodes won't be correct*/
<span class="lineNum">    1258 </span><span class="lineCov">       3064 :         if (!is_resize) compositor_send_resize_event(compositor, NULL, old_z, old_tx, old_ty, GF_FALSE);</span>
<span class="lineNum">    1259 </span><span class="lineCov">       3064 :         gf_sc_lock(compositor, GF_FALSE);</span>
<span class="lineNum">    1260 </span><span class="lineCov">       3064 : }</span>
<span class="lineNum">    1261 </span>            : 
<a name="1262"><span class="lineNum">    1262 </span>            : </a>
<span class="lineNum">    1263 </span>            : 
<span class="lineNum">    1264 </span><span class="lineCov">       1962 : GF_Rect compositor_2d_update_clipper(GF_TraverseState *tr_state, GF_Rect this_clip, Bool *need_restore, GF_Rect *original, Bool for_layer)</span>
<span class="lineNum">    1265 </span>            : {
<span class="lineNum">    1266 </span>            :         GF_Rect clip, orig;
<span class="lineNum">    1267 </span><span class="lineCov">       1962 :         if (for_layer) {</span>
<span class="lineNum">    1268 </span><span class="lineCov">        805 :                 orig = tr_state-&gt;layer_clipper;</span>
<span class="lineNum">    1269 </span><span class="lineCov">        805 :                 *need_restore = tr_state-&gt;has_layer_clip;</span>
<span class="lineNum">    1270 </span>            :         } else {
<span class="lineNum">    1271 </span><span class="lineCov">       1157 :                 orig = tr_state-&gt;clipper;</span>
<span class="lineNum">    1272 </span><span class="lineCov">       1157 :                 *need_restore = tr_state-&gt;has_clip;</span>
<span class="lineNum">    1273 </span>            :         }
<span class="lineNum">    1274 </span><span class="lineCov">       1962 :         *original = orig;</span>
<span class="lineNum">    1275 </span>            : 
<span class="lineNum">    1276 </span><span class="lineCov">       1962 :         clip = this_clip;</span>
<span class="lineNum">    1277 </span><span class="lineCov">       1962 :         if (*need_restore) {</span>
<span class="lineNum">    1278 </span>            : #ifndef GPAC_DISABLE_3D
<span class="lineNum">    1279 </span><span class="lineCov">        159 :                 if (tr_state-&gt;visual-&gt;type_3d) {</span>
<span class="lineNum">    1280 </span>            :                         GF_Matrix mx;
<span class="lineNum">    1281 </span><span class="lineCov">        157 :                         gf_mx_copy(mx, tr_state-&gt;model_matrix);</span>
<span class="lineNum">    1282 </span><span class="lineCov">        157 :                         gf_mx_inverse(&amp;mx);</span>
<span class="lineNum">    1283 </span><span class="lineCov">        157 :                         gf_mx_apply_rect(&amp;mx, &amp;orig);</span>
<span class="lineNum">    1284 </span><span class="lineCov">        157 :                         gf_mx_apply_rect(&amp;tr_state-&gt;layer_matrix, &amp;orig);</span>
<span class="lineNum">    1285 </span>            :                 } else
<span class="lineNum">    1286 </span>            : #endif
<span class="lineNum">    1287 </span>            :                 {
<span class="lineNum">    1288 </span>            :                         GF_Matrix2D mx2d;
<span class="lineNum">    1289 </span><span class="lineCov">          2 :                         gf_mx2d_copy(mx2d, tr_state-&gt;transform);</span>
<span class="lineNum">    1290 </span><span class="lineCov">          2 :                         gf_mx2d_inverse(&amp;mx2d);</span>
<span class="lineNum">    1291 </span><span class="lineCov">          2 :                         gf_mx2d_apply_rect(&amp;mx2d, &amp;orig);</span>
<span class="lineNum">    1292 </span>            :                 }
<span class="lineNum">    1293 </span>            : 
<span class="lineNum">    1294 </span><span class="lineCov">        159 :                 if (clip.x &lt; orig.x) {</span>
<span class="lineNum">    1295 </span><span class="lineCov">        151 :                         clip.width -= (orig.x - clip.x);</span>
<span class="lineNum">    1296 </span>            :                         clip.x = orig.x;
<span class="lineNum">    1297 </span>            :                 }
<span class="lineNum">    1298 </span><span class="lineCov">        159 :                 if (clip.x + clip.width &gt; orig.x + orig.width) {</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :                         clip.width = orig.x + orig.width - clip.x;</span>
<span class="lineNum">    1300 </span>            :                 }
<span class="lineNum">    1301 </span><span class="lineCov">        159 :                 if (clip.y &gt; orig.y) {</span>
<span class="lineNum">    1302 </span><span class="lineNoCov">          0 :                         clip.height -= (clip.y - orig.y);</span>
<span class="lineNum">    1303 </span>            :                         clip.y = orig.y;
<span class="lineNum">    1304 </span>            :                 }
<span class="lineNum">    1305 </span><span class="lineCov">        159 :                 if (clip.y - clip.height &lt; orig.y - orig.height) {</span>
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :                         clip.height = clip.y - orig.y + orig.height;</span>
<span class="lineNum">    1307 </span>            :                 }
<span class="lineNum">    1308 </span>            :         }
<span class="lineNum">    1309 </span><span class="lineCov">       1962 :         if (for_layer) {</span>
<span class="lineNum">    1310 </span><span class="lineCov">        805 :                 tr_state-&gt;layer_clipper = clip;</span>
<span class="lineNum">    1311 </span><span class="lineCov">        805 :                 tr_state-&gt;has_layer_clip = GF_TRUE;</span>
<span class="lineNum">    1312 </span>            : #ifndef GPAC_DISABLE_3D
<span class="lineNum">    1313 </span><span class="lineCov">        805 :                 if (tr_state-&gt;visual-&gt;type_3d) {</span>
<span class="lineNum">    1314 </span><span class="lineCov">        805 :                         gf_mx_copy(tr_state-&gt;layer_matrix, tr_state-&gt;model_matrix);</span>
<span class="lineNum">    1315 </span>            :                 }
<span class="lineNum">    1316 </span>            : #endif
<span class="lineNum">    1317 </span>            :         } else {
<span class="lineNum">    1318 </span><span class="lineCov">       1157 :                 tr_state-&gt;clipper = clip;</span>
<span class="lineNum">    1319 </span>            : #ifndef GPAC_DISABLE_3D
<span class="lineNum">    1320 </span><span class="lineCov">       1157 :                 if (tr_state-&gt;visual-&gt;type_3d) {</span>
<span class="lineNum">    1321 </span>            :                         /*retranslate to world coords*/
<span class="lineNum">    1322 </span><span class="lineCov">        300 :                         gf_mx_apply_rect(&amp;tr_state-&gt;model_matrix, &amp;tr_state-&gt;clipper);</span>
<span class="lineNum">    1323 </span>            :                         /*if 2D, also update with user zoom and translation*/
<span class="lineNum">    1324 </span><span class="lineCov">        300 :                         if (!tr_state-&gt;camera-&gt;is_3D)</span>
<span class="lineNum">    1325 </span><span class="lineCov">        300 :                                 gf_mx_apply_rect(&amp;tr_state-&gt;camera-&gt;modelview, &amp;tr_state-&gt;clipper);</span>
<span class="lineNum">    1326 </span>            :                 } else
<span class="lineNum">    1327 </span>            : #endif
<span class="lineNum">    1328 </span>            : 
<span class="lineNum">    1329 </span><span class="lineCov">        857 :                         gf_mx2d_apply_rect(&amp;tr_state-&gt;transform, &amp;tr_state-&gt;clipper);</span>
<span class="lineNum">    1330 </span>            : 
<span class="lineNum">    1331 </span><span class="lineCov">       1157 :                 tr_state-&gt;has_clip = GF_TRUE;</span>
<span class="lineNum">    1332 </span>            :         }
<span class="lineNum">    1333 </span><span class="lineCov">       1962 :         return clip;</span>
<span class="lineNum">    1334 </span>            : }
<span class="lineNum">    1335 </span>            : 
<a name="1336"><span class="lineNum">    1336 </span>            : </a>
<span class="lineNum">    1337 </span>            : /*overlay management*/
<span class="lineNum">    1338 </span><span class="lineCov">     117729 : Bool visual_2d_overlaps_overlay(GF_VisualManager *visual, DrawableContext *ctx, GF_TraverseState *tr_state)</span>
<span class="lineNum">    1339 </span>            : {
<span class="lineNum">    1340 </span>            :         u32 res = 0;
<span class="lineNum">    1341 </span>            :         GF_OverlayStack *ol;
<span class="lineNum">    1342 </span><span class="lineCov">     117729 :         GF_Compositor *compositor = visual-&gt;compositor;</span>
<span class="lineNum">    1343 </span><span class="lineCov">     117729 :         if (compositor-&gt;visual != visual) return GF_FALSE;</span>
<span class="lineNum">    1344 </span>            : 
<span class="lineNum">    1345 </span><span class="lineCov">     116157 :         ol = visual-&gt;overlays;</span>
<span class="lineNum">    1346 </span><span class="lineCov">     232314 :         while (ol) {</span>
<span class="lineNum">    1347 </span>            :                 u32 i;
<span class="lineNum">    1348 </span>            :                 GF_IRect clip;
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :                 if (ctx == ol-&gt;ctx) {</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :                         ol = ol-&gt;next;</span>
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1352 </span>            :                 }
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :                 clip = ctx-&gt;bi-&gt;clip;</span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :                 if (!ol-&gt;ra.count &amp;&amp; !gf_irect_overlaps(&amp;ol-&gt;ctx-&gt;bi-&gt;clip, &amp;clip)) {</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :                         ol = ol-&gt;next;</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1357 </span>            :                 }
<span class="lineNum">    1358 </span>            :                 /*check previsously drawn areas*/
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;ol-&gt;ra.count; i++) {</span>
<span class="lineNum">    1360 </span>            :                         /*we have drawn something here, don't draw*/
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :                         if (gf_irect_inside(&amp;ol-&gt;ra.list[i].rect, &amp;clip))</span>
<span class="lineNum">    1362 </span>            :                                 break;
<span class="lineNum">    1363 </span>            :                 }
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :                 res++;</span>
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 :                 if (i&lt;ol-&gt;ra.count) {</span>
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 :                         ol = ol-&gt;next;</span>
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1368 </span>            :                 }
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span>            :                 /*note that we add the entire cliper, not the intersection with the overlay one. This is a simple way
<span class="lineNum">    1371 </span>            :                 to handle the case where Drawble2 overlaps Drawable1 overlaps Overlay but Drawable2 doesn't overlaps Overlay
<span class="lineNum">    1372 </span>            :                 by adding the entire drawable cliper, we will postpone drawing of all interconnected regions touching the overlay*/
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :                 ra_union_rect(&amp;ol-&gt;ra, &amp;clip);</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :                 ol = ol-&gt;next;</span>
<span class="lineNum">    1375 </span>            :         }
<span class="lineNum">    1376 </span><span class="lineCov">     116157 :         return res ? GF_TRUE : GF_FALSE;</span>
<a name="1377"><span class="lineNum">    1377 </span>            : }</a>
<span class="lineNum">    1378 </span>            : 
<span class="lineNum">    1379 </span><span class="lineCov">      15811 : void visual_2d_flush_overlay_areas(GF_VisualManager *visual, GF_TraverseState *tr_state)</span>
<span class="lineNum">    1380 </span>            : {
<span class="lineNum">    1381 </span>            :         DrawableContext *ctx;
<span class="lineNum">    1382 </span>            :         GF_OverlayStack *ol;
<span class="lineNum">    1383 </span><span class="lineCov">      15811 :         GF_Compositor *compositor = visual-&gt;compositor;</span>
<span class="lineNum">    1384 </span><span class="lineCov">      15811 :         if (compositor-&gt;visual != visual) return;</span>
<span class="lineNum">    1385 </span>            : 
<span class="lineNum">    1386 </span>            :         /*draw all overlays*/
<span class="lineNum">    1387 </span><span class="lineCov">      14819 :         tr_state-&gt;traversing_mode = TRAVERSE_DRAW_2D;</span>
<span class="lineNum">    1388 </span><span class="lineCov">      14819 :         ol = visual-&gt;overlays;</span>
<span class="lineNum">    1389 </span><span class="lineCov">      29638 :         while (ol) {</span>
<span class="lineNum">    1390 </span>            :                 u32 i;
<span class="lineNum">    1391 </span>            :                 Bool needs_draw = GF_TRUE;
<span class="lineNum">    1392 </span>            :                 GF_IRect the_clip, vid_clip;
<span class="lineNum">    1393 </span>            : 
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :                 ra_refresh(&amp;ol-&gt;ra);</span>
<span class="lineNum">    1395 </span>            : 
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;ol-&gt;ra.count; i++) {</span>
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :                         the_clip = ol-&gt;ra.list[i].rect;</span>
<span class="lineNum">    1398 </span>            : 
<span class="lineNum">    1399 </span>            :                         /*draw all objects above this overlay*/
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :                         ctx = ol-&gt;ctx-&gt;next;</span>
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :                         while (ctx &amp;&amp; ctx-&gt;drawable) {</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :                                 if (gf_irect_overlaps(&amp;ctx-&gt;bi-&gt;clip, &amp;the_clip)) {</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :                                         GF_IRect prev_clip = ctx-&gt;bi-&gt;clip;</span>
<span class="lineNum">    1404 </span>            : 
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :                                         if (needs_draw) {</span>
<span class="lineNum">    1406 </span>            :                                                 /*if first object above is not transparent and completely covers the overlay skip video redraw*/
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :                                                 if ((ctx-&gt;flags &amp; CTX_IS_TRANSPARENT) || !gf_irect_inside(&amp;prev_clip, &amp;the_clip)) {</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :                                                         vid_clip = ol-&gt;ra.list[i].rect;</span>
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :                                                         gf_irect_intersect(&amp;vid_clip, &amp;ol-&gt;ctx-&gt;bi-&gt;clip);</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :                                                         compositor_2d_draw_bitmap_ex(visual, ol-&gt;ctx-&gt;aspect.fill_texture, ol-&gt;ctx, &amp;vid_clip, &amp;ol-&gt;ctx-&gt;bi-&gt;unclip, 0xFF, tr_state, GF_TRUE);</span>
<span class="lineNum">    1411 </span>            :                                                 }
<span class="lineNum">    1412 </span>            :                                                 needs_draw = GF_FALSE;
<span class="lineNum">    1413 </span>            :                                         }
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 :                                         gf_irect_intersect(&amp;ctx-&gt;bi-&gt;clip, &amp;the_clip);</span>
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :                                         tr_state-&gt;ctx = ctx;</span>
<span class="lineNum">    1416 </span>            : 
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :                                         if (ctx-&gt;drawable-&gt;flags &amp; DRAWABLE_USE_TRAVERSE_DRAW) {</span>
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :                                                 gf_node_traverse(ctx-&gt;drawable-&gt;node, tr_state);</span>
<span class="lineNum">    1419 </span>            :                                         } else {
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :                                                 drawable_draw(ctx-&gt;drawable, tr_state);</span>
<span class="lineNum">    1421 </span>            :                                         }
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :                                         ctx-&gt;bi-&gt;clip = prev_clip;</span>
<span class="lineNum">    1423 </span>            :                                 }
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :                                 ctx = ctx-&gt;next;</span>
<span class="lineNum">    1425 </span>            :                         }
<span class="lineNum">    1426 </span>            :                 }
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :                 ol = ol-&gt;next;</span>
<span class="lineNum">    1428 </span>            :         }
<a name="1429"><span class="lineNum">    1429 </span>            : }</a>
<span class="lineNum">    1430 </span>            : 
<span class="lineNum">    1431 </span><span class="lineCov">      26387 : void visual_2d_draw_overlays(GF_VisualManager *visual)</span>
<span class="lineNum">    1432 </span>            : {
<span class="lineNum">    1433 </span>            :         GF_Err e;
<span class="lineNum">    1434 </span>            :         GF_TextureHandler *txh;
<span class="lineNum">    1435 </span>            :         GF_VideoSurface video_src;
<span class="lineNum">    1436 </span>            : 
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :         while (1) {</span>
<span class="lineNum">    1438 </span><span class="lineCov">      26387 :                 GF_OverlayStack *ol = visual-&gt;overlays;</span>
<span class="lineNum">    1439 </span><span class="lineCov">      52774 :                 if (!ol) return;</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :                 visual-&gt;overlays = ol-&gt;next;</span>
<span class="lineNum">    1441 </span>            : 
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :                 txh = ol-&gt;ctx-&gt;aspect.fill_texture;</span>
<span class="lineNum">    1443 </span>            :                 memset(&amp;video_src, 0, sizeof(GF_VideoSurface));
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :                 video_src.height = txh-&gt;height;</span>
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :                 video_src.width = txh-&gt;width;</span>
<span class="lineNum">    1446 </span>            :                 video_src.pitch_x = 0;
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :                 video_src.pitch_y = txh-&gt;stride;</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :                 video_src.pixel_format = txh-&gt;pixelformat;</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :                 video_src.video_buffer = txh-&gt;data;</span>
<span class="lineNum">    1450 </span>            : 
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :                 e = visual-&gt;compositor-&gt;video_out-&gt;Blit(visual-&gt;compositor-&gt;video_out, &amp;video_src, &amp;ol-&gt;src, &amp;ol-&gt;dst, 2);</span>
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :                 if (e) GF_LOG(GF_LOG_ERROR, GF_LOG_COMPOSE, (&quot;[Visual2D] Error %s during overlay update\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    1453 </span>            : 
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :                 ra_del(&amp;ol-&gt;ra);</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :                 gf_free(ol);</span>
<span class="lineNum">    1456 </span>            :         }
<a name="1457"><span class="lineNum">    1457 </span>            : }</a>
<span class="lineNum">    1458 </span>            : 
<span class="lineNum">    1459 </span><span class="lineCov">        605 : void compositor_2d_init_callbacks(GF_Compositor *compositor)</span>
<span class="lineNum">    1460 </span>            : {
<span class="lineNum">    1461 </span><span class="lineCov">        605 :         compositor-&gt;visual-&gt;DrawBitmap = compositor_2d_draw_bitmap;</span>
<span class="lineNum">    1462 </span><span class="lineCov">        605 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

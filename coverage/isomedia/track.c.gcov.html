<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - isomedia/track.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">isomedia</a> - track.c<span style="font-size: 80%;"> (source / <a href="track.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">635</td>
            <td class="headerCovTableEntry">813</td>
            <td class="headerCovTableEntryMed">78.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">13</td>
            <td class="headerCovTableEntry">13</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2000-2020
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / ISO Media File Format sub-project
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/internal/isomedia_dev.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      28 </span>            : 
<a name="29"><span class="lineNum">      29 </span>            : #ifndef GPAC_DISABLE_ISOM</a>
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span><span class="lineCov">         56 : GF_TrackBox *GetTrackbyID(GF_MovieBox *moov, GF_ISOTrackID TrackID)</span>
<span class="lineNum">      32 </span>            : {
<span class="lineNum">      33 </span>            :         GF_TrackBox *trak;
<span class="lineNum">      34 </span>            :         u32 i;
<span class="lineNum">      35 </span><span class="lineCov">         56 :         if (!moov) return NULL;</span>
<span class="lineNum">      36 </span><span class="lineCov">         56 :         i=0;</span>
<span class="lineNum">      37 </span><span class="lineCov">        139 :         while ((trak = (GF_TrackBox *)gf_list_enum(moov-&gt;trackList, &amp;i))) {</span>
<span class="lineNum">      38 </span><span class="lineCov">         81 :                 if (trak-&gt;Header-&gt;trackID == TrackID) return trak;</span>
<span class="lineNum">      39 </span>            :         }
<span class="lineNum">      40 </span>            :         return NULL;
<a name="41"><span class="lineNum">      41 </span>            : }</a>
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span><span class="lineCov">    6158961 : GF_TrackBox *gf_isom_get_track(GF_MovieBox *moov, u32 trackNumber)</span>
<span class="lineNum">      44 </span>            : {
<span class="lineNum">      45 </span>            :         GF_TrackBox *trak;
<span class="lineNum">      46 </span><span class="lineCov">    6158961 :         if (!moov || !trackNumber || (trackNumber &gt; gf_list_count(moov-&gt;trackList))) return NULL;</span>
<span class="lineNum">      47 </span><span class="lineCov">    6157736 :         trak = (GF_TrackBox*)gf_list_get(moov-&gt;trackList, trackNumber - 1);</span>
<span class="lineNum">      48 </span><span class="lineCov">    6157736 :         return trak;</span>
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span>            : }
<span class="lineNum">      51 </span>            : 
<a name="52"><span class="lineNum">      52 </span>            : //get the number of a track given its ID</a>
<span class="lineNum">      53 </span>            : //return 0 if not found error
<span class="lineNum">      54 </span><span class="lineCov">     101153 : u32 gf_isom_get_tracknum_from_id(GF_MovieBox *moov, GF_ISOTrackID trackID)</span>
<span class="lineNum">      55 </span>            : {
<span class="lineNum">      56 </span>            :         u32 i;
<span class="lineNum">      57 </span>            :         GF_TrackBox *trak;
<span class="lineNum">      58 </span><span class="lineCov">     101153 :         i=0;</span>
<span class="lineNum">      59 </span><span class="lineCov">     346954 :         while ((trak = (GF_TrackBox *)gf_list_enum(moov-&gt;trackList, &amp;i))) {</span>
<span class="lineNum">      60 </span><span class="lineCov">     245801 :                 if (trak-&gt;Header-&gt;trackID == trackID) return i;</span>
<span class="lineNum">      61 </span>            :         }
<span class="lineNum">      62 </span>            :         return 0;
<span class="lineNum">      63 </span>            : }
<a name="64"><span class="lineNum">      64 </span>            : </a>
<span class="lineNum">      65 </span>            : //extraction of the ESD from the track
<span class="lineNum">      66 </span><span class="lineCov">       1902 : GF_Err GetESD(GF_MovieBox *moov, GF_ISOTrackID trackID, u32 StreamDescIndex, GF_ESD **outESD)</span>
<span class="lineNum">      67 </span>            : {
<span class="lineNum">      68 </span>            :         GF_Err e;
<span class="lineNum">      69 </span>            :         GF_ESD *esd;
<span class="lineNum">      70 </span>            :         u32 track_num = 0;
<span class="lineNum">      71 </span>            :         u32 k;
<span class="lineNum">      72 </span>            :         GF_SampleTableBox *stbl;
<span class="lineNum">      73 </span>            :         GF_TrackBox *trak, *OCRTrack;
<span class="lineNum">      74 </span>            :         GF_TrackReferenceTypeBox *dpnd;
<span class="lineNum">      75 </span>            :         GF_SLConfig *slc;
<span class="lineNum">      76 </span>            :         GF_MPEGSampleEntryBox *entry;
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineCov">       1902 :         if (!moov) return GF_ISOM_INVALID_FILE;</span>
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span><span class="lineCov">       1902 :         track_num = gf_isom_get_tracknum_from_id(moov, trackID);</span>
<span class="lineNum">      81 </span><span class="lineCov">       1902 :         dpnd = NULL;</span>
<span class="lineNum">      82 </span><span class="lineCov">       1902 :         *outESD = NULL;</span>
<span class="lineNum">      83 </span>            : 
<span class="lineNum">      84 </span><span class="lineCov">       1902 :         trak = gf_isom_get_track(moov, track_num);</span>
<span class="lineNum">      85 </span><span class="lineCov">       1902 :         if (!trak) return GF_ISOM_INVALID_FILE;</span>
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span><span class="lineCov">       1902 :         e = Media_GetESD(trak-&gt;Media, StreamDescIndex, &amp;esd, 0);</span>
<span class="lineNum">      88 </span><span class="lineCov">       1902 :         if (e) return e;</span>
<span class="lineNum">      89 </span><span class="lineCov">       1781 :         if (!esd) return GF_NON_COMPLIANT_BITSTREAM;</span>
<span class="lineNum">      90 </span>            : 
<span class="lineNum">      91 </span><span class="lineCov">       1781 :         e = Media_GetSampleDesc(trak-&gt;Media, StreamDescIndex, (GF_SampleEntryBox **) &amp;entry, NULL);</span>
<span class="lineNum">      92 </span><span class="lineCov">       1781 :         if (e) return e;</span>
<span class="lineNum">      93 </span>            :         //set the ID
<span class="lineNum">      94 </span><span class="lineCov">       1781 :         esd-&gt;ESID = trackID;</span>
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            :         //find stream dependencies: dpnd, sbas and scal
<span class="lineNum">      97 </span><span class="lineCov">       7085 :         for (k=0; k&lt;3; k++) {</span>
<span class="lineNum">      98 </span>            :                 u32 ref = GF_ISOM_BOX_TYPE_DPND;
<span class="lineNum">      99 </span><span class="lineCov">       5325 :                 if (k==1) ref = GF_ISOM_REF_BASE;</span>
<span class="lineNum">     100 </span><span class="lineCov">       3544 :                 else if (k==2) ref = GF_ISOM_REF_SCAL;</span>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span><span class="lineCov">       5325 :                 e = Track_FindRef(trak, ref , &amp;dpnd);</span>
<span class="lineNum">     103 </span><span class="lineCov">       5325 :                 if (e) return e;</span>
<span class="lineNum">     104 </span><span class="lineCov">       5325 :                 if (dpnd) {</span>
<span class="lineNum">     105 </span>            :                         //ONLY ONE STREAM DEPENDENCY IS ALLOWED
<span class="lineNum">     106 </span><span class="lineCov">         21 :                         if (!k &amp;&amp; (dpnd-&gt;trackIDCount != 1)) return GF_ISOM_INVALID_MEDIA;</span>
<span class="lineNum">     107 </span>            :                         //fix the spec: where is the index located ??
<span class="lineNum">     108 </span><span class="lineCov">         21 :                         esd-&gt;dependsOnESID = dpnd-&gt;trackIDs[0];</span>
<span class="lineNum">     109 </span><span class="lineCov">         21 :                         break;</span>
<span class="lineNum">     110 </span>            :                 } else {
<span class="lineNum">     111 </span><span class="lineCov">       5304 :                         esd-&gt;dependsOnESID = 0;</span>
<span class="lineNum">     112 </span>            :                 }
<span class="lineNum">     113 </span>            :         }
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span><span class="lineCov">       1781 :         if (trak-&gt;udta) {</span>
<span class="lineNum">     116 </span>            :                 GF_UserDataMap *map;
<span class="lineNum">     117 </span><span class="lineCov">          9 :                 u32 i = 0;</span>
<span class="lineNum">     118 </span><span class="lineCov">         25 :                 while ((map = (GF_UserDataMap*)gf_list_enum(trak-&gt;udta-&gt;recordList, &amp;i))) {</span>
<span class="lineNum">     119 </span><span class="lineCov">          9 :                         if (map-&gt;boxType == GF_ISOM_BOX_TYPE_AUXV) {</span>
<span class="lineNum">     120 </span><span class="lineCov">          2 :                                 GF_Descriptor *d = gf_odf_desc_new(GF_ODF_AUX_VIDEO_DATA);</span>
<span class="lineNum">     121 </span><span class="lineCov">          2 :                                 gf_list_add(esd-&gt;extensionDescriptors, d);</span>
<span class="lineNum">     122 </span><span class="lineCov">          2 :                                 break;</span>
<span class="lineNum">     123 </span>            :                         }
<span class="lineNum">     124 </span>            :                 }
<span class="lineNum">     125 </span>            :         }
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span>            :         //OK, get the OCR (in a REAL MP4File, OCR is 0 in ESD and is specified through track reference
<span class="lineNum">     128 </span><span class="lineCov">       1781 :         dpnd = NULL;</span>
<span class="lineNum">     129 </span>            :         OCRTrack = NULL;
<span class="lineNum">     130 </span>            :         //find OCR dependencies
<span class="lineNum">     131 </span><span class="lineCov">       1781 :         e = Track_FindRef(trak, GF_ISOM_BOX_TYPE_SYNC, &amp;dpnd);</span>
<span class="lineNum">     132 </span><span class="lineCov">       1781 :         if (e) return e;</span>
<span class="lineNum">     133 </span><span class="lineCov">       1781 :         if (dpnd) {</span>
<span class="lineNum">     134 </span><span class="lineCov">         58 :                 if (dpnd-&gt;trackIDCount != 1) return GF_ISOM_INVALID_MEDIA;</span>
<span class="lineNum">     135 </span><span class="lineCov">         58 :                 esd-&gt;OCRESID = dpnd-&gt;trackIDs[0];</span>
<span class="lineNum">     136 </span><span class="lineCov">         58 :                 OCRTrack = gf_isom_get_track_from_id(trak-&gt;moov, dpnd-&gt;trackIDs[0]);</span>
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span><span class="lineCov">        116 :                 while (OCRTrack) {</span>
<span class="lineNum">     139 </span>            :                         /*if we have a dependency on a track that doesn't have OCR dep, remove that dependency*/
<span class="lineNum">     140 </span><span class="lineCov">         58 :                         e = Track_FindRef(OCRTrack, GF_ISOM_BOX_TYPE_SYNC, &amp;dpnd);</span>
<span class="lineNum">     141 </span><span class="lineCov">         58 :                         if (e || !dpnd || !dpnd-&gt;trackIDCount) {</span>
<span class="lineNum">     142 </span>            :                                 OCRTrack = NULL;
<span class="lineNum">     143 </span>            :                                 goto default_sync;
<span class="lineNum">     144 </span>            :                         }
<span class="lineNum">     145 </span>            :                         /*this is explicit desync*/
<span class="lineNum">     146 </span><span class="lineCov">         46 :                         if ((dpnd-&gt;trackIDs[0]==0) || (dpnd-&gt;trackIDs[0]==OCRTrack-&gt;Header-&gt;trackID))</span>
<span class="lineNum">     147 </span>            :                                 break;
<span class="lineNum">     148 </span>            :                         /*loop in OCRs, break it*/
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :                         if (esd-&gt;ESID == (u16) OCRTrack-&gt;Header-&gt;trackID) {</span>
<span class="lineNum">     150 </span>            :                                 OCRTrack = NULL;
<span class="lineNum">     151 </span>            :                                 goto default_sync;
<span class="lineNum">     152 </span>            :                         }
<span class="lineNum">     153 </span>            :                         /*check next*/
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :                         OCRTrack = gf_isom_get_track_from_id(trak-&gt;moov, dpnd-&gt;trackIDs[0]);</span>
<span class="lineNum">     155 </span>            :                 }
<span class="lineNum">     156 </span><span class="lineCov">         46 :                 if (!OCRTrack) goto default_sync;</span>
<span class="lineNum">     157 </span>            :         } else {
<span class="lineNum">     158 </span><span class="lineCov">       1723 : default_sync:</span>
<span class="lineNum">     159 </span>            :                 /*all tracks are sync'ed by default*/
<span class="lineNum">     160 </span><span class="lineCov">       1735 :                 if (trak-&gt;moov-&gt;mov-&gt;es_id_default_sync&lt;0) {</span>
<span class="lineNum">     161 </span><span class="lineCov">       1118 :                         if (esd-&gt;OCRESID)</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :                                 trak-&gt;moov-&gt;mov-&gt;es_id_default_sync = esd-&gt;OCRESID;</span>
<span class="lineNum">     163 </span>            :                         else
<span class="lineNum">     164 </span><span class="lineCov">       1118 :                                 trak-&gt;moov-&gt;mov-&gt;es_id_default_sync = esd-&gt;ESID;</span>
<span class="lineNum">     165 </span>            :                 }
<span class="lineNum">     166 </span><span class="lineCov">       1735 :                 if (trak-&gt;moov-&gt;mov-&gt;es_id_default_sync) esd-&gt;OCRESID = (u16) trak-&gt;moov-&gt;mov-&gt;es_id_default_sync;</span>
<span class="lineNum">     167 </span>            :                 /*cf ESD writer*/
<span class="lineNum">     168 </span><span class="lineCov">       1735 :                 if (esd-&gt;OCRESID == esd-&gt;ESID) esd-&gt;OCRESID = 0;</span>
<span class="lineNum">     169 </span>            :         }
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            :         //update the IPI stuff if needed
<span class="lineNum">     174 </span><span class="lineCov">       1781 :         if (esd-&gt;ipiPtr != NULL) {</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :                 dpnd = NULL;</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :                 e = Track_FindRef(trak, GF_ISOM_BOX_TYPE_IPIR, &amp;dpnd);</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :                 if (e) return e;</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :                 if (dpnd) {</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :                         if (esd-&gt;ipiPtr-&gt;tag != GF_ODF_ISOM_IPI_PTR_TAG) return GF_ISOM_INVALID_FILE;</span>
<span class="lineNum">     180 </span>            :                         //OK, retrieve the ID: the IPI_ES_Id is currently the ref track
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :                         esd-&gt;ipiPtr-&gt;IPI_ES_Id = dpnd-&gt;trackIDs[esd-&gt;ipiPtr-&gt;IPI_ES_Id - 1];</span>
<span class="lineNum">     182 </span>            :                         //and change the tag
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :                         esd-&gt;ipiPtr-&gt;tag = GF_ODF_IPI_PTR_TAG;</span>
<span class="lineNum">     184 </span>            :                 } else {
<span class="lineNum">     185 </span>            :                         return GF_ISOM_INVALID_FILE;
<span class="lineNum">     186 </span>            :                 }
<span class="lineNum">     187 </span>            :         }
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineCov">       3562 :         if ((trak-&gt;Media-&gt;mediaHeader-&gt;packedLanguage[0] != 'u')</span>
<span class="lineNum">     190 </span><span class="lineCov">       1781 :                 || (trak-&gt;Media-&gt;mediaHeader-&gt;packedLanguage[1] != 'n')</span>
<span class="lineNum">     191 </span><span class="lineCov">       1757 :                 || (trak-&gt;Media-&gt;mediaHeader-&gt;packedLanguage[2] != 'd') ) {</span>
<span class="lineNum">     192 </span><span class="lineCov">         24 :                 if (!esd-&gt;langDesc) esd-&gt;langDesc = (GF_Language *) gf_odf_desc_new(GF_ODF_LANG_TAG);</span>
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span><span class="lineCov">         24 :                 esd-&gt;langDesc-&gt;langCode = trak-&gt;Media-&gt;mediaHeader-&gt;packedLanguage[0];</span>
<span class="lineNum">     195 </span><span class="lineCov">         24 :                 esd-&gt;langDesc-&gt;langCode &lt;&lt;= 8;</span>
<span class="lineNum">     196 </span><span class="lineCov">         24 :                 esd-&gt;langDesc-&gt;langCode |= trak-&gt;Media-&gt;mediaHeader-&gt;packedLanguage[1];</span>
<span class="lineNum">     197 </span><span class="lineCov">         24 :                 esd-&gt;langDesc-&gt;langCode &lt;&lt;= 8;</span>
<span class="lineNum">     198 </span><span class="lineCov">         24 :                 esd-&gt;langDesc-&gt;langCode |= trak-&gt;Media-&gt;mediaHeader-&gt;packedLanguage[2];</span>
<span class="lineNum">     199 </span>            :         }
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            :         {
<span class="lineNum">     203 </span>            :                 u16 rvc_predefined;
<span class="lineNum">     204 </span>            :                 u8 *rvc_cfg_data;
<span class="lineNum">     205 </span>            :                 const char *mime_type;
<span class="lineNum">     206 </span>            :                 u32 rvc_cfg_size;
<span class="lineNum">     207 </span><span class="lineCov">       1781 :                 e = gf_isom_get_rvc_config(moov-&gt;mov, track_num, 1, &amp;rvc_predefined, &amp;rvc_cfg_data, &amp;rvc_cfg_size, &amp;mime_type);</span>
<span class="lineNum">     208 </span><span class="lineCov">       1781 :                 if (e==GF_OK) {</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :                         if (rvc_predefined) {</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :                                 esd-&gt;decoderConfig-&gt;predefined_rvc_config = rvc_predefined;</span>
<span class="lineNum">     211 </span>            :                         } else {
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                                 esd-&gt;decoderConfig-&gt;rvc_config = (GF_DefaultDescriptor *) gf_odf_desc_new(GF_ODF_DSI_TAG);</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :                                 if (mime_type &amp;&amp; !strcmp(mime_type, &quot;application/rvc-config+xml+gz&quot;) ) {</span>
<span class="lineNum">     214 </span>            : #if !defined(GPAC_DISABLE_CORE_TOOLS) &amp;&amp; !defined(GPAC_DISABLE_ZLIB)
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :                                         gf_gz_decompress_payload(rvc_cfg_data, rvc_cfg_size, &amp;esd-&gt;decoderConfig-&gt;rvc_config-&gt;data, &amp;esd-&gt;decoderConfig-&gt;rvc_config-&gt;dataLength);</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :                                         gf_free(rvc_cfg_data);</span>
<span class="lineNum">     217 </span>            : #endif
<span class="lineNum">     218 </span>            :                                 } else {
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :                                         esd-&gt;decoderConfig-&gt;rvc_config-&gt;data = rvc_cfg_data;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                                         esd-&gt;decoderConfig-&gt;rvc_config-&gt;dataLength = rvc_cfg_size;</span>
<span class="lineNum">     221 </span>            :                                 }
<span class="lineNum">     222 </span>            :                         }
<span class="lineNum">     223 </span>            :                 }
<span class="lineNum">     224 </span>            :         }
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span>            :         /*normally all files shall be stored with predefined=SLPredef_MP4, but of course some are broken (philips)
<span class="lineNum">     228 </span>            :         so we just check the ESD_URL. If set, use the given cfg, otherwise always rewrite it*/
<span class="lineNum">     229 </span><span class="lineCov">       1781 :         if (esd-&gt;URLString != NULL) {</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :                 *outESD = esd;</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     232 </span>            :         }
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span>            :         //if we are in publishing mode and we have an SLConfig specified, use it as is
<span class="lineNum">     235 </span><span class="lineCov">       1781 :         switch (entry-&gt;type) {</span>
<span class="lineNum">     236 </span><span class="lineCov">        218 :         case GF_ISOM_BOX_TYPE_MP4V:</span>
<span class="lineNum">     237 </span><span class="lineCov">        218 :                 slc = ((GF_MPEGVisualSampleEntryBox *)entry)-&gt;slc;</span>
<span class="lineNum">     238 </span><span class="lineCov">        218 :                 break;</span>
<span class="lineNum">     239 </span><span class="lineCov">        322 :         case GF_ISOM_BOX_TYPE_MP4A:</span>
<span class="lineNum">     240 </span><span class="lineCov">        322 :                 slc = ((GF_MPEGAudioSampleEntryBox *)entry)-&gt;slc;</span>
<span class="lineNum">     241 </span><span class="lineCov">        322 :                 break;</span>
<span class="lineNum">     242 </span><span class="lineCov">        273 :         case GF_ISOM_BOX_TYPE_MP4S:</span>
<span class="lineNum">     243 </span><span class="lineCov">        273 :                 slc = entry-&gt;slc;</span>
<span class="lineNum">     244 </span><span class="lineCov">        273 :                 break;</span>
<span class="lineNum">     245 </span>            :         default:
<span class="lineNum">     246 </span>            :                 slc = NULL;
<span class="lineNum">     247 </span>            :                 break;
<span class="lineNum">     248 </span>            :         }
<span class="lineNum">     249 </span><span class="lineCov">        813 :         if (slc) {</span>
<span class="lineNum">     250 </span><span class="lineCov">        103 :                 gf_odf_desc_del((GF_Descriptor *)esd-&gt;slConfig);</span>
<span class="lineNum">     251 </span><span class="lineCov">        103 :                 gf_odf_desc_copy((GF_Descriptor *)slc, (GF_Descriptor **)&amp;esd-&gt;slConfig);</span>
<span class="lineNum">     252 </span><span class="lineCov">        103 :                 *outESD = esd;</span>
<span class="lineNum">     253 </span><span class="lineCov">        103 :                 return GF_OK;</span>
<span class="lineNum">     254 </span>            :         }
<span class="lineNum">     255 </span>            :         //otherwise use the regular mapping
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span><span class="lineCov">       1678 :         if (!esd-&gt;slConfig)</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :                 esd-&gt;slConfig = (GF_SLConfig *) gf_odf_desc_new(GF_ODF_SLC_TAG);</span>
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span>            :         //this is a desc for a media in the file, let's rewrite some param
<span class="lineNum">     261 </span><span class="lineCov">       1678 :         esd-&gt;slConfig-&gt;timestampLength = 32;</span>
<span class="lineNum">     262 </span><span class="lineCov">       1678 :         esd-&gt;slConfig-&gt;timestampResolution = trak-&gt;Media-&gt;mediaHeader-&gt;timeScale;</span>
<span class="lineNum">     263 </span>            :         //NO OCR from MP4File streams (eg, constant OC Res one)
<span class="lineNum">     264 </span><span class="lineCov">       1678 :         esd-&gt;slConfig-&gt;OCRLength = 0;</span>
<span class="lineNum">     265 </span><span class="lineCov">       1678 :         esd-&gt;slConfig-&gt;OCRResolution = 0;</span>
<span class="lineNum">     266 </span>            : //      if (OCRTrack) esd-&gt;slConfig-&gt;OCRResolution = OCRTrack-&gt;Media-&gt;mediaHeader-&gt;timeScale;
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span><span class="lineCov">       1678 :         stbl = trak-&gt;Media-&gt;information-&gt;sampleTable;</span>
<span class="lineNum">     269 </span>            :         // a little optimization here: if all our samples are sync,
<span class="lineNum">     270 </span>            :         //set the RAPOnly to true... for external users...
<span class="lineNum">     271 </span><span class="lineCov">       1678 :         if (! stbl-&gt;SyncSample) {</span>
<span class="lineNum">     272 </span><span class="lineCov">        781 :                 if (</span>
<span class="lineNum">     273 </span>            : #ifndef GPAC_DISABLE_ISOM_FRAGMENTS
<span class="lineNum">     274 </span><span class="lineCov">       1003 :                     moov-&gt;mvex &amp;&amp;</span>
<span class="lineNum">     275 </span>            : #endif
<span class="lineNum">     276 </span><span class="lineCov">        444 :                     esd-&gt;decoderConfig &amp;&amp; esd-&gt;decoderConfig-&gt;streamType &amp;&amp;</span>
<span class="lineNum">     277 </span>            :                     (esd-&gt;decoderConfig-&gt;streamType==GF_STREAM_VISUAL)
<span class="lineNum">     278 </span>            :                 ) {
<span class="lineNum">     279 </span><span class="lineCov">        160 :                         esd-&gt;slConfig-&gt;hasRandomAccessUnitsOnlyFlag = 0;</span>
<span class="lineNum">     280 </span><span class="lineCov">        160 :                         esd-&gt;slConfig-&gt;useRandomAccessPointFlag = 1;</span>
<span class="lineNum">     281 </span><span class="lineCov">        160 :                         if (trak-&gt;moov-&gt;mov-&gt;openMode!=GF_ISOM_OPEN_READ) {</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :                                 stbl-&gt;SyncSample = (GF_SyncSampleBox *) gf_isom_box_new_parent(&amp;stbl-&gt;child_boxes, GF_ISOM_BOX_TYPE_STSS);</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :                                 if (!stbl-&gt;SyncSample) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     284 </span>            :                         }
<span class="lineNum">     285 </span>            :                 } else {
<span class="lineNum">     286 </span><span class="lineCov">        621 :                         esd-&gt;slConfig-&gt;hasRandomAccessUnitsOnlyFlag = 1;</span>
<span class="lineNum">     287 </span><span class="lineCov">        621 :                         esd-&gt;slConfig-&gt;useRandomAccessPointFlag = 0;</span>
<span class="lineNum">     288 </span>            :                 }
<span class="lineNum">     289 </span>            :         } else {
<span class="lineNum">     290 </span><span class="lineCov">        897 :                 esd-&gt;slConfig-&gt;hasRandomAccessUnitsOnlyFlag = 0;</span>
<span class="lineNum">     291 </span>            :                 //signal we are NOT using sync points if no info is present in the table
<span class="lineNum">     292 </span><span class="lineCov">        897 :                 esd-&gt;slConfig-&gt;useRandomAccessPointFlag = stbl-&gt;SyncSample-&gt;nb_entries ? 1 : 0;</span>
<span class="lineNum">     293 </span>            :         }
<span class="lineNum">     294 </span>            :         //change to support reflecting OD streams
<span class="lineNum">     295 </span><span class="lineCov">       1678 :         esd-&gt;slConfig-&gt;useAccessUnitEndFlag = 1;</span>
<span class="lineNum">     296 </span><span class="lineCov">       1678 :         esd-&gt;slConfig-&gt;useAccessUnitStartFlag = 1;</span>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span>            :         //signal we do have padding flag (since we only use logical SL packet
<span class="lineNum">     299 </span>            :         //the user can decide whether to use the info or not
<span class="lineNum">     300 </span><span class="lineCov">       1678 :         esd-&gt;slConfig-&gt;usePaddingFlag = stbl-&gt;PaddingBits ? 1 : 0;</span>
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span>            :         //same with degradation priority
<span class="lineNum">     303 </span><span class="lineCov">       1678 :         esd-&gt;slConfig-&gt;degradationPriorityLength = stbl-&gt;DegradationPriority ? 32 : 0;</span>
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span>            :         //this new SL will be OUT OF THE FILE. Let's set its predefined to 0
<span class="lineNum">     306 </span><span class="lineCov">       1678 :         esd-&gt;slConfig-&gt;predefined = 0;</span>
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span><span class="lineCov">       1678 :         *outESD = esd;</span>
<span class="lineNum">     310 </span><span class="lineCov">       1678 :         return GF_OK;</span>
<span class="lineNum">     311 </span>            : }
<span class="lineNum">     312 </span>            : 
<a name="313"><span class="lineNum">     313 </span>            : </a>
<span class="lineNum">     314 </span>            : //extraction of the ESD from the track for the given time
<span class="lineNum">     315 </span><span class="lineCov">        187 : GF_Err GetESDForTime(GF_MovieBox *moov, GF_ISOTrackID trackID, u64 CTS, GF_ESD **outESD)</span>
<span class="lineNum">     316 </span>            : {
<span class="lineNum">     317 </span>            :         GF_Err e;
<span class="lineNum">     318 </span>            :         u32 sampleDescIndex;
<span class="lineNum">     319 </span>            :         GF_TrackBox *trak;
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span><span class="lineCov">        187 :         trak = gf_isom_get_track(moov, gf_isom_get_tracknum_from_id(moov, trackID));</span>
<span class="lineNum">     322 </span><span class="lineCov">        187 :         if (!trak) return GF_ISOM_INVALID_FILE;</span>
<span class="lineNum">     323 </span>            : 
<span class="lineNum">     324 </span><span class="lineCov">        187 :         e = Media_GetSampleDescIndex(trak-&gt;Media, CTS, &amp;sampleDescIndex );</span>
<span class="lineNum">     325 </span><span class="lineCov">        187 :         if (e) return e;</span>
<span class="lineNum">     326 </span><span class="lineCov">        187 :         return GetESD(moov, trackID, sampleDescIndex, outESD);</span>
<span class="lineNum">     327 </span>            : }
<a name="328"><span class="lineNum">     328 </span>            : </a>
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span><span class="lineCov">     619935 : GF_Err Track_FindRef(GF_TrackBox *trak, u32 ReferenceType, GF_TrackReferenceTypeBox **dpnd)</span>
<span class="lineNum">     331 </span>            : {
<span class="lineNum">     332 </span>            :         GF_TrackReferenceBox *ref;
<span class="lineNum">     333 </span>            :         GF_TrackReferenceTypeBox *a;
<span class="lineNum">     334 </span>            :         u32 i;
<span class="lineNum">     335 </span><span class="lineCov">     619935 :         if (! trak) return GF_BAD_PARAM;</span>
<span class="lineNum">     336 </span><span class="lineCov">     619935 :         if (! trak-&gt;References) {</span>
<span class="lineNum">     337 </span><span class="lineCov">     223779 :                 *dpnd = NULL;</span>
<span class="lineNum">     338 </span><span class="lineCov">     223779 :                 return GF_OK;</span>
<span class="lineNum">     339 </span>            :         }
<span class="lineNum">     340 </span>            :         ref = trak-&gt;References;
<span class="lineNum">     341 </span><span class="lineCov">     396156 :         i=0;</span>
<span class="lineNum">     342 </span><span class="lineCov">     924034 :         while ((a = (GF_TrackReferenceTypeBox *)gf_list_enum(ref-&gt;child_boxes, &amp;i))) {</span>
<span class="lineNum">     343 </span><span class="lineCov">     407498 :                 if (a-&gt;reference_type == ReferenceType) {</span>
<span class="lineNum">     344 </span><span class="lineCov">     275776 :                         *dpnd = a;</span>
<span class="lineNum">     345 </span><span class="lineCov">     275776 :                         return GF_OK;</span>
<span class="lineNum">     346 </span>            :                 }
<span class="lineNum">     347 </span>            :         }
<span class="lineNum">     348 </span><span class="lineCov">     120380 :         *dpnd = NULL;</span>
<span class="lineNum">     349 </span><span class="lineCov">     120380 :         return GF_OK;</span>
<a name="350"><span class="lineNum">     350 </span>            : }</a>
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span><span class="lineCov">       3792 : Bool Track_IsMPEG4Stream(u32 HandlerType)</span>
<span class="lineNum">     353 </span>            : {
<span class="lineNum">     354 </span><span class="lineCov">       3792 :         switch (HandlerType) {</span>
<span class="lineNum">     355 </span>            :         case GF_ISOM_MEDIA_VISUAL:
<span class="lineNum">     356 </span>            :     case GF_ISOM_MEDIA_AUXV:
<span class="lineNum">     357 </span>            :     case GF_ISOM_MEDIA_PICT:
<span class="lineNum">     358 </span>            :         case GF_ISOM_MEDIA_AUDIO:
<span class="lineNum">     359 </span>            :         case GF_ISOM_MEDIA_SUBPIC:
<span class="lineNum">     360 </span>            :         case GF_ISOM_MEDIA_OD:
<span class="lineNum">     361 </span>            :         case GF_ISOM_MEDIA_OCR:
<span class="lineNum">     362 </span>            :         case GF_ISOM_MEDIA_SCENE:
<span class="lineNum">     363 </span>            :         case GF_ISOM_MEDIA_MPEG7:
<span class="lineNum">     364 </span>            :         case GF_ISOM_MEDIA_OCI:
<span class="lineNum">     365 </span>            :         case GF_ISOM_MEDIA_IPMP:
<span class="lineNum">     366 </span>            :         case GF_ISOM_MEDIA_MPEGJ:
<span class="lineNum">     367 </span>            :         case GF_ISOM_MEDIA_ESM:
<span class="lineNum">     368 </span>            :                 return 1;
<span class="lineNum">     369 </span>            :         /*Timedtext is NOT an MPEG-4 stream*/
<span class="lineNum">     370 </span><span class="lineCov">         40 :         default:</span>
<span class="lineNum">     371 </span>            :                 /*consider xxsm as MPEG-4 handlers*/
<span class="lineNum">     372 </span><span class="lineCov">         40 :                 if ( (((HandlerType&gt;&gt;8) &amp; 0xFF)== 's') &amp;&amp; ((HandlerType&amp; 0xFF)== 'm'))</span>
<span class="lineNum">     373 </span>            :                         return 1;
<span class="lineNum">     374 </span><span class="lineCov">         40 :                 return 0;</span>
<span class="lineNum">     375 </span>            :         }
<span class="lineNum">     376 </span>            : }
<a name="377"><span class="lineNum">     377 </span>            : </a>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineCov">     586785 : GF_Err SetTrackDuration(GF_TrackBox *trak)</span>
<span class="lineNum">     380 </span>            : {
<span class="lineNum">     381 </span>            :         u64 trackDuration;
<span class="lineNum">     382 </span>            :         u32 i;
<span class="lineNum">     383 </span>            :         GF_Err e;
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span>            :         //the total duration is the media duration: adjust it in case...
<span class="lineNum">     386 </span><span class="lineCov">     586785 :         e = Media_SetDuration(trak);</span>
<span class="lineNum">     387 </span><span class="lineCov">     586785 :         if (e) return e;</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span>            :         //assert the timeScales are non-NULL
<span class="lineNum">     390 </span><span class="lineCov">     586785 :         if (!trak-&gt;moov-&gt;mvhd || !trak-&gt;moov-&gt;mvhd-&gt;timeScale || !trak-&gt;Media-&gt;mediaHeader-&gt;timeScale) return GF_ISOM_INVALID_FILE;</span>
<span class="lineNum">     391 </span><span class="lineCov">     586785 :         trackDuration = (trak-&gt;Media-&gt;mediaHeader-&gt;duration * trak-&gt;moov-&gt;mvhd-&gt;timeScale) / trak-&gt;Media-&gt;mediaHeader-&gt;timeScale;</span>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span>            :         //if we have an edit list, the duration is the sum of all the editList
<span class="lineNum">     394 </span>            :         //entries' duration (always expressed in MovieTimeScale)
<span class="lineNum">     395 </span><span class="lineCov">     586785 :         if (trak-&gt;editBox &amp;&amp; trak-&gt;editBox-&gt;editList) {</span>
<span class="lineNum">     396 </span>            :                 GF_EdtsEntry *ent;
<span class="lineNum">     397 </span>            :                 GF_EditListBox *elst = trak-&gt;editBox-&gt;editList;
<span class="lineNum">     398 </span>            :                 trackDuration = 0;
<span class="lineNum">     399 </span><span class="lineCov">      30863 :                 i=0;</span>
<span class="lineNum">     400 </span><span class="lineCov">     104135 :                 while ((ent = (GF_EdtsEntry*)gf_list_enum(elst-&gt;entryList, &amp;i))) {</span>
<span class="lineNum">     401 </span><span class="lineCov">      42409 :                         trackDuration += ent-&gt;segmentDuration;</span>
<span class="lineNum">     402 </span>            :                 }
<span class="lineNum">     403 </span>            :         }
<span class="lineNum">     404 </span><span class="lineCov">     586785 :         if (!trackDuration) {</span>
<span class="lineNum">     405 </span><span class="lineCov">      12889 :                 trackDuration = (trak-&gt;Media-&gt;mediaHeader-&gt;duration * trak-&gt;moov-&gt;mvhd-&gt;timeScale) / trak-&gt;Media-&gt;mediaHeader-&gt;timeScale;</span>
<span class="lineNum">     406 </span>            :         }
<span class="lineNum">     407 </span><span class="lineCov">     586785 :         if (!trak-&gt;Header) {</span>
<span class="lineNum">     408 </span>            :                 return GF_OK;
<span class="lineNum">     409 </span>            :         }
<span class="lineNum">     410 </span><span class="lineCov">     586785 :         trak-&gt;Header-&gt;duration = trackDuration;</span>
<span class="lineNum">     411 </span><span class="lineCov">     586785 :         if (!trak-&gt;moov-&gt;mov-&gt;keep_utc &amp;&amp; !gf_sys_is_test_mode() )</span>
<span class="lineNum">     412 </span><span class="lineCov">        746 :                 trak-&gt;Header-&gt;modificationTime = gf_isom_get_mp4time();</span>
<span class="lineNum">     413 </span>            :         return GF_OK;
<span class="lineNum">     414 </span>            : }
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span>            : #ifndef GPAC_DISABLE_ISOM_FRAGMENTS
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">     420 </span>            : GF_TrunEntry *traf_get_sample_entry(GF_TrackFragmentBox *traf, u32 sample_index)
<span class="lineNum">     421 </span>            : {
<span class="lineNum">     422 </span>            :         u32 i, idx;
<span class="lineNum">     423 </span>            :         GF_TrackFragmentRunBox *trun;
<span class="lineNum">     424 </span>            :         idx=0;
<span class="lineNum">     425 </span>            :         i=0;
<span class="lineNum">     426 </span>            :         while ((trun = (GF_TrackFragmentRunBox *)gf_list_enum(traf-&gt;TrackRuns, &amp;i))) {
<span class="lineNum">     427 </span>            :                 u32 j;
<span class="lineNum">     428 </span>            :                 for (j=0; j&lt;trun-&gt;sample_count; j++) {
<span class="lineNum">     429 </span>            :                         GF_TrunEntry *ent = gf_list_get(trun-&gt;entries, j);
<span class="lineNum">     430 </span>            :                         if (idx==sample_index) return ent;
<span class="lineNum">     431 </span>            :                         if (ent-&gt;nb_pack&gt;1) {
<span class="lineNum">     432 </span>            :                                 if (idx &lt; sample_index + ent-&gt;nb_pack)
<span class="lineNum">     433 </span>            :                                         return ent;
<span class="lineNum">     434 </span>            :                                 idx += ent-&gt;nb_pack;
<span class="lineNum">     435 </span>            :                         } else {
<span class="lineNum">     436 </span>            :                                 idx++;
<span class="lineNum">     437 </span>            :                         }
<span class="lineNum">     438 </span>            :                 }
<span class="lineNum">     439 </span>            :         }
<span class="lineNum">     440 </span>            :         return NULL;
<span class="lineNum">     441 </span>            : }
<span class="lineNum">     442 </span>            : #endif
<a name="443"><span class="lineNum">     443 </span>            : </a>
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineCov">       4079 : GF_Err MergeTrack(GF_TrackBox *trak, GF_TrackFragmentBox *traf, GF_MovieFragmentBox *moof_box, u64 moof_offset, s32 compressed_diff, u64 *cumulated_offset, Bool is_first_merge)</span>
<span class="lineNum">     446 </span>            : {
<span class="lineNum">     447 </span>            :         u32 i, j, chunk_size, track_num;
<span class="lineNum">     448 </span>            :         u64 base_offset, data_offset, traf_duration;
<span class="lineNum">     449 </span>            :         u32 def_duration, DescIndex, def_size, def_flags;
<span class="lineNum">     450 </span>            :         u32 duration, size, flags, prev_trun_data_offset, sample_index;
<span class="lineNum">     451 </span>            :         u8 pad, sync;
<span class="lineNum">     452 </span>            :         u16 degr;
<span class="lineNum">     453 </span>            :         Bool first_samp_in_traf=GF_TRUE;
<span class="lineNum">     454 </span>            :         Bool store_traf_map=GF_FALSE;
<span class="lineNum">     455 </span><span class="lineCov">       4079 :         u8 *moof_template=NULL;</span>
<span class="lineNum">     456 </span><span class="lineCov">       4079 :         u32 moof_template_size=0;</span>
<span class="lineNum">     457 </span>            :         Bool is_seg_start = GF_FALSE;
<span class="lineNum">     458 </span>            :         u64 seg_start=0, sidx_start=0, sidx_end=0, frag_start=0, last_dts=0;
<span class="lineNum">     459 </span>            :         GF_TrackFragmentRunBox *trun;
<span class="lineNum">     460 </span>            :         GF_TrunEntry *ent;
<span class="lineNum">     461 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">     462 </span>            :         GF_TrackFragmentBox *traf_ref = NULL;
<span class="lineNum">     463 </span>            : #endif
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span>            :         GF_Err stbl_AppendTime(GF_SampleTableBox *stbl, u32 duration, u32 nb_pack);
<span class="lineNum">     466 </span>            :         GF_Err stbl_AppendSize(GF_SampleTableBox *stbl, u32 size, u32 nb_pack);
<span class="lineNum">     467 </span>            :         GF_Err stbl_AppendChunk(GF_SampleTableBox *stbl, u64 offset);
<span class="lineNum">     468 </span>            :         GF_Err stbl_AppendSampleToChunk(GF_SampleTableBox *stbl, u32 DescIndex, u32 samplesInChunk);
<span class="lineNum">     469 </span>            :         GF_Err stbl_AppendCTSOffset(GF_SampleTableBox *stbl, s32 CTSOffset);
<span class="lineNum">     470 </span>            :         GF_Err stbl_AppendRAP(GF_SampleTableBox *stbl, u8 isRap);
<span class="lineNum">     471 </span>            :         GF_Err stbl_AppendPadding(GF_SampleTableBox *stbl, u8 padding);
<span class="lineNum">     472 </span>            :         GF_Err stbl_AppendDegradation(GF_SampleTableBox *stbl, u16 DegradationPriority);
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineCov">       4079 :         if (trak-&gt;Header-&gt;trackID != traf-&gt;tfhd-&gt;trackID) return GF_OK;</span>
<span class="lineNum">     475 </span><span class="lineCov">       4079 :         if (!trak-&gt;Media-&gt;information-&gt;sampleTable</span>
<span class="lineNum">     476 </span><span class="lineCov">       4079 :                 || !trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleSize</span>
<span class="lineNum">     477 </span><span class="lineCov">       4079 :                 || !trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;TimeToSample</span>
<span class="lineNum">     478 </span><span class="lineCov">       4079 :                 || !trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleToChunk</span>
<span class="lineNum">     479 </span><span class="lineCov">       4079 :                 || !trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;ChunkOffset</span>
<span class="lineNum">     480 </span>            :         ) {
<span class="lineNum">     481 </span>            :                 return GF_ISOM_INVALID_FILE;
<span class="lineNum">     482 </span>            :         }
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span><span class="lineCov">       4079 :         if (!traf-&gt;trex-&gt;track)</span>
<span class="lineNum">     485 </span><span class="lineCov">        316 :                 traf-&gt;trex-&gt;track = trak;</span>
<span class="lineNum">     486 </span>            : 
<span class="lineNum">     487 </span>            :         //setup all our defaults
<span class="lineNum">     488 </span><span class="lineCov">       4079 :         DescIndex = (traf-&gt;tfhd-&gt;flags &amp; GF_ISOM_TRAF_SAMPLE_DESC) ? traf-&gt;tfhd-&gt;sample_desc_index : traf-&gt;trex-&gt;def_sample_desc_index;</span>
<span class="lineNum">     489 </span><span class="lineCov">       4079 :         if (!DescIndex) {</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[iso file] default sample description set to 0, likely broken ! Fixing to 1\n&quot; ));</span>
<span class="lineNum">     491 </span>            :                 DescIndex = 1;
<span class="lineNum">     492 </span><span class="lineCov">       4079 :         } else if (DescIndex &gt; gf_list_count(trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleDescription-&gt;child_boxes)) {</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[iso file] default sample description set to %d but only %d sample description(s), likely broken ! Fixing to 1\n&quot;, DescIndex, gf_list_count(trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleDescription-&gt;child_boxes)));</span>
<span class="lineNum">     494 </span>            :                 DescIndex = 1;
<span class="lineNum">     495 </span>            :         }
<span class="lineNum">     496 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">     497 </span>            :         if (traf-&gt;trex-&gt;inherit_from_traf_id) {
<span class="lineNum">     498 </span>            :                 u32 traf_count = gf_list_count(moof_box-&gt;TrackList);
<span class="lineNum">     499 </span>            :                 for (i=0; i&lt;traf_count; i++) {
<span class="lineNum">     500 </span>            :                         GF_TrackFragmentBox *atraf = gf_list_get(moof_box-&gt;TrackList, i);
<span class="lineNum">     501 </span>            :                         if (atraf-&gt;tfhd &amp;&amp; atraf-&gt;tfhd-&gt;trackID==traf-&gt;trex-&gt;inherit_from_traf_id) {
<span class="lineNum">     502 </span>            :                                 traf_ref = atraf;
<span class="lineNum">     503 </span>            :                                 break;
<span class="lineNum">     504 </span>            :                         }
<span class="lineNum">     505 </span>            :                 }
<span class="lineNum">     506 </span>            :         }
<span class="lineNum">     507 </span>            : #endif
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span><span class="lineCov">       4079 :         def_duration = (traf-&gt;tfhd-&gt;flags &amp; GF_ISOM_TRAF_SAMPLE_DUR) ? traf-&gt;tfhd-&gt;def_sample_duration : traf-&gt;trex-&gt;def_sample_duration;</span>
<span class="lineNum">     510 </span><span class="lineCov">       4079 :         def_size = (traf-&gt;tfhd-&gt;flags &amp; GF_ISOM_TRAF_SAMPLE_SIZE) ? traf-&gt;tfhd-&gt;def_sample_size : traf-&gt;trex-&gt;def_sample_size;</span>
<span class="lineNum">     511 </span><span class="lineCov">       4079 :         def_flags = (traf-&gt;tfhd-&gt;flags &amp; GF_ISOM_TRAF_SAMPLE_FLAGS) ? traf-&gt;tfhd-&gt;def_sample_flags : traf-&gt;trex-&gt;def_sample_flags;</span>
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span>            :         //locate base offset, by default use moof (dash-like)
<span class="lineNum">     514 </span>            :         base_offset = moof_offset;
<span class="lineNum">     515 </span>            :         //explicit base offset, use it
<span class="lineNum">     516 </span><span class="lineCov">       4079 :         if (traf-&gt;tfhd-&gt;flags &amp; GF_ISOM_TRAF_BASE_OFFSET)</span>
<span class="lineNum">     517 </span><span class="lineCov">         51 :                 base_offset = traf-&gt;tfhd-&gt;base_data_offset;</span>
<span class="lineNum">     518 </span>            :         //no moof offset and no explicit offset, the offset is the end of the last written chunk of
<span class="lineNum">     519 </span>            :         //the previous traf. For the first traf, *cumulated_offset is actually moof offset
<span class="lineNum">     520 </span><span class="lineCov">       4028 :         else if (!(traf-&gt;tfhd-&gt;flags &amp; GF_ISOM_MOOF_BASE_OFFSET))</span>
<span class="lineNum">     521 </span><span class="lineCov">         32 :                 base_offset = *cumulated_offset;</span>
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span>            :         chunk_size = 0;
<span class="lineNum">     524 </span>            :         prev_trun_data_offset = 0;
<span class="lineNum">     525 </span>            :         data_offset = 0;
<span class="lineNum">     526 </span>            :         traf_duration = 0;
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span>            :         /*in playback mode*/
<span class="lineNum">     529 </span><span class="lineCov">       4079 :         if (traf-&gt;tfdt &amp;&amp; is_first_merge) {</span>
<span class="lineNum">     530 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">     531 </span><span class="lineCov">       3071 :                 if (trak-&gt;moov-&gt;mov-&gt;NextMoofNumber &amp;&amp; trak-&gt;present_in_scalable_segment &amp;&amp; trak-&gt;sample_count_at_seg_start &amp;&amp; (trak-&gt;dts_at_seg_start != traf-&gt;tfdt-&gt;baseMediaDecodeTime)) {</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :                         s32 drift = (s32) ((s64) traf-&gt;tfdt-&gt;baseMediaDecodeTime - (s64)trak-&gt;dts_at_seg_start);</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :                         if (drift&lt;0)  {</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[iso file] Warning: TFDT timing &quot;LLD&quot; less than cumulated timing &quot;LLD&quot; - using tfdt\n&quot;, traf-&gt;tfdt-&gt;baseMediaDecodeTime, trak-&gt;dts_at_seg_start ));</span>
<span class="lineNum">     535 </span>            :                         } else {
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[iso file] TFDT timing &quot;LLD&quot; higher than cumulated timing &quot;LLD&quot; (last sample got extended in duration)\n&quot;, traf-&gt;tfdt-&gt;baseMediaDecodeTime, trak-&gt;dts_at_seg_start ));</span>
<span class="lineNum">     537 </span>            :                         }
<span class="lineNum">     538 </span>            :                 }
<span class="lineNum">     539 </span>            : #endif
<span class="lineNum">     540 </span><span class="lineCov">       3071 :                 trak-&gt;dts_at_seg_start = traf-&gt;tfdt-&gt;baseMediaDecodeTime;</span>
<span class="lineNum">     541 </span>            :         }
<span class="lineNum">     542 </span><span class="lineCov">       1008 :         else if (traf-&gt;tfxd) {</span>
<span class="lineNum">     543 </span><span class="lineCov">          3 :                 trak-&gt;dts_at_seg_start = traf-&gt;tfxd-&gt;absolute_time_in_track_timescale;</span>
<span class="lineNum">     544 </span>            :         }
<span class="lineNum">     545 </span>            : 
<span class="lineNum">     546 </span><span class="lineCov">       4079 :         if (traf-&gt;tfxd) {</span>
<span class="lineNum">     547 </span><span class="lineCov">          3 :                 trak-&gt;last_tfxd_value = traf-&gt;tfxd-&gt;absolute_time_in_track_timescale;</span>
<span class="lineNum">     548 </span><span class="lineCov">          3 :                 trak-&gt;last_tfxd_value += traf-&gt;tfxd-&gt;fragment_duration_in_track_timescale;</span>
<span class="lineNum">     549 </span>            :         }
<span class="lineNum">     550 </span><span class="lineCov">       4079 :         if (traf-&gt;tfrf) {</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :                 if (trak-&gt;tfrf) gf_isom_box_del_parent(&amp;trak-&gt;child_boxes, (GF_Box *)trak-&gt;tfrf);</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :                 trak-&gt;tfrf = traf-&gt;tfrf;</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :                 gf_list_del_item(traf-&gt;child_boxes, traf-&gt;tfrf);</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :                 gf_list_add(trak-&gt;child_boxes, trak-&gt;tfrf);</span>
<span class="lineNum">     555 </span>            :         }
<span class="lineNum">     556 </span>            : 
<span class="lineNum">     557 </span><span class="lineCov">       4079 :         if (trak-&gt;moov-&gt;mov-&gt;signal_frag_bounds) {</span>
<span class="lineNum">     558 </span>            :                 store_traf_map = GF_TRUE;
<span class="lineNum">     559 </span><span class="lineCov">        195 :                 if (is_first_merge) {</span>
<span class="lineNum">     560 </span><span class="lineCov">         87 :                         GF_MovieFragmentBox *moof_clone = NULL;</span>
<span class="lineNum">     561 </span><span class="lineCov">         87 :                         gf_isom_box_freeze_order((GF_Box *)moof_box);</span>
<span class="lineNum">     562 </span><span class="lineCov">         87 :                         gf_isom_clone_box((GF_Box *)moof_box, (GF_Box **)&amp;moof_clone);</span>
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span><span class="lineCov">         87 :                         if (moof_clone) {</span>
<span class="lineNum">     565 </span>            :                                 GF_BitStream *bs;
<span class="lineNum">     566 </span><span class="lineCov">        174 :                                 for (i=0; i&lt;gf_list_count(moof_clone-&gt;TrackList); i++) {</span>
<span class="lineNum">     567 </span><span class="lineCov">         87 :                                         GF_TrackFragmentBox *traf_clone = gf_list_get(moof_clone-&gt;TrackList, i);</span>
<span class="lineNum">     568 </span><span class="lineCov">         87 :                                         gf_isom_box_array_reset_parent(&amp;traf_clone-&gt;child_boxes, traf_clone-&gt;TrackRuns);</span>
<span class="lineNum">     569 </span><span class="lineCov">         87 :                                         gf_isom_box_array_reset_parent(&amp;traf_clone-&gt;child_boxes, traf_clone-&gt;sampleGroups);</span>
<span class="lineNum">     570 </span><span class="lineCov">         87 :                                         gf_isom_box_array_reset_parent(&amp;traf_clone-&gt;child_boxes, traf_clone-&gt;sampleGroupsDescription);</span>
<span class="lineNum">     571 </span><span class="lineCov">         87 :                                         gf_isom_box_array_reset_parent(&amp;traf_clone-&gt;child_boxes, traf_clone-&gt;sub_samples);</span>
<span class="lineNum">     572 </span><span class="lineCov">         87 :                                         gf_isom_box_array_reset_parent(&amp;traf_clone-&gt;child_boxes, traf_clone-&gt;sai_offsets);</span>
<span class="lineNum">     573 </span><span class="lineCov">         87 :                                         gf_isom_box_array_reset_parent(&amp;traf_clone-&gt;child_boxes, traf_clone-&gt;sai_sizes);</span>
<span class="lineNum">     574 </span><span class="lineCov">         87 :                                         if (traf_clone-&gt;sample_encryption) {</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :                                                 gf_isom_box_del_parent(&amp;traf_clone-&gt;child_boxes, (GF_Box *) traf_clone-&gt;sample_encryption);</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :                                                 traf_clone-&gt;sample_encryption = NULL;</span>
<span class="lineNum">     577 </span>            :                                         }
<span class="lineNum">     578 </span><span class="lineCov">         87 :                                         if (traf_clone-&gt;sdtp) {</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :                                                 gf_isom_box_del_parent(&amp;traf_clone-&gt;child_boxes, (GF_Box *) traf_clone-&gt;sdtp);</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :                                                 traf_clone-&gt;sdtp = NULL;</span>
<span class="lineNum">     581 </span>            :                                         }
<span class="lineNum">     582 </span>            :                                 }
<span class="lineNum">     583 </span><span class="lineCov">         87 :                                 gf_isom_box_size((GF_Box *)moof_clone);</span>
<span class="lineNum">     584 </span><span class="lineCov">         87 :                                 bs = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);</span>
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span><span class="lineCov">         87 :                                 if (trak-&gt;moov-&gt;mov-&gt;seg_styp) {</span>
<span class="lineNum">     587 </span><span class="lineCov">         84 :                                         gf_isom_box_size(trak-&gt;moov-&gt;mov-&gt;seg_styp);</span>
<span class="lineNum">     588 </span><span class="lineCov">         84 :                                         gf_isom_box_write(trak-&gt;moov-&gt;mov-&gt;seg_styp, bs);</span>
<span class="lineNum">     589 </span>            :                                 }
<span class="lineNum">     590 </span><span class="lineCov">         87 :                                 if (trak-&gt;moov-&gt;mov-&gt;root_sidx) {</span>
<span class="lineNum">     591 </span><span class="lineCov">         87 :                                         gf_isom_box_size((GF_Box *)trak-&gt;moov-&gt;mov-&gt;root_sidx);</span>
<span class="lineNum">     592 </span><span class="lineCov">         87 :                                         gf_isom_box_write((GF_Box *)trak-&gt;moov-&gt;mov-&gt;root_sidx, bs);</span>
<span class="lineNum">     593 </span>            :                                 }
<span class="lineNum">     594 </span><span class="lineCov">         87 :                                 if (trak-&gt;moov-&gt;mov-&gt;seg_ssix) {</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :                                         gf_isom_box_size(trak-&gt;moov-&gt;mov-&gt;seg_ssix);</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :                                         gf_isom_box_write(trak-&gt;moov-&gt;mov-&gt;seg_ssix, bs);</span>
<span class="lineNum">     597 </span>            :                                 }
<span class="lineNum">     598 </span><span class="lineCov">         87 :                                 gf_isom_box_write((GF_Box *)moof_clone, bs);</span>
<span class="lineNum">     599 </span><span class="lineCov">         87 :                                 gf_isom_box_del((GF_Box*)moof_clone);</span>
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span><span class="lineCov">         87 :                                 gf_bs_get_content(bs, &amp;moof_template, &amp;moof_template_size);</span>
<span class="lineNum">     602 </span><span class="lineCov">         87 :                                 gf_bs_del(bs);</span>
<span class="lineNum">     603 </span>            :                         }
<span class="lineNum">     604 </span>            :                 }
<span class="lineNum">     605 </span><span class="lineCov">        195 :                 if (trak-&gt;moov-&gt;mov-&gt;seg_styp) {</span>
<span class="lineNum">     606 </span>            :                         is_seg_start = GF_TRUE;
<span class="lineNum">     607 </span><span class="lineCov">         84 :                         seg_start = trak-&gt;moov-&gt;mov-&gt;styp_start_offset;</span>
<span class="lineNum">     608 </span>            :                 }
<span class="lineNum">     609 </span><span class="lineCov">        195 :                 if (trak-&gt;moov-&gt;mov-&gt;root_sidx) {</span>
<span class="lineNum">     610 </span>            :                         is_seg_start = GF_TRUE;
<span class="lineNum">     611 </span><span class="lineCov">         87 :                         sidx_start = trak-&gt;moov-&gt;mov-&gt;sidx_start_offset;</span>
<span class="lineNum">     612 </span><span class="lineCov">         87 :                         sidx_end = trak-&gt;moov-&gt;mov-&gt;sidx_end_offset;</span>
<span class="lineNum">     613 </span><span class="lineCov">         87 :                         if (! seg_start || (sidx_start&lt;seg_start))</span>
<span class="lineNum">     614 </span>            :                                 seg_start = sidx_start;
<span class="lineNum">     615 </span>            :                 }
<span class="lineNum">     616 </span><span class="lineCov">        195 :                 frag_start = trak-&gt;moov-&gt;mov-&gt;current_top_box_start;</span>
<span class="lineNum">     617 </span>            :         }
<span class="lineNum">     618 </span><span class="lineCov">       3884 :         else if (trak-&gt;moov-&gt;mov-&gt;store_traf_map) {</span>
<span class="lineNum">     619 </span>            :                 store_traf_map = GF_TRUE;
<span class="lineNum">     620 </span>            :         }
<span class="lineNum">     621 </span>            : 
<span class="lineNum">     622 </span>            : 
<span class="lineNum">     623 </span>            :         sample_index = 0;
<span class="lineNum">     624 </span><span class="lineCov">       4079 :         i=0;</span>
<span class="lineNum">     625 </span><span class="lineCov">      12282 :         while ((trun = (GF_TrackFragmentRunBox *)gf_list_enum(traf-&gt;TrackRuns, &amp;i))) {</span>
<span class="lineNum">     626 </span>            :                 //merge the run
<span class="lineNum">     627 </span><span class="lineCov">     109375 :                 for (j=0; j&lt;trun-&gt;sample_count; j++) {</span>
<span class="lineNum">     628 </span>            :                         GF_Err e;
<span class="lineNum">     629 </span>            :                         s32 cts_offset=0;
<span class="lineNum">     630 </span><span class="lineCov">     109375 :                         if (j&lt;trun-&gt;nb_samples) {</span>
<span class="lineNum">     631 </span><span class="lineCov">     109375 :                                 ent = &amp;trun-&gt;samples[j];</span>
<span class="lineNum">     632 </span>            :                         } else {
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[iso file] Track %d doesn't have enough trun entries (%d) compared to sample count (%d) in run\n&quot;, traf-&gt;trex-&gt;trackID, trun-&gt;nb_samples, trun-&gt;sample_count ));</span>
<span class="lineNum">     634 </span>            :                                 break;
<span class="lineNum">     635 </span>            :                         }
<span class="lineNum">     636 </span>            :                         size = def_size;
<span class="lineNum">     637 </span>            :                         duration = def_duration;
<span class="lineNum">     638 </span>            :                         flags = def_flags;
<span class="lineNum">     639 </span>            : 
<span class="lineNum">     640 </span>            :                         //CTS - if flag not set (trun or ctrn) defaults to 0 which is the base value after alloc
<span class="lineNum">     641 </span>            :                         //we just need to overrite its value if inherited
<span class="lineNum">     642 </span><span class="lineCov">     109375 :                         cts_offset = ent-&gt;CTS_Offset;</span>
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">     645 </span>            :                         if (trun-&gt;use_ctrn) {
<span class="lineNum">     646 </span>            :                                 if (!j &amp;&amp; (trun-&gt;ctrn_flags &amp; GF_ISOM_CTRN_FIRST_SAMPLE) ) {
<span class="lineNum">     647 </span>            :                                         if (trun-&gt;ctrn_first_dur) duration = ent-&gt;Duration;
<span class="lineNum">     648 </span>            :                                         if (trun-&gt;ctrn_first_size) size = ent-&gt;size;
<span class="lineNum">     649 </span>            :                                         if (trun-&gt;ctrn_first_ctts) flags = ent-&gt;flags;
<span class="lineNum">     650 </span>            :                                 } else {
<span class="lineNum">     651 </span>            :                                         if (trun-&gt;ctrn_dur) duration = ent-&gt;Duration;
<span class="lineNum">     652 </span>            :                                         if (trun-&gt;ctrn_size) size = ent-&gt;size;
<span class="lineNum">     653 </span>            :                                         if (trun-&gt;ctrn_sample_flags) flags = ent-&gt;flags;
<span class="lineNum">     654 </span>            :                                 }
<span class="lineNum">     655 </span>            :                                 /*re-override*/
<span class="lineNum">     656 </span>            :                                 if (trun-&gt;ctrn_flags &amp; 0xF0) {
<span class="lineNum">     657 </span>            :                                         GF_TrunEntry *ref_entry;
<span class="lineNum">     658 </span>            :                                         if (!traf_ref) {
<span class="lineNum">     659 </span>            :                                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[iso file] Track %d use traf inheritance to track ID %d but reference traf not found\n&quot;, traf-&gt;trex-&gt;trackID, traf-&gt;trex-&gt;inherit_from_traf_id ));
<span class="lineNum">     660 </span>            :                                                 break;
<span class="lineNum">     661 </span>            :                                         }
<span class="lineNum">     662 </span>            :                                         ref_entry = traf_get_sample_entry(traf_ref, sample_index);
<span class="lineNum">     663 </span>            :                                         if (!ref_entry) {
<span class="lineNum">     664 </span>            :                                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[iso file] Track %d use traf inheritance but sample %d not found in reference traf\n&quot;, traf-&gt;trex-&gt;trackID, sample_index+1 ));
<span class="lineNum">     665 </span>            :                                                 break;
<span class="lineNum">     666 </span>            :                                         }
<span class="lineNum">     667 </span>            :                                         if (trun-&gt;ctrn_flags &amp; GF_ISOM_CTRN_INHERIT_DUR)
<span class="lineNum">     668 </span>            :                                                 duration = ref_entry-&gt;Duration;
<span class="lineNum">     669 </span>            :                                         if (trun-&gt;ctrn_flags &amp; GF_ISOM_CTRN_INHERIT_SIZE)
<span class="lineNum">     670 </span>            :                                                 size = ref_entry-&gt;size;
<span class="lineNum">     671 </span>            :                                         if (trun-&gt;ctrn_flags &amp; GF_ISOM_CTRN_INHERIT_FLAGS)
<span class="lineNum">     672 </span>            :                                                 flags = ref_entry-&gt;flags;
<span class="lineNum">     673 </span>            :                                         if (trun-&gt;ctrn_flags &amp; GF_ISOM_CTRN_INHERIT_CTSO)
<span class="lineNum">     674 </span>            :                                                 cts_offset = ref_entry-&gt;CTS_Offset;
<span class="lineNum">     675 </span>            :                                 }
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span>            :                         } else
<span class="lineNum">     678 </span>            : #endif
<span class="lineNum">     679 </span>            :                         {
<span class="lineNum">     680 </span><span class="lineCov">     114634 :                                 if (trun-&gt;flags &amp; GF_ISOM_TRUN_DURATION) duration = ent-&gt;Duration;</span>
<span class="lineNum">     681 </span><span class="lineCov">     109375 :                                 if (trun-&gt;flags &amp; GF_ISOM_TRUN_SIZE) size = ent-&gt;size;</span>
<span class="lineNum">     682 </span><span class="lineCov">     109375 :                                 if (trun-&gt;flags &amp; GF_ISOM_TRUN_FLAGS) {</span>
<span class="lineNum">     683 </span><span class="lineCov">       6868 :                                         flags = ent-&gt;flags;</span>
<span class="lineNum">     684 </span><span class="lineCov">     102507 :                                 } else if (!j &amp;&amp; (trun-&gt;flags &amp; GF_ISOM_TRUN_FIRST_FLAG)) {</span>
<span class="lineNum">     685 </span><span class="lineCov">       3147 :                                         flags = trun-&gt;first_sample_flags;</span>
<span class="lineNum">     686 </span>            :                                 }
<span class="lineNum">     687 </span>            :                         }
<span class="lineNum">     688 </span>            :                         sample_index++;
<span class="lineNum">     689 </span>            :                         /*store the resolved value in case we have inheritance*/
<span class="lineNum">     690 </span><span class="lineCov">     109375 :                         ent-&gt;size = size;</span>
<span class="lineNum">     691 </span><span class="lineCov">     109375 :                         ent-&gt;Duration = duration;</span>
<span class="lineNum">     692 </span><span class="lineCov">     109375 :                         ent-&gt;flags = flags;</span>
<span class="lineNum">     693 </span>            :                         ent-&gt;CTS_Offset = cts_offset;
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span><span class="lineCov">     109375 :                         last_dts += duration;</span>
<span class="lineNum">     696 </span>            : 
<span class="lineNum">     697 </span>            :                         //add size first
<span class="lineNum">     698 </span><span class="lineCov">     109375 :                         if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleSize) {</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :                                 trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleSize = (GF_SampleSizeBox *) gf_isom_box_new_parent(&amp;trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;child_boxes, GF_ISOM_BOX_TYPE_STSZ);</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :                                 if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleSize)</span>
<span class="lineNum">     701 </span>            :                                         return GF_OUT_OF_MEM;
<span class="lineNum">     702 </span>            :                         }
<span class="lineNum">     703 </span><span class="lineCov">     109375 :                         e = stbl_AppendSize(trak-&gt;Media-&gt;information-&gt;sampleTable, size, ent-&gt;nb_pack);</span>
<span class="lineNum">     704 </span><span class="lineCov">     109375 :                         if (e) return e;</span>
<span class="lineNum">     705 </span>            : 
<span class="lineNum">     706 </span>            :                         //then TS
<span class="lineNum">     707 </span><span class="lineCov">     109375 :                         if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;TimeToSample) {</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :                                 trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;TimeToSample = (GF_TimeToSampleBox *) gf_isom_box_new_parent(&amp;trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;child_boxes, GF_ISOM_BOX_TYPE_STTS);</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :                                 if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;TimeToSample)</span>
<span class="lineNum">     710 </span>            :                                         return GF_OUT_OF_MEM;
<span class="lineNum">     711 </span>            :                         }
<span class="lineNum">     712 </span><span class="lineCov">     109375 :                         e = stbl_AppendTime(trak-&gt;Media-&gt;information-&gt;sampleTable, duration, ent-&gt;nb_pack);</span>
<span class="lineNum">     713 </span><span class="lineCov">     109375 :                         if (e) return e;</span>
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span>            :                         //add chunk on first sample
<span class="lineNum">     716 </span><span class="lineCov">     109375 :                         if (!j) {</span>
<span class="lineNum">     717 </span>            :                                 u64 final_offset;
<span class="lineNum">     718 </span>            :                                 data_offset = base_offset;
<span class="lineNum">     719 </span>            :                                 //we have an explicit data offset for this trun
<span class="lineNum">     720 </span><span class="lineCov">       4124 :                                 if (trun-&gt;flags &amp; GF_ISOM_TRUN_DATA_OFFSET) {</span>
<span class="lineNum">     721 </span><span class="lineCov">       4083 :                                         data_offset += trun-&gt;data_offset;</span>
<span class="lineNum">     722 </span>            :                                         /*reset chunk size since data is now relative to this trun*/
<span class="lineNum">     723 </span>            :                                         chunk_size = 0;
<span class="lineNum">     724 </span>            :                                         /*remember this data offset for following trun*/
<span class="lineNum">     725 </span><span class="lineCov">       4083 :                                         prev_trun_data_offset = trun-&gt;data_offset;</span>
<span class="lineNum">     726 </span>            :                                         /*if mdat is located after the moof, and the moof was compressed, adjust offset
<span class="lineNum">     727 </span>            :                                         otherwise the offset does not need adjustment*/
<span class="lineNum">     728 </span><span class="lineCov">       4083 :                                         if (trun-&gt;data_offset&gt;=0) {</span>
<span class="lineNum">     729 </span><span class="lineCov">       4083 :                                                 data_offset -= compressed_diff;</span>
<span class="lineNum">     730 </span><span class="lineCov">       4083 :                                                 prev_trun_data_offset -= compressed_diff;</span>
<span class="lineNum">     731 </span>            :                                         }
<span class="lineNum">     732 </span>            :                                 }
<span class="lineNum">     733 </span>            :                                 //we had an explicit data offset for the previous trun, use it + chunk size
<span class="lineNum">     734 </span><span class="lineCov">         41 :                                 else if (prev_trun_data_offset) {</span>
<span class="lineNum">     735 </span>            :                                         /*data offset is previous chunk size plus previous offset of the trun*/
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :                                         data_offset += prev_trun_data_offset + chunk_size;</span>
<span class="lineNum">     737 </span>            :                                 }
<span class="lineNum">     738 </span>            :                                 //no explicit data offset, continuous data after last data in previous chunk
<span class="lineNum">     739 </span>            :                                 else {
<span class="lineNum">     740 </span><span class="lineCov">         41 :                                         data_offset += chunk_size;</span>
<span class="lineNum">     741 </span>            :                                         //data offset of first trun in first traf, adjust if compressed moof
<span class="lineNum">     742 </span><span class="lineCov">         41 :                                         if ((i==1) &amp;&amp; (trun-&gt;data_offset&gt;=0)) {</span>
<span class="lineNum">     743 </span><span class="lineCov">         41 :                                                 data_offset -= compressed_diff;</span>
<span class="lineNum">     744 </span>            :                                         }
<span class="lineNum">     745 </span>            :                                 }
<span class="lineNum">     746 </span>            : 
<span class="lineNum">     747 </span>            :                                 final_offset = data_offset;
<span class="lineNum">     748 </span>            :                                 //adjust offset if moov was also compressed and we are still in the same file
<span class="lineNum">     749 </span>            :                                 //so that later call to gf_isom_get_sample properly adjust back the offset
<span class="lineNum">     750 </span><span class="lineCov">       4124 :                                 if (trak-&gt;moov-&gt;compressed_diff) {</span>
<span class="lineNum">     751 </span><span class="lineCov">         10 :                                         final_offset += trak-&gt;moov-&gt;compressed_diff;</span>
<span class="lineNum">     752 </span>            :                                 }
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span><span class="lineCov">       4124 :                                 if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;ChunkOffset) {</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :                                         trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;ChunkOffset = gf_isom_box_new_parent(&amp;trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;child_boxes, GF_ISOM_BOX_TYPE_STCO);</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :                                         if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;ChunkOffset)</span>
<span class="lineNum">     757 </span>            :                                                 return GF_OUT_OF_MEM;
<span class="lineNum">     758 </span>            :                                 }
<span class="lineNum">     759 </span><span class="lineCov">       4124 :                                 e = stbl_AppendChunk(trak-&gt;Media-&gt;information-&gt;sampleTable, final_offset);</span>
<span class="lineNum">     760 </span><span class="lineCov">       4124 :                                 if (e) return e;</span>
<span class="lineNum">     761 </span>            :                                 //then sampleToChunk
<span class="lineNum">     762 </span><span class="lineCov">       4124 :                                 if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleToChunk) {</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :                                         trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleToChunk = (GF_SampleToChunkBox *) gf_isom_box_new_parent(&amp;trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;child_boxes, GF_ISOM_BOX_TYPE_STSC);</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :                                         if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleToChunk)</span>
<span class="lineNum">     765 </span>            :                                                 return GF_OUT_OF_MEM;
<span class="lineNum">     766 </span>            :                                 }
<span class="lineNum">     767 </span><span class="lineCov">       4124 :                                 e = stbl_AppendSampleToChunk(trak-&gt;Media-&gt;information-&gt;sampleTable,</span>
<span class="lineNum">     768 </span>            :                                                          DescIndex, trun-&gt;sample_count);
<span class="lineNum">     769 </span><span class="lineCov">       4124 :                                 if (e) return e;</span>
<span class="lineNum">     770 </span>            :                         }
<span class="lineNum">     771 </span><span class="lineCov">     109375 :                         chunk_size += size;</span>
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span><span class="lineCov">     109375 :                         if (store_traf_map &amp;&amp; first_samp_in_traf) {</span>
<span class="lineNum">     774 </span>            :                                 first_samp_in_traf = GF_FALSE;
<span class="lineNum">     775 </span><span class="lineCov">        195 :                                 e = stbl_AppendTrafMap(trak-&gt;Media-&gt;information-&gt;sampleTable, is_seg_start, seg_start, frag_start, moof_template, moof_template_size, sidx_start, sidx_end);</span>
<span class="lineNum">     776 </span><span class="lineCov">        195 :                                 if (e) return e;</span>
<span class="lineNum">     777 </span>            :                                 //do not deallocate, the memory is now owned by traf map
<span class="lineNum">     778 </span><span class="lineCov">        195 :                                 moof_template = NULL;</span>
<span class="lineNum">     779 </span><span class="lineCov">        195 :                                 moof_template_size = 0;</span>
<span class="lineNum">     780 </span>            :                         }
<span class="lineNum">     781 </span><span class="lineCov">     109375 :                         if (ent-&gt;nb_pack&gt;1) {</span>
<span class="lineNum">     782 </span><span class="lineCov">        185 :                                 j+= ent-&gt;nb_pack-1;</span>
<span class="lineNum">     783 </span><span class="lineCov">        185 :                                 traf_duration += ent-&gt;nb_pack*duration;</span>
<span class="lineNum">     784 </span><span class="lineCov">        185 :                                 continue;</span>
<span class="lineNum">     785 </span>            :                         }
<span class="lineNum">     786 </span>            : 
<span class="lineNum">     787 </span><span class="lineCov">     109190 :                         traf_duration += duration;</span>
<span class="lineNum">     788 </span>            : 
<span class="lineNum">     789 </span><span class="lineCov">     109190 :                         e = stbl_AppendCTSOffset(trak-&gt;Media-&gt;information-&gt;sampleTable, cts_offset);</span>
<span class="lineNum">     790 </span><span class="lineCov">     109190 :                         if (e) return e;</span>
<span class="lineNum">     791 </span>            :                         //flags
<span class="lineNum">     792 </span><span class="lineCov">     109190 :                         sync = GF_ISOM_GET_FRAG_SYNC(flags);</span>
<span class="lineNum">     793 </span><span class="lineCov">     109190 :                         if (trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;no_sync_found &amp;&amp; sync) {</span>
<span class="lineNum">     794 </span><span class="lineCov">        291 :                                 trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;no_sync_found = 0;</span>
<span class="lineNum">     795 </span>            :                         }
<span class="lineNum">     796 </span><span class="lineCov">     109190 :                         e = stbl_AppendRAP(trak-&gt;Media-&gt;information-&gt;sampleTable, sync);</span>
<span class="lineNum">     797 </span><span class="lineCov">     109190 :                         if (e) return e;</span>
<span class="lineNum">     798 </span><span class="lineCov">     109190 :                         pad = GF_ISOM_GET_FRAG_PAD(flags);</span>
<span class="lineNum">     799 </span><span class="lineCov">     109190 :                         if (pad) {</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :                                 e = stbl_AppendPadding(trak-&gt;Media-&gt;information-&gt;sampleTable, pad);</span>
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :                                 if (e) return e;</span>
<span class="lineNum">     802 </span>            :                         }
<span class="lineNum">     803 </span><span class="lineCov">     109190 :                         degr = GF_ISOM_GET_FRAG_DEG(flags);</span>
<span class="lineNum">     804 </span><span class="lineCov">     109190 :                         if (degr) {</span>
<span class="lineNum">     805 </span><span class="lineCov">          3 :                                 e = stbl_AppendDegradation(trak-&gt;Media-&gt;information-&gt;sampleTable, degr);</span>
<span class="lineNum">     806 </span><span class="lineCov">          3 :                                 if (e) return e;</span>
<span class="lineNum">     807 </span>            :                         }
<span class="lineNum">     808 </span><span class="lineCov">     109190 :                         e = stbl_AppendDependencyType(trak-&gt;Media-&gt;information-&gt;sampleTable, GF_ISOM_GET_FRAG_LEAD(flags), GF_ISOM_GET_FRAG_DEPENDS(flags), GF_ISOM_GET_FRAG_DEPENDED(flags), GF_ISOM_GET_FRAG_REDUNDANT(flags));</span>
<span class="lineNum">     809 </span><span class="lineCov">     109190 :                         if (e) return e;</span>
<span class="lineNum">     810 </span>            :                 }
<span class="lineNum">     811 </span>            :         }
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span><span class="lineCov">       4079 :         if (trak-&gt;moov-&gt;mov-&gt;is_smooth &amp;&amp; !traf-&gt;tfdt &amp;&amp; !traf-&gt;tfxd) {</span>
<span class="lineNum">     814 </span><span class="lineCov">         25 :                 if (is_first_merge)</span>
<span class="lineNum">     815 </span><span class="lineCov">         25 :                         trak-&gt;dts_at_seg_start = trak-&gt;dts_at_next_seg_start;</span>
<span class="lineNum">     816 </span><span class="lineCov">         25 :                 trak-&gt;dts_at_next_seg_start += last_dts;</span>
<span class="lineNum">     817 </span>            :         }
<span class="lineNum">     818 </span><span class="lineCov">       4079 :         if (traf_duration &amp;&amp; trak-&gt;editBox &amp;&amp; trak-&gt;editBox-&gt;editList) {</span>
<span class="lineNum">     819 </span><span class="lineCov">        264 :                 for (i=0; i&lt;gf_list_count(trak-&gt;editBox-&gt;editList-&gt;entryList); i++) {</span>
<span class="lineNum">     820 </span><span class="lineCov">        132 :                         GF_EdtsEntry *edts_e = gf_list_get(trak-&gt;editBox-&gt;editList-&gt;entryList, i);</span>
<span class="lineNum">     821 </span><span class="lineCov">        132 :                         if (edts_e-&gt;was_empty_dur) {</span>
<span class="lineNum">     822 </span>            :                                 u64 extend_dur = traf_duration;
<span class="lineNum">     823 </span><span class="lineCov">        105 :                                 extend_dur *= trak-&gt;moov-&gt;mvhd-&gt;timeScale;</span>
<span class="lineNum">     824 </span><span class="lineCov">        105 :                                 extend_dur /= trak-&gt;Media-&gt;mediaHeader-&gt;timeScale;</span>
<span class="lineNum">     825 </span><span class="lineCov">        105 :                                 edts_e-&gt;segmentDuration += extend_dur;</span>
<span class="lineNum">     826 </span>            :                         }
<span class="lineNum">     827 </span><span class="lineCov">         27 :                         else if (!edts_e-&gt;segmentDuration) {</span>
<span class="lineNum">     828 </span><span class="lineCov">         27 :                                 edts_e-&gt;was_empty_dur = GF_TRUE;</span>
<span class="lineNum">     829 </span><span class="lineCov">         27 :                                 if ((s64) traf_duration &gt; edts_e-&gt;mediaTime)</span>
<span class="lineNum">     830 </span><span class="lineCov">         27 :                                         traf_duration -= edts_e-&gt;mediaTime;</span>
<span class="lineNum">     831 </span>            :                                 else
<span class="lineNum">     832 </span>            :                                         traf_duration = 0;
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span><span class="lineCov">         27 :                                 edts_e-&gt;segmentDuration = traf_duration;</span>
<span class="lineNum">     835 </span><span class="lineCov">         27 :                                 edts_e-&gt;segmentDuration *= trak-&gt;moov-&gt;mvhd-&gt;timeScale;</span>
<span class="lineNum">     836 </span><span class="lineCov">         27 :                                 edts_e-&gt;segmentDuration /= trak-&gt;Media-&gt;mediaHeader-&gt;timeScale;</span>
<span class="lineNum">     837 </span>            :                         }
<span class="lineNum">     838 </span>            : 
<span class="lineNum">     839 </span>            :                 }
<span class="lineNum">     840 </span>            :         }
<span class="lineNum">     841 </span>            : 
<span class="lineNum">     842 </span>            :         //in any case, update the cumulated offset
<span class="lineNum">     843 </span>            :         //this will handle hypothetical files mixing MOOF offset and implicit non-moof offset
<span class="lineNum">     844 </span><span class="lineCov">       4079 :         *cumulated_offset = data_offset + chunk_size;</span>
<span class="lineNum">     845 </span>            : 
<span class="lineNum">     846 </span>            :         /*merge sample groups*/
<span class="lineNum">     847 </span><span class="lineCov">       4079 :         if (traf-&gt;sampleGroups) {</span>
<span class="lineNum">     848 </span>            :                 GF_List *groups;
<span class="lineNum">     849 </span>            :                 GF_List *groupDescs;
<span class="lineNum">     850 </span>            :                 Bool is_identical_sgpd = GF_TRUE;
<span class="lineNum">     851 </span>            :                 u32 *new_idx = NULL, new_idx_count=0;
<span class="lineNum">     852 </span>            : 
<span class="lineNum">     853 </span><span class="lineCov">         98 :                 if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;sampleGroups)</span>
<span class="lineNum">     854 </span><span class="lineCov">         98 :                         trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;sampleGroups = gf_list_new();</span>
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span><span class="lineCov">         98 :                 if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;sampleGroupsDescription)</span>
<span class="lineNum">     857 </span><span class="lineCov">         10 :                         trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;sampleGroupsDescription = gf_list_new();</span>
<span class="lineNum">     858 </span>            : 
<span class="lineNum">     859 </span><span class="lineCov">         98 :                 groupDescs = trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;sampleGroupsDescription;</span>
<span class="lineNum">     860 </span><span class="lineCov">        126 :                 for (i=0; i&lt;gf_list_count(traf-&gt;sampleGroupsDescription); i++) {</span>
<span class="lineNum">     861 </span>            :                         GF_SampleGroupDescriptionBox *new_sgdesc = NULL;
<span class="lineNum">     862 </span><span class="lineCov">         28 :                         GF_SampleGroupDescriptionBox *sgdesc = gf_list_get(traf-&gt;sampleGroupsDescription, i);</span>
<span class="lineNum">     863 </span><span class="lineCov">         28 :                         for (j=0; j&lt;gf_list_count(groupDescs); j++) {</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :                                 new_sgdesc = gf_list_get(groupDescs, j);</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :                                 if (new_sgdesc-&gt;grouping_type==sgdesc-&gt;grouping_type) break;</span>
<span class="lineNum">     866 </span>            :                                 new_sgdesc = NULL;
<span class="lineNum">     867 </span>            :                         }
<span class="lineNum">     868 </span>            :                         /*new description, move it to our sample table*/
<span class="lineNum">     869 </span><span class="lineCov">         28 :                         if (!new_sgdesc) {</span>
<span class="lineNum">     870 </span><span class="lineCov">         28 :                                 gf_list_add(groupDescs, sgdesc);</span>
<span class="lineNum">     871 </span><span class="lineCov">         28 :                                 gf_list_add(trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;child_boxes, sgdesc);</span>
<span class="lineNum">     872 </span><span class="lineCov">         28 :                                 gf_list_rem(traf-&gt;sampleGroupsDescription, i);</span>
<span class="lineNum">     873 </span><span class="lineCov">         28 :                                 gf_list_del_item(traf-&gt;child_boxes, sgdesc);</span>
<span class="lineNum">     874 </span><span class="lineCov">         28 :                                 i--;</span>
<span class="lineNum">     875 </span>            :                         }
<span class="lineNum">     876 </span>            :                         /*merge descriptions*/
<span class="lineNum">     877 </span>            :                         else {
<span class="lineNum">     878 </span>            :                                 u32 count;
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :                                 is_identical_sgpd = gf_isom_is_identical_sgpd(new_sgdesc, sgdesc, 0);</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :                                 if (is_identical_sgpd)</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :                                 new_idx_count = gf_list_count(sgdesc-&gt;group_descriptions);</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :                                 new_idx = (u32 *)gf_malloc(new_idx_count * sizeof(u32));</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :                                 if (!new_idx) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     887 </span>            : 
<span class="lineNum">     888 </span>            :                                 count = 0;
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :                                 while (gf_list_count(sgdesc-&gt;group_descriptions)) {</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :                                         void *sgpd_entry = gf_list_get(sgdesc-&gt;group_descriptions, 0);</span>
<span class="lineNum">     891 </span>            :                                         Bool new_entry = GF_TRUE;
<span class="lineNum">     892 </span>            : 
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :                                         for (j = 0; j &lt; gf_list_count(new_sgdesc-&gt;group_descriptions); j++) {</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :                                                 void *ptr = gf_list_get(new_sgdesc-&gt;group_descriptions, j);</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :                                                 if (gf_isom_is_identical_sgpd(sgpd_entry, ptr, new_sgdesc-&gt;grouping_type)) {</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :                                                         new_idx[count] = j + 1;</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :                                                         count ++;</span>
<span class="lineNum">     898 </span>            :                                                         new_entry = GF_FALSE;
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :                                                         gf_free(sgpd_entry);</span>
<span class="lineNum">     900 </span>            :                                                         break;
<span class="lineNum">     901 </span>            :                                                 }
<span class="lineNum">     902 </span>            :                                         }
<span class="lineNum">     903 </span>            : 
<span class="lineNum">     904 </span>            :                                         if (new_entry) {
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :                                                 gf_list_add(new_sgdesc-&gt;group_descriptions, sgpd_entry);</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :                                                 new_idx[count] = gf_list_count(new_sgdesc-&gt;group_descriptions);</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :                                                 count ++;</span>
<span class="lineNum">     908 </span>            :                                         }
<span class="lineNum">     909 </span>            : 
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :                                         gf_list_rem(sgdesc-&gt;group_descriptions, 0);</span>
<span class="lineNum">     911 </span>            :                                 }
<span class="lineNum">     912 </span>            :                         }
<span class="lineNum">     913 </span>            :                 }
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span><span class="lineCov">         98 :                 groups = trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;sampleGroups;</span>
<span class="lineNum">     916 </span><span class="lineCov">        196 :                 for (i=0; i&lt;gf_list_count(traf-&gt;sampleGroups); i++) {</span>
<span class="lineNum">     917 </span>            :                         GF_SampleGroupBox *stbl_group = NULL;
<span class="lineNum">     918 </span><span class="lineCov">         98 :                         GF_SampleGroupBox *frag_group = gf_list_get(traf-&gt;sampleGroups, i);</span>
<span class="lineNum">     919 </span>            : 
<span class="lineNum">     920 </span>            : 
<span class="lineNum">     921 </span><span class="lineCov">         98 :                         for (j=0; j&lt;gf_list_count(groups); j++) {</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :                                 stbl_group = gf_list_get(groups, j);</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :                                 if ((frag_group-&gt;grouping_type==stbl_group-&gt;grouping_type) &amp;&amp; (frag_group-&gt;grouping_type_parameter==stbl_group-&gt;grouping_type_parameter))</span>
<span class="lineNum">     924 </span>            :                                         break;
<span class="lineNum">     925 </span>            :                                 stbl_group = NULL;
<span class="lineNum">     926 </span>            :                         }
<span class="lineNum">     927 </span><span class="lineCov">         98 :                         if (!stbl_group) {</span>
<span class="lineNum">     928 </span><span class="lineCov">         98 :                                 stbl_group = (GF_SampleGroupBox *) gf_isom_box_new_parent(&amp;trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;child_boxes, GF_ISOM_BOX_TYPE_SBGP);</span>
<span class="lineNum">     929 </span><span class="lineCov">         98 :                                 if (!stbl_group) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     930 </span><span class="lineCov">         98 :                                 stbl_group-&gt;grouping_type = frag_group-&gt;grouping_type;</span>
<span class="lineNum">     931 </span><span class="lineCov">         98 :                                 stbl_group-&gt;grouping_type_parameter = frag_group-&gt;grouping_type_parameter;</span>
<span class="lineNum">     932 </span><span class="lineCov">         98 :                                 stbl_group-&gt;version = frag_group-&gt;version;</span>
<span class="lineNum">     933 </span><span class="lineCov">         98 :                                 gf_list_add(groups, stbl_group);</span>
<span class="lineNum">     934 </span>            :                         }
<span class="lineNum">     935 </span>            : 
<span class="lineNum">     936 </span><span class="lineCov">         98 :                         if (is_identical_sgpd) {</span>
<span class="lineNum">     937 </span>            :                                 //adjust sgpd index: in traf index start at 0x1001
<span class="lineNum">     938 </span><span class="lineCov">        181 :                                 for (j = 0; j &lt; frag_group-&gt;entry_count; j++)</span>
<span class="lineNum">     939 </span><span class="lineCov">        181 :                                         frag_group-&gt;sample_entries[j].group_description_index &amp;= 0x0FFFF;</span>
<span class="lineNum">     940 </span><span class="lineCov">         98 :                                 if (frag_group-&gt;entry_count &amp;&amp; stbl_group-&gt;entry_count &amp;&amp;</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :                                         (frag_group-&gt;sample_entries[0].group_description_index==stbl_group-&gt;sample_entries[stbl_group-&gt;entry_count-1].group_description_index)</span>
<span class="lineNum">     942 </span>            :                                    ) {
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :                                         stbl_group-&gt;sample_entries[stbl_group-&gt;entry_count - 1].sample_count += frag_group-&gt;sample_entries[0].sample_count;</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :                                         if (frag_group-&gt;entry_count&gt;1) {</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :                                                 stbl_group-&gt;sample_entries = gf_realloc(stbl_group-&gt;sample_entries, sizeof(GF_SampleGroupEntry) * (stbl_group-&gt;entry_count + frag_group-&gt;entry_count - 1));</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :                                                 memcpy(&amp;stbl_group-&gt;sample_entries[stbl_group-&gt;entry_count], &amp;frag_group-&gt;sample_entries[1], sizeof(GF_SampleGroupEntry) * (frag_group-&gt;entry_count - 1));</span>
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :                                                 stbl_group-&gt;entry_count += frag_group-&gt;entry_count - 1;</span>
<span class="lineNum">     948 </span>            :                                         }
<span class="lineNum">     949 </span>            :                                 } else {
<span class="lineNum">     950 </span><span class="lineCov">         98 :                                         stbl_group-&gt;sample_entries = gf_realloc(stbl_group-&gt;sample_entries, sizeof(GF_SampleGroupEntry) * (stbl_group-&gt;entry_count + frag_group-&gt;entry_count));</span>
<span class="lineNum">     951 </span><span class="lineCov">         98 :                                         memcpy(&amp;stbl_group-&gt;sample_entries[stbl_group-&gt;entry_count], &amp;frag_group-&gt;sample_entries[0], sizeof(GF_SampleGroupEntry) * frag_group-&gt;entry_count);</span>
<span class="lineNum">     952 </span><span class="lineCov">         98 :                                         stbl_group-&gt;entry_count += frag_group-&gt;entry_count;</span>
<span class="lineNum">     953 </span>            :                                 }
<span class="lineNum">     954 </span>            :                         } else {
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :                                 stbl_group-&gt;sample_entries = gf_realloc(stbl_group-&gt;sample_entries, sizeof(GF_SampleGroupEntry) * (stbl_group-&gt;entry_count + frag_group-&gt;entry_count));</span>
<span class="lineNum">     956 </span>            :                                 //adjust sgpd index
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :                                 for (j = 0; j &lt; frag_group-&gt;entry_count; j++) {</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :                                         u32 sgidx = frag_group-&gt;sample_entries[j].group_description_index;</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :                                         if (sgidx &gt; 0x10000) {</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :                                                 sgidx -= 0x10001;</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :                                                 if (sgidx&gt;=new_idx_count) {</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :                                                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[isobmf] corrupted sample group index in fragment %d but only %d group descriptions in fragment\n&quot;, sgidx, new_idx_count));</span>
<span class="lineNum">     963 </span>            :                                                 } else {
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :                                                         frag_group-&gt;sample_entries[j].group_description_index = new_idx[sgidx];</span>
<span class="lineNum">     965 </span>            :                                                 }
<span class="lineNum">     966 </span>            :                                         }
<span class="lineNum">     967 </span>            :                                 }
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :                                 memcpy(&amp;stbl_group-&gt;sample_entries[stbl_group-&gt;entry_count], &amp;frag_group-&gt;sample_entries[0], sizeof(GF_SampleGroupEntry) * frag_group-&gt;entry_count);</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :                                 stbl_group-&gt;entry_count += frag_group-&gt;entry_count;</span>
<span class="lineNum">     970 </span>            :                         }
<span class="lineNum">     971 </span>            :                 }
<span class="lineNum">     972 </span>            : 
<span class="lineNum">     973 </span><span class="lineCov">         98 :                 if (new_idx) gf_free(new_idx);</span>
<span class="lineNum">     974 </span>            :         }
<span class="lineNum">     975 </span>            : 
<span class="lineNum">     976 </span>            :         /*content is encrypted*/
<span class="lineNum">     977 </span><span class="lineCov">       4079 :         track_num = gf_isom_get_tracknum_from_id(trak-&gt;moov, trak-&gt;Header-&gt;trackID);</span>
<span class="lineNum">     978 </span><span class="lineCov">       4079 :         if (gf_isom_is_cenc_media(trak-&gt;moov-&gt;mov, track_num, DescIndex)</span>
<span class="lineNum">     979 </span><span class="lineCov">       3942 :                 || traf-&gt;sample_encryption) {</span>
<span class="lineNum">     980 </span>            :                 /*Merge sample auxiliary encryption information*/
<span class="lineNum">     981 </span>            :                 GF_SampleEncryptionBox *senc = NULL;
<span class="lineNum">     982 </span>            :                 u32 scheme_type;
<span class="lineNum">     983 </span><span class="lineCov">        141 :                 gf_isom_get_cenc_info(trak-&gt;moov-&gt;mov, track_num, DescIndex, NULL, &amp;scheme_type, NULL);</span>
<span class="lineNum">     984 </span>            : 
<span class="lineNum">     985 </span><span class="lineCov">        141 :                 if (traf-&gt;sample_encryption) {</span>
<span class="lineNum">     986 </span><span class="lineCov">       1431 :                         for (i = 0; i &lt; gf_list_count(trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;child_boxes); i++) {</span>
<span class="lineNum">     987 </span><span class="lineCov">       1290 :                                 GF_Box *a = (GF_Box *)gf_list_get(trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;child_boxes, i);</span>
<span class="lineNum">     988 </span><span class="lineCov">       1290 :                                 if (a-&gt;type != traf-&gt;sample_encryption-&gt;type) continue;</span>
<span class="lineNum">     989 </span>            : 
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :                                 if ((a-&gt;type ==GF_ISOM_BOX_TYPE_UUID) &amp;&amp; (((GF_UUIDBox *)a)-&gt;internal_4cc == GF_ISOM_BOX_UUID_PSEC)) {</span>
<span class="lineNum">     991 </span>            :                                         senc = (GF_SampleEncryptionBox *)a;
<span class="lineNum">     992 </span>            :                                         break;
<span class="lineNum">     993 </span>            :                                 }
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :                                 else if (a-&gt;type ==GF_ISOM_BOX_TYPE_SENC) {</span>
<span class="lineNum">     995 </span>            :                                         senc = (GF_SampleEncryptionBox *)a;
<span class="lineNum">     996 </span>            :                                         break;
<span class="lineNum">     997 </span>            :                                 }
<span class="lineNum">     998 </span>            :                         }
<span class="lineNum">     999 </span><span class="lineCov">        141 :                         if (!senc &amp;&amp; trak-&gt;sample_encryption)</span>
<span class="lineNum">    1000 </span>            :                                 senc = trak-&gt;sample_encryption;
<span class="lineNum">    1001 </span>            : 
<span class="lineNum">    1002 </span><span class="lineCov">        141 :                         if (!senc) {</span>
<span class="lineNum">    1003 </span><span class="lineCov">         72 :                                 if (traf-&gt;sample_encryption-&gt;piff_type==1) {</span>
<span class="lineNum">    1004 </span><span class="lineCov">          2 :                                         senc = (GF_SampleEncryptionBox *)gf_isom_create_piff_psec_box(1, 0x2, 0, 0, NULL);</span>
<span class="lineNum">    1005 </span>            :                                 } else {
<span class="lineNum">    1006 </span><span class="lineCov">         70 :                                         senc = gf_isom_create_samp_enc_box(1, 0x2);</span>
<span class="lineNum">    1007 </span>            :                                 }
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span><span class="lineCov">         72 :                                 if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;child_boxes) trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;child_boxes = gf_list_new();</span>
<span class="lineNum">    1010 </span>            : 
<span class="lineNum">    1011 </span><span class="lineCov">         72 :                                 trak-&gt;sample_encryption = senc;</span>
<span class="lineNum">    1012 </span><span class="lineCov">         72 :                                 if (!trak-&gt;child_boxes) trak-&gt;child_boxes = gf_list_new();</span>
<span class="lineNum">    1013 </span><span class="lineCov">         72 :                                 gf_list_add(trak-&gt;child_boxes, senc);</span>
<span class="lineNum">    1014 </span>            :                         }
<span class="lineNum">    1015 </span>            :                 }
<span class="lineNum">    1016 </span>            : 
<span class="lineNum">    1017 </span>            :                 /*get sample auxiliary information by saiz/saio rather than by parsing senc box*/
<span class="lineNum">    1018 </span><span class="lineCov">        141 :                 if (gf_isom_cenc_has_saiz_saio_traf(traf, scheme_type)) {</span>
<span class="lineNum">    1019 </span>            :                         u32 nb_saio;
<span class="lineNum">    1020 </span>            :                         u32 aux_info_type;
<span class="lineNum">    1021 </span>            :                         u64 offset;
<span class="lineNum">    1022 </span>            :                         GF_Err e;
<span class="lineNum">    1023 </span>            :                         Bool is_encrypted;
<span class="lineNum">    1024 </span>            :                         GF_SampleAuxiliaryInfoOffsetBox *saio = NULL;
<span class="lineNum">    1025 </span>            :                         GF_SampleAuxiliaryInfoSizeBox *saiz = NULL;
<span class="lineNum">    1026 </span>            : 
<span class="lineNum">    1027 </span>            :                         offset = nb_saio = 0;
<span class="lineNum">    1028 </span>            : 
<span class="lineNum">    1029 </span><span class="lineCov">        139 :                         for (i = 0; i &lt; gf_list_count(traf-&gt;sai_offsets); i++) {</span>
<span class="lineNum">    1030 </span><span class="lineCov">        139 :                                 saio = (GF_SampleAuxiliaryInfoOffsetBox *)gf_list_get(traf-&gt;sai_offsets, i);</span>
<span class="lineNum">    1031 </span><span class="lineCov">        139 :                                 aux_info_type = saio-&gt;aux_info_type;</span>
<span class="lineNum">    1032 </span><span class="lineCov">        139 :                                 if (!aux_info_type) aux_info_type = scheme_type;</span>
<span class="lineNum">    1033 </span>            : 
<span class="lineNum">    1034 </span>            :                                 /*if we have only 1 sai_offsets, assume that its type is cenc*/
<span class="lineNum">    1035 </span><span class="lineCov">        139 :                                 if ((aux_info_type == GF_ISOM_CENC_SCHEME) || (aux_info_type == GF_ISOM_CBC_SCHEME) ||</span>
<span class="lineNum">    1036 </span><span class="lineCov">         30 :                                         (aux_info_type == GF_ISOM_CENS_SCHEME) || (aux_info_type == GF_ISOM_CBCS_SCHEME) ||</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :                                         (gf_list_count(traf-&gt;sai_offsets) == 1)) {</span>
<span class="lineNum">    1038 </span><span class="lineCov">        139 :                                         if (saio-&gt;offsets &amp;&amp; saio-&gt;entry_count) {</span>
<span class="lineNum">    1039 </span><span class="lineCov">        139 :                                                 offset = saio-&gt;offsets[0] + moof_offset;</span>
<span class="lineNum">    1040 </span>            :                                                 nb_saio = saio-&gt;entry_count;
<span class="lineNum">    1041 </span><span class="lineCov">        139 :                                                 break;</span>
<span class="lineNum">    1042 </span>            :                                         }
<span class="lineNum">    1043 </span>            :                                 }
<span class="lineNum">    1044 </span>            :                                 saio = NULL;
<span class="lineNum">    1045 </span>            :                         }
<span class="lineNum">    1046 </span><span class="lineCov">        139 :                         for (i = 0; i &lt; gf_list_count(traf-&gt;sai_sizes); i++) {</span>
<span class="lineNum">    1047 </span><span class="lineCov">        139 :                                 saiz = (GF_SampleAuxiliaryInfoSizeBox *)gf_list_get(traf-&gt;sai_sizes, i);</span>
<span class="lineNum">    1048 </span><span class="lineCov">        139 :                                 aux_info_type = saiz-&gt;aux_info_type;</span>
<span class="lineNum">    1049 </span><span class="lineCov">        139 :                                 if (!aux_info_type) aux_info_type = scheme_type;</span>
<span class="lineNum">    1050 </span>            :                                 /*if we have only 1 sai_sizes, assume that its type is cenc*/
<span class="lineNum">    1051 </span><span class="lineCov">        139 :                                 if ((aux_info_type == GF_ISOM_CENC_SCHEME) || (aux_info_type == GF_ISOM_CBC_SCHEME) ||</span>
<span class="lineNum">    1052 </span><span class="lineCov">         30 :                                         (aux_info_type == GF_ISOM_CENS_SCHEME) || (aux_info_type == GF_ISOM_CBCS_SCHEME) ||</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :                                         (gf_list_count(traf-&gt;sai_sizes) == 1)) {</span>
<span class="lineNum">    1054 </span>            :                                         break;
<span class="lineNum">    1055 </span>            :                                 }
<span class="lineNum">    1056 </span>            :                                 saiz = NULL;
<span class="lineNum">    1057 </span>            :                         }
<span class="lineNum">    1058 </span><span class="lineCov">        139 :                         if (saiz &amp;&amp; saio &amp;&amp; senc) {</span>
<span class="lineNum">    1059 </span><span class="lineCov">       8616 :                                 for (i = 0; i &lt; saiz-&gt;sample_count; i++) {</span>
<span class="lineNum">    1060 </span>            :                                         GF_CENCSampleAuxInfo *sai;
<span class="lineNum">    1061 </span><span class="lineCov">       4169 :                                         const u8 *key_info=NULL;</span>
<span class="lineNum">    1062 </span>            :                                         u32 key_info_size;
<span class="lineNum">    1063 </span>            :                                         u64 cur_position;
<span class="lineNum">    1064 </span><span class="lineCov">       4169 :                                         if (nb_saio != 1)</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :                                                 offset = saio-&gt;offsets[i] + moof_offset;</span>
<span class="lineNum">    1066 </span><span class="lineCov">       4169 :                                         size = saiz-&gt;default_sample_info_size ? saiz-&gt;default_sample_info_size : saiz-&gt;sample_info_size[i];</span>
<span class="lineNum">    1067 </span>            : 
<span class="lineNum">    1068 </span><span class="lineCov">       4169 :                                         cur_position = gf_bs_get_position(trak-&gt;moov-&gt;mov-&gt;movieFileMap-&gt;bs);</span>
<span class="lineNum">    1069 </span><span class="lineCov">       4169 :                                         gf_bs_seek(trak-&gt;moov-&gt;mov-&gt;movieFileMap-&gt;bs, offset);</span>
<span class="lineNum">    1070 </span>            : 
<span class="lineNum">    1071 </span><span class="lineCov">       4169 :                                         GF_SAFEALLOC(sai, GF_CENCSampleAuxInfo);</span>
<span class="lineNum">    1072 </span><span class="lineCov">       4169 :                                         if (!sai) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1073 </span>            : 
<span class="lineNum">    1074 </span><span class="lineCov">       4169 :                                         e = gf_isom_get_sample_cenc_info_internal(trak, traf, senc, i+1, &amp;is_encrypted, NULL, NULL, &amp;key_info, &amp;key_info_size);</span>
<span class="lineNum">    1075 </span><span class="lineCov">       4169 :                                         if (e) {</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :                                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[isobmf] could not get cenc info for sample %d: %s\n&quot;, i+1, gf_error_to_string(e) ));</span>
<span class="lineNum">    1077 </span>            :                                                 return e;
<span class="lineNum">    1078 </span>            :                                         }
<span class="lineNum">    1079 </span>            : 
<span class="lineNum">    1080 </span><span class="lineCov">       4169 :                                         if (is_encrypted) {</span>
<span class="lineNum">    1081 </span><span class="lineCov">       4144 :                                                 sai-&gt;cenc_data_size = size;</span>
<span class="lineNum">    1082 </span><span class="lineCov">       4144 :                                                 sai-&gt;cenc_data = gf_malloc(sizeof(u8)*size);</span>
<span class="lineNum">    1083 </span><span class="lineCov">       4144 :                                                 if (!sai-&gt;cenc_data) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1084 </span><span class="lineCov">       4144 :                                                 gf_bs_read_data(trak-&gt;moov-&gt;mov-&gt;movieFileMap-&gt;bs, sai-&gt;cenc_data, sai-&gt;cenc_data_size);</span>
<span class="lineNum">    1085 </span>            :                                         } else {
<span class="lineNum">    1086 </span><span class="lineCov">         25 :                                                 sai-&gt;isNotProtected=1;</span>
<span class="lineNum">    1087 </span>            :                                         }
<span class="lineNum">    1088 </span>            : 
<span class="lineNum">    1089 </span><span class="lineCov">       4169 :                                         if (key_info) {</span>
<span class="lineNum">    1090 </span>            :                                                 //not multikey
<span class="lineNum">    1091 </span><span class="lineCov">       4072 :                                                 if (!key_info[0]) {</span>
<span class="lineNum">    1092 </span>            :                                                         //size greater than IV
<span class="lineNum">    1093 </span><span class="lineCov">       4072 :                                                         if (size &gt; key_info[3])</span>
<span class="lineNum">    1094 </span><span class="lineCov">       1805 :                                                                 senc-&gt;flags = 0x00000002;</span>
<span class="lineNum">    1095 </span>            :                                                 }
<span class="lineNum">    1096 </span>            :                                                 //multikey, always use subsamples
<span class="lineNum">    1097 </span>            :                                                 else {
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :                                                         senc-&gt;flags = 0x00000002;</span>
<span class="lineNum">    1099 </span>            :                                                 }
<span class="lineNum">    1100 </span>            :                                         }
<span class="lineNum">    1101 </span>            : 
<span class="lineNum">    1102 </span>            : 
<span class="lineNum">    1103 </span><span class="lineCov">       4169 :                                         gf_bs_seek(trak-&gt;moov-&gt;mov-&gt;movieFileMap-&gt;bs, cur_position);</span>
<span class="lineNum">    1104 </span>            : 
<span class="lineNum">    1105 </span><span class="lineCov">       4169 :                                         gf_list_add(senc-&gt;samp_aux_info, sai);</span>
<span class="lineNum">    1106 </span>            : 
<span class="lineNum">    1107 </span><span class="lineCov">       4169 :                                         e = gf_isom_cenc_merge_saiz_saio(senc, trak-&gt;Media-&gt;information-&gt;sampleTable, offset, size);</span>
<span class="lineNum">    1108 </span><span class="lineCov">       4169 :                                         if (e) return e;</span>
<span class="lineNum">    1109 </span><span class="lineCov">       4169 :                                         if (nb_saio == 1)</span>
<span class="lineNum">    1110 </span><span class="lineCov">       4169 :                                                 offset += size;</span>
<span class="lineNum">    1111 </span>            :                                 }
<span class="lineNum">    1112 </span>            :                         }
<span class="lineNum">    1113 </span><span class="lineCov">          2 :                 } else if (traf-&gt;sample_encryption) {</span>
<span class="lineNum">    1114 </span><span class="lineCov">          2 :                         senc_Parse(trak-&gt;moov-&gt;mov-&gt;movieFileMap-&gt;bs, trak, traf, traf-&gt;sample_encryption);</span>
<span class="lineNum">    1115 </span><span class="lineCov">          2 :                         trak-&gt;sample_encryption-&gt;AlgorithmID = traf-&gt;sample_encryption-&gt;AlgorithmID;</span>
<span class="lineNum">    1116 </span><span class="lineCov">          2 :                         if (!trak-&gt;sample_encryption-&gt;IV_size)</span>
<span class="lineNum">    1117 </span><span class="lineCov">          2 :                                 trak-&gt;sample_encryption-&gt;IV_size = traf-&gt;sample_encryption-&gt;IV_size;</span>
<span class="lineNum">    1118 </span><span class="lineCov">          2 :                         if (!trak-&gt;sample_encryption-&gt;samp_aux_info) trak-&gt;sample_encryption-&gt;samp_aux_info = gf_list_new();</span>
<span class="lineNum">    1119 </span><span class="lineCov">          2 :                         gf_list_transfer(trak-&gt;sample_encryption-&gt;samp_aux_info, traf-&gt;sample_encryption-&gt;samp_aux_info);</span>
<span class="lineNum">    1120 </span><span class="lineCov">          2 :                         if (traf-&gt;sample_encryption-&gt;flags &amp; 0x00000002)</span>
<span class="lineNum">    1121 </span><span class="lineCov">          2 :                                 trak-&gt;sample_encryption-&gt;flags |= 0x00000002;</span>
<span class="lineNum">    1122 </span>            :                 }
<span class="lineNum">    1123 </span>            :         }
<span class="lineNum">    1124 </span>            :         return GF_OK;
<span class="lineNum">    1125 </span>            : }
<span class="lineNum">    1126 </span>            : 
<span class="lineNum">    1127 </span>            : #endif
<span class="lineNum">    1128 </span>            : 
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span>            : #ifndef GPAC_DISABLE_ISOM_WRITE
<a name="1131"><span class="lineNum">    1131 </span>            : </a>
<span class="lineNum">    1132 </span>            : //used to check if a TrackID is available
<span class="lineNum">    1133 </span><span class="lineCov">       1857 : u8 RequestTrack(GF_MovieBox *moov, GF_ISOTrackID TrackID)</span>
<span class="lineNum">    1134 </span>            : {
<span class="lineNum">    1135 </span>            :         u32 i;
<span class="lineNum">    1136 </span>            :         GF_TrackBox *trak;
<span class="lineNum">    1137 </span>            : 
<span class="lineNum">    1138 </span><span class="lineCov">       1857 :         i=0;</span>
<span class="lineNum">    1139 </span><span class="lineCov">       5351 :         while ((trak = (GF_TrackBox *)gf_list_enum(moov-&gt;trackList, &amp;i))) {</span>
<span class="lineNum">    1140 </span><span class="lineCov">       1831 :                 if (trak-&gt;Header-&gt;trackID == TrackID) {</span>
<span class="lineNum">    1141 </span><span class="lineCov">        194 :                         gf_isom_set_last_error(moov-&gt;mov, GF_BAD_PARAM);</span>
<span class="lineNum">    1142 </span><span class="lineCov">        194 :                         return 0;</span>
<span class="lineNum">    1143 </span>            :                 }
<span class="lineNum">    1144 </span>            :         }
<span class="lineNum">    1145 </span>            :         return 1;
<a name="1146"><span class="lineNum">    1146 </span>            : }</a>
<span class="lineNum">    1147 </span>            : 
<span class="lineNum">    1148 </span><span class="lineCov">          1 : GF_Err Track_RemoveRef(GF_TrackBox *trak, u32 ReferenceType)</span>
<span class="lineNum">    1149 </span>            : {
<span class="lineNum">    1150 </span>            :         GF_TrackReferenceBox *ref;
<span class="lineNum">    1151 </span>            :         GF_Box *a;
<span class="lineNum">    1152 </span>            :         u32 i;
<span class="lineNum">    1153 </span><span class="lineCov">          1 :         if (! trak) return GF_BAD_PARAM;</span>
<span class="lineNum">    1154 </span><span class="lineCov">          1 :         if (! trak-&gt;References) return GF_OK;</span>
<span class="lineNum">    1155 </span>            :         ref = trak-&gt;References;
<span class="lineNum">    1156 </span><span class="lineCov">          1 :         i=0;</span>
<span class="lineNum">    1157 </span><span class="lineCov">          4 :         while ((a = (GF_Box *)gf_list_enum(ref-&gt;child_boxes, &amp;i))) {</span>
<span class="lineNum">    1158 </span><span class="lineCov">          2 :                 if (a-&gt;type == ReferenceType) {</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :                         gf_isom_box_del_parent(&amp;ref-&gt;child_boxes, a);</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :                         return GF_OK;</span>
<span class="lineNum">    1161 </span>            :                 }
<span class="lineNum">    1162 </span>            :         }
<span class="lineNum">    1163 </span>            :         return GF_OK;
<a name="1164"><span class="lineNum">    1164 </span>            : }</a>
<span class="lineNum">    1165 </span>            : 
<span class="lineNum">    1166 </span><span class="lineCov">       1626 : GF_Err NewMedia(GF_MediaBox **mdia, u32 MediaType, u32 TimeScale)</span>
<span class="lineNum">    1167 </span>            : {
<span class="lineNum">    1168 </span>            :         GF_MediaHeaderBox *mdhd;
<span class="lineNum">    1169 </span>            :         GF_Box *mediaInfo;
<span class="lineNum">    1170 </span>            :         GF_HandlerBox *hdlr;
<span class="lineNum">    1171 </span>            :         GF_MediaInformationBox *minf;
<span class="lineNum">    1172 </span>            :         GF_DataInformationBox *dinf;
<span class="lineNum">    1173 </span>            :         GF_SampleTableBox *stbl;
<span class="lineNum">    1174 </span>            :         GF_DataReferenceBox *dref;
<span class="lineNum">    1175 </span>            :         char *str=&quot;&quot;;
<span class="lineNum">    1176 </span>            : 
<span class="lineNum">    1177 </span>            :         GF_Err e;
<span class="lineNum">    1178 </span>            : 
<span class="lineNum">    1179 </span><span class="lineCov">       1626 :         if (!mdia) return GF_BAD_PARAM;</span>
<span class="lineNum">    1180 </span>            : 
<span class="lineNum">    1181 </span><span class="lineCov">       1626 :         minf = *mdia ? (*mdia)-&gt;information : NULL;</span>
<span class="lineNum">    1182 </span><span class="lineCov">       1626 :         mdhd = *mdia ? (*mdia)-&gt;mediaHeader : NULL;</span>
<span class="lineNum">    1183 </span><span class="lineCov">       1626 :         hdlr = *mdia ? (*mdia)-&gt;handler : NULL;</span>
<span class="lineNum">    1184 </span><span class="lineCov">       1626 :         dinf =  minf ? minf-&gt;dataInformation : NULL;</span>
<span class="lineNum">    1185 </span><span class="lineCov">       1626 :         stbl = minf ? minf-&gt;sampleTable : NULL;</span>
<span class="lineNum">    1186 </span><span class="lineCov">       1626 :         dref = dinf ? dinf-&gt;dref : NULL;</span>
<span class="lineNum">    1187 </span><span class="lineCov">       1626 :         mediaInfo = minf ? minf-&gt;InfoHeader : NULL;</span>
<span class="lineNum">    1188 </span>            : 
<span class="lineNum">    1189 </span>            :         //first create the media
<span class="lineNum">    1190 </span><span class="lineCov">       1626 :         if (!*mdia) {</span>
<span class="lineNum">    1191 </span><span class="lineCov">       1011 :                 *mdia = (GF_MediaBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_MDIA);</span>
<span class="lineNum">    1192 </span><span class="lineCov">       1011 :                 if (! *mdia) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1193 </span>            :         }
<span class="lineNum">    1194 </span><span class="lineCov">       1626 :         if (!mdhd) {</span>
<span class="lineNum">    1195 </span><span class="lineCov">       1011 :                 mdhd = (GF_MediaHeaderBox *) gf_isom_box_new_parent( &amp; ((*mdia)-&gt;child_boxes), GF_ISOM_BOX_TYPE_MDHD);</span>
<span class="lineNum">    1196 </span><span class="lineCov">       1011 :                 if (! mdhd) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1197 </span><span class="lineCov">       1011 :                 e = mdia_on_child_box((GF_Box*)*mdia, (GF_Box *) mdhd, GF_FALSE);</span>
<span class="lineNum">    1198 </span><span class="lineCov">       1011 :                 if (e) goto err_exit;</span>
<span class="lineNum">    1199 </span>            :         }
<span class="lineNum">    1200 </span><span class="lineCov">       1626 :         if (!hdlr) {</span>
<span class="lineNum">    1201 </span><span class="lineCov">       1011 :                 hdlr = (GF_HandlerBox *) gf_isom_box_new_parent(&amp; ((*mdia)-&gt;child_boxes), GF_ISOM_BOX_TYPE_HDLR);</span>
<span class="lineNum">    1202 </span><span class="lineCov">       1011 :                 if (! hdlr) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1203 </span><span class="lineCov">       1011 :                 e = mdia_on_child_box((GF_Box*)*mdia, (GF_Box *) hdlr, GF_FALSE);</span>
<span class="lineNum">    1204 </span><span class="lineCov">       1011 :                 if (e) goto err_exit;</span>
<span class="lineNum">    1205 </span>            :         }
<span class="lineNum">    1206 </span><span class="lineCov">       1626 :         if (!minf) {</span>
<span class="lineNum">    1207 </span><span class="lineCov">       1011 :                 minf = (GF_MediaInformationBox *) gf_isom_box_new_parent(&amp; ((*mdia)-&gt;child_boxes), GF_ISOM_BOX_TYPE_MINF);</span>
<span class="lineNum">    1208 </span><span class="lineCov">       1011 :                 if (! minf) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1209 </span><span class="lineCov">       1011 :                 e = mdia_on_child_box((GF_Box*)*mdia, (GF_Box *) minf, GF_FALSE);</span>
<span class="lineNum">    1210 </span><span class="lineCov">       1011 :                 if (e) goto err_exit;</span>
<span class="lineNum">    1211 </span>            :         }
<span class="lineNum">    1212 </span><span class="lineCov">       1626 :         if (!dinf) {</span>
<span class="lineNum">    1213 </span><span class="lineCov">       1011 :                 dinf = (GF_DataInformationBox *) gf_isom_box_new_parent(&amp;minf-&gt;child_boxes, GF_ISOM_BOX_TYPE_DINF);</span>
<span class="lineNum">    1214 </span><span class="lineCov">       1011 :                 if (! dinf) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1215 </span><span class="lineCov">       1011 :                 e = minf_on_child_box((GF_Box*)minf, (GF_Box *) dinf, GF_FALSE);</span>
<span class="lineNum">    1216 </span><span class="lineCov">       1011 :                 if (e) goto err_exit;</span>
<span class="lineNum">    1217 </span>            :         }
<span class="lineNum">    1218 </span>            : 
<span class="lineNum">    1219 </span><span class="lineCov">       1626 :         if (!mediaInfo) {</span>
<span class="lineNum">    1220 </span>            :                 //&quot;handler name&quot; is for debugging purposes. Let's stick our name here ;)
<span class="lineNum">    1221 </span><span class="lineCov">       1011 :                 switch (MediaType) {</span>
<span class="lineNum">    1222 </span><span class="lineCov">        537 :                 case GF_ISOM_MEDIA_VISUAL:</span>
<span class="lineNum">    1223 </span><span class="lineCov">        537 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_VMHD);</span>
<span class="lineNum">    1224 </span>            :                         str = &quot;GPAC ISO Video Handler&quot;;
<span class="lineNum">    1225 </span><span class="lineCov">        537 :                         break;</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :                 case GF_ISOM_MEDIA_AUXV:</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_VMHD);</span>
<span class="lineNum">    1228 </span>            :                         str = &quot;GPAC ISO Auxiliary Video Handler&quot;;
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :                 case GF_ISOM_MEDIA_PICT:</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_VMHD);</span>
<span class="lineNum">    1232 </span>            :                         str = &quot;GPAC ISO Picture Sequence Handler&quot;;
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1234 </span><span class="lineCov">        179 :                 case GF_ISOM_MEDIA_AUDIO:</span>
<span class="lineNum">    1235 </span><span class="lineCov">        179 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_SMHD);</span>
<span class="lineNum">    1236 </span>            :                         str = &quot;GPAC ISO Audio Handler&quot;;
<span class="lineNum">    1237 </span><span class="lineCov">        179 :                         break;</span>
<span class="lineNum">    1238 </span><span class="lineCov">         73 :                 case GF_ISOM_MEDIA_HINT:</span>
<span class="lineNum">    1239 </span><span class="lineCov">         73 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_HMHD);</span>
<span class="lineNum">    1240 </span>            :                         str = &quot;GPAC ISO Hint Handler&quot;;
<span class="lineNum">    1241 </span><span class="lineCov">         73 :                         break;</span>
<span class="lineNum">    1242 </span><span class="lineCov">         11 :                 case GF_ISOM_MEDIA_META:</span>
<span class="lineNum">    1243 </span><span class="lineCov">         11 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_NMHD);</span>
<span class="lineNum">    1244 </span>            :                         str = &quot;GPAC Timed MetaData Handler&quot;;
<span class="lineNum">    1245 </span><span class="lineCov">         11 :                         break;</span>
<span class="lineNum">    1246 </span><span class="lineCov">         30 :                 case GF_ISOM_MEDIA_OD:</span>
<span class="lineNum">    1247 </span><span class="lineCov">         30 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_NMHD);</span>
<span class="lineNum">    1248 </span>            :                         str = &quot;GPAC MPEG-4 OD Handler&quot;;
<span class="lineNum">    1249 </span><span class="lineCov">         30 :                         break;</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :                 case GF_ISOM_MEDIA_OCR:</span>
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_NMHD);</span>
<span class="lineNum">    1252 </span>            :                         str = &quot;GPAC MPEG-4 OCR Handler&quot;;
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1254 </span><span class="lineCov">         69 :                 case GF_ISOM_MEDIA_SCENE:</span>
<span class="lineNum">    1255 </span><span class="lineCov">         69 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_NMHD);</span>
<span class="lineNum">    1256 </span>            :                         str = &quot;GPAC MPEG-4 Scene Description Handler&quot;;
<span class="lineNum">    1257 </span><span class="lineCov">         69 :                         break;</span>
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :                 case GF_ISOM_MEDIA_MPEG7:</span>
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_NMHD);</span>
<span class="lineNum">    1260 </span>            :                         str = &quot;GPAC MPEG-4 MPEG-7 Handler&quot;;
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :                 case GF_ISOM_MEDIA_OCI:</span>
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_NMHD);</span>
<span class="lineNum">    1264 </span>            :                         str = &quot;GPAC MPEG-4 OCI Handler&quot;;
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :                 case GF_ISOM_MEDIA_IPMP:</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_NMHD);</span>
<span class="lineNum">    1268 </span>            :                         str = &quot;GPAC MPEG-4 IPMP Handler&quot;;
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :                 case GF_ISOM_MEDIA_MPEGJ:</span>
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_NMHD);</span>
<span class="lineNum">    1272 </span>            :                         str = &quot;GPAC MPEG-4 MPEG-J Handler&quot;;
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1274 </span><span class="lineCov">         83 :                 case GF_ISOM_MEDIA_TEXT:</span>
<span class="lineNum">    1275 </span>            :                 case GF_ISOM_MEDIA_SUBT:
<span class="lineNum">    1276 </span><span class="lineCov">         83 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_NMHD);</span>
<span class="lineNum">    1277 </span>            :                         str = &quot;GPAC Streaming Text Handler&quot;;
<span class="lineNum">    1278 </span><span class="lineCov">         83 :                         break;</span>
<span class="lineNum">    1279 </span><span class="lineCov">         25 :                 case GF_ISOM_MEDIA_MPEG_SUBT:</span>
<span class="lineNum">    1280 </span><span class="lineCov">         25 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_STHD);</span>
<span class="lineNum">    1281 </span>            :                         str = &quot;GPAC MPEG Subtitle Handler&quot;;
<span class="lineNum">    1282 </span><span class="lineCov">         25 :                         break;</span>
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :                 case GF_ISOM_MEDIA_DIMS:</span>
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_VMHD);</span>
<span class="lineNum">    1285 </span>            :                         MediaType = GF_ISOM_MEDIA_SCENE;
<span class="lineNum">    1286 </span>            :                         str = &quot;GPAC DIMS Handler&quot;;
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1288 </span><span class="lineCov">          3 :                 case GF_ISOM_MEDIA_TIMECODE:</span>
<span class="lineNum">    1289 </span><span class="lineCov">          3 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_GMHD);</span>
<span class="lineNum">    1290 </span>            :                         str = &quot;GPAC TMCD Handler&quot;;
<span class="lineNum">    1291 </span><span class="lineCov">          3 :                         break;</span>
<span class="lineNum">    1292 </span><span class="lineCov">          1 :                 default:</span>
<span class="lineNum">    1293 </span><span class="lineCov">          1 :                         mediaInfo = gf_isom_box_new(GF_ISOM_BOX_TYPE_NMHD);</span>
<span class="lineNum">    1294 </span>            :                         str = &quot;GPAC IsoMedia Handler&quot;;
<span class="lineNum">    1295 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    1296 </span>            :                 }
<span class="lineNum">    1297 </span><span class="lineCov">       1011 :                 if (! mediaInfo) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1298 </span><span class="lineCov">       1011 :                 if (!minf-&gt;child_boxes) minf-&gt;child_boxes = gf_list_new();</span>
<span class="lineNum">    1299 </span><span class="lineCov">       1011 :                 gf_list_add(minf-&gt;child_boxes, mediaInfo);</span>
<span class="lineNum">    1300 </span>            : 
<span class="lineNum">    1301 </span><span class="lineCov">       1011 :                 e = minf_on_child_box((GF_Box*)minf, (GF_Box *) mediaInfo, GF_FALSE);</span>
<span class="lineNum">    1302 </span><span class="lineCov">       1011 :                 if (e) goto err_exit;</span>
<span class="lineNum">    1303 </span>            :         }
<span class="lineNum">    1304 </span>            : 
<span class="lineNum">    1305 </span><span class="lineCov">       1626 :         mdhd-&gt;timeScale = TimeScale;</span>
<span class="lineNum">    1306 </span><span class="lineCov">       1626 :         hdlr-&gt;handlerType = MediaType;</span>
<span class="lineNum">    1307 </span><span class="lineCov">       1626 :         if (!hdlr-&gt;nameUTF8)</span>
<span class="lineNum">    1308 </span><span class="lineCov">       1011 :                 hdlr-&gt;nameUTF8 = gf_strdup(str);</span>
<span class="lineNum">    1309 </span>            : 
<span class="lineNum">    1310 </span><span class="lineCov">       1626 :         if (!dref) {</span>
<span class="lineNum">    1311 </span>            :                 //Create a data reference WITHOUT DATA ENTRY (we don't know anything yet about the media Data)
<span class="lineNum">    1312 </span><span class="lineCov">       1011 :                 dref = (GF_DataReferenceBox *) gf_isom_box_new_parent(&amp;dinf-&gt;child_boxes, GF_ISOM_BOX_TYPE_DREF);</span>
<span class="lineNum">    1313 </span><span class="lineCov">       1011 :                 if (! dref) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1314 </span><span class="lineCov">       1011 :                 e = dinf_on_child_box((GF_Box*)dinf, (GF_Box *)dref, GF_FALSE);</span>
<span class="lineNum">    1315 </span><span class="lineCov">       1011 :                 if (e) goto err_exit;</span>
<span class="lineNum">    1316 </span>            :         }
<span class="lineNum">    1317 </span>            : 
<span class="lineNum">    1318 </span><span class="lineCov">       1626 :         if (!stbl) {</span>
<span class="lineNum">    1319 </span>            :                 //first set-up the sample table...
<span class="lineNum">    1320 </span><span class="lineCov">       1011 :                 stbl = (GF_SampleTableBox *) gf_isom_box_new_parent(&amp;minf-&gt;child_boxes, GF_ISOM_BOX_TYPE_STBL);</span>
<span class="lineNum">    1321 </span><span class="lineCov">       1011 :                 if (! stbl) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1322 </span>            : 
<span class="lineNum">    1323 </span><span class="lineCov">       1011 :                 e = minf_on_child_box((GF_Box*)minf, (GF_Box *) stbl, GF_FALSE);</span>
<span class="lineNum">    1324 </span><span class="lineCov">       1011 :                 if (e) goto err_exit;</span>
<span class="lineNum">    1325 </span>            :         }
<span class="lineNum">    1326 </span><span class="lineCov">       1626 :         if (!stbl-&gt;SampleDescription) {</span>
<span class="lineNum">    1327 </span><span class="lineCov">       1011 :                 stbl-&gt;SampleDescription = (GF_SampleDescriptionBox *) gf_isom_box_new_parent(&amp;stbl-&gt;child_boxes, GF_ISOM_BOX_TYPE_STSD);</span>
<span class="lineNum">    1328 </span><span class="lineCov">       1011 :                 if (! stbl-&gt;SampleDescription) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1329 </span>            :         }
<span class="lineNum">    1330 </span>            : 
<span class="lineNum">    1331 </span>            :         //by default create a regular table, 32 but offset and normal sample size
<span class="lineNum">    1332 </span><span class="lineCov">       1626 :         if (!stbl-&gt;ChunkOffset) {</span>
<span class="lineNum">    1333 </span><span class="lineCov">       1626 :                 stbl-&gt;ChunkOffset = gf_isom_box_new_parent(&amp;stbl-&gt;child_boxes, GF_ISOM_BOX_TYPE_STCO);</span>
<span class="lineNum">    1334 </span><span class="lineCov">       1626 :                 if (! stbl-&gt;ChunkOffset) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1335 </span>            :         }
<span class="lineNum">    1336 </span><span class="lineCov">       1626 :         if (!stbl-&gt;SampleSize) {</span>
<span class="lineNum">    1337 </span><span class="lineCov">       1626 :                 stbl-&gt;SampleSize = (GF_SampleSizeBox *) gf_isom_box_new_parent(&amp;stbl-&gt;child_boxes, GF_ISOM_BOX_TYPE_STSZ);</span>
<span class="lineNum">    1338 </span><span class="lineCov">       1626 :                 if (! stbl-&gt;SampleSize) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1339 </span>            :         }
<span class="lineNum">    1340 </span><span class="lineCov">       1626 :         if (!stbl-&gt;SampleToChunk) {</span>
<span class="lineNum">    1341 </span><span class="lineCov">       1626 :                 stbl-&gt;SampleToChunk = (GF_SampleToChunkBox *) gf_isom_box_new_parent(&amp;stbl-&gt;child_boxes, GF_ISOM_BOX_TYPE_STSC);</span>
<span class="lineNum">    1342 </span><span class="lineCov">       1626 :                 if (! stbl-&gt;SampleToChunk) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1343 </span>            :         }
<span class="lineNum">    1344 </span><span class="lineCov">       1626 :         if (!stbl-&gt;TimeToSample) {</span>
<span class="lineNum">    1345 </span><span class="lineCov">       1626 :                 stbl-&gt;TimeToSample = (GF_TimeToSampleBox *) gf_isom_box_new_parent(&amp;stbl-&gt;child_boxes, GF_ISOM_BOX_TYPE_STTS);</span>
<span class="lineNum">    1346 </span><span class="lineCov">       1626 :                 if (! stbl-&gt;TimeToSample) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1347 </span>            :         }
<span class="lineNum">    1348 </span><span class="lineCov">       1626 :         if (!stbl-&gt;SampleDescription) {</span>
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :                 stbl-&gt;SampleDescription = (GF_SampleDescriptionBox *) gf_isom_box_new_parent(&amp;stbl-&gt;child_boxes, GF_ISOM_BOX_TYPE_STSD);</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :                 if (! stbl-&gt;SampleDescription) { e = GF_OUT_OF_MEM; goto err_exit; }</span>
<span class="lineNum">    1351 </span>            :         }
<span class="lineNum">    1352 </span>            :         return GF_OK;
<span class="lineNum">    1353 </span>            : 
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 : err_exit:</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :         if (mdhd) gf_isom_box_del_parent(&amp; ((*mdia)-&gt;child_boxes), (GF_Box *)mdhd);</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :         if (minf) gf_isom_box_del_parent(&amp; ((*mdia)-&gt;child_boxes), (GF_Box *)minf);</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :         if (hdlr) {</span>
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :                 gf_isom_box_del_parent(&amp; ((*mdia)-&gt;child_boxes) , (GF_Box *)hdlr);</span>
<span class="lineNum">    1359 </span>            :         }
<span class="lineNum">    1360 </span>            :         return e;
<span class="lineNum">    1361 </span>            : 
<a name="1362"><span class="lineNum">    1362 </span>            : }</a>
<span class="lineNum">    1363 </span>            : 
<span class="lineNum">    1364 </span><span class="lineCov">        612 : GF_Err Track_SetStreamDescriptor(GF_TrackBox *trak, u32 StreamDescriptionIndex, u32 DataReferenceIndex, GF_ESD *esd, u32 *outStreamIndex)</span>
<span class="lineNum">    1365 </span>            : {
<span class="lineNum">    1366 </span>            :         GF_Err e;
<span class="lineNum">    1367 </span>            :         GF_MPEGSampleEntryBox *entry;
<span class="lineNum">    1368 </span>            :         GF_MPEGVisualSampleEntryBox *entry_v;
<span class="lineNum">    1369 </span>            :         GF_MPEGAudioSampleEntryBox *entry_a;
<span class="lineNum">    1370 </span>            :         GF_TrackReferenceBox *tref;
<span class="lineNum">    1371 </span>            :         GF_TrackReferenceTypeBox *dpnd;
<span class="lineNum">    1372 </span>            :         u16 tmpRef;
<span class="lineNum">    1373 </span>            : 
<span class="lineNum">    1374 </span>            :         entry = NULL;
<span class="lineNum">    1375 </span>            :         tref = NULL;
<span class="lineNum">    1376 </span>            : 
<span class="lineNum">    1377 </span><span class="lineCov">        612 :         if (!trak || !esd || (!outStreamIndex &amp;&amp; !DataReferenceIndex) ) return GF_BAD_PARAM;</span>
<span class="lineNum">    1378 </span><span class="lineCov">        612 :         if (!Track_IsMPEG4Stream(trak-&gt;Media-&gt;handler-&gt;handlerType)) return GF_ISOM_INVALID_MEDIA;</span>
<span class="lineNum">    1379 </span>            : 
<span class="lineNum">    1380 </span>            : 
<span class="lineNum">    1381 </span><span class="lineCov">        611 :         esd-&gt;ESID = 0;</span>
<span class="lineNum">    1382 </span>            :         //set SL to predefined if no url
<span class="lineNum">    1383 </span><span class="lineCov">        611 :         if (esd-&gt;URLString == NULL) {</span>
<span class="lineNum">    1384 </span><span class="lineCov">        611 :                 if (!esd-&gt;slConfig) esd-&gt;slConfig = (GF_SLConfig*) gf_odf_desc_new(GF_ODF_SLC_TAG);</span>
<span class="lineNum">    1385 </span><span class="lineCov">        611 :                 esd-&gt;slConfig-&gt;predefined = SLPredef_MP4;</span>
<span class="lineNum">    1386 </span><span class="lineCov">        611 :                 esd-&gt;slConfig-&gt;durationFlag = 0;</span>
<span class="lineNum">    1387 </span><span class="lineCov">        611 :                 esd-&gt;slConfig-&gt;useTimestampsFlag = 1;</span>
<span class="lineNum">    1388 </span>            :         }
<span class="lineNum">    1389 </span>            : 
<span class="lineNum">    1390 </span>            :         //get the REF box if needed
<span class="lineNum">    1391 </span><span class="lineCov">        611 :         if (esd-&gt;dependsOnESID || (esd-&gt;OCRESID  &amp;&amp; (esd-&gt;OCRESID != trak-&gt;moov-&gt;mov-&gt;es_id_default_sync)) ) {</span>
<span class="lineNum">    1392 </span><span class="lineCov">         53 :                 if (!trak-&gt;References) {</span>
<span class="lineNum">    1393 </span><span class="lineCov">         27 :                         tref = (GF_TrackReferenceBox *) gf_isom_box_new_parent(&amp;trak-&gt;child_boxes, GF_ISOM_BOX_TYPE_TREF);</span>
<span class="lineNum">    1394 </span><span class="lineCov">         27 :                         if (!tref) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1395 </span><span class="lineCov">         27 :                         e = trak_on_child_box((GF_Box*)trak, (GF_Box *)tref, GF_FALSE);</span>
<span class="lineNum">    1396 </span><span class="lineCov">         27 :                         if (e) return e;</span>
<span class="lineNum">    1397 </span>            :                 }
<span class="lineNum">    1398 </span><span class="lineCov">         53 :                 tref = trak-&gt;References;</span>
<span class="lineNum">    1399 </span>            :         }
<span class="lineNum">    1400 </span>            : 
<span class="lineNum">    1401 </span>            :         //Update Stream dependencies
<span class="lineNum">    1402 </span><span class="lineCov">        611 :         e = Track_FindRef(trak, GF_ISOM_REF_DECODE, &amp;dpnd);</span>
<span class="lineNum">    1403 </span><span class="lineCov">        611 :         if (e) return e;</span>
<span class="lineNum">    1404 </span>            : 
<span class="lineNum">    1405 </span><span class="lineCov">        611 :         if (!dpnd &amp;&amp; esd-&gt;dependsOnESID) {</span>
<span class="lineNum">    1406 </span><span class="lineCov">         17 :                 e = Track_FindRef(trak, GF_ISOM_REF_BASE, &amp;dpnd);</span>
<span class="lineNum">    1407 </span><span class="lineCov">         17 :                 if (e) return e;</span>
<span class="lineNum">    1408 </span>            :         }
<span class="lineNum">    1409 </span>            : 
<span class="lineNum">    1410 </span><span class="lineCov">        611 :         if (!dpnd &amp;&amp; esd-&gt;dependsOnESID) {</span>
<span class="lineNum">    1411 </span><span class="lineCov">         14 :                 dpnd = (GF_TrackReferenceTypeBox *) gf_isom_box_new_parent(&amp;tref-&gt;child_boxes, GF_ISOM_BOX_TYPE_REFT);</span>
<span class="lineNum">    1412 </span><span class="lineCov">         14 :                 dpnd-&gt;reference_type = GF_ISOM_BOX_TYPE_DPND;</span>
<span class="lineNum">    1413 </span><span class="lineCov">         14 :                 e = reftype_AddRefTrack(dpnd, esd-&gt;dependsOnESID, NULL);</span>
<span class="lineNum">    1414 </span><span class="lineCov">         14 :                 if (e) return e;</span>
<span class="lineNum">    1415 </span><span class="lineCov">        597 :         } else if (dpnd &amp;&amp; !esd-&gt;dependsOnESID) {</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :                 Track_RemoveRef(trak, GF_ISOM_BOX_TYPE_DPND);</span>
<span class="lineNum">    1417 </span>            :         }
<span class="lineNum">    1418 </span><span class="lineCov">        611 :         esd-&gt;dependsOnESID = 0;</span>
<span class="lineNum">    1419 </span>            : 
<span class="lineNum">    1420 </span>            :         //Update GF_Clock dependencies
<span class="lineNum">    1421 </span><span class="lineCov">        611 :         e = Track_FindRef(trak, GF_ISOM_REF_OCR, &amp;dpnd);</span>
<span class="lineNum">    1422 </span><span class="lineCov">        611 :         if (e) return e;</span>
<span class="lineNum">    1423 </span><span class="lineCov">        611 :         if (!dpnd &amp;&amp; esd-&gt;OCRESID &amp;&amp; (esd-&gt;OCRESID != trak-&gt;moov-&gt;mov-&gt;es_id_default_sync)) {</span>
<span class="lineNum">    1424 </span><span class="lineCov">         29 :                 dpnd = (GF_TrackReferenceTypeBox *) gf_isom_box_new_parent(&amp;tref-&gt;child_boxes, GF_ISOM_BOX_TYPE_REFT);</span>
<span class="lineNum">    1425 </span><span class="lineCov">         29 :                 if (!dpnd) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1426 </span><span class="lineCov">         29 :                 dpnd-&gt;reference_type = GF_ISOM_BOX_TYPE_SYNC;</span>
<span class="lineNum">    1427 </span><span class="lineCov">         29 :                 e = reftype_AddRefTrack(dpnd, esd-&gt;OCRESID, NULL);</span>
<span class="lineNum">    1428 </span><span class="lineCov">         29 :                 if (e) return e;</span>
<span class="lineNum">    1429 </span><span class="lineCov">        582 :         } else if (dpnd &amp;&amp; !esd-&gt;OCRESID) {</span>
<span class="lineNum">    1430 </span><span class="lineCov">          1 :                 Track_RemoveRef(trak, GF_ISOM_BOX_TYPE_SYNC);</span>
<span class="lineNum">    1431 </span><span class="lineCov">        581 :         } else if (dpnd &amp;&amp; esd-&gt;OCRESID) {</span>
<span class="lineNum">    1432 </span><span class="lineCov">         21 :                 if (dpnd-&gt;trackIDCount != 1) return GF_ISOM_INVALID_MEDIA;</span>
<span class="lineNum">    1433 </span><span class="lineCov">         21 :                 dpnd-&gt;trackIDs[0] = esd-&gt;OCRESID;</span>
<span class="lineNum">    1434 </span>            :         }
<span class="lineNum">    1435 </span><span class="lineCov">        611 :         esd-&gt;OCRESID = 0;</span>
<span class="lineNum">    1436 </span>            : 
<span class="lineNum">    1437 </span>            :         //brand new case: we have to change the IPI desc
<span class="lineNum">    1438 </span><span class="lineCov">        611 :         if (esd-&gt;ipiPtr) {</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :                 e = Track_FindRef(trak, GF_ISOM_REF_IPI, &amp;dpnd);</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :                 if (e) return e;</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :                 if (!dpnd) {</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :                         tmpRef = 0;</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :                         dpnd = (GF_TrackReferenceTypeBox *) gf_isom_box_new_parent(&amp;tref-&gt;child_boxes, GF_ISOM_BOX_TYPE_REFT);</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :                         if (!dpnd) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :                         dpnd-&gt;reference_type = GF_ISOM_BOX_TYPE_IPIR;</span>
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :                         e = reftype_AddRefTrack(dpnd, esd-&gt;ipiPtr-&gt;IPI_ES_Id, &amp;tmpRef);</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :                         if (e) return e;</span>
<span class="lineNum">    1448 </span>            :                         //and replace the tag and value...
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :                         esd-&gt;ipiPtr-&gt;IPI_ES_Id = tmpRef;</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :                         esd-&gt;ipiPtr-&gt;tag = GF_ODF_ISOM_IPI_PTR_TAG;</span>
<span class="lineNum">    1451 </span>            :                 } else {
<span class="lineNum">    1452 </span>            :                         //Watch out! ONLY ONE IPI dependency is allowed per stream
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :                         if (dpnd-&gt;trackIDCount != 1) return GF_ISOM_INVALID_MEDIA;</span>
<span class="lineNum">    1454 </span>            :                         //if an existing one is there, what shall we do ???
<span class="lineNum">    1455 </span>            :                         //donno, erase it
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :                         dpnd-&gt;trackIDs[0] = esd-&gt;ipiPtr-&gt;IPI_ES_Id;</span>
<span class="lineNum">    1457 </span>            :                         //and replace the tag and value...
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :                         esd-&gt;ipiPtr-&gt;IPI_ES_Id = 1;</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :                         esd-&gt;ipiPtr-&gt;tag = GF_ODF_ISOM_IPI_PTR_TAG;</span>
<span class="lineNum">    1460 </span>            :                 }
<span class="lineNum">    1461 </span>            :         }
<span class="lineNum">    1462 </span>            : 
<span class="lineNum">    1463 </span>            :         /*don't store the lang desc in ESD, use the media header language info*/
<span class="lineNum">    1464 </span><span class="lineCov">        611 :         if (esd-&gt;langDesc) {</span>
<span class="lineNum">    1465 </span><span class="lineCov">          2 :                 trak-&gt;Media-&gt;mediaHeader-&gt;packedLanguage[0] = (esd-&gt;langDesc-&gt;langCode&gt;&gt;16)&amp;0xFF;</span>
<span class="lineNum">    1466 </span><span class="lineCov">          2 :                 trak-&gt;Media-&gt;mediaHeader-&gt;packedLanguage[1] = (esd-&gt;langDesc-&gt;langCode&gt;&gt;8)&amp;0xFF;</span>
<span class="lineNum">    1467 </span><span class="lineCov">          2 :                 trak-&gt;Media-&gt;mediaHeader-&gt;packedLanguage[2] = (esd-&gt;langDesc-&gt;langCode)&amp;0xFF;</span>
<span class="lineNum">    1468 </span><span class="lineCov">          2 :                 gf_odf_desc_del((GF_Descriptor *)esd-&gt;langDesc);</span>
<span class="lineNum">    1469 </span><span class="lineCov">          2 :                 esd-&gt;langDesc = NULL;</span>
<span class="lineNum">    1470 </span>            :         }
<span class="lineNum">    1471 </span>            : 
<span class="lineNum">    1472 </span>            :         //we have a streamDescriptionIndex, use it
<span class="lineNum">    1473 </span><span class="lineCov">        611 :         if (StreamDescriptionIndex) {</span>
<span class="lineNum">    1474 </span>            :                 u32 entry_type;
<span class="lineNum">    1475 </span><span class="lineCov">        116 :                 entry = (GF_MPEGSampleEntryBox*)gf_list_get(trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleDescription-&gt;child_boxes, StreamDescriptionIndex - 1);</span>
<span class="lineNum">    1476 </span><span class="lineCov">        116 :                 if (!entry) return GF_ISOM_INVALID_FILE;</span>
<span class="lineNum">    1477 </span>            : 
<span class="lineNum">    1478 </span><span class="lineCov">        116 :                 entry_type = entry-&gt;type;</span>
<span class="lineNum">    1479 </span><span class="lineCov">        116 :                 GF_ProtectionSchemeInfoBox *sinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(entry-&gt;child_boxes, GF_ISOM_BOX_TYPE_SINF);</span>
<span class="lineNum">    1480 </span><span class="lineCov">        116 :                 if (sinf &amp;&amp; sinf-&gt;original_format) entry_type = sinf-&gt;original_format-&gt;data_format;</span>
<span class="lineNum">    1481 </span>            :                 
<span class="lineNum">    1482 </span><span class="lineCov">        116 :                 switch (entry_type) {</span>
<span class="lineNum">    1483 </span><span class="lineCov">         73 :                 case GF_ISOM_BOX_TYPE_MP4S:</span>
<span class="lineNum">    1484 </span>            :                         //OK, delete the previous ESD
<span class="lineNum">    1485 </span><span class="lineCov">         73 :                         gf_odf_desc_del((GF_Descriptor *) entry-&gt;esd-&gt;desc);</span>
<span class="lineNum">    1486 </span><span class="lineCov">         73 :                         entry-&gt;esd-&gt;desc = esd;</span>
<span class="lineNum">    1487 </span><span class="lineCov">         73 :                         break;</span>
<span class="lineNum">    1488 </span><span class="lineCov">          5 :                 case GF_ISOM_BOX_TYPE_MP4V:</span>
<span class="lineNum">    1489 </span>            :                         entry_v = (GF_MPEGVisualSampleEntryBox*) entry;
<span class="lineNum">    1490 </span>            :                         //OK, delete the previous ESD
<span class="lineNum">    1491 </span><span class="lineCov">          5 :                         gf_odf_desc_del((GF_Descriptor *) entry_v-&gt;esd-&gt;desc);</span>
<span class="lineNum">    1492 </span><span class="lineCov">          5 :                         entry_v-&gt;esd-&gt;desc = esd;</span>
<span class="lineNum">    1493 </span><span class="lineCov">          5 :                         break;</span>
<span class="lineNum">    1494 </span><span class="lineCov">         10 :                 case GF_ISOM_BOX_TYPE_MP4A:</span>
<span class="lineNum">    1495 </span>            :                         entry_a = (GF_MPEGAudioSampleEntryBox*) entry;
<span class="lineNum">    1496 </span><span class="lineCov">         10 :             if (entry_a-&gt;esd) { // some non-conformant files may not have an ESD ...</span>
<span class="lineNum">    1497 </span>            :                 //OK, delete the previous ESD
<span class="lineNum">    1498 </span><span class="lineCov">         10 :                 gf_odf_desc_del((GF_Descriptor *) entry_a-&gt;esd-&gt;desc);</span>
<span class="lineNum">    1499 </span><span class="lineCov">         10 :                 entry_a-&gt;esd-&gt;desc = esd;</span>
<span class="lineNum">    1500 </span>            :             } else {
<span class="lineNum">    1501 </span>            :                                 // can't return OK here otherwise we can't know if esd hasn't been used
<span class="lineNum">    1502 </span>            :                                 // and need to be freed
<span class="lineNum">    1503 </span>            :                                 return GF_ISOM_INVALID_MEDIA;
<span class="lineNum">    1504 </span>            :                         }
<span class="lineNum">    1505 </span><span class="lineCov">         10 :                         break;</span>
<span class="lineNum">    1506 </span><span class="lineCov">         26 :                 case GF_ISOM_BOX_TYPE_AVC1:</span>
<span class="lineNum">    1507 </span>            :                 case GF_ISOM_BOX_TYPE_AVC2:
<span class="lineNum">    1508 </span>            :                 case GF_ISOM_BOX_TYPE_AVC3:
<span class="lineNum">    1509 </span>            :                 case GF_ISOM_BOX_TYPE_AVC4:
<span class="lineNum">    1510 </span>            :                 case GF_ISOM_BOX_TYPE_SVC1:
<span class="lineNum">    1511 </span>            :                 case GF_ISOM_BOX_TYPE_MVC1:
<span class="lineNum">    1512 </span>            :                 case GF_ISOM_BOX_TYPE_HVC1:
<span class="lineNum">    1513 </span>            :                 case GF_ISOM_BOX_TYPE_HEV1:
<span class="lineNum">    1514 </span>            :                 case GF_ISOM_BOX_TYPE_HVC2:
<span class="lineNum">    1515 </span>            :                 case GF_ISOM_BOX_TYPE_HEV2:
<span class="lineNum">    1516 </span>            :                 case GF_ISOM_BOX_TYPE_LHE1:
<span class="lineNum">    1517 </span>            :                 case GF_ISOM_BOX_TYPE_LHV1:
<span class="lineNum">    1518 </span>            :                 case GF_ISOM_BOX_TYPE_HVT1:
<span class="lineNum">    1519 </span>            :                 case GF_ISOM_BOX_TYPE_VVC1:
<span class="lineNum">    1520 </span>            :                 case GF_ISOM_BOX_TYPE_VVI1:
<span class="lineNum">    1521 </span><span class="lineCov">         26 :                         e = AVC_HEVC_UpdateESD((GF_MPEGVisualSampleEntryBox*)entry, esd);</span>
<span class="lineNum">    1522 </span><span class="lineCov">         26 :                         if (e) return e;</span>
<span class="lineNum">    1523 </span>            :                         break;
<span class="lineNum">    1524 </span><span class="lineCov">          2 :                 case GF_ISOM_BOX_TYPE_LSR1:</span>
<span class="lineNum">    1525 </span><span class="lineCov">          2 :                         e = LSR_UpdateESD((GF_LASeRSampleEntryBox*)entry, esd);</span>
<span class="lineNum">    1526 </span><span class="lineCov">          2 :                         if (e) return e;</span>
<span class="lineNum">    1527 </span>            :                         break;
<span class="lineNum">    1528 </span>            :                 case GF_ISOM_BOX_TYPE_AV01:
<span class="lineNum">    1529 </span>            :                 case GF_ISOM_BOX_TYPE_AV1C:
<span class="lineNum">    1530 </span>            :                 case GF_ISOM_BOX_TYPE_OPUS:
<span class="lineNum">    1531 </span>            :                 case GF_ISOM_BOX_TYPE_DOPS:
<span class="lineNum">    1532 </span>            :                 case GF_ISOM_BOX_TYPE_STXT:
<span class="lineNum">    1533 </span>            :                 case GF_ISOM_BOX_TYPE_WVTT:
<span class="lineNum">    1534 </span>            :                 case GF_ISOM_BOX_TYPE_STPP:
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :                         if (esd) gf_odf_desc_del((GF_Descriptor *) esd);</span>
<span class="lineNum">    1536 </span>            :                         break;
<span class="lineNum">    1537 </span>            : 
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :                 default:</span>
<span class="lineNum">    1539 </span>            :                         //silently fail, not an MPEG-4 esd
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :                         gf_odf_desc_del((GF_Descriptor *) esd);</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :                         return GF_OK;</span>
<span class="lineNum">    1542 </span>            :                 }
<span class="lineNum">    1543 </span>            :         } else {
<span class="lineNum">    1544 </span>            :                 //need to check we're not in URL mode where only ONE description is allowed...
<span class="lineNum">    1545 </span><span class="lineCov">        495 :                 StreamDescriptionIndex = gf_list_count(trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleDescription-&gt;child_boxes);</span>
<span class="lineNum">    1546 </span><span class="lineCov">        495 :                 if (StreamDescriptionIndex) {</span>
<span class="lineNum">    1547 </span><span class="lineNoCov">          0 :                         GF_ESD *old_esd=NULL;</span>
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :                         entry = (GF_MPEGSampleEntryBox*)gf_list_get(trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleDescription-&gt;child_boxes, StreamDescriptionIndex - 1);</span>
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :                         if (!entry) return GF_ISOM_INVALID_FILE;</span>
<span class="lineNum">    1550 </span>            :                         //get ESD (only if present, do not emulate)
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :                         Media_GetESD(trak-&gt;Media, StreamDescriptionIndex, &amp;old_esd, GF_TRUE);</span>
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :                         if (old_esd &amp;&amp; old_esd-&gt;URLString) return GF_BAD_PARAM;</span>
<span class="lineNum">    1553 </span>            :                 }
<span class="lineNum">    1554 </span>            : 
<span class="lineNum">    1555 </span>            :                 //OK, check the handler and create the entry
<span class="lineNum">    1556 </span><span class="lineCov">        495 :                 switch (trak-&gt;Media-&gt;handler-&gt;handlerType) {</span>
<span class="lineNum">    1557 </span><span class="lineCov">        154 :         case GF_ISOM_MEDIA_AUXV:</span>
<span class="lineNum">    1558 </span>            :         case GF_ISOM_MEDIA_PICT:
<span class="lineNum">    1559 </span>            :                 case GF_ISOM_MEDIA_VISUAL:
<span class="lineNum">    1560 </span><span class="lineCov">        154 :                         if ((esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_AVC) || (esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_SVC) || (esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_MVC)) {</span>
<span class="lineNum">    1561 </span><span class="lineCov">          4 :                                 entry_v = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AVC1);</span>
<span class="lineNum">    1562 </span><span class="lineCov">          4 :                                 if (!entry_v) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1563 </span><span class="lineCov">          4 :                                 e = AVC_HEVC_UpdateESD((GF_MPEGVisualSampleEntryBox*)entry_v, esd);</span>
<span class="lineNum">    1564 </span><span class="lineCov">          4 :                                 if (e) return  e;</span>
<span class="lineNum">    1565 </span><span class="lineCov">        150 :                         } else if (esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_HEVC) {</span>
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :                                 entry_v = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_HVC1);</span>
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :                                 if (!entry_v) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :                                 e = AVC_HEVC_UpdateESD((GF_MPEGVisualSampleEntryBox*)entry_v, esd);</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :                                 if (e) return  e;</span>
<span class="lineNum">    1570 </span><span class="lineCov">        150 :                         } else if (esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_VVC) {</span>
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :                                 entry_v = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_VVC1);</span>
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 :                                 if (!entry_v) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :                                 e = AVC_HEVC_UpdateESD((GF_MPEGVisualSampleEntryBox*)entry_v, esd);</span>
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :                                 if (e) return  e;</span>
<span class="lineNum">    1575 </span>            :                         } else {
<span class="lineNum">    1576 </span><span class="lineCov">        150 :                                 entry_v = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_MP4V);</span>
<span class="lineNum">    1577 </span><span class="lineCov">        150 :                                 if (!entry_v) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1578 </span><span class="lineCov">        150 :                                 entry_v-&gt;esd = (GF_ESDBox *) gf_isom_box_new_parent(&amp;entry_v-&gt;child_boxes, GF_ISOM_BOX_TYPE_ESDS);</span>
<span class="lineNum">    1579 </span><span class="lineCov">        150 :                                 if (!entry_v-&gt;esd) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1580 </span><span class="lineCov">        150 :                                 entry_v-&gt;esd-&gt;desc = esd;</span>
<span class="lineNum">    1581 </span>            :                         }
<span class="lineNum">    1582 </span>            : 
<span class="lineNum">    1583 </span>            :                         //type cast possible now
<span class="lineNum">    1584 </span>            :                         entry = (GF_MPEGSampleEntryBox*) entry_v;
<span class="lineNum">    1585 </span>            :                         break;
<span class="lineNum">    1586 </span><span class="lineCov">        218 :                 case GF_ISOM_MEDIA_AUDIO:</span>
<span class="lineNum">    1587 </span><span class="lineCov">        218 :                         if (esd-&gt;decoderConfig-&gt;objectTypeIndication == GF_CODECID_OPUS) {</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :                                 GF_MPEGAudioSampleEntryBox *opus = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new(GF_ISOM_BOX_TYPE_OPUS);</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :                                 if (!opus) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :                                 opus-&gt;cfg_opus = (GF_OpusSpecificBox *)gf_isom_box_new_parent(&amp;opus-&gt;child_boxes, GF_ISOM_BOX_TYPE_DOPS);</span>
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :                                 if (!opus-&gt;cfg_opus) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1592 </span>            :                                 entry = (GF_MPEGSampleEntryBox*)opus;
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :                                 gf_odf_desc_del((GF_Descriptor *) esd);</span>
<span class="lineNum">    1594 </span><span class="lineCov">        218 :                         } else if (esd-&gt;decoderConfig-&gt;objectTypeIndication == GF_CODECID_AC3) {</span>
<span class="lineNum">    1595 </span><span class="lineNoCov">          0 :                                 GF_MPEGAudioSampleEntryBox *ac3 = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);</span>
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :                                 if (!ac3) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :                                 ac3-&gt;cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&amp;ac3-&gt;child_boxes, GF_ISOM_BOX_TYPE_DAC3);</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :                                 if (!ac3-&gt;cfg_ac3) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1599 </span>            :                                 entry = (GF_MPEGSampleEntryBox*) ac3;
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :                                 gf_odf_desc_del((GF_Descriptor *) esd);</span>
<span class="lineNum">    1601 </span><span class="lineCov">        218 :                         } else if (esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_EAC3) {</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :                                 GF_MPEGAudioSampleEntryBox *eac3 = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :                                 if (!eac3) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 :                                 eac3-&gt;cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&amp;eac3-&gt;child_boxes, GF_ISOM_BOX_TYPE_DEC3);</span>
<span class="lineNum">    1605 </span><span class="lineNoCov">          0 :                                 if (!eac3-&gt;cfg_ac3) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1606 </span>            :                                 entry = (GF_MPEGSampleEntryBox*) eac3;
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :                                 gf_odf_desc_del((GF_Descriptor *) esd);</span>
<span class="lineNum">    1608 </span>            :                         } else {
<span class="lineNum">    1609 </span><span class="lineCov">        218 :                                 entry_a = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_MP4A);</span>
<span class="lineNum">    1610 </span><span class="lineCov">        218 :                                 if (!entry_a) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1611 </span><span class="lineCov">        218 :                                 entry_a-&gt;samplerate_hi = trak-&gt;Media-&gt;mediaHeader-&gt;timeScale;</span>
<span class="lineNum">    1612 </span><span class="lineCov">        218 :                                 entry_a-&gt;esd = (GF_ESDBox *) gf_isom_box_new_parent(&amp;entry_a-&gt;child_boxes, GF_ISOM_BOX_TYPE_ESDS);</span>
<span class="lineNum">    1613 </span><span class="lineCov">        218 :                                 if (!entry_a-&gt;esd) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1614 </span><span class="lineCov">        218 :                                 entry_a-&gt;esd-&gt;desc = esd;</span>
<span class="lineNum">    1615 </span>            :                                 //type cast possible now
<span class="lineNum">    1616 </span>            :                                 entry = (GF_MPEGSampleEntryBox*) entry_a;
<span class="lineNum">    1617 </span>            :                         }
<span class="lineNum">    1618 </span>            :                         break;
<span class="lineNum">    1619 </span><span class="lineCov">        123 :                 default:</span>
<span class="lineNum">    1620 </span><span class="lineCov">        123 :                         if ((esd-&gt;decoderConfig-&gt;streamType==0x03) &amp;&amp; (esd-&gt;decoderConfig-&gt;objectTypeIndication==0x09)) {</span>
<span class="lineNum">    1621 </span><span class="lineCov">          3 :                                 entry = (GF_MPEGSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_LSR1);</span>
<span class="lineNum">    1622 </span><span class="lineCov">          3 :                                 if (!entry) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1623 </span><span class="lineCov">          3 :                                 e = LSR_UpdateESD((GF_LASeRSampleEntryBox*)entry, esd);</span>
<span class="lineNum">    1624 </span><span class="lineCov">          3 :                                 if (e) return  e;</span>
<span class="lineNum">    1625 </span>            :                         } else {
<span class="lineNum">    1626 </span><span class="lineCov">        120 :                                 entry = (GF_MPEGSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_MP4S);</span>
<span class="lineNum">    1627 </span><span class="lineCov">        120 :                                 entry-&gt;esd = (GF_ESDBox *) gf_isom_box_new_parent(&amp;entry-&gt;child_boxes, GF_ISOM_BOX_TYPE_ESDS);</span>
<span class="lineNum">    1628 </span><span class="lineCov">        120 :                                 if (!entry-&gt;esd) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1629 </span><span class="lineCov">        120 :                                 entry-&gt;esd-&gt;desc = esd;</span>
<span class="lineNum">    1630 </span>            :                         }
<span class="lineNum">    1631 </span>            :                         break;
<span class="lineNum">    1632 </span>            :                 }
<span class="lineNum">    1633 </span><span class="lineCov">        495 :                 entry-&gt;dataReferenceIndex = DataReferenceIndex;</span>
<span class="lineNum">    1634 </span>            : 
<span class="lineNum">    1635 </span><span class="lineCov">        495 :                 if (!trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleDescription-&gt;child_boxes)</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :                         trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleDescription-&gt;child_boxes = gf_list_new();</span>
<span class="lineNum">    1637 </span><span class="lineCov">        495 :                 gf_list_add(trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleDescription-&gt;child_boxes, entry);</span>
<span class="lineNum">    1638 </span>            :                 
<span class="lineNum">    1639 </span><span class="lineCov">        495 :                 e = stsd_on_child_box((GF_Box*)trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleDescription, (GF_Box *) entry, GF_FALSE);</span>
<span class="lineNum">    1640 </span><span class="lineCov">        495 :                 if (e) return e;</span>
<span class="lineNum">    1641 </span><span class="lineCov">        495 :                 if(outStreamIndex) *outStreamIndex = gf_list_count(trak-&gt;Media-&gt;information-&gt;sampleTable-&gt;SampleDescription-&gt;child_boxes);</span>
<span class="lineNum">    1642 </span>            :         }
<span class="lineNum">    1643 </span>            :         return GF_OK;
<span class="lineNum">    1644 </span>            : }
<span class="lineNum">    1645 </span>            : 
<span class="lineNum">    1646 </span>            : #endif  /*GPAC_DISABLE_ISOM_WRITE*/
<span class="lineNum">    1647 </span>            : 
<span class="lineNum">    1648 </span>            : #endif /*GPAC_DISABLE_ISOM*/
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

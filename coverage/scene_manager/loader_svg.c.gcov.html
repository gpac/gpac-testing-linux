<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - scene_manager/loader_svg.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">scene_manager</a> - loader_svg.c<span style="font-size: 80%;"> (source / <a href="loader_svg.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">730</td>
            <td class="headerCovTableEntry">1092</td>
            <td class="headerCovTableEntryLo">66.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">28</td>
            <td class="headerCovTableEntry">31</td>
            <td class="headerCovTableEntryHi">90.3 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre, Cyril Concolato
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2000-2012
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / Scene Management sub-project
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/scene_manager.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;gpac/utf.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;gpac/xml.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;gpac/events.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;gpac/internal/compositor_dev.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;gpac/internal/scenegraph_dev.h&gt;
<span class="lineNum">      33 </span>            : #include &lt;gpac/internal/laser_dev.h&gt;
<span class="lineNum">      34 </span>            : #include &lt;gpac/nodes_svg.h&gt;
<span class="lineNum">      35 </span>            : #include &lt;gpac/base_coding.h&gt;
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : typedef struct _st_entry
<span class="lineNum">      40 </span>            : {
<span class="lineNum">      41 </span>            :         struct _st_entry *next;
<span class="lineNum">      42 </span>            :         /*as referred to by xlink-href*/
<span class="lineNum">      43 </span>            :         char *stream_name;
<span class="lineNum">      44 </span>            :         /*stream id*/
<span class="lineNum">      45 </span>            :         u32 id;
<span class="lineNum">      46 </span>            :         const char *nhml_info;
<span class="lineNum">      47 </span>            : } SVG_SAFExternalStream;
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span>            : typedef struct
<span class="lineNum">      50 </span>            : {
<span class="lineNum">      51 </span>            :         GF_SceneLoader *load;
<span class="lineNum">      52 </span>            :         GF_Err last_error;
<span class="lineNum">      53 </span>            :         GF_SAXParser *sax_parser;
<span class="lineNum">      54 </span>            :         u32 has_root;
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            :         /* stack of SVG nodes*/
<span class="lineNum">      57 </span>            :         GF_List *node_stack;
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            :         GF_List *deferred_hrefs;
<span class="lineNum">      60 </span>            :         GF_List *deferred_animations;
<span class="lineNum">      61 </span>            :         GF_List *deferred_listeners;
<span class="lineNum">      62 </span>            :         /*non-linear parsing*/
<span class="lineNum">      63 </span>            :         GF_List *peeked_nodes;
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span>            :         /*LASeR parsing*/
<span class="lineNum">      66 </span>            :         u32 command_depth;
<span class="lineNum">      67 </span>            :         GF_StreamContext *laser_es;
<span class="lineNum">      68 </span>            :         GF_AUContext *laser_au;
<span class="lineNum">      69 </span>            :         GF_Command *command;
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            :         /*SAF AU maps to OD AU and is used for each new media declaration*/
<span class="lineNum">      72 </span>            :         GF_AUContext *saf_au;
<span class="lineNum">      73 </span>            :         GF_StreamContext *saf_es;
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span>            :         SVG_SAFExternalStream *streams;
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            :         /*the namespace of the parent element. This is a shortcut to avoid querying the namespace list stored
<span class="lineNum">      78 </span>            :         in the scene graph to find out the namespace of the current element.
<span class="lineNum">      79 </span>            :         For example in &lt;foo:bar&gt;&lt;foo:test/&gt;&lt;/foo:bar&gt;, it avoids looking for the namespace when parsing &lt;foo:test&gt;
<span class="lineNum">      80 </span>            :         */
<span class="lineNum">      81 </span>            :         u32 current_ns;
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            :         /*if parser is used to parse a fragment, the root of the fragment is stored here*/
<span class="lineNum">      84 </span>            :         GF_Node *fragment_root;
<span class="lineNum">      85 </span>            : } GF_SVG_Parser;
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span>            : typedef struct {
<span class="lineNum">      88 </span>            :         /* Stage of the resolving:
<span class="lineNum">      89 </span>            :             0: resolving attributes which depends on the target: from, to, by, values, type
<span class="lineNum">      90 </span>            :                 1: resolving begin times
<span class="lineNum">      91 </span>            :                 2: resolving end times */
<span class="lineNum">      92 </span>            :         u32 resolve_stage;
<span class="lineNum">      93 </span>            :         /* Animation element being deferred */
<span class="lineNum">      94 </span>            :         SVG_Element *animation_elt;
<span class="lineNum">      95 </span>            :         /* anim parent*/
<span class="lineNum">      96 </span>            :         SVG_Element *anim_parent;
<span class="lineNum">      97 </span>            :         /* target animated element*/
<span class="lineNum">      98 </span>            :         SVG_Element *target;
<span class="lineNum">      99 </span>            :         /* id of the target element when unresolved*/
<span class="lineNum">     100 </span>            :         char *target_id;
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span>            :         /* attributes which cannot be parsed until the type of the target attribute is known */
<span class="lineNum">     103 </span>            :         char *type; /* only for animateTransform */
<span class="lineNum">     104 </span>            :         char *to;
<span class="lineNum">     105 </span>            :         char *from;
<span class="lineNum">     106 </span>            :         char *by;
<span class="lineNum">     107 </span>            :         char *values;
<span class="lineNum">     108 </span>            : } SVG_DeferredAnimation;
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span>            : typedef struct
<span class="lineNum">     111 </span>            : {
<span class="lineNum">     112 </span>            :         /*top of parsed sub-tree*/
<span class="lineNum">     113 </span>            :         SVG_Element *node;
<span class="lineNum">     114 </span>            :         /*the current element is animation that cannot be parsed completely
<span class="lineNum">     115 </span>            :           upon reception of start tag of element but for which we may be able
<span class="lineNum">     116 </span>            :           to parse at the end tag of the element (animateMotion)*/
<span class="lineNum">     117 </span>            :         SVG_DeferredAnimation *anim;
<span class="lineNum">     118 </span>            :         /*depth of unknown elements being skipped*/
<span class="lineNum">     119 </span>            :         u32 unknown_depth;
<span class="lineNum">     120 </span>            :         /*last child added, used to speed-up parsing*/
<span class="lineNum">     121 </span>            :         GF_ChildNodeItem *last_child;
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span>            :         /*the namespace of the parent element (used for restoring the context after the current node has been parsed)*/
<span class="lineNum">     124 </span>            :         u32 current_ns;
<span class="lineNum">     125 </span>            :         Bool has_ns;
<a name="126"><span class="lineNum">     126 </span>            : } SVG_NodeStack;</a>
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineCov">         74 : static GF_Err svg_report(GF_SVG_Parser *parser, GF_Err e, char *format, ...)</span>
<span class="lineNum">     129 </span>            : {
<span class="lineNum">     130 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">     131 </span><span class="lineCov">         74 :         if (format &amp;&amp; gf_log_tool_level_on(GF_LOG_PARSER, e ? GF_LOG_ERROR : GF_LOG_WARNING)) {</span>
<span class="lineNum">     132 </span>            :                 char szMsg[2048];
<span class="lineNum">     133 </span>            :                 va_list args;
<span class="lineNum">     134 </span><span class="lineCov">          5 :                 va_start(args, format);</span>
<span class="lineNum">     135 </span>            :                 vsnprintf(szMsg, 2048, format, args);
<span class="lineNum">     136 </span><span class="lineCov">          5 :                 va_end(args);</span>
<span class="lineNum">     137 </span><span class="lineCov">          5 :                 GF_LOG((u32) (e ? GF_LOG_ERROR : GF_LOG_WARNING), GF_LOG_PARSER, (&quot;[SVG Parsing] line %d - %s\n&quot;, gf_xml_sax_get_line(parser-&gt;sax_parser), szMsg));</span>
<span class="lineNum">     138 </span>            :         }
<span class="lineNum">     139 </span>            : #endif
<span class="lineNum">     140 </span><span class="lineCov">         74 :         if (e) {</span>
<span class="lineNum">     141 </span><span class="lineCov">          1 :                 parser-&gt;last_error = e;</span>
<span class="lineNum">     142 </span><span class="lineCov">          1 :                 gf_xml_sax_suspend(parser-&gt;sax_parser, GF_TRUE);</span>
<span class="lineNum">     143 </span>            :         }
<span class="lineNum">     144 </span><span class="lineCov">         74 :         return e;</span>
<a name="145"><span class="lineNum">     145 </span>            : }</a>
<span class="lineNum">     146 </span>            : 
<span class="lineNum">     147 </span><span class="lineCov">        233 : static void svg_progress(void *cbk, u64 done, u64 total)</span>
<span class="lineNum">     148 </span>            : {
<span class="lineNum">     149 </span>            :         GF_SVG_Parser *parser = (GF_SVG_Parser *)cbk;
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span>            :         /*notify MediaEvent*/
<span class="lineNum">     152 </span><span class="lineCov">        233 :         if (parser-&gt;load &amp;&amp; parser-&gt;load-&gt;is) {</span>
<span class="lineNum">     153 </span><span class="lineCov">        155 :                 parser-&gt;load-&gt;is-&gt;on_media_event(parser-&gt;load-&gt;is, GF_EVENT_MEDIA_PROGRESS);</span>
<span class="lineNum">     154 </span><span class="lineCov">        155 :                 if (done == total) {</span>
<span class="lineNum">     155 </span><span class="lineCov">         47 :                         parser-&gt;load-&gt;is-&gt;on_media_event(parser-&gt;load-&gt;is, GF_EVENT_MEDIA_LOAD_DONE);</span>
<span class="lineNum">     156 </span>            :                 }
<span class="lineNum">     157 </span>            :         }
<span class="lineNum">     158 </span><span class="lineCov">        233 :         gf_set_progress(&quot;SVG (Dynamic Attribute List) Parsing&quot;, done, total);</span>
<a name="159"><span class="lineNum">     159 </span><span class="lineCov">        233 : }</span></a>
<span class="lineNum">     160 </span>            : 
<span class="lineNum">     161 </span><span class="lineCov">         14 : static SVG_SAFExternalStream *svg_saf_get_stream(GF_SVG_Parser *parser, u32 id, const char *name)</span>
<span class="lineNum">     162 </span>            : {
<span class="lineNum">     163 </span>            :         SVG_SAFExternalStream *st;
<span class="lineNum">     164 </span><span class="lineCov">         14 :         st = parser-&gt;streams;</span>
<span class="lineNum">     165 </span><span class="lineCov">         16 :         while (st) {</span>
<span class="lineNum">     166 </span><span class="lineCov">          4 :                 if (id == st-&gt;id) return st;</span>
<span class="lineNum">     167 </span><span class="lineCov">          4 :                 if (name &amp;&amp; st-&gt;stream_name &amp;&amp; !strcmp(name, st-&gt;stream_name) ) return st;</span>
<span class="lineNum">     168 </span><span class="lineCov">          2 :                 st = st-&gt;next;</span>
<span class="lineNum">     169 </span>            :         }
<span class="lineNum">     170 </span>            :         return NULL;
<a name="171"><span class="lineNum">     171 </span>            : }</a>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span><span class="lineCov">          2 : static SVG_SAFExternalStream *svg_saf_get_next_available_stream(GF_SVG_Parser *parser)</span>
<span class="lineNum">     174 </span>            : {
<span class="lineNum">     175 </span>            :         /*1 reserved for base laser stream*/
<span class="lineNum">     176 </span>            :         u32 id = 1;
<span class="lineNum">     177 </span><span class="lineCov">          2 :         SVG_SAFExternalStream *st = parser-&gt;streams;</span>
<span class="lineNum">     178 </span>            :         SVG_SAFExternalStream *prev = NULL;
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span><span class="lineCov">          2 :         while (st) {</span>
<span class="lineNum">     181 </span>            :                 prev = st;
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :                 id = st-&gt;id;</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :                 st = st-&gt;next;</span>
<span class="lineNum">     184 </span>            :         }
<span class="lineNum">     185 </span><span class="lineCov">          2 :         GF_SAFEALLOC(st, SVG_SAFExternalStream);</span>
<span class="lineNum">     186 </span><span class="lineCov">          2 :         if (!st) return NULL;</span>
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span><span class="lineCov">          2 :         if (prev) prev-&gt;next = st;</span>
<span class="lineNum">     189 </span><span class="lineCov">          2 :         else parser-&gt;streams = st;</span>
<span class="lineNum">     190 </span><span class="lineCov">          2 :         st-&gt;id = id+1;</span>
<span class="lineNum">     191 </span>            :         return st;
<a name="192"><span class="lineNum">     192 </span>            : }</a>
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span><span class="lineCov">         14 : static void svg_lsr_set_v2(GF_SVG_Parser *parser)</span>
<span class="lineNum">     195 </span>            : {
<span class="lineNum">     196 </span>            :         u32 i;
<span class="lineNum">     197 </span><span class="lineCov">         14 :         if (parser-&gt;load-&gt;ctx &amp;&amp; parser-&gt;load-&gt;ctx-&gt;root_od) {</span>
<span class="lineNum">     198 </span><span class="lineCov">         28 :                 for (i=0; i&lt;gf_list_count(parser-&gt;load-&gt;ctx-&gt;root_od-&gt;ESDescriptors); i++) {</span>
<span class="lineNum">     199 </span><span class="lineCov">         28 :                         GF_ESD *esd = (GF_ESD *)gf_list_get(parser-&gt;load-&gt;ctx-&gt;root_od-&gt;ESDescriptors, i);</span>
<span class="lineNum">     200 </span><span class="lineCov">         28 :                         if (esd-&gt;decoderConfig-&gt;streamType==GF_STREAM_SCENE) {</span>
<span class="lineNum">     201 </span><span class="lineCov">         14 :                                 GF_LASERConfig *cfg = (GF_LASERConfig *)esd-&gt;decoderConfig-&gt;decoderSpecificInfo;</span>
<span class="lineNum">     202 </span><span class="lineCov">         14 :                                 if (cfg &amp;&amp; (cfg-&gt;tag==GF_ODF_LASER_CFG_TAG)) {</span>
<span class="lineNum">     203 </span><span class="lineCov">         14 :                                         if (!cfg-&gt;extensionIDBits) cfg-&gt;extensionIDBits = 2;</span>
<span class="lineNum">     204 </span>            :                                 }
<span class="lineNum">     205 </span>            :                         }
<span class="lineNum">     206 </span>            :                 }
<span class="lineNum">     207 </span>            :         }
<span class="lineNum">     208 </span><span class="lineCov">         14 : }</span>
<a name="209"><span class="lineNum">     209 </span>            : </a>
<span class="lineNum">     210 </span>            : 
<span class="lineNum">     211 </span><span class="lineCov">        115 : static void svg_process_media_href(GF_SVG_Parser *parser, GF_Node *elt, XMLRI *iri)</span>
<span class="lineNum">     212 </span>            : {
<span class="lineNum">     213 </span><span class="lineCov">        115 :         u32 tag = gf_node_get_tag(elt);</span>
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span><span class="lineCov">        115 :         if ((tag==TAG_SVG_image) || (tag==TAG_SVG_video) || (tag==TAG_SVG_audio)) {</span>
<span class="lineNum">     216 </span><span class="lineCov">         12 :                 SVG_SAFExternalStream *st = svg_saf_get_stream(parser, 0, iri-&gt;string+1);</span>
<span class="lineNum">     217 </span><span class="lineCov">         12 :                 if (!st &amp;&amp; !strnicmp(iri-&gt;string, &quot;stream:&quot;, 7))</span>
<span class="lineNum">     218 </span><span class="lineCov">          2 :                         st = svg_saf_get_stream(parser, 0, iri-&gt;string+7);</span>
<span class="lineNum">     219 </span><span class="lineCov">         12 :                 if (st) {</span>
<span class="lineNum">     220 </span><span class="lineCov">          2 :                         gf_free(iri-&gt;string);</span>
<span class="lineNum">     221 </span><span class="lineCov">          2 :                         iri-&gt;string = NULL;</span>
<span class="lineNum">     222 </span><span class="lineCov">          2 :                         iri-&gt;lsr_stream_id = st-&gt;id;</span>
<span class="lineNum">     223 </span><span class="lineCov">          2 :                         iri-&gt;type = XMLRI_STREAMID;</span>
<span class="lineNum">     224 </span><span class="lineCov">          2 :                         return;</span>
<span class="lineNum">     225 </span>            :                 }
<span class="lineNum">     226 </span>            :         }
<span class="lineNum">     227 </span><span class="lineCov">        113 :         if ((parser-&gt;load-&gt;flags &amp; GF_SM_LOAD_EMBEDS_RES) &amp;&amp; (iri-&gt;type==XMLRI_STRING) ) {</span>
<span class="lineNum">     228 </span>            :                 u32 size;
<span class="lineNum">     229 </span>            :                 char *buffer;
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :                 GF_Err e = gf_file_load_data(iri-&gt;string, (u8 **) &amp;buffer, &amp;size);</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :                 if (e) return;</span>
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :                 if (tag==TAG_SVG_script) {</span>
<span class="lineNum">     235 </span>            :                         GF_DOMText *dtext;
<span class="lineNum">     236 </span>            :                         GF_DOMAttribute *att, *prev;
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :                         buffer[size]=0;</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :                         dtext = gf_dom_add_text_node(elt, buffer);</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :                         dtext-&gt;type = GF_DOM_TEXT_CDATA;</span>
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :                         gf_free(iri-&gt;string);</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :                         iri-&gt;string=NULL;</span>
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span>            :                         /*delete attribute*/
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :                         att = ((GF_DOMNode*)elt)-&gt;attributes;</span>
<span class="lineNum">     246 </span>            :                         prev = NULL;
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :                         while(att) {</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :                                 if (att-&gt;tag!=TAG_XLINK_ATT_href) {</span>
<span class="lineNum">     249 </span>            :                                         prev = att;
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :                                         att = att-&gt;next;</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">     252 </span>            :                                 }
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :                                 gf_svg_delete_attribute_value(att-&gt;data_type, att-&gt;data, elt-&gt;sgprivate-&gt;scenegraph);</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :                                 if (prev) prev-&gt;next = att-&gt;next;</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :                                 else ((GF_DOMNode*)elt)-&gt;attributes = att-&gt;next;</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :                                 gf_free(att);</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     258 </span>            :                         }
<span class="lineNum">     259 </span>            :                 } else {
<span class="lineNum">     260 </span>            :                         char *mtype;
<span class="lineNum">     261 </span>            :                         char *buf64;
<span class="lineNum">     262 </span>            :                         u64 size64;
<span class="lineNum">     263 </span>            :                         char *ext;
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :                         buf64 = (char *)gf_malloc((size_t)size*2);</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :                         size64 = gf_base64_encode(buffer, (u32)size, buf64, (u32)size*2);</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :                         buf64[size64] = 0;</span>
<span class="lineNum">     267 </span>            :                         mtype = &quot;application/data&quot;;
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :                         ext = strchr(iri-&gt;string, '.');</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :                         if (ext) {</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :                                 if (!stricmp(ext, &quot;.png&quot;)) mtype = &quot;image/png&quot;;</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :                                 if (!stricmp(ext, &quot;.jpg&quot;) || !stricmp(ext, &quot;.jpeg&quot;)) mtype = &quot;image/jpg&quot;;</span>
<span class="lineNum">     272 </span>            :                         }
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :                         gf_free(iri-&gt;string);</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :                         iri-&gt;string = (char *)gf_malloc(sizeof(char)*(40+(size_t)size64));</span>
<span class="lineNum">     275 </span>            :                         sprintf(iri-&gt;string, &quot;data:%s;base64,%s&quot;, mtype, buf64);
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :                         gf_free(buf64);</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :                         gf_free(buffer);</span>
<span class="lineNum">     278 </span>            :                 }
<span class="lineNum">     279 </span>            :         }
<a name="280"><span class="lineNum">     280 </span>            : }</a>
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span><span class="lineNoCov">          0 : static void xsr_exec_command_list(GF_Node *node, void *par, Bool is_destroy)</span>
<span class="lineNum">     283 </span>            : {
<span class="lineNum">     284 </span>            :         GF_DOMUpdates *up = (GF_DOMUpdates *)node;
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         if (is_destroy || !up || (up-&gt;sgprivate-&gt;tag!=TAG_DOMUpdates)) return;</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :         gf_sg_command_apply_list(up-&gt;sgprivate-&gt;scenegraph, up-&gt;updates, 0);</span>
<a name="287"><span class="lineNum">     287 </span>            : }</a>
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineCov">        180 : static GF_Node *svg_find_node(GF_SVG_Parser *parser, char *ID)</span>
<span class="lineNum">     290 </span>            : {
<span class="lineNum">     291 </span>            :         u32 i, count, tag;
<span class="lineNum">     292 </span>            :         char *node_class;
<span class="lineNum">     293 </span><span class="lineCov">        180 :         GF_Node *n = gf_sg_find_node_by_name(parser-&gt;load-&gt;scene_graph, ID);</span>
<span class="lineNum">     294 </span><span class="lineCov">        180 :         if (n) return n;</span>
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :         count = gf_list_count(parser-&gt;peeked_nodes);</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :                 n = (GF_Node*)gf_list_get(parser-&gt;peeked_nodes, i);</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :                 if (!strcmp(gf_node_get_name(n), ID)) return n;</span>
<span class="lineNum">     300 </span>            :         }
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :         node_class = gf_xml_sax_peek_node(parser-&gt;sax_parser, &quot;id&quot;, ID, NULL, NULL, NULL, NULL);</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :         if (!node_class) return NULL;</span>
<span class="lineNum">     303 </span>            : 
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         tag = gf_xml_get_element_tag(node_class, parser-&gt;current_ns);</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :         n = gf_node_new(parser-&gt;load-&gt;scene_graph, tag);</span>
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :         gf_free(node_class);</span>
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :         if (n) {</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :                 gf_svg_parse_element_id(n, ID, GF_FALSE);</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :                 gf_list_add(parser-&gt;peeked_nodes, n);</span>
<span class="lineNum">     312 </span>            :         }
<span class="lineNum">     313 </span>            :         return n;
<a name="314"><span class="lineNum">     314 </span>            : }</a>
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span><span class="lineCov">        115 : static void svg_post_process_href(GF_SVG_Parser *parser, GF_Node *elt, XMLRI *iri)</span>
<span class="lineNum">     317 </span>            : {
<span class="lineNum">     318 </span>            :         GF_Err e;
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span>            :         /* Embed script if needed or clean data URL with proper mime type */
<span class="lineNum">     321 </span><span class="lineCov">        115 :         svg_process_media_href(parser, elt, iri);</span>
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span>            :         /*keep data when encoding*/
<span class="lineNum">     324 </span><span class="lineCov">        115 :         if ( !(parser-&gt;load-&gt;flags &amp; GF_SM_LOAD_FOR_PLAYBACK)) return;</span>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span>            :         /*unresolved, queue it...*/
<span class="lineNum">     327 </span><span class="lineCov">         45 :         if ((iri-&gt;type==XMLRI_ELEMENTID) &amp;&amp; !iri-&gt;target &amp;&amp; iri-&gt;string) {</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :                 gf_list_add(parser-&gt;deferred_hrefs, iri);</span>
<span class="lineNum">     329 </span>            :         }
<span class="lineNum">     330 </span><span class="lineCov">         45 :         if (iri-&gt;type != XMLRI_STRING) return;</span>
<span class="lineNum">     331 </span><span class="lineCov">         27 :         e = gf_node_store_embedded_data(iri, parser-&gt;load-&gt;localPath, parser-&gt;load-&gt;fileName);</span>
<span class="lineNum">     332 </span><span class="lineCov">         27 :         if (e) svg_report(parser, e, &quot;Error storing embedded IRI data&quot;);</span>
<a name="333"><span class="lineNum">     333 </span>            : }</a>
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span><span class="lineCov">        164 : static void svg_delete_deferred_anim(SVG_DeferredAnimation *anim, GF_List *deferred_animations)</span>
<span class="lineNum">     336 </span>            : {
<span class="lineNum">     337 </span><span class="lineCov">        164 :         if (deferred_animations) gf_list_del_item(deferred_animations, anim);</span>
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span><span class="lineCov">        164 :         if (anim-&gt;target_id) gf_free(anim-&gt;target_id);</span>
<span class="lineNum">     340 </span><span class="lineCov">        164 :         if (anim-&gt;to) gf_free(anim-&gt;to);</span>
<span class="lineNum">     341 </span><span class="lineCov">        164 :         if (anim-&gt;from) gf_free(anim-&gt;from);</span>
<span class="lineNum">     342 </span><span class="lineCov">        164 :         if (anim-&gt;by) gf_free(anim-&gt;by);</span>
<span class="lineNum">     343 </span><span class="lineCov">        164 :         if (anim-&gt;values) gf_free(anim-&gt;values);</span>
<span class="lineNum">     344 </span><span class="lineCov">        164 :         if (anim-&gt;type) gf_free(anim-&gt;type);</span>
<span class="lineNum">     345 </span><span class="lineCov">        164 :         gf_free(anim);</span>
<a name="346"><span class="lineNum">     346 </span><span class="lineCov">        164 : }</span></a>
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span><span class="lineCov">        262 : static Bool svg_parse_animation(GF_SVG_Parser *parser, GF_SceneGraph *sg, SVG_DeferredAnimation *anim, const char *nodeID, u32 force_type)</span>
<span class="lineNum">     349 </span>            : {
<span class="lineNum">     350 </span>            :         GF_FieldInfo info;
<span class="lineNum">     351 </span>            :         u32 tag;
<span class="lineNum">     352 </span>            :         u8 anim_value_type = 0;
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span><span class="lineCov">        262 :         if (anim-&gt;resolve_stage==0) {</span>
<span class="lineNum">     355 </span>            :                 /* Stage 0: parsing the animation attribute values
<span class="lineNum">     356 </span>            :                                         for that we need to resolve the target first */
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            :                 /* if we don't have a target, try to get it */
<span class="lineNum">     359 </span><span class="lineCov">        224 :                 if (!anim-&gt;target)</span>
<span class="lineNum">     360 </span><span class="lineCov">        110 :                         anim-&gt;target = (SVG_Element *) gf_sg_find_node_by_name(sg, anim-&gt;target_id + 1);</span>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span>            :                 /* if now we have a target, create the xlink:href attribute on the animation element and set it to the found target */
<span class="lineNum">     363 </span><span class="lineCov">        224 :                 if (anim-&gt;target) {</span>
<span class="lineNum">     364 </span>            :                         XMLRI *iri;
<span class="lineNum">     365 </span><span class="lineCov">        132 :                         gf_node_get_attribute_by_tag((GF_Node *)anim-&gt;animation_elt, TAG_XLINK_ATT_href, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     366 </span><span class="lineCov">        132 :                         iri = (XMLRI *)info.far_ptr;</span>
<span class="lineNum">     367 </span><span class="lineCov">        132 :                         iri-&gt;type = XMLRI_ELEMENTID;</span>
<span class="lineNum">     368 </span><span class="lineCov">        132 :                         iri-&gt;target = anim-&gt;target;</span>
<span class="lineNum">     369 </span><span class="lineCov">        132 :                         gf_node_register_iri(sg, iri);</span>
<span class="lineNum">     370 </span>            :                 }
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineCov">        224 :                 tag = gf_node_get_tag((GF_Node *)anim-&gt;animation_elt);</span>
<span class="lineNum">     373 </span>            :                 /* get the attribute name attribute if specified */
<span class="lineNum">     374 </span><span class="lineCov">        224 :                 if (anim-&gt;type &amp;&amp; (tag== TAG_SVG_animateTransform) ) {</span>
<span class="lineNum">     375 </span><span class="lineCov">         10 :                         gf_node_get_attribute_by_tag((GF_Node *)anim-&gt;animation_elt, TAG_SVG_ATT_transform_type, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     376 </span><span class="lineCov">         10 :                         gf_svg_parse_attribute((GF_Node *)anim-&gt;animation_elt, &amp;info, anim-&gt;type, 0);</span>
<span class="lineNum">     377 </span><span class="lineCov">         10 :                         switch(*(SVG_TransformType *) info.far_ptr) {</span>
<span class="lineNum">     378 </span>            :                         case SVG_TRANSFORM_TRANSLATE:
<span class="lineNum">     379 </span>            :                                 anim_value_type = SVG_Transform_Translate_datatype;
<span class="lineNum">     380 </span>            :                                 break;
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :                         case SVG_TRANSFORM_SCALE:</span>
<span class="lineNum">     382 </span>            :                                 anim_value_type = SVG_Transform_Scale_datatype;
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     384 </span><span class="lineCov">          2 :                         case SVG_TRANSFORM_ROTATE:</span>
<span class="lineNum">     385 </span>            :                                 anim_value_type = SVG_Transform_Rotate_datatype;
<span class="lineNum">     386 </span><span class="lineCov">          2 :                                 break;</span>
<span class="lineNum">     387 </span><span class="lineCov">          2 :                         case SVG_TRANSFORM_SKEWX:</span>
<span class="lineNum">     388 </span>            :                                 anim_value_type = SVG_Transform_SkewX_datatype;
<span class="lineNum">     389 </span><span class="lineCov">          2 :                                 break;</span>
<span class="lineNum">     390 </span><span class="lineCov">          2 :                         case SVG_TRANSFORM_SKEWY:</span>
<span class="lineNum">     391 </span>            :                                 anim_value_type = SVG_Transform_SkewY_datatype;
<span class="lineNum">     392 </span><span class="lineCov">          2 :                                 break;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                         case SVG_TRANSFORM_MATRIX:</span>
<span class="lineNum">     394 </span>            :                                 anim_value_type = SVG_Transform_datatype;
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                         default:</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_OK, &quot;unknown datatype for animate transform&quot;);</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :                                 return GF_FALSE;</span>
<span class="lineNum">     399 </span>            :                         }
<span class="lineNum">     400 </span>            :                 }
<span class="lineNum">     401 </span><span class="lineCov">        214 :                 else if (gf_node_get_attribute_by_tag((GF_Node *)anim-&gt;animation_elt, TAG_SVG_ATT_attributeName, GF_FALSE, GF_FALSE, &amp;info) == GF_OK) {</span>
<span class="lineNum">     402 </span><span class="lineCov">        202 :                         SMIL_AttributeName *attname = (SMIL_AttributeName *)info.far_ptr;</span>
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span>            :                         /*parse the attribute name even if the target is not found, because a namespace could be specified and
<span class="lineNum">     405 </span>            :                         only valid for the current node*/
<span class="lineNum">     406 </span><span class="lineCov">        202 :                         if (!attname-&gt;type) {</span>
<span class="lineNum">     407 </span>            :                                 char *sep;
<span class="lineNum">     408 </span><span class="lineCov">        114 :                                 char *name = attname-&gt;name;</span>
<span class="lineNum">     409 </span><span class="lineCov">        114 :                                 sep = strchr(name, ':');</span>
<span class="lineNum">     410 </span><span class="lineCov">        114 :                                 if (sep) {</span>
<span class="lineNum">     411 </span><span class="lineCov">          4 :                                         sep[0] = 0;</span>
<span class="lineNum">     412 </span><span class="lineCov">          4 :                                         attname-&gt;type = gf_sg_get_namespace_code(anim-&gt;animation_elt-&gt;sgprivate-&gt;scenegraph, name);</span>
<span class="lineNum">     413 </span><span class="lineCov">          4 :                                         sep[0] = ':';</span>
<span class="lineNum">     414 </span><span class="lineCov">          4 :                                         name = gf_strdup(sep+1);</span>
<span class="lineNum">     415 </span><span class="lineCov">          4 :                                         gf_free(attname-&gt;name);</span>
<span class="lineNum">     416 </span><span class="lineCov">          4 :                                         attname-&gt;name = name;</span>
<span class="lineNum">     417 </span>            :                                 } else {
<span class="lineNum">     418 </span><span class="lineCov">        110 :                                         attname-&gt;type = parser-&gt;current_ns;</span>
<span class="lineNum">     419 </span>            :                                 }
<span class="lineNum">     420 </span>            :                         }
<span class="lineNum">     421 </span>            : 
<span class="lineNum">     422 </span>            :                         /* the target is still not known stay in stage 0 */
<span class="lineNum">     423 </span><span class="lineCov">        202 :                         if (!anim-&gt;target) return GF_FALSE;</span>
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span><span class="lineCov">        110 :                         gf_node_get_attribute_by_name((GF_Node *)anim-&gt;target, attname-&gt;name, attname-&gt;type, GF_TRUE, GF_TRUE, &amp;info);</span>
<span class="lineNum">     426 </span>            :                         /*set the tag value to avoid parsing the name in the anim node_init phase*/
<span class="lineNum">     427 </span><span class="lineCov">        110 :                         attname-&gt;tag = info.fieldIndex;</span>
<span class="lineNum">     428 </span><span class="lineCov">        110 :                         attname-&gt;type = 0;</span>
<span class="lineNum">     429 </span><span class="lineCov">        110 :                         anim_value_type = info.fieldType;</span>
<span class="lineNum">     430 </span>            :                 } else {
<span class="lineNum">     431 </span><span class="lineCov">         12 :                         if (tag == TAG_SVG_animateMotion) {</span>
<span class="lineNum">     432 </span>            :                                 anim_value_type = SVG_Motion_datatype;
<span class="lineNum">     433 </span><span class="lineCov">          4 :                         } else if (tag == TAG_SVG_discard) {</span>
<span class="lineNum">     434 </span>            :                                 /* there is no value to parse in discard, we can jump to the next stage */
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :                                 anim-&gt;resolve_stage = 1;</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :                                 return svg_parse_animation(parser, sg, anim, nodeID, 0);</span>
<span class="lineNum">     437 </span>            :                         } else {
<span class="lineNum">     438 </span><span class="lineCov">          4 :                                 svg_report(parser, GF_OK, &quot;Missing attributeName attribute on %s&quot;, gf_node_get_name((GF_Node *)anim-&gt;animation_elt));</span>
<span class="lineNum">     439 </span><span class="lineCov">          4 :                                 return GF_FALSE;</span>
<span class="lineNum">     440 </span>            :                         }
<span class="lineNum">     441 </span>            :                 }
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span>            :                 /* the target is still not known stay in stage 0 */
<span class="lineNum">     444 </span><span class="lineCov">        128 :                 if (!anim-&gt;target) return GF_FALSE;</span>
<span class="lineNum">     445 </span>            : 
<span class="lineNum">     446 </span><span class="lineCov">        128 :                 if (anim-&gt;to) {</span>
<span class="lineNum">     447 </span>            :                         /* now that we have a target, if there is a to value to parse, create the attribute and parse it */
<span class="lineNum">     448 </span><span class="lineCov">         62 :                         gf_node_get_attribute_by_tag((GF_Node *)anim-&gt;animation_elt, TAG_SVG_ATT_to, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     449 </span><span class="lineCov">         62 :                         gf_svg_parse_attribute((GF_Node *)anim-&gt;animation_elt, &amp;info, anim-&gt;to, anim_value_type);</span>
<span class="lineNum">     450 </span><span class="lineCov">         62 :                         if (anim_value_type==XMLRI_datatype) {</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :                                 svg_post_process_href(parser, (GF_Node *) anim-&gt;target, (XMLRI*)((SMIL_AnimateValue *)info.far_ptr)-&gt;value);</span>
<span class="lineNum">     452 </span>            :                         }
<span class="lineNum">     453 </span>            :                 }
<span class="lineNum">     454 </span><span class="lineCov">        128 :                 if (anim-&gt;from) {</span>
<span class="lineNum">     455 </span>            :                         /* now that we have a target, if there is a from value to parse, create the attribute and parse it */
<span class="lineNum">     456 </span><span class="lineCov">         60 :                         gf_node_get_attribute_by_tag((GF_Node *)anim-&gt;animation_elt, TAG_SVG_ATT_from, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     457 </span><span class="lineCov">         60 :                         gf_svg_parse_attribute((GF_Node *)anim-&gt;animation_elt, &amp;info, anim-&gt;from, anim_value_type);</span>
<span class="lineNum">     458 </span><span class="lineCov">         60 :                         if (anim_value_type==XMLRI_datatype)</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :                                 svg_post_process_href(parser,  (GF_Node *) anim-&gt;target, (XMLRI*)((SMIL_AnimateValue *)info.far_ptr)-&gt;value);</span>
<span class="lineNum">     460 </span>            :                 }
<span class="lineNum">     461 </span><span class="lineCov">        128 :                 if (anim-&gt;by) {</span>
<span class="lineNum">     462 </span>            :                         /* now that we have a target, if there is a by value to parse, create the attribute and parse it */
<span class="lineNum">     463 </span><span class="lineCov">          6 :                         gf_node_get_attribute_by_tag((GF_Node *)anim-&gt;animation_elt, TAG_SVG_ATT_by, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     464 </span><span class="lineCov">          6 :                         gf_svg_parse_attribute((GF_Node *)anim-&gt;animation_elt, &amp;info, anim-&gt;by, anim_value_type);</span>
<span class="lineNum">     465 </span><span class="lineCov">          6 :                         if (anim_value_type==XMLRI_datatype)</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                                 svg_post_process_href(parser,  (GF_Node *) anim-&gt;target, (XMLRI*)((SMIL_AnimateValue *)info.far_ptr)-&gt;value);</span>
<span class="lineNum">     467 </span>            :                 }
<span class="lineNum">     468 </span><span class="lineCov">        128 :                 if (anim-&gt;values) {</span>
<span class="lineNum">     469 </span>            :                         /* now that we have a target, if there is a 'values' value to parse, create the attribute and parse it */
<span class="lineNum">     470 </span><span class="lineCov">         44 :                         gf_node_get_attribute_by_tag((GF_Node *)anim-&gt;animation_elt, TAG_SVG_ATT_values, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     471 </span><span class="lineCov">         44 :                         gf_svg_parse_attribute((GF_Node *)anim-&gt;animation_elt, &amp;info, anim-&gt;values, anim_value_type);</span>
<span class="lineNum">     472 </span><span class="lineCov">         44 :                         if (anim_value_type==XMLRI_datatype) {</span>
<span class="lineNum">     473 </span>            :                                 u32 i, count;
<span class="lineNum">     474 </span>            :                                 SMIL_AnimateValues *anim_values;
<span class="lineNum">     475 </span><span class="lineCov">          4 :                                 anim_values = (SMIL_AnimateValues *)info.far_ptr;</span>
<span class="lineNum">     476 </span><span class="lineCov">          4 :                                 count = gf_list_count(anim_values-&gt;values);</span>
<span class="lineNum">     477 </span><span class="lineCov">         18 :                                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     478 </span><span class="lineCov">         14 :                                         XMLRI *iri = (XMLRI *)gf_list_get(anim_values-&gt;values, i);</span>
<span class="lineNum">     479 </span><span class="lineCov">         14 :                                         svg_post_process_href(parser,  (GF_Node *) anim-&gt;target, iri);</span>
<span class="lineNum">     480 </span>            :                                 }
<span class="lineNum">     481 </span>            :                         }
<span class="lineNum">     482 </span>            :                 }
<span class="lineNum">     483 </span><span class="lineCov">        128 :                 anim-&gt;resolve_stage = 1;</span>
<span class="lineNum">     484 </span>            :         }
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span><span class="lineCov">        166 :         if (anim-&gt;resolve_stage == 1) {</span>
<span class="lineNum">     487 </span>            :                 /* Stage 1: parsing the begin values
<span class="lineNum">     488 </span>            :                                         we go into the next stage only if at least one begin value is resolved */
<span class="lineNum">     489 </span><span class="lineCov">        158 :                 gf_node_get_attribute_by_tag((GF_Node *)anim-&gt;animation_elt, TAG_SVG_ATT_begin, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     490 </span><span class="lineCov">        158 :                 if (gf_svg_resolve_smil_times((GF_Node *)anim-&gt;animation_elt, anim-&gt;target, *(GF_List **)info.far_ptr, GF_FALSE, nodeID)) {</span>
<span class="lineNum">     491 </span><span class="lineCov">        158 :                         anim-&gt;resolve_stage = 2;</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :                 } else if (force_type!=2) {</span>
<span class="lineNum">     493 </span>            :                         return GF_FALSE;
<span class="lineNum">     494 </span>            :                 }
<span class="lineNum">     495 </span>            :         }
<span class="lineNum">     496 </span>            : 
<span class="lineNum">     497 </span><span class="lineCov">        166 :         gf_node_get_attribute_by_tag((GF_Node *)anim-&gt;animation_elt, TAG_SVG_ATT_end, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     498 </span><span class="lineCov">        166 :         if (!gf_svg_resolve_smil_times((GF_Node *)anim-&gt;animation_elt, anim-&gt;target, *(GF_List **)info.far_ptr, GF_TRUE, nodeID)) {</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :                 if (force_type!=2) return GF_FALSE;</span>
<span class="lineNum">     500 </span>            :         }
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span>            :         /*animateMotion needs its children to be parsed before it can be initialized !! */
<span class="lineNum">     503 </span><span class="lineCov">        166 :         if (force_type || gf_node_get_tag((GF_Node *)anim-&gt;animation_elt) != TAG_SVG_animateMotion) {</span>
<span class="lineNum">     504 </span><span class="lineCov">        158 :                 gf_node_init((GF_Node *)anim-&gt;animation_elt);</span>
<span class="lineNum">     505 </span><span class="lineCov">        158 :                 return GF_TRUE;</span>
<span class="lineNum">     506 </span>            :         } else {
<span class="lineNum">     507 </span>            :                 return GF_FALSE;
<span class="lineNum">     508 </span>            :         }
<span class="lineNum">     509 </span>            : 
<a name="510"><span class="lineNum">     510 </span>            : }</a>
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span><span class="lineCov">       2339 : static void svg_resolved_refs(GF_SVG_Parser *parser, GF_SceneGraph *sg, const char *nodeID)</span>
<span class="lineNum">     513 </span>            : {
<span class="lineNum">     514 </span>            :         u32 count, i;
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span>            :         /*check unresolved HREF*/
<span class="lineNum">     517 </span><span class="lineCov">       2339 :         count = gf_list_count(parser-&gt;deferred_hrefs);</span>
<span class="lineNum">     518 </span><span class="lineCov">       2339 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     519 </span>            :                 GF_Node *targ;
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                 XMLRI *iri = (XMLRI *)gf_list_get(parser-&gt;deferred_hrefs, i);</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                 if (nodeID &amp;&amp; strcmp(iri-&gt;string + 1, nodeID)) continue;</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :                 targ = gf_sg_find_node_by_name(sg, iri-&gt;string + 1);</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :                 if (targ) {</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :                         iri-&gt;type = XMLRI_ELEMENTID;</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :                         iri-&gt;target = targ;</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :                         gf_node_register_iri(sg, iri);</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :                         gf_free(iri-&gt;string);</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :                         iri-&gt;string = NULL;</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :                         gf_list_rem(parser-&gt;deferred_hrefs, i);</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :                         i--;</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :                         count--;</span>
<span class="lineNum">     532 </span>            :                 }
<span class="lineNum">     533 </span>            :         }
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span>            :         /*check unresolved listeners */
<span class="lineNum">     536 </span><span class="lineCov">       2339 :         count = gf_list_count(parser-&gt;deferred_listeners);</span>
<span class="lineNum">     537 </span><span class="lineCov">       2339 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     538 </span>            :                 GF_FieldInfo info;
<span class="lineNum">     539 </span>            :                 GF_Node *par;
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :                 SVG_Element *listener = (SVG_Element *)gf_list_get(parser-&gt;deferred_listeners, i);</span>
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span>            :                 par = NULL;
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :                 if (gf_node_get_attribute_by_tag((GF_Node *)listener, TAG_XMLEV_ATT_observer, GF_FALSE, GF_FALSE, &amp;info) == GF_OK) {</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :                         XMLRI *observer = (XMLRI *)info.far_ptr;</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :                         if (observer-&gt;type == XMLRI_ELEMENTID) {</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :                                 if (!observer-&gt;target &amp;&amp; observer-&gt;string &amp;&amp; !strcmp(observer-&gt;string, nodeID) ) {</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :                                         observer-&gt;target = gf_sg_find_node_by_name(sg, (char*) nodeID);</span>
<span class="lineNum">     548 </span>            :                                 }
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :                                 par = (GF_Node *)observer-&gt;target;</span>
<span class="lineNum">     550 </span>            :                         }
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :                         if (!par) continue;</span>
<span class="lineNum">     552 </span>            :                 }
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :                 if (gf_node_get_attribute_by_tag((GF_Node *)listener, TAG_XMLEV_ATT_target, GF_FALSE, GF_FALSE, &amp;info) == GF_OK) {</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :                         XMLRI *target = (XMLRI *)info.far_ptr;</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :                         if (target-&gt;type == XMLRI_ELEMENTID) {</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :                                 if (!target-&gt;target) continue;</span>
<span class="lineNum">     557 </span>            :                                 else {
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :                                         if (!par) par = (GF_Node*)target-&gt;target;</span>
<span class="lineNum">     559 </span>            :                                 }
<span class="lineNum">     560 </span>            :                         }
<span class="lineNum">     561 </span>            :                 }
<span class="lineNum">     562 </span>            :                 assert(par);
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :                 gf_node_dom_listener_add((GF_Node *)par, (GF_Node *) listener);</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :                 gf_list_rem(parser-&gt;deferred_listeners, i);</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :                 i--;</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :                 count--;</span>
<span class="lineNum">     567 </span>            :         }
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span>            :         /*check unresolved anims*/
<span class="lineNum">     570 </span><span class="lineCov">       2339 :         count = gf_list_count(parser-&gt;deferred_animations);</span>
<span class="lineNum">     571 </span><span class="lineCov">       2427 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     572 </span><span class="lineCov">         88 :                 SVG_DeferredAnimation *anim = (SVG_DeferredAnimation *)gf_list_get(parser-&gt;deferred_animations, i);</span>
<span class="lineNum">     573 </span>            :                 /*resolve it - we don't check the name since it may be used in SMIL times, which we don't track at anim level*/
<span class="lineNum">     574 </span><span class="lineCov">         88 :                 if (svg_parse_animation(parser, sg, anim, nodeID, 1)) {</span>
<span class="lineNum">     575 </span><span class="lineCov">         22 :                         svg_delete_deferred_anim(anim, parser-&gt;deferred_animations);</span>
<span class="lineNum">     576 </span><span class="lineCov">         22 :                         i--;</span>
<span class="lineNum">     577 </span><span class="lineCov">         22 :                         count--;</span>
<span class="lineNum">     578 </span>            :                 }
<span class="lineNum">     579 </span>            :         }
<a name="580"><span class="lineNum">     580 </span><span class="lineCov">       2339 : }</span></a>
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span><span class="lineCov">         68 : static void svg_init_root_element(GF_SVG_Parser *parser, SVG_Element *root_svg)</span>
<span class="lineNum">     583 </span>            : {
<span class="lineNum">     584 </span>            :         GF_FieldInfo width_info, height_info;
<span class="lineNum">     585 </span>            :         u32 svg_w, svg_h;
<span class="lineNum">     586 </span>            :         svg_w = svg_h = 0;
<span class="lineNum">     587 </span><span class="lineCov">         68 :         if (!gf_node_get_attribute_by_tag((GF_Node *)root_svg, TAG_SVG_ATT_width, GF_FALSE, GF_FALSE, &amp;width_info)</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :                 &amp;&amp; !gf_node_get_attribute_by_tag((GF_Node *)root_svg, TAG_SVG_ATT_height, GF_FALSE, GF_FALSE, &amp;height_info)) {</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :                 SVG_Length * w = (SVG_Length *)width_info.far_ptr;</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :                 SVG_Length * h = (SVG_Length *)height_info.far_ptr;</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :                 if (w-&gt;type == SVG_NUMBER_VALUE) svg_w = FIX2INT(w-&gt;value);</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :                 if (h-&gt;type == SVG_NUMBER_VALUE) svg_h = FIX2INT(h-&gt;value);</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :                 gf_sg_set_scene_size_info(parser-&gt;load-&gt;scene_graph, svg_w, svg_h, GF_TRUE);</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :                 if (parser-&gt;load-&gt;ctx) {</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :                         parser-&gt;load-&gt;ctx-&gt;scene_width = svg_w;</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :                         parser-&gt;load-&gt;ctx-&gt;scene_height = svg_h;</span>
<span class="lineNum">     597 </span>            :                 }
<span class="lineNum">     598 </span>            :         }
<span class="lineNum">     599 </span><span class="lineCov">         68 :         if (parser-&gt;load-&gt;type == GF_SM_LOAD_XSR) {</span>
<span class="lineNum">     600 </span>            :                 assert(parser-&gt;command);
<span class="lineNum">     601 </span>            :                 assert(parser-&gt;command-&gt;tag == GF_SG_LSR_NEW_SCENE);
<span class="lineNum">     602 </span><span class="lineCov">          2 :                 parser-&gt;command-&gt;node = (GF_Node *)root_svg;</span>
<span class="lineNum">     603 </span>            :         }
<span class="lineNum">     604 </span><span class="lineCov">         68 :         gf_sg_set_root_node(parser-&gt;load-&gt;scene_graph, (GF_Node *)root_svg);</span>
<span class="lineNum">     605 </span><span class="lineCov">         68 :         parser-&gt;has_root = 1;</span>
<a name="606"><span class="lineNum">     606 </span><span class="lineCov">         68 : }</span></a>
<span class="lineNum">     607 </span>            : 
<span class="lineNum">     608 </span><span class="lineCov">       3903 : static void svg_check_namespace(GF_SVG_Parser *parser, const GF_XMLAttribute *attributes, u32 nb_attributes, Bool *has_ns)</span>
<span class="lineNum">     609 </span>            : {
<span class="lineNum">     610 </span>            :         u32 i;
<span class="lineNum">     611 </span>            :         /*parse all att to check for namespaces, to:
<span class="lineNum">     612 </span>            :            - add the prefixed namespaces (xmlns:xxxx='...')
<span class="lineNum">     613 </span>            :            - change the namespace for this element if no prefix (xmlns='...')*/
<span class="lineNum">     614 </span><span class="lineCov">      10861 :         for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">     615 </span><span class="lineCov">      10861 :                 GF_XMLAttribute *att = (GF_XMLAttribute *)&amp;attributes[i];</span>
<span class="lineNum">     616 </span><span class="lineCov">      10861 :                 if (!att-&gt;value || !strlen(att-&gt;value)) continue;</span>
<span class="lineNum">     617 </span><span class="lineCov">      10859 :                 if (!strncmp(att-&gt;name, &quot;xmlns&quot;, 5)) {</span>
<span class="lineNum">     618 </span>            :                         /* check if we have a prefix for this namespace */
<span class="lineNum">     619 </span><span class="lineCov">        210 :                         char *qname = strchr(att-&gt;name, ':');</span>
<span class="lineNum">     620 </span><span class="lineCov">        210 :                         if (qname) {</span>
<span class="lineNum">     621 </span><span class="lineCov">        108 :                                 qname++;</span>
<span class="lineNum">     622 </span>            :                         }
<span class="lineNum">     623 </span>            :                         /* Adds the namespace to the scene graph, either with a prefix or with NULL */
<span class="lineNum">     624 </span><span class="lineCov">        210 :                         gf_sg_add_namespace(parser-&gt;load-&gt;scene_graph, att-&gt;value, qname);</span>
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span><span class="lineCov">        210 :                         if (!qname) {</span>
<span class="lineNum">     627 </span>            :                                 /* Only if there was no prefix, we change the namespace for the current element */
<span class="lineNum">     628 </span><span class="lineCov">        102 :                                 parser-&gt;current_ns = gf_sg_get_namespace_code_from_name(parser-&gt;load-&gt;scene_graph, att-&gt;value);</span>
<span class="lineNum">     629 </span>            :                         }
<span class="lineNum">     630 </span>            :                         /* Signal that when ending this element, namespaces will have to be removed */
<span class="lineNum">     631 </span><span class="lineCov">        210 :                         *has_ns = GF_TRUE;</span>
<span class="lineNum">     632 </span>            :                 }
<span class="lineNum">     633 </span>            :         }
<span class="lineNum">     634 </span><span class="lineCov">       3903 : }</span>
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span>            : //#define SKIP_ALL
<span class="lineNum">     637 </span>            : //#define SKIP_ATTS
<span class="lineNum">     638 </span>            : //#define SKIP_ATTS_PARSING
<span class="lineNum">     639 </span>            : //#define SKIP_INIT
<span class="lineNum">     640 </span>            : 
<a name="641"><span class="lineNum">     641 </span>            : //#define SKIP_UNKNOWN_NODES</a>
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span><span class="lineCov">       3619 : static SVG_Element *svg_parse_element(GF_SVG_Parser *parser, const char *name, const char *name_space, const GF_XMLAttribute *attributes, u32 nb_attributes, SVG_NodeStack *parent, Bool *has_ns)</span>
<span class="lineNum">     644 </span>            : {
<span class="lineNum">     645 </span>            :         GF_FieldInfo info;
<span class="lineNum">     646 </span>            :         u32     tag, i, count, ns, xmlns;
<span class="lineNum">     647 </span>            :         Bool needs_init, has_id;
<span class="lineNum">     648 </span>            :         SVG_Element *elt = NULL;
<span class="lineNum">     649 </span>            :         const char *node_name = NULL;
<span class="lineNum">     650 </span>            :         const char *ev_event, *ev_observer;
<span class="lineNum">     651 </span>            :         SVG_DeferredAnimation *anim = NULL;
<span class="lineNum">     652 </span>            :         char *ID = NULL;
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span><span class="lineCov">       3619 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_PARSER, (&quot;[SVG Parsing] Parsing node %s\n&quot;, name));</span>
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span><span class="lineCov">       3619 :         *has_ns = GF_FALSE;</span>
<span class="lineNum">     657 </span>            : 
<span class="lineNum">     658 </span><span class="lineCov">       3619 :         svg_check_namespace(parser, attributes, nb_attributes, has_ns);</span>
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span><span class="lineCov">      13904 :         for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">     661 </span><span class="lineCov">      10285 :                 GF_XMLAttribute *att = (GF_XMLAttribute *)&amp;attributes[i];</span>
<span class="lineNum">     662 </span><span class="lineCov">      10285 :                 if (!att-&gt;value || !strlen(att-&gt;value)) continue;</span>
<span class="lineNum">     663 </span>            :                 /* FIXME: This should be changed to reflect that xml:id has precedence over id if both are specified with different values */
<span class="lineNum">     664 </span><span class="lineCov">      10285 :                 if (!stricmp(att-&gt;name, &quot;id&quot;) || !stricmp(att-&gt;name, &quot;xml:id&quot;)) {</span>
<span class="lineNum">     665 </span><span class="lineCov">       2339 :                         if (!ID) ID = att-&gt;value;</span>
<span class="lineNum">     666 </span>            :                 }
<span class="lineNum">     667 </span>            :         }
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span>            :         /* CHECK: overriding the element namespace with the parent one, if given ???
<span class="lineNum">     670 </span>            :            This is wrong ??*/
<span class="lineNum">     671 </span><span class="lineCov">       3619 :         xmlns = parser-&gt;current_ns;</span>
<span class="lineNum">     672 </span><span class="lineCov">       3619 :         if (name_space) {</span>
<span class="lineNum">     673 </span><span class="lineCov">         44 :                 xmlns = gf_sg_get_namespace_code(parser-&gt;load-&gt;scene_graph, (char *) name_space);</span>
<span class="lineNum">     674 </span><span class="lineCov">         44 :                 if (!xmlns) {</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, (&quot;[SVG Parsing] line %d - XMLNS prefix %s not defined - skipping\n&quot;, gf_xml_sax_get_line(parser-&gt;sax_parser), name_space));</span>
<span class="lineNum">     676 </span>            :                         return NULL;
<span class="lineNum">     677 </span>            :                 }
<span class="lineNum">     678 </span>            :         }
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span>            :         /* Translates the node type (called name) from a String into a unique numeric identifier in GPAC */
<span class="lineNum">     681 </span><span class="lineCov">       3619 :         tag = xmlns ? gf_xml_get_element_tag(name, xmlns) : TAG_UndefinedNode;</span>
<span class="lineNum">     682 </span><span class="lineCov">       3619 :         if (tag == TAG_UndefinedNode) {</span>
<span class="lineNum">     683 </span>            : #ifdef SKIP_UNKNOWN_NODES
<span class="lineNum">     684 </span>            :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_PARSER, (&quot;[SVG Parsing] line %d - Unknown element %s - skipping\n&quot;, gf_xml_sax_get_line(parser-&gt;sax_parser), name));
<span class="lineNum">     685 </span>            :                 return NULL;
<span class="lineNum">     686 </span>            : #else
<span class="lineNum">     687 </span>            :                 tag = TAG_DOMFullNode;
<span class="lineNum">     688 </span>            : #endif
<span class="lineNum">     689 </span>            :         }
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span>            :         /* If this element has an ID, we look in the list of elements already created in advance (in case of reference) to see if it is there,
<span class="lineNum">     692 </span>            :            in which case we will reuse it*/
<span class="lineNum">     693 </span>            :         has_id = GF_FALSE;
<span class="lineNum">     694 </span><span class="lineCov">       3619 :         count = gf_list_count(parser-&gt;peeked_nodes);</span>
<span class="lineNum">     695 </span><span class="lineCov">       3619 :         if (count &amp;&amp; ID) {</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :                         GF_Node *n = (GF_Node *)gf_list_get(parser-&gt;peeked_nodes, i);</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :                         const char *n_id = gf_node_get_name(n);</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :                         if (n_id &amp;&amp; !strcmp(n_id, ID)) {</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :                                 gf_list_rem(parser-&gt;peeked_nodes, i);</span>
<span class="lineNum">     701 </span>            :                                 has_id = GF_TRUE;
<span class="lineNum">     702 </span>            :                                 elt = (SVG_Element*)n;
<span class="lineNum">     703 </span>            :                                 break;
<span class="lineNum">     704 </span>            :                         }
<span class="lineNum">     705 </span>            :                 }
<span class="lineNum">     706 </span>            :         }
<span class="lineNum">     707 </span>            : 
<span class="lineNum">     708 </span>            :         /* If the element was found in the list of elements already created, we do not need to create it, we reuse it.
<span class="lineNum">     709 </span>            :            Otherwise, we create it based on the tag */
<span class="lineNum">     710 </span>            :         if (!has_id) {
<span class="lineNum">     711 </span>            :                 /* Creates a node in the current scene graph */
<span class="lineNum">     712 </span><span class="lineCov">       3619 :                 elt = (SVG_Element*)gf_node_new(parser-&gt;load-&gt;scene_graph, tag);</span>
<span class="lineNum">     713 </span><span class="lineCov">       3619 :                 if (!elt) {</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :                         parser-&gt;last_error = GF_SG_UNKNOWN_NODE;</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">     716 </span>            :                 }
<span class="lineNum">     717 </span>            :                 /* CHECK: Why isn't this code in the gf_node_new call ?? */
<span class="lineNum">     718 </span><span class="lineCov">       3619 :                 if (tag == TAG_DOMFullNode) {</span>
<span class="lineNum">     719 </span>            :                         GF_DOMFullNode *d = (GF_DOMFullNode *)elt;
<span class="lineNum">     720 </span><span class="lineCov">        138 :                         d-&gt;name = gf_strdup(name);</span>
<span class="lineNum">     721 </span><span class="lineCov">        138 :                         d-&gt;ns = xmlns;</span>
<span class="lineNum">     722 </span><span class="lineCov">        138 :                         if (ID)</span>
<span class="lineNum">     723 </span><span class="lineCov">          2 :                                 gf_svg_parse_element_id((GF_Node *)d, ID, GF_FALSE);</span>
<span class="lineNum">     724 </span>            :                 }
<span class="lineNum">     725 </span>            :         }
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span>            :         /* We indicate that the element is used by its parent (reference counting for safe deleting) */
<span class="lineNum">     728 </span><span class="lineCov">       3619 :         gf_node_register((GF_Node *)elt, (parent ? (GF_Node *)parent-&gt;node : NULL));</span>
<span class="lineNum">     729 </span>            :         /* We attach this element as the last child of its parent */
<span class="lineNum">     730 </span><span class="lineCov">       3619 :         if (parent &amp;&amp; elt) gf_node_list_add_child_last( &amp; parent-&gt;node-&gt;children, (GF_Node*)elt, &amp; parent-&gt;last_child);</span>
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span>            :         /* By default, all elements will need initialization for rendering, except some that will explicitly set it to 0 */
<span class="lineNum">     733 </span>            :         needs_init = GF_TRUE;
<span class="lineNum">     734 </span>            : 
<span class="lineNum">     735 </span><span class="lineCov">       3619 :         if (gf_svg_is_animation_tag(tag)) {</span>
<span class="lineNum">     736 </span><span class="lineCov">        134 :                 GF_SAFEALLOC(anim, SVG_DeferredAnimation);</span>
<span class="lineNum">     737 </span><span class="lineCov">        134 :                 if (!anim) {</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :                         parser-&gt;last_error = GF_OUT_OF_MEM;</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">     740 </span>            :                 }
<span class="lineNum">     741 </span>            :                 /*default anim target is parent node*/
<span class="lineNum">     742 </span><span class="lineCov">        134 :                 anim-&gt;animation_elt = elt;</span>
<span class="lineNum">     743 </span><span class="lineCov">        134 :                 if (!parent) {</span>
<span class="lineNum">     744 </span><span class="lineCov">         10 :                         if (parser-&gt;command) {</span>
<span class="lineNum">     745 </span><span class="lineCov">         10 :                                 anim-&gt;target = anim-&gt;anim_parent = (SVG_Element*) parser-&gt;command-&gt;node;</span>
<span class="lineNum">     746 </span>            :                         }
<span class="lineNum">     747 </span>            :                 } else {
<span class="lineNum">     748 </span><span class="lineCov">        124 :                         anim-&gt;target = anim-&gt;anim_parent = parent-&gt;node;</span>
<span class="lineNum">     749 </span>            :                 }
<span class="lineNum">     750 </span><span class="lineCov">       3485 :         } else if (gf_svg_is_timing_tag(tag)) {</span>
<span class="lineNum">     751 </span>            :                 /* warning: we use the SVG_DeferredAnimation structure for some timing nodes which are not
<span class="lineNum">     752 </span>            :                    animations, but we put the parse stage at 1 (timing) see svg_parse_animation. */
<span class="lineNum">     753 </span><span class="lineCov">         30 :                 GF_SAFEALLOC(anim, SVG_DeferredAnimation);</span>
<span class="lineNum">     754 </span><span class="lineCov">         30 :                 if (!anim) {</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :                         parser-&gt;last_error = GF_OUT_OF_MEM;</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">     757 </span>            :                 }
<span class="lineNum">     758 </span>            :                 /*default anim target is parent node*/
<span class="lineNum">     759 </span><span class="lineCov">         30 :                 anim-&gt;animation_elt = elt;</span>
<span class="lineNum">     760 </span><span class="lineCov">         30 :                 if (!parent) {</span>
<span class="lineNum">     761 </span><span class="lineCov">          6 :                         if (parser-&gt;command) {</span>
<span class="lineNum">     762 </span><span class="lineCov">          6 :                                 anim-&gt;target = anim-&gt;anim_parent = (SVG_Element*) parser-&gt;command-&gt;node;</span>
<span class="lineNum">     763 </span>            :                         }
<span class="lineNum">     764 </span>            :                 } else {
<span class="lineNum">     765 </span><span class="lineCov">         24 :                         anim-&gt;target = anim-&gt;anim_parent = parent-&gt;node;</span>
<span class="lineNum">     766 </span>            :                 }
<span class="lineNum">     767 </span><span class="lineCov">         30 :                 anim-&gt;resolve_stage = 1;</span>
<span class="lineNum">     768 </span><span class="lineCov">       3455 :         } else if ((tag == TAG_SVG_script) || (tag==TAG_SVG_handler)) {</span>
<span class="lineNum">     769 </span>            :                 /* Scripts and handlers don't render and have no initialization phase */
<span class="lineNum">     770 </span>            :                 needs_init = GF_FALSE;
<span class="lineNum">     771 </span>            :         }
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span>            :         ev_event = ev_observer = NULL;
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span>            : #ifdef SKIP_ATTS
<span class="lineNum">     776 </span>            :         nb_attributes = 0;
<span class="lineNum">     777 </span>            : #endif
<span class="lineNum">     778 </span>            : 
<span class="lineNum">     779 </span>            :         /*set the root of the SVG tree BEFORE processing events in order to have it setup for script init (e.g. load events, including in root svg)*/
<span class="lineNum">     780 </span><span class="lineCov">       3619 :         if ((tag == TAG_SVG_svg) &amp;&amp; !parser-&gt;has_root) {</span>
<span class="lineNum">     781 </span><span class="lineCov">         68 :                 svg_init_root_element(parser, elt);</span>
<span class="lineNum">     782 </span>            :         }
<span class="lineNum">     783 </span>            : 
<span class="lineNum">     784 </span>            :         /*parse all att*/
<span class="lineNum">     785 </span><span class="lineCov">      10285 :         for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">     786 </span><span class="lineCov">      10285 :                 GF_XMLAttribute *att = (GF_XMLAttribute *)&amp;attributes[i];</span>
<span class="lineNum">     787 </span>            :                 char *att_name = NULL;
<span class="lineNum">     788 </span><span class="lineCov">      10285 :                 if (!att-&gt;value || !strlen(att-&gt;value)) continue;</span>
<span class="lineNum">     789 </span>            : 
<span class="lineNum">     790 </span>            :                 /* first determine in which namespace is the attribute and store the result in ns,
<span class="lineNum">     791 </span>            :                 then shift the char buffer to point to the local name of the attribute*/
<span class="lineNum">     792 </span>            :                 ns = xmlns;
<span class="lineNum">     793 </span><span class="lineCov">      10285 :                 att_name = strchr(att-&gt;name, ':');</span>
<span class="lineNum">     794 </span><span class="lineCov">      10285 :                 if (att_name) {</span>
<span class="lineNum">     795 </span><span class="lineCov">        527 :                         if (!strncmp(att-&gt;name, &quot;xmlns&quot;, 5)) {</span>
<span class="lineNum">     796 </span><span class="lineCov">         98 :                                 ns = gf_sg_get_namespace_code(parser-&gt;load-&gt;scene_graph, att_name+1);</span>
<span class="lineNum">     797 </span><span class="lineCov">         98 :                                 att_name = att-&gt;name;</span>
<span class="lineNum">     798 </span>            :                         } else {
<span class="lineNum">     799 </span><span class="lineCov">        429 :                                 att_name[0] = 0;</span>
<span class="lineNum">     800 </span><span class="lineCov">        429 :                                 ns = gf_sg_get_namespace_code(parser-&gt;load-&gt;scene_graph, att-&gt;name);</span>
<span class="lineNum">     801 </span><span class="lineCov">        429 :                                 att_name[0] = ':';</span>
<span class="lineNum">     802 </span><span class="lineCov">        429 :                                 att_name++;</span>
<span class="lineNum">     803 </span>            :                         }
<span class="lineNum">     804 </span>            :                 } else {
<span class="lineNum">     805 </span>            :                         att_name = att-&gt;name;
<span class="lineNum">     806 </span>            :                 }
<span class="lineNum">     807 </span>            : 
<span class="lineNum">     808 </span>            :                 /* Begin of special cases of attributes */
<span class="lineNum">     809 </span>            : 
<span class="lineNum">     810 </span>            :                 /* CHECK: Shouldn't namespaces be checked here ? */
<span class="lineNum">     811 </span><span class="lineCov">      10285 :                 if (!stricmp(att_name, &quot;style&quot;)) {</span>
<span class="lineNum">     812 </span><span class="lineCov">         55 :                         gf_svg_parse_style((GF_Node *)elt, att-&gt;value);</span>
<span class="lineNum">     813 </span><span class="lineCov">         55 :                         continue;</span>
<span class="lineNum">     814 </span>            :                 }
<span class="lineNum">     815 </span>            : 
<span class="lineNum">     816 </span>            :                 /* Some attributes of the animation elements cannot be parsed (into typed values) until the type of value is known,
<span class="lineNum">     817 </span>            :                    we defer the parsing and store them temporarily as strings */
<span class="lineNum">     818 </span><span class="lineCov">      10230 :                 if (anim) {</span>
<span class="lineNum">     819 </span><span class="lineCov">        855 :                         if (!stricmp(att_name, &quot;to&quot;)) {</span>
<span class="lineNum">     820 </span><span class="lineCov">         66 :                                 anim-&gt;to = gf_strdup(att-&gt;value);</span>
<span class="lineNum">     821 </span><span class="lineCov">         66 :                                 continue;</span>
<span class="lineNum">     822 </span>            :                         }
<span class="lineNum">     823 </span><span class="lineCov">        789 :                         if (!stricmp(att_name, &quot;from&quot;)) {</span>
<span class="lineNum">     824 </span><span class="lineCov">         62 :                                 anim-&gt;from = gf_strdup(att-&gt;value);</span>
<span class="lineNum">     825 </span><span class="lineCov">         62 :                                 continue;</span>
<span class="lineNum">     826 </span>            :                         }
<span class="lineNum">     827 </span><span class="lineCov">        727 :                         if (!stricmp(att_name, &quot;by&quot;)) {</span>
<span class="lineNum">     828 </span><span class="lineCov">          8 :                                 anim-&gt;by = gf_strdup(att-&gt;value);</span>
<span class="lineNum">     829 </span><span class="lineCov">          8 :                                 continue;</span>
<span class="lineNum">     830 </span>            :                         }
<span class="lineNum">     831 </span><span class="lineCov">        719 :                         if (!stricmp(att_name, &quot;values&quot;)) {</span>
<span class="lineNum">     832 </span><span class="lineCov">         46 :                                 anim-&gt;values = gf_strdup(att-&gt;value);</span>
<span class="lineNum">     833 </span><span class="lineCov">         46 :                                 continue;</span>
<span class="lineNum">     834 </span>            :                         }
<span class="lineNum">     835 </span><span class="lineCov">        673 :                         if ((tag == TAG_SVG_animateTransform) &amp;&amp; !stricmp(att_name, &quot;type&quot;)) {</span>
<span class="lineNum">     836 </span><span class="lineCov">         10 :                                 anim-&gt;type = gf_strdup(att-&gt;value);</span>
<span class="lineNum">     837 </span><span class="lineCov">         10 :                                 continue;</span>
<span class="lineNum">     838 </span>            :                         }
<span class="lineNum">     839 </span>            :                 }
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span>            :                 /* Special case for xlink:href attributes */
<span class="lineNum">     842 </span><span class="lineCov">      10038 :                 if ((ns == GF_XMLNS_XLINK) &amp;&amp; !stricmp(att_name, &quot;href&quot;) ) {</span>
<span class="lineNum">     843 </span>            : 
<span class="lineNum">     844 </span><span class="lineCov">        147 :                         if (gf_svg_is_animation_tag(tag)) {</span>
<span class="lineNum">     845 </span>            :                                 /* For xlink:href in animation elements,
<span class="lineNum">     846 </span>            :                                 we try to locate the target of the xlink:href to determine the type of values to be animated */
<span class="lineNum">     847 </span>            :                                 assert(anim);
<span class="lineNum">     848 </span><span class="lineCov">         46 :                                 anim-&gt;target_id = gf_strdup(att-&gt;value);</span>
<span class="lineNum">     849 </span>            :                                 /*The target may be NULL, if it has not yet been parsed, we will try to resolve it later on */
<span class="lineNum">     850 </span><span class="lineCov">         46 :                                 anim-&gt;target = (SVG_Element *) gf_sg_find_node_by_name(parser-&gt;load-&gt;scene_graph, anim-&gt;target_id + 1);</span>
<span class="lineNum">     851 </span><span class="lineCov">         46 :                                 continue;</span>
<span class="lineNum">     852 </span>            :                         } else {
<span class="lineNum">     853 </span>            :                                 /* For xlink:href attribute on elements other than animation elements,
<span class="lineNum">     854 </span>            :                                    we create the attribute, parse it and try to do some special process it */
<span class="lineNum">     855 </span>            :                                 XMLRI *iri = NULL;
<span class="lineNum">     856 </span><span class="lineCov">        101 :                                 if (gf_node_get_attribute_by_tag((GF_Node *)elt, TAG_XLINK_ATT_href, GF_TRUE, GF_FALSE, &amp;info)==GF_OK) {</span>
<span class="lineNum">     857 </span><span class="lineCov">        101 :                                         gf_svg_parse_attribute((GF_Node *)elt, &amp;info, att-&gt;value, 0);</span>
<span class="lineNum">     858 </span><span class="lineCov">        101 :                                         iri = (XMLRI *)info.far_ptr;</span>
<span class="lineNum">     859 </span>            : 
<span class="lineNum">     860 </span>            :                                         /* extract streamID ref or data URL and store as file */
<span class="lineNum">     861 </span><span class="lineCov">        101 :                                         svg_post_process_href(parser, (GF_Node *)elt, iri);</span>
<span class="lineNum">     862 </span><span class="lineCov">        101 :                                         continue;</span>
<span class="lineNum">     863 </span>            :                                 }
<span class="lineNum">     864 </span>            :                         }
<span class="lineNum">     865 </span>            :                 }
<span class="lineNum">     866 </span>            : 
<span class="lineNum">     867 </span>            :                 /* For the XML Event handler element, we need to defer the parsing of some attributes */
<span class="lineNum">     868 </span><span class="lineCov">       9891 :                 if ((tag == TAG_SVG_handler) &amp;&amp; (ns == GF_XMLNS_XMLEV)) {</span>
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :                         if (!stricmp(att_name, &quot;event&quot;) ) {</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :                                 ev_event = att-&gt;value;</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     872 </span>            :                         }
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :                         if (!stricmp(att_name, &quot;observer&quot;) ) {</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :                                 ev_observer = att-&gt;value;</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     876 </span>            :                         }
<span class="lineNum">     877 </span>            :                 }
<span class="lineNum">     878 </span>            : 
<span class="lineNum">     879 </span>            :                 /*laser specific stuff*/
<span class="lineNum">     880 </span><span class="lineCov">       9891 :                 if (ns == GF_XMLNS_LASER) {</span>
<span class="lineNum">     881 </span>            :                         /* CHECK: we should probably check the namespace of the attribute here */
<span class="lineNum">     882 </span><span class="lineCov">         32 :                         if (!stricmp(att_name, &quot;scale&quot;) ) {</span>
<span class="lineNum">     883 </span><span class="lineCov">          2 :                                 if (gf_node_get_attribute_by_tag((GF_Node *)elt, TAG_SVG_ATT_transform, GF_TRUE, GF_TRUE, &amp;info)==GF_OK) {</span>
<span class="lineNum">     884 </span>            :                                         SVG_Point pt;
<span class="lineNum">     885 </span><span class="lineCov">          2 :                                         SVG_Transform *mat = (SVG_Transform *)info.far_ptr;</span>
<span class="lineNum">     886 </span><span class="lineCov">          2 :                                         svg_parse_point(&amp;pt, att-&gt;value);</span>
<span class="lineNum">     887 </span><span class="lineCov">          2 :                                         gf_mx2d_add_scale(&amp;mat-&gt;mat, pt.x, pt.y);</span>
<span class="lineNum">     888 </span><span class="lineCov">          2 :                                         continue;</span>
<span class="lineNum">     889 </span>            :                                 }
<span class="lineNum">     890 </span>            :                         }
<span class="lineNum">     891 </span><span class="lineCov">         30 :                         if (!stricmp(att_name, &quot;translation&quot;) ) {</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :                                 if (gf_node_get_attribute_by_tag((GF_Node *)elt, TAG_SVG_ATT_transform, GF_TRUE, GF_TRUE, &amp;info)==GF_OK) {</span>
<span class="lineNum">     893 </span>            :                                         SVG_Point pt;
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :                                         SVG_Transform *mat = (SVG_Transform *)info.far_ptr;</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :                                         svg_parse_point(&amp;pt, att-&gt;value);</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :                                         gf_mx2d_add_translation(&amp;mat-&gt;mat, pt.x, pt.y);</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">     898 </span>            :                                 }
<span class="lineNum">     899 </span>            :                         }
<span class="lineNum">     900 </span>            :                 }
<span class="lineNum">     901 </span>            : 
<span class="lineNum">     902 </span>            :                 /* For all attributes of the form 'on...', like 'onclick' we create a listener for the event on the current element,
<span class="lineNum">     903 </span>            :                    we connect the listener to a handler that contains the code in the 'on...' attribute. */
<span class="lineNum">     904 </span>            :                 /* CHECK: we should probably check the namespace of the attribute and of the element here */
<span class="lineNum">     905 </span><span class="lineCov">       9889 :                 if (!strncmp(att_name, &quot;on&quot;, 2)) {</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :                         u32 evtType = gf_dom_event_type_by_name(att_name + 2);</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :                         if (evtType != GF_EVENT_UNKNOWN) {</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :                                 SVG_handlerElement *handler = gf_dom_listener_build((GF_Node *) elt, evtType, 0);</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :                                 gf_dom_add_text_node((GF_Node *)handler, gf_strdup(att-&gt;value) );</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :                                 gf_node_init((GF_Node *)handler);</span>
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     912 </span>            :                         }
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :                         svg_report(parser, GF_OK, &quot;Skipping unknown event handler %s on node %s&quot;, att-&gt;name, name);</span>
<span class="lineNum">     914 </span>            :                 }
<span class="lineNum">     915 </span>            : 
<span class="lineNum">     916 </span>            :                 /* end of special cases of attributes */
<span class="lineNum">     917 </span>            : 
<span class="lineNum">     918 </span>            :                 /* General attribute creation and parsing */
<span class="lineNum">     919 </span><span class="lineCov">       9889 :                 if (gf_node_get_attribute_by_name((GF_Node *)elt, att_name, ns, GF_TRUE, GF_FALSE, &amp;info)==GF_OK) {</span>
<span class="lineNum">     920 </span>            : #ifndef SKIP_ATTS_PARSING
<span class="lineNum">     921 </span><span class="lineCov">       9889 :                         GF_Err e = gf_svg_parse_attribute((GF_Node *)elt, &amp;info, att-&gt;value, 0);</span>
<span class="lineNum">     922 </span><span class="lineCov">       9889 :                         if (e) {</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :                                 svg_report(parser, e, &quot;Error parsing attribute %s on node %s&quot;, att-&gt;name, name);</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     925 </span>            :                         }
<span class="lineNum">     926 </span><span class="lineCov">       9889 :                         if (info.fieldType == SVG_ID_datatype) {</span>
<span class="lineNum">     927 </span>            :                                 /*&quot;when both 'id' and 'xml:id'  are specified on the same element but with different values,
<span class="lineNum">     928 </span>            :                                 the SVGElement::id field must return either of the values but should give precedence to
<span class="lineNum">     929 </span>            :                                 the 'xml:id'  attribute.&quot;*/
<span class="lineNum">     930 </span><span class="lineCov">       2333 :                                 if (!node_name || (info.fieldIndex == TAG_XML_ATT_id)) {</span>
<span class="lineNum">     931 </span><span class="lineCov">       2333 :                                         node_name = *(SVG_ID *)info.far_ptr;</span>
<span class="lineNum">     932 </span>            :                                         /* Check if ID start with a digit, which is not a valid ID for a node according to XML (see http://www.w3.org/TR/xml/#id) */
<span class="lineNum">     933 </span><span class="lineCov">       2333 :                                         if (isdigit(node_name[0])) {</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :                                                 svg_report(parser, GF_BAD_PARAM, &quot;Invalid value %s for node %s %s&quot;, node_name, name, att-&gt;name);</span>
<span class="lineNum">     935 </span>            :                                                 node_name = NULL;
<span class="lineNum">     936 </span>            :                                         }
<span class="lineNum">     937 </span>            :                                 }
<span class="lineNum">     938 </span>            :                         } else {
<span class="lineNum">     939 </span><span class="lineCov">       7556 :                                 switch (info.fieldIndex) {</span>
<span class="lineNum">     940 </span><span class="lineCov">         10 :                                 case TAG_SVG_ATT_syncMaster:</span>
<span class="lineNum">     941 </span>            :                                 case TAG_SVG_ATT_focusHighlight:
<span class="lineNum">     942 </span>            :                                 case TAG_SVG_ATT_initialVisibility:
<span class="lineNum">     943 </span>            :                                 case TAG_SVG_ATT_fullscreen:
<span class="lineNum">     944 </span>            :                                 case TAG_SVG_ATT_requiredFonts:
<span class="lineNum">     945 </span>            :                                         /*switch LASeR Configuration to v2 because these attributes are not part of v1*/
<span class="lineNum">     946 </span><span class="lineCov">         10 :                                         svg_lsr_set_v2(parser);</span>
<span class="lineNum">     947 </span><span class="lineCov">         10 :                                         break;</span>
<span class="lineNum">     948 </span>            :                                 }
<span class="lineNum">     949 </span>            :                         }
<span class="lineNum">     950 </span>            : #endif
<span class="lineNum">     951 </span><span class="lineCov">       9889 :                         continue;</span>
<span class="lineNum">     952 </span>            :                 }
<span class="lineNum">     953 </span>            : 
<span class="lineNum">     954 </span>            :                 /* all other attributes (??? failed to be created) should fall in this category */
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :                 svg_report(parser, GF_OK, &quot;Skipping attribute %s on node %s&quot;, att-&gt;name, name);</span>
<span class="lineNum">     956 </span>            :         }
<span class="lineNum">     957 </span>            : 
<span class="lineNum">     958 </span>            :         /* When a handler element specifies the event attribute, an implicit listener is defined */
<span class="lineNum">     959 </span><span class="lineCov">       3619 :         if (ev_event) {</span>
<span class="lineNum">     960 </span>            :                 GF_Node *node = (GF_Node *)elt;
<span class="lineNum">     961 </span>            :                 SVG_Element *listener;
<span class="lineNum">     962 </span>            :                 u32 type;
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :                 listener = (SVG_Element *) gf_node_new(node-&gt;sgprivate-&gt;scenegraph, TAG_SVG_listener);</span>
<span class="lineNum">     964 </span>            :                 /*We don't want to insert the implicit listener in the DOM. However remember
<span class="lineNum">     965 </span>            :                 the listener at the handler level in case the handler gets destroyed*/
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :                 gf_node_set_private(node, (GF_Node*)listener );</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :                 gf_node_register((GF_Node*)listener, NULL);</span>
<span class="lineNum">     968 </span>            : 
<span class="lineNum">     969 </span>            :                 /* this listener listens to the given type of event */
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :                 type = gf_dom_event_type_by_name(ev_event);</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :                 gf_node_get_attribute_by_tag(node, TAG_XMLEV_ATT_event, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :                 ((XMLEV_Event *)info.far_ptr)-&gt;type = type;</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :                 gf_node_get_attribute_by_tag((GF_Node *)listener, TAG_XMLEV_ATT_event, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :                 ((XMLEV_Event *)info.far_ptr)-&gt;type = type;</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :                 gf_node_get_attribute_by_tag((GF_Node *)listener, TAG_XMLEV_ATT_handler, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :                 ((XMLRI *)info.far_ptr)-&gt;target = node;</span>
<span class="lineNum">     977 </span>            : 
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :                 if (ev_observer) {</span>
<span class="lineNum">     979 </span>            :                         /* An observer was specified, so it needs to be used */
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :                         gf_node_get_attribute_by_tag((GF_Node *)listener, TAG_XMLEV_ATT_observer, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :                         gf_svg_parse_attribute((GF_Node *)elt, &amp;info, (char*)ev_observer, 0);</span>
<span class="lineNum">     982 </span>            :                 } else {
<span class="lineNum">     983 </span>            :                         /* No observer specified, this listener listens with the parent of the handler as the event target */
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :                         gf_node_get_attribute_by_tag((GF_Node *)listener, TAG_XMLEV_ATT_target, GF_TRUE, GF_FALSE, &amp;info);</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :                         ((XMLRI *)info.far_ptr)-&gt;target = parent-&gt;node;</span>
<span class="lineNum">     986 </span>            :                 }
<span class="lineNum">     987 </span>            :                 /* if the target was found (already parsed), we are fine, otherwise we need to try to find it again,
<span class="lineNum">     988 </span>            :                    we place the listener in the deferred listener list */
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :                 if ( ((XMLRI *)info.far_ptr)-&gt;target)</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :                         gf_node_dom_listener_add(((XMLRI *)info.far_ptr)-&gt;target, (GF_Node *) listener);</span>
<span class="lineNum">     991 </span>            :                 else
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :                         gf_list_add(parser-&gt;deferred_listeners, listener);</span>
<span class="lineNum">     993 </span>            :         }
<span class="lineNum">     994 </span>            : 
<span class="lineNum">     995 </span><span class="lineCov">       3619 :         if (!node_name &amp;&amp; ID)</span>
<span class="lineNum">     996 </span>            :                 node_name = ID;
<span class="lineNum">     997 </span>            : 
<span class="lineNum">     998 </span>            :         /* if the new element has an id, we try to resolve deferred references (including animations, href and listeners (just above)*/
<span class="lineNum">     999 </span><span class="lineCov">       3619 :         if (node_name) {</span>
<span class="lineNum">    1000 </span><span class="lineCov">       2339 :                 if (!has_id) {</span>
<span class="lineNum">    1001 </span>            :                         /* if the element was already created before this call, we don't need to get a numerical id, we have it already */
<span class="lineNum">    1002 </span><span class="lineCov">       2339 :                         gf_svg_parse_element_id((GF_Node *)elt, node_name, parser-&gt;command_depth ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    1003 </span>            :                 }
<span class="lineNum">    1004 </span><span class="lineCov">       2339 :                 svg_resolved_refs(parser, parser-&gt;load-&gt;scene_graph, node_name);</span>
<span class="lineNum">    1005 </span>            :         }
<span class="lineNum">    1006 </span>            : 
<span class="lineNum">    1007 </span>            :         /* if the new element is an animation, now that all specified attributes have been found,
<span class="lineNum">    1008 </span>            :            we can start parsing them */
<span class="lineNum">    1009 </span><span class="lineCov">       3619 :         if (anim) {</span>
<span class="lineNum">    1010 </span>            :                 /*FIXME - we need to parse from/to/values but not initialize the stack*/
<span class="lineNum">    1011 </span>            : //              if (parser-&gt;load-&gt;flags &amp; GF_SM_LOAD_FOR_PLAYBACK) {
<span class="lineNum">    1012 </span>            :                 needs_init = GF_FALSE;
<span class="lineNum">    1013 </span><span class="lineCov">        164 :                 if (svg_parse_animation(parser, parser-&gt;load-&gt;scene_graph, anim, NULL, 0)) {</span>
<span class="lineNum">    1014 </span><span class="lineCov">        132 :                         svg_delete_deferred_anim(anim, NULL);</span>
<span class="lineNum">    1015 </span>            :                 } else {
<span class="lineNum">    1016 </span><span class="lineCov">         32 :                         gf_list_add(parser-&gt;deferred_animations, anim);</span>
<span class="lineNum">    1017 </span>            :                 }
<span class="lineNum">    1018 </span>            : //              } else {
<span class="lineNum">    1019 </span>            : //                      svg_delete_deferred_anim(anim, NULL);
<span class="lineNum">    1020 </span>            : //              }
<span class="lineNum">    1021 </span>            :         }
<span class="lineNum">    1022 </span>            : 
<span class="lineNum">    1023 </span>            : #ifndef SKIP_INIT
<span class="lineNum">    1024 </span><span class="lineCov">       3455 :         if (needs_init) {</span>
<span class="lineNum">    1025 </span>            :                 /* For elements that need it, we initialize the rendering stack */
<span class="lineNum">    1026 </span><span class="lineCov">       3443 :                 gf_node_init((GF_Node *)elt);</span>
<span class="lineNum">    1027 </span>            :         }
<span class="lineNum">    1028 </span>            : #endif
<span class="lineNum">    1029 </span>            : 
<span class="lineNum">    1030 </span><span class="lineCov">       3619 :         if (parent &amp;&amp; elt) {</span>
<span class="lineNum">    1031 </span>            :                 /*mark parent element as dirty (new child added) and invalidate parent graph for progressive rendering*/
<span class="lineNum">    1032 </span><span class="lineCov">       3467 :                 gf_node_dirty_set((GF_Node *)parent-&gt;node, GF_SG_CHILD_DIRTY, GF_TRUE);</span>
<span class="lineNum">    1033 </span>            :                 /*request scene redraw*/
<span class="lineNum">    1034 </span><span class="lineCov">       3467 :                 if (parser-&gt;load-&gt;scene_graph-&gt;NodeCallback) {</span>
<span class="lineNum">    1035 </span><span class="lineCov">       2248 :                         parser-&gt;load-&gt;scene_graph-&gt;NodeCallback(parser-&gt;load-&gt;scene_graph-&gt;userpriv, GF_SG_CALLBACK_MODIFIED, NULL, NULL);</span>
<span class="lineNum">    1036 </span>            :                 }
<span class="lineNum">    1037 </span>            :         }
<span class="lineNum">    1038 </span>            : 
<span class="lineNum">    1039 </span>            :         /*If we are in playback mode, we register (reference counting for safe deleting) the listener element with the element that uses it */
<span class="lineNum">    1040 </span><span class="lineCov">       3619 :         if ((parser-&gt;load-&gt;flags &amp; GF_SM_LOAD_FOR_PLAYBACK) &amp;&amp; elt &amp;&amp; (tag==TAG_SVG_listener)) {</span>
<span class="lineNum">    1041 </span>            :                 Bool post_pone = GF_FALSE;
<span class="lineNum">    1042 </span>            :                 SVG_Element *par = NULL;
<span class="lineNum">    1043 </span>            :                 SVG_Element *listener = (SVG_Element *)elt;
<span class="lineNum">    1044 </span>            : 
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :                 if (gf_node_get_attribute_by_tag((GF_Node *)listener, TAG_XMLEV_ATT_observer, GF_FALSE, GF_FALSE, &amp;info) == GF_OK) {</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :                         XMLRI *observer = (XMLRI *)info.far_ptr;</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :                         if (observer-&gt;type == XMLRI_ELEMENTID) {</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :                                 if (!observer-&gt;target) post_pone = GF_TRUE;</span>
<span class="lineNum">    1049 </span>            :                                 else par = (SVG_Element *)observer-&gt;target;
<span class="lineNum">    1050 </span>            :                         }
<span class="lineNum">    1051 </span>            :                 }
<span class="lineNum">    1052 </span>            : 
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :                 if (gf_node_get_attribute_by_tag((GF_Node *)listener, TAG_XMLEV_ATT_target, GF_FALSE, GF_FALSE, &amp;info) == GF_OK) {</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :                         XMLRI *target = (XMLRI *)info.far_ptr;</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :                         if (!par &amp;&amp; (target-&gt;type == XMLRI_ELEMENTID)) {</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :                                 if (!target-&gt;target) post_pone = GF_TRUE;</span>
<span class="lineNum">    1057 </span>            :                                 else par = (SVG_Element *)target-&gt;target;
<span class="lineNum">    1058 </span>            :                         }
<span class="lineNum">    1059 </span>            :                 }
<span class="lineNum">    1060 </span>            :                 /*check handler, create it if not specified*/
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :                 if (parent &amp;&amp; (gf_node_get_attribute_by_tag((GF_Node *)listener, TAG_XMLEV_ATT_handler, GF_TRUE, GF_FALSE, &amp;info) == GF_OK)) {</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :                         XMLRI *handler = (XMLRI *)info.far_ptr;</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :                         if (!handler-&gt;target) {</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :                                 if (!handler-&gt;string) handler-&gt;target = parent-&gt;node;</span>
<span class="lineNum">    1065 </span>            :                         }
<span class="lineNum">    1066 </span>            :                 }
<span class="lineNum">    1067 </span>            :                 /*if event is a key event, register it with root*/
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :                 if (!par &amp;&amp; gf_node_get_attribute_by_tag((GF_Node *)listener, TAG_XMLEV_ATT_event, GF_FALSE, GF_FALSE, &amp;info) == GF_OK) {</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :                         XMLEV_Event *ev = (XMLEV_Event *)info.far_ptr;</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :                         if ((ev-&gt;type&gt;=GF_EVENT_KEYUP) &amp;&amp; (ev-&gt;type&lt;=GF_EVENT_TEXTINPUT)) par = (SVG_Element*) listener-&gt;sgprivate-&gt;scenegraph-&gt;RootNode;</span>
<span class="lineNum">    1071 </span>            :                 }
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :                 if (post_pone) {</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :                         gf_list_add(parser-&gt;deferred_listeners, listener);</span>
<span class="lineNum">    1075 </span>            :                 } else {
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :                         if (!par &amp;&amp; parent) par = parent-&gt;node;</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :                         gf_node_dom_listener_add((GF_Node *)par, (GF_Node *) listener);</span>
<span class="lineNum">    1078 </span>            :                 }
<span class="lineNum">    1079 </span>            :         }
<span class="lineNum">    1080 </span>            :         return elt;
<span class="lineNum">    1081 </span>            : }
<a name="1082"><span class="lineNum">    1082 </span>            : </a>
<span class="lineNum">    1083 </span>            : 
<span class="lineNum">    1084 </span><span class="lineCov">        182 : static GF_Err lsr_parse_command(GF_SVG_Parser *parser, const GF_XMLAttribute *attributes, u32 nb_attributes)</span>
<span class="lineNum">    1085 </span>            : {
<span class="lineNum">    1086 </span>            :         GF_FieldInfo info;
<span class="lineNum">    1087 </span>            :         GF_Node *opNode;
<span class="lineNum">    1088 </span>            :         Bool is_replace = GF_FALSE;
<span class="lineNum">    1089 </span>            :         char *atNode = NULL;
<span class="lineNum">    1090 </span>            :         char *atAtt = NULL;
<span class="lineNum">    1091 </span>            :         char *atOperandNode = NULL;
<span class="lineNum">    1092 </span>            :         char *atOperandAtt = NULL;
<span class="lineNum">    1093 </span>            :         char *atValue = NULL;
<span class="lineNum">    1094 </span>            :         char *atPoint = NULL;
<span class="lineNum">    1095 </span>            :         char *atInteger = NULL;
<span class="lineNum">    1096 </span>            :         char *atEvent = NULL;
<span class="lineNum">    1097 </span>            :         char *atString = NULL;
<span class="lineNum">    1098 </span>            :         GF_CommandField *field;
<span class="lineNum">    1099 </span>            :         s32 index = -1;
<span class="lineNum">    1100 </span>            :         u32 i;
<span class="lineNum">    1101 </span><span class="lineCov">        182 :         switch (parser-&gt;command-&gt;tag) {</span>
<span class="lineNum">    1102 </span>            :         case GF_SG_LSR_NEW_SCENE:
<span class="lineNum">    1103 </span>            :                 return GF_OK;
<span class="lineNum">    1104 </span>            :         case GF_SG_LSR_DELETE:
<span class="lineNum">    1105 </span><span class="lineCov">         10 :                 for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">    1106 </span><span class="lineCov">         10 :                         GF_XMLAttribute *att = (GF_XMLAttribute *) &amp;attributes[i];</span>
<span class="lineNum">    1107 </span><span class="lineCov">         10 :                         if (!strcmp(att-&gt;name, &quot;ref&quot;)) atNode = att-&gt;value;</span>
<span class="lineNum">    1108 </span><span class="lineCov">          4 :                         else if (!strcmp(att-&gt;name, &quot;attributeName&quot;)) atAtt = att-&gt;value;</span>
<span class="lineNum">    1109 </span><span class="lineCov">          2 :                         else if (!strcmp(att-&gt;name, &quot;index&quot;)) index = atoi(att-&gt;value);</span>
<span class="lineNum">    1110 </span>            :                 }
<span class="lineNum">    1111 </span><span class="lineCov">          6 :                 if (!atNode) return svg_report(parser, GF_BAD_PARAM, &quot;Missing node ref for command&quot;);</span>
<span class="lineNum">    1112 </span>            :                 /*should be a XML IDREF, not an XML IRI*/
<span class="lineNum">    1113 </span><span class="lineCov">          6 :                 if (atNode[0]=='#') atNode++;</span>
<span class="lineNum">    1114 </span>            : 
<span class="lineNum">    1115 </span><span class="lineCov">          6 :                 parser-&gt;command-&gt;node = svg_find_node(parser, atNode);</span>
<span class="lineNum">    1116 </span><span class="lineCov">          6 :                 if (!parser-&gt;command-&gt;node) return svg_report(parser, GF_BAD_PARAM, &quot;Cannot find node node ref %s for command&quot;, atNode);</span>
<span class="lineNum">    1117 </span><span class="lineCov">          6 :                 if (atAtt) {</span>
<span class="lineNum">    1118 </span><span class="lineCov">          2 :                         if (!strcmp(atAtt, &quot;children&quot;)) {</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :                                 field = gf_sg_command_field_new(parser-&gt;command);</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :                                 field-&gt;pos = index;</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :                                 field-&gt;fieldIndex = 0;</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :                                 field-&gt;fieldType = 0;</span>
<span class="lineNum">    1123 </span>            :                         } else {
<span class="lineNum">    1124 </span><span class="lineCov">          2 :                                 if (gf_node_get_attribute_by_name(parser-&gt;command-&gt;node, atAtt, parser-&gt;current_ns, GF_FALSE, GF_FALSE, &amp;info)==GF_OK) {</span>
<span class="lineNum">    1125 </span><span class="lineCov">          2 :                                         field = gf_sg_command_field_new(parser-&gt;command);</span>
<span class="lineNum">    1126 </span><span class="lineCov">          2 :                                         field-&gt;pos = index;</span>
<span class="lineNum">    1127 </span><span class="lineCov">          2 :                                         field-&gt;fieldIndex = info.fieldIndex;</span>
<span class="lineNum">    1128 </span><span class="lineCov">          2 :                                         field-&gt;fieldType = info.fieldType;</span>
<span class="lineNum">    1129 </span>            :                                 }
<span class="lineNum">    1130 </span>            :                         }
<span class="lineNum">    1131 </span><span class="lineCov">          4 :                 } else if (index&gt;=0) {</span>
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :                         field = gf_sg_command_field_new(parser-&gt;command);</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :                         field-&gt;pos = index;</span>
<span class="lineNum">    1134 </span>            :                 }
<span class="lineNum">    1135 </span><span class="lineCov">          6 :                 gf_node_register(parser-&gt;command-&gt;node, NULL);</span>
<span class="lineNum">    1136 </span><span class="lineCov">          6 :                 return GF_OK;</span>
<span class="lineNum">    1137 </span><span class="lineCov">         58 :         case GF_SG_LSR_REPLACE:</span>
<span class="lineNum">    1138 </span>            :                 is_replace = GF_TRUE;
<span class="lineNum">    1139 </span><span class="lineCov">         62 :         case GF_SG_LSR_ADD:</span>
<span class="lineNum">    1140 </span>            :         case GF_SG_LSR_INSERT:
<span class="lineNum">    1141 </span><span class="lineCov">        254 :                 for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">    1142 </span><span class="lineCov">        192 :                         GF_XMLAttribute *att = (GF_XMLAttribute *)&amp;attributes[i];</span>
<span class="lineNum">    1143 </span><span class="lineCov">        192 :                         if (!strcmp(att-&gt;name, &quot;ref&quot;)) atNode = att-&gt;value;</span>
<span class="lineNum">    1144 </span><span class="lineCov">        130 :                         else if (!strcmp(att-&gt;name, &quot;operandElementId&quot;)) atOperandNode = att-&gt;value;</span>
<span class="lineNum">    1145 </span><span class="lineCov">        128 :                         else if (!strcmp(att-&gt;name, &quot;operandAttributeName&quot;)) atOperandAtt = att-&gt;value;</span>
<span class="lineNum">    1146 </span><span class="lineCov">        126 :                         else if (!strcmp(att-&gt;name, &quot;value&quot;)) atValue = att-&gt;value;</span>
<span class="lineNum">    1147 </span><span class="lineCov">         76 :                         else if (!strcmp(att-&gt;name, &quot;attributeName&quot;)) atAtt = att-&gt;value;</span>
<span class="lineNum">    1148 </span>            :                         /*replace only*/
<span class="lineNum">    1149 </span><span class="lineCov">         16 :                         else if (!strcmp(att-&gt;name, &quot;index&quot;)) index = atoi(att-&gt;value);</span>
<span class="lineNum">    1150 </span>            :                 }
<span class="lineNum">    1151 </span><span class="lineCov">         62 :                 if (!atNode) return svg_report(parser, GF_BAD_PARAM, &quot;Missing node ref for command&quot;);</span>
<span class="lineNum">    1152 </span><span class="lineCov">         62 :                 parser-&gt;command-&gt;node = svg_find_node(parser, atNode);</span>
<span class="lineNum">    1153 </span><span class="lineCov">         62 :                 if (!parser-&gt;command-&gt;node) return svg_report(parser, GF_BAD_PARAM, &quot;Cannot find node node ref %s for command&quot;, atNode);</span>
<span class="lineNum">    1154 </span>            :                 /*child or node replacement*/
<span class="lineNum">    1155 </span><span class="lineCov">         62 :                 if ( (is_replace || (parser-&gt;command-&gt;tag==GF_SG_LSR_INSERT)) &amp;&amp; (!atAtt || !strcmp(atAtt, &quot;children&quot;)) ) {</span>
<span class="lineNum">    1156 </span><span class="lineCov">          6 :                         field = gf_sg_command_field_new(parser-&gt;command);</span>
<span class="lineNum">    1157 </span><span class="lineCov">          6 :                         field-&gt;pos = index;</span>
<span class="lineNum">    1158 </span><span class="lineCov">          6 :                         if (atAtt) field-&gt;fieldIndex = TAG_LSR_ATT_children;</span>
<span class="lineNum">    1159 </span><span class="lineCov">          6 :                         gf_node_register(parser-&gt;command-&gt;node, NULL);</span>
<span class="lineNum">    1160 </span><span class="lineCov">          6 :                         return GF_OK;</span>
<span class="lineNum">    1161 </span>            :                 }
<span class="lineNum">    1162 </span><span class="lineCov">         56 :                 if (!atAtt) return svg_report(parser, GF_BAD_PARAM, &quot;Missing attribute name for command&quot;);</span>
<span class="lineNum">    1163 </span><span class="lineCov">         56 :                 if (!strcmp(atAtt, &quot;textContent&quot;)) {</span>
<span class="lineNum">    1164 </span><span class="lineCov">          4 :                         field = gf_sg_command_field_new(parser-&gt;command);</span>
<span class="lineNum">    1165 </span><span class="lineCov">          4 :                         field-&gt;pos = -1;</span>
<span class="lineNum">    1166 </span><span class="lineCov">          4 :                         field-&gt;fieldIndex = (u32) -1;</span>
<span class="lineNum">    1167 </span><span class="lineCov">          4 :                         field-&gt;fieldType = DOM_String_datatype;</span>
<span class="lineNum">    1168 </span><span class="lineCov">          4 :                         gf_node_register(parser-&gt;command-&gt;node, NULL);</span>
<span class="lineNum">    1169 </span><span class="lineCov">          4 :                         if (atValue) {</span>
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :                                 field-&gt;field_ptr = gf_svg_create_attribute_value(field-&gt;fieldType);</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :                                 *(SVG_String *)field-&gt;field_ptr = gf_strdup(atValue);</span>
<span class="lineNum">    1172 </span>            :                         }
<span class="lineNum">    1173 </span>            :                         return GF_OK;
<span class="lineNum">    1174 </span>            :                 }
<span class="lineNum">    1175 </span><span class="lineCov">         52 :                 if (!strcmp(atAtt, &quot;scale&quot;) || !strcmp(atAtt, &quot;translation&quot;) || !strcmp(atAtt, &quot;rotation&quot;)) {</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :                         if (!strcmp(atAtt, &quot;scale&quot;)) {</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :                                 info.fieldType = SVG_Transform_Scale_datatype;</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :                                 info.fieldIndex = TAG_LSR_ATT_scale;</span>
<span class="lineNum">    1179 </span>            :                         }
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :                         else if (!strcmp(atAtt, &quot;translation&quot;)) {</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :                                 info.fieldType = SVG_Transform_Translate_datatype;</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :                                 info.fieldIndex = TAG_LSR_ATT_translation;</span>
<span class="lineNum">    1183 </span>            :                         }
<span class="lineNum">    1184 </span>            :                         else /*if (!strcmp(atAtt, &quot;rotation&quot;)) */ {
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :                                 info.fieldType = SVG_Transform_Rotate_datatype;</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :                                 info.fieldIndex = TAG_LSR_ATT_rotation;</span>
<span class="lineNum">    1187 </span>            :                         }
<span class="lineNum">    1188 </span>            :                 } else {
<span class="lineNum">    1189 </span>            :                         /*FIXME - handle namespace properly here !!*/
<span class="lineNum">    1190 </span><span class="lineCov">         52 :                         info.fieldIndex = gf_xml_get_attribute_tag(parser-&gt;command-&gt;node, atAtt, (strchr(atAtt, ':')==NULL) ? parser-&gt;current_ns : 0);</span>
<span class="lineNum">    1191 </span><span class="lineCov">         52 :                         info.fieldType = gf_xml_get_attribute_type(info.fieldIndex);</span>
<span class="lineNum">    1192 </span>            : 
<span class="lineNum">    1193 </span>            : #ifndef GPAC_DISABLE_LASER
<span class="lineNum">    1194 </span>            :                         /*
<span class="lineNum">    1195 </span>            :                                                 if (gf_lsr_anim_type_from_attribute(info.fieldIndex)&lt;0) {
<span class="lineNum">    1196 </span>            :                                                         return svg_report(parser, GF_BAD_PARAM, &quot;Attribute %s of element %s is not updatable\n&quot;, atAtt, gf_node_get_class_name(parser-&gt;command-&gt;node));
<span class="lineNum">    1197 </span>            :                                                 }
<span class="lineNum">    1198 </span>            :                         */
<span class="lineNum">    1199 </span>            : #endif /*GPAC_DISABLE_LASER*/
<span class="lineNum">    1200 </span>            :                 }
<span class="lineNum">    1201 </span>            : 
<span class="lineNum">    1202 </span>            :                 opNode = NULL;
<span class="lineNum">    1203 </span><span class="lineCov">         52 :                 if (atOperandNode) {</span>
<span class="lineNum">    1204 </span><span class="lineCov">          2 :                         opNode = gf_sg_find_node_by_name(parser-&gt;load-&gt;scene_graph, atOperandNode);</span>
<span class="lineNum">    1205 </span><span class="lineCov">          2 :                         if (!opNode) return svg_report(parser, GF_BAD_PARAM, &quot;Cannot find operand element %s for command&quot;, atOperandNode);</span>
<span class="lineNum">    1206 </span>            :                 }
<span class="lineNum">    1207 </span><span class="lineCov">         52 :                 if (!atValue &amp;&amp; (!atOperandNode || !atOperandAtt) ) return svg_report(parser, GF_BAD_PARAM, &quot;Missing attribute value for command&quot;);</span>
<span class="lineNum">    1208 </span><span class="lineCov">         52 :                 field = gf_sg_command_field_new(parser-&gt;command);</span>
<span class="lineNum">    1209 </span><span class="lineCov">         52 :                 field-&gt;pos = index;</span>
<span class="lineNum">    1210 </span><span class="lineCov">         52 :                 field-&gt;fieldIndex = info.fieldIndex;</span>
<span class="lineNum">    1211 </span><span class="lineCov">         52 :                 field-&gt;fieldType = info.fieldType;</span>
<span class="lineNum">    1212 </span><span class="lineCov">         52 :                 if (atValue) {</span>
<span class="lineNum">    1213 </span>            :                         GF_FieldInfo nf;
<span class="lineNum">    1214 </span><span class="lineCov">         50 :                         nf.fieldType = info.fieldType;</span>
<span class="lineNum">    1215 </span><span class="lineCov">         50 :                         field-&gt;field_ptr = nf.far_ptr = gf_svg_create_attribute_value(info.fieldType);</span>
<span class="lineNum">    1216 </span><span class="lineCov">         50 :                         if (field-&gt;field_ptr) {</span>
<span class="lineNum">    1217 </span><span class="lineCov">         50 :                                 gf_svg_parse_attribute(parser-&gt;command-&gt;node, &amp;nf, atValue, (u8) info.fieldType);</span>
<span class="lineNum">    1218 </span><span class="lineCov">         50 :                                 if (info.fieldType==XMLRI_datatype)</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :                                         svg_process_media_href(parser, parser-&gt;command-&gt;node, (XMLRI*)field-&gt;field_ptr);</span>
<span class="lineNum">    1220 </span>            :                         }
<span class="lineNum">    1221 </span><span class="lineCov">          2 :                 } else if (opNode) {</span>
<span class="lineNum">    1222 </span><span class="lineCov">          2 :                         parser-&gt;command-&gt;fromNodeID = gf_node_get_id(opNode);</span>
<span class="lineNum">    1223 </span>            :                         /*FIXME - handle namespace properly here !!*/
<span class="lineNum">    1224 </span><span class="lineCov">          2 :                         parser-&gt;command-&gt;fromFieldIndex = gf_xml_get_attribute_tag(opNode, atOperandAtt, parser-&gt;current_ns);</span>
<span class="lineNum">    1225 </span>            :                 }
<span class="lineNum">    1226 </span><span class="lineCov">         52 :                 gf_node_register(parser-&gt;command-&gt;node, NULL);</span>
<span class="lineNum">    1227 </span><span class="lineCov">         52 :                 return GF_OK;</span>
<span class="lineNum">    1228 </span>            :         case GF_SG_LSR_ACTIVATE:
<span class="lineNum">    1229 </span>            :         case GF_SG_LSR_DEACTIVATE:
<span class="lineNum">    1230 </span><span class="lineCov">          4 :                 for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">    1231 </span><span class="lineCov">          4 :                         GF_XMLAttribute *att = (GF_XMLAttribute *) &amp;attributes[i];</span>
<span class="lineNum">    1232 </span><span class="lineCov">          4 :                         if (!strcmp(att-&gt;name, &quot;ref&quot;)) atNode = att-&gt;value;</span>
<span class="lineNum">    1233 </span>            :                 }
<span class="lineNum">    1234 </span><span class="lineCov">          4 :                 if (!atNode) return svg_report(parser, GF_BAD_PARAM, &quot;Missing node ref for command&quot;);</span>
<span class="lineNum">    1235 </span>            :                 /*should be a XML IDREF, not an XML IRI*/
<span class="lineNum">    1236 </span><span class="lineCov">          4 :                 if (atNode[0]=='#') atNode++;</span>
<span class="lineNum">    1237 </span><span class="lineCov">          4 :                 parser-&gt;command-&gt;node = svg_find_node(parser, atNode);</span>
<span class="lineNum">    1238 </span><span class="lineCov">          4 :                 if (!parser-&gt;command-&gt;node) return svg_report(parser, GF_BAD_PARAM, &quot;Cannot find node ref %s for command&quot;, atNode);</span>
<span class="lineNum">    1239 </span><span class="lineCov">          4 :                 gf_node_register(parser-&gt;command-&gt;node, NULL);</span>
<span class="lineNum">    1240 </span>            : 
<span class="lineNum">    1241 </span>            :                 /*switch to V2*/
<span class="lineNum">    1242 </span><span class="lineCov">          4 :                 svg_lsr_set_v2(parser);</span>
<span class="lineNum">    1243 </span>            : 
<span class="lineNum">    1244 </span><span class="lineCov">          4 :                 return GF_OK;</span>
<span class="lineNum">    1245 </span>            :         case GF_SG_LSR_SEND_EVENT:
<span class="lineNum">    1246 </span><span class="lineCov">        290 :                 for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">    1247 </span><span class="lineCov">        290 :                         GF_XMLAttribute *att = (GF_XMLAttribute *) &amp;attributes[i];</span>
<span class="lineNum">    1248 </span><span class="lineCov">        290 :                         if (!strcmp(att-&gt;name, &quot;ref&quot;)) atNode = att-&gt;value;</span>
<span class="lineNum">    1249 </span><span class="lineCov">        182 :                         else if (!strcmp(att-&gt;name, &quot;event&quot;)) atEvent = att-&gt;value;</span>
<span class="lineNum">    1250 </span><span class="lineCov">         74 :                         else if (!strcmp(att-&gt;name, &quot;pointvalue&quot;)) atPoint = att-&gt;value;</span>
<span class="lineNum">    1251 </span><span class="lineCov">         60 :                         else if (!strcmp(att-&gt;name, &quot;intvalue&quot;)) atInteger = att-&gt;value;</span>
<span class="lineNum">    1252 </span><span class="lineCov">         50 :                         else if (!strcmp(att-&gt;name, &quot;stringvalue&quot;)) atString = att-&gt;value;</span>
<span class="lineNum">    1253 </span>            :                 }
<span class="lineNum">    1254 </span>            : 
<span class="lineNum">    1255 </span><span class="lineCov">        108 :                 if (!atEvent) return svg_report(parser, GF_BAD_PARAM, &quot;Missing event name for command&quot;);</span>
<span class="lineNum">    1256 </span><span class="lineCov">        108 :                 if (!atNode) return svg_report(parser, GF_BAD_PARAM, &quot;Missing node ref for command&quot;);</span>
<span class="lineNum">    1257 </span>            :                 /*should be a XML IDREF, not an XML IRI*/
<span class="lineNum">    1258 </span><span class="lineCov">        108 :                 if (atNode[0]=='#') atNode++;</span>
<span class="lineNum">    1259 </span><span class="lineCov">        108 :                 parser-&gt;command-&gt;node = svg_find_node(parser, atNode);</span>
<span class="lineNum">    1260 </span><span class="lineCov">        108 :                 if (!parser-&gt;command-&gt;node) return svg_report(parser, GF_BAD_PARAM, &quot;Cannot find node node ref %s for command&quot;, atNode);</span>
<span class="lineNum">    1261 </span><span class="lineCov">        108 :                 gf_node_register(parser-&gt;command-&gt;node, NULL);</span>
<span class="lineNum">    1262 </span>            : 
<span class="lineNum">    1263 </span><span class="lineCov">        108 :                 parser-&gt;command-&gt;send_event_name = gf_dom_event_type_by_name(atEvent);</span>
<span class="lineNum">    1264 </span>            : 
<span class="lineNum">    1265 </span><span class="lineCov">        108 :                 parser-&gt;command-&gt;send_event_integer = 0;</span>
<span class="lineNum">    1266 </span><span class="lineCov">        108 :                 if (atString) {</span>
<span class="lineNum">    1267 </span><span class="lineCov">         50 :                         u32 key = gf_dom_get_key_type(atString);</span>
<span class="lineNum">    1268 </span><span class="lineCov">         50 :                         if (key == GF_KEY_UNIDENTIFIED) {</span>
<span class="lineNum">    1269 </span><span class="lineCov">          2 :                                 parser-&gt;command-&gt;send_event_string = gf_strdup(atString);</span>
<span class="lineNum">    1270 </span>            :                         } else {
<span class="lineNum">    1271 </span><span class="lineCov">         48 :                                 parser-&gt;command-&gt;send_event_integer = key;</span>
<span class="lineNum">    1272 </span>            :                         }
<span class="lineNum">    1273 </span>            :                 }
<span class="lineNum">    1274 </span><span class="lineCov">        118 :                 if (atInteger) parser-&gt;command-&gt;send_event_integer = atoi(atInteger);</span>
<span class="lineNum">    1275 </span><span class="lineCov">        108 :                 if (atPoint) {</span>
<span class="lineNum">    1276 </span>            :                         SVG_Point pt;
<span class="lineNum">    1277 </span><span class="lineCov">         14 :                         svg_parse_point(&amp;pt, atPoint);</span>
<span class="lineNum">    1278 </span><span class="lineCov">         14 :                         parser-&gt;command-&gt;send_event_x = FIX2INT(pt.x);</span>
<span class="lineNum">    1279 </span><span class="lineCov">         14 :                         parser-&gt;command-&gt;send_event_y = FIX2INT(pt.y);</span>
<span class="lineNum">    1280 </span>            :                 }
<span class="lineNum">    1281 </span>            :                 return GF_OK;
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :         default:</span>
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :                 return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1284 </span>            :         }
<span class="lineNum">    1285 </span>            : }
<a name="1286"><span class="lineNum">    1286 </span>            : </a>
<span class="lineNum">    1287 </span>            : 
<span class="lineNum">    1288 </span><span class="lineCov">        442 : static u32 lsr_get_command_by_name(const char *name)</span>
<span class="lineNum">    1289 </span>            : {
<span class="lineNum">    1290 </span><span class="lineCov">        442 :         if (!strcmp(name, &quot;NewScene&quot;)) return GF_SG_LSR_NEW_SCENE;</span>
<span class="lineNum">    1291 </span><span class="lineCov">        438 :         else if (!strcmp(name, &quot;RefreshScene&quot;)) return GF_SG_LSR_REFRESH_SCENE;</span>
<span class="lineNum">    1292 </span><span class="lineCov">        438 :         else if (!strcmp(name, &quot;Add&quot;)) return GF_SG_LSR_ADD;</span>
<span class="lineNum">    1293 </span><span class="lineCov">        438 :         else if (!strcmp(name, &quot;Replace&quot;)) return GF_SG_LSR_REPLACE;</span>
<span class="lineNum">    1294 </span><span class="lineCov">        328 :         else if (!strcmp(name, &quot;Delete&quot;)) return GF_SG_LSR_DELETE;</span>
<span class="lineNum">    1295 </span><span class="lineCov">        318 :         else if (!strcmp(name, &quot;Insert&quot;)) return GF_SG_LSR_INSERT;</span>
<span class="lineNum">    1296 </span><span class="lineCov">        310 :         else if (!strcmp(name, &quot;Restore&quot;)) return GF_SG_LSR_RESTORE;</span>
<span class="lineNum">    1297 </span><span class="lineCov">        310 :         else if (!strcmp(name, &quot;Save&quot;)) return GF_SG_LSR_SAVE;</span>
<span class="lineNum">    1298 </span><span class="lineCov">        310 :         else if (!strcmp(name, &quot;Clean&quot;)) return GF_SG_LSR_CLEAN;</span>
<span class="lineNum">    1299 </span><span class="lineCov">        310 :         else if (!strcmp(name, &quot;SendEvent&quot;)) return GF_SG_LSR_SEND_EVENT;</span>
<span class="lineNum">    1300 </span><span class="lineCov">         94 :         else if (!strcmp(name, &quot;Activate&quot;)) return GF_SG_LSR_ACTIVATE;</span>
<span class="lineNum">    1301 </span><span class="lineCov">         90 :         else if (!strcmp(name, &quot;Deactivate&quot;)) return GF_SG_LSR_DEACTIVATE;</span>
<span class="lineNum">    1302 </span><span class="lineCov">         86 :         return GF_SG_UNDEFINED;</span>
<a name="1303"><span class="lineNum">    1303 </span>            : }</a>
<span class="lineNum">    1304 </span>            : 
<span class="lineNum">    1305 </span><span class="lineCov">          2 : static GF_ESD *lsr_parse_header(GF_SVG_Parser *parser, const char *name, const char *name_space, const GF_XMLAttribute *attributes, u32 nb_attributes)</span>
<span class="lineNum">    1306 </span>            : {
<span class="lineNum">    1307 </span>            :         u32 i;
<span class="lineNum">    1308 </span><span class="lineCov">          2 :         if (!strcmp(name, &quot;LASeRHeader&quot;)) {</span>
<span class="lineNum">    1309 </span>            :                 GF_ESD *esd;
<span class="lineNum">    1310 </span><span class="lineCov">          2 :                 GF_LASERConfig *lsrc = (GF_LASERConfig *) gf_odf_desc_new(GF_ODF_LASER_CFG_TAG);</span>
<span class="lineNum">    1311 </span><span class="lineCov">         14 :                 for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">    1312 </span><span class="lineCov">         14 :                         GF_XMLAttribute *att = (GF_XMLAttribute *) &amp;attributes[i];</span>
<span class="lineNum">    1313 </span><span class="lineCov">         14 :                         if (!strcmp(att-&gt;name, &quot;profile&quot;)) lsrc-&gt;profile = !strcmp(att-&gt;value, &quot;full&quot;) ? 1 : 0;</span>
<span class="lineNum">    1314 </span><span class="lineCov">         12 :                         else if (!strcmp(att-&gt;name, &quot;level&quot;)) lsrc-&gt;level = atoi(att-&gt;value);</span>
<span class="lineNum">    1315 </span><span class="lineCov">         14 :                         else if (!strcmp(att-&gt;name, &quot;resolution&quot;)) lsrc-&gt;resolution = atoi(att-&gt;value);</span>
<span class="lineNum">    1316 </span><span class="lineCov">         12 :                         else if (!strcmp(att-&gt;name, &quot;timeResolution&quot;)) lsrc-&gt;time_resolution = atoi(att-&gt;value);</span>
<span class="lineNum">    1317 </span><span class="lineCov">         10 :                         else if (!strcmp(att-&gt;name, &quot;coordBits&quot;)) lsrc-&gt;coord_bits = atoi(att-&gt;value);</span>
<span class="lineNum">    1318 </span><span class="lineCov">          6 :                         else if (!strcmp(att-&gt;name, &quot;scaleBits_minus_coordBits&quot;)) lsrc-&gt;scale_bits_minus_coord_bits = atoi(att-&gt;value);</span>
<span class="lineNum">    1319 </span><span class="lineCov">          8 :                         else if (!strcmp(att-&gt;name, &quot;colorComponentBits&quot;)) lsrc-&gt;colorComponentBits = atoi(att-&gt;value);</span>
<span class="lineNum">    1320 </span><span class="lineCov">          4 :                         else if (!strcmp(att-&gt;name, &quot;newSceneIndicator&quot;)) lsrc-&gt;newSceneIndicator = (!strcmp(att-&gt;value, &quot;yes&quot;) || !strcmp(att-&gt;value, &quot;true&quot;)) ? 1 : 0;</span>
<span class="lineNum">    1321 </span><span class="lineCov">          4 :                         else if (!strcmp(att-&gt;name, &quot;useFullRequestHost&quot;)) lsrc-&gt;fullRequestHost = (!strcmp(att-&gt;value, &quot;yes&quot;) || !strcmp(att-&gt;value, &quot;true&quot;)) ? 1 : 0;</span>
<span class="lineNum">    1322 </span><span class="lineCov">          2 :                         else if (!strcmp(att-&gt;name, &quot;pathComponents&quot;)) lsrc-&gt;fullRequestHost = atoi(att-&gt;value);</span>
<span class="lineNum">    1323 </span><span class="lineCov">          2 :                         else if (!strcmp(att-&gt;name, &quot;extensionIDBits&quot;)) lsrc-&gt;extensionIDBits = atoi(att-&gt;value);</span>
<span class="lineNum">    1324 </span>            :                         /*others are ignored in GPAC atm*/
<span class="lineNum">    1325 </span>            :                 }
<span class="lineNum">    1326 </span><span class="lineCov">          2 :                 esd = gf_odf_desc_esd_new(2);</span>
<span class="lineNum">    1327 </span><span class="lineCov">          2 :                 gf_odf_desc_del((GF_Descriptor *)esd-&gt;decoderConfig-&gt;decoderSpecificInfo);</span>
<span class="lineNum">    1328 </span><span class="lineCov">          2 :                 esd-&gt;decoderConfig-&gt;decoderSpecificInfo = (GF_DefaultDescriptor *) lsrc;</span>
<span class="lineNum">    1329 </span><span class="lineCov">          2 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_SCENE;</span>
<span class="lineNum">    1330 </span><span class="lineCov">          2 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GF_CODECID_LASER;</span>
<span class="lineNum">    1331 </span><span class="lineCov">          2 :                 esd-&gt;slConfig-&gt;timestampResolution = lsrc-&gt;time_resolution ? lsrc-&gt;time_resolution : 1000;</span>
<span class="lineNum">    1332 </span>            :                 return esd;
<span class="lineNum">    1333 </span>            :         }
<span class="lineNum">    1334 </span>            :         return NULL;
<span class="lineNum">    1335 </span>            : }
<a name="1336"><span class="lineNum">    1336 </span>            : </a>
<span class="lineNum">    1337 </span>            : 
<span class="lineNum">    1338 </span><span class="lineCov">       3817 : static void svg_node_start(void *sax_cbck, const char *name, const char *name_space, const GF_XMLAttribute *attributes, u32 nb_attributes)</span>
<span class="lineNum">    1339 </span>            : {
<span class="lineNum">    1340 </span>            : #ifndef SKIP_ALL
<span class="lineNum">    1341 </span>            :         GF_SVG_Parser *parser = (GF_SVG_Parser *)sax_cbck;
<span class="lineNum">    1342 </span>            :         SVG_NodeStack *stack, *parent;
<span class="lineNum">    1343 </span>            :         SVG_Element *elt;
<span class="lineNum">    1344 </span>            :         SVG_Element *cond = NULL;
<span class="lineNum">    1345 </span>            :         u32 xmlns;
<span class="lineNum">    1346 </span>            :         Bool has_ns;
<span class="lineNum">    1347 </span>            : 
<span class="lineNum">    1348 </span><span class="lineCov">       3817 :         parent = (SVG_NodeStack *)gf_list_last(parser-&gt;node_stack);</span>
<span class="lineNum">    1349 </span>            : 
<span class="lineNum">    1350 </span>            :         /*switch to conditional*/
<span class="lineNum">    1351 </span><span class="lineCov">       3817 :         if (parent &amp;&amp; parent-&gt;node-&gt;sgprivate-&gt;tag==TAG_LSR_conditional) {</span>
<span class="lineNum">    1352 </span>            :                 cond = parent-&gt;node;
<span class="lineNum">    1353 </span>            :                 parent = NULL;
<span class="lineNum">    1354 </span>            :         }
<span class="lineNum">    1355 </span>            : 
<span class="lineNum">    1356 </span>            :         /* If the loader was created with the DIMS type and this is the root element, restore the stream and AU
<span class="lineNum">    1357 </span>            :         context - in DIMS? we only have one stream an dcommands are stacked in the last AU of the stream*/
<span class="lineNum">    1358 </span><span class="lineCov">       3809 :         if (!parent &amp;&amp; (parser-&gt;load-&gt;type == GF_SM_LOAD_DIMS) &amp;&amp; parser-&gt;load-&gt;ctx) {</span>
<span class="lineNum">    1359 </span>            : 
<span class="lineNum">    1360 </span>            :                 /*if not created, do it now*/
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :                 if (!gf_list_count(parser-&gt;load-&gt;ctx-&gt;streams)) {</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :                         parser-&gt;laser_es = gf_sm_stream_new(parser-&gt;load-&gt;ctx, 1, GF_STREAM_SCENE, GF_CODECID_DIMS);</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :                         if (!parser-&gt;laser_es) {</span>
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1366 </span>            :                         }
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :                         parser-&gt;laser_es-&gt;timeScale = 1000;</span>
<span class="lineNum">    1368 </span>            :                         /* Create a default AU to behave as other streams (LASeR, BIFS)
<span class="lineNum">    1369 </span>            :                            but it is left empty, there is no notion of REPLACE Scene or NEw Scene,
<span class="lineNum">    1370 </span>            :                            the RAP is the graph */
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :                         parser-&gt;laser_au = gf_sm_stream_au_new(parser-&gt;laser_es, 0, 0, GF_TRUE);</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :                         if (!parser-&gt;laser_au) {</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1375 </span>            :                         }
<span class="lineNum">    1376 </span>            :                 } else {
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :                         parser-&gt;laser_es = gf_list_get(parser-&gt;load-&gt;ctx-&gt;streams, 0);</span>
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :                         parser-&gt;laser_au = gf_list_last(parser-&gt;laser_es-&gt;AUs);</span>
<span class="lineNum">    1379 </span>            :                 }
<span class="lineNum">    1380 </span>            :         }
<span class="lineNum">    1381 </span>            : 
<span class="lineNum">    1382 </span>            :         /*saf setup*/
<span class="lineNum">    1383 </span><span class="lineCov">       3817 :         if ((!parent &amp;&amp; (parser-&gt;load-&gt;type!=GF_SM_LOAD_SVG)) || cond) {</span>
<span class="lineNum">    1384 </span>            :                 u32 com_type;
<span class="lineNum">    1385 </span>            : 
<span class="lineNum">    1386 </span><span class="lineCov">        284 :                 has_ns=GF_FALSE;</span>
<span class="lineNum">    1387 </span><span class="lineCov">        284 :                 svg_check_namespace(parser, attributes, nb_attributes, &amp;has_ns);</span>
<span class="lineNum">    1388 </span>            : 
<span class="lineNum">    1389 </span>            :                 /*nothing to do, the context is already created*/
<span class="lineNum">    1390 </span><span class="lineCov">        284 :                 if (!strcmp(name, &quot;SAFSession&quot;)) return;</span>
<span class="lineNum">    1391 </span>            :                 /*nothing to do, wait for the laser (or other) header before creating stream)*/
<span class="lineNum">    1392 </span><span class="lineCov">        282 :                 if (!strcmp(name, &quot;sceneHeader&quot;)) return;</span>
<span class="lineNum">    1393 </span>            :                 /*nothing to do, wait for the laser (or other) header before creating stream)*/
<span class="lineNum">    1394 </span><span class="lineCov">        280 :                 if (!strcmp(name, &quot;LASeRHeader&quot;)) {</span>
<span class="lineNum">    1395 </span>            :                         GF_ESD *esd;
<span class="lineNum">    1396 </span>            : 
<span class="lineNum">    1397 </span><span class="lineCov">          2 :                         if (!parser-&gt;load-&gt;ctx) {</span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_BAD_PARAM, &quot;Invalid parser context&quot;);</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1400 </span>            :                         }
<span class="lineNum">    1401 </span><span class="lineCov">          2 :                         esd = lsr_parse_header(parser, name, name_space, attributes, nb_attributes);</span>
<span class="lineNum">    1402 </span><span class="lineCov">          2 :                         if (!esd) {</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_BAD_PARAM, &quot;Invalid LASER Header&quot;);</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1405 </span>            :                         }
<span class="lineNum">    1406 </span>            :                         /*TODO find a better way of assigning an ID to the laser stream...*/
<span class="lineNum">    1407 </span><span class="lineCov">          2 :                         esd-&gt;ESID = 1;</span>
<span class="lineNum">    1408 </span><span class="lineCov">          2 :                         parser-&gt;laser_es = gf_sm_stream_new(parser-&gt;load-&gt;ctx, esd-&gt;ESID, esd-&gt;decoderConfig-&gt;streamType, esd-&gt;decoderConfig-&gt;objectTypeIndication);</span>
<span class="lineNum">    1409 </span><span class="lineCov">          2 :                         if (!parser-&gt;laser_es) {</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1412 </span>            :                         }
<span class="lineNum">    1413 </span><span class="lineCov">          2 :                         if (!parser-&gt;load-&gt;ctx-&gt;root_od) {</span>
<span class="lineNum">    1414 </span><span class="lineCov">          2 :                                 parser-&gt;load-&gt;ctx-&gt;root_od = (GF_ObjectDescriptor *) gf_odf_desc_new(GF_ODF_IOD_TAG);</span>
<span class="lineNum">    1415 </span><span class="lineCov">          2 :                                 if (!parser-&gt;load-&gt;ctx-&gt;root_od) {</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :                                         svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :                                         return;</span>
<span class="lineNum">    1418 </span>            :                                 }
<span class="lineNum">    1419 </span>            :                         }
<span class="lineNum">    1420 </span><span class="lineCov">          2 :                         gf_list_add(parser-&gt;load-&gt;ctx-&gt;root_od-&gt;ESDescriptors, esd);</span>
<span class="lineNum">    1421 </span><span class="lineCov">          2 :                         parser-&gt;laser_es-&gt;timeScale = esd-&gt;slConfig-&gt;timestampResolution;</span>
<span class="lineNum">    1422 </span><span class="lineCov">          2 :                         return;</span>
<span class="lineNum">    1423 </span>            :                 }
<span class="lineNum">    1424 </span><span class="lineCov">        278 :                 if (!strcmp(name, &quot;sceneUnit&quot;) ) {</span>
<span class="lineNum">    1425 </span>            :                         u32 time, i;
<span class="lineNum">    1426 </span>            :                         Bool rap;
<span class="lineNum">    1427 </span>            :                         time = 0;
<span class="lineNum">    1428 </span>            :                         rap =  GF_FALSE;
<span class="lineNum">    1429 </span><span class="lineCov">          6 :                         if (!gf_list_count(parser-&gt;laser_es-&gt;AUs)) rap = GF_TRUE;</span>
<span class="lineNum">    1430 </span><span class="lineCov">          4 :                         for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">    1431 </span><span class="lineCov">          4 :                                 GF_XMLAttribute *att = (GF_XMLAttribute *) &amp;attributes[i];</span>
<span class="lineNum">    1432 </span><span class="lineCov">          8 :                                 if (!strcmp(att-&gt;name, &quot;time&quot;)) time = atoi(att-&gt;value);</span>
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;rap&quot;)) rap = !strcmp(att-&gt;value, &quot;yes&quot;) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1434 </span>            :                         }
<span class="lineNum">    1435 </span>            :                         /*create new laser unit*/
<span class="lineNum">    1436 </span><span class="lineCov">          6 :                         parser-&gt;laser_au = gf_sm_stream_au_new(parser-&gt;laser_es, time, 0, rap);</span>
<span class="lineNum">    1437 </span><span class="lineCov">          6 :                         if (!parser-&gt;laser_au) {</span>
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1440 </span>            :                         }
<span class="lineNum">    1441 </span>            :                         return;
<span class="lineNum">    1442 </span>            :                 }
<span class="lineNum">    1443 </span>            : 
<span class="lineNum">    1444 </span><span class="lineCov">        272 :                 if (!strcmp(name, &quot;StreamHeader&quot;) || !strcmp(name, &quot;RemoteStreamHeader&quot;)</span>
<span class="lineNum">    1445 </span>            :                         /*SAF &amp; SAFML are just a pain ...*/
<span class="lineNum">    1446 </span><span class="lineCov">        272 :                         || !strcmp(name, &quot;mediaHeader&quot;) || !strcmp(name, &quot;imageHeader&quot;)</span>
<span class="lineNum">    1447 </span>            :                    ) {
<span class="lineNum">    1448 </span>            :                         char *url = NULL;
<span class="lineNum">    1449 </span>            :                         char *src = NULL;
<span class="lineNum">    1450 </span>            :                         const char *ID = NULL;
<span class="lineNum">    1451 </span>            :                         u32 time, codecid, ST, i, ts_res;
<span class="lineNum">    1452 </span>            :                         GF_ODUpdate *odU;
<span class="lineNum">    1453 </span>            :                         GF_ObjectDescriptor *od;
<span class="lineNum">    1454 </span>            :                         SVG_SAFExternalStream*st;
<span class="lineNum">    1455 </span>            :                         /*create a SAF stream*/
<span class="lineNum">    1456 </span><span class="lineCov">          2 :                         if (!parser-&gt;saf_es &amp;&amp; parser-&gt;load-&gt;ctx) {</span>
<span class="lineNum">    1457 </span><span class="lineCov">          2 :                                 GF_ESD *esd = (GF_ESD*)gf_odf_desc_esd_new(2);</span>
<span class="lineNum">    1458 </span><span class="lineCov">          2 :                                 esd-&gt;ESID = 0xFFFE;</span>
<span class="lineNum">    1459 </span><span class="lineCov">          2 :                                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_OD;</span>
<span class="lineNum">    1460 </span><span class="lineCov">          2 :                                 esd-&gt;decoderConfig-&gt;objectTypeIndication = 1;</span>
<span class="lineNum">    1461 </span><span class="lineCov">          2 :                                 parser-&gt;saf_es = gf_sm_stream_new(parser-&gt;load-&gt;ctx, esd-&gt;ESID, GF_STREAM_OD, GF_CODECID_OD_V1);</span>
<span class="lineNum">    1462 </span><span class="lineCov">          2 :                                 if (!parser-&gt;saf_es) {</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :                                         svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :                                         return;</span>
<span class="lineNum">    1465 </span>            :                                 }
<span class="lineNum">    1466 </span><span class="lineCov">          2 :                                 if (!parser-&gt;load-&gt;ctx-&gt;root_od) {</span>
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :                                         parser-&gt;load-&gt;ctx-&gt;root_od = (GF_ObjectDescriptor *) gf_odf_desc_new(GF_ODF_IOD_TAG);</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :                                         if (!parser-&gt;load-&gt;ctx-&gt;root_od) {</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :                                                 svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :                                                 return;</span>
<span class="lineNum">    1471 </span>            :                                         }
<span class="lineNum">    1472 </span>            :                                 }
<span class="lineNum">    1473 </span><span class="lineCov">          2 :                                 parser-&gt;saf_es-&gt;timeScale = 1000;</span>
<span class="lineNum">    1474 </span><span class="lineCov">          2 :                                 gf_list_add(parser-&gt;load-&gt;ctx-&gt;root_od-&gt;ESDescriptors, esd);</span>
<span class="lineNum">    1475 </span>            :                         }
<span class="lineNum">    1476 </span>            :                         time = 0;
<span class="lineNum">    1477 </span>            :                         ts_res = 1000;
<span class="lineNum">    1478 </span>            :                         codecid = ST = 0;
<span class="lineNum">    1479 </span><span class="lineCov">          4 :                         for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">    1480 </span><span class="lineCov">          4 :                                 GF_XMLAttribute *att = (GF_XMLAttribute *) &amp;attributes[i];</span>
<span class="lineNum">    1481 </span><span class="lineCov">          4 :                                 if (!strcmp(att-&gt;name, &quot;time&quot;)) time = atoi(att-&gt;value);</span>
<span class="lineNum">    1482 </span><span class="lineCov">          4 :                                 else if (!strcmp(att-&gt;name, &quot;rap&quot;)) ;//rap = !strcmp(att-&gt;value, &quot;yes&quot;) ? 1 : 0;</span>
<span class="lineNum">    1483 </span><span class="lineCov">          4 :                                 else if (!strcmp(att-&gt;name, &quot;url&quot;)) url = gf_strdup(att-&gt;value);</span>
<span class="lineNum">    1484 </span><span class="lineCov">          2 :                                 else if (!strcmp(att-&gt;name, &quot;streamID&quot;)) ID = att-&gt;value;</span>
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;objectTypeIndication&quot;)) codecid = atoi(att-&gt;value);</span>
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;codecID&quot;)) {</span>
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :                                         codecid = GF_4CC(att-&gt;value[0],att-&gt;value[1],att-&gt;value[2],att-&gt;value[3]);</span>
<span class="lineNum">    1488 </span>            :                                 }
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;streamType&quot;)) ST = atoi(att-&gt;value);</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;timeStampResolution&quot;)) ts_res = atoi(att-&gt;value);</span>
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;source&quot;)) src = att-&gt;value;</span>
<span class="lineNum">    1492 </span>            : 
<span class="lineNum">    1493 </span>            :                         }
<span class="lineNum">    1494 </span><span class="lineCov">          2 :                         if (!strcmp(name, &quot;imageHeader&quot;)) ST = 4;</span>
<span class="lineNum">    1495 </span>            : 
<span class="lineNum">    1496 </span>            :                         /*create new SAF stream*/
<span class="lineNum">    1497 </span><span class="lineCov">          2 :                         st = svg_saf_get_next_available_stream(parser);</span>
<span class="lineNum">    1498 </span><span class="lineCov">          2 :                         st-&gt;stream_name = ID ? gf_strdup(ID) : NULL;</span>
<span class="lineNum">    1499 </span>            : 
<span class="lineNum">    1500 </span>            :                         /*create new SAF unit*/
<span class="lineNum">    1501 </span><span class="lineCov">          2 :                         parser-&gt;saf_au = gf_sm_stream_au_new(parser-&gt;saf_es, time, 0, GF_FALSE);</span>
<span class="lineNum">    1502 </span><span class="lineCov">          2 :                         if (!parser-&gt;saf_au) {</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1505 </span>            :                         }
<span class="lineNum">    1506 </span>            : 
<span class="lineNum">    1507 </span><span class="lineCov">          2 :                         odU = (GF_ODUpdate *) gf_odf_com_new(GF_ODF_OD_UPDATE_TAG);</span>
<span class="lineNum">    1508 </span><span class="lineCov">          2 :                         if (!odU) {</span>
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1511 </span>            :                         }
<span class="lineNum">    1512 </span><span class="lineCov">          2 :                         gf_list_add(parser-&gt;saf_au-&gt;commands, odU);</span>
<span class="lineNum">    1513 </span><span class="lineCov">          2 :                         od = (GF_ObjectDescriptor *) gf_odf_desc_new(GF_ODF_OD_TAG);</span>
<span class="lineNum">    1514 </span><span class="lineCov">          2 :                         if (!od) {</span>
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1517 </span>            :                         }
<span class="lineNum">    1518 </span><span class="lineCov">          2 :                         gf_list_add(odU-&gt;objectDescriptors, od);</span>
<span class="lineNum">    1519 </span><span class="lineCov">          2 :                         od-&gt;objectDescriptorID = st-&gt;id;</span>
<span class="lineNum">    1520 </span>            : 
<span class="lineNum">    1521 </span><span class="lineCov">          2 :                         if (url) {</span>
<span class="lineNum">    1522 </span><span class="lineCov">          2 :                                 od-&gt;URLString = url;</span>
<span class="lineNum">    1523 </span>            :                         } else {
<span class="lineNum">    1524 </span>            :                                 GF_MuxInfo *mux;
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :                                 GF_ESD *esd = (GF_ESD*)gf_odf_desc_esd_new(2);</span>
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :                                 if (!esd) {</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :                                         svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :                                         return;</span>
<span class="lineNum">    1529 </span>            :                                 }
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 :                                 gf_list_add(od-&gt;ESDescriptors, esd);</span>
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :                                 esd-&gt;decoderConfig-&gt;objectTypeIndication = codecid;</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :                                 esd-&gt;decoderConfig-&gt;streamType = ST;</span>
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :                                 esd-&gt;ESID = st-&gt;id;</span>
<span class="lineNum">    1534 </span>            : 
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :                                 mux = (GF_MuxInfo *)gf_odf_desc_new(GF_ODF_MUXINFO_TAG);</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :                                 if (!mux) {</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :                                         svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :                                         return;</span>
<span class="lineNum">    1539 </span>            :                                 }
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :                                 gf_list_add(esd-&gt;extensionDescriptors, mux);</span>
<span class="lineNum">    1541 </span>            : 
<span class="lineNum">    1542 </span>            :                                 /*global source for stream, don't use nhml dumping*/
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :                                 if (src) {</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :                                         mux-&gt;file_name = gf_strdup(src);</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :                                         st-&gt;nhml_info = NULL;</span>
<span class="lineNum">    1546 </span>            :                                 } else {
<span class="lineNum">    1547 </span>            :                                         FILE *nhml;
<span class="lineNum">    1548 </span>            :                                         char szName[1024];
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :                                         if (parser-&gt;load-&gt;localPath) {</span>
<span class="lineNum">    1550 </span>            :                                                 strcpy(szName, parser-&gt;load-&gt;localPath);
<span class="lineNum">    1551 </span>            :                                                 strcat(szName, &quot;/&quot;);
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :                                                 strcat(szName, ID ? ID : &quot;&quot;);</span>
<span class="lineNum">    1553 </span>            :                                         } else {
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :                                                 strcpy(szName, ID ? ID : &quot;&quot;);</span>
<span class="lineNum">    1555 </span>            :                                         }
<span class="lineNum">    1556 </span>            :                                         strcat(szName, &quot;_temp.nhml&quot;);
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 :                                         mux-&gt;file_name = gf_strdup(szName);</span>
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :                                         st-&gt;nhml_info = mux-&gt;file_name;</span>
<span class="lineNum">    1559 </span><span class="lineNoCov">          0 :                                         nhml = gf_fopen(st-&gt;nhml_info, &quot;wt&quot;);</span>
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :                                         if (nhml) {</span>
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :                                                 gf_fprintf(nhml, &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot; ?&gt;\n&quot;);</span>
<span class="lineNum">    1562 </span><span class="lineNoCov">          0 :                                                 gf_fprintf(nhml, &quot;&lt;NHNTStream version=\&quot;1.0\&quot; timeScale=\&quot;%d\&quot; streamType=\&quot;%d\&quot; objectTypeIndication=\&quot;%d\&quot; inRootOD=\&quot;no\&quot; trackID=\&quot;%d\&quot;&gt;\n&quot;, ts_res, ST, codecid, st-&gt;id);</span>
<span class="lineNum">    1563 </span><span class="lineNoCov">          0 :                                                 gf_fclose(nhml);</span>
<span class="lineNum">    1564 </span>            :                                         } else {
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :                                                 GF_LOG(GF_LOG_WARNING, GF_LOG_PARSER, (&quot;[LASeR Parser] Error opening nhml file %s while preparing import\n&quot;, st-&gt;nhml_info));</span>
<span class="lineNum">    1566 </span>            :                                         }
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :                                         mux-&gt;delete_file = GF_TRUE;</span>
<span class="lineNum">    1568 </span>            :                                 }
<span class="lineNum">    1569 </span>            :                         }
<span class="lineNum">    1570 </span>            :                         return;
<span class="lineNum">    1571 </span>            :                 }
<span class="lineNum">    1572 </span><span class="lineCov">        270 :                 if (!strcmp(name, &quot;mediaUnit&quot;) || !strcmp(name, &quot;imageUnit&quot;) ) {</span>
<span class="lineNum">    1573 </span>            :                         FILE *nhml;
<span class="lineNum">    1574 </span>            :                         char *id = NULL;
<span class="lineNum">    1575 </span>            :                         char *src = NULL;
<span class="lineNum">    1576 </span>            :                         SVG_SAFExternalStream*st;
<span class="lineNum">    1577 </span>            :                         u32 i, rap, time, offset, length;
<span class="lineNum">    1578 </span>            :                         rap = time = offset = length = 0;
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :                                 GF_XMLAttribute *att = (GF_XMLAttribute *) &amp;attributes[i];</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :                                 if (!strcmp(att-&gt;name, &quot;time&quot;)) time = atoi(att-&gt;value);</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;source&quot;)) src = att-&gt;value;</span>
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;ref&quot;)) id = att-&gt;value;</span>
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;rap&quot;)) rap = !strcmp(att-&gt;value, &quot;yes&quot;) ? 1 : 0;</span>
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;startOffset&quot;)) offset = atoi(att-&gt;value);</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :                                 else if (!strcmp(att-&gt;name, &quot;length&quot;)) length = atoi(att-&gt;value);</span>
<span class="lineNum">    1587 </span>            :                         }
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :                         st = svg_saf_get_stream(parser, 0, id);</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :                         if (!st || !st-&gt;nhml_info) {</span>
<span class="lineNum">    1590 </span>            :                                 return;
<span class="lineNum">    1591 </span>            :                         }
<span class="lineNum">    1592 </span><span class="lineNoCov">          0 :                         nhml = gf_fopen(st-&gt;nhml_info, &quot;a+t&quot;);</span>
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :                         gf_fprintf(nhml, &quot;&lt;NHNTSample &quot;);</span>
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :                         if (time) gf_fprintf(nhml, &quot;DTS=\&quot;%d\&quot; &quot;, time);</span>
<span class="lineNum">    1595 </span><span class="lineNoCov">          0 :                         if (length) gf_fprintf(nhml, &quot;dataLength=\&quot;%d\&quot; &quot;, length);</span>
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :                         if (offset) gf_fprintf(nhml, &quot;mediaOffset=\&quot;%d\&quot; &quot;, offset);</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :                         if (rap) gf_fprintf(nhml, &quot;isRAP=\&quot;yes\&quot; &quot;);</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :                         if (src) gf_fprintf(nhml, &quot;mediaFile=\&quot;%s\&quot; &quot;, src);</span>
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :                         gf_fprintf(nhml, &quot;/&gt;\n&quot;);</span>
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :                         gf_fclose(nhml);</span>
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    1602 </span>            :                 }
<span class="lineNum">    1603 </span><span class="lineCov">        270 :                 if (!strcmp(name, &quot;endOfStream&quot;) ) {</span>
<span class="lineNum">    1604 </span>            :                         FILE *nhml;
<span class="lineNum">    1605 </span>            :                         char *id = NULL;
<span class="lineNum">    1606 </span>            :                         u32 i;
<span class="lineNum">    1607 </span>            :                         SVG_SAFExternalStream*st;
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;nb_attributes; i++) {</span>
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :                                 GF_XMLAttribute *att = (GF_XMLAttribute *) &amp;attributes[i];</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :                                 if (!strcmp(att-&gt;name, &quot;ref&quot;)) id = att-&gt;value;</span>
<span class="lineNum">    1611 </span>            :                         }
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :                         st = svg_saf_get_stream(parser, 0, id);</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :                         if (!st || !st-&gt;nhml_info) {</span>
<span class="lineNum">    1614 </span>            :                                 return;
<span class="lineNum">    1615 </span>            :                         }
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 :                         nhml = gf_fopen(st-&gt;nhml_info, &quot;a+t&quot;);</span>
<span class="lineNum">    1617 </span><span class="lineNoCov">          0 :                         gf_fprintf(nhml, &quot;&lt;/NHNTStream&gt;\n&quot;);</span>
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :                         gf_fclose(nhml);</span>
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    1620 </span>            :                 }
<span class="lineNum">    1621 </span>            : 
<span class="lineNum">    1622 </span><span class="lineCov">        270 :                 if (!strcmp(name, &quot;endOfSAFSession&quot;) ) {</span>
<span class="lineNum">    1623 </span>            :                         return;
<span class="lineNum">    1624 </span>            :                 }
<span class="lineNum">    1625 </span>            : 
<span class="lineNum">    1626 </span><span class="lineCov">        268 :                 if ((parser-&gt;load-&gt;type==GF_SM_LOAD_XSR) &amp;&amp; !parser-&gt;laser_au &amp;&amp; !cond) {</span>
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :                         if (parser-&gt;load-&gt;flags &amp; GF_SM_LOAD_CONTEXT_READY) {</span>
<span class="lineNum">    1628 </span>            :                                 assert(parser-&gt;laser_es);
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :                                 parser-&gt;laser_au = gf_sm_stream_au_new(parser-&gt;laser_es, 0, 0, GF_FALSE);</span>
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :                                 if (!parser-&gt;laser_au) {</span>
<span class="lineNum">    1631 </span><span class="lineNoCov">          0 :                                         svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1632 </span><span class="lineNoCov">          0 :                                         return;</span>
<span class="lineNum">    1633 </span>            :                                 }
<span class="lineNum">    1634 </span>            :                         } else {
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_BAD_PARAM, &quot;LASeR sceneUnit not defined for command %s&quot;, name);</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1637 </span>            :                         }
<span class="lineNum">    1638 </span>            :                 }
<span class="lineNum">    1639 </span>            :                 /*command parsing*/
<span class="lineNum">    1640 </span><span class="lineCov">        268 :                 com_type = lsr_get_command_by_name(name);</span>
<span class="lineNum">    1641 </span><span class="lineCov">        268 :                 if (com_type != GF_SG_UNDEFINED) {</span>
<span class="lineNum">    1642 </span>            :                         SVG_NodeStack *top;
<span class="lineNum">    1643 </span>            :                         GF_Err e;
<span class="lineNum">    1644 </span><span class="lineCov">        182 :                         parser-&gt;command = gf_sg_command_new(parser-&gt;load-&gt;scene_graph, com_type);</span>
<span class="lineNum">    1645 </span><span class="lineCov">        182 :                         if (!parser-&gt;command) {</span>
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_OUT_OF_MEM, NULL);</span>
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1648 </span>            :                         }
<span class="lineNum">    1649 </span>            : 
<span class="lineNum">    1650 </span>            :                         /*this is likely a conditional start - update unknown depth level*/
<span class="lineNum">    1651 </span><span class="lineCov">        182 :                         top = (SVG_NodeStack*)gf_list_last(parser-&gt;node_stack);</span>
<span class="lineNum">    1652 </span><span class="lineCov">        182 :                         if (top) {</span>
<span class="lineNum">    1653 </span><span class="lineCov">          8 :                                 top-&gt;unknown_depth ++;</span>
<span class="lineNum">    1654 </span><span class="lineCov">          8 :                                 parser-&gt;command_depth++;</span>
<span class="lineNum">    1655 </span>            :                         }
<span class="lineNum">    1656 </span>            : 
<span class="lineNum">    1657 </span><span class="lineCov">        182 :                         e = lsr_parse_command(parser, attributes, nb_attributes);</span>
<span class="lineNum">    1658 </span><span class="lineCov">        182 :                         if (e!= GF_OK) {</span>
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :                                 parser-&gt;command-&gt;node = NULL;</span>
<span class="lineNum">    1660 </span><span class="lineNoCov">          0 :                                 gf_sg_command_del(parser-&gt;command);</span>
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 :                                 parser-&gt;command = NULL;</span>
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, (&quot;[LASeR Parser] Error parsing %s command - skipping\n&quot;, (parser-&gt;load-&gt;type==GF_SM_LOAD_XSR) ? &quot;LASeR&quot; : &quot;DIMS&quot;));</span>
<span class="lineNum">    1663 </span>            :                                 return;
<span class="lineNum">    1664 </span>            :                         }
<span class="lineNum">    1665 </span>            : 
<span class="lineNum">    1666 </span><span class="lineCov">        182 :                         if (cond) {</span>
<span class="lineNum">    1667 </span><span class="lineCov">          8 :                                 GF_DOMUpdates *up = cond-&gt;children ? (GF_DOMUpdates *)cond-&gt;children-&gt;node : NULL;</span>
<span class="lineNum">    1668 </span><span class="lineCov">          6 :                                 if (!up) {</span>
<span class="lineNum">    1669 </span><span class="lineCov">          2 :                                         up = gf_dom_add_updates_node((GF_Node*)cond);</span>
<span class="lineNum">    1670 </span>            : 
<span class="lineNum">    1671 </span><span class="lineCov">          2 :                                         if (parser-&gt;load-&gt;flags &amp; GF_SM_LOAD_FOR_PLAYBACK) {</span>
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :                                                 gf_node_set_callback_function((GF_Node*)up, xsr_exec_command_list);</span>
<span class="lineNum">    1673 </span>            :                                         }
<span class="lineNum">    1674 </span>            :                                 }
<span class="lineNum">    1675 </span><span class="lineCov">          8 :                                 gf_list_add(up-&gt;updates, parser-&gt;command);</span>
<span class="lineNum">    1676 </span><span class="lineCov">        174 :                         } else if (parser-&gt;laser_au) {</span>
<span class="lineNum">    1677 </span><span class="lineCov">        174 :                                 gf_list_add(parser-&gt;laser_au-&gt;commands, parser-&gt;command);</span>
<span class="lineNum">    1678 </span>            :                         }
<span class="lineNum">    1679 </span><span class="lineCov">        182 :                         switch (com_type) {</span>
<span class="lineNum">    1680 </span><span class="lineCov">          2 :                         case GF_SG_LSR_NEW_SCENE:</span>
<span class="lineNum">    1681 </span>            :                         case GF_SG_LSR_REFRESH_SCENE:
<span class="lineNum">    1682 </span><span class="lineCov">          2 :                                 if (parser-&gt;laser_au) parser-&gt;laser_au-&gt;flags |= GF_SM_AU_RAP;</span>
<span class="lineNum">    1683 </span>            :                                 break;
<span class="lineNum">    1684 </span>            :                         }
<span class="lineNum">    1685 </span><span class="lineCov">        182 :                         parser-&gt;current_ns = GF_XMLNS_SVG;</span>
<span class="lineNum">    1686 </span><span class="lineCov">        182 :                         return;</span>
<span class="lineNum">    1687 </span>            :                 }
<span class="lineNum">    1688 </span>            :         }
<span class="lineNum">    1689 </span>            : 
<span class="lineNum">    1690 </span><span class="lineCov">       3619 :         if (!parent &amp;&amp; !parser-&gt;command &amp;&amp; (parser-&gt;load-&gt;flags &amp; GF_SM_LOAD_CONTEXT_STREAMING)) {</span>
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :                 gf_sg_reset(parser-&gt;load-&gt;scene_graph);</span>
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :                 parser-&gt;has_root = 0;</span>
<span class="lineNum">    1693 </span>            :         }
<span class="lineNum">    1694 </span>            : 
<span class="lineNum">    1695 </span>            :         /*something not supported happened (bad command name, bad root, ...) */
<span class="lineNum">    1696 </span><span class="lineCov">       3619 :         if ((parser-&gt;has_root==1) &amp;&amp; !parent &amp;&amp; !parser-&gt;command)</span>
<span class="lineNum">    1697 </span>            :                 return;
<span class="lineNum">    1698 </span>            : 
<span class="lineNum">    1699 </span><span class="lineCov">       3619 :         xmlns = parser-&gt;current_ns;</span>
<span class="lineNum">    1700 </span><span class="lineCov">       3619 :         has_ns = GF_FALSE;</span>
<span class="lineNum">    1701 </span>            : 
<span class="lineNum">    1702 </span><span class="lineCov">       3619 :         elt = svg_parse_element(parser, name, name_space, attributes, nb_attributes, parent, &amp;has_ns);</span>
<span class="lineNum">    1703 </span><span class="lineCov">       3619 :         if (!elt) {</span>
<span class="lineNum">    1704 </span><span class="lineNoCov">          0 :                 if (parent) parent-&gt;unknown_depth++;</span>
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :                 else if (cond) parser-&gt;command_depth++;</span>
<span class="lineNum">    1706 </span>            :                 return;
<span class="lineNum">    1707 </span>            :         }
<span class="lineNum">    1708 </span><span class="lineCov">       3619 :         GF_SAFEALLOC(stack, SVG_NodeStack);</span>
<span class="lineNum">    1709 </span><span class="lineCov">       3619 :         if (!stack) {</span>
<span class="lineNum">    1710 </span><span class="lineNoCov">          0 :                 parser-&gt;last_error = GF_OUT_OF_MEM;</span>
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1712 </span>            :         }
<span class="lineNum">    1713 </span><span class="lineCov">       3619 :         stack-&gt;node = elt;</span>
<span class="lineNum">    1714 </span><span class="lineCov">       3619 :         stack-&gt;current_ns = xmlns;</span>
<span class="lineNum">    1715 </span><span class="lineCov">       3619 :         stack-&gt;has_ns = has_ns;</span>
<span class="lineNum">    1716 </span><span class="lineCov">       3619 :         gf_list_add(parser-&gt;node_stack, stack);</span>
<span class="lineNum">    1717 </span>            : 
<span class="lineNum">    1718 </span><span class="lineCov">       3689 :         if ( (gf_node_get_tag((GF_Node *)elt) == TAG_SVG_svg) &amp;&amp;</span>
<span class="lineNum">    1719 </span><span class="lineCov">        140 :                 (!parser-&gt;has_root || (parser-&gt;command &amp;&amp; !parser-&gt;command-&gt;node) )</span>
<span class="lineNum">    1720 </span>            :            ) {
<span class="lineNum">    1721 </span>            : 
<span class="lineNum">    1722 </span><span class="lineNoCov">          0 :                 if (!parser-&gt;has_root) svg_init_root_element(parser, elt);</span>
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :                 if (parser-&gt;command) parser-&gt;command-&gt;node = (GF_Node*)elt;</span>
<span class="lineNum">    1724 </span><span class="lineCov">       3619 :         } else if (!parent &amp;&amp; parser-&gt;has_root &amp;&amp; parser-&gt;command) {</span>
<span class="lineNum">    1725 </span><span class="lineCov">         86 :                 GF_CommandField *field = (GF_CommandField *)gf_list_get(parser-&gt;command-&gt;command_fields, 0);</span>
<span class="lineNum">    1726 </span><span class="lineCov">         86 :                 if (field) {</span>
<span class="lineNum">    1727 </span>            :                         /*either not assigned or textContent*/
<span class="lineNum">    1728 </span><span class="lineCov">         84 :                         if (field-&gt;new_node &amp;&amp; (field-&gt;new_node-&gt;sgprivate-&gt;tag==TAG_DOMText)) {</span>
<span class="lineNum">    1729 </span><span class="lineCov">          4 :                                 gf_node_unregister(field-&gt;new_node, NULL);</span>
<span class="lineNum">    1730 </span><span class="lineCov">          4 :                                 field-&gt;new_node = NULL;</span>
<span class="lineNum">    1731 </span>            :                         }
<span class="lineNum">    1732 </span><span class="lineCov">         84 :                         if (field-&gt;new_node) {</span>
<span class="lineNum">    1733 </span><span class="lineCov">          4 :                                 field-&gt;field_ptr = &amp;field-&gt;node_list;</span>
<span class="lineNum">    1734 </span><span class="lineCov">          4 :                                 gf_node_list_add_child(&amp; field-&gt;node_list, field-&gt;new_node);</span>
<span class="lineNum">    1735 </span><span class="lineCov">          4 :                                 field-&gt;new_node = NULL;</span>
<span class="lineNum">    1736 </span><span class="lineCov">          4 :                                 gf_node_list_add_child( &amp; field-&gt;node_list, (GF_Node*) elt);</span>
<span class="lineNum">    1737 </span><span class="lineCov">         80 :                         } else if (field-&gt;node_list) {</span>
<span class="lineNum">    1738 </span><span class="lineCov">         74 :                                 gf_node_list_add_child(&amp; field-&gt;node_list, (GF_Node*) elt);</span>
<span class="lineNum">    1739 </span>            :                         } else {
<span class="lineNum">    1740 </span><span class="lineCov">          6 :                                 field-&gt;new_node = (GF_Node*)elt;</span>
<span class="lineNum">    1741 </span><span class="lineCov">          6 :                                 field-&gt;field_ptr = &amp;field-&gt;new_node;</span>
<span class="lineNum">    1742 </span>            :                         }
<span class="lineNum">    1743 </span>            :                 } else {
<span class="lineNum">    1744 </span>            :                         assert(parser-&gt;command-&gt;tag==GF_SG_LSR_NEW_SCENE);
<span class="lineNum">    1745 </span>            :                         assert(gf_node_get_tag((GF_Node *)elt) == TAG_SVG_svg);
<span class="lineNum">    1746 </span><span class="lineCov">          2 :                         if(!parser-&gt;command-&gt;node)</span>
<span class="lineNum">    1747 </span><span class="lineNoCov">          0 :                                 parser-&gt;command-&gt;node = (GF_Node *)elt;</span>
<span class="lineNum">    1748 </span>            :                 }
<span class="lineNum">    1749 </span><span class="lineCov">       3533 :         } else if (!parser-&gt;has_root ) {</span>
<span class="lineNum">    1750 </span><span class="lineNoCov">          0 :                 gf_list_del_item(parser-&gt;node_stack, stack);</span>
<span class="lineNum">    1751 </span><span class="lineNoCov">          0 :                 gf_free(stack);</span>
<span class="lineNum">    1752 </span><span class="lineNoCov">          0 :                 gf_node_unregister((GF_Node *)elt, NULL);</span>
<span class="lineNum">    1753 </span><span class="lineCov">       3533 :         } else if ((parser-&gt;has_root==2) &amp;&amp; !parser-&gt;fragment_root) {</span>
<span class="lineNum">    1754 </span><span class="lineNoCov">          0 :                 parser-&gt;fragment_root = (GF_Node *)elt;</span>
<span class="lineNum">    1755 </span>            :         }
<span class="lineNum">    1756 </span>            : #endif
<a name="1757"><span class="lineNum">    1757 </span>            : }</a>
<span class="lineNum">    1758 </span>            : 
<span class="lineNum">    1759 </span><span class="lineCov">       3817 : static void svg_node_end(void *sax_cbck, const char *name, const char *name_space)</span>
<span class="lineNum">    1760 </span>            : {
<span class="lineNum">    1761 </span>            : #ifndef SKIP_ALL
<span class="lineNum">    1762 </span>            : #ifdef SKIP_UNKNOWN_NODES
<span class="lineNum">    1763 </span>            :         u32 ns;
<span class="lineNum">    1764 </span>            : #endif
<span class="lineNum">    1765 </span>            :         GF_SVG_Parser *parser = (GF_SVG_Parser *)sax_cbck;
<span class="lineNum">    1766 </span><span class="lineCov">       3817 :         SVG_NodeStack *top = (SVG_NodeStack *)gf_list_last(parser-&gt;node_stack);</span>
<span class="lineNum">    1767 </span>            : 
<span class="lineNum">    1768 </span><span class="lineCov">       3817 :         if (!top) {</span>
<span class="lineNum">    1769 </span><span class="lineCov">        190 :                 if (parser-&gt;laser_au &amp;&amp; !strcmp(name, &quot;sceneUnit&quot;)) {</span>
<span class="lineNum">    1770 </span><span class="lineCov">          6 :                         parser-&gt;laser_au = NULL;</span>
<span class="lineNum">    1771 </span><span class="lineCov">          6 :                         return;</span>
<span class="lineNum">    1772 </span>            :                 }
<span class="lineNum">    1773 </span><span class="lineCov">        184 :                 if (parser-&gt;command) {</span>
<span class="lineNum">    1774 </span><span class="lineCov">        174 :                         u32 com_type = lsr_get_command_by_name(name);</span>
<span class="lineNum">    1775 </span><span class="lineCov">        174 :                         if (com_type == parser-&gt;command-&gt;tag) {</span>
<span class="lineNum">    1776 </span><span class="lineCov">        172 :                                 if (parser-&gt;load-&gt;type==GF_SM_LOAD_DIMS &amp;&amp; parser-&gt;load-&gt;flags &amp; GF_SM_LOAD_FOR_PLAYBACK) {</span>
<span class="lineNum">    1777 </span><span class="lineNoCov">          0 :                                         gf_sg_command_apply(parser-&gt;load-&gt;scene_graph, parser-&gt;command, 0);</span>
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :                                         gf_sg_command_del(parser-&gt;command);</span>
<span class="lineNum">    1779 </span>            :                                 }
<span class="lineNum">    1780 </span><span class="lineCov">        172 :                                 parser-&gt;command = NULL;</span>
<span class="lineNum">    1781 </span><span class="lineCov">        172 :                                 return;</span>
<span class="lineNum">    1782 </span>            :                         }
<span class="lineNum">    1783 </span>            :                 }
<span class="lineNum">    1784 </span>            :                 /*error*/
<span class="lineNum">    1785 </span>            :                 return;
<span class="lineNum">    1786 </span>            :         }
<span class="lineNum">    1787 </span>            : 
<span class="lineNum">    1788 </span>            : #ifdef SKIP_UNKNOWN_NODES
<span class="lineNum">    1789 </span>            :         ns = parser-&gt;current_ns;
<span class="lineNum">    1790 </span>            :         if (name_space)
<span class="lineNum">    1791 </span>            :                 ns = gf_sg_get_namespace_code(parser-&gt;load-&gt;scene_graph, (char *) name_space);
<span class="lineNum">    1792 </span>            : 
<span class="lineNum">    1793 </span>            :         /*only remove created nodes ... */
<span class="lineNum">    1794 </span>            :         if (gf_xml_get_element_tag(name, ns) != TAG_UndefinedNode)
<span class="lineNum">    1795 </span>            : #endif
<span class="lineNum">    1796 </span>            :         {
<span class="lineNum">    1797 </span>            :                 const char *the_name;
<span class="lineNum">    1798 </span>            :                 Bool mismatch = GF_FALSE;
<span class="lineNum">    1799 </span><span class="lineCov">       3627 :                 SVG_Element *node = top-&gt;node;</span>
<span class="lineNum">    1800 </span>            :                 /*check node name...*/
<span class="lineNum">    1801 </span><span class="lineCov">       3627 :                 the_name = gf_node_get_class_name((GF_Node *)node);</span>
<span class="lineNum">    1802 </span><span class="lineCov">       3627 :                 if (name_space &amp;&amp; strstr(the_name, name_space) &amp;&amp; strstr(the_name, name) ) {}</span>
<span class="lineNum">    1803 </span><span class="lineCov">       3583 :                 else if (!strcmp(the_name, name) ) {}</span>
<span class="lineNum">    1804 </span>            :                 else mismatch = GF_TRUE;
<span class="lineNum">    1805 </span>            : 
<span class="lineNum">    1806 </span>            :                 if (mismatch) {
<span class="lineNum">    1807 </span><span class="lineCov">          8 :                         if (top-&gt;unknown_depth) {</span>
<span class="lineNum">    1808 </span><span class="lineCov">          8 :                                 top-&gt;unknown_depth--;</span>
<span class="lineNum">    1809 </span><span class="lineCov">          8 :                                 return;</span>
<span class="lineNum">    1810 </span>            :                         } else {
<span class="lineNum">    1811 </span><span class="lineNoCov">          0 :                                 svg_report(parser, GF_BAD_PARAM, &quot;SVG depth mismatch: expecting &lt;/%s&gt; got &lt;/%s&gt;&quot;, the_name, name);</span>
<span class="lineNum">    1812 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1813 </span>            :                         }
<span class="lineNum">    1814 </span>            :                 }
<span class="lineNum">    1815 </span><span class="lineCov">       3619 :                 parser-&gt;current_ns = top-&gt;current_ns;</span>
<span class="lineNum">    1816 </span><span class="lineCov">       3619 :                 if (top-&gt;has_ns) gf_xml_pop_namespaces(top-&gt;node);</span>
<span class="lineNum">    1817 </span><span class="lineCov">       3619 :                 gf_free(top);</span>
<span class="lineNum">    1818 </span><span class="lineCov">       3619 :                 gf_list_rem_last(parser-&gt;node_stack);</span>
<span class="lineNum">    1819 </span>            : 
<span class="lineNum">    1820 </span><span class="lineCov">       3619 :                 if (parser-&gt;load-&gt;flags &amp; GF_SM_LOAD_FOR_PLAYBACK) {</span>
<span class="lineNum">    1821 </span><span class="lineCov">       2296 :                         switch (node-&gt;sgprivate-&gt;tag) {</span>
<span class="lineNum">    1822 </span><span class="lineCov">          1 :                         case TAG_SVG_animateMotion:</span>
<span class="lineNum">    1823 </span>            :                                 /*
<span class="lineNum">    1824 </span>            :                                 try to init animateMotion once all children have been parsed
<span class="lineNum">    1825 </span>            :                                 to make sure we get the mpath child if any, however, we are still not sure
<span class="lineNum">    1826 </span>            :                                 if the target is known. We can force initialisation
<span class="lineNum">    1827 </span>            :                                 because mpath children (if any have been parsed)
<span class="lineNum">    1828 </span>            :                                 */
<span class="lineNum">    1829 </span>            :                         {
<span class="lineNum">    1830 </span>            :                                 u32 i, count;
<span class="lineNum">    1831 </span>            :                                 SVG_DeferredAnimation *anim = NULL;
<span class="lineNum">    1832 </span><span class="lineCov">          1 :                                 count = gf_list_count(parser-&gt;deferred_animations);</span>
<span class="lineNum">    1833 </span><span class="lineCov">          3 :                                 for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">    1834 </span><span class="lineCov">          3 :                                         anim = gf_list_get(parser-&gt;deferred_animations, i);</span>
<span class="lineNum">    1835 </span><span class="lineCov">          3 :                                         if (anim-&gt;animation_elt == node) break;</span>
<span class="lineNum">    1836 </span>            :                                         else anim = NULL;
<span class="lineNum">    1837 </span>            :                                 }
<span class="lineNum">    1838 </span><span class="lineCov">          1 :                                 if (anim) {</span>
<span class="lineNum">    1839 </span><span class="lineCov">          1 :                                         if (svg_parse_animation(parser, gf_node_get_graph((GF_Node *)node), anim, NULL, 1)) {</span>
<span class="lineNum">    1840 </span><span class="lineCov">          1 :                                                 svg_delete_deferred_anim(anim, parser-&gt;deferred_animations);</span>
<span class="lineNum">    1841 </span>            :                                         }
<span class="lineNum">    1842 </span>            :                                 }
<span class="lineNum">    1843 </span>            :                         }
<span class="lineNum">    1844 </span>            :                         break;
<span class="lineNum">    1845 </span><span class="lineCov">          4 :                         case TAG_SVG_script:</span>
<span class="lineNum">    1846 </span>            :                         case TAG_SVG_handler:
<span class="lineNum">    1847 </span>            :                                 /*init script once text script is loaded*/
<span class="lineNum">    1848 </span><span class="lineCov">          4 :                                 gf_node_init((GF_Node *)node);</span>
<span class="lineNum">    1849 </span><span class="lineCov">          4 :                                 break;</span>
<span class="lineNum">    1850 </span>            :                         }
<span class="lineNum">    1851 </span>            :                         /*if we have associated event listeners, trigger the onLoad, only in playback mode */
<span class="lineNum">    1852 </span><span class="lineCov">       2296 :                         if (node-&gt;sgprivate-&gt;interact &amp;&amp; node-&gt;sgprivate-&gt;interact-&gt;dom_evt) {</span>
<span class="lineNum">    1853 </span>            :                                 GF_DOM_Event evt;
<span class="lineNum">    1854 </span>            :                                 memset(&amp;evt, 0, sizeof(GF_DOM_Event));
<span class="lineNum">    1855 </span><span class="lineCov">          2 :                                 evt.type = GF_EVENT_LOAD;</span>
<span class="lineNum">    1856 </span><span class="lineCov">          2 :                                 gf_dom_event_fire((GF_Node*)node, &amp;evt);</span>
<span class="lineNum">    1857 </span>            :                         }
<span class="lineNum">    1858 </span>            : 
<span class="lineNum">    1859 </span>            :                 }
<span class="lineNum">    1860 </span>            :         }
<span class="lineNum">    1861 </span>            : #ifdef SKIP_UNKNOWN_NODES
<span class="lineNum">    1862 </span>            :         else {
<span class="lineNum">    1863 </span>            :                 if (top-&gt;unknown_depth) {
<span class="lineNum">    1864 </span>            :                         top-&gt;unknown_depth--;
<span class="lineNum">    1865 </span>            :                         if (!top-&gt;unknown_depth) {
<span class="lineNum">    1866 </span>            :                                 /*this is not 100% correct, we should track which unsupported node changed the namespace*/
<span class="lineNum">    1867 </span>            :                                 parser-&gt;current_ns = top-&gt;current_ns;
<span class="lineNum">    1868 </span>            :                                 if (parser-&gt;command_depth) parser-&gt;command_depth --;
<span class="lineNum">    1869 </span>            :                         }
<span class="lineNum">    1870 </span>            :                 } else if (parser-&gt;command_depth) {
<span class="lineNum">    1871 </span>            :                         parser-&gt;command_depth--;
<span class="lineNum">    1872 </span>            :                 } else {
<span class="lineNum">    1873 </span>            :                         svg_report(parser, GF_BAD_PARAM, &quot;SVG depth mismatch&quot;);
<span class="lineNum">    1874 </span>            :                 }
<span class="lineNum">    1875 </span>            :         }
<span class="lineNum">    1876 </span>            : #endif
<span class="lineNum">    1877 </span>            : 
<span class="lineNum">    1878 </span>            : #endif //SKIP_ALL
<a name="1879"><span class="lineNum">    1879 </span>            : }</a>
<span class="lineNum">    1880 </span>            : 
<span class="lineNum">    1881 </span><span class="lineCov">       6047 : static void svg_text_content(void *sax_cbck, const char *text_content, Bool is_cdata)</span>
<span class="lineNum">    1882 </span>            : {
<span class="lineNum">    1883 </span>            : #ifndef SKIP_ALL
<span class="lineNum">    1884 </span>            :         GF_SVG_Parser *parser = (GF_SVG_Parser *)sax_cbck;
<span class="lineNum">    1885 </span><span class="lineCov">       6047 :         SVG_NodeStack *top = (SVG_NodeStack *)gf_list_last(parser-&gt;node_stack);</span>
<span class="lineNum">    1886 </span><span class="lineCov">       6047 :         SVG_Element *elt = (top ? top-&gt;node : NULL);</span>
<span class="lineNum">    1887 </span>            :         GF_DOMText *text;
<span class="lineNum">    1888 </span>            :         Bool skip_text;
<span class="lineNum">    1889 </span>            :         u32 tag;
<span class="lineNum">    1890 </span>            : 
<span class="lineNum">    1891 </span><span class="lineCov">       6047 :         if (top &amp;&amp; top-&gt;unknown_depth &amp;&amp; !parser-&gt;command_depth) return;</span>
<span class="lineNum">    1892 </span><span class="lineCov">       6047 :         if (!elt &amp;&amp; !parser-&gt;command) return;</span>
<span class="lineNum">    1893 </span>            : 
<span class="lineNum">    1894 </span><span class="lineCov">       5855 :         tag = (elt ? gf_node_get_tag((GF_Node *)elt) : 0);</span>
<span class="lineNum">    1895 </span>            : 
<span class="lineNum">    1896 </span>            :         /*if top is a conditional, create a new text node*/
<span class="lineNum">    1897 </span><span class="lineCov">       5855 :         if (!elt || tag == TAG_LSR_conditional) {</span>
<span class="lineNum">    1898 </span>            :                 GF_CommandField *field;
<span class="lineNum">    1899 </span><span class="lineCov">        110 :                 if (!parser-&gt;command) return;</span>
<span class="lineNum">    1900 </span>            : 
<span class="lineNum">    1901 </span><span class="lineCov">        110 :                 field = (GF_CommandField *)gf_list_get(parser-&gt;command-&gt;command_fields, 0);</span>
<span class="lineNum">    1902 </span><span class="lineCov">        110 :                 if (parser-&gt;command-&gt;tag == GF_SG_LSR_NEW_SCENE || parser-&gt;command-&gt;tag == GF_SG_LSR_ADD) return;</span>
<span class="lineNum">    1903 </span>            : 
<span class="lineNum">    1904 </span><span class="lineCov">        106 :                 if (!field || field-&gt;field_ptr) return;</span>
<span class="lineNum">    1905 </span>            : 
<span class="lineNum">    1906 </span><span class="lineCov">          8 :                 if (field-&gt;new_node) {</span>
<span class="lineNum">    1907 </span><span class="lineNoCov">          0 :                         svg_report(parser, GF_OK, &quot;Warning: LASeR cannot replace children with a mix of text nodes and elements - ignoring text\n&quot;);</span>
<span class="lineNum">    1908 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    1909 </span>            :                 }
<span class="lineNum">    1910 </span>            : 
<span class="lineNum">    1911 </span>            :                 /*create a text node but don't register it with any node*/
<span class="lineNum">    1912 </span><span class="lineCov">          8 :                 text = gf_dom_new_text_node(parser-&gt;load-&gt;scene_graph);</span>
<span class="lineNum">    1913 </span><span class="lineCov">          8 :                 gf_node_register((GF_Node *)text, NULL);</span>
<span class="lineNum">    1914 </span><span class="lineCov">          8 :                 text-&gt;textContent = gf_strdup(text_content);</span>
<span class="lineNum">    1915 </span>            : 
<span class="lineNum">    1916 </span><span class="lineCov">          8 :                 if (field-&gt;new_node) {</span>
<span class="lineNum">    1917 </span><span class="lineNoCov">          0 :                         field-&gt;field_ptr = &amp;field-&gt;node_list;</span>
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :                         gf_node_list_add_child(&amp; field-&gt;node_list, field-&gt;new_node);</span>
<span class="lineNum">    1919 </span><span class="lineNoCov">          0 :                         field-&gt;new_node = NULL;</span>
<span class="lineNum">    1920 </span><span class="lineNoCov">          0 :                         gf_node_list_add_child( &amp; field-&gt;node_list, (GF_Node*) text);</span>
<span class="lineNum">    1921 </span><span class="lineCov">          8 :                 } else if (field-&gt;node_list) {</span>
<span class="lineNum">    1922 </span><span class="lineNoCov">          0 :                         gf_node_list_add_child(&amp; field-&gt;node_list, (GF_Node*) text);</span>
<span class="lineNum">    1923 </span>            :                 } else {
<span class="lineNum">    1924 </span><span class="lineCov">          8 :                         field-&gt;new_node = (GF_Node*)text;</span>
<span class="lineNum">    1925 </span><span class="lineCov">          8 :                         field-&gt;field_ptr = &amp;field-&gt;new_node;</span>
<span class="lineNum">    1926 </span>            :                 }
<span class="lineNum">    1927 </span>            :                 return;
<span class="lineNum">    1928 </span>            :         }
<span class="lineNum">    1929 </span>            :         skip_text = GF_TRUE;
<span class="lineNum">    1930 </span>            :         switch (tag) {
<span class="lineNum">    1931 </span>            :         case TAG_DOMFullNode:
<span class="lineNum">    1932 </span>            :         case TAG_SVG_a:
<span class="lineNum">    1933 </span>            :         case TAG_SVG_title:
<span class="lineNum">    1934 </span>            :         case TAG_SVG_desc:
<span class="lineNum">    1935 </span>            :         case TAG_SVG_metadata:
<span class="lineNum">    1936 </span>            :         case TAG_SVG_text:
<span class="lineNum">    1937 </span>            :         case TAG_SVG_tspan:
<span class="lineNum">    1938 </span>            :         case TAG_SVG_textArea:
<span class="lineNum">    1939 </span>            :                 skip_text = GF_FALSE;
<span class="lineNum">    1940 </span>            :                 break;
<span class="lineNum">    1941 </span>            :         /*for script and handlers only add text if not empty*/
<span class="lineNum">    1942 </span><span class="lineCov">         24 :         case TAG_SVG_handler:</span>
<span class="lineNum">    1943 </span>            :         case TAG_SVG_script:
<span class="lineNum">    1944 </span>            :         {
<span class="lineNum">    1945 </span><span class="lineCov">         24 :                 u32 i, len = (u32) strlen(text_content);</span>
<span class="lineNum">    1946 </span><span class="lineCov">         82 :                 for (i=0; i&lt;len; i++) {</span>
<span class="lineNum">    1947 </span><span class="lineCov">         64 :                         if (!strchr(&quot; \n\r\t&quot;, text_content[i])) {</span>
<span class="lineNum">    1948 </span>            :                                 skip_text = GF_FALSE;
<span class="lineNum">    1949 </span>            :                                 break;
<span class="lineNum">    1950 </span>            :                         }
<span class="lineNum">    1951 </span>            :                 }
<span class="lineNum">    1952 </span>            :         }
<span class="lineNum">    1953 </span>            :         break;
<span class="lineNum">    1954 </span>            :         }
<span class="lineNum">    1955 </span>            : 
<span class="lineNum">    1956 </span><span class="lineCov">         24 :         if (!skip_text) {</span>
<span class="lineNum">    1957 </span><span class="lineCov">        638 :                 text = gf_dom_add_text_node((GF_Node *)elt, gf_strdup(text_content));</span>
<span class="lineNum">    1958 </span><span class="lineCov">        638 :                 text-&gt;type = is_cdata ? GF_DOM_TEXT_CDATA : GF_DOM_TEXT_REGULAR;</span>
<span class="lineNum">    1959 </span><span class="lineCov">        638 :                 gf_node_changed((GF_Node *)text, NULL);</span>
<span class="lineNum">    1960 </span>            :         }
<span class="lineNum">    1961 </span>            : #endif
<a name="1962"><span class="lineNum">    1962 </span>            : }</a>
<span class="lineNum">    1963 </span>            : 
<span class="lineNum">    1964 </span><span class="lineCov">         69 : static GF_SVG_Parser *svg_new_parser(GF_SceneLoader *load)</span>
<span class="lineNum">    1965 </span>            : {
<span class="lineNum">    1966 </span>            :         GF_SVG_Parser *parser;
<span class="lineNum">    1967 </span><span class="lineCov">         69 :         switch (load-&gt;type) {</span>
<span class="lineNum">    1968 </span><span class="lineCov">          2 :         case GF_SM_LOAD_XSR:</span>
<span class="lineNum">    1969 </span><span class="lineCov">          2 :                 if (!load-&gt;ctx) return NULL;</span>
<span class="lineNum">    1970 </span>            :                 break;
<span class="lineNum">    1971 </span>            :         case GF_SM_LOAD_SVG:
<span class="lineNum">    1972 </span>            :         case GF_SM_LOAD_DIMS:
<span class="lineNum">    1973 </span>            :                 break;
<span class="lineNum">    1974 </span>            :         default:
<span class="lineNum">    1975 </span>            :                 return NULL;
<span class="lineNum">    1976 </span>            :         }
<span class="lineNum">    1977 </span>            : 
<span class="lineNum">    1978 </span><span class="lineCov">         69 :         GF_SAFEALLOC(parser, GF_SVG_Parser);</span>
<span class="lineNum">    1979 </span><span class="lineCov">         69 :         if (!parser) {</span>
<span class="lineNum">    1980 </span>            :                 return NULL;
<span class="lineNum">    1981 </span>            :         }
<span class="lineNum">    1982 </span><span class="lineCov">         69 :         parser-&gt;node_stack = gf_list_new();</span>
<span class="lineNum">    1983 </span><span class="lineCov">         69 :         parser-&gt;deferred_hrefs = gf_list_new();</span>
<span class="lineNum">    1984 </span><span class="lineCov">         69 :         parser-&gt;deferred_animations = gf_list_new();</span>
<span class="lineNum">    1985 </span><span class="lineCov">         69 :         parser-&gt;deferred_listeners = gf_list_new();</span>
<span class="lineNum">    1986 </span><span class="lineCov">         69 :         parser-&gt;peeked_nodes = gf_list_new();</span>
<span class="lineNum">    1987 </span>            : 
<span class="lineNum">    1988 </span><span class="lineCov">         69 :         parser-&gt;sax_parser = gf_xml_sax_new(svg_node_start, svg_node_end, svg_text_content, parser);</span>
<span class="lineNum">    1989 </span><span class="lineCov">         69 :         parser-&gt;load = load;</span>
<span class="lineNum">    1990 </span><span class="lineCov">         69 :         load-&gt;loader_priv = parser;</span>
<span class="lineNum">    1991 </span><span class="lineCov">         69 :         if (load-&gt;ctx) load-&gt;ctx-&gt;is_pixel_metrics = GF_TRUE;</span>
<span class="lineNum">    1992 </span>            : 
<span class="lineNum">    1993 </span>            :         /*to cope with old files not signaling XMLNS, add the SVG NS by default*/
<span class="lineNum">    1994 </span><span class="lineCov">         69 :         gf_sg_add_namespace(parser-&gt;load-&gt;scene_graph, &quot;http://www.w3.org/2000/svg&quot;, NULL);</span>
<span class="lineNum">    1995 </span><span class="lineCov">         69 :         parser-&gt;current_ns = GF_XMLNS_SVG;</span>
<span class="lineNum">    1996 </span>            : 
<span class="lineNum">    1997 </span>            : #ifdef GPAC_ENABLE_COVERAGE
<span class="lineNum">    1998 </span><span class="lineCov">         69 :         if (gf_sys_is_cov_mode()) {</span>
<span class="lineNum">    1999 </span><span class="lineCov">         69 :                 svg_report(parser, GF_OK, NULL);</span>
<span class="lineNum">    2000 </span>            :         }
<span class="lineNum">    2001 </span>            : #endif
<span class="lineNum">    2002 </span>            : 
<span class="lineNum">    2003 </span>            :         return parser;
<a name="2004"><span class="lineNum">    2004 </span>            : }</a>
<span class="lineNum">    2005 </span>            : 
<span class="lineNum">    2006 </span><span class="lineCov">         68 : static void svg_flush_animations(GF_SVG_Parser *parser)</span>
<span class="lineNum">    2007 </span>            : {
<span class="lineNum">    2008 </span><span class="lineCov">         68 :         if (!parser) return;</span>
<span class="lineNum">    2009 </span><span class="lineCov">         77 :         while (gf_list_count(parser-&gt;deferred_animations)) {</span>
<span class="lineNum">    2010 </span><span class="lineCov">          9 :                 SVG_DeferredAnimation *anim = (SVG_DeferredAnimation *)gf_list_get(parser-&gt;deferred_animations, 0);</span>
<span class="lineNum">    2011 </span><span class="lineCov">          9 :                 svg_parse_animation(parser, parser-&gt;load-&gt;scene_graph, anim, NULL, 2);</span>
<span class="lineNum">    2012 </span><span class="lineCov">          9 :                 svg_delete_deferred_anim(anim, parser-&gt;deferred_animations);</span>
<span class="lineNum">    2013 </span>            :         }
<a name="2014"><span class="lineNum">    2014 </span>            : }</a>
<span class="lineNum">    2015 </span>            : 
<span class="lineNum">    2016 </span><span class="lineCov">        136 : static void gf_sm_svg_flush_state(GF_SVG_Parser *parser)</span>
<span class="lineNum">    2017 </span>            : {
<span class="lineNum">    2018 </span><span class="lineCov">        136 :         while (gf_list_count(parser-&gt;node_stack)) {</span>
<span class="lineNum">    2019 </span><span class="lineNoCov">          0 :                 SVG_NodeStack *st = (SVG_NodeStack *)gf_list_last(parser-&gt;node_stack);</span>
<span class="lineNum">    2020 </span><span class="lineNoCov">          0 :                 gf_list_rem_last(parser-&gt;node_stack);</span>
<span class="lineNum">    2021 </span><span class="lineNoCov">          0 :                 gf_free(st);</span>
<span class="lineNum">    2022 </span>            :         }
<span class="lineNum">    2023 </span>            :         /*FIXME - if there still are som deferred listeners, we should pass them to the scene graph
<span class="lineNum">    2024 </span>            :         and wait for the parent to be defined*/
<span class="lineNum">    2025 </span><span class="lineCov">        136 :         while (gf_list_count(parser-&gt;deferred_listeners)) {</span>
<span class="lineNum">    2026 </span><span class="lineNoCov">          0 :                 GF_Node *l = (GF_Node *)gf_list_last(parser-&gt;deferred_listeners);</span>
<span class="lineNum">    2027 </span><span class="lineNoCov">          0 :                 gf_list_rem_last(parser-&gt;deferred_listeners);</span>
<span class="lineNum">    2028 </span>            :                 /*listeners not resolved are not inserted in the tree - destroy them*/
<span class="lineNum">    2029 </span><span class="lineNoCov">          0 :                 gf_node_register(l, NULL);</span>
<span class="lineNum">    2030 </span><span class="lineNoCov">          0 :                 gf_node_unregister(l, NULL);</span>
<span class="lineNum">    2031 </span>            :         }
<a name="2032"><span class="lineNum">    2032 </span><span class="lineCov">        136 : }</span></a>
<span class="lineNum">    2033 </span>            : 
<span class="lineNum">    2034 </span><span class="lineCov">         69 : static GF_Err gf_sm_load_initialize_svg(GF_SceneLoader *load, const char *str_data, Bool is_fragment)</span>
<span class="lineNum">    2035 </span>            : {
<span class="lineNum">    2036 </span>            :         GF_Err e;
<span class="lineNum">    2037 </span>            :         GF_SVG_Parser *parser;
<span class="lineNum">    2038 </span>            : 
<span class="lineNum">    2039 </span><span class="lineCov">         69 :         if (str_data) {</span>
<span class="lineNum">    2040 </span>            :                 char BOM[6];
<span class="lineNum">    2041 </span><span class="lineCov">          1 :                 BOM[0] = str_data[0];</span>
<span class="lineNum">    2042 </span><span class="lineCov">          1 :                 BOM[1] = str_data[1];</span>
<span class="lineNum">    2043 </span><span class="lineCov">          1 :                 BOM[2] = str_data[2];</span>
<span class="lineNum">    2044 </span><span class="lineCov">          1 :                 BOM[3] = str_data[3];</span>
<span class="lineNum">    2045 </span><span class="lineCov">          1 :                 BOM[4] = BOM[5] = 0;</span>
<span class="lineNum">    2046 </span><span class="lineCov">          1 :                 parser = svg_new_parser(load);</span>
<span class="lineNum">    2047 </span><span class="lineCov">          1 :                 if (!parser) return GF_BAD_PARAM;</span>
<span class="lineNum">    2048 </span>            : 
<span class="lineNum">    2049 </span><span class="lineCov">          1 :                 if (is_fragment) parser-&gt;has_root = 2;</span>
<span class="lineNum">    2050 </span><span class="lineCov">          1 :                 e = gf_xml_sax_init(parser-&gt;sax_parser, (unsigned char*)BOM);</span>
<span class="lineNum">    2051 </span><span class="lineCov">          1 :                 if (e) {</span>
<span class="lineNum">    2052 </span><span class="lineNoCov">          0 :                         svg_report(parser, e, &quot;Error initializing SAX parser: %s&quot;, gf_xml_sax_get_error(parser-&gt;sax_parser) );</span>
<span class="lineNum">    2053 </span><span class="lineNoCov">          0 :                         return e;</span>
<span class="lineNum">    2054 </span>            :                 }
<span class="lineNum">    2055 </span><span class="lineCov">          1 :                 str_data += 4;</span>
<span class="lineNum">    2056 </span>            : 
<span class="lineNum">    2057 </span><span class="lineCov">         68 :         } else if (load-&gt;fileName) {</span>
<span class="lineNum">    2058 </span><span class="lineCov">         68 :                 parser = svg_new_parser(load);</span>
<span class="lineNum">    2059 </span><span class="lineCov">         68 :                 if (!parser) return GF_BAD_PARAM;</span>
<span class="lineNum">    2060 </span>            :         } else {
<span class="lineNum">    2061 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    2062 </span>            :         }
<span class="lineNum">    2063 </span>            : 
<span class="lineNum">    2064 </span>            :         /*chunk parsing*/
<span class="lineNum">    2065 </span><span class="lineCov">         69 :         if (load-&gt;flags &amp; GF_SM_LOAD_CONTEXT_READY) {</span>
<span class="lineNum">    2066 </span>            :                 u32 i;
<span class="lineNum">    2067 </span>            :                 GF_StreamContext *sc;
<span class="lineNum">    2068 </span><span class="lineNoCov">          0 :                 if (!load-&gt;ctx) return GF_BAD_PARAM;</span>
<span class="lineNum">    2069 </span>            : 
<span class="lineNum">    2070 </span>            :                 /*restore context - note that base layer are ALWAYS declared BEFORE enhancement layers with gpac parsers*/
<span class="lineNum">    2071 </span><span class="lineNoCov">          0 :                 i=0;</span>
<span class="lineNum">    2072 </span><span class="lineNoCov">          0 :                 while ((sc = (GF_StreamContext*)gf_list_enum(load-&gt;ctx-&gt;streams, &amp;i))) {</span>
<span class="lineNum">    2073 </span><span class="lineNoCov">          0 :                         switch (sc-&gt;streamType) {</span>
<span class="lineNum">    2074 </span><span class="lineNoCov">          0 :                         case GF_STREAM_SCENE:</span>
<span class="lineNum">    2075 </span><span class="lineNoCov">          0 :                                 if (!parser-&gt;laser_es) parser-&gt;laser_es = sc;</span>
<span class="lineNum">    2076 </span>            :                                 break;
<span class="lineNum">    2077 </span>            :                         default:
<span class="lineNum">    2078 </span>            :                                 break;
<span class="lineNum">    2079 </span>            :                         }
<span class="lineNum">    2080 </span>            :                 }
<span class="lineNum">    2081 </span>            :                 /*need at least one scene stream - FIXME - accept SVG as root? */
<span class="lineNum">    2082 </span><span class="lineNoCov">          0 :                 if (!parser-&gt;laser_es) return GF_BAD_PARAM;</span>
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_INFO, GF_LOG_PARSER, (&quot;SVG: MPEG-4 LASeR / DIMS Scene Chunk Parsing&quot;));</span>
<span class="lineNum">    2084 </span>            :         } else {
<span class="lineNum">    2085 </span><span class="lineCov">         69 :                 GF_LOG(GF_LOG_INFO, GF_LOG_PARSER, (&quot;[Parser] %s Scene Parsing: %s\n&quot;, ((load-&gt;type==GF_SM_LOAD_SVG) ? &quot;SVG&quot; : ((load-&gt;type==GF_SM_LOAD_XSR) ? &quot;LASeR&quot; : &quot;DIMS&quot;)), load-&gt;fileName));</span>
<span class="lineNum">    2086 </span>            :         }
<span class="lineNum">    2087 </span>            : 
<span class="lineNum">    2088 </span><span class="lineCov">         69 :         if (str_data)</span>
<span class="lineNum">    2089 </span><span class="lineCov">          1 :                 return gf_xml_sax_parse(parser-&gt;sax_parser, str_data);</span>
<span class="lineNum">    2090 </span>            : 
<span class="lineNum">    2091 </span>            :         return GF_OK;
<span class="lineNum">    2092 </span>            : }
<a name="2093"><span class="lineNum">    2093 </span>            : </a>
<span class="lineNum">    2094 </span>            : 
<span class="lineNum">    2095 </span><span class="lineCov">         68 : GF_Err load_svg_run(GF_SceneLoader *load)</span>
<span class="lineNum">    2096 </span>            : {
<span class="lineNum">    2097 </span>            :         u32 in_time;
<span class="lineNum">    2098 </span>            :         GF_Err e;
<span class="lineNum">    2099 </span><span class="lineCov">         68 :         GF_SVG_Parser *parser = (GF_SVG_Parser *)load-&gt;loader_priv;</span>
<span class="lineNum">    2100 </span>            : 
<span class="lineNum">    2101 </span><span class="lineCov">         68 :         if (!parser) {</span>
<span class="lineNum">    2102 </span><span class="lineCov">         68 :                 e = gf_sm_load_initialize_svg(load, NULL, GF_FALSE);</span>
<span class="lineNum">    2103 </span><span class="lineCov">         68 :                 if (e) return e;</span>
<span class="lineNum">    2104 </span><span class="lineCov">         68 :                 parser = (GF_SVG_Parser *)load-&gt;loader_priv;</span>
<span class="lineNum">    2105 </span>            :         }
<span class="lineNum">    2106 </span>            : 
<span class="lineNum">    2107 </span><span class="lineCov">         68 :         in_time = gf_sys_clock();</span>
<span class="lineNum">    2108 </span><span class="lineCov">         68 :         e = gf_xml_sax_parse_file(parser-&gt;sax_parser, (const char *)load-&gt;fileName, svg_progress);</span>
<span class="lineNum">    2109 </span><span class="lineCov">         68 :         if (parser-&gt;last_error&lt;0) e = parser-&gt;last_error;</span>
<span class="lineNum">    2110 </span>            :         
<span class="lineNum">    2111 </span><span class="lineCov">         68 :         if (e&lt;0) return svg_report(parser, e, &quot;Unable to parse file %s: %s&quot;, load-&gt;fileName, gf_xml_sax_get_error(parser-&gt;sax_parser) );</span>
<span class="lineNum">    2112 </span><span class="lineCov">         67 :         GF_LOG(GF_LOG_INFO, GF_LOG_PARSER, (&quot;[Parser] Scene parsed and Scene Graph built in %d ms\n&quot;, gf_sys_clock() - in_time));</span>
<span class="lineNum">    2113 </span>            : 
<span class="lineNum">    2114 </span><span class="lineCov">         67 :         svg_flush_animations(parser);</span>
<span class="lineNum">    2115 </span><span class="lineCov">         67 :         gf_sm_svg_flush_state(parser);</span>
<span class="lineNum">    2116 </span><span class="lineCov">         67 :         return e;</span>
<span class="lineNum">    2117 </span>            : 
<a name="2118"><span class="lineNum">    2118 </span>            : }</a>
<span class="lineNum">    2119 </span>            : 
<span class="lineNum">    2120 </span><span class="lineCov">        117 : static void load_svg_done(GF_SceneLoader *load)</span>
<span class="lineNum">    2121 </span>            : {
<span class="lineNum">    2122 </span>            :         SVG_SAFExternalStream *st;
<span class="lineNum">    2123 </span><span class="lineCov">        117 :         GF_SVG_Parser *parser = (GF_SVG_Parser *)load-&gt;loader_priv;</span>
<span class="lineNum">    2124 </span><span class="lineCov">        117 :         if (!parser) return;</span>
<span class="lineNum">    2125 </span>            : 
<span class="lineNum">    2126 </span><span class="lineCov">         69 :         gf_sm_svg_flush_state(parser);</span>
<span class="lineNum">    2127 </span>            : 
<span class="lineNum">    2128 </span><span class="lineCov">         69 :         gf_list_del(parser-&gt;node_stack);</span>
<span class="lineNum">    2129 </span><span class="lineCov">         69 :         gf_list_del(parser-&gt;deferred_hrefs);</span>
<span class="lineNum">    2130 </span><span class="lineCov">         69 :         gf_list_del(parser-&gt;deferred_listeners);</span>
<span class="lineNum">    2131 </span><span class="lineCov">         69 :         gf_list_del(parser-&gt;peeked_nodes);</span>
<span class="lineNum">    2132 </span>            :         /* reset animations */
<span class="lineNum">    2133 </span><span class="lineCov">         69 :         gf_list_del(parser-&gt;deferred_animations);</span>
<span class="lineNum">    2134 </span><span class="lineCov">         69 :         if (parser-&gt;sax_parser) {</span>
<span class="lineNum">    2135 </span><span class="lineCov">         69 :                 gf_xml_sax_del(parser-&gt;sax_parser);</span>
<span class="lineNum">    2136 </span>            :         }
<span class="lineNum">    2137 </span><span class="lineCov">         69 :         st = parser-&gt;streams;</span>
<span class="lineNum">    2138 </span><span class="lineCov">        140 :         while (st) {</span>
<span class="lineNum">    2139 </span><span class="lineCov">          2 :                 SVG_SAFExternalStream *next = st-&gt;next;</span>
<span class="lineNum">    2140 </span><span class="lineCov">          2 :                 gf_free(st-&gt;stream_name);</span>
<span class="lineNum">    2141 </span><span class="lineCov">          2 :                 gf_free(st);</span>
<span class="lineNum">    2142 </span>            :                 st = next;
<span class="lineNum">    2143 </span>            :         }
<span class="lineNum">    2144 </span><span class="lineCov">         69 :         gf_free(parser);</span>
<span class="lineNum">    2145 </span><span class="lineCov">         69 :         load-&gt;loader_priv = NULL;</span>
<a name="2146"><span class="lineNum">    2146 </span>            : }</a>
<span class="lineNum">    2147 </span>            : 
<span class="lineNum">    2148 </span><span class="lineCov">          1 : GF_Err load_svg_parse_string(GF_SceneLoader *load, const char *str)</span>
<span class="lineNum">    2149 </span>            : {
<span class="lineNum">    2150 </span>            :         GF_Err e;
<span class="lineNum">    2151 </span><span class="lineCov">          1 :         GF_SVG_Parser *parser = (GF_SVG_Parser *)load-&gt;loader_priv;</span>
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span><span class="lineCov">          1 :         if (!parser) {</span>
<span class="lineNum">    2154 </span><span class="lineCov">          1 :                 e = gf_sm_load_initialize_svg(load, str, GF_FALSE);</span>
<span class="lineNum">    2155 </span><span class="lineCov">          1 :                 parser = (GF_SVG_Parser *)load-&gt;loader_priv;</span>
<span class="lineNum">    2156 </span>            :         } else {
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :                 e = gf_xml_sax_parse(parser-&gt;sax_parser, str);</span>
<span class="lineNum">    2158 </span>            :         }
<span class="lineNum">    2159 </span><span class="lineCov">          1 :         if (e&lt;0) svg_report(parser, e, &quot;Unable to parse chunk: %s&quot;, parser ? gf_xml_sax_get_error(parser-&gt;sax_parser) : &quot;no parser&quot;);</span>
<span class="lineNum">    2160 </span><span class="lineCov">          1 :         else e = parser-&gt;last_error;</span>
<span class="lineNum">    2161 </span>            :         
<span class="lineNum">    2162 </span>            : 
<span class="lineNum">    2163 </span><span class="lineCov">          1 :         svg_flush_animations(parser);</span>
<span class="lineNum">    2164 </span>            : 
<span class="lineNum">    2165 </span>            :         /*if error move to done state and wait for next XML chunk*/
<span class="lineNum">    2166 </span><span class="lineCov">          1 :         if (e) load_svg_done(load);</span>
<span class="lineNum">    2167 </span>            : 
<span class="lineNum">    2168 </span><span class="lineCov">          1 :         return e;</span>
<a name="2169"><span class="lineNum">    2169 </span>            : }</a>
<span class="lineNum">    2170 </span>            : 
<span class="lineNum">    2171 </span><span class="lineNoCov">          0 : static GF_Err load_svg_suspend(GF_SceneLoader *load, Bool suspend)</span>
<span class="lineNum">    2172 </span>            : {
<span class="lineNum">    2173 </span><span class="lineNoCov">          0 :         GF_SVG_Parser *parser = (GF_SVG_Parser *)load-&gt;loader_priv;</span>
<span class="lineNum">    2174 </span><span class="lineNoCov">          0 :         if (parser) gf_xml_sax_suspend(parser-&gt;sax_parser, suspend);</span>
<span class="lineNum">    2175 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">    2176 </span>            : }
<a name="2177"><span class="lineNum">    2177 </span>            : </a>
<span class="lineNum">    2178 </span>            : 
<span class="lineNum">    2179 </span><span class="lineCov">         69 : GF_Err gf_sm_load_init_svg(GF_SceneLoader *load)</span>
<span class="lineNum">    2180 </span>            : {
<span class="lineNum">    2181 </span><span class="lineCov">         69 :         load-&gt;process = load_svg_run;</span>
<span class="lineNum">    2182 </span><span class="lineCov">         69 :         load-&gt;done = load_svg_done;</span>
<span class="lineNum">    2183 </span><span class="lineCov">         69 :         load-&gt;parse_string = load_svg_parse_string;</span>
<span class="lineNum">    2184 </span><span class="lineCov">         69 :         load-&gt;suspend = load_svg_suspend;</span>
<span class="lineNum">    2185 </span>            : 
<span class="lineNum">    2186 </span><span class="lineCov">         69 :         return GF_OK;</span>
<span class="lineNum">    2187 </span>            : 
<a name="2188"><span class="lineNum">    2188 </span>            : }</a>
<span class="lineNum">    2189 </span>            : 
<span class="lineNum">    2190 </span><span class="lineNoCov">          0 : GF_Node *gf_sm_load_svg_from_string(GF_SceneGraph *in_scene, char *node_str)</span>
<span class="lineNum">    2191 </span>            : {
<span class="lineNum">    2192 </span>            :         GF_Err e;
<span class="lineNum">    2193 </span>            :         GF_SVG_Parser *parser;
<span class="lineNum">    2194 </span>            :         GF_Node *node;
<span class="lineNum">    2195 </span>            :         GF_SceneLoader ctx;
<span class="lineNum">    2196 </span>            :         memset(&amp;ctx, 0, sizeof(GF_SceneLoader));
<span class="lineNum">    2197 </span><span class="lineNoCov">          0 :         ctx.scene_graph = in_scene;</span>
<span class="lineNum">    2198 </span><span class="lineNoCov">          0 :         ctx.type = GF_SM_LOAD_SVG;</span>
<span class="lineNum">    2199 </span>            : 
<span class="lineNum">    2200 </span><span class="lineNoCov">          0 :         e = gf_sm_load_initialize_svg(&amp;ctx, node_str, GF_TRUE);</span>
<span class="lineNum">    2201 </span>            : 
<span class="lineNum">    2202 </span><span class="lineNoCov">          0 :         parser = (GF_SVG_Parser *)ctx.loader_priv;</span>
<span class="lineNum">    2203 </span>            : 
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :         if (e != GF_OK) {</span>
<span class="lineNum">    2205 </span><span class="lineNoCov">          0 :                 if (parser) {</span>
<span class="lineNum">    2206 </span><span class="lineNoCov">          0 :                         if (parser-&gt;fragment_root) gf_node_unregister(parser-&gt;fragment_root, NULL);</span>
<span class="lineNum">    2207 </span><span class="lineNoCov">          0 :                         parser-&gt;fragment_root=NULL;</span>
<span class="lineNum">    2208 </span>            :                 }
<span class="lineNum">    2209 </span><span class="lineNoCov">          0 :                 load_svg_done(&amp;ctx);</span>
<span class="lineNum">    2210 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    2211 </span>            :         }
<span class="lineNum">    2212 </span>            : 
<span class="lineNum">    2213 </span><span class="lineNoCov">          0 :         node = parser ? parser-&gt;fragment_root : NULL;</span>
<span class="lineNum">    2214 </span>            :         /*don't register*/
<span class="lineNum">    2215 </span><span class="lineNoCov">          0 :         if (node) node-&gt;sgprivate-&gt;num_instances--;</span>
<span class="lineNum">    2216 </span><span class="lineNoCov">          0 :         load_svg_done(&amp;ctx);</span>
<span class="lineNum">    2217 </span><span class="lineNoCov">          0 :         return node;</span>
<span class="lineNum">    2218 </span>            : }
<span class="lineNum">    2219 </span>            : 
<span class="lineNum">    2220 </span>            : #endif
<span class="lineNum">    2221 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - media_tools/media_import.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">media_tools</a> - media_import.c<span style="font-size: 80%;"> (source / <a href="media_import.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">649</td>
            <td class="headerCovTableEntry">858</td>
            <td class="headerCovTableEntryMed">75.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">11</td>
            <td class="headerCovTableEntry">12</td>
            <td class="headerCovTableEntryHi">91.7 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre, Romain Bouqueau, Cyril Concolato
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2000-2021
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / Media Tools sub-project
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/filters.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &lt;gpac/internal/media_dev.h&gt;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : #include &lt;gpac/xml.h&gt;
<span class="lineNum">      33 </span>            : #include &lt;gpac/network.h&gt;
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : 
<a name="36"><span class="lineNum">      36 </span>            : #ifndef GPAC_DISABLE_MEDIA_IMPORT</a>
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span><span class="lineCov">         65 : GF_Err gf_import_message(GF_MediaImporter *import, GF_Err e, char *format, ...)</span>
<span class="lineNum">      39 </span>            : {
<span class="lineNum">      40 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">      41 </span><span class="lineCov">         65 :         if (gf_log_tool_level_on(GF_LOG_AUTHOR, e ? GF_LOG_WARNING : GF_LOG_INFO)) {</span>
<span class="lineNum">      42 </span>            :                 va_list args;
<span class="lineNum">      43 </span>            :                 char szMsg[1024];
<span class="lineNum">      44 </span><span class="lineCov">         65 :                 va_start(args, format);</span>
<span class="lineNum">      45 </span>            :                 vsnprintf(szMsg, 1024, format, args);
<span class="lineNum">      46 </span><span class="lineCov">         65 :                 va_end(args);</span>
<span class="lineNum">      47 </span><span class="lineCov">         65 :                 GF_LOG((u32) (e ? GF_LOG_WARNING : GF_LOG_INFO), GF_LOG_AUTHOR, (&quot;%s\n&quot;, szMsg) );</span>
<span class="lineNum">      48 </span>            :         }
<span class="lineNum">      49 </span>            : #endif
<span class="lineNum">      50 </span><span class="lineCov">         65 :         return e;</span>
<span class="lineNum">      51 </span>            : }
<a name="52"><span class="lineNum">      52 </span>            : </a>
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span><span class="lineCov">        948 : static void gf_media_update_bitrate_ex(GF_ISOFile *file, u32 track, Bool use_esd)</span>
<span class="lineNum">      55 </span>            : {
<span class="lineNum">      56 </span>            : #ifndef GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">      57 </span>            :         u32 i, count, timescale, db_size, cdur, csize;
<span class="lineNum">      58 </span>            :         u64 time_wnd, max_rate, avg_rate, bitrate;
<span class="lineNum">      59 </span>            :         Double br;
<span class="lineNum">      60 </span>            :         GF_ISOSample sample;
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span>            :         db_size = 0;
<span class="lineNum">      63 </span>            :         max_rate = avg_rate = time_wnd = bitrate = 0;
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span>            :         csize = 0;
<span class="lineNum">      66 </span>            :         cdur = 0;
<span class="lineNum">      67 </span><span class="lineCov">        948 :         if (gf_isom_get_media_type(file, track)==GF_ISOM_MEDIA_AUDIO) {</span>
<span class="lineNum">      68 </span><span class="lineCov">        236 :                 csize = gf_isom_get_constant_sample_size(file, track);</span>
<span class="lineNum">      69 </span><span class="lineCov">        236 :                 cdur = gf_isom_get_constant_sample_duration(file, track);</span>
<span class="lineNum">      70 </span><span class="lineCov">        236 :                 if (cdur &gt; 1) cdur = 0;</span>
<span class="lineNum">      71 </span>            :         }
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span>            :         memset(&amp;sample, 0, sizeof(GF_ISOSample));
<span class="lineNum">      74 </span><span class="lineCov">        948 :         timescale = gf_isom_get_media_timescale(file, track);</span>
<span class="lineNum">      75 </span><span class="lineCov">        948 :         count = gf_isom_get_sample_count(file, track);</span>
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span><span class="lineCov">        948 :         if (csize &amp;&amp; cdur) {</span>
<span class="lineNum">      78 </span>            :                 db_size = 0;
<span class="lineNum">      79 </span><span class="lineCov">         16 :                 avg_rate = 8 * csize * timescale / cdur;</span>
<span class="lineNum">      80 </span>            :                 bitrate = avg_rate;
<span class="lineNum">      81 </span>            :         } else {
<span class="lineNum">      82 </span>            :                 u32 rate = 0;
<span class="lineNum">      83 </span><span class="lineCov">     424314 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">      84 </span>            :                         u32 di;
<span class="lineNum">      85 </span><span class="lineCov">     423386 :                         GF_ISOSample *samp = gf_isom_get_sample_info_ex(file, track, i+1, &amp;di, NULL, &amp;sample);</span>
<span class="lineNum">      86 </span><span class="lineCov">     423386 :                         if (!samp) break;</span>
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span><span class="lineCov">     423382 :                         if (samp-&gt;dataLength &gt; db_size) db_size = samp-&gt;dataLength;</span>
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span><span class="lineCov">     423382 :                         avg_rate += samp-&gt;dataLength;</span>
<span class="lineNum">      91 </span><span class="lineCov">     423382 :                         rate += samp-&gt;dataLength;</span>
<span class="lineNum">      92 </span><span class="lineCov">     423382 :                         if (samp-&gt;DTS &gt; time_wnd + timescale) {</span>
<span class="lineNum">      93 </span><span class="lineCov">      14566 :                                 if (rate &gt; max_rate) max_rate = rate;</span>
<span class="lineNum">      94 </span>            :                                 time_wnd = samp-&gt;DTS;
<span class="lineNum">      95 </span>            :                                 rate = 0;
<span class="lineNum">      96 </span>            :                         }
<span class="lineNum">      97 </span>            :                 }
<span class="lineNum">      98 </span>            :         }
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span><span class="lineCov">        948 :         br = (Double) (s64) gf_isom_get_media_duration(file, track);</span>
<span class="lineNum">     101 </span><span class="lineCov">        948 :         br /= timescale;</span>
<span class="lineNum">     102 </span><span class="lineCov">        948 :         if (br) {</span>
<span class="lineNum">     103 </span>            :                 GF_ESD *esd = NULL;
<span class="lineNum">     104 </span><span class="lineCov">        942 :                 if (!csize || !cdur) {</span>
<span class="lineNum">     105 </span><span class="lineCov">        926 :                         bitrate = (u32) ((Double) (s64)avg_rate / br);</span>
<span class="lineNum">     106 </span><span class="lineCov">        926 :                         bitrate *= 8;</span>
<span class="lineNum">     107 </span><span class="lineCov">        926 :                         max_rate *= 8;</span>
<span class="lineNum">     108 </span>            :                 }
<span class="lineNum">     109 </span><span class="lineCov">        942 :                 if (!max_rate) max_rate = bitrate;</span>
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span><span class="lineCov">        942 :                 if (use_esd) esd = gf_isom_get_esd(file, track, 1);</span>
<span class="lineNum">     112 </span><span class="lineCov">         61 :                 if (esd &amp;&amp; esd-&gt;decoderConfig) {</span>
<span class="lineNum">     113 </span><span class="lineCov">         28 :                         esd-&gt;decoderConfig-&gt;avgBitrate = (u32) bitrate;</span>
<span class="lineNum">     114 </span><span class="lineCov">         28 :                         esd-&gt;decoderConfig-&gt;maxBitrate = (u32) max_rate;</span>
<span class="lineNum">     115 </span><span class="lineCov">         28 :                         esd-&gt;decoderConfig-&gt;bufferSizeDB = db_size;</span>
<span class="lineNum">     116 </span><span class="lineCov">         28 :                         gf_isom_change_mpeg4_description(file, track, 1, esd);</span>
<span class="lineNum">     117 </span>            :                 } else {
<span class="lineNum">     118 </span>            :                         /*move to bps*/
<span class="lineNum">     119 </span><span class="lineCov">        914 :                         gf_isom_update_bitrate(file, track, 1, (u32) bitrate, (u32) max_rate, db_size);</span>
<span class="lineNum">     120 </span>            :                 }
<span class="lineNum">     121 </span><span class="lineCov">        942 :                 if (esd) gf_odf_desc_del((GF_Descriptor *)esd);</span>
<span class="lineNum">     122 </span>            :         }
<span class="lineNum">     123 </span>            : #endif
<span class="lineNum">     124 </span><span class="lineCov">        948 : }</span>
<a name="125"><span class="lineNum">     125 </span>            : </a>
<span class="lineNum">     126 </span>            : GF_EXPORT
<span class="lineNum">     127 </span><span class="lineCov">        887 : void gf_media_update_bitrate(GF_ISOFile *file, u32 track)</span>
<span class="lineNum">     128 </span>            : {
<span class="lineNum">     129 </span><span class="lineCov">        887 :         gf_media_update_bitrate_ex(file, track, GF_FALSE);</span>
<a name="130"><span class="lineNum">     130 </span>            : </a>
<span class="lineNum">     131 </span><span class="lineCov">        887 : }</span>
<span class="lineNum">     132 </span><span class="lineCov">         16 : void gf_media_get_video_timing(Double fps, u32 *timescale, u32 *dts_inc)</span>
<span class="lineNum">     133 </span>            : {
<span class="lineNum">     134 </span><span class="lineCov">         16 :         u32 fps_1000 = (u32) (fps*1000 + 0.5);</span>
<span class="lineNum">     135 </span>            :         /*handle all drop-frame formats*/
<span class="lineNum">     136 </span><span class="lineCov">         16 :         if (fps_1000==29970) {</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :                 *timescale = 30000;</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :                 *dts_inc = 1001;</span>
<span class="lineNum">     139 </span>            :         }
<span class="lineNum">     140 </span><span class="lineCov">         16 :         else if (fps_1000==23976) {</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :                 *timescale = 24000;</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :                 *dts_inc = 1001;</span>
<span class="lineNum">     143 </span>            :         }
<span class="lineNum">     144 </span><span class="lineCov">         16 :         else if (fps_1000==59940) {</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :                 *timescale = 60000;</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :                 *dts_inc = 1001;</span>
<span class="lineNum">     147 </span>            :         } else {
<span class="lineNum">     148 </span><span class="lineCov">         16 :                 *timescale = fps_1000;</span>
<span class="lineNum">     149 </span><span class="lineCov">         16 :                 *dts_inc = 1000;</span>
<span class="lineNum">     150 </span>            :         }
<span class="lineNum">     151 </span><span class="lineCov">         16 : }</span>
<a name="152"><span class="lineNum">     152 </span>            : </a>
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span><span class="lineCov">          1 : static GF_Err gf_import_afx_sc3dmc(GF_MediaImporter *import, Bool mult_desc_allowed)</span>
<span class="lineNum">     155 </span>            : {
<span class="lineNum">     156 </span>            :         GF_Err e;
<span class="lineNum">     157 </span>            :         Bool destroy_esd;
<span class="lineNum">     158 </span>            :         u32 size, track, di, dsi_len;
<span class="lineNum">     159 </span>            :         GF_ISOSample *samp;
<span class="lineNum">     160 </span>            :         u32 codecid;
<span class="lineNum">     161 </span>            :         char *dsi, *data;
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span><span class="lineCov">          1 :         if (import-&gt;flags &amp; GF_IMPORT_PROBE_ONLY) {</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :                 import-&gt;tk_info[0].track_num = 1;</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :                 import-&gt;tk_info[0].stream_type = GF_STREAM_SCENE;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :                 import-&gt;tk_info[0].codecid = GF_CODECID_AFX;</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :                 import-&gt;nb_tracks = 1;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     169 </span>            :         }
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineCov">          1 :         e = gf_file_load_data(import-&gt;in_name, (u8 **) &amp;data, &amp;size);</span>
<span class="lineNum">     172 </span><span class="lineCov">          1 :         if (e) return gf_import_message(import, e, &quot;Opening file %s failed&quot;, import-&gt;in_name);</span>
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span><span class="lineCov">          1 :         if ((s32) size &lt; 0) return GF_IO_ERR;</span>
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span>            :         codecid = GF_CODECID_AFX;
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span><span class="lineCov">          1 :         dsi = (char *)gf_malloc(1);</span>
<span class="lineNum">     179 </span>            :         dsi_len = 1;
<span class="lineNum">     180 </span><span class="lineCov">          1 :         dsi[0] = GPAC_AFX_SCALABLE_COMPLEXITY;</span>
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span>            :         destroy_esd = GF_FALSE;
<span class="lineNum">     183 </span><span class="lineCov">          1 :         if (!import-&gt;esd) {</span>
<span class="lineNum">     184 </span><span class="lineCov">          1 :                 import-&gt;esd = gf_odf_desc_esd_new(0);</span>
<span class="lineNum">     185 </span>            :                 destroy_esd = GF_TRUE;
<span class="lineNum">     186 </span>            :         }
<span class="lineNum">     187 </span>            :         /*update stream type/oti*/
<span class="lineNum">     188 </span><span class="lineCov">          1 :         if (!import-&gt;esd-&gt;decoderConfig) import-&gt;esd-&gt;decoderConfig = (GF_DecoderConfig *) gf_odf_desc_new(GF_ODF_DCD_TAG);</span>
<span class="lineNum">     189 </span><span class="lineCov">          1 :         if (!import-&gt;esd-&gt;slConfig) import-&gt;esd-&gt;slConfig = (GF_SLConfig *) gf_odf_desc_new(GF_ODF_SLC_TAG);</span>
<span class="lineNum">     190 </span><span class="lineCov">          1 :         import-&gt;esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_SCENE;</span>
<span class="lineNum">     191 </span><span class="lineCov">          1 :         import-&gt;esd-&gt;decoderConfig-&gt;objectTypeIndication = codecid;</span>
<span class="lineNum">     192 </span><span class="lineCov">          1 :         import-&gt;esd-&gt;decoderConfig-&gt;bufferSizeDB = size;</span>
<span class="lineNum">     193 </span><span class="lineCov">          1 :         import-&gt;esd-&gt;decoderConfig-&gt;avgBitrate = 8*size;</span>
<span class="lineNum">     194 </span><span class="lineCov">          1 :         import-&gt;esd-&gt;decoderConfig-&gt;maxBitrate = 8*size;</span>
<span class="lineNum">     195 </span><span class="lineCov">          1 :         import-&gt;esd-&gt;slConfig-&gt;timestampResolution = 1000;</span>
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span><span class="lineCov">          1 :         if (!import-&gt;esd-&gt;decoderConfig-&gt;decoderSpecificInfo) import-&gt;esd-&gt;decoderConfig-&gt;decoderSpecificInfo = (GF_DefaultDescriptor *) gf_odf_desc_new(GF_ODF_DSI_TAG);</span>
<span class="lineNum">     198 </span><span class="lineCov">          1 :         if (import-&gt;esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data) gf_free(import-&gt;esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data);</span>
<span class="lineNum">     199 </span><span class="lineCov">          1 :         import-&gt;esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data = dsi;</span>
<span class="lineNum">     200 </span><span class="lineCov">          1 :         import-&gt;esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;dataLength = dsi_len;</span>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span>            :         track = 0;
<span class="lineNum">     204 </span><span class="lineCov">          1 :         if (mult_desc_allowed)</span>
<span class="lineNum">     205 </span><span class="lineCov">          1 :                 track = gf_isom_get_track_by_id(import-&gt;dest, import-&gt;esd-&gt;ESID);</span>
<span class="lineNum">     206 </span><span class="lineCov">          1 :         if (!track)</span>
<span class="lineNum">     207 </span><span class="lineCov">          1 :                 track = gf_isom_new_track(import-&gt;dest, import-&gt;esd-&gt;ESID, GF_ISOM_MEDIA_SCENE, 1000);</span>
<span class="lineNum">     208 </span><span class="lineCov">          1 :         if (!track) {</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :                 e = gf_isom_last_error(import-&gt;dest);</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :                 goto exit;</span>
<span class="lineNum">     211 </span>            :         }
<span class="lineNum">     212 </span><span class="lineCov">          1 :         gf_isom_set_track_enabled(import-&gt;dest, track, GF_TRUE);</span>
<span class="lineNum">     213 </span><span class="lineCov">          1 :         if (!import-&gt;esd-&gt;ESID) import-&gt;esd-&gt;ESID = gf_isom_get_track_id(import-&gt;dest, track);</span>
<span class="lineNum">     214 </span><span class="lineCov">          1 :         import-&gt;final_trackID = import-&gt;esd-&gt;ESID;</span>
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span><span class="lineCov">          1 :         if (import-&gt;source_magic)</span>
<span class="lineNum">     217 </span><span class="lineCov">          1 :                 gf_isom_set_track_magic(import-&gt;dest, track, import-&gt;source_magic);</span>
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span><span class="lineCov">          1 :         e = gf_isom_new_mpeg4_description(import-&gt;dest, track, import-&gt;esd, (import-&gt;flags &amp; GF_IMPORT_USE_DATAREF) ? import-&gt;in_name : NULL, NULL, &amp;di);</span>
<span class="lineNum">     220 </span><span class="lineCov">          1 :         if (e) goto exit;</span>
<span class="lineNum">     221 </span>            :         //gf_isom_set_visual_info(import-&gt;dest, track, di, w, h);
<span class="lineNum">     222 </span><span class="lineCov">          1 :         samp = gf_isom_sample_new();</span>
<span class="lineNum">     223 </span><span class="lineCov">          1 :         samp-&gt;IsRAP = RAP;</span>
<span class="lineNum">     224 </span><span class="lineCov">          1 :         samp-&gt;dataLength = size;</span>
<span class="lineNum">     225 </span><span class="lineCov">          1 :         if (import-&gt;initial_time_offset) samp-&gt;DTS = (u64) (import-&gt;initial_time_offset*1000);</span>
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span><span class="lineCov">          1 :         gf_import_message(import, GF_OK, &quot;%s import %s&quot;, &quot;SC3DMC&quot;, import-&gt;in_name);</span>
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span>            :         /*we must start a track from DTS = 0*/
<span class="lineNum">     230 </span><span class="lineCov">          1 :         if (!gf_isom_get_sample_count(import-&gt;dest, track) &amp;&amp; samp-&gt;DTS) {</span>
<span class="lineNum">     231 </span>            :                 /*todo - we could add an edit list*/
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :                 samp-&gt;DTS=0;</span>
<span class="lineNum">     233 </span>            :         }
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span><span class="lineCov">          1 :         gf_set_progress(&quot;Importing SC3DMC&quot;, 0, 1);</span>
<span class="lineNum">     236 </span><span class="lineCov">          1 :         if (import-&gt;flags &amp; GF_IMPORT_USE_DATAREF) {</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :                 e = gf_isom_add_sample_reference(import-&gt;dest, track, di, samp, (u64) 0);</span>
<span class="lineNum">     238 </span>            :         } else {
<span class="lineNum">     239 </span><span class="lineCov">          1 :                 samp-&gt;data = data;</span>
<span class="lineNum">     240 </span><span class="lineCov">          1 :                 e = gf_isom_add_sample(import-&gt;dest, track, di, samp);</span>
<span class="lineNum">     241 </span><span class="lineCov">          1 :                 samp-&gt;data = NULL;</span>
<span class="lineNum">     242 </span>            :         }
<span class="lineNum">     243 </span><span class="lineCov">          1 :         gf_set_progress(&quot;Importing SC3DMC&quot;, 1, 1);</span>
<span class="lineNum">     244 </span>            : 
<span class="lineNum">     245 </span><span class="lineCov">          1 :         gf_isom_sample_del(&amp;samp);</span>
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineCov">          1 : exit:</span>
<span class="lineNum">     248 </span><span class="lineCov">          1 :         gf_free(data);</span>
<span class="lineNum">     249 </span><span class="lineCov">          1 :         if (import-&gt;esd &amp;&amp; destroy_esd) {</span>
<span class="lineNum">     250 </span><span class="lineCov">          1 :                 gf_odf_desc_del((GF_Descriptor *) import-&gt;esd);</span>
<span class="lineNum">     251 </span><span class="lineCov">          1 :                 import-&gt;esd = NULL;</span>
<span class="lineNum">     252 </span>            :         }
<span class="lineNum">     253 </span>            :         return e;
<a name="254"><span class="lineNum">     254 </span>            : }</a>
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span><span class="lineCov">         81 : static GF_Err gf_import_isomedia_track(GF_MediaImporter *import)</span>
<span class="lineNum">     257 </span>            : {
<span class="lineNum">     258 </span>            :         GF_Err e;
<span class="lineNum">     259 </span>            :         u64 offset, sampDTS, duration, dts_offset;
<span class="lineNum">     260 </span>            :         Bool is_nalu_video=GF_FALSE;
<span class="lineNum">     261 </span>            :         u32 track, di, trackID, track_in, i, num_samples, mtype, w, h, sr, sbr_sr, ch, mstype, cur_extract_mode, cdur, bps;
<span class="lineNum">     262 </span>            :         u64 mtimescale;
<span class="lineNum">     263 </span>            :         s32 trans_x, trans_y;
<span class="lineNum">     264 </span>            :         s16 layer;
<span class="lineNum">     265 </span>            :         char *lang;
<span class="lineNum">     266 </span><span class="lineCov">         81 :         u8 *sai_buffer = NULL;</span>
<span class="lineNum">     267 </span><span class="lineCov">         81 :         u32 sai_buffer_size = 0, sai_buffer_alloc = 0;</span>
<span class="lineNum">     268 </span><span class="lineCov">         81 :         const char *orig_name = gf_url_get_resource_name(gf_isom_get_filename(import-&gt;orig));</span>
<span class="lineNum">     269 </span>            :         Bool sbr, ps;
<span class="lineNum">     270 </span>            :         GF_ISOSample *samp;
<span class="lineNum">     271 </span>            :         GF_ESD *origin_esd;
<span class="lineNum">     272 </span>            :         GF_InitialObjectDescriptor *iod;
<span class="lineNum">     273 </span>            :         Bool is_cenc;
<span class="lineNum">     274 </span>            :         GF_ISOTrackCloneFlags clone_flags;
<span class="lineNum">     275 </span>            :         sampDTS = 0;
<span class="lineNum">     276 </span><span class="lineCov">         81 :         if (import-&gt;flags &amp; GF_IMPORT_PROBE_ONLY) {</span>
<span class="lineNum">     277 </span><span class="lineCov">         60 :                 for (i=0; i&lt;gf_isom_get_track_count(import-&gt;orig); i++) {</span>
<span class="lineNum">     278 </span><span class="lineCov">         40 :                         import-&gt;tk_info[i].track_num = gf_isom_get_track_id(import-&gt;orig, i+1);</span>
<span class="lineNum">     279 </span><span class="lineCov">         40 :                         mtype = gf_isom_get_media_type(import-&gt;orig, i+1);</span>
<span class="lineNum">     280 </span><span class="lineCov">         40 :                         switch (mtype) {</span>
<span class="lineNum">     281 </span><span class="lineCov">         12 :                         case GF_ISOM_MEDIA_VISUAL:</span>
<span class="lineNum">     282 </span><span class="lineCov">         12 :                                 import-&gt;tk_info[i].stream_type = GF_STREAM_VISUAL;</span>
<span class="lineNum">     283 </span><span class="lineCov">         12 :                                 break;</span>
<span class="lineNum">     284 </span><span class="lineCov">         20 :                         case GF_ISOM_MEDIA_AUDIO:</span>
<span class="lineNum">     285 </span><span class="lineCov">         20 :                                 import-&gt;tk_info[i].stream_type = GF_STREAM_AUDIO;</span>
<span class="lineNum">     286 </span><span class="lineCov">         20 :                                 break;</span>
<span class="lineNum">     287 </span><span class="lineCov">          8 :                         case GF_ISOM_MEDIA_TEXT:</span>
<span class="lineNum">     288 </span><span class="lineCov">          8 :                                 import-&gt;tk_info[i].stream_type = GF_STREAM_TEXT;</span>
<span class="lineNum">     289 </span><span class="lineCov">          8 :                                 break;</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :                         case GF_ISOM_MEDIA_SCENE:</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :                                 import-&gt;tk_info[i].stream_type = GF_STREAM_SCENE;</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :                         default:</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :                                 import-&gt;tk_info[i].stream_type = mtype;</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     296 </span>            :                         }
<span class="lineNum">     297 </span><span class="lineCov">         40 :                         if (import-&gt;tk_info[i].stream_type == GF_STREAM_VISUAL) {</span>
<span class="lineNum">     298 </span><span class="lineCov">         12 :                                 gf_isom_get_visual_info(import-&gt;orig, i+1, 1, &amp;import-&gt;tk_info[i].video_info.width, &amp;import-&gt;tk_info[i].video_info.height);</span>
<span class="lineNum">     299 </span><span class="lineCov">         28 :                         } else if (import-&gt;tk_info[i].stream_type == GF_STREAM_AUDIO) {</span>
<span class="lineNum">     300 </span><span class="lineCov">         20 :                                 gf_isom_get_audio_info(import-&gt;orig, i+1, 1, &amp;import-&gt;tk_info[i].audio_info.sample_rate, &amp;import-&gt;tk_info[i].audio_info.nb_channels, NULL);</span>
<span class="lineNum">     301 </span>            :                         }
<span class="lineNum">     302 </span><span class="lineCov">         40 :                         lang = NULL;</span>
<span class="lineNum">     303 </span><span class="lineCov">         40 :                         gf_isom_get_media_language(import-&gt;orig, i+1, &amp;lang);</span>
<span class="lineNum">     304 </span><span class="lineCov">         40 :                         if (lang) {</span>
<span class="lineNum">     305 </span><span class="lineCov">         40 :                                 import-&gt;tk_info[i].lang = GF_4CC(' ', lang[0], lang[1], lang[2]);</span>
<span class="lineNum">     306 </span><span class="lineCov">         40 :                                 gf_free(lang);</span>
<span class="lineNum">     307 </span><span class="lineCov">         40 :                                 lang = NULL;</span>
<span class="lineNum">     308 </span>            :                         }
<span class="lineNum">     309 </span><span class="lineCov">         40 :                         gf_media_get_rfc_6381_codec_name(import-&gt;orig, i+1, import-&gt;tk_info[i].szCodecProfile, GF_FALSE, GF_FALSE);</span>
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span><span class="lineCov">         40 :                         import-&gt;nb_tracks ++;</span>
<span class="lineNum">     312 </span>            :                 }
<span class="lineNum">     313 </span>            :                 return GF_OK;
<span class="lineNum">     314 </span>            :         }
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span><span class="lineCov">         61 :         trackID = import-&gt;trackID;</span>
<span class="lineNum">     317 </span><span class="lineCov">         61 :         if (!trackID) {</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :                 if (gf_isom_get_track_count(import-&gt;orig) != 1) return gf_import_message(import, GF_BAD_PARAM, &quot;Several tracks in MP4 - please indicate track to import&quot;);</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :                 trackID = gf_isom_get_track_id(import-&gt;orig, 1);</span>
<span class="lineNum">     320 </span>            :         }
<span class="lineNum">     321 </span><span class="lineCov">         61 :         track_in = gf_isom_get_track_by_id(import-&gt;orig, trackID);</span>
<span class="lineNum">     322 </span><span class="lineCov">         61 :         if (!track_in) return gf_import_message(import, GF_URL_ERROR, &quot;Cannot find track ID %d in file&quot;, trackID);</span>
<span class="lineNum">     323 </span>            : 
<span class="lineNum">     324 </span><span class="lineCov">         61 :         origin_esd = gf_isom_get_esd(import-&gt;orig, track_in, 1);</span>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span><span class="lineCov">         61 :         if (import-&gt;esd &amp;&amp; origin_esd) {</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :                 origin_esd-&gt;OCRESID = import-&gt;esd-&gt;OCRESID;</span>
<span class="lineNum">     328 </span>            :                 /*there may be other things to import...*/
<span class="lineNum">     329 </span>            :         }
<span class="lineNum">     330 </span>            :         ps = GF_FALSE;
<span class="lineNum">     331 </span>            :         sbr = GF_FALSE;
<span class="lineNum">     332 </span>            :         sbr_sr = 0;
<span class="lineNum">     333 </span><span class="lineCov">         61 :         w = h = 0;</span>
<span class="lineNum">     334 </span><span class="lineCov">         61 :         cur_extract_mode = gf_isom_get_nalu_extract_mode(import-&gt;orig, track_in);</span>
<span class="lineNum">     335 </span><span class="lineCov">         61 :         iod = (GF_InitialObjectDescriptor *) gf_isom_get_root_od(import-&gt;orig);</span>
<span class="lineNum">     336 </span><span class="lineCov">         61 :         if (iod &amp;&amp; (iod-&gt;tag != GF_ODF_IOD_TAG)) {</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                 gf_odf_desc_del((GF_Descriptor *) iod);</span>
<span class="lineNum">     338 </span>            :                 iod = NULL;
<span class="lineNum">     339 </span>            :         }
<span class="lineNum">     340 </span><span class="lineCov">         61 :         mtype = gf_isom_get_media_type(import-&gt;orig, track_in);</span>
<span class="lineNum">     341 </span><span class="lineCov">         61 :         if (mtype==GF_ISOM_MEDIA_VISUAL) {</span>
<span class="lineNum">     342 </span><span class="lineCov">         26 :                 u8 PL = iod ? iod-&gt;visual_profileAndLevel : 0xFE;</span>
<span class="lineNum">     343 </span><span class="lineCov">         26 :                 gf_isom_get_visual_info(import-&gt;orig, track_in, 1, &amp;w, &amp;h);</span>
<span class="lineNum">     344 </span>            : #ifndef GPAC_DISABLE_AV_PARSERS
<span class="lineNum">     345 </span>            :                 /*for MPEG-4 visual, always check size (don't trust input file)*/
<span class="lineNum">     346 </span><span class="lineCov">         26 :                 if (origin_esd &amp;&amp; (origin_esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_MPEG4_PART2)) {</span>
<span class="lineNum">     347 </span>            :                         GF_M4VDecSpecInfo dsi;
<span class="lineNum">     348 </span><span class="lineCov">          2 :                         gf_m4v_get_config(origin_esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data, origin_esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;dataLength, &amp;dsi);</span>
<span class="lineNum">     349 </span><span class="lineCov">          2 :                         w = dsi.width;</span>
<span class="lineNum">     350 </span><span class="lineCov">          2 :                         h = dsi.height;</span>
<span class="lineNum">     351 </span><span class="lineCov">          2 :                         PL = dsi.VideoPL;</span>
<span class="lineNum">     352 </span>            :                 }
<span class="lineNum">     353 </span>            : #endif
<span class="lineNum">     354 </span><span class="lineCov">         26 :                 gf_isom_set_pl_indication(import-&gt;dest, GF_ISOM_PL_VISUAL, PL);</span>
<span class="lineNum">     355 </span>            :         }
<span class="lineNum">     356 </span><span class="lineCov">         35 :         else if (mtype==GF_ISOM_MEDIA_AUDIO) {</span>
<span class="lineNum">     357 </span><span class="lineCov">         21 :                 u8 PL = iod ? iod-&gt;audio_profileAndLevel : 0xFE;</span>
<span class="lineNum">     358 </span><span class="lineCov">         21 :                 bps = 16;</span>
<span class="lineNum">     359 </span><span class="lineCov">         21 :                 sr = ch = sbr_sr = 0;</span>
<span class="lineNum">     360 </span>            :                 sbr = GF_FALSE;
<span class="lineNum">     361 </span>            :                 ps = GF_FALSE;
<span class="lineNum">     362 </span><span class="lineCov">         21 :                 gf_isom_get_audio_info(import-&gt;orig, track_in, 1, &amp;sr, &amp;ch, &amp;bps);</span>
<span class="lineNum">     363 </span>            : #ifndef GPAC_DISABLE_AV_PARSERS
<span class="lineNum">     364 </span><span class="lineCov">         21 :                 if (origin_esd &amp;&amp; origin_esd-&gt;decoderConfig &amp;&amp; (origin_esd-&gt;decoderConfig-&gt;objectTypeIndication==GF_CODECID_AAC_MPEG4)) {</span>
<span class="lineNum">     365 </span><span class="lineCov">          5 :                         if (origin_esd-&gt;decoderConfig-&gt;decoderSpecificInfo) {</span>
<span class="lineNum">     366 </span>            :                                 GF_M4ADecSpecInfo dsi;
<span class="lineNum">     367 </span><span class="lineCov">          5 :                                 gf_m4a_get_config(origin_esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data, origin_esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;dataLength, &amp;dsi);</span>
<span class="lineNum">     368 </span><span class="lineCov">          5 :                                 sr = dsi.base_sr;</span>
<span class="lineNum">     369 </span><span class="lineCov">          5 :                                 if (dsi.has_sbr) sbr_sr = dsi.sbr_sr;</span>
<span class="lineNum">     370 </span><span class="lineCov">          5 :                                 ch = dsi.nb_chan;</span>
<span class="lineNum">     371 </span><span class="lineCov">          5 :                                 PL = dsi.audioPL;</span>
<span class="lineNum">     372 </span><span class="lineCov">          5 :                                 sbr = dsi.has_sbr ? ((dsi.base_object_type==GF_M4A_AAC_SBR || dsi.base_object_type==GF_M4A_AAC_PS) ? 2 : 1) : GF_FALSE;</span>
<span class="lineNum">     373 </span><span class="lineCov">          5 :                                 ps = dsi.has_ps;</span>
<span class="lineNum">     374 </span>            :                         } else {
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_PARSER, (&quot;Missing DecoderSpecificInfo in MPEG-4 AAC stream\n&quot;));</span>
<span class="lineNum">     376 </span>            :                         }
<span class="lineNum">     377 </span>            :                 }
<span class="lineNum">     378 </span>            : #endif
<span class="lineNum">     379 </span><span class="lineCov">         21 :                 gf_isom_set_pl_indication(import-&gt;dest, GF_ISOM_PL_AUDIO, PL);</span>
<span class="lineNum">     380 </span>            :         }
<span class="lineNum">     381 </span><span class="lineCov">         14 :         else if (mtype==GF_ISOM_MEDIA_SUBPIC) {</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :                 w = h = 0;</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :                 trans_x = trans_y = 0;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :                 layer = 0;</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :                 if (origin_esd &amp;&amp; origin_esd-&gt;decoderConfig-&gt;objectTypeIndication == GF_CODECID_SUBPIC) {</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :                         gf_isom_get_track_layout_info(import-&gt;orig, track_in, &amp;w, &amp;h, &amp;trans_x, &amp;trans_y, &amp;layer);</span>
<span class="lineNum">     387 </span>            :                 }
<span class="lineNum">     388 </span>            :         }
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineCov">         61 :         gf_odf_desc_del((GF_Descriptor *) iod);</span>
<span class="lineNum">     391 </span><span class="lineCov">         61 :         if ( ! gf_isom_get_track_count(import-&gt;dest)) {</span>
<span class="lineNum">     392 </span>            :                 u32 timescale;
<span class="lineNum">     393 </span><span class="lineCov">         32 :                 if (import-&gt;moov_timescale&lt;0)</span>
<span class="lineNum">     394 </span><span class="lineCov">          2 :                         timescale = gf_isom_get_media_timescale(import-&gt;orig, track_in);</span>
<span class="lineNum">     395 </span>            :                 else
<span class="lineNum">     396 </span><span class="lineCov">         30 :                         timescale = gf_isom_get_timescale(import-&gt;orig);</span>
<span class="lineNum">     397 </span><span class="lineCov">         32 :                 gf_isom_set_timescale(import-&gt;dest, timescale);</span>
<span class="lineNum">     398 </span>            :         }
<span class="lineNum">     399 </span>            :         clone_flags = GF_ISOM_CLONE_TRACK_NO_QT;
<span class="lineNum">     400 </span><span class="lineCov">         61 :         if (import-&gt;asemode == GF_IMPORT_AUDIO_SAMPLE_ENTRY_v1_QTFF) {</span>
<span class="lineNum">     401 </span>            :                 clone_flags = 0;
<span class="lineNum">     402 </span>            :         } else {
<span class="lineNum">     403 </span><span class="lineCov">         50 :                 const char *dst = gf_isom_get_filename(import-&gt;dest);</span>
<span class="lineNum">     404 </span><span class="lineCov">         50 :                 if (dst &amp;&amp; strstr(dst, &quot;.mov&quot;))</span>
<span class="lineNum">     405 </span>            :                         clone_flags = 0;
<span class="lineNum">     406 </span>            :         }
<span class="lineNum">     407 </span>            : 
<span class="lineNum">     408 </span><span class="lineCov">         61 :         if (import-&gt;flags &amp; GF_IMPORT_USE_DATAREF) clone_flags |= GF_ISOM_CLONE_TRACK_KEEP_DREF;</span>
<span class="lineNum">     409 </span><span class="lineCov">         61 :         e = gf_isom_clone_track(import-&gt;orig, track_in, import-&gt;dest, clone_flags, &amp;track);</span>
<span class="lineNum">     410 </span><span class="lineCov">         61 :         if (e) goto exit;</span>
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span><span class="lineCov">         61 :         if ((gf_isom_get_track_count(import-&gt;dest)==1) &amp;&amp; gf_isom_has_keep_utc_times(import-&gt;dest)) {</span>
<span class="lineNum">     414 </span>            :                 u64 cdate, mdate;
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :                 gf_isom_get_creation_time(import-&gt;orig, &amp;cdate, &amp;mdate);</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :                 gf_isom_set_creation_time(import-&gt;dest, cdate, mdate);</span>
<span class="lineNum">     417 </span>            :         }
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span><span class="lineCov">         61 :         di = 1;</span>
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineCov">         61 :         if (import-&gt;esd &amp;&amp; import-&gt;esd-&gt;ESID) {</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :                 e = gf_isom_set_track_id(import-&gt;dest, track, import-&gt;esd-&gt;ESID);</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :                 if (e) goto exit;</span>
<span class="lineNum">     424 </span>            :         }
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span><span class="lineCov">         61 :         import-&gt;final_trackID = gf_isom_get_track_id(import-&gt;dest, track);</span>
<span class="lineNum">     427 </span><span class="lineCov">         61 :         if (import-&gt;esd &amp;&amp; import-&gt;esd-&gt;dependsOnESID) {</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :                 gf_isom_set_track_reference(import-&gt;dest, track, GF_ISOM_REF_DECODE, import-&gt;esd-&gt;dependsOnESID);</span>
<span class="lineNum">     429 </span>            :         }
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineCov">         61 :         if (import-&gt;trackID &amp;&amp; !(import-&gt;flags &amp; GF_IMPORT_KEEP_REFS)) {</span>
<span class="lineNum">     432 </span><span class="lineCov">         11 :                 gf_isom_remove_track_references(import-&gt;dest, track);</span>
<span class="lineNum">     433 </span>            :         }
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineCov">         61 :         if (import-&gt;source_magic)</span>
<span class="lineNum">     436 </span><span class="lineCov">         61 :                 gf_isom_set_track_magic(import-&gt;dest, track, import-&gt;source_magic);</span>
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span><span class="lineCov">         61 :         mstype = gf_isom_get_media_subtype(import-&gt;orig, track_in, di);</span>
<span class="lineNum">     439 </span><span class="lineCov">         61 :         switch (mtype) {</span>
<span class="lineNum">     440 </span><span class="lineCov">         26 :         case GF_ISOM_MEDIA_VISUAL:</span>
<span class="lineNum">     441 </span><span class="lineCov">         26 :                 gf_import_message(import, GF_OK, &quot;IsoMedia import %s - track ID %d - Video (size %d x %d)&quot;, orig_name, trackID, w, h);</span>
<span class="lineNum">     442 </span><span class="lineCov">         26 :                 break;</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :     case GF_ISOM_MEDIA_AUXV:</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :         gf_import_message(import, GF_OK, &quot;IsoMedia import %s - track ID %d - Auxiliary Video (size %d x %d)&quot;, orig_name, trackID, w, h);</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :     case GF_ISOM_MEDIA_PICT:</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :         gf_import_message(import, GF_OK, &quot;IsoMedia import %s - track ID %d - Picture sequence (size %d x %d)&quot;, orig_name, trackID, w, h);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     449 </span><span class="lineCov">         21 :         case GF_ISOM_MEDIA_AUDIO:</span>
<span class="lineNum">     450 </span>            :         {
<span class="lineNum">     451 </span><span class="lineCov">         21 :                 if (ps) {</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :                         gf_import_message(import, GF_OK, &quot;IsoMedia import %s - track ID %d - HE-AACv2 (SR %d - SBR-SR %d - %d channels)&quot;, orig_name, trackID, sr, sbr_sr, ch);</span>
<span class="lineNum">     453 </span><span class="lineCov">         21 :                 } else if (sbr) {</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :                         gf_import_message(import, GF_OK, &quot;IsoMedia import %s - track ID %d - HE-AAC (SR %d - SBR-SR %d - %d channels)&quot;, orig_name, trackID, sr, sbr_sr, ch);</span>
<span class="lineNum">     455 </span>            :                 } else {
<span class="lineNum">     456 </span><span class="lineCov">         21 :                         gf_import_message(import, GF_OK, &quot;IsoMedia import %s - track ID %d - Audio (SR %d - %d channels)&quot;, orig_name, trackID, sr, ch);</span>
<span class="lineNum">     457 </span>            :                 }
<span class="lineNum">     458 </span><span class="lineCov">         21 :                 if (import-&gt;asemode != GF_IMPORT_AUDIO_SAMPLE_ENTRY_NOT_SET) {</span>
<span class="lineNum">     459 </span><span class="lineCov">          8 :                         gf_isom_get_audio_info(import-&gt;orig, track_in, 1, &amp;sr, &amp;ch, &amp;bps);</span>
<span class="lineNum">     460 </span><span class="lineCov">          8 :                         gf_isom_set_audio_info(import-&gt;dest, track, 1, sr, ch, bps, import-&gt;asemode);</span>
<span class="lineNum">     461 </span>            :                 }
<span class="lineNum">     462 </span>            :         }
<span class="lineNum">     463 </span>            :         break;
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :         case GF_ISOM_MEDIA_SUBPIC:</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :                 gf_import_message(import, GF_OK, &quot;IsoMedia import %s - track ID %d - VobSub (size %d x %d)&quot;, orig_name, trackID, w, h);</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     467 </span><span class="lineCov">         14 :         default:</span>
<span class="lineNum">     468 </span>            :         {
<span class="lineNum">     469 </span>            :                 char szT[GF_4CC_MSIZE];
<span class="lineNum">     470 </span><span class="lineCov">         14 :                 mstype = gf_isom_get_mpeg4_subtype(import-&gt;orig, track_in, di);</span>
<span class="lineNum">     471 </span><span class="lineCov">         14 :                 if (!mstype) mstype = gf_isom_get_media_subtype(import-&gt;orig, track_in, di);</span>
<span class="lineNum">     472 </span><span class="lineCov">         14 :                 strcpy(szT, gf_4cc_to_str(mtype));</span>
<span class="lineNum">     473 </span><span class="lineCov">         14 :                 gf_import_message(import, GF_OK, &quot;IsoMedia import %s - track ID %d - media type \&quot;%s:%s\&quot;&quot;, orig_name, trackID, szT, gf_4cc_to_str(mstype));</span>
<span class="lineNum">     474 </span>            :         }
<span class="lineNum">     475 </span><span class="lineCov">         14 :         break;</span>
<span class="lineNum">     476 </span>            :         }
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span>            :         //this may happen with fragmented files
<span class="lineNum">     479 </span>            :         dts_offset = 0;
<span class="lineNum">     480 </span><span class="lineCov">         61 :         samp = gf_isom_get_sample_info(import-&gt;orig, track_in, 1, &amp;di, &amp;offset);</span>
<span class="lineNum">     481 </span><span class="lineCov">         61 :         if (samp) {</span>
<span class="lineNum">     482 </span><span class="lineCov">         61 :                 dts_offset = samp-&gt;DTS;</span>
<span class="lineNum">     483 </span><span class="lineCov">         61 :                 gf_isom_sample_del(&amp;samp);</span>
<span class="lineNum">     484 </span>            :         }
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span><span class="lineCov">         61 :         is_cenc = gf_isom_is_cenc_media(import-&gt;orig, track_in, 0);</span>
<span class="lineNum">     487 </span><span class="lineCov">         61 :         if (gf_isom_is_media_encrypted(import-&gt;orig, track_in, 0)) {</span>
<span class="lineNum">     488 </span><span class="lineCov">          2 :                 gf_isom_get_original_format_type(import-&gt;orig, track_in, 0, &amp;mstype);</span>
<span class="lineNum">     489 </span>            :         }
<span class="lineNum">     490 </span>            : 
<span class="lineNum">     491 </span><span class="lineCov">         61 :         cdur = gf_isom_get_constant_sample_duration(import-&gt;orig, track_in);</span>
<span class="lineNum">     492 </span><span class="lineCov">         61 :         gf_isom_enable_raw_pack(import-&gt;orig, track_in, 2048);</span>
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span><span class="lineCov">         61 :         mtimescale = gf_isom_get_media_timescale(import-&gt;orig, track_in);</span>
<span class="lineNum">     495 </span>            :         duration = 0;
<span class="lineNum">     496 </span><span class="lineCov">         61 :         if ((import-&gt;duration.num&gt;0) &amp;&amp; import-&gt;duration.den) {</span>
<span class="lineNum">     497 </span><span class="lineCov">          3 :                 duration = (u64) (((Double)import-&gt;duration.num * mtimescale) / import-&gt;duration.den);</span>
<span class="lineNum">     498 </span>            :         }
<span class="lineNum">     499 </span><span class="lineCov">         61 :         gf_isom_set_nalu_extract_mode(import-&gt;orig, track_in, GF_ISOM_NALU_EXTRACT_INSPECT);</span>
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span><span class="lineCov">         61 :         if (import-&gt;xps_inband) {</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :                 if (is_cenc ) {</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_PARSER, (&quot;[ISOM import] CENC media detected - cannot switch parameter set storage mode\n&quot;));</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                 } else if (import-&gt;flags &amp; GF_IMPORT_USE_DATAREF) {</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_PARSER, (&quot;[ISOM import] Cannot switch parameter set storage mode when using data reference\n&quot;));</span>
<span class="lineNum">     506 </span>            :                 } else {
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :                         switch (mstype) {</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                         case GF_ISOM_SUBTYPE_AVC_H264:</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :                                 gf_isom_set_nalu_extract_mode(import-&gt;orig, track_in, GF_ISOM_NALU_EXTRACT_INSPECT | GF_ISOM_NALU_EXTRACT_INBAND_PS_FLAG);</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :                                 gf_isom_avc_set_inband_config(import-&gt;dest, track, 1, (import-&gt;xps_inband==2) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :                         case GF_ISOM_SUBTYPE_HVC1:</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :                                 gf_isom_set_nalu_extract_mode(import-&gt;orig, track_in, GF_ISOM_NALU_EXTRACT_INSPECT | GF_ISOM_NALU_EXTRACT_INBAND_PS_FLAG);</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :                                 gf_isom_hevc_set_inband_config(import-&gt;dest, track, 1, (import-&gt;xps_inband==2) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :                         case GF_ISOM_SUBTYPE_VVC1:</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :                                 gf_isom_set_nalu_extract_mode(import-&gt;orig, track_in, GF_ISOM_NALU_EXTRACT_INSPECT | GF_ISOM_NALU_EXTRACT_INBAND_PS_FLAG);</span>
<span class="lineNum">     518 </span>            :                                 //gf_isom_vvc_set_inband_config(import-&gt;dest, track, 1, (import-&gt;xps_inband==2) ? GF_TRUE : GF_FALSE);
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     520 </span>            :                         }
<span class="lineNum">     521 </span>            :                 }
<span class="lineNum">     522 </span>            :         }
<span class="lineNum">     523 </span><span class="lineCov">         61 :         switch (mstype) {</span>
<span class="lineNum">     524 </span><span class="lineCov">         19 :         case GF_ISOM_SUBTYPE_AVC_H264:</span>
<span class="lineNum">     525 </span>            :         case GF_ISOM_SUBTYPE_SVC_H264:
<span class="lineNum">     526 </span>            :         case GF_ISOM_SUBTYPE_MVC_H264:
<span class="lineNum">     527 </span>            :         case GF_ISOM_SUBTYPE_AVC2_H264:
<span class="lineNum">     528 </span>            :         case GF_ISOM_SUBTYPE_AVC3_H264:
<span class="lineNum">     529 </span>            :         case GF_ISOM_SUBTYPE_AVC4_H264:
<span class="lineNum">     530 </span>            :         case GF_ISOM_SUBTYPE_HEV1:
<span class="lineNum">     531 </span>            :         case GF_ISOM_SUBTYPE_HVC1:
<span class="lineNum">     532 </span>            :         case GF_ISOM_SUBTYPE_LHE1:
<span class="lineNum">     533 </span>            :         case GF_ISOM_SUBTYPE_LHV1:
<span class="lineNum">     534 </span>            :         case GF_ISOM_SUBTYPE_HVT1:
<span class="lineNum">     535 </span>            :         case GF_ISOM_SUBTYPE_VVC1:
<span class="lineNum">     536 </span>            :         case GF_ISOM_SUBTYPE_VVI1:
<span class="lineNum">     537 </span>            :                 is_nalu_video = GF_TRUE;
<span class="lineNum">     538 </span><span class="lineCov">         19 :                 break;</span>
<span class="lineNum">     539 </span>            :         }
<span class="lineNum">     540 </span><span class="lineCov">         61 :         num_samples = gf_isom_get_sample_count(import-&gt;orig, track_in);</span>
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span><span class="lineCov">         61 :         if (is_cenc) {</span>
<span class="lineNum">     543 </span>            :                 u32 container_type;
<span class="lineNum">     544 </span><span class="lineCov">          2 :                 e = gf_isom_cenc_get_sample_aux_info(import-&gt;orig, track_in, 0, 1, &amp;container_type, NULL, NULL);</span>
<span class="lineNum">     545 </span><span class="lineCov">          2 :                 if (e)</span>
<span class="lineNum">     546 </span>            :                         goto exit;
<span class="lineNum">     547 </span><span class="lineCov">          2 :                 if (container_type==GF_ISOM_BOX_UUID_PSEC) {</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :                         e = gf_isom_piff_allocate_storage(import-&gt;dest, track, 0, 0, NULL);</span>
<span class="lineNum">     549 </span>            :                 } else {
<span class="lineNum">     550 </span><span class="lineCov">          2 :                         e = gf_isom_cenc_allocate_storage(import-&gt;dest, track);</span>
<span class="lineNum">     551 </span>            :                 }
<span class="lineNum">     552 </span><span class="lineCov">          2 :                 if (e) goto exit;</span>
<span class="lineNum">     553 </span><span class="lineCov">          2 :                 e = gf_isom_clone_pssh(import-&gt;dest, import-&gt;orig, GF_FALSE);</span>
<span class="lineNum">     554 </span><span class="lineCov">          2 :                 if (e) goto exit;</span>
<span class="lineNum">     555 </span>            :         }
<span class="lineNum">     556 </span><span class="lineCov">       6771 :         for (i=0; i&lt;num_samples; i++) {</span>
<span class="lineNum">     557 </span><span class="lineCov">       6713 :                 if (import-&gt;flags &amp; GF_IMPORT_USE_DATAREF) {</span>
<span class="lineNum">     558 </span><span class="lineCov">        514 :                         samp = gf_isom_get_sample_info(import-&gt;orig, track_in, i+1, &amp;di, &amp;offset);</span>
<span class="lineNum">     559 </span><span class="lineCov">        514 :                         if (!samp) {</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :                                 e = gf_isom_last_error(import-&gt;orig);</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :                                 goto exit;</span>
<span class="lineNum">     562 </span>            :                         }
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span><span class="lineCov">        514 :                         samp-&gt;DTS -= dts_offset;</span>
<span class="lineNum">     565 </span><span class="lineCov">        514 :                         if (duration &amp;&amp; !gf_sys_old_arch_compat() &amp;&amp; ((u64) samp-&gt;DTS * import-&gt;duration.den &gt;= mtimescale * import-&gt;duration.num)) {</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :                                 gf_isom_sample_del(&amp;samp);</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     568 </span>            :                         }
<span class="lineNum">     569 </span><span class="lineCov">        514 :                         e = gf_isom_add_sample_reference(import-&gt;dest, track, di, samp, offset);</span>
<span class="lineNum">     570 </span>            :                 } else {
<span class="lineNum">     571 </span><span class="lineCov">       6199 :                         samp = gf_isom_get_sample(import-&gt;orig, track_in, i+1, &amp;di);</span>
<span class="lineNum">     572 </span><span class="lineCov">       6199 :                         if (!samp) {</span>
<span class="lineNum">     573 </span>            :                                 /*couldn't get the sample, but still move on*/
<span class="lineNum">     574 </span>            :                                 goto exit;
<span class="lineNum">     575 </span>            :                         }
<span class="lineNum">     576 </span><span class="lineCov">       6199 :                         samp-&gt;DTS -= dts_offset;</span>
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span>            :                         /*if packed samples (raw) and import duration is set, adjust the number of samples to add*/
<span class="lineNum">     579 </span><span class="lineCov">       6199 :                         if (samp-&gt;nb_pack &amp;&amp; duration &amp;&amp; (samp-&gt;DTS + samp-&gt;nb_pack*cdur &gt; duration) ) {</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :                                 u32 nb_samp = (u32) ( (duration - samp-&gt;DTS) / cdur);</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :                                 u32 csize = samp-&gt;dataLength / samp-&gt;nb_pack;</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :                                 if (!nb_samp) {</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :                                         gf_isom_sample_del(&amp;samp);</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">     585 </span>            :                                 }
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :                                 samp-&gt;dataLength = csize*nb_samp;</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :                                 samp-&gt;nb_pack = nb_samp;</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :                                 duration = samp-&gt;DTS-1;</span>
<span class="lineNum">     589 </span>            :                         }
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span>            :                         /*if not first sample and same DTS as previous sample, force DTS++*/
<span class="lineNum">     592 </span><span class="lineCov">       6199 :                         if (i &amp;&amp; (samp-&gt;DTS&lt;=sampDTS)) {</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :                                 if (i+1 &lt; num_samples) {</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_PARSER, (&quot;[ISOM import] 0-duration sample detected at DTS %u - adjusting\n&quot;, samp-&gt;DTS));</span>
<span class="lineNum">     595 </span>            :                                 }
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :                                 samp-&gt;DTS = sampDTS + 1;</span>
<span class="lineNum">     597 </span>            :                         }
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span><span class="lineCov">       6199 :                         if (duration &amp;&amp; !gf_sys_old_arch_compat() &amp;&amp; ((u64) samp-&gt;DTS * import-&gt;duration.den &gt;= mtimescale * import-&gt;duration.num)) {</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :                                 gf_isom_sample_del(&amp;samp);</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     602 </span>            :                         }
<span class="lineNum">     603 </span>            : 
<span class="lineNum">     604 </span><span class="lineCov">       6199 :                         e = gf_isom_add_sample(import-&gt;dest, track, di, samp);</span>
<span class="lineNum">     605 </span>            :                 }
<span class="lineNum">     606 </span><span class="lineCov">       6713 :                 sampDTS = samp-&gt;DTS;</span>
<span class="lineNum">     607 </span><span class="lineCov">       6713 :                 if (samp-&gt;nb_pack)</span>
<span class="lineNum">     608 </span><span class="lineCov">        400 :                         i+= samp-&gt;nb_pack-1;</span>
<span class="lineNum">     609 </span><span class="lineCov">       6713 :                 gf_isom_sample_del(&amp;samp);</span>
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span>            :                 //this will also copy all sample to group mapping, including seig for CENC
<span class="lineNum">     612 </span><span class="lineCov">       6713 :                 gf_isom_copy_sample_info(import-&gt;dest, track, import-&gt;orig, track_in, i+1);</span>
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span><span class="lineCov">       6713 :                 if (e)</span>
<span class="lineNum">     615 </span>            :                         goto exit;
<span class="lineNum">     616 </span><span class="lineCov">       6713 :                 if (is_cenc) {</span>
<span class="lineNum">     617 </span>            :                         u32 container_type;
<span class="lineNum">     618 </span>            :                         Bool Is_Encrypted;
<span class="lineNum">     619 </span>            :                         Bool is_mkey=GF_FALSE;
<span class="lineNum">     620 </span>            :                         u8 crypt_byte_block, skip_byte_block;
<span class="lineNum">     621 </span><span class="lineCov">       1004 :                         const u8 *key_info=NULL;</span>
<span class="lineNum">     622 </span><span class="lineCov">       1004 :                         u32 key_info_len = 0;</span>
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span><span class="lineCov">       1004 :                         e = gf_isom_get_sample_cenc_info(import-&gt;orig, track_in, i+1, &amp;Is_Encrypted, &amp;crypt_byte_block, &amp;skip_byte_block, &amp;key_info, &amp;key_info_len);</span>
<span class="lineNum">     625 </span><span class="lineCov">       1004 :                         if (e) goto exit;</span>
<span class="lineNum">     626 </span><span class="lineCov">       1004 :                         if (key_info) {</span>
<span class="lineNum">     627 </span><span class="lineCov">       1004 :                                 is_mkey = key_info[0];</span>
<span class="lineNum">     628 </span>            :                         }
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span><span class="lineCov">       1004 :                         if (Is_Encrypted) {</span>
<span class="lineNum">     631 </span><span class="lineCov">       1004 :                                 sai_buffer_size = sai_buffer_alloc;</span>
<span class="lineNum">     632 </span><span class="lineCov">       1004 :                                 e = gf_isom_cenc_get_sample_aux_info(import-&gt;orig, track_in, i+1, di, &amp;container_type, &amp;sai_buffer, &amp;sai_buffer_size);</span>
<span class="lineNum">     633 </span><span class="lineCov">       1004 :                                 if (e) goto exit;</span>
<span class="lineNum">     634 </span><span class="lineCov">       1004 :                                 if (sai_buffer_size &gt; sai_buffer_alloc)</span>
<span class="lineNum">     635 </span>            :                                         sai_buffer_alloc = sai_buffer_size;
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineCov">       1004 :                                 e = gf_isom_track_cenc_add_sample_info(import-&gt;dest, track, container_type, sai_buffer, sai_buffer_size, is_nalu_video, GF_FALSE, is_mkey);</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            :                         } else {
<span class="lineNum">     640 </span>            :                                 //we don't set container type since we don't add data to the container (senc/...)
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :                                 e = gf_isom_track_cenc_add_sample_info(import-&gt;dest, track, 0, NULL, 0, is_nalu_video, GF_FALSE, is_mkey);</span>
<span class="lineNum">     642 </span>            :                         }
<span class="lineNum">     643 </span><span class="lineCov">       1004 :                         if (e)</span>
<span class="lineNum">     644 </span>            :                                 goto exit;
<span class="lineNum">     645 </span>            :                 }
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span><span class="lineCov">       6713 :                 gf_set_progress(&quot;Importing ISO File&quot;, i+1, num_samples);</span>
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span><span class="lineCov">       6713 :                 if (duration &amp;&amp; gf_sys_old_arch_compat() &amp;&amp; (sampDTS &gt; duration))</span>
<span class="lineNum">     650 </span>            :                         break;
<span class="lineNum">     651 </span>            :         }
<span class="lineNum">     652 </span>            : 
<span class="lineNum">     653 </span>            :         //adjust last sample duration
<span class="lineNum">     654 </span><span class="lineCov">         61 :         if (i==num_samples) {</span>
<span class="lineNum">     655 </span><span class="lineCov">         58 :                 u32 dur = gf_isom_get_sample_duration(import-&gt;orig, track_in, num_samples);</span>
<span class="lineNum">     656 </span><span class="lineCov">         58 :                 gf_isom_set_last_sample_duration(import-&gt;dest, track, dur);</span>
<span class="lineNum">     657 </span>            :         } else {
<span class="lineNum">     658 </span>            :                 s64 mediaOffset;
<span class="lineNum">     659 </span><span class="lineCov">          3 :                 if (gf_isom_get_edit_list_type(import-&gt;orig, track_in, &amp;mediaOffset)) {</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_AUTHOR, (&quot;[ISOBMF Import] Multiple edits found in source media, import may be broken\n&quot;));</span>
<span class="lineNum">     661 </span>            :                 }
<span class="lineNum">     662 </span><span class="lineCov">          3 :                 gf_isom_update_edit_list_duration(import-&gt;dest, track);</span>
<span class="lineNum">     663 </span><span class="lineCov">          3 :                 gf_isom_update_duration(import-&gt;dest);</span>
<span class="lineNum">     664 </span>            :         }
<span class="lineNum">     665 </span>            : 
<span class="lineNum">     666 </span><span class="lineCov">         61 :         if (gf_isom_has_time_offset(import-&gt;orig, track_in)==2) {</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :                 e = gf_isom_set_composition_offset_mode(import-&gt;dest, track, GF_TRUE);</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :                 if (e)</span>
<span class="lineNum">     669 </span>            :                         goto exit;
<span class="lineNum">     670 </span>            :         }
<span class="lineNum">     671 </span>            : 
<span class="lineNum">     672 </span>            : 
<span class="lineNum">     673 </span><span class="lineCov">         61 :         if (import-&gt;esd) {</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :                 if (!import-&gt;esd-&gt;slConfig) {</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :                         import-&gt;esd-&gt;slConfig = origin_esd ? origin_esd-&gt;slConfig : NULL;</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :                         if (origin_esd) origin_esd-&gt;slConfig = NULL;</span>
<span class="lineNum">     677 </span>            :                 }
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :                 if (!import-&gt;esd-&gt;decoderConfig) {</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :                         import-&gt;esd-&gt;decoderConfig = origin_esd ? origin_esd-&gt;decoderConfig : NULL;</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :                         if (origin_esd) origin_esd-&gt;decoderConfig = NULL;</span>
<span class="lineNum">     681 </span>            :                 }
<span class="lineNum">     682 </span>            :         }
<span class="lineNum">     683 </span><span class="lineCov">         61 :         gf_media_update_bitrate_ex(import-&gt;dest, track, GF_TRUE);</span>
<span class="lineNum">     684 </span><span class="lineCov">         61 :         if (mtype == GF_ISOM_MEDIA_VISUAL) {</span>
<span class="lineNum">     685 </span><span class="lineCov">         26 :                 if (import-&gt;is_alpha) {</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :                         e = gf_isom_set_image_sequence_alpha(import-&gt;dest, track, di, GF_FALSE);</span>
<span class="lineNum">     687 </span>            :                         if (e) goto exit;
<span class="lineNum">     688 </span>            :                 }
<span class="lineNum">     689 </span>            :         }
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span><span class="lineCov">         61 : exit:</span>
<span class="lineNum">     692 </span><span class="lineCov">         61 :         if (sai_buffer) gf_free(sai_buffer);</span>
<span class="lineNum">     693 </span><span class="lineCov">         61 :         if (origin_esd) gf_odf_desc_del((GF_Descriptor *) origin_esd);</span>
<span class="lineNum">     694 </span><span class="lineCov">         61 :         gf_isom_set_nalu_extract_mode(import-&gt;orig, track_in, cur_extract_mode);</span>
<span class="lineNum">     695 </span><span class="lineCov">         61 :         return e;</span>
<a name="696"><span class="lineNum">     696 </span>            : }</a>
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span><span class="lineCov">         42 : static GF_Err gf_import_isomedia(GF_MediaImporter *import)</span>
<span class="lineNum">     699 </span>            : {
<span class="lineNum">     700 </span>            :         u32 nb_tracks, i;
<span class="lineNum">     701 </span><span class="lineCov">         42 :         if (import-&gt;trackID)</span>
<span class="lineNum">     702 </span><span class="lineCov">         10 :                 return gf_import_isomedia_track(import);</span>
<span class="lineNum">     703 </span>            : 
<span class="lineNum">     704 </span><span class="lineCov">         32 :         if (!import-&gt;orig) return GF_BAD_PARAM;</span>
<span class="lineNum">     705 </span>            : 
<span class="lineNum">     706 </span><span class="lineCov">         32 :         nb_tracks = gf_isom_get_track_count(import-&gt;orig);</span>
<span class="lineNum">     707 </span><span class="lineCov">        135 :         for (i=0; i&lt;nb_tracks; i++) {</span>
<span class="lineNum">     708 </span><span class="lineCov">         71 :                 import-&gt;trackID = gf_isom_get_track_id(import-&gt;orig, i+1);</span>
<span class="lineNum">     709 </span><span class="lineCov">         71 :                 if (import-&gt;trackID) {</span>
<span class="lineNum">     710 </span><span class="lineCov">         71 :                         GF_Err e = gf_import_isomedia_track(import);</span>
<span class="lineNum">     711 </span><span class="lineCov">         71 :                         import-&gt;trackID = 0;</span>
<span class="lineNum">     712 </span><span class="lineCov">         71 :                         if (e) return e;</span>
<span class="lineNum">     713 </span>            :                 }
<span class="lineNum">     714 </span>            :         }
<span class="lineNum">     715 </span>            :         return GF_OK;
<span class="lineNum">     716 </span>            : }
<a name="717"><span class="lineNum">     717 </span>            : </a>
<span class="lineNum">     718 </span>            : GF_EXPORT
<span class="lineNum">     719 </span><span class="lineCov">          1 : GF_Err gf_media_nal_rewrite_samples(GF_ISOFile *file, u32 track, u32 new_size)</span>
<span class="lineNum">     720 </span>            : {
<span class="lineNum">     721 </span>            :         u32 i, count, di, remain, msize;
<span class="lineNum">     722 </span>            :         char *buffer;
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span>            :         msize = 4096;
<span class="lineNum">     725 </span><span class="lineCov">          1 :         buffer = (char*)gf_malloc(sizeof(char)*msize);</span>
<span class="lineNum">     726 </span><span class="lineCov">          1 :         count = gf_isom_get_sample_count(file, track);</span>
<span class="lineNum">     727 </span><span class="lineCov">        175 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     728 </span><span class="lineCov">        173 :                 GF_ISOSample *samp = gf_isom_get_sample(file, track, i+1, &amp;di);</span>
<span class="lineNum">     729 </span><span class="lineCov">        173 :                 GF_BitStream *oldbs = gf_bs_new(samp-&gt;data, samp-&gt;dataLength, GF_BITSTREAM_READ);</span>
<span class="lineNum">     730 </span><span class="lineCov">        173 :                 GF_BitStream *newbs = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);</span>
<span class="lineNum">     731 </span><span class="lineCov">        173 :                 u32 prev_size = 8*gf_isom_get_nalu_length_field(file, track, di);</span>
<span class="lineNum">     732 </span><span class="lineCov">        173 :                 if (!prev_size) return GF_NON_COMPLIANT_BITSTREAM;</span>
<span class="lineNum">     733 </span>            :                 
<span class="lineNum">     734 </span><span class="lineCov">        173 :                 remain = samp-&gt;dataLength;</span>
<span class="lineNum">     735 </span><span class="lineCov">        520 :                 while (remain) {</span>
<span class="lineNum">     736 </span><span class="lineCov">        174 :                         u32 size = gf_bs_read_int(oldbs, prev_size);</span>
<span class="lineNum">     737 </span><span class="lineCov">        174 :                         gf_bs_write_int(newbs, size, new_size);</span>
<span class="lineNum">     738 </span><span class="lineCov">        174 :                         remain -= prev_size/8;</span>
<span class="lineNum">     739 </span><span class="lineCov">        174 :                         if (size&gt;msize) {</span>
<span class="lineNum">     740 </span>            :                                 msize = size;
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :                                 buffer = (char*)gf_realloc(buffer, sizeof(char)*msize);</span>
<span class="lineNum">     742 </span>            :                         }
<span class="lineNum">     743 </span><span class="lineCov">        174 :                         gf_bs_read_data(oldbs, buffer, size);</span>
<span class="lineNum">     744 </span><span class="lineCov">        174 :                         gf_bs_write_data(newbs, buffer, size);</span>
<span class="lineNum">     745 </span><span class="lineCov">        174 :                         remain -= size;</span>
<span class="lineNum">     746 </span>            :                 }
<span class="lineNum">     747 </span><span class="lineCov">        173 :                 gf_bs_del(oldbs);</span>
<span class="lineNum">     748 </span><span class="lineCov">        173 :                 gf_free(samp-&gt;data);</span>
<span class="lineNum">     749 </span><span class="lineCov">        173 :                 samp-&gt;data = NULL;</span>
<span class="lineNum">     750 </span><span class="lineCov">        173 :                 samp-&gt;dataLength = 0;</span>
<span class="lineNum">     751 </span><span class="lineCov">        173 :                 gf_bs_get_content(newbs, &amp;samp-&gt;data, &amp;samp-&gt;dataLength);</span>
<span class="lineNum">     752 </span><span class="lineCov">        173 :                 gf_bs_del(newbs);</span>
<span class="lineNum">     753 </span><span class="lineCov">        173 :                 gf_isom_update_sample(file, track, i+1, samp, GF_TRUE);</span>
<span class="lineNum">     754 </span><span class="lineCov">        173 :                 gf_isom_sample_del(&amp;samp);</span>
<span class="lineNum">     755 </span>            :         }
<span class="lineNum">     756 </span><span class="lineCov">          1 :         gf_free(buffer);</span>
<span class="lineNum">     757 </span><span class="lineCov">          1 :         return GF_OK;</span>
<span class="lineNum">     758 </span>            : }
<a name="759"><span class="lineNum">     759 </span>            : </a>
<span class="lineNum">     760 </span>            : GF_EXPORT
<span class="lineNum">     761 </span><span class="lineCov">          2 : GF_Err gf_media_import_chapters_file(GF_MediaImporter *import)</span>
<span class="lineNum">     762 </span>            : {
<span class="lineNum">     763 </span>            :         s32 read=0;
<span class="lineNum">     764 </span>            :         GF_Err e;
<span class="lineNum">     765 </span>            :         u32 state, offset;
<span class="lineNum">     766 </span>            :         u32 cur_chap;
<span class="lineNum">     767 </span>            :         u64 ts;
<span class="lineNum">     768 </span>            :         Bool found_chap = GF_FALSE;
<span class="lineNum">     769 </span>            :         u32 i, h, m, s, ms, fr, fps;
<span class="lineNum">     770 </span>            :         char line[1024];
<span class="lineNum">     771 </span>            :         char szTitle[1024];
<span class="lineNum">     772 </span><span class="lineCov">          2 :         FILE *f = gf_fopen(import-&gt;in_name, &quot;rt&quot;);</span>
<span class="lineNum">     773 </span><span class="lineCov">          2 :         if (!f) return GF_URL_ERROR;</span>
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span><span class="lineCov">          2 :         read = (s32) gf_fread(line, 4, f);</span>
<span class="lineNum">     776 </span><span class="lineCov">          2 :         if (read &lt; 0) {</span>
<span class="lineNum">     777 </span>            :                 e = GF_IO_ERR;
<span class="lineNum">     778 </span>            :                 goto err_exit;
<span class="lineNum">     779 </span>            :         }
<span class="lineNum">     780 </span><span class="lineCov">          2 :         if (read &lt; 4) {</span>
<span class="lineNum">     781 </span>            :                 e = GF_URL_ERROR;
<span class="lineNum">     782 </span>            :                 goto err_exit;
<span class="lineNum">     783 </span>            :         }
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span><span class="lineCov">          2 :         if ((line[0]==(char)(0xFF)) &amp;&amp; (line[1]==(char)(0xFE))) {</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :                 if (!line[2] &amp;&amp; !line[3]) {</span>
<span class="lineNum">     787 </span>            :                         e = GF_NOT_SUPPORTED;
<span class="lineNum">     788 </span>            :                         goto err_exit;
<span class="lineNum">     789 </span>            :                 }
<span class="lineNum">     790 </span>            :                 offset = 2;
<span class="lineNum">     791 </span><span class="lineCov">          2 :         } else if ((line[0]==(char)(0xFE)) &amp;&amp; (line[1]==(char)(0xFF))) {</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :                 if (!line[2] &amp;&amp; !line[3]) {</span>
<span class="lineNum">     793 </span>            :                         e = GF_NOT_SUPPORTED;
<span class="lineNum">     794 </span>            :                         goto err_exit;
<span class="lineNum">     795 </span>            :                 }
<span class="lineNum">     796 </span>            :                 offset = 2;
<span class="lineNum">     797 </span><span class="lineCov">          2 :         } else if ((line[0]==(char)(0xEF)) &amp;&amp; (line[1]==(char)(0xBB)) &amp;&amp; (line[2]==(char)(0xBF))) {</span>
<span class="lineNum">     798 </span>            :                 /*we handle UTF8 as asci*/
<span class="lineNum">     799 </span>            :                 offset = 3;
<span class="lineNum">     800 </span>            :         } else {
<span class="lineNum">     801 </span>            :                 offset = 0;
<span class="lineNum">     802 </span>            :         }
<span class="lineNum">     803 </span><span class="lineCov">          2 :         gf_fseek(f, offset, SEEK_SET);</span>
<span class="lineNum">     804 </span>            : 
<span class="lineNum">     805 </span><span class="lineCov">          2 :         if (import-&gt;flags &amp; GF_IMPORT_PROBE_ONLY) {</span>
<span class="lineNum">     806 </span>            :                 Bool is_chap_or_sub = GF_FALSE;
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :                 import-&gt;nb_tracks = 0;</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :                 while (!is_chap_or_sub &amp;&amp; (gf_fgets(line, 1024, f) != NULL)) {</span>
<span class="lineNum">     809 </span>            :                         char *sep;
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :                         strlwr(line);</span>
<span class="lineNum">     811 </span>            : 
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :                         if (strstr(line, &quot;addchapter(&quot;)) is_chap_or_sub = GF_TRUE;</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :                         else if (strstr(line, &quot;--&gt;&quot;)) is_chap_or_sub = GF_TRUE;</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :                         else if ((sep = strstr(line, &quot;chapter&quot;)) != NULL) {</span>
<span class="lineNum">     815 </span>            :                                 sep+=7;
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :                                 if (!strncmp(sep+1, &quot;name&quot;, 4)) is_chap_or_sub = GF_TRUE;</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :                                 else if (!strncmp(sep+2, &quot;name&quot;, 4)) is_chap_or_sub = GF_TRUE;</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :                                 else if (!strncmp(sep+3, &quot;name&quot;, 4)) is_chap_or_sub = GF_TRUE;</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :                                 else if (strstr(line, &quot;Zoom&quot;) || strstr(line, &quot;zoom&quot;)) is_chap_or_sub = GF_TRUE;</span>
<span class="lineNum">     820 </span>            :                         }
<span class="lineNum">     821 </span>            :                 }
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :                 gf_fclose(f);</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :                 if (is_chap_or_sub) {</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :                         import-&gt;nb_tracks = 1;</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :                         import-&gt;tk_info[0].stream_type = GF_STREAM_TEXT;</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :                         import-&gt;tk_info[0].is_chapter = GF_TRUE;</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :                         return GF_OK;</span>
<span class="lineNum">     828 </span>            :                 }
<span class="lineNum">     829 </span>            :                 return GF_NOT_SUPPORTED;
<span class="lineNum">     830 </span>            :         }
<span class="lineNum">     831 </span>            : 
<span class="lineNum">     832 </span><span class="lineCov">          2 :         e = gf_isom_remove_chapter(import-&gt;dest, 0, 0);</span>
<span class="lineNum">     833 </span><span class="lineCov">          2 :         if (e) goto err_exit;</span>
<span class="lineNum">     834 </span>            : 
<span class="lineNum">     835 </span><span class="lineCov">          2 :         if (!import-&gt;video_fps.num || !import-&gt;video_fps.den ) {</span>
<span class="lineNum">     836 </span>            :                 /*try to figure out the frame rate*/
<span class="lineNum">     837 </span><span class="lineCov">          2 :                 for (i=0; i&lt;gf_isom_get_track_count(import-&gt;dest); i++) {</span>
<span class="lineNum">     838 </span>            :                         GF_ISOSample *samp;
<span class="lineNum">     839 </span>            :                         u32 timescale, inc;
<span class="lineNum">     840 </span><span class="lineCov">          2 :             u32 mtype = gf_isom_get_media_type(import-&gt;dest, i+1);</span>
<span class="lineNum">     841 </span><span class="lineCov">          2 :                         if (!gf_isom_is_video_handler_type(mtype)) continue;</span>
<span class="lineNum">     842 </span><span class="lineCov">          2 :                         if (gf_isom_get_sample_count(import-&gt;dest, i+1) &lt; 20) continue;</span>
<span class="lineNum">     843 </span><span class="lineCov">          2 :                         samp = gf_isom_get_sample_info(import-&gt;dest, 1, 2, NULL, NULL);</span>
<span class="lineNum">     844 </span><span class="lineCov">          2 :                         inc = (u32) samp-&gt;DTS;</span>
<span class="lineNum">     845 </span><span class="lineCov">          2 :                         if (!inc) inc=1;</span>
<span class="lineNum">     846 </span><span class="lineCov">          2 :                         timescale = gf_isom_get_media_timescale(import-&gt;dest, i+1);</span>
<span class="lineNum">     847 </span><span class="lineCov">          2 :                         import-&gt;video_fps.num = timescale;</span>
<span class="lineNum">     848 </span><span class="lineCov">          2 :                         import-&gt;video_fps.den = inc;</span>
<span class="lineNum">     849 </span><span class="lineCov">          2 :                         gf_isom_sample_del(&amp;samp);</span>
<span class="lineNum">     850 </span><span class="lineCov">          2 :                         GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[Chapter import] Guessed video frame rate %u/%u\n&quot;, timescale, inc));</span>
<span class="lineNum">     851 </span><span class="lineCov">          2 :                         break;</span>
<span class="lineNum">     852 </span>            :                 }
<span class="lineNum">     853 </span><span class="lineCov">          2 :                 if (!import-&gt;video_fps.num || !import-&gt;video_fps.den) {</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :                         import-&gt;video_fps.num = 25;</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :                         import-&gt;video_fps.den = 1;</span>
<span class="lineNum">     856 </span>            :                 }
<span class="lineNum">     857 </span>            :         }
<span class="lineNum">     858 </span>            : 
<span class="lineNum">     859 </span>            :         cur_chap = 0;
<span class="lineNum">     860 </span>            :         ts = 0;
<span class="lineNum">     861 </span>            :         state = 0;
<span class="lineNum">     862 </span><span class="lineCov">         17 :         while (gf_fgets(line, 1024, f) != NULL) {</span>
<span class="lineNum">     863 </span>            :                 char *title = NULL;
<span class="lineNum">     864 </span>            :                 u32 off = 0;
<span class="lineNum">     865 </span>            :                 char *sL;
<span class="lineNum">     866 </span><span class="lineCov">         30 :                 while (1) {</span>
<span class="lineNum">     867 </span><span class="lineCov">         45 :                         u32 len = (u32) strlen(line);</span>
<span class="lineNum">     868 </span><span class="lineCov">         45 :                         if (!len) break;</span>
<span class="lineNum">     869 </span><span class="lineCov">         45 :                         switch (line[len-1]) {</span>
<span class="lineNum">     870 </span><span class="lineCov">         30 :                         case '\n':</span>
<span class="lineNum">     871 </span>            :                         case '\t':
<span class="lineNum">     872 </span>            :                         case '\r':
<span class="lineNum">     873 </span>            :                         case ' ':
<span class="lineNum">     874 </span><span class="lineCov">         30 :                                 line[len-1] = 0;</span>
<span class="lineNum">     875 </span><span class="lineCov">         30 :                                 continue;</span>
<span class="lineNum">     876 </span>            :                         }
<span class="lineNum">     877 </span>            :                         break;
<span class="lineNum">     878 </span>            :                 }
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :                 while (line[off]==' ') off++;</span>
<span class="lineNum">     881 </span><span class="lineCov">         15 :                 if (!strlen(line+off)) continue;</span>
<span class="lineNum">     882 </span>            :                 sL = line+off;
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span><span class="lineCov">         15 :                 szTitle[0] = 0;</span>
<span class="lineNum">     885 </span>            :                 /*ZoomPlayer chapters*/
<span class="lineNum">     886 </span><span class="lineCov">         15 :                 if (!strnicmp(sL, &quot;AddChapter(&quot;, 11)) {</span>
<span class="lineNum">     887 </span>            :                         u32 nb_fr;
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :                         sscanf(sL, &quot;AddChapter(%u,%1023s)&quot;, &amp;nb_fr, szTitle);</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :                         ts = nb_fr;</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :                         ts *= 1000;</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :                         ts = (u64) (((s64) ts )  *import-&gt;video_fps.den / import-&gt;video_fps.num);</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :                         sL = strchr(sL, ',');</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :                         strcpy(szTitle, sL+1);</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :                         sL = strrchr(szTitle, ')');</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :                         if (sL) sL[0] = 0;</span>
<span class="lineNum">     896 </span><span class="lineCov">         15 :                 } else if (!strnicmp(sL, &quot;AddChapterBySecond(&quot;, 19)) {</span>
<span class="lineNum">     897 </span>            :                         u32 nb_s;
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :                         sscanf(sL, &quot;AddChapterBySecond(%u,%1023s)&quot;, &amp;nb_s, szTitle);</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :                         ts = nb_s;</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :                         ts *= 1000;</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :                         sL = strchr(sL, ',');</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :                         strcpy(szTitle, sL+1);</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :                         sL = strrchr(szTitle, ')');</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :                         if (sL) sL[0] = 0;</span>
<span class="lineNum">     905 </span><span class="lineCov">         15 :                 } else if (!strnicmp(sL, &quot;AddChapterByTime(&quot;, 17)) {</span>
<span class="lineNum">     906 </span><span class="lineCov">          1 :                         sscanf(sL, &quot;AddChapterByTime(%u,%u,%u,%1023s)&quot;, &amp;h, &amp;m, &amp;s, szTitle);</span>
<span class="lineNum">     907 </span><span class="lineCov">          1 :                         ts = 3600*h + 60*m + s;</span>
<span class="lineNum">     908 </span><span class="lineCov">          1 :                         ts *= 1000;</span>
<span class="lineNum">     909 </span><span class="lineCov">          1 :                         sL = strchr(sL, ',');</span>
<span class="lineNum">     910 </span><span class="lineCov">          1 :                         if (sL) sL = strchr(sL+1, ',');</span>
<span class="lineNum">     911 </span><span class="lineCov">          1 :                         if (sL) sL = strchr(sL+1, ',');</span>
<span class="lineNum">     912 </span><span class="lineCov">          1 :                         if (sL) strcpy(szTitle, sL+1);</span>
<span class="lineNum">     913 </span><span class="lineCov">          1 :                         sL = strrchr(szTitle, ')');</span>
<span class="lineNum">     914 </span><span class="lineCov">          1 :                         if (sL) sL[0] = 0;</span>
<span class="lineNum">     915 </span>            :                 }
<span class="lineNum">     916 </span>            :                 /*regular or SMPTE time codes*/
<span class="lineNum">     917 </span><span class="lineCov">         14 :                 else if ((strlen(sL)&gt;=8) &amp;&amp; (sL[2]==':') &amp;&amp; (sL[5]==':')) {</span>
<span class="lineNum">     918 </span>            :                         title = NULL;
<span class="lineNum">     919 </span><span class="lineCov">          4 :                         if (strlen(sL)==8) {</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :                                 sscanf(sL, &quot;%02u:%02u:%02u&quot;, &amp;h, &amp;m, &amp;s);</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :                                 ts = (h*3600 + m*60+s)*1000;</span>
<span class="lineNum">     922 </span>            :                         }
<span class="lineNum">     923 </span>            :                         else {
<span class="lineNum">     924 </span>            :                                 char szTS[20], *tok;
<span class="lineNum">     925 </span>            :                                 strncpy(szTS, sL, 19);
<span class="lineNum">     926 </span><span class="lineCov">          4 :                                 szTS[19]=0;</span>
<span class="lineNum">     927 </span><span class="lineCov">          4 :                                 tok = strrchr(szTS, ' ');</span>
<span class="lineNum">     928 </span><span class="lineCov">          4 :                                 if (tok) {</span>
<span class="lineNum">     929 </span><span class="lineCov">          4 :                                         title = strchr(sL, ' ') + 1;</span>
<span class="lineNum">     930 </span><span class="lineCov">          4 :                                         while (title[0]==' ') title++;</span>
<span class="lineNum">     931 </span><span class="lineCov">          4 :                                         if (strlen(title)) strcpy(szTitle, title);</span>
<span class="lineNum">     932 </span><span class="lineCov">          4 :                                         tok[0] = 0;</span>
<span class="lineNum">     933 </span>            :                                 }
<span class="lineNum">     934 </span>            :                                 ts = 0;
<span class="lineNum">     935 </span><span class="lineCov">          4 :                                 h = m = s = ms = 0;</span>
<span class="lineNum">     936 </span>            : 
<span class="lineNum">     937 </span><span class="lineCov">          4 :                                 if (sscanf(szTS, &quot;%u:%u:%u;%u/%u&quot;, &amp;h, &amp;m, &amp;s, &amp;fr, &amp;fps)==5) {</span>
<span class="lineNum">     938 </span><span class="lineCov">          1 :                                         ts = (h*3600 + m*60+s)*1000 + 1000*fr/fps;</span>
<span class="lineNum">     939 </span><span class="lineCov">          3 :                                 } else if (sscanf(szTS, &quot;%u:%u:%u;%u&quot;, &amp;h, &amp;m, &amp;s, &amp;fr)==4) {</span>
<span class="lineNum">     940 </span><span class="lineCov">          1 :                                         ts = (h*3600 + m*60+s);</span>
<span class="lineNum">     941 </span><span class="lineCov">          1 :                                         ts = (s64) (((import-&gt;video_fps.num*((s64)ts) + import-&gt;video_fps.den*fr) * 1000 ) / import-&gt;video_fps.num ) ;</span>
<span class="lineNum">     942 </span><span class="lineCov">          2 :                                 } else if (sscanf(szTS, &quot;%u:%u:%u.%u&quot;, &amp;h, &amp;m, &amp;s, &amp;ms) == 4) {</span>
<span class="lineNum">     943 </span>            :                                         //microseconds used
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :                                         if (ms&gt;=1000) ms /= 1000;</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :                                         ts = (h*3600 + m*60+s)*1000+ms;</span>
<span class="lineNum">     946 </span><span class="lineCov">          2 :                                 } else if (sscanf(szTS, &quot;%u:%u:%u.%u&quot;, &amp;h, &amp;m, &amp;s, &amp;ms) == 4) {</span>
<span class="lineNum">     947 </span>            :                                         //microseconds used
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :                                         if (ms&gt;=1000) ms /= 1000;</span>
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :                                         ts = (h*3600 + m*60+s)*1000+ms;</span>
<span class="lineNum">     950 </span><span class="lineCov">          2 :                                 } else if (sscanf(szTS, &quot;%u:%u:%u:%u&quot;, &amp;h, &amp;m, &amp;s, &amp;ms) == 4) {</span>
<span class="lineNum">     951 </span>            :                                         //microseconds used
<span class="lineNum">     952 </span><span class="lineCov">          2 :                                         if (ms&gt;=1000) ms /= 1000;</span>
<span class="lineNum">     953 </span><span class="lineCov">          2 :                                         ts = (h*3600 + m*60+s)*1000+ms;</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :                                 } else if (sscanf(szTS, &quot;%u:%u:%u&quot;, &amp;h, &amp;m, &amp;s) == 3) {</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :                                         ts = (h*3600 + m*60+s) * 1000;</span>
<span class="lineNum">     956 </span>            :                                 }
<span class="lineNum">     957 </span>            :                         }
<span class="lineNum">     958 </span>            :                 }
<span class="lineNum">     959 </span>            :                 /*CHAPTERX= and CHAPTERXNAME=*/
<span class="lineNum">     960 </span><span class="lineCov">         10 :                 else if (!strnicmp(sL, &quot;CHAPTER&quot;, 7)) {</span>
<span class="lineNum">     961 </span>            :                         u32 idx;
<span class="lineNum">     962 </span>            :                         char szTemp[20], *str;
<span class="lineNum">     963 </span>            :                         strncpy(szTemp, sL, 19);
<span class="lineNum">     964 </span><span class="lineCov">          8 :                         szTemp[19] = 0;</span>
<span class="lineNum">     965 </span><span class="lineCov">          8 :                         str = strrchr(szTemp, '=');</span>
<span class="lineNum">     966 </span><span class="lineCov">         16 :                         if (!str) continue;</span>
<span class="lineNum">     967 </span><span class="lineCov">          8 :                         str[0] = 0;</span>
<span class="lineNum">     968 </span><span class="lineCov">          8 :                         strlwr(szTemp);</span>
<span class="lineNum">     969 </span><span class="lineCov">          8 :                         idx = cur_chap;</span>
<span class="lineNum">     970 </span><span class="lineCov">          8 :                         str = strchr(sL, '=');</span>
<span class="lineNum">     971 </span><span class="lineCov">          8 :                         str++;</span>
<span class="lineNum">     972 </span><span class="lineCov">          8 :                         if (strstr(szTemp, &quot;name&quot;)) {</span>
<span class="lineNum">     973 </span><span class="lineCov">          4 :                                 sscanf(szTemp, &quot;chapter%uname&quot;, &amp;idx);</span>
<span class="lineNum">     974 </span>            :                                 strcpy(szTitle, str);
<span class="lineNum">     975 </span><span class="lineCov">          4 :                                 if (idx!=cur_chap) {</span>
<span class="lineNum">     976 </span>            :                                         cur_chap=idx;
<span class="lineNum">     977 </span>            :                                         state = 0;
<span class="lineNum">     978 </span>            :                                 }
<span class="lineNum">     979 </span><span class="lineCov">          4 :                                 state++;</span>
<span class="lineNum">     980 </span>            :                         } else {
<span class="lineNum">     981 </span><span class="lineCov">          4 :                                 sscanf(szTemp, &quot;chapter%u&quot;, &amp;idx);</span>
<span class="lineNum">     982 </span><span class="lineCov">          4 :                                 if (idx!=cur_chap) {</span>
<span class="lineNum">     983 </span>            :                                         cur_chap=idx;
<span class="lineNum">     984 </span>            :                                         state = 0;
<span class="lineNum">     985 </span>            :                                 }
<span class="lineNum">     986 </span><span class="lineCov">          4 :                                 state++;</span>
<span class="lineNum">     987 </span>            : 
<span class="lineNum">     988 </span>            :                                 ts = 0;
<span class="lineNum">     989 </span><span class="lineCov">          4 :                                 h = m = s = ms = 0;</span>
<span class="lineNum">     990 </span><span class="lineCov">          4 :                                 if (sscanf(str, &quot;%u:%u:%u.%u&quot;, &amp;h, &amp;m, &amp;s, &amp;ms) == 4) {</span>
<span class="lineNum">     991 </span>            :                                         //microseconds used
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :                                         if (ms&gt;=1000) ms/=1000;</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :                                         ts = (h*3600 + m*60+s)*1000+ms;</span>
<span class="lineNum">     994 </span><span class="lineCov">          4 :                                 } else if (sscanf(str, &quot;%u:%u:%u:%u&quot;, &amp;h, &amp;m, &amp;s, &amp;ms) == 4) {</span>
<span class="lineNum">     995 </span>            :                                         //microseconds used
<span class="lineNum">     996 </span><span class="lineCov">          4 :                                         if (ms&gt;=1000) ms/=1000;</span>
<span class="lineNum">     997 </span><span class="lineCov">          4 :                                         ts = (h*3600 + m*60+s)*1000+ms;</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :                                 } else if (sscanf(str, &quot;%u:%u:%u&quot;, &amp;h, &amp;m, &amp;s) == 3) {</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :                                         ts = (h*3600 + m*60+s) * 1000;</span>
<span class="lineNum">    1000 </span>            :                                 }
<span class="lineNum">    1001 </span>            :                         }
<span class="lineNum">    1002 </span><span class="lineCov">          8 :                         if (state==2) {</span>
<span class="lineNum">    1003 </span>            :                                 found_chap = GF_TRUE;
<span class="lineNum">    1004 </span><span class="lineCov">          4 :                                 e = gf_isom_add_chapter(import-&gt;dest, 0, ts, szTitle);</span>
<span class="lineNum">    1005 </span><span class="lineCov">          4 :                                 if (e) goto err_exit;</span>
<span class="lineNum">    1006 </span>            :                                 state = 0;
<span class="lineNum">    1007 </span>            :                         }
<span class="lineNum">    1008 </span><span class="lineCov">          8 :                         continue;</span>
<span class="lineNum">    1009 </span>            :                 }
<span class="lineNum">    1010 </span><span class="lineCov">          2 :                 else continue;</span>
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span>            :                 found_chap = GF_TRUE;
<span class="lineNum">    1013 </span><span class="lineCov">          5 :                 if (strlen(szTitle)) {</span>
<span class="lineNum">    1014 </span><span class="lineCov">          5 :                         e = gf_isom_add_chapter(import-&gt;dest, 0, ts, szTitle);</span>
<span class="lineNum">    1015 </span>            :                 } else {
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :                         e = gf_isom_add_chapter(import-&gt;dest, 0, ts, NULL);</span>
<span class="lineNum">    1017 </span>            :                 }
<span class="lineNum">    1018 </span><span class="lineCov">          5 :                 if (e) goto err_exit;</span>
<span class="lineNum">    1019 </span>            :         }
<span class="lineNum">    1020 </span>            : 
<span class="lineNum">    1021 </span><span class="lineCov">          2 : err_exit:</span>
<span class="lineNum">    1022 </span><span class="lineCov">          2 :         gf_fclose(f);</span>
<span class="lineNum">    1023 </span><span class="lineCov">          2 :         if (!found_chap) return GF_NOT_FOUND;</span>
<span class="lineNum">    1024 </span><span class="lineCov">          2 :         return e;</span>
<span class="lineNum">    1025 </span>            : }
<a name="1026"><span class="lineNum">    1026 </span>            : </a>
<span class="lineNum">    1027 </span>            : GF_EXPORT
<span class="lineNum">    1028 </span><span class="lineCov">          2 : GF_Err gf_media_import_chapters(GF_ISOFile *file, char *chap_file, GF_Fraction import_fps, Bool use_qt)</span>
<span class="lineNum">    1029 </span>            : {
<span class="lineNum">    1030 </span>            :         GF_Err e;
<span class="lineNum">    1031 </span>            :         u32 i;
<span class="lineNum">    1032 </span>            :         GF_MediaImporter import;
<span class="lineNum">    1033 </span>            :         //remove all chapter info
<span class="lineNum">    1034 </span><span class="lineCov">          2 :         gf_isom_remove_chapter(file, 0, 0);</span>
<span class="lineNum">    1035 </span>            : 
<span class="lineNum">    1036 </span><span class="lineCov">          2 : restart_check:</span>
<span class="lineNum">    1037 </span>            :         //remove all chapter tracks
<span class="lineNum">    1038 </span><span class="lineCov">          6 :         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    1039 </span><span class="lineCov">          2 :                 if (gf_isom_get_reference_count(file, i+1, GF_ISOM_REF_CHAP)) {</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :                         u32 chap_track=0;</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :                         gf_isom_get_reference(file, i+1, GF_ISOM_REF_CHAP, 1, &amp;chap_track);</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :                         if (chap_track) {</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :                                 gf_isom_remove_track(file, chap_track);</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :                                 goto restart_check;</span>
<span class="lineNum">    1045 </span>            :                         }
<span class="lineNum">    1046 </span>            :                 }
<span class="lineNum">    1047 </span>            :         }
<span class="lineNum">    1048 </span>            : 
<span class="lineNum">    1049 </span>            :         memset(&amp;import, 0, sizeof(GF_MediaImporter));
<span class="lineNum">    1050 </span><span class="lineCov">          2 :         import.dest = file;</span>
<span class="lineNum">    1051 </span><span class="lineCov">          2 :         import.in_name = chap_file;</span>
<span class="lineNum">    1052 </span><span class="lineCov">          2 :         import.video_fps = import_fps;</span>
<span class="lineNum">    1053 </span><span class="lineCov">          2 :         import.streamFormat = &quot;CHAP&quot;;</span>
<span class="lineNum">    1054 </span><span class="lineCov">          2 :         e = gf_media_import(&amp;import);</span>
<span class="lineNum">    1055 </span><span class="lineCov">          2 :         if (e) return e;</span>
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineCov">          2 :         if (!import.final_trackID) return GF_OK;</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :         if (use_qt) {</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :                 u32 chap_track = gf_isom_get_track_by_id(file, import.final_trackID);</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :                 u32 nb_sdesc = gf_isom_get_sample_description_count(file, chap_track);</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;nb_sdesc; i++) {</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :                         gf_isom_set_media_subtype(file, chap_track, i+1, GF_ISOM_SUBTYPE_TEXT);</span>
<span class="lineNum">    1063 </span>            :                 }
<span class="lineNum">    1064 </span>            :         }
<span class="lineNum">    1065 </span>            :         //imported chapter is a track, set reference
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;gf_isom_get_track_count(file); i++) {</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :                 u32 mtype = gf_isom_get_media_type(file, i+1);</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :                 switch (mtype) {</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :                 case GF_ISOM_MEDIA_VISUAL:</span>
<span class="lineNum">    1070 </span>            :                 case GF_ISOM_MEDIA_AUXV:
<span class="lineNum">    1071 </span>            :                 case GF_ISOM_MEDIA_PICT:
<span class="lineNum">    1072 </span>            :                 case GF_ISOM_MEDIA_AUDIO:
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :                         gf_isom_set_track_reference(file, i+1, GF_ISOM_REF_CHAP, import.final_trackID);</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1075 </span>            :                 }
<span class="lineNum">    1076 </span>            :         }
<span class="lineNum">    1077 </span>            :         return GF_OK;
<a name="1078"><span class="lineNum">    1078 </span>            : }</a>
<span class="lineNum">    1079 </span>            : 
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 : static void on_import_setup_failure(GF_Filter *f, void *on_setup_error_udta, GF_Err e)</span>
<span class="lineNum">    1081 </span>            : {
<span class="lineNum">    1082 </span>            :         GF_MediaImporter *importer = (GF_MediaImporter *)on_setup_error_udta;
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :         if (importer)</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :                 importer-&gt;last_error = e;</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 : }</span>
<a name="1086"><span class="lineNum">    1086 </span>            : </a>
<span class="lineNum">    1087 </span>            : GF_EXPORT
<span class="lineNum">    1088 </span><span class="lineCov">        717 : GF_Err gf_media_import(GF_MediaImporter *importer)</span>
<span class="lineNum">    1089 </span>            : {
<span class="lineNum">    1090 </span>            :         GF_Err e;
<span class="lineNum">    1091 </span>            :         u32 i, count;
<span class="lineNum">    1092 </span>            :         GF_FilterSession *fsess=NULL;
<span class="lineNum">    1093 </span><span class="lineCov">        717 :         char *args = NULL;</span>
<span class="lineNum">    1094 </span>            :         char szSubArg[1024];
<span class="lineNum">    1095 </span>            :         char szFilterID[20];
<span class="lineNum">    1096 </span>            :         Bool source_id_set = GF_FALSE;
<span class="lineNum">    1097 </span>            :         Bool source_is_isom = GF_FALSE;
<span class="lineNum">    1098 </span>            :         GF_Filter *isobmff_mux, *source;
<span class="lineNum">    1099 </span>            :         GF_Filter *filter_orig;
<span class="lineNum">    1100 </span>            :         char *ext;
<span class="lineNum">    1101 </span>            :         char *fmt = NULL;
<span class="lineNum">    1102 </span>            : 
<span class="lineNum">    1103 </span><span class="lineCov">        717 :         if (!importer || (!importer-&gt;dest &amp;&amp; (importer-&gt;flags!=GF_IMPORT_PROBE_ONLY)) || (!importer-&gt;in_name &amp;&amp; !importer-&gt;orig) ) return GF_BAD_PARAM;</span>
<span class="lineNum">    1104 </span>            : 
<span class="lineNum">    1105 </span><span class="lineCov">        717 :         if (importer-&gt;orig) return gf_import_isomedia(importer);</span>
<span class="lineNum">    1106 </span>            : 
<span class="lineNum">    1107 </span><span class="lineCov">        717 :         if (importer-&gt;force_ext) {</span>
<span class="lineNum">    1108 </span>            :                 ext = importer-&gt;force_ext;
<span class="lineNum">    1109 </span>            :         } else {
<span class="lineNum">    1110 </span><span class="lineCov">        717 :                 ext = gf_file_ext_start(importer-&gt;in_name);</span>
<span class="lineNum">    1111 </span><span class="lineCov">        717 :                 if (!ext) ext = &quot;&quot;;</span>
<span class="lineNum">    1112 </span>            :         }
<span class="lineNum">    1113 </span>            : 
<span class="lineNum">    1114 </span><span class="lineCov">        717 :         if (importer-&gt;streamFormat) fmt = importer-&gt;streamFormat;</span>
<span class="lineNum">    1115 </span>            : 
<span class="lineNum">    1116 </span>            :         /*if isobmf and probing or no filter, direct copy*/
<span class="lineNum">    1117 </span><span class="lineCov">        717 :         if (gf_isom_probe_file(importer-&gt;in_name)) {</span>
<span class="lineNum">    1118 </span>            :                 u64 magic = 1;
<span class="lineNum">    1119 </span>            :                 magic &lt;&lt;= 32;
<span class="lineNum">    1120 </span><span class="lineCov">         45 :                 magic |= (importer-&gt;source_magic &amp; 0xFFFFFFFFUL);</span>
<span class="lineNum">    1121 </span><span class="lineCov">         45 :                 importer-&gt;source_magic = magic;</span>
<span class="lineNum">    1122 </span>            :                 source_is_isom = GF_TRUE;
<span class="lineNum">    1123 </span><span class="lineCov">         45 :                 if ((!importer-&gt;filter_chain &amp;&amp; !importer-&gt;filter_dst_opts &amp;&amp; !importer-&gt;run_in_session &amp;&amp; !importer-&gt;start_time)</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :                         || (importer-&gt;flags &amp; GF_IMPORT_PROBE_ONLY)</span>
<span class="lineNum">    1125 </span>            :                 ) {
<span class="lineNum">    1126 </span><span class="lineCov">         45 :                         importer-&gt;orig = gf_isom_open(importer-&gt;in_name, GF_ISOM_OPEN_READ, NULL);</span>
<span class="lineNum">    1127 </span><span class="lineCov">         45 :                         if (importer-&gt;orig) {</span>
<span class="lineNum">    1128 </span><span class="lineCov">         42 :                                 e = gf_import_isomedia(importer);</span>
<span class="lineNum">    1129 </span><span class="lineCov">         42 :                                 gf_isom_delete(importer-&gt;orig);</span>
<span class="lineNum">    1130 </span><span class="lineCov">         42 :                                 importer-&gt;orig = NULL;</span>
<span class="lineNum">    1131 </span><span class="lineCov">         42 :                                 return e;</span>
<span class="lineNum">    1132 </span>            :                         }
<span class="lineNum">    1133 </span>            :                 }
<span class="lineNum">    1134 </span>            :         }
<span class="lineNum">    1135 </span>            : 
<span class="lineNum">    1136 </span>            :         /*SC3DMC*/
<span class="lineNum">    1137 </span><span class="lineCov">        675 :         if (!strnicmp(ext, &quot;.s3d&quot;, 4) || (fmt &amp;&amp; !stricmp(fmt, &quot;SC3DMC&quot;)) )</span>
<span class="lineNum">    1138 </span><span class="lineCov">          1 :                 return gf_import_afx_sc3dmc(importer, GF_TRUE);</span>
<span class="lineNum">    1139 </span>            :         /* chapter */
<span class="lineNum">    1140 </span><span class="lineCov">        674 :         else if (!strnicmp(ext, &quot;.txt&quot;, 4) || !strnicmp(ext, &quot;.chap&quot;, 5) || (fmt &amp;&amp; !stricmp(fmt, &quot;CHAP&quot;)) ) {</span>
<span class="lineNum">    1141 </span><span class="lineCov">          2 :                 e =  gf_media_import_chapters_file(importer);</span>
<span class="lineNum">    1142 </span><span class="lineCov">          2 :                 if (!strnicmp(ext, &quot;.txt&quot;, 4) &amp;&amp; (e==GF_NOT_FOUND)) {</span>
<span class="lineNum">    1143 </span>            : 
<span class="lineNum">    1144 </span>            :                 } else {
<span class="lineNum">    1145 </span>            :                         return e;
<span class="lineNum">    1146 </span>            :                 }
<span class="lineNum">    1147 </span>            :         }
<span class="lineNum">    1148 </span>            : 
<span class="lineNum">    1149 </span><span class="lineCov">        672 :         e = GF_OK;</span>
<span class="lineNum">    1150 </span><span class="lineCov">        672 :         importer-&gt;last_error = GF_OK;</span>
<span class="lineNum">    1151 </span>            : 
<span class="lineNum">    1152 </span><span class="lineCov">        672 :         if (importer-&gt;flags &amp; GF_IMPORT_PROBE_ONLY) {</span>
<span class="lineNum">    1153 </span>            :                 GF_Filter *prober, *src_filter;
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span><span class="lineCov">         63 :                 fsess = gf_fs_new_defaults(0);</span>
<span class="lineNum">    1156 </span><span class="lineCov">         63 :                 if (!fsess) {</span>
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :                         return gf_import_message(importer, GF_BAD_PARAM, &quot;[Importer] Cannot load filter session for import&quot;);</span>
<span class="lineNum">    1158 </span>            :                 }
<span class="lineNum">    1159 </span><span class="lineCov">         63 :                 prober = gf_fs_load_filter(fsess, &quot;probe&quot;, &amp;e);</span>
<span class="lineNum">    1160 </span><span class="lineCov">         63 :                 src_filter = gf_fs_load_source(fsess, importer-&gt;in_name, &quot;index=0&quot;, NULL, &amp;e);</span>
<span class="lineNum">    1161 </span><span class="lineCov">         63 :                 if (e) {</span>
<span class="lineNum">    1162 </span><span class="lineNoCov">          0 :                         gf_fs_run(fsess);</span>
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 :                         gf_fs_del(fsess);</span>
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :                         return gf_import_message(importer, e, &quot;[Importer] Cannot load filter for input file \&quot;%s\&quot;&quot;, importer-&gt;in_name);</span>
<span class="lineNum">    1165 </span>            :                 }
<span class="lineNum">    1166 </span>            : #ifdef GPAC_ENABLE_COVERAGE
<span class="lineNum">    1167 </span><span class="lineCov">         63 :                 if (gf_sys_is_cov_mode()) {</span>
<span class="lineNum">    1168 </span>            :                         on_import_setup_failure(NULL, NULL, GF_OK);
<span class="lineNum">    1169 </span>            :                 }
<span class="lineNum">    1170 </span>            : #endif
<span class="lineNum">    1171 </span>            : 
<span class="lineNum">    1172 </span><span class="lineCov">         63 :                 gf_filter_set_setup_failure_callback(prober, src_filter, on_import_setup_failure, importer);</span>
<span class="lineNum">    1173 </span><span class="lineCov">         63 :                 gf_fs_run(fsess);</span>
<span class="lineNum">    1174 </span>            : 
<span class="lineNum">    1175 </span><span class="lineCov">         63 :                 if (importer-&gt;last_error) {</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :                         gf_fs_del(fsess);</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :                         return gf_import_message(importer, importer-&gt;last_error, &quot;[Importer] Error probing %s&quot;, importer-&gt;in_name);</span>
<span class="lineNum">    1178 </span>            :                 }
<span class="lineNum">    1179 </span>            : 
<span class="lineNum">    1180 </span><span class="lineCov">         63 :                 importer-&gt;nb_tracks = 0;</span>
<span class="lineNum">    1181 </span><span class="lineCov">         63 :                 count = gf_filter_get_ipid_count(prober);</span>
<span class="lineNum">    1182 </span><span class="lineCov">        130 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1183 </span>            :                         const GF_PropertyValue *p;
<span class="lineNum">    1184 </span><span class="lineCov">         67 :                         struct __track_import_info *tki = &amp;importer-&gt;tk_info[importer-&gt;nb_tracks];</span>
<span class="lineNum">    1185 </span><span class="lineCov">         67 :                         GF_FilterPid *pid = gf_filter_get_ipid(prober, i);</span>
<span class="lineNum">    1186 </span>            : 
<span class="lineNum">    1187 </span><span class="lineCov">         67 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_STREAM_TYPE);</span>
<span class="lineNum">    1188 </span><span class="lineCov">         67 :                         tki-&gt;stream_type = p ? p-&gt;value.uint : GF_STREAM_UNKNOWN;</span>
<span class="lineNum">    1189 </span><span class="lineCov">         67 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_CODECID);</span>
<span class="lineNum">    1190 </span><span class="lineCov">         67 :                         tki-&gt;codecid = p ? p-&gt;value.uint : GF_CODECID_NONE;</span>
<span class="lineNum">    1191 </span><span class="lineCov">         67 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_LANGUAGE);</span>
<span class="lineNum">    1192 </span><span class="lineCov">         67 :                         if (p &amp;&amp; p-&gt;value.string) tki-&gt;lang = GF_4CC(p-&gt;value.string[0], p-&gt;value.string[1], p-&gt;value.string[2], ' ');</span>
<span class="lineNum">    1193 </span><span class="lineCov">         67 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_ID);</span>
<span class="lineNum">    1194 </span><span class="lineCov">         67 :                         tki-&gt;track_num = p ? p-&gt;value.uint : 1;</span>
<span class="lineNum">    1195 </span><span class="lineCov">         67 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_ESID);</span>
<span class="lineNum">    1196 </span><span class="lineCov">         67 :                         if (p) tki-&gt;mpeg4_es_id = p-&gt;value.uint;</span>
<span class="lineNum">    1197 </span><span class="lineCov">         67 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_SERVICE_ID);</span>
<span class="lineNum">    1198 </span><span class="lineCov">         67 :                         if (p) tki-&gt;prog_num = p-&gt;value.uint;</span>
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span><span class="lineCov">         67 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_DURATION);</span>
<span class="lineNum">    1201 </span><span class="lineCov">         67 :                         if (p) {</span>
<span class="lineNum">    1202 </span><span class="lineCov">         19 :                                 Double d = (Double) p-&gt;value.lfrac.num;</span>
<span class="lineNum">    1203 </span><span class="lineCov">         19 :                                 d*=1000;</span>
<span class="lineNum">    1204 </span><span class="lineCov">         19 :                                 if (p-&gt;value.lfrac.den) d /= p-&gt;value.lfrac.den;</span>
<span class="lineNum">    1205 </span><span class="lineCov">         19 :                                 if (d &gt; importer-&gt;probe_duration) importer-&gt;probe_duration = (u64) d;</span>
<span class="lineNum">    1206 </span>            :                         }
<span class="lineNum">    1207 </span>            : 
<span class="lineNum">    1208 </span><span class="lineCov">         67 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_WIDTH);</span>
<span class="lineNum">    1209 </span><span class="lineCov">         67 :                         if (p) {</span>
<span class="lineNum">    1210 </span><span class="lineCov">         32 :                                 tki-&gt;video_info.width = p-&gt;value.uint;</span>
<span class="lineNum">    1211 </span><span class="lineCov">         32 :                                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_HEIGHT);</span>
<span class="lineNum">    1212 </span><span class="lineCov">         32 :                                 if (p) tki-&gt;video_info.height = p-&gt;value.uint;</span>
<span class="lineNum">    1213 </span><span class="lineCov">         32 :                                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_FPS);</span>
<span class="lineNum">    1214 </span><span class="lineCov">         32 :                                 if (p) {</span>
<span class="lineNum">    1215 </span><span class="lineCov">         28 :                                         tki-&gt;video_info.FPS = p-&gt;value.frac.num;</span>
<span class="lineNum">    1216 </span><span class="lineCov">         28 :                                         if (p-&gt;value.frac.den) tki-&gt;video_info.FPS /= p-&gt;value.frac.den;</span>
<span class="lineNum">    1217 </span>            :                                 }
<span class="lineNum">    1218 </span><span class="lineCov">         32 :                                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_SAR);</span>
<span class="lineNum">    1219 </span><span class="lineCov">         32 :                                 if (p) tki-&gt;video_info.par = (p-&gt;value.frac.num &lt;&lt; 16) | p-&gt;value.frac.den;</span>
<span class="lineNum">    1220 </span>            :                         }
<span class="lineNum">    1221 </span><span class="lineCov">         67 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_SAMPLE_RATE);</span>
<span class="lineNum">    1222 </span><span class="lineCov">         67 :                         if (p) {</span>
<span class="lineNum">    1223 </span><span class="lineCov">         28 :                                 tki-&gt;audio_info.sample_rate = p-&gt;value.uint;</span>
<span class="lineNum">    1224 </span><span class="lineCov">         28 :                                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_NUM_CHANNELS);</span>
<span class="lineNum">    1225 </span><span class="lineCov">         28 :                                 if (p) tki-&gt;audio_info.nb_channels = p-&gt;value.uint;</span>
<span class="lineNum">    1226 </span><span class="lineCov">         28 :                                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_SAMPLES_PER_FRAME);</span>
<span class="lineNum">    1227 </span><span class="lineCov">         28 :                                 if (p) tki-&gt;audio_info.samples_per_frame = p-&gt;value.uint;</span>
<span class="lineNum">    1228 </span>            :                         }
<span class="lineNum">    1229 </span>            : /*                      p = gf_filter_pid_get_property(pid, GF_PROP_PID_CAN_DATAREF);
<span class="lineNum">    1230 </span>            :                         if (p) importer-&gt;flags |= GF_IMPORT_USE_DATAREF;
<span class="lineNum">    1231 </span>            : */
<span class="lineNum">    1232 </span><span class="lineCov">         67 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_SUBTYPE);</span>
<span class="lineNum">    1233 </span><span class="lineCov">         67 :                         if (p) tki-&gt;media_subtype = p-&gt;value.uint;</span>
<span class="lineNum">    1234 </span>            : 
<span class="lineNum">    1235 </span><span class="lineCov">         67 :                         importer-&gt;nb_tracks++;</span>
<span class="lineNum">    1236 </span>            :                 }
<span class="lineNum">    1237 </span><span class="lineCov">         63 :                 gf_fs_del(fsess);</span>
<span class="lineNum">    1238 </span><span class="lineCov">         63 :                 return GF_OK;</span>
<span class="lineNum">    1239 </span>            :         }
<span class="lineNum">    1240 </span>            : 
<span class="lineNum">    1241 </span><span class="lineCov">        609 :         if (importer-&gt;run_in_session) {</span>
<span class="lineNum">    1242 </span>            :                 fsess = importer-&gt;run_in_session;
<span class="lineNum">    1243 </span>            :         } else {
<span class="lineNum">    1244 </span><span class="lineCov">        607 :                 fsess = gf_fs_new_defaults(fmt ? GF_FS_FLAG_NO_PROBE : 0);</span>
<span class="lineNum">    1245 </span><span class="lineCov">        607 :                 if (!fsess) {</span>
<span class="lineNum">    1246 </span><span class="lineNoCov">          0 :                         return gf_import_message(importer, GF_BAD_PARAM, &quot;[Importer] Cannot load filter session for import&quot;);</span>
<span class="lineNum">    1247 </span>            :                 }
<span class="lineNum">    1248 </span>            :         }
<span class="lineNum">    1249 </span>            : 
<span class="lineNum">    1250 </span>            :         filter_orig=NULL;
<span class="lineNum">    1251 </span>            : 
<span class="lineNum">    1252 </span><span class="lineCov">        609 :         if (importer-&gt;run_in_session) {</span>
<span class="lineNum">    1253 </span><span class="lineCov">          2 :                 sprintf(szFilterID, &quot;%d&quot;, (u32) ( (importer-&gt;source_magic &amp; 0xFFFFFFFFUL) ) );</span>
<span class="lineNum">    1254 </span>            :         } else {
<span class="lineNum">    1255 </span>            :                 strcpy(szFilterID, &quot;1&quot;);
<span class="lineNum">    1256 </span>            :         }
<span class="lineNum">    1257 </span>            : 
<span class="lineNum">    1258 </span><span class="lineCov">        609 :         if (!importer-&gt;run_in_session) {</span>
<span class="lineNum">    1259 </span>            :                 //mux args
<span class="lineNum">    1260 </span><span class="lineCov">        607 :                 e = gf_dynstrcat(&amp;args, &quot;mp4mx:importer&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1261 </span><span class="lineCov">        607 :                 sprintf(szSubArg, &quot;file=%p&quot;, importer-&gt;dest);</span>
<span class="lineNum">    1262 </span><span class="lineCov">        607 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1263 </span>            :         }
<span class="lineNum">    1264 </span>            : 
<span class="lineNum">    1265 </span><span class="lineCov">        609 :         if (importer-&gt;trackID) {</span>
<span class="lineNum">    1266 </span>            :                 sprintf(szSubArg, &quot;SID=%s#PID=%d&quot;, szFilterID, importer-&gt;trackID);
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1268 </span>            :         }
<span class="lineNum">    1269 </span><span class="lineCov">        609 :         if (importer-&gt;filter_dst_opts)</span>
<span class="lineNum">    1270 </span><span class="lineCov">          1 :                 e |= gf_dynstrcat(&amp;args, importer-&gt;filter_dst_opts, &quot;:gfloc:&quot;);</span>
<span class="lineNum">    1271 </span>            : 
<span class="lineNum">    1272 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_FORCE_MPEG4)</span>
<span class="lineNum">    1273 </span><span class="lineCov">         49 :                 e |= gf_dynstrcat(&amp;args, &quot;m4sys&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1274 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_USE_DATAREF)</span>
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :                 e |= gf_dynstrcat(&amp;args, &quot;dref&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1276 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_NO_EDIT_LIST)</span>
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :                 e |= gf_dynstrcat(&amp;args, &quot;noedit&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1278 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_FORCE_PACKED)</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :                 e |= gf_dynstrcat(&amp;args, &quot;pack_nal&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1280 </span><span class="lineCov">        609 :         if (importer-&gt;xps_inband==1)</span>
<span class="lineNum">    1281 </span><span class="lineCov">          8 :                 e |= gf_dynstrcat(&amp;args, &quot;xps_inband=all&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1282 </span><span class="lineCov">        601 :         else if (importer-&gt;xps_inband==2)</span>
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :                 e |= gf_dynstrcat(&amp;args, &quot;xps_inband=both&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1284 </span><span class="lineCov">        609 :         if (importer-&gt;esd &amp;&amp; importer-&gt;esd-&gt;ESID) {</span>
<span class="lineNum">    1285 </span><span class="lineCov">         47 :                 sprintf(szSubArg, &quot;trackid=%d&quot;, importer-&gt;esd-&gt;ESID);</span>
<span class="lineNum">    1286 </span><span class="lineCov">         47 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1287 </span>            :         }
<span class="lineNum">    1288 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_FORCE_SYNC)</span>
<span class="lineNum">    1289 </span><span class="lineCov">          1 :                 e |= gf_dynstrcat(&amp;args, &quot;:forcesync&quot;, NULL);</span>
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span><span class="lineCov">        609 :         if (importer-&gt;duration.den) {</span>
<span class="lineNum">    1292 </span><span class="lineCov">         91 :                 sprintf(szSubArg, &quot;idur=%d/%d&quot;, importer-&gt;duration.num, importer-&gt;duration.den);</span>
<span class="lineNum">    1293 </span><span class="lineCov">         91 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1294 </span>            :         }
<span class="lineNum">    1295 </span><span class="lineCov">        609 :         if (importer-&gt;frames_per_sample) {</span>
<span class="lineNum">    1296 </span>            :                 sprintf(szSubArg, &quot;pack3gp=%d&quot;, importer-&gt;frames_per_sample);
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1298 </span>            :         }
<span class="lineNum">    1299 </span><span class="lineCov">        609 :         if (importer-&gt;moov_timescale) {</span>
<span class="lineNum">    1300 </span>            :                 sprintf(szSubArg, &quot;moovts=%d&quot;, importer-&gt;moov_timescale);
<span class="lineNum">    1301 </span><span class="lineCov">          2 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1302 </span>            :         }
<span class="lineNum">    1303 </span><span class="lineCov">        609 :         if (importer-&gt;asemode==GF_IMPORT_AUDIO_SAMPLE_ENTRY_v0_2) { e |= gf_dynstrcat(&amp;args, &quot;ase=v0s&quot;, &quot;:&quot;); }</span>
<span class="lineNum">    1304 </span><span class="lineCov">        608 :         else if (importer-&gt;asemode==GF_IMPORT_AUDIO_SAMPLE_ENTRY_v1_MPEG) { e |= gf_dynstrcat(&amp;args, &quot;ase=v1&quot;, &quot;:&quot;); }</span>
<span class="lineNum">    1305 </span><span class="lineCov">        607 :         else if (importer-&gt;asemode==GF_IMPORT_AUDIO_SAMPLE_ENTRY_v1_QTFF) { e |= gf_dynstrcat(&amp;args, &quot;ase=v1qt&quot;, &quot;:&quot;); }</span>
<span class="lineNum">    1306 </span>            : 
<span class="lineNum">    1307 </span><span class="lineCov">        609 :         if (source_is_isom &amp;&amp; gf_isom_has_keep_utc_times(importer-&gt;dest) ) { e |= gf_dynstrcat(&amp;args, &quot;keep_utc&quot;, &quot;:&quot;); }</span>
<span class="lineNum">    1308 </span>            : 
<span class="lineNum">    1309 </span><span class="lineCov">        609 :         if (importer-&gt;start_time) {</span>
<span class="lineNum">    1310 </span>            :                 sprintf(szSubArg, &quot;start=%f&quot;, importer-&gt;start_time);
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1312 </span>            :         }
<span class="lineNum">    1313 </span><span class="lineCov">        609 :         if (e) {</span>
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :                 gf_fs_del(fsess);</span>
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :                 gf_free(args);</span>
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 :                 return gf_import_message(importer, e, &quot;[Importer] Cannot load ISOBMFF muxer arguments&quot;);</span>
<span class="lineNum">    1317 </span>            :         }
<span class="lineNum">    1318 </span>            : 
<span class="lineNum">    1319 </span><span class="lineCov">        609 :         if (!importer-&gt;run_in_session) {</span>
<span class="lineNum">    1320 </span><span class="lineCov">        607 :                 isobmff_mux = gf_fs_load_filter(fsess, args, &amp;e);</span>
<span class="lineNum">    1321 </span><span class="lineCov">        607 :                 gf_free(args);</span>
<span class="lineNum">    1322 </span><span class="lineCov">        607 :                 args = NULL;</span>
<span class="lineNum">    1323 </span>            : 
<span class="lineNum">    1324 </span><span class="lineCov">        607 :                 if (!isobmff_mux) {</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :                         gf_fs_del(fsess);</span>
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 :                         gf_free(args);</span>
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :                         return gf_import_message(importer, e, &quot;[Importer] Cannot load ISOBMFF muxer&quot;);</span>
<span class="lineNum">    1328 </span>            :                 }
<span class="lineNum">    1329 </span>            :         } else {
<span class="lineNum">    1330 </span><span class="lineCov">          2 :                 importer-&gt;update_mux_args = args;</span>
<span class="lineNum">    1331 </span><span class="lineCov">          2 :                 args = NULL;</span>
<span class="lineNum">    1332 </span>            :                 isobmff_mux = NULL;
<span class="lineNum">    1333 </span>            :         }
<span class="lineNum">    1334 </span>            : 
<span class="lineNum">    1335 </span>            :         //filter chain
<span class="lineNum">    1336 </span><span class="lineCov">        609 :         if (importer-&gt;filter_chain) {</span>
<span class="lineNum">    1337 </span>            :                 GF_Filter *prev_filter=NULL;
<span class="lineNum">    1338 </span>            :                 char *fargs = (char *) importer-&gt;filter_chain;
<span class="lineNum">    1339 </span><span class="lineCov">          2 :                 char *sep1 = strstr(fargs, &quot;@@&quot;);</span>
<span class="lineNum">    1340 </span><span class="lineCov">          2 :                 char *sep2 = strstr(fargs, &quot;@&quot;);</span>
<span class="lineNum">    1341 </span>            :                 Bool old_syntax = GF_FALSE;
<span class="lineNum">    1342 </span><span class="lineCov">          2 :                 if (sep1 &amp;&amp; sep2 &amp;&amp; (sep1==sep2))</span>
<span class="lineNum">    1343 </span>            :                         old_syntax = GF_TRUE;
<span class="lineNum">    1344 </span>            : 
<span class="lineNum">    1345 </span><span class="lineCov">          2 :                 while (fargs) {</span>
<span class="lineNum">    1346 </span>            :                         GF_Filter *f;
<span class="lineNum">    1347 </span>            :                         char *sep;
<span class="lineNum">    1348 </span>            :                         Bool end_of_sub_chain = GF_FALSE;
<span class="lineNum">    1349 </span><span class="lineCov">          2 :                         if (old_syntax) {</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :                                 sep = strstr(fargs, &quot;@@&quot;);</span>
<span class="lineNum">    1351 </span>            :                         } else {
<span class="lineNum">    1352 </span><span class="lineCov">          2 :                                 sep = strstr(fargs, &quot;@&quot;);</span>
<span class="lineNum">    1353 </span><span class="lineCov">          2 :                                 if (sep &amp;&amp; (sep[1] == '@'))</span>
<span class="lineNum">    1354 </span>            :                                         end_of_sub_chain = GF_TRUE;
<span class="lineNum">    1355 </span>            :                         }
<span class="lineNum">    1356 </span><span class="lineCov">          2 :                         if (sep) sep[0] = 0;</span>
<span class="lineNum">    1357 </span><span class="lineCov">          2 :                         f = gf_fs_load_filter(fsess, fargs, &amp;e);</span>
<span class="lineNum">    1358 </span><span class="lineCov">          2 :                         if (!f) {</span>
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :                                 if (!importer-&gt;run_in_session)</span>
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :                                         gf_fs_del(fsess);</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :                                 return gf_import_message(importer, e, &quot;[Importer] Cannot load filter %s&quot;, fargs);</span>
<span class="lineNum">    1362 </span>            :                         }
<span class="lineNum">    1363 </span><span class="lineCov">          2 :                         if (prev_filter) {</span>
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :                                 gf_filter_set_source(f, prev_filter, NULL);</span>
<span class="lineNum">    1365 </span>            :                         }
<span class="lineNum">    1366 </span>            :                         prev_filter = f;
<span class="lineNum">    1367 </span><span class="lineCov">          2 :                         if (!filter_orig) filter_orig = f;</span>
<span class="lineNum">    1368 </span>            : 
<span class="lineNum">    1369 </span><span class="lineCov">          2 :                         if (!sep) end_of_sub_chain = GF_TRUE;</span>
<span class="lineNum">    1370 </span>            :                         //we cannot directly set the source id in case we run in an existing session
<span class="lineNum">    1371 </span><span class="lineCov">          2 :                         if (end_of_sub_chain &amp;&amp; prev_filter) {</span>
<span class="lineNum">    1372 </span>            :                                 const char *prev_id;
<span class="lineNum">    1373 </span><span class="lineCov">          2 :                                 if (importer-&gt;trackID) {</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :                                         if (gf_filter_get_id(prev_filter)) {</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :                                                 if (!importer-&gt;run_in_session)</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :                                                         gf_fs_del(fsess);</span>
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :                                                 return gf_import_message(importer, GF_FILTER_NOT_FOUND, &quot;[Importer] last filter in chain cannot use filter ID (%s)&quot;, fargs);</span>
<span class="lineNum">    1378 </span>            :                                         }
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :                                         gf_filter_assign_id(prev_filter, szFilterID);</span>
<span class="lineNum">    1380 </span>            :                                         source_id_set=GF_TRUE;
<span class="lineNum">    1381 </span>            :                                 }
<span class="lineNum">    1382 </span><span class="lineCov">          2 :                                 prev_id = gf_filter_get_id(prev_filter);</span>
<span class="lineNum">    1383 </span><span class="lineCov">          2 :                                 if (!prev_id) {</span>
<span class="lineNum">    1384 </span><span class="lineCov">          2 :                                         gf_filter_assign_id(prev_filter, NULL);</span>
<span class="lineNum">    1385 </span><span class="lineCov">          2 :                                         prev_id = gf_filter_get_id(prev_filter);</span>
<span class="lineNum">    1386 </span>            :                                 }
<span class="lineNum">    1387 </span><span class="lineCov">          2 :                                 if (importer-&gt;run_in_session) {</span>
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :                                         gf_dynstrcat(&amp;importer-&gt;update_mux_args, &quot;:SID=&quot;, NULL);</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :                                         gf_dynstrcat(&amp;importer-&gt;update_mux_args, prev_id, NULL);</span>
<span class="lineNum">    1390 </span>            :                                 } else {
<span class="lineNum">    1391 </span>            :                                         assert(isobmff_mux);
<span class="lineNum">    1392 </span><span class="lineCov">          2 :                                         gf_filter_set_source(isobmff_mux, prev_filter, NULL);</span>
<span class="lineNum">    1393 </span>            :                                 }
<span class="lineNum">    1394 </span>            :                                 prev_filter = NULL;
<span class="lineNum">    1395 </span>            :                         }
<span class="lineNum">    1396 </span>            : 
<span class="lineNum">    1397 </span><span class="lineCov">          2 :                         if (!sep) break;</span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :                         sep[0] = '@';</span>
<span class="lineNum">    1399 </span>            : 
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :                         if (old_syntax || end_of_sub_chain) {</span>
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :                                 fargs = sep+2;</span>
<span class="lineNum">    1402 </span>            :                         } else {
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :                                 fargs = sep+1;</span>
<span class="lineNum">    1404 </span>            :                         }
<span class="lineNum">    1405 </span>            :                 }
<span class="lineNum">    1406 </span>            :         }
<span class="lineNum">    1407 </span>            : 
<span class="lineNum">    1408 </span>            :         //source args
<span class="lineNum">    1409 </span><span class="lineCov">        609 :         e = gf_dynstrcat(&amp;args, &quot;importer:index=0&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1410 </span><span class="lineCov">        609 :         if (importer-&gt;trackID &amp;&amp; !source_id_set) {</span>
<span class="lineNum">    1411 </span>            :                 sprintf(szSubArg, &quot;FID=%s&quot;, szFilterID);
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1413 </span>            :         }
<span class="lineNum">    1414 </span><span class="lineCov">        609 :         if (fmt) {</span>
<span class="lineNum">    1415 </span>            :                 sprintf(szSubArg, &quot;ext=%s&quot;, fmt);
<span class="lineNum">    1416 </span><span class="lineCov">          5 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1417 </span>            :         }
<span class="lineNum">    1418 </span><span class="lineCov">        609 :         if (importer-&gt;filter_src_opts) e |= gf_dynstrcat(&amp;args, importer-&gt;filter_src_opts, &quot;:&quot;);</span>
<span class="lineNum">    1419 </span>            : 
<span class="lineNum">    1420 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_SBR_IMPLICIT) e |= gf_dynstrcat(&amp;args, &quot;sbr=imp&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1421 </span><span class="lineCov">        606 :         else if (importer-&gt;flags &amp; GF_IMPORT_SBR_EXPLICIT) e |= gf_dynstrcat(&amp;args, &quot;sbr=exp&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1422 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_PS_IMPLICIT) e |= gf_dynstrcat(&amp;args, &quot;ps=imp&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1423 </span><span class="lineCov">        606 :         else if (importer-&gt;flags &amp; GF_IMPORT_PS_EXPLICIT) e |= gf_dynstrcat(&amp;args, &quot;ps=exp&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1424 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_OVSBR) e |= gf_dynstrcat(&amp;args, &quot;ovsbr&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1425 </span>            :         //avoids message at end of import
<span class="lineNum">    1426 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_FORCE_PACKED) e |= gf_dynstrcat(&amp;args, &quot;nal_length=0&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1427 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_SET_SUBSAMPLES) e |= gf_dynstrcat(&amp;args, &quot;subsamples&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1428 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_NO_SEI) e |= gf_dynstrcat(&amp;args, &quot;nosei&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1429 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_SVC_NONE) e |= gf_dynstrcat(&amp;args, &quot;nosvc&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1430 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_SAMPLE_DEPS) e |= gf_dynstrcat(&amp;args, &quot;deps&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1431 </span><span class="lineCov">        609 :         if (importer-&gt;flags &amp; GF_IMPORT_FORCE_MPEG4) e |= gf_dynstrcat(&amp;args, &quot;mpeg4&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1432 </span><span class="lineCov">        609 :         if (importer-&gt;keep_audelim) e |= gf_dynstrcat(&amp;args, &quot;audelim&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1433 </span><span class="lineCov">        609 :         if (importer-&gt;video_fps.num &amp;&amp; importer-&gt;video_fps.den) {</span>
<span class="lineNum">    1434 </span>            :                 sprintf(szSubArg, &quot;fps=%d/%d&quot;, importer-&gt;video_fps.num, importer-&gt;video_fps.den);
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1436 </span>            :         }
<span class="lineNum">    1437 </span><span class="lineCov">        609 :         if (importer-&gt;is_alpha) e |= gf_dynstrcat(&amp;args, &quot;#Alpha&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1438 </span>            : 
<span class="lineNum">    1439 </span><span class="lineCov">        609 :         if (importer-&gt;streamFormat &amp;&amp; !strcmp(importer-&gt;streamFormat, &quot;VTT&quot;)) e |= gf_dynstrcat(&amp;args, &quot;webvtt&quot;, &quot;:&quot;);</span>
<span class="lineNum">    1440 </span>            : 
<span class="lineNum">    1441 </span><span class="lineCov">        609 :         if (importer-&gt;source_magic) {</span>
<span class="lineNum">    1442 </span>            :                 sprintf(szSubArg, &quot;#SrcMagic=&quot;LLU, importer-&gt;source_magic);
<span class="lineNum">    1443 </span><span class="lineCov">        555 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1444 </span>            :         }
<span class="lineNum">    1445 </span><span class="lineCov">        609 :         if (importer-&gt;track_index) {</span>
<span class="lineNum">    1446 </span>            :                 sprintf(szSubArg, &quot;#MuxIndex=%d&quot;, importer-&gt;track_index);
<span class="lineNum">    1447 </span><span class="lineCov">        455 :                 e |= gf_dynstrcat(&amp;args, szSubArg, &quot;:&quot;);</span>
<span class="lineNum">    1448 </span>            :         }
<span class="lineNum">    1449 </span>            : 
<span class="lineNum">    1450 </span><span class="lineCov">        609 :         if (e) {</span>
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :                 if (!importer-&gt;run_in_session)</span>
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :                         gf_fs_del(fsess);</span>
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :                 gf_free(args);</span>
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :                 return gf_import_message(importer, e, &quot;[Importer] Cannot load arguments for input %s&quot;, importer-&gt;in_name);</span>
<span class="lineNum">    1455 </span>            :         }
<span class="lineNum">    1456 </span>            : 
<span class="lineNum">    1457 </span><span class="lineCov">        609 :         source = gf_fs_load_source(fsess, importer-&gt;in_name, args, NULL, &amp;e);</span>
<span class="lineNum">    1458 </span><span class="lineCov">        609 :         gf_free(args);</span>
<span class="lineNum">    1459 </span><span class="lineCov">        609 :         args = NULL;</span>
<span class="lineNum">    1460 </span>            : 
<span class="lineNum">    1461 </span><span class="lineCov">        609 :         if (e) {</span>
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :                 if (!importer-&gt;run_in_session)</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :                         gf_fs_del(fsess);</span>
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :                 return gf_import_message(importer, e, &quot;[Importer] Cannot load filter for input file \&quot;%s\&quot;&quot;, importer-&gt;in_name);</span>
<span class="lineNum">    1465 </span>            :         }
<span class="lineNum">    1466 </span>            : 
<span class="lineNum">    1467 </span><span class="lineCov">        609 :         if (filter_orig)</span>
<span class="lineNum">    1468 </span><span class="lineCov">          2 :                 gf_filter_set_source(filter_orig, source, NULL);</span>
<span class="lineNum">    1469 </span>            : 
<span class="lineNum">    1470 </span>            :         //source is setup, we run in an external session, nothing left to do
<span class="lineNum">    1471 </span><span class="lineCov">        609 :         if (importer-&gt;run_in_session)</span>
<span class="lineNum">    1472 </span>            :                 return GF_OK;
<span class="lineNum">    1473 </span>            : 
<span class="lineNum">    1474 </span><span class="lineCov">        607 :         gf_fs_run(fsess);</span>
<span class="lineNum">    1475 </span>            : 
<span class="lineNum">    1476 </span><span class="lineCov">        607 :         if (!importer-&gt;last_error) importer-&gt;last_error = gf_fs_get_last_connect_error(fsess);</span>
<span class="lineNum">    1477 </span><span class="lineCov">        607 :         if (!importer-&gt;last_error) importer-&gt;last_error = gf_fs_get_last_process_error(fsess);</span>
<span class="lineNum">    1478 </span>            : 
<span class="lineNum">    1479 </span><span class="lineCov">        607 :         if (importer-&gt;last_error) {</span>
<span class="lineNum">    1480 </span><span class="lineCov">          3 :                 gf_fs_print_non_connected(fsess);</span>
<span class="lineNum">    1481 </span><span class="lineCov">          3 :                 if (importer-&gt;print_stats_graph &amp; 1) gf_fs_print_stats(fsess);</span>
<span class="lineNum">    1482 </span><span class="lineCov">          3 :                 if (importer-&gt;print_stats_graph &amp; 2) gf_fs_print_connections(fsess);</span>
<span class="lineNum">    1483 </span><span class="lineCov">          3 :                 if (!importer-&gt;run_in_session)</span>
<span class="lineNum">    1484 </span><span class="lineCov">          3 :                         gf_fs_del(fsess);</span>
<span class="lineNum">    1485 </span><span class="lineCov">          3 :                 return gf_import_message(importer, importer-&gt;last_error, &quot;[Importer] Error importing %s&quot;, importer-&gt;in_name);</span>
<span class="lineNum">    1486 </span>            :         }
<span class="lineNum">    1487 </span>            : 
<span class="lineNum">    1488 </span><span class="lineCov">        604 :         importer-&gt;final_trackID = gf_isom_get_last_created_track_id(importer-&gt;dest);</span>
<span class="lineNum">    1489 </span>            : 
<span class="lineNum">    1490 </span><span class="lineCov">        604 :         if (importer-&gt;esd &amp;&amp; importer-&gt;final_trackID) {</span>
<span class="lineNum">    1491 </span><span class="lineCov">         49 :                 u32 tk_num = gf_isom_get_track_by_id(importer-&gt;dest, importer-&gt;final_trackID);</span>
<span class="lineNum">    1492 </span><span class="lineCov">         49 :                 GF_ESD *esd = gf_isom_get_esd(importer-&gt;dest, tk_num, 1);</span>
<span class="lineNum">    1493 </span><span class="lineCov">         49 :                 if (esd &amp;&amp; !importer-&gt;esd-&gt;decoderConfig) {</span>
<span class="lineNum">    1494 </span><span class="lineCov">         30 :                         importer-&gt;esd-&gt;decoderConfig = esd-&gt;decoderConfig;</span>
<span class="lineNum">    1495 </span><span class="lineCov">         30 :                         esd-&gt;decoderConfig = NULL;</span>
<span class="lineNum">    1496 </span>            :                 }
<span class="lineNum">    1497 </span><span class="lineCov">         49 :                 if (esd &amp;&amp; !importer-&gt;esd-&gt;slConfig) {</span>
<span class="lineNum">    1498 </span><span class="lineCov">         30 :                         importer-&gt;esd-&gt;slConfig = esd-&gt;slConfig;</span>
<span class="lineNum">    1499 </span><span class="lineCov">         30 :                         esd-&gt;slConfig = NULL;</span>
<span class="lineNum">    1500 </span>            :                 }
<span class="lineNum">    1501 </span><span class="lineCov">         49 :                 if (esd) {</span>
<span class="lineNum">    1502 </span><span class="lineCov">         48 :                         gf_odf_desc_del((GF_Descriptor *) esd);</span>
<span class="lineNum">    1503 </span>            :                 }
<span class="lineNum">    1504 </span>            : 
<span class="lineNum">    1505 </span><span class="lineCov">         49 :                 if (!importer-&gt;esd-&gt;ESID) {</span>
<span class="lineNum">    1506 </span><span class="lineCov">          2 :                         importer-&gt;esd-&gt;ESID = importer-&gt;final_trackID;</span>
<span class="lineNum">    1507 </span>            :                 }
<span class="lineNum">    1508 </span>            :         }
<span class="lineNum">    1509 </span>            : 
<span class="lineNum">    1510 </span><span class="lineCov">        604 :         if (!e) gf_fs_print_unused_args(fsess, &quot;index,fps&quot;);</span>
<span class="lineNum">    1511 </span><span class="lineCov">        604 :         gf_fs_print_non_connected(fsess);</span>
<span class="lineNum">    1512 </span><span class="lineCov">        604 :         if (importer-&gt;print_stats_graph &amp; 1) gf_fs_print_stats(fsess);</span>
<span class="lineNum">    1513 </span><span class="lineCov">        604 :         if (importer-&gt;print_stats_graph &amp; 2) gf_fs_print_connections(fsess);</span>
<span class="lineNum">    1514 </span><span class="lineCov">        604 :         gf_fs_del(fsess);</span>
<span class="lineNum">    1515 </span><span class="lineCov">        604 :         if (!importer-&gt;final_trackID) {</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :                 return gf_import_message(importer, GF_NOT_SUPPORTED, &quot;[Importer] No valid track to import in input file \&quot;%s\&quot;&quot;, importer-&gt;in_name);</span>
<span class="lineNum">    1517 </span>            :         }
<span class="lineNum">    1518 </span>            :         return GF_OK;
<span class="lineNum">    1519 </span>            : }
<span class="lineNum">    1520 </span>            : 
<span class="lineNum">    1521 </span>            : #endif /*GPAC_DISABLE_MEDIA_IMPORT*/
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

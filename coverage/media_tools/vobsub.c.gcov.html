<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - media_tools/vobsub.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">media_tools</a> - vobsub.c<span style="font-size: 80%;"> (source / <a href="vobsub.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">146</td>
            <td class="headerCovTableEntry">172</td>
            <td class="headerCovTableEntryMed">84.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntry">8</td>
            <td class="headerCovTableEntryMed">87.5 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *          GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *          Copyright (c) by  Falco (Ivan Vecera) 2006
<span class="lineNum">       5 </span>            :  *          Copyright (c) Jean Le Feuvre - Telecom ParisTech 2018_2020
<span class="lineNum">       6 </span>            :  *                  All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / Media Tools sub-project
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : #include &lt;gpac/list.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;gpac/internal/vobsub.h&gt;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : typedef struct _tag_lang_type
<span class="lineNum">      31 </span>            : {
<span class="lineNum">      32 </span>            :         char id[3];
<span class="lineNum">      33 </span>            :         char lang[4];
<span class="lineNum">      34 </span>            : } lang_type;
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : static lang_type lang_table[] =
<span class="lineNum">      37 </span>            : {
<span class="lineNum">      38 </span>            :         {&quot;--&quot;, &quot;und&quot; },
<span class="lineNum">      39 </span>            :         {&quot;aa&quot;, &quot;aar&quot; },
<span class="lineNum">      40 </span>            :         {&quot;ab&quot;, &quot;abk&quot; },
<span class="lineNum">      41 </span>            :         {&quot;af&quot;, &quot;afr&quot; },
<span class="lineNum">      42 </span>            :         {&quot;am&quot;, &quot;amh&quot; },
<span class="lineNum">      43 </span>            :         {&quot;ar&quot;, &quot;ara&quot; },
<span class="lineNum">      44 </span>            :         {&quot;as&quot;, &quot;ast&quot; },
<span class="lineNum">      45 </span>            :         {&quot;ay&quot;, &quot;aym&quot; },
<span class="lineNum">      46 </span>            :         {&quot;az&quot;, &quot;aze&quot; },
<span class="lineNum">      47 </span>            :         {&quot;ba&quot;, &quot;bak&quot; },
<span class="lineNum">      48 </span>            :         {&quot;be&quot;, &quot;bel&quot; },
<span class="lineNum">      49 </span>            :         {&quot;bg&quot;, &quot;bul&quot; },
<span class="lineNum">      50 </span>            :         {&quot;bh&quot;, &quot;bih&quot; },
<span class="lineNum">      51 </span>            :         {&quot;bi&quot;, &quot;bis&quot; },
<span class="lineNum">      52 </span>            :         {&quot;bn&quot;, &quot;ben&quot; },
<span class="lineNum">      53 </span>            :         {&quot;bo&quot;, &quot;bod&quot; }, // was &quot;tib&quot; (Tibetan)
<span class="lineNum">      54 </span>            :         {&quot;br&quot;, &quot;bre&quot; },
<span class="lineNum">      55 </span>            :         {&quot;ca&quot;, &quot;cat&quot; },
<span class="lineNum">      56 </span>            :         {&quot;cc&quot;, &quot;und&quot; },
<span class="lineNum">      57 </span>            :         {&quot;co&quot;, &quot;cos&quot; },
<span class="lineNum">      58 </span>            :         {&quot;cs&quot;, &quot;ces&quot; }, // was &quot;cze&quot; (Czech)
<span class="lineNum">      59 </span>            :         {&quot;cy&quot;, &quot;cym&quot; }, // was &quot;wel&quot; (Welsh)
<span class="lineNum">      60 </span>            :         {&quot;da&quot;, &quot;dan&quot; },
<span class="lineNum">      61 </span>            :         {&quot;de&quot;, &quot;deu&quot; }, // was &quot;ger&quot; (German)
<span class="lineNum">      62 </span>            :         {&quot;dz&quot;, &quot;dzo&quot; },
<span class="lineNum">      63 </span>            :         {&quot;el&quot;, &quot;ell&quot; }, // was &quot;gre&quot; (Greek, Modern (1453-))
<span class="lineNum">      64 </span>            :         {&quot;en&quot;, &quot;eng&quot; },
<span class="lineNum">      65 </span>            :         {&quot;eo&quot;, &quot;epo&quot; },
<span class="lineNum">      66 </span>            :         {&quot;es&quot;, &quot;spa&quot; },
<span class="lineNum">      67 </span>            :         {&quot;et&quot;, &quot;est&quot; },
<span class="lineNum">      68 </span>            :         {&quot;eu&quot;, &quot;eus&quot; }, // was &quot;baq&quot; (Basque)
<span class="lineNum">      69 </span>            :         {&quot;fa&quot;, &quot;fas&quot; }, // was &quot;per&quot; (Persian)
<span class="lineNum">      70 </span>            :         {&quot;fi&quot;, &quot;fin&quot; },
<span class="lineNum">      71 </span>            :         {&quot;fj&quot;, &quot;fij&quot; },
<span class="lineNum">      72 </span>            :         {&quot;fo&quot;, &quot;fao&quot; },
<span class="lineNum">      73 </span>            :         {&quot;fr&quot;, &quot;fra&quot; }, // was &quot;fre&quot; (French)
<span class="lineNum">      74 </span>            :         {&quot;fy&quot;, &quot;fry&quot; },
<span class="lineNum">      75 </span>            :         {&quot;ga&quot;, &quot;gle&quot; },
<span class="lineNum">      76 </span>            :         {&quot;gl&quot;, &quot;glg&quot; },
<span class="lineNum">      77 </span>            :         {&quot;gn&quot;, &quot;grn&quot; },
<span class="lineNum">      78 </span>            :         {&quot;gu&quot;, &quot;guj&quot; },
<span class="lineNum">      79 </span>            :         {&quot;ha&quot;, &quot;hau&quot; },
<span class="lineNum">      80 </span>            :         {&quot;he&quot;, &quot;heb&quot; },
<span class="lineNum">      81 </span>            :         {&quot;hi&quot;, &quot;hin&quot; },
<span class="lineNum">      82 </span>            :         {&quot;hr&quot;, &quot;scr&quot; },
<span class="lineNum">      83 </span>            :         {&quot;hu&quot;, &quot;hun&quot; },
<span class="lineNum">      84 </span>            :         {&quot;hy&quot;, &quot;hye&quot; }, // was &quot;arm&quot; (Armenian)
<span class="lineNum">      85 </span>            :         {&quot;ia&quot;, &quot;ina&quot; },
<span class="lineNum">      86 </span>            :         {&quot;id&quot;, &quot;ind&quot; },
<span class="lineNum">      87 </span>            :         {&quot;ik&quot;, &quot;ipk&quot; },
<span class="lineNum">      88 </span>            :         {&quot;is&quot;, &quot;isl&quot; }, // was &quot;ice&quot; (Icelandic)
<span class="lineNum">      89 </span>            :         {&quot;it&quot;, &quot;ita&quot; },
<span class="lineNum">      90 </span>            :         {&quot;iu&quot;, &quot;iku&quot; },
<span class="lineNum">      91 </span>            :         {&quot;ja&quot;, &quot;jpn&quot; },
<span class="lineNum">      92 </span>            :         {&quot;jv&quot;, &quot;jav&quot; },
<span class="lineNum">      93 </span>            :         {&quot;ka&quot;, &quot;kat&quot; }, // was &quot;geo&quot; (Georgian)
<span class="lineNum">      94 </span>            :         {&quot;kk&quot;, &quot;kaz&quot; },
<span class="lineNum">      95 </span>            :         {&quot;kl&quot;, &quot;kal&quot; },
<span class="lineNum">      96 </span>            :         {&quot;km&quot;, &quot;khm&quot; },
<span class="lineNum">      97 </span>            :         {&quot;kn&quot;, &quot;kan&quot; },
<span class="lineNum">      98 </span>            :         {&quot;ko&quot;, &quot;kor&quot; },
<span class="lineNum">      99 </span>            :         {&quot;ks&quot;, &quot;kas&quot; },
<span class="lineNum">     100 </span>            :         {&quot;ku&quot;, &quot;kur&quot; },
<span class="lineNum">     101 </span>            :         {&quot;ky&quot;, &quot;kir&quot; },
<span class="lineNum">     102 </span>            :         {&quot;la&quot;, &quot;lat&quot; },
<span class="lineNum">     103 </span>            :         {&quot;ln&quot;, &quot;lin&quot; },
<span class="lineNum">     104 </span>            :         {&quot;lo&quot;, &quot;lao&quot; },
<span class="lineNum">     105 </span>            :         {&quot;lt&quot;, &quot;lit&quot; },
<span class="lineNum">     106 </span>            :         {&quot;lv&quot;, &quot;lav&quot; },
<span class="lineNum">     107 </span>            :         {&quot;mg&quot;, &quot;mlg&quot; },
<span class="lineNum">     108 </span>            :         {&quot;mi&quot;, &quot;mri&quot; }, // was &quot;mao&quot; (Maori)
<span class="lineNum">     109 </span>            :         {&quot;mk&quot;, &quot;mkd&quot; }, // was &quot;mac&quot; (Macedonian)
<span class="lineNum">     110 </span>            :         {&quot;ml&quot;, &quot;mlt&quot; },
<span class="lineNum">     111 </span>            :         {&quot;mn&quot;, &quot;mon&quot; },
<span class="lineNum">     112 </span>            :         {&quot;mo&quot;, &quot;mol&quot; },
<span class="lineNum">     113 </span>            :         {&quot;mr&quot;, &quot;mar&quot; },
<span class="lineNum">     114 </span>            :         {&quot;ms&quot;, &quot;msa&quot; }, // was &quot;may&quot; (Malay)
<span class="lineNum">     115 </span>            :         {&quot;my&quot;, &quot;mya&quot; }, // was &quot;bur&quot; (Burmese)
<span class="lineNum">     116 </span>            :         {&quot;na&quot;, &quot;nau&quot; },
<span class="lineNum">     117 </span>            :         {&quot;ne&quot;, &quot;nep&quot; },
<span class="lineNum">     118 </span>            :         {&quot;nl&quot;, &quot;nld&quot; }, // was &quot;dut&quot; (Dutch; Flemish)
<span class="lineNum">     119 </span>            :         {&quot;no&quot;, &quot;nor&quot; },
<span class="lineNum">     120 </span>            :         {&quot;oc&quot;, &quot;oci&quot; },
<span class="lineNum">     121 </span>            :         {&quot;om&quot;, &quot;orm&quot; },
<span class="lineNum">     122 </span>            :         {&quot;or&quot;, &quot;ori&quot; },
<span class="lineNum">     123 </span>            :         {&quot;pa&quot;, &quot;pan&quot; },
<span class="lineNum">     124 </span>            :         {&quot;pl&quot;, &quot;pol&quot; },
<span class="lineNum">     125 </span>            :         {&quot;ps&quot;, &quot;pus&quot; },
<span class="lineNum">     126 </span>            :         {&quot;pt&quot;, &quot;por&quot; },
<span class="lineNum">     127 </span>            :         {&quot;qu&quot;, &quot;que&quot; },
<span class="lineNum">     128 </span>            :         {&quot;rm&quot;, &quot;roh&quot; },
<span class="lineNum">     129 </span>            :         {&quot;rn&quot;, &quot;run&quot; },
<span class="lineNum">     130 </span>            :         {&quot;ro&quot;, &quot;ron&quot; }, // was &quot;rum&quot; (Romanian; Moldavian; Moldovan)
<span class="lineNum">     131 </span>            :         {&quot;ru&quot;, &quot;rus&quot; },
<span class="lineNum">     132 </span>            :         {&quot;rw&quot;, &quot;kin&quot; },
<span class="lineNum">     133 </span>            :         {&quot;sa&quot;, &quot;san&quot; },
<span class="lineNum">     134 </span>            :         {&quot;sd&quot;, &quot;snd&quot; },
<span class="lineNum">     135 </span>            :         {&quot;sg&quot;, &quot;sag&quot; },
<span class="lineNum">     136 </span>            :         {&quot;sh&quot;, &quot;scr&quot; },
<span class="lineNum">     137 </span>            :         {&quot;si&quot;, &quot;sin&quot; },
<span class="lineNum">     138 </span>            :         {&quot;sk&quot;, &quot;slk&quot; }, // was &quot;slo&quot; (Slovak)
<span class="lineNum">     139 </span>            :         {&quot;sl&quot;, &quot;slv&quot; },
<span class="lineNum">     140 </span>            :         {&quot;sm&quot;, &quot;smo&quot; },
<span class="lineNum">     141 </span>            :         {&quot;sn&quot;, &quot;sna&quot; },
<span class="lineNum">     142 </span>            :         {&quot;so&quot;, &quot;som&quot; },
<span class="lineNum">     143 </span>            :         {&quot;sq&quot;, &quot;sqi&quot; }, // was &quot;alb&quot; (Albanian)
<span class="lineNum">     144 </span>            :         {&quot;sr&quot;, &quot;srp&quot; },
<span class="lineNum">     145 </span>            :         {&quot;ss&quot;, &quot;ssw&quot; },
<span class="lineNum">     146 </span>            :         {&quot;st&quot;, &quot;sot&quot; },
<span class="lineNum">     147 </span>            :         {&quot;su&quot;, &quot;sun&quot; },
<span class="lineNum">     148 </span>            :         {&quot;sv&quot;, &quot;swe&quot; },
<span class="lineNum">     149 </span>            :         {&quot;sw&quot;, &quot;swa&quot; },
<span class="lineNum">     150 </span>            :         {&quot;ta&quot;, &quot;tam&quot; },
<span class="lineNum">     151 </span>            :         {&quot;te&quot;, &quot;tel&quot; },
<span class="lineNum">     152 </span>            :         {&quot;tg&quot;, &quot;tgk&quot; },
<span class="lineNum">     153 </span>            :         {&quot;th&quot;, &quot;tha&quot; },
<span class="lineNum">     154 </span>            :         {&quot;ti&quot;, &quot;tir&quot; },
<span class="lineNum">     155 </span>            :         {&quot;tk&quot;, &quot;tuk&quot; },
<span class="lineNum">     156 </span>            :         {&quot;tl&quot;, &quot;tgl&quot; },
<span class="lineNum">     157 </span>            :         {&quot;tn&quot;, &quot;tsn&quot; },
<span class="lineNum">     158 </span>            :         {&quot;to&quot;, &quot;tog&quot; },
<span class="lineNum">     159 </span>            :         {&quot;tr&quot;, &quot;tur&quot; },
<span class="lineNum">     160 </span>            :         {&quot;ts&quot;, &quot;tso&quot; },
<span class="lineNum">     161 </span>            :         {&quot;tt&quot;, &quot;tat&quot; },
<span class="lineNum">     162 </span>            :         {&quot;tw&quot;, &quot;twi&quot; },
<span class="lineNum">     163 </span>            :         {&quot;ug&quot;, &quot;uig&quot; },
<span class="lineNum">     164 </span>            :         {&quot;uk&quot;, &quot;ukr&quot; },
<span class="lineNum">     165 </span>            :         {&quot;ur&quot;, &quot;urd&quot; },
<span class="lineNum">     166 </span>            :         {&quot;uz&quot;, &quot;uzb&quot; },
<span class="lineNum">     167 </span>            :         {&quot;vi&quot;, &quot;vie&quot; },
<span class="lineNum">     168 </span>            :         {&quot;vo&quot;, &quot;vol&quot; },
<span class="lineNum">     169 </span>            :         {&quot;wo&quot;, &quot;wol&quot; },
<span class="lineNum">     170 </span>            :         {&quot;xh&quot;, &quot;xho&quot; },
<span class="lineNum">     171 </span>            :         {&quot;yi&quot;, &quot;yid&quot; },
<span class="lineNum">     172 </span>            :         {&quot;yo&quot;, &quot;yor&quot; },
<span class="lineNum">     173 </span>            :         {&quot;za&quot;, &quot;zha&quot; },
<span class="lineNum">     174 </span>            :         {&quot;zh&quot;, &quot;zho&quot; }, // was &quot;chi&quot; (Chinese)
<span class="lineNum">     175 </span>            :         {&quot;zu&quot;, &quot;zul&quot; }
<span class="lineNum">     176 </span>            : };
<span class="lineNum">     177 </span>            : 
<a name="178"><span class="lineNum">     178 </span>            : </a>
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span><span class="lineNoCov">          0 : s32 vobsub_lang_name(u16 id)</span>
<span class="lineNum">     181 </span>            : {
<span class="lineNum">     182 </span>            :         u16 lang_id;
<span class="lineNum">     183 </span>            :         s32 i, count;
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span>            :         count = (sizeof(lang_table) / sizeof(lang_table[0]));
<span class="lineNum">     186 </span>            : 
<span class="lineNum">     187 </span><span class="lineCov">         52 :         for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">     188 </span><span class="lineCov">         54 :                 lang_id = (lang_table[i].id[0]&lt;&lt;8) | lang_table[i].id[1];</span>
<span class="lineNum">     189 </span>            : 
<span class="lineNum">     190 </span><span class="lineCov">         54 :                 if (id == lang_id) {</span>
<span class="lineNum">     191 </span>            :                         return i;
<span class="lineNum">     192 </span>            :                 }
<span class="lineNum">     193 </span>            :         }
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span>            :         return 0; /* Undefined - und */
<a name="196"><span class="lineNum">     196 </span>            : }</a>
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span><span class="lineCov">          1 : char *vobsub_lang_id(char *name)</span>
<span class="lineNum">     199 </span>            : {
<span class="lineNum">     200 </span>            :         s32 i, count;
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            :         count = (sizeof(lang_table) / sizeof(lang_table[0]));
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span><span class="lineCov">         27 :         for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">     205 </span><span class="lineCov">         27 :                 if (!stricmp(lang_table[i].lang, name)) {</span>
<span class="lineNum">     206 </span><span class="lineCov">          1 :                         return lang_table[i].id;</span>
<span class="lineNum">     207 </span>            :                 }
<span class="lineNum">     208 </span>            :         }
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span>            :         return &quot;--&quot;; /* Undefined */
<a name="211"><span class="lineNum">     211 </span>            : }</a>
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span><span class="lineCov">         90 : static char *strltrim(char *str)</span>
<span class="lineNum">     214 </span>            : {
<span class="lineNum">     215 </span><span class="lineCov">         90 :         if (str == NULL) {</span>
<span class="lineNum">     216 </span>            :                 return NULL;
<span class="lineNum">     217 </span>            :         }
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span><span class="lineCov">        130 :         while (*str) {</span>
<span class="lineNum">     220 </span><span class="lineCov">        128 :                 if (!isspace(*str)) {</span>
<span class="lineNum">     221 </span>            :                         return str;
<span class="lineNum">     222 </span>            :                 }
<span class="lineNum">     223 </span><span class="lineCov">         40 :                 str++;</span>
<span class="lineNum">     224 </span>            :         }
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span>            :         return str;
<a name="227"><span class="lineNum">     227 </span>            : }</a>
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span><span class="lineCov">         90 : static char *strrtrim(char *str)</span>
<span class="lineNum">     230 </span>            : {
<span class="lineNum">     231 </span>            :         char *end;
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span><span class="lineCov">         90 :         if (str == NULL) {</span>
<span class="lineNum">     234 </span>            :                 return NULL;
<span class="lineNum">     235 </span>            :         }
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span><span class="lineCov">         90 :         end = str + strlen(str);</span>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineCov">        280 :         while (end-- &gt; str) {</span>
<span class="lineNum">     240 </span><span class="lineCov">        188 :                 if (!isspace(*end)) {</span>
<span class="lineNum">     241 </span>            :                         return str;
<span class="lineNum">     242 </span>            :                 }
<span class="lineNum">     243 </span><span class="lineCov">        100 :                 *end = '\0';</span>
<span class="lineNum">     244 </span>            :         }
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span>            :         return str;
<span class="lineNum">     247 </span>            : }
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span>            : static char *strtrim(char *str)
<span class="lineNum">     250 </span>            : {
<span class="lineNum">     251 </span><span class="lineCov">         90 :         return strltrim(strrtrim(str));</span>
<a name="252"><span class="lineNum">     252 </span>            : }</a>
<span class="lineNum">     253 </span>            : 
<span class="lineNum">     254 </span><span class="lineCov">          2 : GF_Err vobsub_read_idx(FILE *file, vobsub_file *vobsub, s32 *version)</span>
<span class="lineNum">     255 </span>            : {
<span class="lineNum">     256 </span>            :         char  strbuf[256];
<span class="lineNum">     257 </span>            :         char *str, *pos, *entry;
<span class="lineNum">     258 </span><span class="lineCov">          2 :         s32   line, id =-1, delay = 0;</span>
<span class="lineNum">     259 </span>            :         Bool  error = 0;
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span><span class="lineCov">         52 :         for (line = 0; !error &amp;&amp; gf_fgets(strbuf, sizeof(strbuf), file); line++)</span>
<span class="lineNum">     262 </span>            :         {
<span class="lineNum">     263 </span>            :                 str = strtrim(strbuf);
<span class="lineNum">     264 </span>            : 
<span class="lineNum">     265 </span><span class="lineCov">         50 :                 if (line == 0)</span>
<span class="lineNum">     266 </span>            :                 {
<span class="lineNum">     267 </span>            :                         char *buf = &quot;VobSub index file, v&quot;;
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span><span class="lineCov">          2 :                         pos = strstr(str, buf);</span>
<span class="lineNum">     270 </span><span class="lineCov">          2 :                         if (pos == NULL || sscanf(pos + strlen(buf), &quot;%d&quot;, version) != 1 || *version &gt; VOBSUBIDXVER)</span>
<span class="lineNum">     271 </span>            :                         {
<span class="lineNum">     272 </span>            :                                 error = 1;
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     274 </span>            :                         }
<span class="lineNum">     275 </span>            :                 }
<span class="lineNum">     276 </span><span class="lineCov">         48 :                 else if (strlen(str) == 0)</span>
<span class="lineNum">     277 </span>            :                 {
<span class="lineNum">     278 </span><span class="lineCov">          2 :                         continue;</span>
<span class="lineNum">     279 </span>            :                 }
<span class="lineNum">     280 </span><span class="lineCov">         46 :                 else if (str[0] == '#')</span>
<span class="lineNum">     281 </span>            :                 {
<span class="lineNum">     282 </span><span class="lineCov">          6 :                         continue;</span>
<span class="lineNum">     283 </span>            :                 }
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span><span class="lineCov">         42 :                 pos = strchr(str, ':');</span>
<span class="lineNum">     286 </span><span class="lineCov">         42 :                 if (pos == NULL || pos == str)</span>
<span class="lineNum">     287 </span>            :                 {
<span class="lineNum">     288 </span><span class="lineCov">          2 :                         continue;</span>
<span class="lineNum">     289 </span>            :                 }
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            :                 entry = str;
<span class="lineNum">     292 </span><span class="lineCov">         40 :                 *pos  = '\0';</span>
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span><span class="lineCov">         40 :                 str = strtrim(pos + 1);</span>
<span class="lineNum">     295 </span><span class="lineCov">         40 :                 if (strlen(str) == 0)</span>
<span class="lineNum">     296 </span>            :                 {
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     298 </span>            :                 }
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span><span class="lineCov">         40 :                 if (stricmp(entry, &quot;size&quot;) == 0)</span>
<span class="lineNum">     301 </span>            :                 {
<span class="lineNum">     302 </span>            :                         s32 w, h;
<span class="lineNum">     303 </span><span class="lineCov">          2 :                         if (sscanf(str, &quot;%dx%d&quot;, &amp;w, &amp;h) != 2)</span>
<span class="lineNum">     304 </span>            :                         {
<span class="lineNum">     305 </span>            :                                 error = 1;
<span class="lineNum">     306 </span>            :                         }
<span class="lineNum">     307 </span><span class="lineCov">          2 :                         vobsub-&gt;width  = w;</span>
<span class="lineNum">     308 </span><span class="lineCov">          2 :                         vobsub-&gt;height = h;</span>
<span class="lineNum">     309 </span>            :                 }
<span class="lineNum">     310 </span><span class="lineCov">         38 :                 else if (stricmp(entry, &quot;palette&quot;) == 0)</span>
<span class="lineNum">     311 </span>            :                 {
<span class="lineNum">     312 </span>            :                         s32 c;
<span class="lineNum">     313 </span>            :                         u8  palette[16][4];
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineCov">          2 :                         if (sscanf(str, &quot;%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x&quot;,</span>
<span class="lineNum">     316 </span>            :                                    (u32 *) &amp;palette[0], (u32 *) &amp;palette[1], (u32 *) &amp;palette[2], (u32 *) &amp;palette[3],
<span class="lineNum">     317 </span>            :                                    (u32 *) &amp;palette[4], (u32 *) &amp;palette[5], (u32 *) &amp;palette[6], (u32 *) &amp;palette[7],
<span class="lineNum">     318 </span>            :                                    (u32 *) &amp;palette[8], (u32 *) &amp;palette[9], (u32 *) &amp;palette[10], (u32 *) &amp;palette[11],
<span class="lineNum">     319 </span>            :                                    (u32 *) &amp;palette[12],(u32 *) &amp;palette[13],(u32 *) &amp;palette[14], (u32 *) &amp;palette[15]) != 16)
<span class="lineNum">     320 </span>            :                         {
<span class="lineNum">     321 </span>            :                                 error = 1;
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     323 </span>            :                         }
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span><span class="lineCov">         32 :                         for (c = 0; c &lt; 16; c++)</span>
<span class="lineNum">     326 </span>            :                         {
<span class="lineNum">     327 </span>            :                                 u8 r, g, b;
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span><span class="lineCov">         32 :                                 r = palette[c][2];</span>
<span class="lineNum">     330 </span><span class="lineCov">         32 :                                 g = palette[c][1];</span>
<span class="lineNum">     331 </span><span class="lineCov">         32 :                                 b = palette[c][0];</span>
<span class="lineNum">     332 </span><span class="lineCov">         32 :                                 vobsub-&gt;palette[c][0] = 0;</span>
<span class="lineNum">     333 </span><span class="lineCov">         32 :                                 vobsub-&gt;palette[c][1] = (( 66 * r + 129 * g +  25 * b + 128 +  4096) &gt;&gt; 8) &amp; 0xff;</span>
<span class="lineNum">     334 </span><span class="lineCov">         32 :                                 vobsub-&gt;palette[c][2] = ((112 * r -  94 * g -  18 * b + 128 + 32768) &gt;&gt; 8) &amp; 0xff;</span>
<span class="lineNum">     335 </span><span class="lineCov">         32 :                                 vobsub-&gt;palette[c][3] = ((-38 * r -  74 * g + 112 * b + 128 + 32768) &gt;&gt; 8) &amp; 0xff;</span>
<span class="lineNum">     336 </span>            :                         }
<span class="lineNum">     337 </span>            :                 }
<span class="lineNum">     338 </span><span class="lineCov">         36 :                 else if (stricmp(entry, &quot;id&quot;) == 0)</span>
<span class="lineNum">     339 </span>            :                 {
<span class="lineNum">     340 </span>            :                         char *buf = &quot;index:&quot;;
<span class="lineNum">     341 </span>            :                         s32   lang_id;
<span class="lineNum">     342 </span>            : 
<span class="lineNum">     343 </span><span class="lineCov">          2 :                         strlwr(str);</span>
<span class="lineNum">     344 </span><span class="lineCov">          2 :                         lang_id = ((str[0] &amp; 0xff) &lt;&lt; 8) | (str[1] &amp; 0xff);</span>
<span class="lineNum">     345 </span>            : 
<span class="lineNum">     346 </span><span class="lineCov">          2 :                         pos = strstr(str, buf);</span>
<span class="lineNum">     347 </span><span class="lineCov">          2 :                         if (pos == NULL)</span>
<span class="lineNum">     348 </span>            :                         {
<span class="lineNum">     349 </span>            :                                 error = 1;
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     351 </span>            :                         }
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span><span class="lineCov">          2 :                         if (sscanf(pos + strlen(buf), &quot;%d&quot;, &amp;id) != 1 || id &lt; 0 || id &gt;= 32)</span>
<span class="lineNum">     354 </span>            :                         {
<span class="lineNum">     355 </span>            :                                 error = 1;
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     357 </span>            :                         }
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span><span class="lineCov">          2 :                         vobsub-&gt;langs[id].id   = lang_id;</span>
<span class="lineNum">     360 </span><span class="lineCov">          4 :                         vobsub-&gt;langs[id].name = lang_table[vobsub_lang_name((u16)lang_id)].lang;</span>
<span class="lineNum">     361 </span><span class="lineCov">          2 :                         vobsub-&gt;langs[id].idx = id;</span>
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span><span class="lineCov">          2 :                         vobsub-&gt;langs[id].subpos = gf_list_new();</span>
<span class="lineNum">     364 </span><span class="lineCov">          2 :                         if (vobsub-&gt;langs[id].subpos == NULL)</span>
<span class="lineNum">     365 </span>            :                         {
<span class="lineNum">     366 </span>            :                                 error = 1;
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     368 </span>            :                         }
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span>            :                         delay = 0;
<span class="lineNum">     371 </span><span class="lineCov">          2 :                         vobsub-&gt;num_langs++;</span>
<span class="lineNum">     372 </span>            :                 }
<span class="lineNum">     373 </span><span class="lineCov">         34 :                 else if (id &gt;= 0 &amp;&amp; stricmp(entry, &quot;delay&quot;) == 0)</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :                 {</span>
<span class="lineNum">     375 </span>            :                         s32  hh, mm, ss, ms;
<span class="lineNum">     376 </span>            :                         char c;
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :                         s32  sign = (str[0] == '-') ? -1 : 1;</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span>            :                         pos = str;
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :                         while (*pos == '-' || *pos == '+') pos++;</span>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :                         if (sscanf(pos, &quot;%d%c%d%c%d%c%d&quot;, &amp;hh, &amp;c, &amp;mm, &amp;c, &amp;ss, &amp;c, &amp;ms) != 7)</span>
<span class="lineNum">     383 </span>            :                         {
<span class="lineNum">     384 </span>            :                                 error = 1;
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     386 </span>            :                         }
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :                         delay += (hh*60*60*1000 + mm*60*1000 + ss*1000 + ms) * sign;</span>
<span class="lineNum">     389 </span>            :                 }
<span class="lineNum">     390 </span><span class="lineCov">         34 :                 else if (id &gt;= 0 &amp;&amp; stricmp(entry, &quot;timestamp&quot;) == 0)</span>
<span class="lineNum">     391 </span>            :                 {
<span class="lineNum">     392 </span>            :                         vobsub_pos *vspos;
<span class="lineNum">     393 </span>            :                         s32         sign;
<span class="lineNum">     394 </span>            :                         char        c;
<span class="lineNum">     395 </span>            :                         s32         hh, mm, ss, ms;
<span class="lineNum">     396 </span>            :                         char       *buf = &quot;filepos:&quot;;
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span><span class="lineCov">         30 :                         vspos = (vobsub_pos*)gf_calloc(1, sizeof(vobsub_pos));</span>
<span class="lineNum">     399 </span><span class="lineCov">         30 :                         if (vspos == NULL) {</span>
<span class="lineNum">     400 </span>            :                                 error = 1;
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     402 </span>            :                         }
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span><span class="lineCov">         30 :                         sign = (str[0] == '-') ? -1 : 1;</span>
<span class="lineNum">     405 </span><span class="lineCov">         30 :                         while (*str == '-' || *str == '+') str++;</span>
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span><span class="lineCov">         30 :                         if (sscanf(str, &quot;%d%c%d%c%d%c%d&quot;, &amp;hh, &amp;c, &amp;mm, &amp;c, &amp;ss, &amp;c, &amp;ms) != 7)</span>
<span class="lineNum">     408 </span>            :                         {
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :                                 gf_free(vspos);</span>
<span class="lineNum">     410 </span>            :                                 error = 1;
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     412 </span>            :                         }
<span class="lineNum">     413 </span>            : 
<span class="lineNum">     414 </span><span class="lineCov">         30 :                         vspos-&gt;start = (((hh*60 + mm)*60 + ss)*1000 + ms) * sign + delay;</span>
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span><span class="lineCov">         30 :                         pos = strstr(str, buf);</span>
<span class="lineNum">     417 </span><span class="lineCov">         30 :                         if (pos == NULL)</span>
<span class="lineNum">     418 </span>            :                         {
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :                                 gf_free(vspos);</span>
<span class="lineNum">     420 </span>            :                                 error = 1;
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     422 </span>            :                         }
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineCov">         30 :                         if (sscanf(pos + strlen(buf), LLX, &amp;vspos-&gt;filepos) != 1)</span>
<span class="lineNum">     425 </span>            :                         {
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :                                 gf_free(vspos);</span>
<span class="lineNum">     427 </span>            :                                 error = 1;
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     429 </span>            :                         }
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineCov">         30 :                         if (delay &lt; 0 &amp;&amp; gf_list_count(vobsub-&gt;langs[id].subpos) &gt; 0)</span>
<span class="lineNum">     432 </span>            :                         {
<span class="lineNum">     433 </span>            :                                 vobsub_pos *vspos_next;
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :                                 vspos_next = (vobsub_pos*)gf_list_get(vobsub-&gt;langs[id].subpos, gf_list_count(vobsub-&gt;langs[id].subpos) - 1);</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :                                 if (vspos-&gt;start &lt; vspos_next-&gt;start)</span>
<span class="lineNum">     437 </span>            :                                 {
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :                                         delay += (s32)(vspos_next-&gt;start - vspos-&gt;start);</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :                                         vspos-&gt;start = vspos_next-&gt;start;</span>
<span class="lineNum">     440 </span>            :                                 }
<span class="lineNum">     441 </span>            :                         }
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineCov">         30 :                         if (gf_list_add(vobsub-&gt;langs[id].subpos, vspos) != GF_OK)</span>
<span class="lineNum">     444 </span>            :                         {
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :                                 gf_free(vspos);</span>
<span class="lineNum">     446 </span>            :                                 error = 1;
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     448 </span>            :                         }
<span class="lineNum">     449 </span>            :                 }
<span class="lineNum">     450 </span>            :         }
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span><span class="lineCov">          2 :         return error ? GF_CORRUPTED_DATA : GF_OK;</span>
<a name="453"><span class="lineNum">     453 </span>            : }</a>
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span><span class="lineCov">          2 : void vobsub_free(vobsub_file *vobsub)</span>
<span class="lineNum">     456 </span>            : {
<span class="lineNum">     457 </span>            :         s32 i;
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span><span class="lineCov">          2 :         if (vobsub == NULL)</span>
<span class="lineNum">     460 </span>            :                 return;
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineCov">         64 :         for (i = 0; i &lt; 32; i++) {</span>
<span class="lineNum">     463 </span><span class="lineCov">         64 :                 if (vobsub-&gt;langs[i].subpos) {</span>
<span class="lineNum">     464 </span>            :                         GF_List *list = vobsub-&gt;langs[i].subpos;
<span class="lineNum">     465 </span>            :                         vobsub_pos *vspos;
<span class="lineNum">     466 </span><span class="lineCov">          2 :                         u32 pos = 0;</span>
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span>            :                         do {
<span class="lineNum">     469 </span><span class="lineCov">         32 :                                 vspos = (vobsub_pos*)gf_list_enum(list, &amp;pos);</span>
<span class="lineNum">     470 </span><span class="lineCov">         32 :                                 gf_free(vspos);</span>
<span class="lineNum">     471 </span>            :                         }
<span class="lineNum">     472 </span><span class="lineCov">         32 :                         while (vspos != NULL);</span>
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineCov">          2 :                         gf_list_del(list);</span>
<span class="lineNum">     475 </span>            :                 }
<span class="lineNum">     476 </span>            :         }
<span class="lineNum">     477 </span><span class="lineCov">          2 :         gf_free(vobsub);</span>
<a name="478"><span class="lineNum">     478 </span>            : }</a>
<span class="lineNum">     479 </span>            : 
<span class="lineNum">     480 </span><span class="lineCov">         30 : GF_Err vobsub_get_subpic_duration(u8 *_data, u32 psize, u32 dsize, u32 *duration)</span>
<span class="lineNum">     481 </span>            : {
<span class="lineNum">     482 </span>            :         u32 i, dcsq_stm, nxt_dcsq, start_stm, stop_stm;
<span class="lineNum">     483 </span>            :         u8 *data = (u8 *)_data;
<span class="lineNum">     484 </span>            :         start_stm = 0;
<span class="lineNum">     485 </span>            :         stop_stm  = 0;
<span class="lineNum">     486 </span>            :         nxt_dcsq  = dsize;
<span class="lineNum">     487 </span>            : 
<span class="lineNum">     488 </span><span class="lineCov">         30 :         if (psize) do {</span>
<span class="lineNum">     489 </span>            :                 i = nxt_dcsq;
<span class="lineNum">     490 </span><span class="lineCov">         60 :                 dcsq_stm = (data[i+0] &lt;&lt; 8) | data[i+1];</span>
<span class="lineNum">     491 </span><span class="lineCov">         60 :                 nxt_dcsq = (data[i+2] &lt;&lt; 8) | data[i+3];</span>
<span class="lineNum">     492 </span><span class="lineCov">         60 :                 i += 4;</span>
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span><span class="lineCov">         60 :                 if (nxt_dcsq &gt; psize || nxt_dcsq &lt; dsize) {</span>
<span class="lineNum">     495 </span>            :                         return GF_CORRUPTED_DATA;
<span class="lineNum">     496 </span>            :                 }
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span>            :                 while (1) {
<span class="lineNum">     499 </span>            :                         u8  cmd;
<span class="lineNum">     500 </span>            :                         int len;
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span><span class="lineCov">        240 :                         cmd = data[i++];</span>
<span class="lineNum">     503 </span>            :                         switch (cmd)
<span class="lineNum">     504 </span>            :                         {
<span class="lineNum">     505 </span>            :                         case 0x00:
<span class="lineNum">     506 </span>            :                                 len = 0;
<span class="lineNum">     507 </span>            :                                 break;
<span class="lineNum">     508 </span>            :                         case 0x01:
<span class="lineNum">     509 </span>            :                                 len = 0;
<span class="lineNum">     510 </span>            :                                 break;
<span class="lineNum">     511 </span>            :                         case 0x02:
<span class="lineNum">     512 </span>            :                                 len = 0;
<span class="lineNum">     513 </span>            :                                 break;
<span class="lineNum">     514 </span>            :                         case 0x03:
<span class="lineNum">     515 </span>            :                                 len = 2;
<span class="lineNum">     516 </span>            :                                 break;
<span class="lineNum">     517 </span>            :                         case 0x04:
<span class="lineNum">     518 </span>            :                                 len = 2;
<span class="lineNum">     519 </span>            :                                 break;
<span class="lineNum">     520 </span>            :                         case 0x05:
<span class="lineNum">     521 </span>            :                                 len = 6;
<span class="lineNum">     522 </span>            :                                 break;
<span class="lineNum">     523 </span>            :                         case 0x06:
<span class="lineNum">     524 </span>            :                                 len = 4;
<span class="lineNum">     525 </span>            :                                 break;
<span class="lineNum">     526 </span>            :                         default:
<span class="lineNum">     527 </span>            :                                 len = 0;
<span class="lineNum">     528 </span>            :                                 break;
<span class="lineNum">     529 </span>            :                         }
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span><span class="lineCov">        240 :                         if (i + len &gt; psize) {</span>
<span class="lineNum">     532 </span>            :                                 return GF_CORRUPTED_DATA;
<span class="lineNum">     533 </span>            :                         }
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span>            :                         i += len;
<span class="lineNum">     536 </span>            : 
<span class="lineNum">     537 </span><span class="lineCov">        240 :                         if (cmd == 0x00 || cmd == 0x01) {</span>
<span class="lineNum">     538 </span>            :                                 /* start normal or forced displaying */
<span class="lineNum">     539 </span><span class="lineCov">         30 :                                 start_stm = dcsq_stm * 1024;</span>
<span class="lineNum">     540 </span><span class="lineCov">        210 :                         } else if (cmd == 0x02) {</span>
<span class="lineNum">     541 </span>            :                                 /* stop displaying */
<span class="lineNum">     542 </span><span class="lineCov">         30 :                                 stop_stm = dcsq_stm * 1024;</span>
<span class="lineNum">     543 </span><span class="lineCov">        180 :                         } else if (cmd &gt; 0x06) {</span>
<span class="lineNum">     544 </span>            :                                 /* unknown command or end of control block */
<span class="lineNum">     545 </span>            :                                 break;
<span class="lineNum">     546 </span>            :                         }
<span class="lineNum">     547 </span>            :                 }
<span class="lineNum">     548 </span><span class="lineCov">         60 :         } while (i &lt;= nxt_dcsq &amp;&amp; i &lt; psize);</span>
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span><span class="lineCov">         30 :         *duration = stop_stm - start_stm;</span>
<span class="lineNum">     551 </span>            : 
<span class="lineNum">     552 </span><span class="lineCov">         30 :         return GF_OK;</span>
<a name="553"><span class="lineNum">     553 </span>            : }</a>
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span><span class="lineCov">         14 : GF_Err vobsub_packetize_subpicture(FILE *fsub, u64 pts, u8 *data, u32 dataSize)</span>
<span class="lineNum">     556 </span>            : {
<span class="lineNum">     557 </span>            :         u8      buf[0x800], ptsbuf[5];
<span class="lineNum">     558 </span>            :         int     put_pts = 1;
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span>            :         /* Build PTS buffer */
<span class="lineNum">     561 </span><span class="lineCov">         14 :         ptsbuf[0] = (u8)(((pts &gt;&gt; 29) &amp; 0x0e) | 0x21);</span>
<span class="lineNum">     562 </span><span class="lineCov">         14 :         ptsbuf[1] = (u8)(((pts &gt;&gt; 22) &amp; 0xff));</span>
<span class="lineNum">     563 </span><span class="lineCov">         14 :         ptsbuf[2] = (u8)(((pts &gt;&gt; 14) &amp; 0xfe) | 0x01);</span>
<span class="lineNum">     564 </span><span class="lineCov">         14 :         ptsbuf[3] = (u8)(((pts &gt;&gt;  7) &amp; 0xff));</span>
<span class="lineNum">     565 </span><span class="lineCov">         14 :         ptsbuf[4] = (u8)(((pts &lt;&lt;  1) &amp; 0xfe) | 0x01);</span>
<span class="lineNum">     566 </span>            : 
<span class="lineNum">     567 </span><span class="lineCov">         51 :         while (dataSize &gt; 0) {</span>
<span class="lineNum">     568 </span>            :                 u8      *p;
<span class="lineNum">     569 </span>            :                 u32 padLen = 0;
<span class="lineNum">     570 </span>            :                 u32 dataLen = sizeof(buf);
<span class="lineNum">     571 </span>            :                 u32 packLen;
<span class="lineNum">     572 </span>            : 
<span class="lineNum">     573 </span>            :                 /* Zerofill packet */
<span class="lineNum">     574 </span>            :                 memset(buf, 0, sizeof(buf));
<span class="lineNum">     575 </span>            :                 p = buf;
<span class="lineNum">     576 </span>            : 
<span class="lineNum">     577 </span>            :                 /* Put pack header */
<span class="lineNum">     578 </span>            :                 *p++ = 0x00;
<span class="lineNum">     579 </span>            :                 *p++ = 0x00;
<span class="lineNum">     580 </span><span class="lineCov">         23 :                 *p++ = 0x01;</span>
<span class="lineNum">     581 </span><span class="lineCov">         23 :                 *p++ = 0xba;</span>
<span class="lineNum">     582 </span><span class="lineCov">         23 :                 *p++ = 0x40;</span>
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span>            :                 /* Jump to PES header */
<span class="lineNum">     585 </span>            :                 p += 9;
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span>            :                 /* Put PES header */
<span class="lineNum">     588 </span>            :                 *p++ = 0x00;
<span class="lineNum">     589 </span>            :                 *p++ = 0x00;
<span class="lineNum">     590 </span><span class="lineCov">         23 :                 *p++ = 0x01;</span>
<span class="lineNum">     591 </span><span class="lineCov">         23 :                 *p++ = 0xbd;</span>
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span>            :                 /* Compute max size of content */
<span class="lineNum">     594 </span>            :                 dataLen -= 14; /* Pack header */
<span class="lineNum">     595 </span>            :                 dataLen -=  4; /* Start code + Stream ID */
<span class="lineNum">     596 </span>            :                 dataLen -=  2; /* PES packet size */
<span class="lineNum">     597 </span>            :                 dataLen -=  3; /* PES header extension */
<span class="lineNum">     598 </span><span class="lineCov">         23 :                 dataLen -= put_pts ? 5 : 0; /* PTS */</span>
<span class="lineNum">     599 </span><span class="lineCov">         23 :                 dataLen -=  1; /* Substream ID */</span>
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span>            :                 /* Check if the subpicture data fits in packet */
<span class="lineNum">     602 </span><span class="lineCov">         23 :                 if (dataSize &lt;= dataLen) {</span>
<span class="lineNum">     603 </span><span class="lineCov">         14 :                         padLen  = dataLen - dataSize;</span>
<span class="lineNum">     604 </span>            :                         dataLen = dataSize;
<span class="lineNum">     605 </span>            :                 }
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span>            :                 /* Compute and put packet size (PES header extension + PTS + Substream ID + data + padding) */
<span class="lineNum">     608 </span><span class="lineCov">         23 :                 packLen = 3 + (put_pts ? 5 : 0) + 1 + dataLen + ((padLen &lt; 6) ? padLen : 0);</span>
<span class="lineNum">     609 </span><span class="lineCov">         23 :                 *p++ = (packLen &gt;&gt; 8) &amp; 0xff;</span>
<span class="lineNum">     610 </span><span class="lineCov">         23 :                 *p++ = packLen &amp; 0xff;</span>
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span>            :                 /* Put PES header extension */
<span class="lineNum">     613 </span><span class="lineCov">         23 :                 *p++ = 0x80;</span>
<span class="lineNum">     614 </span><span class="lineCov">         23 :                 *p++ = put_pts ? 0x80 : 0x00;</span>
<span class="lineNum">     615 </span><span class="lineCov">         23 :                 *p++ = (put_pts ? 5 : 0) + ((padLen &lt; 6) ? padLen : 0);</span>
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            :                 /* Put PTS */
<span class="lineNum">     618 </span><span class="lineCov">         23 :                 if (put_pts) {</span>
<span class="lineNum">     619 </span><span class="lineCov">         14 :                         *p++ = ptsbuf[0];</span>
<span class="lineNum">     620 </span><span class="lineCov">         14 :                         *p++ = ptsbuf[1];</span>
<span class="lineNum">     621 </span><span class="lineCov">         14 :                         *p++ = ptsbuf[2];</span>
<span class="lineNum">     622 </span><span class="lineCov">         14 :                         *p++ = ptsbuf[3];</span>
<span class="lineNum">     623 </span><span class="lineCov">         14 :                         *p++ = ptsbuf[4];</span>
<span class="lineNum">     624 </span>            :                 }
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span>            :                 /* Skip padding bytes */
<span class="lineNum">     627 </span><span class="lineCov">         23 :                 if (padLen &lt; 6) {</span>
<span class="lineNum">     628 </span><span class="lineCov">         10 :                         p += padLen;</span>
<span class="lineNum">     629 </span>            :                 }
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span>            :                 /* Put Substream ID */
<span class="lineNum">     632 </span><span class="lineCov">         23 :                 *p++ = 0x20;</span>
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span>            :                 /* Copy data into packet buffer */
<span class="lineNum">     635 </span><span class="lineCov">         23 :                 memcpy(p, data, dataLen);</span>
<span class="lineNum">     636 </span><span class="lineCov">         23 :                 p += dataLen;</span>
<span class="lineNum">     637 </span>            : 
<span class="lineNum">     638 </span>            :                 /* Put padding bytes if padding len &gt;= 6 */
<span class="lineNum">     639 </span><span class="lineCov">         23 :                 if (padLen &gt;= 6) {</span>
<span class="lineNum">     640 </span><span class="lineCov">         13 :                         padLen -= 6;</span>
<span class="lineNum">     641 </span><span class="lineCov">         13 :                         *p++ = 0x00;</span>
<span class="lineNum">     642 </span><span class="lineCov">         13 :                         *p++ = 0x00;</span>
<span class="lineNum">     643 </span><span class="lineCov">         13 :                         *p++ = 0x01;</span>
<span class="lineNum">     644 </span><span class="lineCov">         13 :                         *p++ = 0xbe;</span>
<span class="lineNum">     645 </span><span class="lineCov">         13 :                         *p++ = (padLen &gt;&gt; 8) &amp; 0xff;</span>
<span class="lineNum">     646 </span><span class="lineCov">         13 :                         *p++ = padLen &amp; 0xff;</span>
<span class="lineNum">     647 </span><span class="lineCov">         13 :                         memset(p, 0, padLen);</span>
<span class="lineNum">     648 </span>            :                 }
<span class="lineNum">     649 </span>            : 
<span class="lineNum">     650 </span>            :                 /* Write packet into file */
<span class="lineNum">     651 </span><span class="lineCov">         23 :                 if (gf_fwrite(buf, sizeof(buf), fsub) != sizeof(buf)) {</span>
<span class="lineNum">     652 </span>            :                         return GF_IO_ERR;
<span class="lineNum">     653 </span>            :                 }
<span class="lineNum">     654 </span>            : 
<span class="lineNum">     655 </span>            :                 /* Move data pointer... */
<span class="lineNum">     656 </span><span class="lineCov">         23 :                 data += dataLen;</span>
<span class="lineNum">     657 </span><span class="lineCov">         23 :                 dataSize -= dataLen;</span>
<span class="lineNum">     658 </span>            : 
<span class="lineNum">     659 </span>            :                 /* Next packet (if any) will not contain PTS */
<span class="lineNum">     660 </span>            :                 put_pts = 0;
<span class="lineNum">     661 </span>            :         }
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span>            :         return GF_OK;
<span class="lineNum">     664 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

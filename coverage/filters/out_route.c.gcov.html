<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - filters/out_route.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">filters</a> - out_route.c<span style="font-size: 80%;"> (source / <a href="out_route.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">824</td>
            <td class="headerCovTableEntry">1098</td>
            <td class="headerCovTableEntryMed">75.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">18</td>
            <td class="headerCovTableEntry">18</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2020
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / ROUTE output filter
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : #include &lt;gpac/filters.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;gpac/xml.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;gpac/route.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;gpac/network.h&gt;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : enum
<span class="lineNum">      35 </span>            : {
<span class="lineNum">      36 </span>            :         LCT_SPLIT_NONE=0,
<span class="lineNum">      37 </span>            :         LCT_SPLIT_TYPE,
<span class="lineNum">      38 </span>            :         LCT_SPLIT_ALL,
<span class="lineNum">      39 </span>            : };
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : typedef struct
<span class="lineNum">      42 </span>            : {
<span class="lineNum">      43 </span>            :         char *dst, *ext, *mime, *ifce, *ip;
<span class="lineNum">      44 </span>            :         u32 carousel, first_port, bsid, mtu, splitlct, ttl, brinc, runfor;
<span class="lineNum">      45 </span>            :         Bool korean, llmode, noreg;
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            :         GF_FilterCapability in_caps[2];
<span class="lineNum">      48 </span>            :         char szExt[10];
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span>            :         GF_List *services;
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            :         //ATSC3
<span class="lineNum">      53 </span>            :         GF_Socket *sock_atsc_lls;
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span>            :         u64 clock_init, clock, clock_stats;
<span class="lineNum">      56 </span>            :         u64 last_lls_clock;
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            :         u8 *lls_time_table;
<span class="lineNum">      59 </span>            :         u32 lls_time_table_len;
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            :         u8 *lls_slt_table;
<span class="lineNum">      62 </span>            :         u32 lls_slt_table_len;
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            :         u64 bytes_sent;
<span class="lineNum">      65 </span>            :         u8 *lct_buffer;
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span>            :         u64 reschedule_us;
<span class="lineNum">      68 </span>            :         u32 next_raw_file_toi;
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span>            :         Bool reporting_on;
<span class="lineNum">      71 </span>            :         u64 total_size, total_bytes;
<span class="lineNum">      72 </span>            :         Bool total_size_unknown;
<span class="lineNum">      73 </span>            :         u32 nb_resources;
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span>            :         Bool done;
<span class="lineNum">      76 </span>            : } GF_ROUTEOutCtx;
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            : typedef struct
<span class="lineNum">      79 </span>            : {
<span class="lineNum">      80 </span>            :         char *ip;
<span class="lineNum">      81 </span>            :         u32 port;
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            :         //for now we use a single route session per service, differenciated by TSI
<span class="lineNum">      84 </span>            :         GF_Socket *sock;
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span>            : } ROUTELCT;
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            : typedef struct
<span class="lineNum">      89 </span>            : {
<span class="lineNum">      90 </span>            :         u32 service_id;
<span class="lineNum">      91 </span>            :         GF_List *pids;
<span class="lineNum">      92 </span>            :         u32 dash_mode;
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span>            :         GF_List *rlcts;
<span class="lineNum">      95 </span>            :         ROUTELCT *rlct_base;
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span>            :         Bool is_done;
<span class="lineNum">      98 </span>            :         Bool wait_for_inputs;
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            :         //storage for main manifest - all manifests (including HLS sub-playlists) are sent in the same PID
<span class="lineNum">     101 </span>            :         //HLS sub-playlists are stored on their related PID to be pushed at each new seg
<span class="lineNum">     102 </span>            :         char *manifest, *manifest_name, *manifest_mime, *manifest_server, *manifest_url;
<span class="lineNum">     103 </span>            :         u32 manifest_version, manifest_crc;
<span class="lineNum">     104 </span>            :         Bool stsid_changed;
<span class="lineNum">     105 </span>            :         u32 stsid_version;
<span class="lineNum">     106 </span>            :         u32 first_port;
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span>            :         u8 *stsid_bundle;
<span class="lineNum">     109 </span>            :         u32 stsid_bundle_size;
<span class="lineNum">     110 </span>            :         u32 stsid_bundle_toi;
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span>            :         u64 last_stsid_clock;
<span class="lineNum">     113 </span>            :         u32 manifest_type;
<span class="lineNum">     114 </span>            :         u32 creation_time;
<span class="lineNum">     115 </span>            : } ROUTEService;
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span>            : typedef struct
<span class="lineNum">     118 </span>            : {
<span class="lineNum">     119 </span>            :         GF_FilterPid *pid;
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span>            :         ROUTEService *route;
<span class="lineNum">     122 </span>            :         ROUTELCT *rlct;
<span class="lineNum">     123 </span>            : 
<span class="lineNum">     124 </span>            :         u32 tsi, bandwidth, stream_type;
<span class="lineNum">     125 </span>            :         GF_Fraction dash_dur;
<span class="lineNum">     126 </span>            :         //we cannot hold a ref to the init segment packet, as this may lock the input waiting for its realease to dispatch next packets
<span class="lineNum">     127 </span>            :         u8 *init_seg_data;
<span class="lineNum">     128 </span>            :         u32 init_seg_size;
<span class="lineNum">     129 </span>            :         u32 init_seg_crc;
<span class="lineNum">     130 </span>            :         char *init_seg_name;
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span>            :         //0: not manifest, 1: MPD, 2: HLS
<span class="lineNum">     133 </span>            :         u32 manifest_type;
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span>            :         Bool init_seg_sent;
<span class="lineNum">     136 </span>            : 
<span class="lineNum">     137 </span>            :         char *template;
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span>            :         char *hld_child_pl, *hld_child_pl_name;
<span class="lineNum">     140 </span>            :         u32 hld_child_pl_version, hld_child_pl_crc;
<span class="lineNum">     141 </span>            :         u64 hls_ref_id;
<span class="lineNum">     142 </span>            :         Bool update_hls_child_pl;
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span>            :         u32 fmtp, mode;
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span>            :         GF_FilterPacket *current_pck;
<span class="lineNum">     147 </span>            :         u32 current_toi;
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span>            :         const u8 *pck_data;
<span class="lineNum">     150 </span>            :         u32 pck_size, pck_offset;
<span class="lineNum">     151 </span>            :         u64 res_size, offset_at_seg_start;
<span class="lineNum">     152 </span>            :         char *seg_name;
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span>            :         u32 timescale;
<span class="lineNum">     155 </span>            :         u64 clock_at_first_pck;
<span class="lineNum">     156 </span>            :         u64 cts_first_pck;
<span class="lineNum">     157 </span>            :         u64 current_cts_us;
<span class="lineNum">     158 </span>            :         u64 current_dur_us;
<span class="lineNum">     159 </span>            :         u64 carousel_time_us;
<span class="lineNum">     160 </span>            :         u64 clock_at_pck;
<span class="lineNum">     161 </span>            :         Bool raw_file, use_basename;
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span>            :         u32 full_frame_size, cumulated_frag_size, frag_offset;
<span class="lineNum">     164 </span>            :         u32 frag_idx;
<span class="lineNum">     165 </span>            :         Bool push_init, force_tol_send;
<span class="lineNum">     166 </span>            :         u64 clock_at_frame_start, cts_us_at_frame_start, cts_at_frame_start;
<span class="lineNum">     167 </span>            :         u32 pck_dur_at_frame_start;
<span class="lineNum">     168 </span>            : 
<span class="lineNum">     169 </span>            :         u32 bitrate;
<span class="lineNum">     170 </span>            : } ROUTEPid;
<a name="171"><span class="lineNum">     171 </span>            : </a>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span><span class="lineCov">          7 : ROUTELCT *route_create_lct_channel(GF_ROUTEOutCtx *ctx, const char *ip, u32 port, GF_Err *e)</span>
<span class="lineNum">     174 </span>            : {
<span class="lineNum">     175 </span><span class="lineCov">          7 :         *e = GF_OUT_OF_MEM;</span>
<span class="lineNum">     176 </span>            :         ROUTELCT *rlct;
<span class="lineNum">     177 </span><span class="lineCov">          7 :         GF_SAFEALLOC(rlct, ROUTELCT);</span>
<span class="lineNum">     178 </span><span class="lineCov">          7 :         if (!rlct) return NULL;</span>
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span><span class="lineCov">          7 :         rlct-&gt;ip = gf_strdup(ip ? ip : ctx-&gt;ip);</span>
<span class="lineNum">     181 </span><span class="lineCov">          7 :         if (!rlct-&gt;ip) goto fail;</span>
<span class="lineNum">     182 </span><span class="lineCov">          7 :         if (port) {</span>
<span class="lineNum">     183 </span><span class="lineCov">          7 :                 rlct-&gt;port = port;</span>
<span class="lineNum">     184 </span>            :         } else {
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :                 rlct-&gt;port = ctx-&gt;first_port;</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :                 ctx-&gt;first_port ++;</span>
<span class="lineNum">     187 </span>            :         }
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineCov">          7 :         if (rlct-&gt;ip) {</span>
<span class="lineNum">     190 </span><span class="lineCov">          7 :                 rlct-&gt;sock = gf_sk_new(GF_SOCK_TYPE_UDP);</span>
<span class="lineNum">     191 </span><span class="lineCov">          7 :                 if (rlct-&gt;sock) {</span>
<span class="lineNum">     192 </span><span class="lineCov">          7 :                         *e = gf_sk_setup_multicast(rlct-&gt;sock, rlct-&gt;ip, rlct-&gt;port, ctx-&gt;ttl, GF_FALSE, ctx-&gt;ifce);</span>
<span class="lineNum">     193 </span><span class="lineCov">          7 :                         if (*e) {</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :                                 gf_sk_del(rlct-&gt;sock);</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :                                 rlct-&gt;sock = NULL;</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :                                 goto fail;</span>
<span class="lineNum">     197 </span>            :                         }
<span class="lineNum">     198 </span>            :                 }
<span class="lineNum">     199 </span>            :         }
<span class="lineNum">     200 </span><span class="lineCov">          7 :         *e = GF_OK;</span>
<span class="lineNum">     201 </span><span class="lineCov">          7 :         return rlct;</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 : fail:</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :         if (rlct-&gt;ip) gf_free(rlct-&gt;ip);</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :         gf_free(rlct);</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :         return NULL;</span>
<a name="206"><span class="lineNum">     206 </span>            : }</a>
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span><span class="lineCov">          7 : ROUTEService *routeout_create_service(GF_ROUTEOutCtx *ctx, u32 service_id, const char *ip, u32 port, GF_Err *e)</span>
<span class="lineNum">     209 </span>            : {
<span class="lineNum">     210 </span>            :         ROUTEService *rserv;
<span class="lineNum">     211 </span>            :         ROUTELCT *rlct = NULL;
<span class="lineNum">     212 </span><span class="lineCov">          7 :         *e = GF_OUT_OF_MEM;</span>
<span class="lineNum">     213 </span><span class="lineCov">          7 :         GF_SAFEALLOC(rserv, ROUTEService);</span>
<span class="lineNum">     214 </span><span class="lineCov">          7 :         if (!rserv) return NULL;</span>
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span><span class="lineCov">          7 :         rlct = route_create_lct_channel(ctx, ip, port, e);</span>
<span class="lineNum">     217 </span><span class="lineCov">          7 :         if (!rlct) {</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :                 gf_free(rserv);</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     220 </span>            :         }
<span class="lineNum">     221 </span><span class="lineCov">          7 :         if (port) {</span>
<span class="lineNum">     222 </span><span class="lineCov">          7 :                 rserv-&gt;first_port = port+1;</span>
<span class="lineNum">     223 </span>            :         }
<span class="lineNum">     224 </span>            : 
<span class="lineNum">     225 </span><span class="lineCov">          7 :         rserv-&gt;pids = gf_list_new();</span>
<span class="lineNum">     226 </span><span class="lineCov">          7 :         if (!rserv-&gt;pids) goto fail;</span>
<span class="lineNum">     227 </span><span class="lineCov">          7 :         rserv-&gt;rlcts = gf_list_new();</span>
<span class="lineNum">     228 </span><span class="lineCov">          7 :         if (!rserv-&gt;rlcts) goto fail;</span>
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span><span class="lineCov">          7 :         gf_list_add(rserv-&gt;rlcts, rlct);</span>
<span class="lineNum">     231 </span><span class="lineCov">          7 :         rserv-&gt;rlct_base = rlct;</span>
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span><span class="lineCov">          7 :         rserv-&gt;service_id = service_id;</span>
<span class="lineNum">     234 </span><span class="lineCov">          7 :         gf_list_add(ctx-&gt;services, rserv);</span>
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span><span class="lineCov">          7 :         if (ctx-&gt;lls_slt_table) {</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :                 gf_free(ctx-&gt;lls_slt_table);</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :                 ctx-&gt;lls_slt_table = NULL;</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :                 ctx-&gt;last_lls_clock = 0;</span>
<span class="lineNum">     240 </span>            :         }
<span class="lineNum">     241 </span><span class="lineCov">          7 :         *e = GF_OK;</span>
<span class="lineNum">     242 </span><span class="lineCov">          7 :         return rserv;</span>
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span><span class="lineNoCov">          0 : fail:</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :         *e = GF_OUT_OF_MEM;</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :         if (rlct-&gt;ip) gf_free(rlct-&gt;ip);</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :         gf_free(rlct);</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :         if (rserv-&gt;pids) gf_list_del(rserv-&gt;pids);</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :         if (rserv-&gt;rlcts) gf_list_del(rserv-&gt;rlcts);</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :         gf_free(rserv);</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :         return NULL;</span>
<a name="252"><span class="lineNum">     252 </span>            : }</a>
<span class="lineNum">     253 </span>            : 
<span class="lineNum">     254 </span><span class="lineCov">         16 : void routeout_remove_pid(ROUTEPid *rpid, Bool is_rem)</span>
<span class="lineNum">     255 </span>            : {
<span class="lineNum">     256 </span><span class="lineCov">         16 :         if (!is_rem) {</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :                 gf_list_del_item(rpid-&gt;route-&gt;pids, rpid);</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :                 rpid-&gt;route-&gt;stsid_changed = GF_TRUE;</span>
<span class="lineNum">     259 </span>            :         }
<span class="lineNum">     260 </span><span class="lineCov">         16 :         if (rpid-&gt;rlct != rpid-&gt;route-&gt;rlct_base) {</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :                 gf_list_del_item(rpid-&gt;route-&gt;rlcts, rpid-&gt;rlct);</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :                 gf_free(rpid-&gt;rlct-&gt;ip);</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :                 gf_sk_del(rpid-&gt;rlct-&gt;sock);</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :                 gf_free(rpid-&gt;rlct);</span>
<span class="lineNum">     265 </span>            :         }
<span class="lineNum">     266 </span>            : 
<span class="lineNum">     267 </span><span class="lineCov">         16 :         if (rpid-&gt;init_seg_data) gf_free(rpid-&gt;init_seg_data);</span>
<span class="lineNum">     268 </span><span class="lineCov">         16 :         if (rpid-&gt;init_seg_name) gf_free(rpid-&gt;init_seg_name);</span>
<span class="lineNum">     269 </span><span class="lineCov">         16 :         if (rpid-&gt;hld_child_pl) gf_free(rpid-&gt;hld_child_pl);</span>
<span class="lineNum">     270 </span><span class="lineCov">         16 :         if (rpid-&gt;hld_child_pl_name) gf_free(rpid-&gt;hld_child_pl_name);</span>
<span class="lineNum">     271 </span><span class="lineCov">         16 :         if (rpid-&gt;template) gf_free(rpid-&gt;template);</span>
<span class="lineNum">     272 </span><span class="lineCov">         16 :         if (rpid-&gt;seg_name) gf_free(rpid-&gt;seg_name);</span>
<span class="lineNum">     273 </span>            : 
<span class="lineNum">     274 </span><span class="lineCov">         16 :         if (rpid-&gt;current_pck)</span>
<span class="lineNum">     275 </span><span class="lineCov">          4 :                 gf_filter_pck_unref(rpid-&gt;current_pck);</span>
<span class="lineNum">     276 </span><span class="lineCov">         16 :         gf_free(rpid);</span>
<a name="277"><span class="lineNum">     277 </span><span class="lineCov">         16 : }</span></a>
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span><span class="lineCov">          7 : void routeout_delete_service(ROUTEService *serv)</span>
<span class="lineNum">     280 </span>            : {
<span class="lineNum">     281 </span><span class="lineCov">         30 :         while (gf_list_count(serv-&gt;pids)) {</span>
<span class="lineNum">     282 </span><span class="lineCov">         16 :                 ROUTEPid *rpid = gf_list_pop_back(serv-&gt;pids);</span>
<span class="lineNum">     283 </span><span class="lineCov">         16 :                 routeout_remove_pid(rpid, GF_TRUE);</span>
<span class="lineNum">     284 </span>            :         }
<span class="lineNum">     285 </span><span class="lineCov">          7 :         gf_list_del(serv-&gt;pids);</span>
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span><span class="lineCov">         21 :         while (gf_list_count(serv-&gt;rlcts)) {</span>
<span class="lineNum">     288 </span><span class="lineCov">          7 :                 ROUTELCT *rlct = gf_list_pop_back(serv-&gt;rlcts);</span>
<span class="lineNum">     289 </span><span class="lineCov">          7 :                 gf_sk_del(rlct-&gt;sock);</span>
<span class="lineNum">     290 </span><span class="lineCov">          7 :                 gf_free(rlct-&gt;ip);</span>
<span class="lineNum">     291 </span><span class="lineCov">          7 :                 gf_free(rlct);</span>
<span class="lineNum">     292 </span>            :         }
<span class="lineNum">     293 </span><span class="lineCov">          7 :         gf_list_del(serv-&gt;rlcts);</span>
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span><span class="lineCov">          7 :         if (serv-&gt;manifest_mime) gf_free(serv-&gt;manifest_mime);</span>
<span class="lineNum">     296 </span><span class="lineCov">          7 :         if (serv-&gt;manifest_name) gf_free(serv-&gt;manifest_name);</span>
<span class="lineNum">     297 </span><span class="lineCov">          7 :         if (serv-&gt;manifest_server) gf_free(serv-&gt;manifest_server);</span>
<span class="lineNum">     298 </span><span class="lineCov">          7 :         if (serv-&gt;manifest_url) gf_free(serv-&gt;manifest_url);</span>
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span><span class="lineCov">          7 :         if (serv-&gt;manifest) gf_free(serv-&gt;manifest);</span>
<span class="lineNum">     301 </span><span class="lineCov">          7 :         if (serv-&gt;stsid_bundle) gf_free(serv-&gt;stsid_bundle);</span>
<span class="lineNum">     302 </span><span class="lineCov">          7 :         gf_free(serv);</span>
<a name="303"><span class="lineNum">     303 </span><span class="lineCov">          7 : }</span></a>
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span><span class="lineCov">         44 : static GF_Err routeout_configure_pid(GF_Filter *filter, GF_FilterPid *pid, Bool is_remove)</span>
<span class="lineNum">     306 </span>            : {
<span class="lineNum">     307 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">     308 </span>            :         u32 i;
<span class="lineNum">     309 </span>            :         GF_FilterEvent evt;
<span class="lineNum">     310 </span>            :         ROUTEService *rserv;
<span class="lineNum">     311 </span>            :         u32 manifest_type;
<span class="lineNum">     312 </span>            :         u32 service_id = 0;
<span class="lineNum">     313 </span>            :         u32 pid_dash_mode = 0;
<span class="lineNum">     314 </span><span class="lineCov">         44 :         GF_ROUTEOutCtx *ctx = (GF_ROUTEOutCtx *) gf_filter_get_udta(filter);</span>
<span class="lineNum">     315 </span>            :         ROUTEPid *rpid;
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineCov">         44 :         rpid = gf_filter_pid_get_udta(pid);</span>
<span class="lineNum">     318 </span><span class="lineCov">         44 :         if (is_remove) {</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :                 if (rpid) routeout_remove_pid(rpid, GF_FALSE);</span>
<span class="lineNum">     320 </span>            :                 return GF_OK;
<span class="lineNum">     321 </span>            :         }
<span class="lineNum">     322 </span><span class="lineCov">         44 :         if (! gf_filter_pid_check_caps(pid))</span>
<span class="lineNum">     323 </span>            :                 return GF_FILTER_NOT_SUPPORTED;
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span>            :         //we currently ignore any reconfiguration of the pids
<span class="lineNum">     326 </span><span class="lineCov">         44 :         if (rpid) {</span>
<span class="lineNum">     327 </span>            :                 //any change to a raw file will require reconfiguring S-TSID
<span class="lineNum">     328 </span><span class="lineCov">         28 :                 if (rpid-&gt;raw_file) {</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :                         rpid-&gt;route-&gt;stsid_changed = GF_TRUE;</span>
<span class="lineNum">     330 </span>            :                 }
<span class="lineNum">     331 </span><span class="lineCov">         28 :                 else if (!rpid-&gt;manifest_type) {</span>
<span class="lineNum">     332 </span><span class="lineCov">         24 :                         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_TEMPLATE);</span>
<span class="lineNum">     333 </span><span class="lineCov">         24 :                         if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">     334 </span><span class="lineCov">         24 :                                 if (!rpid-&gt;template || strcmp(rpid-&gt;template, p-&gt;value.string)) {</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :                                         if (rpid-&gt;template) gf_free(rpid-&gt;template);</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :                                         rpid-&gt;template = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                                         rpid-&gt;route-&gt;stsid_changed = GF_TRUE;</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                                         rpid-&gt;use_basename = (strchr(rpid-&gt;template, '/')==NULL) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">     339 </span>            :                                 }
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :                         } else if (rpid-&gt;template) {</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :                                 gf_free(rpid-&gt;template);</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                                 rpid-&gt;template = NULL;</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :                                 rpid-&gt;route-&gt;stsid_changed = GF_TRUE;</span>
<span class="lineNum">     344 </span>            :                         }
<span class="lineNum">     345 </span>            :                 }
<span class="lineNum">     346 </span>            : 
<span class="lineNum">     347 </span>            :                 return GF_OK;
<span class="lineNum">     348 </span>            :         }
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span><span class="lineCov">         16 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_DISABLE_PROGRESSIVE);</span>
<span class="lineNum">     351 </span><span class="lineCov">         16 :         if (p &amp;&amp; p-&gt;value.uint) {</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] Delivering files with progressive download disabled is not possible in ROUTE !\n&quot;));</span>
<span class="lineNum">     353 </span>            :                 return GF_FILTER_NOT_SUPPORTED;
<span class="lineNum">     354 </span>            :         }
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineCov">         16 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_DASH_MODE);</span>
<span class="lineNum">     357 </span><span class="lineCov">         16 :         if (p) pid_dash_mode = p-&gt;value.uint;</span>
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span><span class="lineCov">         16 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_SERVICE_ID);</span>
<span class="lineNum">     360 </span><span class="lineCov">         16 :         if (p) service_id = p-&gt;value.uint;</span>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span>            :         rserv = NULL;
<span class="lineNum">     363 </span><span class="lineCov">         16 :         for (i=0; i&lt;gf_list_count(ctx-&gt;services); i++) {</span>
<span class="lineNum">     364 </span><span class="lineCov">          9 :                 rserv = gf_list_get(ctx-&gt;services, i);</span>
<span class="lineNum">     365 </span><span class="lineCov">          9 :                 if (service_id == rserv-&gt;service_id) break;</span>
<span class="lineNum">     366 </span>            :                 rserv = NULL;
<span class="lineNum">     367 </span>            :         }
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span>            :         manifest_type = 0;
<span class="lineNum">     370 </span><span class="lineCov">         16 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_MIME);</span>
<span class="lineNum">     371 </span><span class="lineCov">         16 :         if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">     372 </span><span class="lineCov">         16 :                 if (strstr(p-&gt;value.string, &quot;dash&quot;)) manifest_type = 1;</span>
<span class="lineNum">     373 </span><span class="lineCov">          9 :                 else if (strstr(p-&gt;value.string, &quot;mpd&quot;)) manifest_type = 1;</span>
<span class="lineNum">     374 </span><span class="lineCov">          9 :                 else if (strstr(p-&gt;value.string, &quot;mpegurl&quot;)) manifest_type = 2;</span>
<span class="lineNum">     375 </span>            :         }
<span class="lineNum">     376 </span>            :         if (!manifest_type) {
<span class="lineNum">     377 </span><span class="lineCov">          9 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_FILE_EXT);</span>
<span class="lineNum">     378 </span><span class="lineCov">          9 :                 if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">     379 </span><span class="lineCov">          9 :                         if (strstr(p-&gt;value.string, &quot;mpd&quot;)) manifest_type = 1;</span>
<span class="lineNum">     380 </span><span class="lineCov">          9 :                         else if (strstr(p-&gt;value.string, &quot;m3u8&quot;)) manifest_type = 2;</span>
<span class="lineNum">     381 </span><span class="lineCov">          9 :                         else if (strstr(p-&gt;value.string, &quot;3gm&quot;)) manifest_type = 1;</span>
<span class="lineNum">     382 </span>            :                 }
<span class="lineNum">     383 </span>            :         }
<span class="lineNum">     384 </span><span class="lineCov">         16 :         if (manifest_type) {</span>
<span class="lineNum">     385 </span><span class="lineCov">          7 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ORIG_STREAM_TYPE);</span>
<span class="lineNum">     386 </span><span class="lineCov">          7 :                 if (!p || (p-&gt;value.uint!=GF_STREAM_FILE)) {</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_ROUTE, (&quot;[ROUTE] Manifest file detected but no dashin filter, file will be uploaded as is !\n&quot;));</span>
<span class="lineNum">     388 </span>            :                         manifest_type = 0;
<span class="lineNum">     389 </span>            :                 }
<span class="lineNum">     390 </span>            :         }
<span class="lineNum">     391 </span>            : 
<span class="lineNum">     392 </span><span class="lineCov">         16 :         if (!rserv) {</span>
<span class="lineNum">     393 </span>            :                 GF_Err e;
<span class="lineNum">     394 </span><span class="lineCov">          7 :                 u32 port = ctx-&gt;first_port;</span>
<span class="lineNum">     395 </span><span class="lineCov">          7 :                 const char *service_ip = ctx-&gt;ip;</span>
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span>            :                 //cannot have 2 manifest pids connecting in route mode
<span class="lineNum">     398 </span><span class="lineCov">          7 :                 if (!ctx-&gt;sock_atsc_lls &amp;&amp; gf_list_count(ctx-&gt;services) &amp;&amp; manifest_type) {</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :                         if (strchr(ctx-&gt;dst, '$')) {</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_ROUTE, (&quot;[ROUTE] Multiple services in route mode, creating a new output filter\n&quot;));</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :                                 return GF_REQUIRES_NEW_INSTANCE;</span>
<span class="lineNum">     402 </span>            :                         }
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] Multiple services in route mode and no URL templating, cannot create new output\n&quot;));</span>
<span class="lineNum">     404 </span>            :                         return GF_FILTER_NOT_SUPPORTED;
<span class="lineNum">     405 </span>            :                 }
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span><span class="lineCov">          7 :                 if (ctx-&gt;sock_atsc_lls) {</span>
<span class="lineNum">     408 </span><span class="lineCov">          2 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_ROUTE_IP);</span>
<span class="lineNum">     409 </span><span class="lineCov">          2 :                         if (p &amp;&amp; p-&gt;value.string) service_ip = p-&gt;value.string;</span>
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span><span class="lineCov">          2 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_ROUTE_PORT);</span>
<span class="lineNum">     412 </span><span class="lineCov">          2 :                         if (p &amp;&amp; p-&gt;value.uint) port = p-&gt;value.uint;</span>
<span class="lineNum">     413 </span><span class="lineCov">          2 :                         else ctx-&gt;first_port++;</span>
<span class="lineNum">     414 </span>            :                 }
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span><span class="lineCov">          7 :                 rserv = routeout_create_service(ctx, service_id, service_ip, port, &amp;e);</span>
<span class="lineNum">     417 </span><span class="lineCov">          7 :                 if (!rserv) return e;</span>
<span class="lineNum">     418 </span><span class="lineCov">          7 :                 rserv-&gt;dash_mode = pid_dash_mode;</span>
<span class="lineNum">     419 </span>            :         }
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineCov">         16 :         if (!rserv-&gt;manifest_type)</span>
<span class="lineNum">     422 </span><span class="lineCov">          7 :                 rserv-&gt;manifest_type = manifest_type;</span>
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineCov">         16 :         if (rserv-&gt;dash_mode != pid_dash_mode){</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] Mix of raw and muxed files should never happen - please report bug !\n&quot;));</span>
<span class="lineNum">     426 </span>            :                 return GF_SERVICE_ERROR;
<span class="lineNum">     427 </span>            :         }
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span><span class="lineCov">         16 :         GF_SAFEALLOC(rpid, ROUTEPid);</span>
<span class="lineNum">     430 </span><span class="lineCov">         16 :         if (!rpid) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     431 </span><span class="lineCov">         16 :         rpid-&gt;route = rserv;</span>
<span class="lineNum">     432 </span><span class="lineCov">         16 :         rpid-&gt;pid = pid;</span>
<span class="lineNum">     433 </span><span class="lineCov">         16 :         rpid-&gt;fmtp = 128;</span>
<span class="lineNum">     434 </span><span class="lineCov">         16 :         rpid-&gt;mode = 1;</span>
<span class="lineNum">     435 </span><span class="lineCov">         16 :         rpid-&gt;tsi = 0;</span>
<span class="lineNum">     436 </span><span class="lineCov">         16 :         rpid-&gt;manifest_type = manifest_type;</span>
<span class="lineNum">     437 </span><span class="lineCov">         16 :         if (manifest_type) {</span>
<span class="lineNum">     438 </span><span class="lineCov">          7 :                 rserv-&gt;creation_time = gf_sys_clock();</span>
<span class="lineNum">     439 </span><span class="lineCov">          7 :                 gf_filter_pid_ignore_blocking(pid, GF_TRUE);</span>
<span class="lineNum">     440 </span>            :         }
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineCov">         16 :         gf_list_add(rserv-&gt;pids, rpid);</span>
<span class="lineNum">     443 </span><span class="lineCov">         16 :         gf_filter_pid_set_udta(pid, rpid);</span>
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineCov">         16 :         rpid-&gt;rlct = rserv-&gt;rlct_base;</span>
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineCov">         16 :         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_BITRATE);</span>
<span class="lineNum">     448 </span><span class="lineCov">         16 :         if (p) rpid-&gt;bitrate = p-&gt;value.uint * (100+ctx-&gt;brinc) / 100;</span>
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span><span class="lineCov">         16 :         rpid-&gt;stream_type = 0;</span>
<span class="lineNum">     451 </span><span class="lineCov">         16 :         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_ORIG_STREAM_TYPE);</span>
<span class="lineNum">     452 </span><span class="lineCov">         16 :         if (!p) {</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :                 if (!rpid-&gt;manifest_type) {</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :                         rpid-&gt;raw_file = GF_TRUE;</span>
<span class="lineNum">     455 </span>            :                 }
<span class="lineNum">     456 </span>            :         } else {
<span class="lineNum">     457 </span><span class="lineCov">         16 :                 rpid-&gt;stream_type = p-&gt;value.uint;</span>
<span class="lineNum">     458 </span>            :         }
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineCov">         16 :         rpid-&gt;bandwidth = 0;</span>
<span class="lineNum">     461 </span><span class="lineCov">         16 :         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_BITRATE);</span>
<span class="lineNum">     462 </span><span class="lineCov">         16 :         if (p) rpid-&gt;bandwidth = p-&gt;value.uint;</span>
<span class="lineNum">     463 </span>            : 
<span class="lineNum">     464 </span><span class="lineCov">         16 :         rpid-&gt;dash_dur.num = 1;</span>
<span class="lineNum">     465 </span><span class="lineCov">         16 :         rpid-&gt;dash_dur.den = 1;</span>
<span class="lineNum">     466 </span><span class="lineCov">         16 :         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_DASH_DUR);</span>
<span class="lineNum">     467 </span><span class="lineCov">         16 :         if (p) rpid-&gt;dash_dur = p-&gt;value.frac;</span>
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span><span class="lineCov">         16 :         if (!rpid-&gt;manifest_type &amp;&amp; !rpid-&gt;raw_file) {</span>
<span class="lineNum">     470 </span><span class="lineCov">          9 :                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_TEMPLATE);</span>
<span class="lineNum">     471 </span><span class="lineCov">          9 :                 if (p &amp;&amp; p-&gt;value.string) rpid-&gt;template = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span>            :                 else {
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_ROUTE, (&quot;[ROUTE] Segment file PID detected but no template assigned, assuming raw file upload!\n&quot;));</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :                         rpid-&gt;raw_file = GF_TRUE;</span>
<span class="lineNum">     476 </span>            :                 }
<span class="lineNum">     477 </span>            :         }
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span><span class="lineCov">         16 :         if (rpid-&gt;raw_file) {</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :                 rpid-&gt;tsi = 1;</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :                 rpid-&gt;current_toi = ctx-&gt;next_raw_file_toi;</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :                 ctx-&gt;next_raw_file_toi ++;</span>
<span class="lineNum">     483 </span>            :         }
<span class="lineNum">     484 </span>            : 
<span class="lineNum">     485 </span><span class="lineCov">         16 :         if (!rpid-&gt;manifest_type &amp;&amp; !rpid-&gt;raw_file) {</span>
<span class="lineNum">     486 </span>            :                 Bool do_split = GF_FALSE;
<span class="lineNum">     487 </span>            : 
<span class="lineNum">     488 </span><span class="lineCov">          9 :                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_TIMESCALE);</span>
<span class="lineNum">     489 </span><span class="lineCov">          9 :                 if (p) rpid-&gt;timescale = p-&gt;value.uint;</span>
<span class="lineNum">     490 </span>            : 
<span class="lineNum">     491 </span><span class="lineCov">          9 :                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PCK_HLS_REF);</span>
<span class="lineNum">     492 </span><span class="lineCov">          9 :                 if (p) rpid-&gt;hls_ref_id = p-&gt;value.longuint;</span>
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span><span class="lineCov">          9 :                 rpid-&gt;tsi = gf_list_find(rserv-&gt;pids, rpid) * 10;</span>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span>            :                 //do we put this on the main LCT of the service or do we split ?
<span class="lineNum">     497 </span><span class="lineCov">          9 :                 if (ctx-&gt;splitlct==LCT_SPLIT_ALL) {</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :                         if (gf_list_count(rserv-&gt;pids)&gt;1)</span>
<span class="lineNum">     499 </span>            :                                 do_split = GF_TRUE;
<span class="lineNum">     500 </span>            :                 }
<span class="lineNum">     501 </span><span class="lineCov">          9 :                 else if (ctx-&gt;splitlct &amp;&amp; rpid-&gt;stream_type) {</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;gf_list_count(rserv-&gt;pids); i++) {</span>
<span class="lineNum">     503 </span>            :                                 u32 astreamtype;
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                                 ROUTEPid *apid = gf_list_get(rserv-&gt;pids, i);</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                                 if (apid-&gt;manifest_type) continue;</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :                                 if (apid == rpid) continue;</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :                                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_ORIG_STREAM_TYPE);</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                                 if (!p) continue;</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :                                 astreamtype = p-&gt;value.uint;</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :                                 if (astreamtype==rpid-&gt;stream_type) {</span>
<span class="lineNum">     511 </span>            :                                         do_split = GF_TRUE;
<span class="lineNum">     512 </span>            :                                         break;
<span class="lineNum">     513 </span>            :                                 }
<span class="lineNum">     514 </span>            :                         }
<span class="lineNum">     515 </span>            :                 }
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :                 if (do_split) {</span>
<span class="lineNum">     517 </span>            :                         GF_Err e;
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :                         rserv-&gt;first_port++;</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :                         ctx-&gt;first_port++;</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                         rpid-&gt;rlct = route_create_lct_channel(ctx, NULL, rserv-&gt;first_port, &amp;e);</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                         if (e) return e;</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :                         if (rpid-&gt;rlct) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :                                 gf_list_add(rserv-&gt;rlcts, rpid-&gt;rlct);</span>
<span class="lineNum">     524 </span>            :                         }
<span class="lineNum">     525 </span>            :                 }
<span class="lineNum">     526 </span>            :         }
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span><span class="lineCov">         16 :         gf_filter_pid_init_play_event(pid, &amp;evt, 0, 1.0, &quot;ROUTEOut&quot;);</span>
<span class="lineNum">     530 </span><span class="lineCov">         16 :         gf_filter_pid_send_event(pid, &amp;evt);</span>
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span><span class="lineCov">         16 :         rserv-&gt;wait_for_inputs = GF_TRUE;</span>
<span class="lineNum">     533 </span>            :         //low-latency mode, consume media segment files as they are received (don't wait for full segment reconstruction)
<span class="lineNum">     534 </span><span class="lineCov">         16 :         if (ctx-&gt;llmode &amp;&amp; !rpid-&gt;manifest_type &amp;&amp; !rpid-&gt;raw_file) {</span>
<span class="lineNum">     535 </span><span class="lineCov">          5 :                 gf_filter_pid_set_framing_mode(pid, GF_FALSE);</span>
<span class="lineNum">     536 </span>            :         } else {
<span class="lineNum">     537 </span><span class="lineCov">         11 :                 gf_filter_pid_set_framing_mode(pid, GF_TRUE);</span>
<span class="lineNum">     538 </span>            :         }
<span class="lineNum">     539 </span>            :         return GF_OK;
<a name="540"><span class="lineNum">     540 </span>            : }</a>
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span><span class="lineCov">         11 : static GF_Err routeout_initialize(GF_Filter *filter)</span>
<span class="lineNum">     543 </span>            : {
<span class="lineNum">     544 </span>            :         char *base_name;
<span class="lineNum">     545 </span>            :         Bool is_atsc = GF_TRUE;
<span class="lineNum">     546 </span>            :         char *ext=NULL;
<span class="lineNum">     547 </span><span class="lineCov">         11 :         GF_ROUTEOutCtx *ctx = (GF_ROUTEOutCtx *) gf_filter_get_udta(filter);</span>
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span><span class="lineCov">         11 :         if (!ctx || !ctx-&gt;dst) return GF_BAD_PARAM;</span>
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineCov">         11 :         if (!strnicmp(ctx-&gt;dst, &quot;route://&quot;, 8)) {</span>
<span class="lineNum">     552 </span>            :                 is_atsc = GF_FALSE;
<span class="lineNum">     553 </span><span class="lineCov">          4 :         } else if (strnicmp(ctx-&gt;dst, &quot;atsc://&quot;, 7))  {</span>
<span class="lineNum">     554 </span>            :                 return GF_NOT_SUPPORTED;
<span class="lineNum">     555 </span>            :         }
<span class="lineNum">     556 </span>            : 
<span class="lineNum">     557 </span><span class="lineCov">         11 :         if (ctx-&gt;ext) {</span>
<span class="lineNum">     558 </span>            :                 ext = ctx-&gt;ext;
<span class="lineNum">     559 </span>            :         } else {
<span class="lineNum">     560 </span><span class="lineCov">         11 :                 if (is_atsc) {</span>
<span class="lineNum">     561 </span><span class="lineCov">          4 :                         base_name = gf_file_basename(ctx-&gt;dst);</span>
<span class="lineNum">     562 </span>            :                 } else {
<span class="lineNum">     563 </span><span class="lineCov">          7 :                         char *sep = strchr(ctx-&gt;dst + 8, '/');</span>
<span class="lineNum">     564 </span><span class="lineCov">          7 :                         base_name = sep ? gf_file_basename(ctx-&gt;dst) : NULL;</span>
<span class="lineNum">     565 </span>            :                 }
<span class="lineNum">     566 </span><span class="lineCov">         11 :                 ext = base_name ? gf_file_ext_start(base_name) : NULL;</span>
<span class="lineNum">     567 </span><span class="lineCov">         11 :                 if (ext) ext++;</span>
<span class="lineNum">     568 </span>            :         }
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span>            : #if 0
<span class="lineNum">     571 </span>            :         if (!ext) {
<span class="lineNum">     572 </span>            :                 GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] Missing destination manifest type, cannot infer format!\n&quot;));
<span class="lineNum">     573 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">     574 </span>            :         }
<span class="lineNum">     575 </span>            : #endif
<span class="lineNum">     576 </span>            : 
<span class="lineNum">     577 </span><span class="lineCov">         11 :         if (is_atsc) {</span>
<span class="lineNum">     578 </span><span class="lineCov">          4 :                 if (!ctx-&gt;ip) return GF_BAD_PARAM;</span>
<span class="lineNum">     579 </span>            :         } else {
<span class="lineNum">     580 </span>            :                 char *sep, *root;
<span class="lineNum">     581 </span><span class="lineCov">          7 :                 sep = strrchr(ctx-&gt;dst+8, ':');</span>
<span class="lineNum">     582 </span><span class="lineCov">          7 :                 if (sep) sep[0] = 0;</span>
<span class="lineNum">     583 </span><span class="lineCov">          7 :                 root = sep ? strchr(sep+1, '/') : NULL;</span>
<span class="lineNum">     584 </span><span class="lineCov">          7 :                 if (root) root[0] = 0;</span>
<span class="lineNum">     585 </span><span class="lineCov">          7 :                 if (ctx-&gt;ip) gf_free(ctx-&gt;ip);</span>
<span class="lineNum">     586 </span><span class="lineCov">          7 :                 ctx-&gt;ip = gf_strdup(ctx-&gt;dst+8);</span>
<span class="lineNum">     587 </span><span class="lineCov">          7 :                 if (sep) {</span>
<span class="lineNum">     588 </span><span class="lineCov">         14 :                         ctx-&gt;first_port = atoi(sep+1);</span>
<span class="lineNum">     589 </span><span class="lineCov">          7 :                         sep[0] = ':';</span>
<span class="lineNum">     590 </span>            :                 }
<span class="lineNum">     591 </span><span class="lineCov">          7 :                 if (root) root[0] = '/';</span>
<span class="lineNum">     592 </span>            :         }
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span><span class="lineCov">         11 :         if (!gf_sk_is_multicast_address(ctx-&gt;ip)) {</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] IP %s is not a multicast address\n&quot;, ctx-&gt;ip));</span>
<span class="lineNum">     596 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">     597 </span>            :         }
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span><span class="lineCov">         11 :         if (ext || ctx-&gt;mime) {</span>
<span class="lineNum">     600 </span>            :                 //static cap, streamtype = file
<span class="lineNum">     601 </span><span class="lineCov">          6 :                 ctx-&gt;in_caps[0].code = GF_PROP_PID_STREAM_TYPE;</span>
<span class="lineNum">     602 </span><span class="lineCov">          6 :                 ctx-&gt;in_caps[0].val = PROP_UINT(GF_STREAM_FILE);</span>
<span class="lineNum">     603 </span><span class="lineCov">          6 :                 ctx-&gt;in_caps[0].flags = GF_CAPS_INPUT_STATIC;</span>
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span><span class="lineCov">          6 :                 if (ctx-&gt;mime) {</span>
<span class="lineNum">     606 </span><span class="lineCov">          4 :                         ctx-&gt;in_caps[1].code = GF_PROP_PID_MIME;</span>
<span class="lineNum">     607 </span><span class="lineCov">          4 :                         ctx-&gt;in_caps[1].val = PROP_NAME( ctx-&gt;mime );</span>
<span class="lineNum">     608 </span><span class="lineCov">          4 :                         ctx-&gt;in_caps[1].flags = GF_CAPS_INPUT;</span>
<span class="lineNum">     609 </span>            :                 } else {
<span class="lineNum">     610 </span><span class="lineCov">          2 :                         strncpy(ctx-&gt;szExt, ext, 9);</span>
<span class="lineNum">     611 </span><span class="lineCov">          2 :                         ctx-&gt;szExt[9] = 0;</span>
<span class="lineNum">     612 </span><span class="lineCov">          2 :                         strlwr(ctx-&gt;szExt);</span>
<span class="lineNum">     613 </span><span class="lineCov">          2 :                         ctx-&gt;in_caps[1].code = GF_PROP_PID_FILE_EXT;</span>
<span class="lineNum">     614 </span><span class="lineCov">          2 :                         ctx-&gt;in_caps[1].val = PROP_NAME( ctx-&gt;szExt );</span>
<span class="lineNum">     615 </span><span class="lineCov">          2 :                         ctx-&gt;in_caps[1].flags = GF_CAPS_INPUT;</span>
<span class="lineNum">     616 </span>            :                 }
<span class="lineNum">     617 </span><span class="lineCov">          6 :                 gf_filter_override_caps(filter, ctx-&gt;in_caps, 2);</span>
<span class="lineNum">     618 </span>            :         }
<span class="lineNum">     619 </span>            : 
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span>            :         /*this is an alias for our main filter, nothing to initialize*/
<span class="lineNum">     622 </span><span class="lineCov">         11 :         if (gf_filter_is_alias(filter)) {</span>
<span class="lineNum">     623 </span>            :                 return GF_OK;
<span class="lineNum">     624 </span>            :         }
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span><span class="lineCov">          7 :         ctx-&gt;services = gf_list_new();</span>
<span class="lineNum">     627 </span>            : 
<span class="lineNum">     628 </span><span class="lineCov">          7 :         if (is_atsc) {</span>
<span class="lineNum">     629 </span><span class="lineCov">          2 :                 ctx-&gt;sock_atsc_lls = gf_sk_new(GF_SOCK_TYPE_UDP);</span>
<span class="lineNum">     630 </span><span class="lineCov">          2 :                 gf_sk_setup_multicast(ctx-&gt;sock_atsc_lls, GF_ATSC_MCAST_ADDR, GF_ATSC_MCAST_PORT, 0, GF_FALSE, ctx-&gt;ifce);</span>
<span class="lineNum">     631 </span>            :         }
<span class="lineNum">     632 </span>            : 
<span class="lineNum">     633 </span><span class="lineCov">          7 :         ctx-&gt;lct_buffer = gf_malloc(sizeof(u8) * ctx-&gt;mtu);</span>
<span class="lineNum">     634 </span><span class="lineCov">          7 :         ctx-&gt;clock_init = gf_sys_clock_high_res();</span>
<span class="lineNum">     635 </span><span class="lineCov">          7 :         ctx-&gt;clock_stats = ctx-&gt;clock_init;</span>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineCov">          7 :         if (!ctx-&gt;carousel) ctx-&gt;carousel = 1000;</span>
<span class="lineNum">     638 </span>            :         //move to microseconds
<span class="lineNum">     639 </span><span class="lineCov">          7 :         ctx-&gt;carousel *= 1000;</span>
<span class="lineNum">     640 </span><span class="lineCov">          7 :         ctx-&gt;next_raw_file_toi = 1;</span>
<span class="lineNum">     641 </span><span class="lineCov">          7 :         return GF_OK;</span>
<a name="642"><span class="lineNum">     642 </span>            : }</a>
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span><span class="lineCov">         11 : static void routeout_finalize(GF_Filter *filter)</span>
<span class="lineNum">     645 </span>            : {
<span class="lineNum">     646 </span>            :         GF_ROUTEOutCtx *ctx;
<span class="lineNum">     647 </span>            :         /*this is an alias for our main filter, nothing to finalize*/
<span class="lineNum">     648 </span><span class="lineCov">         11 :         if (gf_filter_is_alias(filter))</span>
<span class="lineNum">     649 </span>            :                 return;
<span class="lineNum">     650 </span>            : 
<span class="lineNum">     651 </span><span class="lineCov">          7 :         ctx = (GF_ROUTEOutCtx *) gf_filter_get_udta(filter);</span>
<span class="lineNum">     652 </span>            : 
<span class="lineNum">     653 </span><span class="lineCov">         21 :         while (gf_list_count(ctx-&gt;services)) {</span>
<span class="lineNum">     654 </span><span class="lineCov">          7 :                 routeout_delete_service(gf_list_pop_back(ctx-&gt;services));</span>
<span class="lineNum">     655 </span>            :         }
<span class="lineNum">     656 </span><span class="lineCov">          7 :         gf_list_del(ctx-&gt;services);</span>
<span class="lineNum">     657 </span><span class="lineCov">          7 :         if (ctx-&gt;sock_atsc_lls)</span>
<span class="lineNum">     658 </span><span class="lineCov">          2 :                 gf_sk_del(ctx-&gt;sock_atsc_lls);</span>
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span><span class="lineCov">          7 :         if (ctx-&gt;lct_buffer) gf_free(ctx-&gt;lct_buffer);</span>
<span class="lineNum">     661 </span><span class="lineCov">          7 :         if (ctx-&gt;lls_slt_table) gf_free(ctx-&gt;lls_slt_table);</span>
<span class="lineNum">     662 </span><span class="lineCov">          7 :         if (ctx-&gt;lls_time_table) gf_free(ctx-&gt;lls_time_table);</span>
<a name="663"><span class="lineNum">     663 </span>            : }</a>
<span class="lineNum">     664 </span>            : 
<span class="lineNum">     665 </span><span class="lineCov">          9 : char *routeout_strip_base(ROUTEService *serv, char *url)</span>
<span class="lineNum">     666 </span>            : {
<span class="lineNum">     667 </span>            :         u32 len;
<span class="lineNum">     668 </span><span class="lineCov">          9 :         if (!url) return NULL;</span>
<span class="lineNum">     669 </span><span class="lineCov">          9 :         if (!serv-&gt;manifest_server &amp;&amp; !serv-&gt;manifest_url)</span>
<span class="lineNum">     670 </span><span class="lineCov">          4 :                 return gf_strdup(url);</span>
<span class="lineNum">     671 </span>            : 
<span class="lineNum">     672 </span><span class="lineCov">          5 :         len = serv-&gt;manifest_server ? (u32) strlen(serv-&gt;manifest_server) : 0;</span>
<span class="lineNum">     673 </span><span class="lineCov">          4 :         if (!len || !strncmp(url, serv-&gt;manifest_server, len)) {</span>
<span class="lineNum">     674 </span><span class="lineCov">          1 :                 url += len;</span>
<span class="lineNum">     675 </span><span class="lineCov">          1 :                 char *sep = len ? strchr(url, '/') : url;</span>
<span class="lineNum">     676 </span><span class="lineCov">          1 :                 if (sep) {</span>
<span class="lineNum">     677 </span><span class="lineCov">          1 :                         if (len) sep += 1;</span>
<span class="lineNum">     678 </span><span class="lineCov">          1 :                         len = (u32) strlen(serv-&gt;manifest_url);</span>
<span class="lineNum">     679 </span><span class="lineCov">          1 :                         if (!strncmp(sep, serv-&gt;manifest_url, len)) {</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :                                 return gf_strdup(sep + len);</span>
<span class="lineNum">     681 </span>            :                         }
<span class="lineNum">     682 </span>            :                 }
<span class="lineNum">     683 </span>            :         }
<span class="lineNum">     684 </span><span class="lineCov">          5 :         return gf_strdup(url);</span>
<span class="lineNum">     685 </span>            : }
<span class="lineNum">     686 </span>            : 
<a name="687"><span class="lineNum">     687 </span>            : #define MULTIPART_BOUNDARY      &quot;_GPAC_BOUNDARY_ROUTE_.67706163_&quot;</a>
<span class="lineNum">     688 </span>            : #define ROUTE_INIT_TOI  0xFFFFFFFF
<span class="lineNum">     689 </span><span class="lineCov">    6266968 : static GF_Err routeout_check_service_updates(GF_ROUTEOutCtx *ctx, ROUTEService *serv)</span>
<span class="lineNum">     690 </span>            : {
<span class="lineNum">     691 </span>            :         u32 i, j, count;
<span class="lineNum">     692 </span>            :         char temp[1000];
<span class="lineNum">     693 </span><span class="lineCov">    6266968 :         char *payload_text = NULL;</span>
<span class="lineNum">     694 </span>            :         Bool manifest_updated = GF_FALSE;
<span class="lineNum">     695 </span>            :         u32 nb_media=0, nb_media_init=0, nb_raw_files=0;
<span class="lineNum">     696 </span>            : 
<span class="lineNum">     697 </span><span class="lineCov">    6266968 :         count = gf_list_count(serv-&gt;pids);</span>
<span class="lineNum">     698 </span>            :         //check no changes in init segment or in manifests
<span class="lineNum">     699 </span><span class="lineCov">   22373830 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     700 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">     701 </span><span class="lineCov">   16106862 :                 ROUTEPid *rpid = gf_list_get(serv-&gt;pids, i);</span>
<span class="lineNum">     702 </span>            : 
<span class="lineNum">     703 </span>            :                 //raw file, nothing to check
<span class="lineNum">     704 </span><span class="lineCov">   16106862 :                 if (rpid-&gt;raw_file) {</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :                         nb_raw_files++;</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     707 </span>            :                 }
<span class="lineNum">     708 </span>            :                 //media file, check for init segment and hls child manifest
<span class="lineNum">     709 </span><span class="lineCov">   16106862 :                 if (!rpid-&gt;manifest_type) {</span>
<span class="lineNum">     710 </span><span class="lineCov">    9839894 :                         nb_media++;</span>
<span class="lineNum">     711 </span>            :                         while (1) {
<span class="lineNum">     712 </span><span class="lineCov">    9839903 :                                 GF_FilterPacket *pck = gf_filter_pid_get_packet(rpid-&gt;pid);</span>
<span class="lineNum">     713 </span><span class="lineCov">    9839903 :                                 if (!pck) break;</span>
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span><span class="lineCov">    2063386 :                                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_INIT);</span>
<span class="lineNum">     716 </span><span class="lineCov">    2063386 :                                 if (p &amp;&amp; p-&gt;value.boolean) {</span>
<span class="lineNum">     717 </span>            :                                         const u8 *data;
<span class="lineNum">     718 </span>            :                                         u32 len, crc;
<span class="lineNum">     719 </span><span class="lineCov">          9 :                                         data = gf_filter_pck_get_data(pck, &amp;len);</span>
<span class="lineNum">     720 </span><span class="lineCov">          9 :                                         crc = gf_crc_32(data, len);</span>
<span class="lineNum">     721 </span>            :                                         //whenever init seg changes, bump stsid version
<span class="lineNum">     722 </span><span class="lineCov">          9 :                                         if (crc != rpid-&gt;init_seg_crc) {</span>
<span class="lineNum">     723 </span><span class="lineCov">          9 :                                                 if (rpid-&gt;init_seg_data) gf_free(rpid-&gt;init_seg_data);</span>
<span class="lineNum">     724 </span><span class="lineCov">          9 :                                                 rpid-&gt;init_seg_data = gf_malloc(len);</span>
<span class="lineNum">     725 </span><span class="lineCov">          9 :                                                 memcpy(rpid-&gt;init_seg_data, data, len);</span>
<span class="lineNum">     726 </span><span class="lineCov">          9 :                                                 rpid-&gt;init_seg_size = len;</span>
<span class="lineNum">     727 </span><span class="lineCov">          9 :                                                 rpid-&gt;init_seg_crc = crc;</span>
<span class="lineNum">     728 </span><span class="lineCov">          9 :                                                 rpid-&gt;init_seg_sent = GF_FALSE;</span>
<span class="lineNum">     729 </span><span class="lineCov">          9 :                                                 serv-&gt;stsid_changed = GF_TRUE;</span>
<span class="lineNum">     730 </span><span class="lineCov">          9 :                                                 rpid-&gt;current_toi = 0;</span>
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span><span class="lineCov">          9 :                                                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENAME);</span>
<span class="lineNum">     733 </span><span class="lineCov">          9 :                                                 if (!p) p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PCK_FILENAME);</span>
<span class="lineNum">     734 </span><span class="lineCov">          9 :                                                 if (rpid-&gt;init_seg_name) gf_free(rpid-&gt;init_seg_name);</span>
<span class="lineNum">     735 </span><span class="lineCov">          9 :                                                 rpid-&gt;init_seg_name = p ? routeout_strip_base(rpid-&gt;route, p-&gt;value.string) : NULL;</span>
<span class="lineNum">     736 </span>            :                                         }
<span class="lineNum">     737 </span><span class="lineCov">          9 :                                         gf_filter_pid_drop_packet(rpid-&gt;pid);</span>
<span class="lineNum">     738 </span><span class="lineCov">          9 :                                         continue;</span>
<span class="lineNum">     739 </span>            :                                 }
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span>            :                                 break;
<span class="lineNum">     742 </span>            :                         }
<span class="lineNum">     743 </span><span class="lineCov">    9839894 :                         if (rpid-&gt;init_seg_data) {</span>
<span class="lineNum">     744 </span><span class="lineCov">    9839894 :                                 nb_media_init ++;</span>
<span class="lineNum">     745 </span><span class="lineCov">    9839894 :                                 if (serv-&gt;manifest_type==2) {</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :                                         if (!rpid-&gt;hld_child_pl_name)</span>
<span class="lineNum">     747 </span>            :                                                 nb_media_init --;
<span class="lineNum">     748 </span>            :                                 }
<span class="lineNum">     749 </span>            :                         }
<span class="lineNum">     750 </span><span class="lineCov">    9839894 :                         continue;</span>
<span class="lineNum">     751 </span>            :                 }
<span class="lineNum">     752 </span>            :                 //manifest pid, wait for manifest
<span class="lineNum">     753 </span><span class="lineCov">         16 :                 while (1) {</span>
<span class="lineNum">     754 </span>            :                         char szLocManfest[100];
<span class="lineNum">     755 </span>            :                         u32 man_size, man_crc;
<span class="lineNum">     756 </span>            :                         const char *file_name=NULL, *proto;
<span class="lineNum">     757 </span><span class="lineCov">    6266984 :                         GF_FilterPacket *pck = gf_filter_pid_get_packet(rpid-&gt;pid);</span>
<span class="lineNum">     758 </span><span class="lineCov">    6266984 :                         if (!pck) break;</span>
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span><span class="lineCov">         16 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENAME);</span>
<span class="lineNum">     761 </span><span class="lineCov">         16 :                         if (!p) p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_URL);</span>
<span class="lineNum">     762 </span>            : 
<span class="lineNum">     763 </span><span class="lineCov">         16 :                         if (p)</span>
<span class="lineNum">     764 </span><span class="lineCov">         16 :                                 file_name = p-&gt;value.string;</span>
<span class="lineNum">     765 </span>            :                         else
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :                                 file_name = ctx-&gt;dst;</span>
<span class="lineNum">     767 </span>            : 
<span class="lineNum">     768 </span><span class="lineCov">         16 :                         if (file_name) {</span>
<span class="lineNum">     769 </span><span class="lineCov">         16 :                                 proto = strstr(file_name, &quot;://&quot;);</span>
<span class="lineNum">     770 </span><span class="lineCov">         16 :                                 if (proto) {</span>
<span class="lineNum">     771 </span><span class="lineCov">         13 :                                         if (ctx-&gt;sock_atsc_lls) {</span>
<span class="lineNum">     772 </span><span class="lineCov">          8 :                                                 file_name = proto[3] ? proto+3 : NULL;</span>
<span class="lineNum">     773 </span>            :                                         } else {
<span class="lineNum">     774 </span><span class="lineCov">          5 :                                                 file_name = strchr(proto+3, '/');</span>
<span class="lineNum">     775 </span><span class="lineCov">          5 :                                                 if (file_name) file_name ++;</span>
<span class="lineNum">     776 </span>            :                                         }
<span class="lineNum">     777 </span>            :                                 }
<span class="lineNum">     778 </span>            :                         }
<span class="lineNum">     779 </span>            : 
<span class="lineNum">     780 </span><span class="lineCov">          8 :                         if (!file_name) {</span>
<span class="lineNum">     781 </span><span class="lineCov">          8 :                                 snprintf(szLocManfest, 100, &quot;manifest.%s&quot;, (serv-&gt;manifest_type==2) ? &quot;m3u8&quot; : &quot;mpd&quot;);</span>
<span class="lineNum">     782 </span>            :                                 file_name = szLocManfest;
<span class="lineNum">     783 </span><span class="lineCov">          8 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_ROUTE, (&quot;[ROUTE] Cannot guess manifest name, assuming %s\n&quot;, file_name));</span>
<span class="lineNum">     784 </span>            :                         }
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span>            :                         //child subplaylist
<span class="lineNum">     787 </span><span class="lineCov">         16 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_HLS_REF);</span>
<span class="lineNum">     788 </span><span class="lineCov">         16 :                         if (p &amp;&amp; p-&gt;value.uint) {</span>
<span class="lineNum">     789 </span>            :                                 u32 k;
<span class="lineNum">     790 </span>            :                                 ROUTEPid *media_pid = NULL;
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :                                 for (k=0; k&lt;count; k++) {</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :                                         media_pid = gf_list_get(serv-&gt;pids, k);</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :                                         if (media_pid-&gt;hls_ref_id == p-&gt;value.longuint)</span>
<span class="lineNum">     794 </span>            :                                                 break;
<span class="lineNum">     795 </span>            :                                         media_pid = NULL;
<span class="lineNum">     796 </span>            :                                 }
<span class="lineNum">     797 </span>            :                                 //not yet available - happens when loading an existing m3u8 session
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :                                 if (!media_pid)</span>
<span class="lineNum">     799 </span>            :                                         break;
<span class="lineNum">     800 </span>            : 
<span class="lineNum">     801 </span>            :                                 const u8 *data;
<span class="lineNum">     802 </span>            :                                 u32 len, crc;
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :                                 data = gf_filter_pck_get_data(pck, &amp;len);</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :                                 crc = gf_crc_32(data, len);</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :                                 if (crc != media_pid-&gt;hld_child_pl_crc) {</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :                                         if (media_pid-&gt;hld_child_pl) gf_free(media_pid-&gt;hld_child_pl);</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :                                         media_pid-&gt;hld_child_pl = gf_malloc(len+1);</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :                                         memcpy(media_pid-&gt;hld_child_pl, data, len);</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :                                         media_pid-&gt;hld_child_pl[len] = 0;</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :                                         media_pid-&gt;hld_child_pl_crc = crc;</span>
<span class="lineNum">     811 </span>            : 
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :                                         if (!media_pid-&gt;hld_child_pl_name || strcmp(media_pid-&gt;hld_child_pl_name, file_name)) {</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :                                                 if (media_pid-&gt;hld_child_pl_name) gf_free(media_pid-&gt;init_seg_name);</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :                                                 media_pid-&gt;hld_child_pl_name = routeout_strip_base(rpid-&gt;route, (char *)file_name);</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :                                                 serv-&gt;stsid_changed = GF_TRUE;</span>
<span class="lineNum">     816 </span>            :                                         }
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :                                         media_pid-&gt;update_hls_child_pl = GF_TRUE;</span>
<span class="lineNum">     818 </span>            :                                 }
<span class="lineNum">     819 </span>            :                         } else {
<span class="lineNum">     820 </span><span class="lineCov">         16 :                                 const u8 *man_data = gf_filter_pck_get_data(pck, &amp;man_size);</span>
<span class="lineNum">     821 </span><span class="lineCov">         16 :                                 man_crc = gf_crc_32(man_data, man_size);</span>
<span class="lineNum">     822 </span><span class="lineCov">         16 :                                 if (man_crc != serv-&gt;manifest_crc) {</span>
<span class="lineNum">     823 </span><span class="lineCov">         16 :                                         serv-&gt;manifest_crc = man_crc;</span>
<span class="lineNum">     824 </span><span class="lineCov">         16 :                                         if (serv-&gt;manifest) gf_free(serv-&gt;manifest);</span>
<span class="lineNum">     825 </span><span class="lineCov">         16 :                                         serv-&gt;manifest = gf_malloc(man_size+1);</span>
<span class="lineNum">     826 </span><span class="lineCov">         16 :                                         memcpy(serv-&gt;manifest, man_data, man_size);</span>
<span class="lineNum">     827 </span><span class="lineCov">         16 :                                         serv-&gt;manifest[man_size] = 0;</span>
<span class="lineNum">     828 </span><span class="lineCov">         16 :                                         serv-&gt;manifest_version++;</span>
<span class="lineNum">     829 </span><span class="lineCov">         16 :                                         if (serv-&gt;manifest_name) {</span>
<span class="lineNum">     830 </span><span class="lineCov">          9 :                                                 if (strcmp(serv-&gt;manifest_name, file_name)) serv-&gt;stsid_changed = GF_TRUE;</span>
<span class="lineNum">     831 </span><span class="lineCov">          9 :                                                 gf_free(serv-&gt;manifest_name);</span>
<span class="lineNum">     832 </span>            :                                         }
<span class="lineNum">     833 </span><span class="lineCov">         16 :                                         serv-&gt;manifest_name = gf_strdup(file_name);</span>
<span class="lineNum">     834 </span>            :                                         manifest_updated = GF_TRUE;
<span class="lineNum">     835 </span>            : 
<span class="lineNum">     836 </span><span class="lineCov">         16 :                                         if (serv-&gt;manifest_server) gf_free(serv-&gt;manifest_server);</span>
<span class="lineNum">     837 </span><span class="lineCov">         16 :                                         if (serv-&gt;manifest_url) gf_free(serv-&gt;manifest_url);</span>
<span class="lineNum">     838 </span><span class="lineCov">         16 :                                         serv-&gt;manifest_server = serv-&gt;manifest_url = NULL;</span>
<span class="lineNum">     839 </span>            : 
<span class="lineNum">     840 </span><span class="lineCov">         16 :                                         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_URL);</span>
<span class="lineNum">     841 </span><span class="lineCov">         16 :                                         serv-&gt;manifest_url = p ? gf_strdup(p-&gt;value.string) : NULL;</span>
<span class="lineNum">     842 </span><span class="lineCov">         16 :                                         if (serv-&gt;manifest_url) {</span>
<span class="lineNum">     843 </span><span class="lineCov">         16 :                                                 char *sep = strstr(serv-&gt;manifest_url, file_name);</span>
<span class="lineNum">     844 </span><span class="lineCov">         16 :                                                 if (sep) sep[0] = 0;</span>
<span class="lineNum">     845 </span><span class="lineCov">         16 :                                                 sep = strstr(serv-&gt;manifest_url, &quot;://&quot;);</span>
<span class="lineNum">     846 </span><span class="lineCov">         16 :                                                 if (sep) sep = strchr(sep + 3, '/');</span>
<span class="lineNum">     847 </span><span class="lineCov">         16 :                                                 if (sep) {</span>
<span class="lineNum">     848 </span><span class="lineCov">          7 :                                                         serv-&gt;manifest_server = serv-&gt;manifest_url;</span>
<span class="lineNum">     849 </span><span class="lineCov">          7 :                                                         serv-&gt;manifest_url = gf_strdup(sep+1);</span>
<span class="lineNum">     850 </span><span class="lineCov">          7 :                                                         sep[0] = 0;</span>
<span class="lineNum">     851 </span><span class="lineCov">          7 :                                                         sep = strchr(serv-&gt;manifest_server + 8, ':');</span>
<span class="lineNum">     852 </span><span class="lineCov">          7 :                                                         if (sep) sep[0] = 0;</span>
<span class="lineNum">     853 </span>            :                                                 }
<span class="lineNum">     854 </span>            :                                         }
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span>            : 
<span class="lineNum">     857 </span><span class="lineCov">         16 :                                         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_MIME);</span>
<span class="lineNum">     858 </span><span class="lineCov">         16 :                                         if (p) {</span>
<span class="lineNum">     859 </span><span class="lineCov">         16 :                                                 if (serv-&gt;manifest_mime) gf_free(serv-&gt;manifest_mime);</span>
<span class="lineNum">     860 </span><span class="lineCov">         16 :                                                 serv-&gt;manifest_mime = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">     861 </span>            :                                         }
<span class="lineNum">     862 </span>            :                                 }
<span class="lineNum">     863 </span>            :                         }
<span class="lineNum">     864 </span><span class="lineCov">         16 :                         gf_filter_pid_drop_packet(rpid-&gt;pid);</span>
<span class="lineNum">     865 </span>            :                 }
<span class="lineNum">     866 </span>            :         }
<span class="lineNum">     867 </span>            :         //not ready, waiting for init
<span class="lineNum">     868 </span><span class="lineCov">    6266968 :         if ((nb_media+nb_raw_files==0) || (nb_media_init&lt;nb_media) || (serv-&gt;manifest &amp;&amp; !nb_media)) {</span>
<span class="lineNum">     869 </span><span class="lineCov">          8 :                 u32 now = gf_sys_clock() - serv-&gt;creation_time;</span>
<span class="lineNum">     870 </span><span class="lineCov">          8 :                 if (now &gt; 5000) {</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] No media PIDs found for HAS service after %d ms, aborting !\n&quot;, now));</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :                         serv-&gt;is_done = GF_TRUE;</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :                         return GF_SERVICE_ERROR;</span>
<span class="lineNum">     874 </span>            :                 }
<span class="lineNum">     875 </span>            :                 return GF_OK;
<span class="lineNum">     876 </span>            :         }
<span class="lineNum">     877 </span>            : 
<span class="lineNum">     878 </span>            :         //not ready, waiting for manifest
<span class="lineNum">     879 </span><span class="lineCov">    6266960 :         if (!serv-&gt;manifest &amp;&amp; !nb_raw_files) {</span>
<span class="lineNum">     880 </span>            :                 return GF_OK;
<span class="lineNum">     881 </span>            :         }
<span class="lineNum">     882 </span>            :         //already setup and no changes
<span class="lineNum">     883 </span><span class="lineCov">    6266956 :         else if (!serv-&gt;wait_for_inputs) {</span>
<span class="lineNum">     884 </span><span class="lineCov">    6266948 :                 if (!manifest_updated &amp;&amp; !serv-&gt;stsid_changed)</span>
<span class="lineNum">     885 </span>            :                         return GF_OK;
<span class="lineNum">     886 </span>            :         }
<span class="lineNum">     887 </span><span class="lineCov">         17 :         if (serv-&gt;wait_for_inputs) {</span>
<span class="lineNum">     888 </span><span class="lineCov">          8 :                 if (!serv-&gt;manifest) {</span>
<span class="lineNum">     889 </span>            :                         assert(nb_raw_files);
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :                         serv-&gt;stsid_changed = GF_TRUE;</span>
<span class="lineNum">     891 </span>            :                 }
<span class="lineNum">     892 </span><span class="lineCov">          8 :                 serv-&gt;wait_for_inputs = GF_FALSE;</span>
<span class="lineNum">     893 </span>            :         }
<span class="lineNum">     894 </span>            : 
<span class="lineNum">     895 </span><span class="lineCov">         17 :         if (serv-&gt;stsid_changed) {</span>
<span class="lineNum">     896 </span><span class="lineCov">          8 :                 serv-&gt;stsid_version++;</span>
<span class="lineNum">     897 </span>            : 
<span class="lineNum">     898 </span><span class="lineCov">         26 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     899 </span><span class="lineCov">         18 :                         ROUTEPid *rpid = gf_list_get(serv-&gt;pids, i);</span>
<span class="lineNum">     900 </span><span class="lineCov">         18 :                         if (rpid-&gt;manifest_type) continue;</span>
<span class="lineNum">     901 </span><span class="lineCov">         10 :                         rpid-&gt;clock_at_first_pck = 0;</span>
<span class="lineNum">     902 </span>            :                 }
<span class="lineNum">     903 </span>            :         }
<span class="lineNum">     904 </span>            : 
<span class="lineNum">     905 </span>            :         //ATSC3: mbms enveloppe, service description, astcROUTE bundle
<span class="lineNum">     906 </span><span class="lineCov">         17 :         if (ctx-&gt;sock_atsc_lls) {</span>
<span class="lineNum">     907 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">     908 </span>            :                 char *service_name;
<span class="lineNum">     909 </span>            :                 ROUTEPid *rpid;
<span class="lineNum">     910 </span><span class="lineCov">          8 :                 u32 service_id = serv-&gt;service_id;</span>
<span class="lineNum">     911 </span><span class="lineCov">          8 :                 if (!service_id) {</span>
<span class="lineNum">     912 </span>            :                         service_id = 1;
<span class="lineNum">     913 </span>            :                 }
<span class="lineNum">     914 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, &quot;Content-Type: multipart/related; type=\&quot;application/mbms-envelope+xml\&quot;; boundary=\&quot;&quot;MULTIPART_BOUNDARY&quot;\&quot;\r\n\r\n&quot;, NULL);</span>
<span class="lineNum">     915 </span>            : 
<span class="lineNum">     916 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, &quot;--&quot;MULTIPART_BOUNDARY&quot;\r\nContent-Type: application/mbms-envelope+xml\r\nContent-Location: envelope.xml\r\n\r\n&quot;, NULL);</span>
<span class="lineNum">     917 </span>            : 
<span class="lineNum">     918 </span>            :                 //dump usd first, then S-TSID then manifest
<span class="lineNum">     919 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text,</span>
<span class="lineNum">     920 </span>            :                         &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;
<span class="lineNum">     921 </span>            :                         &quot;&lt;metadataEnvelope xmlns=\&quot;urn:3gpp:metadata:2005:MBMS:envelope\&quot;&gt;\n&quot;
<span class="lineNum">     922 </span>            :                         &quot; &lt;item metadataURI=\&quot;usbd.xml\&quot; version=\&quot;&quot;, NULL);
<span class="lineNum">     923 </span><span class="lineCov">          8 :                 snprintf(temp, 100, &quot;%d&quot;, serv-&gt;stsid_version);</span>
<span class="lineNum">     924 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">     925 </span>            : 
<span class="lineNum">     926 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, &quot;\&quot; contentType=\&quot;&quot;, NULL);</span>
<span class="lineNum">     927 </span><span class="lineCov">          8 :                 if (ctx-&gt;korean)</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;payload_text, &quot;application/mbms-user-service-description+xml&quot;, NULL);</span>
<span class="lineNum">     929 </span>            :                 else
<span class="lineNum">     930 </span><span class="lineCov">          8 :                         gf_dynstrcat(&amp;payload_text, &quot;application/route-usd+xml&quot;, NULL);</span>
<span class="lineNum">     931 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, &quot;\&quot;/&gt;\n&quot;, NULL);</span>
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text,</span>
<span class="lineNum">     934 </span>            :                         &quot; &lt;item metadataURI=\&quot;stsid.xml\&quot; version=\&quot;&quot;, NULL);
<span class="lineNum">     935 </span><span class="lineCov">          8 :                 snprintf(temp, 100, &quot;%d&quot;, serv-&gt;stsid_version);</span>
<span class="lineNum">     936 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, &quot;\&quot; contentType=\&quot;&quot;, NULL);</span>
<span class="lineNum">     939 </span><span class="lineCov">          8 :                 if (ctx-&gt;korean)</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;payload_text, &quot;application/s-tsid&quot;, NULL);</span>
<span class="lineNum">     941 </span>            :                 else
<span class="lineNum">     942 </span><span class="lineCov">          8 :                         gf_dynstrcat(&amp;payload_text, &quot;application/route-s-tsid+xml&quot;, NULL);</span>
<span class="lineNum">     943 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, &quot;\&quot;/&gt;\n&quot;, NULL);</span>
<span class="lineNum">     944 </span>            : 
<span class="lineNum">     945 </span>            : 
<span class="lineNum">     946 </span><span class="lineCov">          8 :                 if (serv-&gt;manifest) {</span>
<span class="lineNum">     947 </span><span class="lineCov">          8 :                         snprintf(temp, 1000, &quot; &lt;item metadataURI=\&quot;%s\&quot; version=\&quot;%d\&quot; contentType=\&quot;%s\&quot;/&gt;\n&quot;, serv-&gt;manifest_name, serv-&gt;manifest_version, serv-&gt;manifest_mime);</span>
<span class="lineNum">     948 </span><span class="lineCov">          8 :                         gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">     949 </span>            :                 }
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, &quot;&lt;/metadataEnvelope&gt;\n\r\n&quot;, NULL);</span>
<span class="lineNum">     952 </span>            : 
<span class="lineNum">     953 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, &quot;--&quot;MULTIPART_BOUNDARY&quot;\r\nContent-Type: &quot;, NULL);</span>
<span class="lineNum">     954 </span><span class="lineCov">          8 :                 if (ctx-&gt;korean)</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;payload_text, &quot;application/mbms-user-service-description+xml&quot;, NULL);</span>
<span class="lineNum">     956 </span>            :                 else
<span class="lineNum">     957 </span><span class="lineCov">          8 :                         gf_dynstrcat(&amp;payload_text, &quot;application/route-usd+xml&quot;, NULL);</span>
<span class="lineNum">     958 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, &quot;\r\nContent-Location: usbd.xml\r\n\r\n&quot;, NULL);</span>
<span class="lineNum">     959 </span>            : 
<span class="lineNum">     960 </span><span class="lineCov">          8 :                 rpid = gf_list_get(serv-&gt;pids, 0);</span>
<span class="lineNum">     961 </span><span class="lineCov">          8 :                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_SERVICE_NAME);</span>
<span class="lineNum">     962 </span><span class="lineCov">          8 :                 if (p &amp;&amp; p-&gt;value.string)</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :                         service_name = p-&gt;value.string;</span>
<span class="lineNum">     964 </span>            :                 else
<span class="lineNum">     965 </span>            :                         service_name = &quot;GPAC TV&quot;;
<span class="lineNum">     966 </span>            : 
<span class="lineNum">     967 </span>            :                 snprintf(temp, 1000, &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;
<span class="lineNum">     968 </span>            :                                 &quot;&lt;BundleDescriptionROUTE xmlns=\&quot;tag:atsc.org,2016:XMLSchemas/ATSC3/Delivery/ROUTEUSD/1.0/\&quot;&gt;\n&quot;
<span class="lineNum">     969 </span>            :                                 &quot; &lt;UserServiceDescription serviceId=\&quot;%d\&quot;&gt;\n&quot;
<span class="lineNum">     970 </span>            :                                 &quot;  &lt;Name lang=\&quot;eng\&quot;&gt;%s&lt;/Name&gt;\n&quot;
<span class="lineNum">     971 </span>            :                                 &quot;  &lt;DeliveryMethod&gt;\n&quot;
<span class="lineNum">     972 </span>            :                                 &quot;   &lt;BroadcastAppService&gt;\n&quot;, service_id, service_name);
<span class="lineNum">     973 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">     974 </span>            : 
<span class="lineNum">     975 </span><span class="lineCov">         24 :                 for (i=0;i&lt;count; i++) {</span>
<span class="lineNum">     976 </span><span class="lineCov">         16 :                         rpid = gf_list_get(serv-&gt;pids, i);</span>
<span class="lineNum">     977 </span><span class="lineCov">         16 :                         if (rpid-&gt;manifest_type) continue;</span>
<span class="lineNum">     978 </span>            :                         //set template
<span class="lineNum">     979 </span><span class="lineCov">          8 :                         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_TEMPLATE);</span>
<span class="lineNum">     980 </span><span class="lineCov">          8 :                         if (p) {</span>
<span class="lineNum">     981 </span><span class="lineCov">          8 :                                 char *tpl = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">     982 </span><span class="lineCov">          8 :                                 char *sep = strchr(tpl, '$');</span>
<span class="lineNum">     983 </span><span class="lineCov">          8 :                                 if (sep) sep[0] = 0;</span>
<span class="lineNum">     984 </span><span class="lineCov">          8 :                                 if (!strstr(payload_text, tpl)) {</span>
<span class="lineNum">     985 </span><span class="lineCov">          8 :                                         gf_dynstrcat(&amp;payload_text, &quot;    &lt;BasePattern&gt;&quot;, NULL);</span>
<span class="lineNum">     986 </span><span class="lineCov">          8 :                                         gf_dynstrcat(&amp;payload_text, tpl, NULL);</span>
<span class="lineNum">     987 </span><span class="lineCov">          8 :                                         gf_dynstrcat(&amp;payload_text, &quot;&lt;/BasePattern&gt;\n&quot;, NULL);</span>
<span class="lineNum">     988 </span>            :                                 }
<span class="lineNum">     989 </span><span class="lineCov">          8 :                                 gf_free(tpl);</span>
<span class="lineNum">     990 </span>            :                         }
<span class="lineNum">     991 </span>            :                 }
<span class="lineNum">     992 </span>            : 
<span class="lineNum">     993 </span><span class="lineCov">          8 :                 gf_dynstrcat(&amp;payload_text, &quot;   &lt;/BroadcastAppService&gt;\n&quot;</span>
<span class="lineNum">     994 </span>            :                                 &quot;  &lt;/DeliveryMethod&gt;\n&quot;
<span class="lineNum">     995 </span>            :                                 &quot; &lt;/UserServiceDescription&gt;\n&quot;
<span class="lineNum">     996 </span>            :                                 &quot;&lt;/BundleDescriptionROUTE&gt;\n\r\n&quot;, NULL);
<span class="lineNum">     997 </span>            :         }
<span class="lineNum">     998 </span>            :         //ROUTE: only inject manifest and S-TSID
<span class="lineNum">     999 </span>            :         else {
<span class="lineNum">    1000 </span><span class="lineCov">          9 :                 gf_dynstrcat(&amp;payload_text, &quot;Content-Type: multipart/related; type=\&quot;&quot;, NULL);</span>
<span class="lineNum">    1001 </span><span class="lineCov">          9 :                 if (serv-&gt;manifest) {</span>
<span class="lineNum">    1002 </span><span class="lineCov">          9 :                         gf_dynstrcat(&amp;payload_text, serv-&gt;manifest_mime, NULL);</span>
<span class="lineNum">    1003 </span>            :                 }
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :                 else if (ctx-&gt;korean)</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;payload_text, &quot;application/s-tsid&quot;, NULL);</span>
<span class="lineNum">    1006 </span>            :                 else
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;payload_text, &quot;application/route-s-tsid+xml&quot;, NULL);</span>
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span><span class="lineCov">          9 :                 gf_dynstrcat(&amp;payload_text, &quot;\&quot;; boundary=\&quot;&quot;MULTIPART_BOUNDARY&quot;\&quot;\r\n\r\n&quot;, NULL);</span>
<span class="lineNum">    1010 </span>            :         }
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span><span class="lineCov">         17 :         if (serv-&gt;manifest) {</span>
<span class="lineNum">    1013 </span><span class="lineCov">         17 :                 gf_dynstrcat(&amp;payload_text, &quot;--&quot;MULTIPART_BOUNDARY&quot;\r\nContent-Type: &quot;, NULL);</span>
<span class="lineNum">    1014 </span><span class="lineCov">         17 :                 gf_dynstrcat(&amp;payload_text, serv-&gt;manifest_mime, NULL);</span>
<span class="lineNum">    1015 </span><span class="lineCov">         17 :                 gf_dynstrcat(&amp;payload_text, &quot;\r\nContent-Location: &quot;, NULL);</span>
<span class="lineNum">    1016 </span><span class="lineCov">         17 :                 gf_dynstrcat(&amp;payload_text, serv-&gt;manifest_name, NULL);</span>
<span class="lineNum">    1017 </span><span class="lineCov">         17 :                 gf_dynstrcat(&amp;payload_text, &quot;\r\n\r\n&quot;, NULL);</span>
<span class="lineNum">    1018 </span><span class="lineCov">         17 :                 gf_dynstrcat(&amp;payload_text, serv-&gt;manifest, NULL);</span>
<span class="lineNum">    1019 </span><span class="lineCov">         17 :                 gf_dynstrcat(&amp;payload_text, &quot;\r\n\r\n&quot;, NULL);</span>
<span class="lineNum">    1020 </span>            :         }
<span class="lineNum">    1021 </span>            : 
<span class="lineNum">    1022 </span><span class="lineCov">         17 :         gf_dynstrcat(&amp;payload_text, &quot;--&quot;MULTIPART_BOUNDARY&quot;\r\nContent-Type: &quot;, NULL);</span>
<span class="lineNum">    1023 </span><span class="lineCov">         17 :         if (ctx-&gt;korean)</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :                 gf_dynstrcat(&amp;payload_text, &quot;application/s-tsid&quot;, NULL);</span>
<span class="lineNum">    1025 </span>            :         else
<span class="lineNum">    1026 </span><span class="lineCov">         17 :                 gf_dynstrcat(&amp;payload_text, &quot;application/route-s-tsid+xml&quot;, NULL);</span>
<span class="lineNum">    1027 </span><span class="lineCov">         17 :         gf_dynstrcat(&amp;payload_text, &quot;\r\nContent-Location: stsid.xml\r\n\r\n&quot;, NULL);</span>
<span class="lineNum">    1028 </span>            : 
<span class="lineNum">    1029 </span><span class="lineCov">         17 :         gf_dynstrcat(&amp;payload_text, &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;</span>
<span class="lineNum">    1030 </span>            :                 &quot;&lt;S-TSID xmlns=\&quot;tag:atsc.org,2016:XMLSchemas/ATSC3/Delivery/S-TSID/1.0/\&quot; xmlns:afdt=\&quot;tag:atsc.org,2016:XMLSchemas/ATSC3/Delivery/ATSC-FDT/1.0/\&quot; xmlns:fdt=\&quot;urn:ietf:params:xml:ns:fdt\&quot;&gt;\n&quot;, NULL);
<span class="lineNum">    1031 </span>            : 
<span class="lineNum">    1032 </span><span class="lineCov">         34 :         for (j=0; j&lt;gf_list_count(serv-&gt;rlcts); j++) {</span>
<span class="lineNum">    1033 </span><span class="lineCov">         17 :                 ROUTELCT *rlct = gf_list_get(serv-&gt;rlcts, j);</span>
<span class="lineNum">    1034 </span>            : 
<span class="lineNum">    1035 </span>            :                 const char *src_ip;
<span class="lineNum">    1036 </span>            :                 char szIP[GF_MAX_IP_NAME_LEN];
<span class="lineNum">    1037 </span><span class="lineCov">         17 :                 src_ip = ctx-&gt;ifce;</span>
<span class="lineNum">    1038 </span><span class="lineCov">         17 :                 if (!src_ip) {</span>
<span class="lineNum">    1039 </span><span class="lineCov">         17 :                         gf_sk_get_local_ip(rlct-&gt;sock, szIP);</span>
<span class="lineNum">    1040 </span>            :                         src_ip = szIP;
<span class="lineNum">    1041 </span>            :                 }
<span class="lineNum">    1042 </span>            : 
<span class="lineNum">    1043 </span><span class="lineCov">         17 :                 snprintf(temp, 1000, &quot; &lt;RS dIpAddr=\&quot;%s\&quot; dPort=\&quot;%d\&quot; sIpAddr=\&quot;%s\&quot;&gt;\n&quot;, rlct-&gt;ip, rlct-&gt;port, src_ip);</span>
<span class="lineNum">    1044 </span><span class="lineCov">         17 :                 gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">    1045 </span>            : 
<span class="lineNum">    1046 </span><span class="lineCov">         53 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1047 </span>            :                         const GF_PropertyValue *p;
<span class="lineNum">    1048 </span><span class="lineCov">         36 :                         ROUTEPid *rpid = gf_list_get(serv-&gt;pids, i);</span>
<span class="lineNum">    1049 </span><span class="lineCov">         36 :                         if (rpid-&gt;manifest_type) continue;</span>
<span class="lineNum">    1050 </span><span class="lineCov">         19 :                         if (rpid-&gt;rlct != rlct) continue;</span>
<span class="lineNum">    1051 </span>            : 
<span class="lineNum">    1052 </span><span class="lineCov">         19 :                         if (rpid-&gt;bandwidth) {</span>
<span class="lineNum">    1053 </span><span class="lineCov">          6 :                                 u32 kbps = rpid-&gt;bandwidth / 1000;</span>
<span class="lineNum">    1054 </span><span class="lineCov">          6 :                                 kbps *= 110;</span>
<span class="lineNum">    1055 </span><span class="lineCov">          6 :                                 kbps /= 100;</span>
<span class="lineNum">    1056 </span><span class="lineCov">          6 :                                 snprintf(temp, 100, &quot;  &lt;LS tsi=\&quot;%d\&quot; bw=\&quot;%d\&quot;&gt;\n&quot;, rpid-&gt;tsi, kbps);</span>
<span class="lineNum">    1057 </span>            :                         } else {
<span class="lineNum">    1058 </span><span class="lineCov">         13 :                                 snprintf(temp, 100, &quot;  &lt;LS tsi=\&quot;%d\&quot;&gt;\n&quot;, rpid-&gt;tsi);</span>
<span class="lineNum">    1059 </span>            :                         }
<span class="lineNum">    1060 </span><span class="lineCov">         19 :                         gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">    1061 </span>            : 
<span class="lineNum">    1062 </span><span class="lineCov">         19 :                         if (serv-&gt;manifest) {</span>
<span class="lineNum">    1063 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, &quot;   &lt;SrcFlow rt=\&quot;true\&quot;&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1064 </span>            :                         } else {
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;payload_text, &quot;   &lt;SrcFlow rt=\&quot;false\&quot;&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1066 </span>            :                         }
<span class="lineNum">    1067 </span>            : 
<span class="lineNum">    1068 </span><span class="lineCov">         19 :                         if (ctx-&gt;korean) {</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;payload_text, &quot;    &lt;EFDT version=\&quot;0\&quot;&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1070 </span>            :                         } else {
<span class="lineNum">    1071 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, &quot;    &lt;EFDT&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1072 </span>            :                         }
<span class="lineNum">    1073 </span>            : 
<span class="lineNum">    1074 </span><span class="lineCov">         19 :                         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_TEMPLATE);</span>
<span class="lineNum">    1075 </span><span class="lineCov">         19 :                         if (p) {</span>
<span class="lineNum">    1076 </span>            :                                 char *sep;
<span class="lineNum">    1077 </span><span class="lineCov">         19 :                                 strcpy(temp, p-&gt;value.string);</span>
<span class="lineNum">    1078 </span><span class="lineCov">         19 :                                 sep = strstr(temp, &quot;$Number&quot;);</span>
<span class="lineNum">    1079 </span><span class="lineCov">         19 :                                 if (sep) {</span>
<span class="lineNum">    1080 </span><span class="lineCov">         19 :                                         sep[0] = 0;</span>
<span class="lineNum">    1081 </span>            :                                         strcat(temp, &quot;$TOI&quot;);
<span class="lineNum">    1082 </span><span class="lineCov">         19 :                                         sep = strstr(p-&gt;value.string, &quot;$Number&quot;);</span>
<span class="lineNum">    1083 </span><span class="lineCov">         19 :                                         strcat(temp, sep + 7);</span>
<span class="lineNum">    1084 </span>            :                                 }
<span class="lineNum">    1085 </span>            :                         }
<span class="lineNum">    1086 </span>            : 
<span class="lineNum">    1087 </span><span class="lineCov">         19 :                         if (ctx-&gt;korean) {</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :                                 if (p) {</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :                                         gf_dynstrcat(&amp;payload_text, &quot;     &lt;FileTemplate&gt;&quot;, NULL);</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :                                         gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :                                         gf_dynstrcat(&amp;payload_text, &quot;&lt;/FileTemplate&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1092 </span>            :                                 }
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;payload_text, &quot;     &lt;FDTParameters&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1094 </span>            :                         } else {
<span class="lineNum">    1095 </span>            :                                 u32 max_size = 0;
<span class="lineNum">    1096 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, &quot;     &lt;FDT-Instance afdt:efdtVersion=\&quot;0\&quot;&quot;, NULL);</span>
<span class="lineNum">    1097 </span><span class="lineCov">         19 :                                 if (p) {</span>
<span class="lineNum">    1098 </span><span class="lineCov">         19 :                                         gf_dynstrcat(&amp;payload_text, &quot; afdt:fileTemplate=\&quot;&quot;, NULL);</span>
<span class="lineNum">    1099 </span><span class="lineCov">         19 :                                         gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">    1100 </span><span class="lineCov">         19 :                                         gf_dynstrcat(&amp;payload_text, &quot;\&quot;&quot;, NULL);</span>
<span class="lineNum">    1101 </span>            :                                 }
<span class="lineNum">    1102 </span>            : 
<span class="lineNum">    1103 </span><span class="lineCov">         19 :                                 if (!rpid-&gt;bandwidth || !rpid-&gt;dash_dur.den || !rpid-&gt;dash_dur.num) {</span>
<span class="lineNum">    1104 </span><span class="lineCov">         13 :                                         switch (rpid-&gt;stream_type) {</span>
<span class="lineNum">    1105 </span>            :                                         case GF_STREAM_VISUAL: max_size = 5000000; break;
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :                                         case GF_STREAM_AUDIO: max_size = 1000000; break;</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :                                         default: max_size = 100000; break;</span>
<span class="lineNum">    1108 </span>            :                                         }
<span class="lineNum">    1109 </span>            :                                 } else {
<span class="lineNum">    1110 </span><span class="lineCov">          6 :                                         max_size = rpid-&gt;bandwidth / 8;</span>
<span class="lineNum">    1111 </span><span class="lineCov">          6 :                                         max_size *= rpid-&gt;dash_dur.num;</span>
<span class="lineNum">    1112 </span><span class="lineCov">          6 :                                         max_size /= rpid-&gt;dash_dur.den;</span>
<span class="lineNum">    1113 </span>            :                                         //use 2x avg rate announced as safety
<span class="lineNum">    1114 </span><span class="lineCov">          6 :                                         max_size *= 2;</span>
<span class="lineNum">    1115 </span>            :                                 }
<span class="lineNum">    1116 </span>            : 
<span class="lineNum">    1117 </span>            :                                 snprintf(temp, 1000, &quot; Expires=\&quot;4294967295\&quot; afdt:maxTransportSize=\&quot;%d\&quot;&gt;\n&quot;, max_size);
<span class="lineNum">    1118 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">    1119 </span>            :                         }
<span class="lineNum">    1120 </span>            : 
<span class="lineNum">    1121 </span><span class="lineCov">         19 :                         if (rpid-&gt;init_seg_name) {</span>
<span class="lineNum">    1122 </span>            :                                 snprintf(temp, 1000, &quot;      &lt;fdt:File Content-Location=\&quot;%s\&quot; TOI=\&quot;%u\&quot;/&gt;\n&quot;, rpid-&gt;init_seg_name, ROUTE_INIT_TOI);
<span class="lineNum">    1123 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">    1124 </span>            :                         }
<span class="lineNum">    1125 </span><span class="lineCov">         19 :                         if (rpid-&gt;hld_child_pl_name) {</span>
<span class="lineNum">    1126 </span>            :                                 snprintf(temp, 1000, &quot;      &lt;fdt:File Content-Location=\&quot;%s\&quot; TOI=\&quot;%u\&quot;/&gt;\n&quot;, rpid-&gt;hld_child_pl_name, ROUTE_INIT_TOI - 1);
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">    1128 </span>            :                         }
<span class="lineNum">    1129 </span><span class="lineCov">         19 :                         if (rpid-&gt;raw_file) {</span>
<span class="lineNum">    1130 </span>            :                                 const char *mime, *url;
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :                                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_MIME);</span>
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :                                 if (p &amp;&amp; p-&gt;value.string &amp;&amp; strcmp(p-&gt;value.string, &quot;*&quot;))</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :                                         mime = p-&gt;value.string;</span>
<span class="lineNum">    1134 </span>            :                                 else {
<span class="lineNum">    1135 </span>            :                                         mime = &quot;application/octet-string&quot;;
<span class="lineNum">    1136 </span>            :                                 }
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :                                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_ROUTE_NAME);</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :                                 if (p &amp;&amp; p-&gt;value.string)</span>
<span class="lineNum">    1139 </span>            :                                         url = p-&gt;value.string;
<span class="lineNum">    1140 </span>            :                                 else {
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :                                         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_URL);</span>
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :                                         url = (p &amp;&amp; p-&gt;value.string) ? gf_file_basename(p-&gt;value.string) : &quot;/dev/null&quot;;</span>
<span class="lineNum">    1143 </span>            :                                 }
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :                                 snprintf(temp, 1000, &quot;      &lt;fdt:File Content-Location=\&quot;%s\&quot; Content-Type=\&quot;%s\&quot; TOI=\&quot;%u\&quot;/&gt;\n&quot;, url, mime, rpid-&gt;current_toi);</span>
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">    1146 </span>            :                         }
<span class="lineNum">    1147 </span>            : 
<span class="lineNum">    1148 </span><span class="lineCov">         19 :                         if (ctx-&gt;korean) {</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;payload_text, &quot;     &lt;/FDTParameters&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1150 </span>            :                         } else {
<span class="lineNum">    1151 </span><span class="lineCov">         19 :                 gf_dynstrcat(&amp;payload_text, &quot;     &lt;/FDT-Instance&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1152 </span>            :                         }
<span class="lineNum">    1153 </span><span class="lineCov">         19 :                         gf_dynstrcat(&amp;payload_text, &quot;    &lt;/EFDT&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span><span class="lineCov">         19 :                         if (rpid-&gt;stream_type) {</span>
<span class="lineNum">    1156 </span>            :                                 const char *rep_id;
<span class="lineNum">    1157 </span><span class="lineCov">         19 :                                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_REP_ID);</span>
<span class="lineNum">    1158 </span><span class="lineCov">         19 :                                 if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    1159 </span>            :                                         rep_id = p-&gt;value.string;
<span class="lineNum">    1160 </span>            :                                 } else {
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] Missing representation ID on PID (broken input filter), using \&quot;1\&quot;\n&quot;));</span>
<span class="lineNum">    1162 </span>            :                                         rep_id = &quot;1&quot;;
<span class="lineNum">    1163 </span>            :                                 }
<span class="lineNum">    1164 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, &quot;    &lt;ContentInfo&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1165 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, &quot;     &lt;MediaInfo repId=\&quot;&quot;, NULL);</span>
<span class="lineNum">    1166 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, rep_id, NULL);</span>
<span class="lineNum">    1167 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, &quot;\&quot;&quot;, NULL);</span>
<span class="lineNum">    1168 </span><span class="lineCov">         19 :                                 switch (rpid-&gt;stream_type) {</span>
<span class="lineNum">    1169 </span><span class="lineCov">         16 :                                 case GF_STREAM_VISUAL:</span>
<span class="lineNum">    1170 </span><span class="lineCov">         16 :                                         gf_dynstrcat(&amp;payload_text, &quot; contentType=\&quot;video\&quot;&quot;, NULL);</span>
<span class="lineNum">    1171 </span><span class="lineCov">         16 :                                         break;</span>
<span class="lineNum">    1172 </span><span class="lineCov">          3 :                                 case GF_STREAM_AUDIO:</span>
<span class="lineNum">    1173 </span><span class="lineCov">          3 :                                         gf_dynstrcat(&amp;payload_text, &quot; contentType=\&quot;audio\&quot;&quot;, NULL);</span>
<span class="lineNum">    1174 </span><span class="lineCov">          3 :                                         break;</span>
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :                                 case GF_STREAM_TEXT:</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :                                         gf_dynstrcat(&amp;payload_text, &quot; contentType=\&quot;subtitles\&quot;&quot;, NULL);</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1178 </span>            :                                 //other stream types are not mapped in ATSC3, do not set content type
<span class="lineNum">    1179 </span>            :                                 }
<span class="lineNum">    1180 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, &quot;/&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1181 </span><span class="lineCov">         19 :                                 gf_dynstrcat(&amp;payload_text, &quot;    &lt;/ContentInfo&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1182 </span>            :                         }
<span class="lineNum">    1183 </span>            :                         //setup payload format - we remove srcFecPayloadId=\&quot;0\&quot; as there is no FEC support yet
<span class="lineNum">    1184 </span><span class="lineCov">         19 :                         snprintf(temp, 1000,</span>
<span class="lineNum">    1185 </span>            :                                         &quot;    &lt;Payload codePoint=\&quot;%d\&quot; formatId=\&quot;%d\&quot; frag=\&quot;0\&quot; order=\&quot;true\&quot;/&gt;\n&quot;
<span class="lineNum">    1186 </span>            :                                         , rpid-&gt;fmtp, rpid-&gt;mode);
<span class="lineNum">    1187 </span>            : 
<span class="lineNum">    1188 </span><span class="lineCov">         19 :                         gf_dynstrcat(&amp;payload_text, temp, NULL);</span>
<span class="lineNum">    1189 </span>            : 
<span class="lineNum">    1190 </span><span class="lineCov">         19 :                         gf_dynstrcat(&amp;payload_text,</span>
<span class="lineNum">    1191 </span>            :                                         &quot;   &lt;/SrcFlow&gt;\n&quot;
<span class="lineNum">    1192 </span>            :                                         &quot;  &lt;/LS&gt;\n&quot;, NULL);
<span class="lineNum">    1193 </span>            :                 }
<span class="lineNum">    1194 </span><span class="lineCov">         17 :                 gf_dynstrcat(&amp;payload_text, &quot; &lt;/RS&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1195 </span>            :         }
<span class="lineNum">    1196 </span>            : 
<span class="lineNum">    1197 </span><span class="lineCov">         17 :         gf_dynstrcat(&amp;payload_text, &quot;&lt;/S-TSID&gt;\n\r\n&quot;, NULL);</span>
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span><span class="lineCov">         17 :         gf_dynstrcat(&amp;payload_text, &quot;--&quot;MULTIPART_BOUNDARY&quot;--\n&quot;, NULL);</span>
<span class="lineNum">    1200 </span>            : 
<span class="lineNum">    1201 </span>            : 
<span class="lineNum">    1202 </span><span class="lineCov">         17 :         GF_LOG(GF_LOG_INFO, GF_LOG_ROUTE, (&quot;[ROUTE] Updated Manifest+S-TSID bundle to:\n%s\n&quot;, payload_text));</span>
<span class="lineNum">    1203 </span>            : 
<span class="lineNum">    1204 </span>            :         //compress and store as final payload
<span class="lineNum">    1205 </span><span class="lineCov">         17 :         if (serv-&gt;stsid_bundle) gf_free(serv-&gt;stsid_bundle);</span>
<span class="lineNum">    1206 </span><span class="lineCov">         17 :         serv-&gt;stsid_bundle = (u8 *) payload_text;</span>
<span class="lineNum">    1207 </span><span class="lineCov">         17 :         serv-&gt;stsid_bundle_size = 1 + (u32) strlen(payload_text);</span>
<span class="lineNum">    1208 </span><span class="lineCov">         17 :         gf_gz_compress_payload(&amp;serv-&gt;stsid_bundle, serv-&gt;stsid_bundle_size, &amp;serv-&gt;stsid_bundle_size);</span>
<span class="lineNum">    1209 </span>            : 
<span class="lineNum">    1210 </span><span class="lineCov">         17 :         serv-&gt;stsid_bundle_toi = 0x80000000; //compressed</span>
<span class="lineNum">    1211 </span><span class="lineCov">         17 :         if (manifest_updated) serv-&gt;stsid_bundle_toi |= (1&lt;&lt;18);</span>
<span class="lineNum">    1212 </span><span class="lineCov">         17 :         if (serv-&gt;stsid_changed) {</span>
<span class="lineNum">    1213 </span><span class="lineCov">          8 :                 serv-&gt;stsid_bundle_toi |= (1&lt;&lt;17);</span>
<span class="lineNum">    1214 </span><span class="lineCov">          8 :                 serv-&gt;stsid_bundle_toi |= (serv-&gt;stsid_version &amp; 0xFF);</span>
<span class="lineNum">    1215 </span><span class="lineCov">          9 :         } else if (manifest_updated) {</span>
<span class="lineNum">    1216 </span><span class="lineCov">          9 :                 serv-&gt;stsid_bundle_toi |= (serv-&gt;manifest_version &amp; 0xFF);</span>
<span class="lineNum">    1217 </span>            :         }
<span class="lineNum">    1218 </span>            : 
<span class="lineNum">    1219 </span><span class="lineCov">         17 :         serv-&gt;stsid_changed = GF_FALSE;</span>
<span class="lineNum">    1220 </span>            : 
<span class="lineNum">    1221 </span>            :         //reset last sent time
<span class="lineNum">    1222 </span><span class="lineCov">         17 :         serv-&gt;last_stsid_clock = 0;</span>
<span class="lineNum">    1223 </span><span class="lineCov">         17 :         return GF_OK;</span>
<span class="lineNum">    1224 </span>            : }
<a name="1225"><span class="lineNum">    1225 </span>            : </a>
<span class="lineNum">    1226 </span>            : 
<span class="lineNum">    1227 </span><span class="lineCov">       4334 : u32 routeout_lct_send(GF_ROUTEOutCtx *ctx, GF_Socket *sock, u32 tsi, u32 toi, u32 codepoint, u8 *payload, u32 len, u32 offset, u32 service_id, u32 total_size, u32 offset_in_frame)</span>
<span class="lineNum">    1228 </span>            : {
<span class="lineNum">    1229 </span><span class="lineCov">       4334 :         u32 max_size = ctx-&gt;mtu;</span>
<span class="lineNum">    1230 </span>            :         u32 send_payl_size;
<span class="lineNum">    1231 </span>            :         u32 hdr_len = 4;
<span class="lineNum">    1232 </span>            :         u32 hpos;
<span class="lineNum">    1233 </span>            :         GF_Err e;
<span class="lineNum">    1234 </span>            : 
<span class="lineNum">    1235 </span><span class="lineCov">       4334 :         if (total_size) {</span>
<span class="lineNum">    1236 </span>            :                 //TOL extension
<span class="lineNum">    1237 </span><span class="lineCov">       1288 :                 if (total_size&lt;=0xFFFFFF) hdr_len += 1;</span>
<span class="lineNum">    1238 </span>            :                 else hdr_len += 2;
<span class="lineNum">    1239 </span>            :         }
<span class="lineNum">    1240 </span>            : 
<span class="lineNum">    1241 </span>            :         //start offset is not in header
<span class="lineNum">    1242 </span><span class="lineCov">       4334 :         send_payl_size = 4 * (hdr_len+1) + len - offset;</span>
<span class="lineNum">    1243 </span><span class="lineCov">       4334 :         if (send_payl_size &gt; max_size) {</span>
<span class="lineNum">    1244 </span><span class="lineCov">       4096 :                 send_payl_size = max_size - 4 * (hdr_len+1);</span>
<span class="lineNum">    1245 </span>            :         } else {
<span class="lineNum">    1246 </span><span class="lineCov">        238 :                 send_payl_size = len - offset;</span>
<span class="lineNum">    1247 </span>            :         }
<span class="lineNum">    1248 </span><span class="lineCov">       4334 :         ctx-&gt;lct_buffer[0] = 0x12; //V=b0001, C=b00, PSI=b10</span>
<span class="lineNum">    1249 </span><span class="lineCov">       4334 :         ctx-&gt;lct_buffer[1] = 0xA0; //S=b1, 0=b01, h=b0, res=b00, A=b0, B=X</span>
<span class="lineNum">    1250 </span>            :         //set close flag only if total_len is known
<span class="lineNum">    1251 </span><span class="lineCov">       4334 :         if (total_size &amp;&amp; (offset + send_payl_size == len))</span>
<span class="lineNum">    1252 </span><span class="lineCov">        127 :                 ctx-&gt;lct_buffer[1] |= 1;</span>
<span class="lineNum">    1253 </span>            : 
<span class="lineNum">    1254 </span><span class="lineCov">       4334 :         ctx-&gt;lct_buffer[2] = hdr_len;</span>
<span class="lineNum">    1255 </span><span class="lineCov">       4334 :         ctx-&gt;lct_buffer[3] = (u8) codepoint;</span>
<span class="lineNum">    1256 </span>            :         hpos = 4;
<span class="lineNum">    1257 </span>            : 
<span class="lineNum">    1258 </span>            : #define PUT_U32(_val)\
<span class="lineNum">    1259 </span>            :         ctx-&gt;lct_buffer[hpos] = (_val&gt;&gt;24 &amp; 0xFF);\
<span class="lineNum">    1260 </span>            :         ctx-&gt;lct_buffer[hpos+1] = (_val&gt;&gt;16 &amp; 0xFF);\
<span class="lineNum">    1261 </span>            :         ctx-&gt;lct_buffer[hpos+2] = (_val&gt;&gt;8 &amp; 0xFF);\
<span class="lineNum">    1262 </span>            :         ctx-&gt;lct_buffer[hpos+3] = (_val &amp; 0xFF); \
<span class="lineNum">    1263 </span>            :         hpos+=4;
<span class="lineNum">    1264 </span>            : 
<span class="lineNum">    1265 </span>            :         //CCI=0
<span class="lineNum">    1266 </span><span class="lineCov">       4334 :         PUT_U32(0);</span>
<span class="lineNum">    1267 </span><span class="lineCov">       4334 :         PUT_U32(tsi);</span>
<span class="lineNum">    1268 </span><span class="lineCov">       4334 :         PUT_U32(toi);</span>
<span class="lineNum">    1269 </span>            : 
<span class="lineNum">    1270 </span>            :         //total length
<span class="lineNum">    1271 </span><span class="lineCov">       4334 :         if (total_size) {</span>
<span class="lineNum">    1272 </span><span class="lineCov">       1288 :                 if (total_size&lt;=0xFFFFFF) {</span>
<span class="lineNum">    1273 </span><span class="lineCov">       1288 :                         ctx-&gt;lct_buffer[hpos] = GF_LCT_EXT_TOL24;</span>
<span class="lineNum">    1274 </span><span class="lineCov">       1288 :                         ctx-&gt;lct_buffer[hpos+1] = total_size&gt;&gt;16 &amp; 0xFF;</span>
<span class="lineNum">    1275 </span><span class="lineCov">       1288 :                         ctx-&gt;lct_buffer[hpos+2] = total_size&gt;&gt;8 &amp; 0xFF;</span>
<span class="lineNum">    1276 </span><span class="lineCov">       1288 :                         ctx-&gt;lct_buffer[hpos+3] = total_size &amp; 0xFF;</span>
<span class="lineNum">    1277 </span>            :                         hpos+=4;
<span class="lineNum">    1278 </span>            :                 } else {
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :                         ctx-&gt;lct_buffer[hpos] = GF_LCT_EXT_TOL48;</span>
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 :                         ctx-&gt;lct_buffer[hpos+1] = 2; //2 x 32 bits for header ext</span>
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :                         ctx-&gt;lct_buffer[hpos+2] = 0;</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :                         ctx-&gt;lct_buffer[hpos+3] = 0;</span>
<span class="lineNum">    1283 </span>            :                         hpos+=4;
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :                         PUT_U32(total_size);</span>
<span class="lineNum">    1285 </span>            :                 }
<span class="lineNum">    1286 </span>            :         }
<span class="lineNum">    1287 </span>            : 
<span class="lineNum">    1288 </span>            :         //start_offset
<span class="lineNum">    1289 </span><span class="lineCov">       4334 :         PUT_U32(offset_in_frame);</span>
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span>            :         assert(send_payl_size+hpos &lt;= ctx-&gt;mtu);
<span class="lineNum">    1292 </span>            : 
<span class="lineNum">    1293 </span><span class="lineCov">       4334 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_ROUTE, (&quot;[ROUTE] LCT SID %u TSI %u TOI %u size %u (frag %u total %u) offset %u (%u in obj)\n&quot;, service_id, tsi, toi, send_payl_size, len, total_size, offset, offset_in_frame));</span>
<span class="lineNum">    1294 </span>            : 
<span class="lineNum">    1295 </span><span class="lineCov">       4334 :         memcpy(ctx-&gt;lct_buffer + hpos, payload + offset, send_payl_size);</span>
<span class="lineNum">    1296 </span><span class="lineCov">       4334 :         e = gf_sk_send(sock, ctx-&gt;lct_buffer, send_payl_size + hpos);</span>
<span class="lineNum">    1297 </span><span class="lineCov">       4334 :         if (e) {</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] Failed to send LCT object TSI %u TOI %u fragment: %s\n&quot;, tsi, toi, gf_error_to_string(e) ));</span>
<span class="lineNum">    1299 </span>            :         }
<span class="lineNum">    1300 </span>            :         //store what we actually sent including header for rate estimation
<span class="lineNum">    1301 </span><span class="lineCov">       4334 :         ctx-&gt;bytes_sent += send_payl_size + hpos;</span>
<span class="lineNum">    1302 </span>            :         //but return what we sent from the source
<span class="lineNum">    1303 </span><span class="lineCov">       4334 :         return send_payl_size;</span>
<a name="1304"><span class="lineNum">    1304 </span>            : }</a>
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span><span class="lineCov">         47 : static GF_Err routeout_service_send_bundle(GF_ROUTEOutCtx *ctx, ROUTEService *serv)</span>
<span class="lineNum">    1307 </span>            : {
<span class="lineNum">    1308 </span>            :         u32 offset = 0;
<span class="lineNum">    1309 </span>            : 
<span class="lineNum">    1310 </span>            :         //we don't regulate
<span class="lineNum">    1311 </span><span class="lineCov">        141 :         while (offset &lt; serv-&gt;stsid_bundle_size) {</span>
<span class="lineNum">    1312 </span>            :                 /*send lct with codepoint &quot;NRT - Unsigned Package Mode&quot; (multipart):
<span class="lineNum">    1313 </span>            :                 &quot;In broadcast delivery of SLS for a DASH-formatted streaming Service delivered using ROUTE, since SLS fragments are NRT files in nature,
<span class="lineNum">    1314 </span>            :                 their carriage over the ROUTE session/LCT channel assigned by the SLT shall be in accordance to the Unsigned Packaged Mode or
<span class="lineNum">    1315 </span>            :                 the Signed Package Mode as described in Section A.3.3.4 and A.3.3.5, respectively&quot;
<span class="lineNum">    1316 </span>            :                 */
<span class="lineNum">    1317 </span><span class="lineCov">         47 :                 offset += routeout_lct_send(ctx, serv-&gt;rlct_base-&gt;sock, 0, serv-&gt;stsid_bundle_toi, 3, serv-&gt;stsid_bundle, serv-&gt;stsid_bundle_size, offset, serv-&gt;service_id, serv-&gt;stsid_bundle_size, offset);</span>
<span class="lineNum">    1318 </span>            :         }
<span class="lineNum">    1319 </span><span class="lineCov">         47 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_ROUTE, (&quot;[ROUTE] Sent service %d bundle (%d bytes)\n&quot;, serv-&gt;service_id, serv-&gt;stsid_bundle_size));</span>
<span class="lineNum">    1320 </span><span class="lineCov">         47 :         return GF_OK;</span>
<a name="1321"><span class="lineNum">    1321 </span>            : }</a>
<span class="lineNum">    1322 </span>            : 
<span class="lineNum">    1323 </span><span class="lineCov">       1095 : static void routeout_fetch_packet(GF_ROUTEOutCtx *ctx, ROUTEPid *rpid)</span>
<span class="lineNum">    1324 </span>            : {
<span class="lineNum">    1325 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">    1326 </span>            :         Bool start, end;
<span class="lineNum">    1327 </span>            :         u64 pck_dur;
<span class="lineNum">    1328 </span>            :         u64 ts;
<span class="lineNum">    1329 </span>            :         Bool has_ts;
<span class="lineNum">    1330 </span>            :         Bool pck_dur_for_segment;
<span class="lineNum">    1331 </span>            : 
<span class="lineNum">    1332 </span>            : retry:
<span class="lineNum">    1333 </span>            : 
<span class="lineNum">    1334 </span><span class="lineCov">       1095 :         rpid-&gt;current_pck = gf_filter_pid_get_packet(rpid-&gt;pid);</span>
<span class="lineNum">    1335 </span><span class="lineCov">       1095 :         if (!rpid-&gt;current_pck) {</span>
<span class="lineNum">    1336 </span><span class="lineCov">        942 :                 if (gf_filter_pid_is_eos(rpid-&gt;pid)) {</span>
<span class="lineNum">    1337 </span>            : #if 0
<span class="lineNum">    1338 </span>            :                         if (gf_filter_reporting_enabled(filter)) {
<span class="lineNum">    1339 </span>            :                                 char szStatus[1024];
<span class="lineNum">    1340 </span>            :                                 snprintf(szStatus, 1024, &quot;%s: done - wrote &quot;LLU&quot; bytes&quot;, gf_file_basename(ctx-&gt;szFileName), ctx-&gt;nb_write);
<span class="lineNum">    1341 </span>            :                                 gf_filter_update_status(filter, 10000, szStatus);
<span class="lineNum">    1342 </span>            :                         }
<span class="lineNum">    1343 </span>            : #endif
<span class="lineNum">    1344 </span>            : 
<span class="lineNum">    1345 </span><span class="lineCov">          5 :                         if (rpid-&gt;route-&gt;dash_mode &amp;&amp; rpid-&gt;res_size) {</span>
<span class="lineNum">    1346 </span>            :                                 GF_FilterEvent evt;
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :                                 GF_FEVT_INIT(evt, GF_FEVT_SEGMENT_SIZE, rpid-&gt;pid);</span>
<span class="lineNum">    1348 </span>            :                                 evt.seg_size.seg_url = NULL;
<span class="lineNum">    1349 </span>            : 
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :                                 if (rpid-&gt;route-&gt;dash_mode==1) {</span>
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :                                         evt.seg_size.is_init = GF_TRUE;</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :                                         rpid-&gt;route-&gt;dash_mode = 2;</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :                                         evt.seg_size.media_range_start = 0;</span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :                                         evt.seg_size.media_range_end = 0;</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_send_event(rpid-&gt;pid, &amp;evt);</span>
<span class="lineNum">    1356 </span>            :                                 } else {
<span class="lineNum">    1357 </span>            :                                         evt.seg_size.is_init = GF_FALSE;
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :                                         evt.seg_size.media_range_start = rpid-&gt;offset_at_seg_start;</span>
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :                                         evt.seg_size.media_range_end = rpid-&gt;res_size - 1;</span>
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_send_event(rpid-&gt;pid, &amp;evt);</span>
<span class="lineNum">    1361 </span>            :                                 }
<span class="lineNum">    1362 </span>            :                         }
<span class="lineNum">    1363 </span>            :                         //done
<span class="lineNum">    1364 </span><span class="lineCov">          5 :                         rpid-&gt;res_size = 0;</span>
<span class="lineNum">    1365 </span><span class="lineCov">        942 :                         return;</span>
<span class="lineNum">    1366 </span>            :                 }
<span class="lineNum">    1367 </span>            :                 return;
<span class="lineNum">    1368 </span>            :         }
<span class="lineNum">    1369 </span><span class="lineCov">        153 :         gf_filter_pck_ref(&amp;rpid-&gt;current_pck);</span>
<span class="lineNum">    1370 </span><span class="lineCov">        153 :         gf_filter_pid_drop_packet(rpid-&gt;pid);</span>
<span class="lineNum">    1371 </span>            : 
<span class="lineNum">    1372 </span><span class="lineCov">        153 :         gf_filter_pck_get_framing(rpid-&gt;current_pck, &amp;start, &amp;end);</span>
<span class="lineNum">    1373 </span>            : 
<span class="lineNum">    1374 </span>            :         //trash redundant info for raw files
<span class="lineNum">    1375 </span><span class="lineCov">        153 :         if (rpid-&gt;raw_file) {</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :                 u32 dep_flags = gf_filter_pck_get_dependency_flags(rpid-&gt;current_pck);</span>
<span class="lineNum">    1377 </span>            :                 //redundant packet, do not store
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :                 if ((dep_flags &amp; 0x3) == 1) {</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :                         gf_filter_pck_unref(rpid-&gt;current_pck);</span>
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :                         rpid-&gt;current_pck = NULL;</span>
<span class="lineNum">    1381 </span>            :                         goto retry;
<span class="lineNum">    1382 </span>            :                 }
<span class="lineNum">    1383 </span>            :         }
<span class="lineNum">    1384 </span>            : 
<span class="lineNum">    1385 </span><span class="lineCov">        153 :         rpid-&gt;pck_data = gf_filter_pck_get_data(rpid-&gt;current_pck, &amp;rpid-&gt;pck_size);</span>
<span class="lineNum">    1386 </span><span class="lineCov">        153 :         rpid-&gt;pck_offset = 0;</span>
<span class="lineNum">    1387 </span>            : 
<span class="lineNum">    1388 </span><span class="lineCov">        153 :         p = gf_filter_pck_get_property(rpid-&gt;current_pck, GF_PROP_PCK_INIT);</span>
<span class="lineNum">    1389 </span><span class="lineCov">        153 :         if (p &amp;&amp; p-&gt;value.boolean) {</span>
<span class="lineNum">    1390 </span>            :                 u32 crc;
<span class="lineNum">    1391 </span>            :                 assert(start &amp;&amp; end);
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :                 crc = gf_crc_32(rpid-&gt;pck_data, rpid-&gt;pck_size);</span>
<span class="lineNum">    1393 </span>            :                 //whenever init seg changes, bump stsid version
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :                 if (crc != rpid-&gt;init_seg_crc) {</span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :                         rpid-&gt;init_seg_crc = crc;</span>
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :                         rpid-&gt;route-&gt;stsid_changed = GF_TRUE;</span>
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :                         rpid-&gt;current_toi = 0;</span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :                         if (rpid-&gt;init_seg_data) gf_free(rpid-&gt;init_seg_data);</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :                         rpid-&gt;init_seg_data = gf_malloc(rpid-&gt;pck_size);</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :                         memcpy(rpid-&gt;init_seg_data, rpid-&gt;pck_data, rpid-&gt;pck_size);</span>
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :                         rpid-&gt;init_seg_size = rpid-&gt;pck_size;</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :                         rpid-&gt;init_seg_sent = GF_FALSE;</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :                         p = gf_filter_pck_get_property(rpid-&gt;current_pck, GF_PROP_PCK_FILENAME);</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :                         if (rpid-&gt;init_seg_name) gf_free(rpid-&gt;init_seg_name);</span>
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :                         rpid-&gt;init_seg_name = p ? routeout_strip_base(rpid-&gt;route, p-&gt;value.string) : NULL;</span>
<span class="lineNum">    1406 </span>            :                 }
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :                 gf_filter_pck_unref(rpid-&gt;current_pck);</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :                 rpid-&gt;current_pck = NULL;</span>
<span class="lineNum">    1409 </span>            :                 goto retry;
<span class="lineNum">    1410 </span>            :         }
<span class="lineNum">    1411 </span>            : 
<span class="lineNum">    1412 </span><span class="lineCov">        153 :         p = gf_filter_pck_get_property(rpid-&gt;current_pck, GF_PROP_PID_HLS_PLAYLIST);</span>
<span class="lineNum">    1413 </span><span class="lineCov">        153 :         if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    1414 </span>            :                 u32 crc;
<span class="lineNum">    1415 </span>            :                 assert(start &amp;&amp; end);
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :                 crc = gf_crc_32(rpid-&gt;pck_data, rpid-&gt;pck_size);</span>
<span class="lineNum">    1417 </span>            :                 //whenever init seg changes, bump stsid version
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :                 if (crc != rpid-&gt;hld_child_pl_crc) {</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :                         rpid-&gt;hld_child_pl_crc = crc;</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :                         if (rpid-&gt;hld_child_pl) gf_free(rpid-&gt;hld_child_pl);</span>
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :                         rpid-&gt;hld_child_pl = gf_malloc(rpid-&gt;pck_size+1);</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :                         memcpy(rpid-&gt;hld_child_pl, rpid-&gt;pck_data, rpid-&gt;pck_size);</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :                         rpid-&gt;hld_child_pl[rpid-&gt;pck_size] = 0;</span>
<span class="lineNum">    1424 </span>            : 
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :                         if (!rpid-&gt;hld_child_pl_name || strcmp(rpid-&gt;hld_child_pl_name, p-&gt;value.string)) {</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :                                 rpid-&gt;route-&gt;stsid_changed = GF_TRUE;</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :                                 if (rpid-&gt;hld_child_pl_name) gf_free(rpid-&gt;hld_child_pl_name);</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :                                 rpid-&gt;hld_child_pl_name = routeout_strip_base(rpid-&gt;route, p-&gt;value.string);</span>
<span class="lineNum">    1429 </span>            :                         }
<span class="lineNum">    1430 </span>            :                 }
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :                 gf_filter_pck_unref(rpid-&gt;current_pck);</span>
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :                 rpid-&gt;current_pck = NULL;</span>
<span class="lineNum">    1433 </span>            :                 goto retry;
<span class="lineNum">    1434 </span>            :         }
<span class="lineNum">    1435 </span><span class="lineCov">        153 :         if (rpid-&gt;route-&gt;dash_mode) {</span>
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 :                 p = gf_filter_pck_get_property(rpid-&gt;current_pck, GF_PROP_PCK_FILENUM);</span>
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :                 if (p) {</span>
<span class="lineNum">    1438 </span>            :                         GF_FilterEvent evt;
<span class="lineNum">    1439 </span>            : 
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :                         GF_FEVT_INIT(evt, GF_FEVT_SEGMENT_SIZE, rpid-&gt;pid);</span>
<span class="lineNum">    1441 </span>            :                         evt.seg_size.seg_url = NULL;
<span class="lineNum">    1442 </span>            : 
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :                         if (rpid-&gt;route-&gt;dash_mode==1) {</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :                                 evt.seg_size.is_init = GF_TRUE;</span>
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :                                 rpid-&gt;route-&gt;dash_mode = 2;</span>
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :                                 evt.seg_size.media_range_start = 0;</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :                                 evt.seg_size.media_range_end = 0;</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_send_event(rpid-&gt;pid, &amp;evt);</span>
<span class="lineNum">    1449 </span>            :                         } else {
<span class="lineNum">    1450 </span>            :                                 evt.seg_size.is_init = GF_FALSE;
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :                                 evt.seg_size.media_range_start = rpid-&gt;offset_at_seg_start;</span>
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :                                 evt.seg_size.media_range_end = rpid-&gt;res_size - 1;</span>
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :                                 rpid-&gt;offset_at_seg_start = evt.seg_size.media_range_end;</span>
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_send_event(rpid-&gt;pid, &amp;evt);</span>
<span class="lineNum">    1455 </span>            :                         }
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :                         if ( gf_filter_pck_get_property(rpid-&gt;current_pck, GF_PROP_PCK_FILENAME))</span>
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :                                 start = GF_TRUE;</span>
<span class="lineNum">    1458 </span>            :                 }
<span class="lineNum">    1459 </span>            :         }
<span class="lineNum">    1460 </span>            : 
<span class="lineNum">    1461 </span><span class="lineCov">        153 :         if (rpid-&gt;raw_file) {</span>
<span class="lineNum">    1462 </span>            :                 assert(start &amp;&amp; end);
<span class="lineNum">    1463 </span>            : 
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :                 if (rpid-&gt;seg_name) gf_free(rpid-&gt;seg_name);</span>
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :                 rpid-&gt;seg_name = &quot;unknown&quot;;</span>
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_ROUTE_NAME);</span>
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :                 if (p)</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :                         rpid-&gt;seg_name = p-&gt;value.string;</span>
<span class="lineNum">    1469 </span>            :                 else {
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_URL);</span>
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :                         if (p) rpid-&gt;seg_name = gf_file_basename(p-&gt;value.string);</span>
<span class="lineNum">    1472 </span>            :                 }
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :                 rpid-&gt;seg_name = gf_strdup(rpid-&gt;seg_name);</span>
<span class="lineNum">    1474 </span>            : 
<span class="lineNum">    1475 </span>            :                 //setup carousel period
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :                 rpid-&gt;carousel_time_us = ctx-&gt;carousel;</span>
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_ROUTE_CAROUSEL);</span>
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :                 if (p) {</span>
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :                         rpid-&gt;carousel_time_us = p-&gt;value.frac.num;</span>
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :                         rpid-&gt;carousel_time_us *= 1000000;</span>
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :                         rpid-&gt;carousel_time_us /= p-&gt;value.frac.den;</span>
<span class="lineNum">    1482 </span>            :                 }
<span class="lineNum">    1483 </span>            :                 //setup upload time
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :                 rpid-&gt;current_dur_us = ctx-&gt;carousel;</span>
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_ROUTE_SENDTIME);</span>
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :                 if (p) {</span>
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :                         rpid-&gt;current_dur_us = p-&gt;value.frac.num;</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :                         rpid-&gt;current_dur_us *= 1000000;</span>
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :                         rpid-&gt;current_dur_us /= p-&gt;value.frac.den;</span>
<span class="lineNum">    1490 </span>            :                 }
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :                 if (rpid-&gt;carousel_time_us &amp;&amp; (rpid-&gt;current_dur_us&gt;rpid-&gt;carousel_time_us)) {</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_ROUTE, (&quot;[ROUTE] Requested upload time of file &quot;LLU&quot; is greater than its carousel time &quot;LLU&quot;, adjusting carousel\n&quot;, rpid-&gt;current_dur_us, rpid-&gt;carousel_time_us));</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :                         rpid-&gt;carousel_time_us = rpid-&gt;current_dur_us;</span>
<span class="lineNum">    1494 </span>            :                 }
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :                 rpid-&gt;clock_at_pck = rpid-&gt;current_cts_us = rpid-&gt;cts_us_at_frame_start = ctx-&gt;clock;</span>
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :                 rpid-&gt;full_frame_size = rpid-&gt;pck_size;</span>
<span class="lineNum">    1497 </span>            :                 return;
<span class="lineNum">    1498 </span>            :         }
<span class="lineNum">    1499 </span>            : 
<span class="lineNum">    1500 </span><span class="lineCov">        153 :         if (start) {</span>
<span class="lineNum">    1501 </span><span class="lineCov">         42 :                 p = gf_filter_pck_get_property(rpid-&gt;current_pck, GF_PROP_PCK_FILENAME);</span>
<span class="lineNum">    1502 </span><span class="lineCov">         42 :                 if (rpid-&gt;seg_name) gf_free(rpid-&gt;seg_name);</span>
<span class="lineNum">    1503 </span><span class="lineCov">         42 :                 if (p) {</span>
<span class="lineNum">    1504 </span><span class="lineCov">         42 :                         rpid-&gt;seg_name = rpid-&gt;use_basename ? gf_file_basename(p-&gt;value.string) : p-&gt;value.string;</span>
<span class="lineNum">    1505 </span>            :                 } else {
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :                         rpid-&gt;seg_name = &quot;unknown&quot;;</span>
<span class="lineNum">    1507 </span>            :                 }
<span class="lineNum">    1508 </span><span class="lineCov">         42 :                 rpid-&gt;seg_name = gf_strdup(rpid-&gt;seg_name);</span>
<span class="lineNum">    1509 </span>            : 
<span class="lineNum">    1510 </span>            :                 //file num increased per packet, open new file
<span class="lineNum">    1511 </span><span class="lineCov">         42 :                 p = gf_filter_pck_get_property(rpid-&gt;current_pck, GF_PROP_PCK_FILENUM);</span>
<span class="lineNum">    1512 </span><span class="lineCov">         42 :                 if (p)</span>
<span class="lineNum">    1513 </span><span class="lineCov">         42 :                         rpid-&gt;current_toi = p-&gt;value.uint;</span>
<span class="lineNum">    1514 </span>            :                 else {
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] Missing filenum on segment %s, something is wrong in demux chain - assuming +1 increase\n&quot;, rpid-&gt;seg_name));</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :                         rpid-&gt;current_toi ++;</span>
<span class="lineNum">    1517 </span>            :                 }
<span class="lineNum">    1518 </span><span class="lineCov">         42 :                 rpid-&gt;frag_idx = 0;</span>
<span class="lineNum">    1519 </span><span class="lineCov">         42 :                 rpid-&gt;full_frame_size = end ? rpid-&gt;pck_size : 0;</span>
<span class="lineNum">    1520 </span><span class="lineCov">         42 :                 rpid-&gt;cumulated_frag_size = rpid-&gt;pck_size;</span>
<span class="lineNum">    1521 </span><span class="lineCov">         42 :                 rpid-&gt;push_init = GF_TRUE;</span>
<span class="lineNum">    1522 </span><span class="lineCov">         42 :                 rpid-&gt;frag_offset = 0;</span>
<span class="lineNum">    1523 </span>            :         } else {
<span class="lineNum">    1524 </span><span class="lineCov">        111 :                 rpid-&gt;frag_idx++;</span>
<span class="lineNum">    1525 </span><span class="lineCov">        111 :                 rpid-&gt;cumulated_frag_size += rpid-&gt;pck_size;</span>
<span class="lineNum">    1526 </span><span class="lineCov">        111 :                 if (end) {</span>
<span class="lineNum">    1527 </span><span class="lineCov">         18 :                         rpid-&gt;full_frame_size = rpid-&gt;cumulated_frag_size;</span>
<span class="lineNum">    1528 </span><span class="lineCov">         18 :                         rpid-&gt;force_tol_send = GF_TRUE;</span>
<span class="lineNum">    1529 </span>            :                 }
<span class="lineNum">    1530 </span>            :         }
<span class="lineNum">    1531 </span>            : 
<span class="lineNum">    1532 </span>            : 
<span class="lineNum">    1533 </span><span class="lineCov">        153 :         pck_dur = gf_filter_pck_get_duration(rpid-&gt;current_pck);</span>
<span class="lineNum">    1534 </span>            :         //check if duration is for the entire segment or this fragment (cf forward=file in dmx_dash.c)
<span class="lineNum">    1535 </span>            :         pck_dur_for_segment = GF_FALSE;
<span class="lineNum">    1536 </span><span class="lineCov">        153 :         if (start) {</span>
<span class="lineNum">    1537 </span><span class="lineCov">         42 :                 rpid-&gt;pck_dur_at_frame_start = 0;</span>
<span class="lineNum">    1538 </span><span class="lineCov">         42 :                 if (gf_filter_pck_get_carousel_version(rpid-&gt;current_pck))</span>
<span class="lineNum">    1539 </span>            :                         pck_dur_for_segment = GF_TRUE;
<span class="lineNum">    1540 </span>            :         }
<span class="lineNum">    1541 </span>            : 
<span class="lineNum">    1542 </span><span class="lineCov">        153 :         ts = gf_filter_pck_get_cts(rpid-&gt;current_pck);</span>
<span class="lineNum">    1543 </span><span class="lineCov">        153 :         has_ts = (ts==GF_FILTER_NO_TS) ? GF_FALSE : GF_TRUE;</span>
<span class="lineNum">    1544 </span>            : 
<span class="lineNum">    1545 </span><span class="lineCov">        153 :         if (</span>
<span class="lineNum">    1546 </span>            :                 //no TS and not initial fragment, recompute timing and dur
<span class="lineNum">    1547 </span><span class="lineCov">        228 :                 (!start &amp;&amp; !has_ts &amp;&amp; rpid-&gt;bitrate &amp;&amp; rpid-&gt;pck_dur_at_frame_start)</span>
<span class="lineNum">    1548 </span>            :                 //has TS, initial fragment and duration for the entire segment, recompute dur only
<span class="lineNum">    1549 </span><span class="lineCov">         78 :                 || (has_ts &amp;&amp; start &amp;&amp; !end &amp;&amp; pck_dur &amp;&amp; pck_dur_for_segment)</span>
<span class="lineNum">    1550 </span>            :         ) {
<span class="lineNum">    1551 </span>            :                 u64 frag_time, tot_est_size;
<span class="lineNum">    1552 </span>            : 
<span class="lineNum">    1553 </span>            :                 //fragment start, store packed duration
<span class="lineNum">    1554 </span><span class="lineCov">         93 :                 if (has_ts) {</span>
<span class="lineNum">    1555 </span><span class="lineCov">         18 :                         rpid-&gt;pck_dur_at_frame_start = (u32) pck_dur;</span>
<span class="lineNum">    1556 </span>            :                 }
<span class="lineNum">    1557 </span>            :                 //compute estimated file size based on segment duration and rate, use 10% overhead
<span class="lineNum">    1558 </span><span class="lineCov">         93 :                 tot_est_size = rpid-&gt;bitrate;</span>
<span class="lineNum">    1559 </span><span class="lineCov">         93 :                 tot_est_size *= rpid-&gt;pck_dur_at_frame_start;</span>
<span class="lineNum">    1560 </span><span class="lineCov">         93 :                 tot_est_size /= rpid-&gt;timescale;</span>
<span class="lineNum">    1561 </span><span class="lineCov">         93 :                 tot_est_size /= 8;</span>
<span class="lineNum">    1562 </span>            : 
<span class="lineNum">    1563 </span>            :                 //our estimate was too small...
<span class="lineNum">    1564 </span><span class="lineCov">         93 :                 if (tot_est_size &lt; rpid-&gt;cumulated_frag_size)</span>
<span class="lineNum">    1565 </span>            :                         tot_est_size = rpid-&gt;cumulated_frag_size;
<span class="lineNum">    1566 </span>            : 
<span class="lineNum">    1567 </span>            :                 //compute timing proportional to packet duration, with ratio of current size / tot_est_size
<span class="lineNum">    1568 </span><span class="lineCov">         93 :                 pck_dur = rpid-&gt;pck_size * rpid-&gt;pck_dur_at_frame_start / tot_est_size;</span>
<span class="lineNum">    1569 </span><span class="lineCov">         93 :                 if (!pck_dur) pck_dur = 1;</span>
<span class="lineNum">    1570 </span>            : 
<span class="lineNum">    1571 </span><span class="lineCov">         93 :                 if (!has_ts) {</span>
<span class="lineNum">    1572 </span><span class="lineCov">         75 :                         frag_time = (rpid-&gt;cumulated_frag_size-rpid-&gt;pck_size) *  rpid-&gt;pck_dur_at_frame_start / tot_est_size;</span>
<span class="lineNum">    1573 </span><span class="lineCov">         75 :                         ts = rpid-&gt;cts_at_frame_start + frag_time;</span>
<span class="lineNum">    1574 </span>            :                 } else {
<span class="lineNum">    1575 </span>            :                         frag_time = 0;
<span class="lineNum">    1576 </span>            :                 }
<span class="lineNum">    1577 </span><span class="lineCov">         93 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_ROUTE, (&quot;[ROUTE] Missing timing for fragment %d of segment %s - timing estimated from bitrate: TS &quot;LLU&quot; (&quot;LLU&quot; in segment) dur &quot;LLU&quot;\n&quot;, rpid-&gt;frag_idx, rpid-&gt;seg_name, ts, frag_time, pck_dur));</span>
<span class="lineNum">    1578 </span>            :         }
<span class="lineNum">    1579 </span>            : 
<span class="lineNum">    1580 </span><span class="lineCov">        153 :         if (ts!=GF_FILTER_NO_TS) {</span>
<span class="lineNum">    1581 </span>            :                 u64 diff;
<span class="lineNum">    1582 </span><span class="lineCov">        153 :                 if (!rpid-&gt;clock_at_first_pck) {</span>
<span class="lineNum">    1583 </span><span class="lineCov">          9 :                         rpid-&gt;clock_at_first_pck = ctx-&gt;clock;</span>
<span class="lineNum">    1584 </span><span class="lineCov">          9 :                         rpid-&gt;cts_first_pck = ts;</span>
<span class="lineNum">    1585 </span>            :                 }
<span class="lineNum">    1586 </span>            :                 //move to microsecs
<span class="lineNum">    1587 </span><span class="lineCov">        153 :                 diff = ts - rpid-&gt;cts_first_pck;</span>
<span class="lineNum">    1588 </span><span class="lineCov">        153 :                 diff *= 1000000;</span>
<span class="lineNum">    1589 </span><span class="lineCov">        153 :                 diff /= rpid-&gt;timescale;</span>
<span class="lineNum">    1590 </span>            : 
<span class="lineNum">    1591 </span><span class="lineCov">        153 :                 rpid-&gt;current_cts_us = rpid-&gt;clock_at_first_pck + diff;</span>
<span class="lineNum">    1592 </span><span class="lineCov">        153 :                 rpid-&gt;clock_at_pck = ctx-&gt;clock;</span>
<span class="lineNum">    1593 </span>            : 
<span class="lineNum">    1594 </span><span class="lineCov">        153 :                 if (start) {</span>
<span class="lineNum">    1595 </span><span class="lineCov">         42 :                         rpid-&gt;clock_at_frame_start = ctx-&gt;clock;</span>
<span class="lineNum">    1596 </span><span class="lineCov">         42 :                         rpid-&gt;cts_us_at_frame_start = rpid-&gt;current_cts_us;</span>
<span class="lineNum">    1597 </span><span class="lineCov">         42 :                         rpid-&gt;cts_at_frame_start = ts;</span>
<span class="lineNum">    1598 </span>            :                 }
<span class="lineNum">    1599 </span>            : 
<span class="lineNum">    1600 </span><span class="lineCov">        153 :                 rpid-&gt;current_dur_us = pck_dur;</span>
<span class="lineNum">    1601 </span><span class="lineCov">        153 :                 if (!rpid-&gt;current_dur_us) {</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :                         rpid-&gt;current_dur_us = rpid-&gt;timescale;</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] Missing duration on segment %s, something is wrong in demux chain, will not be able to regulate correctly\n&quot;, rpid-&gt;seg_name));</span>
<span class="lineNum">    1604 </span>            :                 }
<span class="lineNum">    1605 </span><span class="lineCov">        153 :                 rpid-&gt;current_dur_us *= 1000000;</span>
<span class="lineNum">    1606 </span><span class="lineCov">        153 :                 rpid-&gt;current_dur_us /= rpid-&gt;timescale;</span>
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :         } else if (start &amp;&amp; end) {</span>
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] Missing timing on segment %s, using previous fragment timing CTS &quot;LLU&quot; duration &quot;LLU&quot; us\nSomething could be wrong in demux chain, will not be able to regulate correctly\n&quot;, rpid-&gt;seg_name, rpid-&gt;current_cts_us-rpid-&gt;clock_at_first_pck, rpid-&gt;current_dur_us));</span>
<span class="lineNum">    1609 </span>            :         } else {
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_ROUTE, (&quot;[ROUTE] Missing timing on fragment %d of segment %s, using previous fragment timing CTS &quot;LLU&quot; duration &quot;LLU&quot; us\nSomething could be wrong in demux chain, will not be able to regulate correctly\n&quot;, rpid-&gt;frag_idx, rpid-&gt;seg_name, rpid-&gt;current_cts_us-rpid-&gt;clock_at_first_pck, rpid-&gt;current_dur_us));</span>
<span class="lineNum">    1611 </span>            :         }
<span class="lineNum">    1612 </span>            : 
<span class="lineNum">    1613 </span>            : 
<span class="lineNum">    1614 </span><span class="lineCov">        153 :         rpid-&gt;res_size += rpid-&gt;pck_size;</span>
<span class="lineNum">    1615 </span>            : }
<a name="1616"><span class="lineNum">    1616 </span>            : </a>
<span class="lineNum">    1617 </span>            : 
<span class="lineNum">    1618 </span><span class="lineCov">    6266968 : static GF_Err routeout_process_service(GF_ROUTEOutCtx *ctx, ROUTEService *serv)</span>
<span class="lineNum">    1619 </span>            : {
<span class="lineNum">    1620 </span>            :         u32 i, count, nb_done;
<span class="lineNum">    1621 </span>            :         GF_Err e;
<span class="lineNum">    1622 </span>            : 
<span class="lineNum">    1623 </span><span class="lineCov">    6266968 :         e = routeout_check_service_updates(ctx, serv);</span>
<span class="lineNum">    1624 </span>            : 
<span class="lineNum">    1625 </span><span class="lineCov">    6266968 :         if (serv-&gt;stsid_bundle) {</span>
<span class="lineNum">    1626 </span><span class="lineCov">    6266956 :                 u64 diff = ctx-&gt;clock - serv-&gt;last_stsid_clock;</span>
<span class="lineNum">    1627 </span><span class="lineCov">    6266956 :                 if (diff &gt;= ctx-&gt;carousel) {</span>
<span class="lineNum">    1628 </span><span class="lineCov">         47 :                         routeout_service_send_bundle(ctx, serv);</span>
<span class="lineNum">    1629 </span><span class="lineCov">         47 :                         serv-&gt;last_stsid_clock = ctx-&gt;clock;</span>
<span class="lineNum">    1630 </span>            :                 } else {
<span class="lineNum">    1631 </span><span class="lineCov">    6266909 :                         u64 next_sched = ctx-&gt;carousel - diff;</span>
<span class="lineNum">    1632 </span><span class="lineCov">    6266909 :                         if (next_sched &lt; ctx-&gt;reschedule_us)</span>
<span class="lineNum">    1633 </span><span class="lineCov">     262616 :                                 ctx-&gt;reschedule_us = next_sched;</span>
<span class="lineNum">    1634 </span>            :                 }
<span class="lineNum">    1635 </span>            :         } else {
<span class="lineNum">    1636 </span>            :                 //not ready
<span class="lineNum">    1637 </span>            :                 return e;
<span class="lineNum">    1638 </span>            :         }
<span class="lineNum">    1639 </span>            : 
<span class="lineNum">    1640 </span>            :         nb_done = 0;
<span class="lineNum">    1641 </span><span class="lineCov">    6266956 :         count = gf_list_count(serv-&gt;pids);</span>
<span class="lineNum">    1642 </span><span class="lineCov">   22373802 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1643 </span><span class="lineCov">   16106846 :                 ROUTEPid *rpid = gf_list_get(serv-&gt;pids, i);</span>
<span class="lineNum">    1644 </span><span class="lineCov">   16106846 :                 Bool send_hls_child = rpid-&gt;update_hls_child_pl;</span>
<span class="lineNum">    1645 </span><span class="lineCov">   16106846 :                 if (rpid-&gt;manifest_type) {</span>
<span class="lineNum">    1646 </span><span class="lineCov">    6266956 :                         nb_done++;</span>
<span class="lineNum">    1647 </span><span class="lineCov">    6266956 :                         continue;</span>
<span class="lineNum">    1648 </span>            :                 }
<span class="lineNum">    1649 </span>            : 
<span class="lineNum">    1650 </span><span class="lineCov">    9839890 :                 if (ctx-&gt;reporting_on) {</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :                         if (rpid-&gt;full_frame_size) {</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :                                 ctx-&gt;total_size += rpid-&gt;full_frame_size;</span>
<span class="lineNum">    1653 </span>            :                         } else {
<span class="lineNum">    1654 </span><span class="lineNoCov">          0 :                                 ctx-&gt;total_size += rpid-&gt;pck_size;</span>
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :                                 ctx-&gt;total_size_unknown = GF_TRUE;</span>
<span class="lineNum">    1656 </span>            :                         }
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :                         ctx-&gt;total_bytes += rpid-&gt;pck_offset;</span>
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 :                         ctx-&gt;nb_resources++;</span>
<span class="lineNum">    1659 </span>            :                 }
<span class="lineNum">    1660 </span>            : 
<span class="lineNum">    1661 </span><span class="lineCov">    9839890 : next_packet:</span>
<span class="lineNum">    1662 </span>            : 
<span class="lineNum">    1663 </span><span class="lineCov">    9840039 :                 if (!rpid-&gt;current_pck) {</span>
<span class="lineNum">    1664 </span>            :                         u32 offset;
<span class="lineNum">    1665 </span><span class="lineCov">       1095 :                         routeout_fetch_packet(ctx, rpid);</span>
<span class="lineNum">    1666 </span><span class="lineCov">       1095 :                         if (!rpid-&gt;current_pck) {</span>
<span class="lineNum">    1667 </span><span class="lineCov">        942 :                                 if (gf_filter_pid_is_eos(rpid-&gt;pid))</span>
<span class="lineNum">    1668 </span><span class="lineCov">          5 :                                         nb_done++;</span>
<span class="lineNum">    1669 </span><span class="lineCov">        942 :                                 continue;</span>
<span class="lineNum">    1670 </span>            :                         }
<span class="lineNum">    1671 </span>            : 
<span class="lineNum">    1672 </span><span class="lineCov">        153 :                         if (ctx-&gt;reporting_on) {</span>
<span class="lineNum">    1673 </span><span class="lineNoCov">          0 :                                 if (rpid-&gt;full_frame_size) {</span>
<span class="lineNum">    1674 </span><span class="lineNoCov">          0 :                                         ctx-&gt;total_size += rpid-&gt;full_frame_size;</span>
<span class="lineNum">    1675 </span>            :                                 } else {
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :                                         ctx-&gt;total_size += rpid-&gt;pck_size;</span>
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :                                         ctx-&gt;total_size_unknown = GF_TRUE;</span>
<span class="lineNum">    1678 </span>            :                                 }
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :                                 ctx-&gt;nb_resources++;</span>
<span class="lineNum">    1680 </span>            :                         }
<span class="lineNum">    1681 </span>            : 
<span class="lineNum">    1682 </span><span class="lineCov">        153 :                         if (rpid-&gt;push_init) {</span>
<span class="lineNum">    1683 </span><span class="lineCov">         42 :                                 rpid-&gt;push_init = GF_FALSE;</span>
<span class="lineNum">    1684 </span>            :                                 send_hls_child = GF_TRUE;
<span class="lineNum">    1685 </span><span class="lineCov">         42 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_ROUTE, (&quot;[ROUTE] Sending init segment %s\n&quot;, rpid-&gt;init_seg_name));</span>
<span class="lineNum">    1686 </span>            : 
<span class="lineNum">    1687 </span>            :                                 //send init asap
<span class="lineNum">    1688 </span>            :                                 offset = 0;
<span class="lineNum">    1689 </span><span class="lineCov">         84 :                                 while (offset &lt; rpid-&gt;init_seg_size) {</span>
<span class="lineNum">    1690 </span>            :                                         //we use codepoint 5 (new IS) or 7 (repeated IS)
<span class="lineNum">    1691 </span>            :                                         u32 codepoint;
<span class="lineNum">    1692 </span><span class="lineCov">         42 :                                         if (rpid-&gt;init_seg_sent) {</span>
<span class="lineNum">    1693 </span>            :                                                 codepoint = 7;
<span class="lineNum">    1694 </span>            :                                         } else {
<span class="lineNum">    1695 </span><span class="lineCov">         42 :                                                 rpid-&gt;init_seg_sent = GF_FALSE;</span>
<span class="lineNum">    1696 </span>            :                                                 codepoint = 5;
<span class="lineNum">    1697 </span>            :                                         }
<span class="lineNum">    1698 </span><span class="lineCov">         42 :                                         offset += routeout_lct_send(ctx, rpid-&gt;rlct-&gt;sock, rpid-&gt;tsi, ROUTE_INIT_TOI, codepoint, (u8 *) rpid-&gt;init_seg_data, rpid-&gt;init_seg_size, offset, serv-&gt;service_id, rpid-&gt;init_seg_size, offset);</span>
<span class="lineNum">    1699 </span>            :                                 }
<span class="lineNum">    1700 </span><span class="lineCov">         42 :                                 if (ctx-&gt;reporting_on) {</span>
<span class="lineNum">    1701 </span><span class="lineNoCov">          0 :                                         ctx-&gt;total_size += rpid-&gt;init_seg_size;</span>
<span class="lineNum">    1702 </span><span class="lineNoCov">          0 :                                         ctx-&gt;total_bytes = rpid-&gt;init_seg_size;</span>
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :                                         ctx-&gt;nb_resources++;</span>
<span class="lineNum">    1704 </span>            :                                 }
<span class="lineNum">    1705 </span>            :                         }
<span class="lineNum">    1706 </span>            :                 }
<span class="lineNum">    1707 </span>            :                 //send child m3u8 asap
<span class="lineNum">    1708 </span><span class="lineCov">    9839055 :                 if (send_hls_child &amp;&amp; rpid-&gt;hld_child_pl) {</span>
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :                         u32 hls_len = (u32) strlen(rpid-&gt;hld_child_pl);</span>
<span class="lineNum">    1710 </span>            :                         u32 offset = 0;
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_INFO, GF_LOG_ROUTE, (&quot;[ROUTE] Sending HLS sub playlist %s: \n%s\n&quot;, rpid-&gt;hld_child_pl_name, rpid-&gt;hld_child_pl));</span>
<span class="lineNum">    1712 </span>            : 
<span class="lineNum">    1713 </span><span class="lineNoCov">          0 :                         while (offset &lt; hls_len) {</span>
<span class="lineNum">    1714 </span>            :                                 //we use codepoint 1 (NRT - file mode) for subplaylists
<span class="lineNum">    1715 </span><span class="lineNoCov">          0 :                                 offset += routeout_lct_send(ctx, rpid-&gt;rlct-&gt;sock, rpid-&gt;tsi, ROUTE_INIT_TOI-1, 1, (u8 *) rpid-&gt;hld_child_pl, hls_len, offset, serv-&gt;service_id, hls_len, offset);</span>
<span class="lineNum">    1716 </span>            :                         }
<span class="lineNum">    1717 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;reporting_on) {</span>
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 :                                 ctx-&gt;total_size += hls_len;</span>
<span class="lineNum">    1719 </span><span class="lineNoCov">          0 :                                 ctx-&gt;total_bytes = hls_len;</span>
<span class="lineNum">    1720 </span><span class="lineNoCov">          0 :                                 ctx-&gt;nb_resources++;</span>
<span class="lineNum">    1721 </span>            :                         }
<span class="lineNum">    1722 </span><span class="lineNoCov">          0 :                         rpid-&gt;update_hls_child_pl = GF_FALSE;</span>
<span class="lineNum">    1723 </span>            :                 }
<span class="lineNum">    1724 </span>            : 
<span class="lineNum">    1725 </span><span class="lineCov">    9843342 :                 while ((rpid-&gt;pck_offset &lt; rpid-&gt;pck_size) || rpid-&gt;force_tol_send) {</span>
<span class="lineNum">    1726 </span>            :                         u32 sent, codepoint;
<span class="lineNum">    1727 </span>            :                         //we have timing info, let's regulate
<span class="lineNum">    1728 </span><span class="lineCov">    9843193 :                         if (rpid-&gt;current_cts_us!=GF_FILTER_NO_TS) {</span>
<span class="lineNum">    1729 </span>            :                                 u64 cur_time_us;
<span class="lineNum">    1730 </span><span class="lineCov">    9843193 :                                 ctx-&gt;clock = gf_sys_clock_high_res();</span>
<span class="lineNum">    1731 </span>            :                                 //carousel, not yet ready
<span class="lineNum">    1732 </span><span class="lineCov">    9843193 :                                 if (ctx-&gt;clock &lt; rpid-&gt;clock_at_frame_start)</span>
<span class="lineNum">    1733 </span>            :                                         break;
<span class="lineNum">    1734 </span>            : 
<span class="lineNum">    1735 </span>            :                                 //send delay proportionnal to send progress - ultimately we should follow the frame timing, not the segment timing
<span class="lineNum">    1736 </span>            :                                 //but for the time being we only push complete segments (no LL)
<span class="lineNum">    1737 </span>            :                                 //it may happen that pck_size is 0 (last_chunk=0) when we force sending a TOL
<span class="lineNum">    1738 </span><span class="lineCov">    9843193 :                                 if (!ctx-&gt;noreg &amp;&amp; rpid-&gt;pck_size) {</span>
<span class="lineNum">    1739 </span><span class="lineCov">    9843193 :                                         cur_time_us = rpid-&gt;pck_offset;</span>
<span class="lineNum">    1740 </span><span class="lineCov">    9843193 :                                         cur_time_us *= rpid-&gt;current_dur_us;</span>
<span class="lineNum">    1741 </span><span class="lineCov">    9843193 :                                         cur_time_us /= rpid-&gt;pck_size;</span>
<span class="lineNum">    1742 </span><span class="lineCov">    9843193 :                                         cur_time_us += rpid-&gt;current_cts_us;</span>
<span class="lineNum">    1743 </span>            : 
<span class="lineNum">    1744 </span><span class="lineCov">    9843193 :                                         if (cur_time_us &gt; ctx-&gt;clock ) {</span>
<span class="lineNum">    1745 </span><span class="lineCov">    9838948 :                                                 u64 next_sched = (cur_time_us - ctx-&gt;clock) / 2;</span>
<span class="lineNum">    1746 </span><span class="lineCov">    9838948 :                                                 if (next_sched &lt; ctx-&gt;reschedule_us)</span>
<span class="lineNum">    1747 </span><span class="lineCov">    7667670 :                                                         ctx-&gt;reschedule_us = next_sched;</span>
<span class="lineNum">    1748 </span>            :                                                 break;
<span class="lineNum">    1749 </span>            :                                         }
<span class="lineNum">    1750 </span>            :                                 }
<span class="lineNum">    1751 </span>            :                         }
<span class="lineNum">    1752 </span>            :                         //we use codepoint 8 (media segment, file mode) for media segments, otherwise as listed in S-TSID
<span class="lineNum">    1753 </span><span class="lineCov">       4245 :                         codepoint = rpid-&gt;raw_file ? rpid-&gt;fmtp : 8;</span>
<span class="lineNum">    1754 </span><span class="lineCov">       4245 :                         sent = routeout_lct_send(ctx, rpid-&gt;rlct-&gt;sock, rpid-&gt;tsi, rpid-&gt;current_toi, codepoint, (u8 *) rpid-&gt;pck_data, rpid-&gt;pck_size, rpid-&gt;pck_offset, serv-&gt;service_id, rpid-&gt;full_frame_size, rpid-&gt;pck_offset + rpid-&gt;frag_offset);</span>
<span class="lineNum">    1755 </span><span class="lineCov">       4245 :                         rpid-&gt;pck_offset += sent;</span>
<span class="lineNum">    1756 </span><span class="lineCov">       4245 :                         if (ctx-&gt;reporting_on) {</span>
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 :                                 ctx-&gt;total_bytes += sent;</span>
<span class="lineNum">    1758 </span>            :                         }
<span class="lineNum">    1759 </span><span class="lineCov">       4245 :                         rpid-&gt;force_tol_send = GF_FALSE;</span>
<span class="lineNum">    1760 </span>            :                 }
<span class="lineNum">    1761 </span>            :                 assert (rpid-&gt;pck_offset &lt;= rpid-&gt;pck_size);
<span class="lineNum">    1762 </span>            : 
<span class="lineNum">    1763 </span><span class="lineCov">    9839097 :                 if (rpid-&gt;pck_offset == rpid-&gt;pck_size) {</span>
<span class="lineNum">    1764 </span>            :                         //print fragment push info except if single fragment
<span class="lineNum">    1765 </span><span class="lineCov">        149 :                         if (rpid-&gt;frag_idx || !rpid-&gt;full_frame_size) {</span>
<span class="lineNum">    1766 </span><span class="lineCov">        129 :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_ROUTE, (&quot;[ROUTE] pushed fragment %s#%d (%d bytes) in &quot;LLU&quot; us - target push &quot;LLU&quot; us\n&quot;, rpid-&gt;seg_name, rpid-&gt;frag_idx+1, rpid-&gt;pck_size, ctx-&gt;clock - rpid-&gt;clock_at_pck, rpid-&gt;current_dur_us));</span>
<span class="lineNum">    1767 </span>            :                         }
<span class="lineNum">    1768 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">    1769 </span>            :                         //print full object push info
<span class="lineNum">    1770 </span><span class="lineCov">        149 :                         if (rpid-&gt;full_frame_size &amp;&amp; (gf_log_get_tool_level(GF_LOG_ROUTE)&gt;=GF_LOG_INFO)) {</span>
<span class="lineNum">    1771 </span>            :                                 char szFInfo[1000], szSID[31];
<span class="lineNum">    1772 </span>            :                                 u64 seg_clock, target_push_dur;
<span class="lineNum">    1773 </span>            : 
<span class="lineNum">    1774 </span><span class="lineCov">         18 :                                 if (rpid-&gt;pck_dur_at_frame_start) {</span>
<span class="lineNum">    1775 </span><span class="lineCov">         14 :                                         target_push_dur = rpid-&gt;pck_dur_at_frame_start;</span>
<span class="lineNum">    1776 </span><span class="lineCov">         14 :                                         target_push_dur *= 1000000;</span>
<span class="lineNum">    1777 </span><span class="lineCov">         14 :                                         target_push_dur /= rpid-&gt;timescale;</span>
<span class="lineNum">    1778 </span>            :                                 } else {
<span class="lineNum">    1779 </span><span class="lineCov">          4 :                                         target_push_dur = rpid-&gt;current_dur_us + rpid-&gt;current_cts_us - rpid-&gt;cts_us_at_frame_start;</span>
<span class="lineNum">    1780 </span>            :                                 }
<span class="lineNum">    1781 </span><span class="lineCov">         18 :                                 if (ctx-&gt;sock_atsc_lls) {</span>
<span class="lineNum">    1782 </span><span class="lineNoCov">          0 :                                         snprintf(szSID, 20, &quot;Service%d &quot;, serv-&gt;service_id);</span>
<span class="lineNum">    1783 </span><span class="lineNoCov">          0 :                                         szSID[30] = 0;</span>
<span class="lineNum">    1784 </span>            :                                 }
<span class="lineNum">    1785 </span>            :                                 else
<span class="lineNum">    1786 </span><span class="lineCov">         18 :                                         szSID[0] = 0;</span>
<span class="lineNum">    1787 </span>            : 
<span class="lineNum">    1788 </span><span class="lineCov">         18 :                                 if (rpid-&gt;frag_idx)</span>
<span class="lineNum">    1789 </span><span class="lineCov">         18 :                                         snprintf(szFInfo, 100, &quot;%s%s (%d frags %d bytes)&quot;, szSID, rpid-&gt;seg_name, rpid-&gt;frag_idx+1, rpid-&gt;full_frame_size);</span>
<span class="lineNum">    1790 </span>            :                                 else
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :                                         snprintf(szFInfo, 100, &quot;%s%s (%d bytes)&quot;, szSID, rpid-&gt;seg_name, rpid-&gt;full_frame_size);</span>
<span class="lineNum">    1792 </span>            : 
<span class="lineNum">    1793 </span><span class="lineCov">         18 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_ROUTE, (&quot;[ROUTE] Pushed %s in &quot;LLU&quot; us - target push &quot;LLU&quot; us\n&quot;, szFInfo, ctx-&gt;clock - rpid-&gt;clock_at_frame_start, target_push_dur));</span>
<span class="lineNum">    1794 </span>            : 
<span class="lineNum">    1795 </span>            :                                 //real-time stream, check we are not out of sync
<span class="lineNum">    1796 </span><span class="lineCov">         18 :                                 if (!rpid-&gt;raw_file) {</span>
<span class="lineNum">    1797 </span>            :                                         //clock time is the clock at first pck of first seg + cts_diff(cur_seg, first_seg)
<span class="lineNum">    1798 </span><span class="lineCov">         18 :                                         seg_clock = rpid-&gt;cts_us_at_frame_start + target_push_dur;</span>
<span class="lineNum">    1799 </span>            : 
<span class="lineNum">    1800 </span>            :                                         //if segment clock time is greater than clock, we've been pushing too fast
<span class="lineNum">    1801 </span><span class="lineCov">         18 :                                         if (seg_clock &gt; ctx-&gt;clock) {</span>
<span class="lineNum">    1802 </span><span class="lineCov">         17 :                                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_ROUTE, (&quot;[ROUTE] Segment %s pushed early by &quot;LLU&quot; us\n&quot;, rpid-&gt;seg_name, seg_clock - ctx-&gt;clock));</span>
<span class="lineNum">    1803 </span>            :                                         }
<span class="lineNum">    1804 </span>            :                                         //otherwise we've been pushing too slowly
<span class="lineNum">    1805 </span><span class="lineCov">          1 :                                         else if (ctx-&gt;clock &gt; 1000 + seg_clock) {</span>
<span class="lineNum">    1806 </span><span class="lineCov">          1 :                                                 GF_LOG(GF_LOG_INFO, GF_LOG_ROUTE, (&quot;[ROUTE] Segment %s pushed too late by &quot;LLU&quot; us\n&quot;, rpid-&gt;seg_name, ctx-&gt;clock - seg_clock));</span>
<span class="lineNum">    1807 </span>            :                                         }
<span class="lineNum">    1808 </span>            : 
<span class="lineNum">    1809 </span><span class="lineCov">         18 :                                         if (rpid-&gt;pck_dur_at_frame_start &amp;&amp; ctx-&gt;llmode) {</span>
<span class="lineNum">    1810 </span><span class="lineCov">         14 :                                                 u64 seg_rate = rpid-&gt;full_frame_size * 8;</span>
<span class="lineNum">    1811 </span><span class="lineCov">         14 :                                                 seg_rate *= rpid-&gt;timescale;</span>
<span class="lineNum">    1812 </span><span class="lineCov">         14 :                                                 seg_rate /= rpid-&gt;pck_dur_at_frame_start;</span>
<span class="lineNum">    1813 </span>            : 
<span class="lineNum">    1814 </span><span class="lineCov">         14 :                                                 if (seg_rate &gt; rpid-&gt;bitrate) {</span>
<span class="lineNum">    1815 </span><span class="lineCov">          3 :                                                         GF_LOG(GF_LOG_WARNING, GF_LOG_ROUTE, (&quot;[ROUTE] Segment %s rate &quot;LLU&quot; but stream rate &quot;LLU&quot;, updating bitrate\n&quot;, rpid-&gt;seg_name, seg_rate, rpid-&gt;bitrate));</span>
<span class="lineNum">    1816 </span><span class="lineCov">          3 :                                                         rpid-&gt;bitrate = (u32) seg_rate;</span>
<span class="lineNum">    1817 </span>            :                                                 }
<span class="lineNum">    1818 </span>            :                                         }
<span class="lineNum">    1819 </span>            :                                 }
<span class="lineNum">    1820 </span>            :                         }
<span class="lineNum">    1821 </span>            : #endif
<span class="lineNum">    1822 </span>            :                         //raw file, keep on sending data if carousel period is set and no new packet
<span class="lineNum">    1823 </span><span class="lineCov">        149 :                         if (rpid-&gt;raw_file &amp;&amp; rpid-&gt;carousel_time_us) {</span>
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :                                 GF_FilterPacket *pck_next = gf_filter_pid_get_packet(rpid-&gt;pid);</span>
<span class="lineNum">    1825 </span><span class="lineNoCov">          0 :                                 if (!pck_next) {</span>
<span class="lineNum">    1826 </span><span class="lineNoCov">          0 :                                         rpid-&gt;pck_offset = 0;</span>
<span class="lineNum">    1827 </span><span class="lineNoCov">          0 :                                         rpid-&gt;current_cts_us += rpid-&gt;carousel_time_us;</span>
<span class="lineNum">    1828 </span><span class="lineNoCov">          0 :                                         rpid-&gt;clock_at_pck = rpid-&gt;current_cts_us;</span>
<span class="lineNum">    1829 </span><span class="lineNoCov">          0 :                                         rpid-&gt;clock_at_frame_start += rpid-&gt;carousel_time_us;</span>
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 :                                         rpid-&gt;cts_us_at_frame_start = rpid-&gt;current_cts_us;</span>
<span class="lineNum">    1831 </span>            :                                         //exit sending for this pid
<span class="lineNum">    1832 </span><span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">    1833 </span>            :                                 }
<span class="lineNum">    1834 </span>            :                         }
<span class="lineNum">    1835 </span><span class="lineCov">        149 :                         gf_filter_pck_unref(rpid-&gt;current_pck);</span>
<span class="lineNum">    1836 </span><span class="lineCov">        149 :                         rpid-&gt;current_pck = NULL;</span>
<span class="lineNum">    1837 </span><span class="lineCov">        149 :                         rpid-&gt;frag_offset = rpid-&gt;cumulated_frag_size;</span>
<span class="lineNum">    1838 </span><span class="lineCov">        149 :                         goto next_packet;</span>
<span class="lineNum">    1839 </span>            :                 }
<span class="lineNum">    1840 </span>            :         }
<span class="lineNum">    1841 </span><span class="lineCov">    6266956 :         serv-&gt;is_done = (nb_done==count) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1842 </span><span class="lineCov">    6266956 :         return GF_OK;</span>
<span class="lineNum">    1843 </span>            : }
<a name="1844"><span class="lineNum">    1844 </span>            : </a>
<span class="lineNum">    1845 </span>            : #define GF_TAI_UTC_OFFSET       37
<span class="lineNum">    1846 </span><span class="lineCov">    1353816 : static void routeout_send_lls(GF_ROUTEOutCtx *ctx)</span>
<span class="lineNum">    1847 </span>            : {
<span class="lineNum">    1848 </span><span class="lineCov">    1353816 :         char *payload_text = NULL;</span>
<span class="lineNum">    1849 </span>            :         u8 *payload = NULL, *pay_start;
<span class="lineNum">    1850 </span>            :         char tmp[2000];
<span class="lineNum">    1851 </span>            :         u32 i, count, len, comp_size;
<span class="lineNum">    1852 </span>            :         s32 timezone, h, m;
<span class="lineNum">    1853 </span><span class="lineCov">    1353816 :         u64 diff = ctx-&gt;clock - ctx-&gt;last_lls_clock;</span>
<span class="lineNum">    1854 </span><span class="lineCov">    1353816 :         if (diff &lt; ctx-&gt;carousel) {</span>
<span class="lineNum">    1855 </span><span class="lineCov">    1353804 :                 u64 next_sched = ctx-&gt;carousel - diff;</span>
<span class="lineNum">    1856 </span><span class="lineCov">    1353804 :                 if (next_sched &lt; ctx-&gt;reschedule_us)</span>
<span class="lineNum">    1857 </span><span class="lineCov">      76636 :                         ctx-&gt;reschedule_us = next_sched;</span>
<span class="lineNum">    1858 </span><span class="lineCov">    1353804 :                 return;</span>
<span class="lineNum">    1859 </span>            :         }
<span class="lineNum">    1860 </span><span class="lineCov">         12 :         ctx-&gt;last_lls_clock = ctx-&gt;clock;</span>
<span class="lineNum">    1861 </span>            : 
<span class="lineNum">    1862 </span><span class="lineCov">         12 :         if (!ctx-&gt;bytes_sent) ctx-&gt;clock_stats = ctx-&gt;clock;</span>
<span class="lineNum">    1863 </span>            : 
<span class="lineNum">    1864 </span>            :         //we send 2 LLS tables, SysTime and SLT
<span class="lineNum">    1865 </span>            : 
<span class="lineNum">    1866 </span>            :         //SysTime
<span class="lineNum">    1867 </span><span class="lineCov">         12 :         if (!ctx-&gt;lls_time_table) {</span>
<span class="lineNum">    1868 </span><span class="lineCov">          2 :                 gf_dynstrcat(&amp;payload_text, &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&lt;SystemTime currentUtcOffset=\&quot;&quot;, NULL);</span>
<span class="lineNum">    1869 </span>            :                 sprintf(tmp, &quot;%d&quot;, GF_TAI_UTC_OFFSET);
<span class="lineNum">    1870 </span><span class="lineCov">          2 :                 gf_dynstrcat(&amp;payload_text, tmp, NULL);</span>
<span class="lineNum">    1871 </span><span class="lineCov">          2 :                 gf_dynstrcat(&amp;payload_text, &quot;\&quot; utcLocalOffset=\&quot;&quot;, NULL);</span>
<span class="lineNum">    1872 </span><span class="lineCov">          2 :                 timezone = -gf_net_get_timezone() / 60;</span>
<span class="lineNum">    1873 </span><span class="lineCov">          2 :                 h = timezone / 60;</span>
<span class="lineNum">    1874 </span><span class="lineCov">          2 :                 m = timezone - h*60;</span>
<span class="lineNum">    1875 </span><span class="lineCov">          2 :                 if (m)</span>
<span class="lineNum">    1876 </span><span class="lineNoCov">          0 :                         sprintf(tmp, &quot;%sPT%dH%dM&quot;, (h&lt;0) ? &quot;-&quot; : &quot;&quot;, ABS(h), m);</span>
<span class="lineNum">    1877 </span>            :                 else
<span class="lineNum">    1878 </span><span class="lineCov">          2 :                         sprintf(tmp, &quot;%sPT%dH&quot;, (h&lt;0) ? &quot;-&quot; : &quot;&quot;, ABS(h));</span>
<span class="lineNum">    1879 </span><span class="lineCov">          2 :                 gf_dynstrcat(&amp;payload_text, tmp, NULL);</span>
<span class="lineNum">    1880 </span><span class="lineCov">          2 :                 gf_dynstrcat(&amp;payload_text, &quot;\&quot; dsStatus=\&quot;&quot;, NULL);</span>
<span class="lineNum">    1881 </span><span class="lineCov">          2 :                 gf_dynstrcat(&amp;payload_text, gf_net_time_is_dst() ? &quot;true&quot; : &quot;false&quot;, NULL);</span>
<span class="lineNum">    1882 </span><span class="lineCov">          2 :                 gf_dynstrcat(&amp;payload_text, &quot;\&quot;/&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1883 </span>            : 
<span class="lineNum">    1884 </span><span class="lineCov">          2 :                 GF_LOG(GF_LOG_INFO, GF_LOG_ROUTE, (&quot;[ROUTE] Updating ATSC3 LLS.SysTime:\n%s\n&quot;, payload_text));</span>
<span class="lineNum">    1885 </span><span class="lineCov">          2 :                 len = (u32) strlen(payload_text);</span>
<span class="lineNum">    1886 </span><span class="lineCov">          2 :                 comp_size = 2*len;</span>
<span class="lineNum">    1887 </span><span class="lineCov">          2 :                 payload = gf_malloc(sizeof(char)*(comp_size+4));</span>
<span class="lineNum">    1888 </span><span class="lineCov">          2 :                 pay_start = payload + 4;</span>
<span class="lineNum">    1889 </span><span class="lineCov">          2 :                 gf_gz_compress_payload_ex((u8 **) &amp;payload_text, len, &amp;comp_size, 0, GF_FALSE, &amp;pay_start);</span>
<span class="lineNum">    1890 </span><span class="lineCov">          2 :                 gf_free(payload_text);</span>
<span class="lineNum">    1891 </span><span class="lineCov">          2 :                 payload_text = NULL;</span>
<span class="lineNum">    1892 </span>            : 
<span class="lineNum">    1893 </span><span class="lineCov">          2 :                 comp_size += 4;</span>
<span class="lineNum">    1894 </span>            :                 //format header
<span class="lineNum">    1895 </span><span class="lineCov">          2 :                 payload[0] = 3; //tableID</span>
<span class="lineNum">    1896 </span><span class="lineCov">          2 :                 payload[1] = 0; //groupid</span>
<span class="lineNum">    1897 </span><span class="lineCov">          2 :                 payload[2] = 0; //lls_group_count_minus_one</span>
<span class="lineNum">    1898 </span><span class="lineCov">          2 :                 payload[3] = 1; //lls_table_version</span>
<span class="lineNum">    1899 </span>            : 
<span class="lineNum">    1900 </span><span class="lineCov">          2 :                 ctx-&gt;lls_time_table = payload;</span>
<span class="lineNum">    1901 </span><span class="lineCov">          2 :                 ctx-&gt;lls_time_table_len = comp_size;</span>
<span class="lineNum">    1902 </span>            :         }
<span class="lineNum">    1903 </span>            : 
<span class="lineNum">    1904 </span><span class="lineCov">         12 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_ROUTE, (&quot;[ROUTE] Sending ATSC3 LLS.SysTime\n&quot;));</span>
<span class="lineNum">    1905 </span><span class="lineCov">         12 :         gf_sk_send(ctx-&gt;sock_atsc_lls, ctx-&gt;lls_time_table, ctx-&gt;lls_time_table_len);</span>
<span class="lineNum">    1906 </span><span class="lineCov">         12 :         ctx-&gt;bytes_sent += ctx-&gt;lls_time_table_len;</span>
<span class="lineNum">    1907 </span>            : 
<span class="lineNum">    1908 </span>            :         //SLT
<span class="lineNum">    1909 </span><span class="lineCov">         12 :         if (!ctx-&gt;lls_slt_table) {</span>
<span class="lineNum">    1910 </span><span class="lineCov">          2 :                 count = gf_list_count(ctx-&gt;services);</span>
<span class="lineNum">    1911 </span><span class="lineCov">          2 :                 snprintf(tmp, 1000, &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&lt;SLT bsid=\&quot;%d\&quot;&gt;\n&quot;, ctx-&gt;bsid);</span>
<span class="lineNum">    1912 </span><span class="lineCov">          2 :                 gf_dynstrcat(&amp;payload_text, tmp, NULL);</span>
<span class="lineNum">    1913 </span><span class="lineCov">          4 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1914 </span>            :                         const GF_PropertyValue *p;
<span class="lineNum">    1915 </span>            :                         const char *src_ip, *service_name;
<span class="lineNum">    1916 </span>            :                         char szIP[GF_MAX_IP_NAME_LEN];
<span class="lineNum">    1917 </span>            :                         ROUTEPid *rpid;
<span class="lineNum">    1918 </span><span class="lineCov">          2 :                         ROUTEService *serv = gf_list_get(ctx-&gt;services, i);</span>
<span class="lineNum">    1919 </span><span class="lineCov">          2 :                         u32 sid = serv-&gt;service_id;</span>
<span class="lineNum">    1920 </span><span class="lineCov">          2 :                         if (!sid) sid = 1;</span>
<span class="lineNum">    1921 </span>            : 
<span class="lineNum">    1922 </span><span class="lineCov">          2 :                         rpid = gf_list_get(serv-&gt;pids, 0);</span>
<span class="lineNum">    1923 </span><span class="lineCov">          2 :                         p = gf_filter_pid_get_property_str(rpid-&gt;pid, &quot;ShortServiceName&quot;);</span>
<span class="lineNum">    1924 </span><span class="lineCov">          2 :                         if (!p)</span>
<span class="lineNum">    1925 </span><span class="lineCov">          2 :                                 p = gf_filter_pid_get_property(rpid-&gt;pid, GF_PROP_PID_SERVICE_NAME);</span>
<span class="lineNum">    1926 </span><span class="lineCov">          2 :                         service_name = (p &amp;&amp; p-&gt;value.string) ? p-&gt;value.string : &quot;GPAC&quot;;</span>
<span class="lineNum">    1927 </span><span class="lineCov">          2 :                         len = (u32) strlen(service_name);</span>
<span class="lineNum">    1928 </span><span class="lineCov">          2 :                         if (len&gt;7) len = 7;</span>
<span class="lineNum">    1929 </span><span class="lineCov">          2 :                         strncpy(szIP, service_name, len);</span>
<span class="lineNum">    1930 </span><span class="lineCov">          2 :                         szIP[len] = 0;</span>
<span class="lineNum">    1931 </span>            : 
<span class="lineNum">    1932 </span><span class="lineCov">          2 :                         snprintf(tmp, 2000,</span>
<span class="lineNum">    1933 </span>            :                                 &quot; &lt;Service serviceId=\&quot;%d\&quot; sltSvcSeqNum=\&quot;0 \&quot; serviceCategory=\&quot;1\&quot; globalServiceId=\&quot;urn:gpac:atsc:serviceid:%d.%d\&quot; majorChannelNo=\&quot;666\&quot; minorChannelNo=\&quot;666\&quot; shortServiceName=\&quot;%s\&quot;&gt;\n&quot;, sid, ctx-&gt;bsid, sid, szIP);
<span class="lineNum">    1934 </span><span class="lineCov">          2 :                         gf_dynstrcat(&amp;payload_text, tmp, NULL);</span>
<span class="lineNum">    1935 </span>            : 
<span class="lineNum">    1936 </span><span class="lineCov">          2 :                         src_ip = ctx-&gt;ifce;</span>
<span class="lineNum">    1937 </span><span class="lineCov">          2 :                         if (!src_ip) {</span>
<span class="lineNum">    1938 </span><span class="lineCov">          2 :                                 gf_sk_get_local_ip(serv-&gt;rlct_base-&gt;sock, szIP);</span>
<span class="lineNum">    1939 </span>            :                                 src_ip = szIP;
<span class="lineNum">    1940 </span>            :                         }
<span class="lineNum">    1941 </span><span class="lineCov">          2 :                         int res = snprintf(tmp, 1000, &quot;  &lt;BroadcastSvcSignaling slsProtocol=\&quot;1\&quot; slsDestinationIpAddress=\&quot;%s\&quot; slsDestinationUdpPort=\&quot;%d\&quot; slsSourceIpAddress=\&quot;%s\&quot;/&gt;\n&quot;</span>
<span class="lineNum">    1942 </span><span class="lineCov">          2 :                                 &quot; &lt;/Service&gt;\n&quot;, serv-&gt;rlct_base-&gt;ip, serv-&gt;rlct_base-&gt;port, src_ip);</span>
<span class="lineNum">    1943 </span><span class="lineCov">          2 :                         if (res&lt;0) {</span>
<span class="lineNum">    1944 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_ROUTE, (&quot;[ROUTE] String truncated will trying to write: &lt;BroadcastSvcSignaling slsProtocol=\&quot;1\&quot; slsDestinationIpAddress=\&quot;%s\&quot; slsDestinationUdpPort=\&quot;%d\&quot; slsSourceIpAddress=\&quot;%s\&quot;/&gt;\n&quot;, serv-&gt;rlct_base-&gt;ip, serv-&gt;rlct_base-&gt;port, src_ip));</span>
<span class="lineNum">    1945 </span>            :                         }
<span class="lineNum">    1946 </span><span class="lineCov">          2 :                         gf_dynstrcat(&amp;payload_text, tmp, NULL);</span>
<span class="lineNum">    1947 </span>            :                 }
<span class="lineNum">    1948 </span><span class="lineCov">          2 :                 gf_dynstrcat(&amp;payload_text, &quot;&lt;/SLT&gt;\n&quot;, NULL);</span>
<span class="lineNum">    1949 </span>            : 
<span class="lineNum">    1950 </span><span class="lineCov">          2 :                 GF_LOG(GF_LOG_INFO, GF_LOG_ROUTE, (&quot;[ROUTE] Updating ATSC3 LLS.SLT:\n%s\n&quot;, payload_text));</span>
<span class="lineNum">    1951 </span>            : 
<span class="lineNum">    1952 </span><span class="lineCov">          2 :                 len = (u32) strlen(payload_text);</span>
<span class="lineNum">    1953 </span><span class="lineCov">          2 :                 comp_size = 2*len;</span>
<span class="lineNum">    1954 </span><span class="lineCov">          2 :                 payload = gf_malloc(sizeof(char)*(comp_size+4));</span>
<span class="lineNum">    1955 </span><span class="lineCov">          2 :                 pay_start = payload + 4;</span>
<span class="lineNum">    1956 </span><span class="lineCov">          2 :                 gf_gz_compress_payload_ex((u8 **) &amp;payload_text, len, &amp;comp_size, 0, GF_FALSE, &amp;pay_start);</span>
<span class="lineNum">    1957 </span><span class="lineCov">          2 :                 gf_free(payload_text);</span>
<span class="lineNum">    1958 </span><span class="lineCov">          2 :                 payload_text = NULL;</span>
<span class="lineNum">    1959 </span>            : 
<span class="lineNum">    1960 </span><span class="lineCov">          2 :                 comp_size += 4;</span>
<span class="lineNum">    1961 </span>            :                 //format header
<span class="lineNum">    1962 </span><span class="lineCov">          2 :                 payload[0] = 1; //tableID</span>
<span class="lineNum">    1963 </span><span class="lineCov">          2 :                 payload[1] = 0; //groupid</span>
<span class="lineNum">    1964 </span><span class="lineCov">          2 :                 payload[2] = 0; //lls_group_count_minus_one</span>
<span class="lineNum">    1965 </span><span class="lineCov">          2 :                 payload[3] = 1; //lls_table_version</span>
<span class="lineNum">    1966 </span>            : 
<span class="lineNum">    1967 </span><span class="lineCov">          2 :                 ctx-&gt;lls_slt_table = payload;</span>
<span class="lineNum">    1968 </span><span class="lineCov">          2 :                 ctx-&gt;lls_slt_table_len = comp_size;</span>
<span class="lineNum">    1969 </span>            :         }
<span class="lineNum">    1970 </span>            : 
<span class="lineNum">    1971 </span><span class="lineCov">         12 :         GF_LOG(GF_LOG_INFO, GF_LOG_ROUTE, (&quot;[ROUTE] Sending ATSC3 LLS SysTime and SLT\n&quot;));</span>
<span class="lineNum">    1972 </span><span class="lineCov">         12 :         gf_sk_send(ctx-&gt;sock_atsc_lls, ctx-&gt;lls_slt_table, ctx-&gt;lls_slt_table_len);</span>
<span class="lineNum">    1973 </span><span class="lineCov">         12 :         ctx-&gt;bytes_sent += ctx-&gt;lls_slt_table_len;</span>
<a name="1974"><span class="lineNum">    1974 </span>            : }</a>
<span class="lineNum">    1975 </span>            : 
<span class="lineNum">    1976 </span><span class="lineCov">    6267146 : static GF_Err routeout_process(GF_Filter *filter)</span>
<span class="lineNum">    1977 </span>            : {
<span class="lineNum">    1978 </span>            :         GF_Err e = GF_OK;
<span class="lineNum">    1979 </span>            :         u32 i, count;
<span class="lineNum">    1980 </span>            :         Bool all_serv_done = GF_TRUE;
<span class="lineNum">    1981 </span><span class="lineCov">    6267146 :         GF_ROUTEOutCtx *ctx = (GF_ROUTEOutCtx *) gf_filter_get_udta(filter);</span>
<span class="lineNum">    1982 </span>            : 
<span class="lineNum">    1983 </span><span class="lineCov">    6267146 :         ctx-&gt;clock = gf_sys_clock_high_res();</span>
<span class="lineNum">    1984 </span><span class="lineCov">    6267146 :         ctx-&gt;reschedule_us = MIN(ctx-&gt;carousel, 50000);</span>
<span class="lineNum">    1985 </span><span class="lineCov">    6267146 :         ctx-&gt;reporting_on = gf_filter_reporting_enabled(filter);</span>
<span class="lineNum">    1986 </span><span class="lineCov">    6267146 :         if (ctx-&gt;reporting_on) {</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :                 ctx-&gt;total_size_unknown = GF_FALSE;</span>
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :                 ctx-&gt;total_size = 0;</span>
<span class="lineNum">    1989 </span><span class="lineNoCov">          0 :                 ctx-&gt;total_bytes = GF_FALSE;</span>
<span class="lineNum">    1990 </span><span class="lineNoCov">          0 :                 ctx-&gt;nb_resources = 0;</span>
<span class="lineNum">    1991 </span>            :         }
<span class="lineNum">    1992 </span>            : 
<span class="lineNum">    1993 </span><span class="lineCov">    6267146 :         if (ctx-&gt;runfor) {</span>
<span class="lineNum">    1994 </span><span class="lineCov">    3573042 :                 if (ctx-&gt;clock - ctx-&gt;clock_init &gt; ctx-&gt;runfor*1000) {</span>
<span class="lineNum">    1995 </span><span class="lineCov">         99 :                         if (!ctx-&gt;done) {</span>
<span class="lineNum">    1996 </span><span class="lineCov">          2 :                                 ctx-&gt;done = GF_TRUE;</span>
<span class="lineNum">    1997 </span><span class="lineCov">          2 :                                 count = gf_filter_get_ipid_count(filter);</span>
<span class="lineNum">    1998 </span><span class="lineCov">          8 :                                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1999 </span>            :                                         GF_FilterEvent evt;
<span class="lineNum">    2000 </span><span class="lineCov">          6 :                                         GF_FilterPid *pid = gf_filter_get_ipid(filter, i);</span>
<span class="lineNum">    2001 </span><span class="lineCov">          6 :                                         GF_FEVT_INIT(evt, GF_FEVT_STOP, pid);</span>
<span class="lineNum">    2002 </span><span class="lineCov">          6 :                                         gf_filter_pid_send_event(pid, &amp;evt);</span>
<span class="lineNum">    2003 </span><span class="lineCov">          6 :                                         gf_filter_pid_set_discard(pid, GF_TRUE);</span>
<span class="lineNum">    2004 </span>            :                                 }
<span class="lineNum">    2005 </span>            :                         }
<span class="lineNum">    2006 </span>            :                         return GF_EOS;
<span class="lineNum">    2007 </span>            :                 }
<span class="lineNum">    2008 </span>            :         }
<span class="lineNum">    2009 </span>            : 
<span class="lineNum">    2010 </span><span class="lineCov">    6267047 :         if (ctx-&gt;sock_atsc_lls)</span>
<span class="lineNum">    2011 </span><span class="lineCov">    1353816 :                 routeout_send_lls(ctx);</span>
<span class="lineNum">    2012 </span>            : 
<span class="lineNum">    2013 </span><span class="lineCov">    6267047 :         count = gf_list_count(ctx-&gt;services);</span>
<span class="lineNum">    2014 </span><span class="lineCov">   12534094 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2015 </span><span class="lineCov">    6267047 :                 ROUTEService *serv = gf_list_get(ctx-&gt;services, i);</span>
<span class="lineNum">    2016 </span><span class="lineCov">    6267047 :                 if (!serv-&gt;is_done) {</span>
<span class="lineNum">    2017 </span><span class="lineCov">    6266968 :                         e |= routeout_process_service(ctx, serv);</span>
<span class="lineNum">    2018 </span><span class="lineCov">    6266968 :                         if (!serv-&gt;is_done)</span>
<span class="lineNum">    2019 </span>            :                                 all_serv_done = GF_FALSE;
<span class="lineNum">    2020 </span>            :                 }
<span class="lineNum">    2021 </span>            :         }
<span class="lineNum">    2022 </span>            : 
<span class="lineNum">    2023 </span><span class="lineCov">    6267047 :         if (all_serv_done) {</span>
<span class="lineNum">    2024 </span><span class="lineCov">         84 :                 return e ? e : GF_EOS;</span>
<span class="lineNum">    2025 </span>            :         }
<span class="lineNum">    2026 </span>            : 
<span class="lineNum">    2027 </span><span class="lineCov">    6266963 :         if (ctx-&gt;clock - ctx-&gt;clock_stats &gt;= 1000000) {</span>
<span class="lineNum">    2028 </span><span class="lineCov">         42 :                 u64 rate = ctx-&gt;bytes_sent * 8 * 1000 / (ctx-&gt;clock - ctx-&gt;clock_stats);</span>
<span class="lineNum">    2029 </span><span class="lineCov">         42 :                 GF_LOG(GF_LOG_INFO, GF_LOG_ROUTE, (&quot;[ROUTE] Mux rate &quot;LLU&quot; kbps\n&quot;, rate));</span>
<span class="lineNum">    2030 </span><span class="lineCov">         42 :                 if (ctx-&gt;reporting_on) {</span>
<span class="lineNum">    2031 </span>            :                         u32 progress = 0;
<span class="lineNum">    2032 </span>            :                         char szStatus[200];
<span class="lineNum">    2033 </span><span class="lineNoCov">          0 :                         if (!ctx-&gt;total_size_unknown &amp;&amp; ctx-&gt;total_bytes)</span>
<span class="lineNum">    2034 </span><span class="lineNoCov">          0 :                                 progress = (u32) (10000*ctx-&gt;total_bytes / ctx-&gt;total_size);</span>
<span class="lineNum">    2035 </span>            : 
<span class="lineNum">    2036 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;sock_atsc_lls) {</span>
<span class="lineNum">    2037 </span><span class="lineNoCov">          0 :                                 snprintf(szStatus, 200, &quot;Mux rate &quot;LLU&quot; kbps - %d services - %d active resources %.02f %% done&quot;, rate, count, ctx-&gt;nb_resources, ((Double)progress) / 100);</span>
<span class="lineNum">    2038 </span>            :                         } else {
<span class="lineNum">    2039 </span><span class="lineNoCov">          0 :                                 snprintf(szStatus, 200, &quot;Mux rate &quot;LLU&quot; kbps - %d active resources %.02f %% done&quot;, rate, ctx-&gt;nb_resources, ((Double)progress) / 100);</span>
<span class="lineNum">    2040 </span>            :                         }
<span class="lineNum">    2041 </span><span class="lineNoCov">          0 :                         gf_filter_update_status(filter, 0, szStatus);</span>
<span class="lineNum">    2042 </span>            :                 }
<span class="lineNum">    2043 </span><span class="lineCov">         42 :                 ctx-&gt;bytes_sent = 0;</span>
<span class="lineNum">    2044 </span><span class="lineCov">         42 :                 ctx-&gt;clock_stats = ctx-&gt;clock;</span>
<span class="lineNum">    2045 </span>            :         }
<span class="lineNum">    2046 </span><span class="lineCov">    6266963 :         ctx-&gt;reschedule_us++;</span>
<span class="lineNum">    2047 </span><span class="lineCov">    6266963 :         gf_filter_ask_rt_reschedule(filter, (u32) ctx-&gt;reschedule_us);</span>
<span class="lineNum">    2048 </span><span class="lineCov">    6266963 :         return e;</span>
<a name="2049"><span class="lineNum">    2049 </span>            : }</a>
<span class="lineNum">    2050 </span>            : 
<span class="lineNum">    2051 </span><span class="lineCov">       2198 : static GF_FilterProbeScore routeout_probe_url(const char *url, const char *mime)</span>
<span class="lineNum">    2052 </span>            : {
<span class="lineNum">    2053 </span><span class="lineCov">       2198 :         if (!strnicmp(url, &quot;atsc://&quot;, 7)) return GF_FPROBE_SUPPORTED;</span>
<span class="lineNum">    2054 </span><span class="lineCov">       2194 :         if (!strnicmp(url, &quot;route://&quot;, 8)) return GF_FPROBE_SUPPORTED;</span>
<a name="2055"><span class="lineNum">    2055 </span><span class="lineCov">       2187 :         return GF_FPROBE_NOT_SUPPORTED;</span></a>
<span class="lineNum">    2056 </span>            : }
<span class="lineNum">    2057 </span><span class="lineCov">          4 : static Bool routeout_use_alias(GF_Filter *filter, const char *url, const char *mime)</span>
<span class="lineNum">    2058 </span>            : {
<span class="lineNum">    2059 </span>            :         const char *sep;
<span class="lineNum">    2060 </span>            :         u32 len;
<span class="lineNum">    2061 </span><span class="lineCov">          4 :         GF_ROUTEOutCtx *ctx = (GF_ROUTEOutCtx *) gf_filter_get_udta(filter);</span>
<span class="lineNum">    2062 </span>            : 
<span class="lineNum">    2063 </span>            :         //atsc, do not analyze IP and port
<span class="lineNum">    2064 </span><span class="lineCov">          4 :         if (ctx-&gt;sock_atsc_lls) {</span>
<span class="lineNum">    2065 </span><span class="lineCov">          2 :                 if (!strncmp(url, &quot;atsc://&quot;, 7)) return GF_TRUE;</span>
<span class="lineNum">    2066 </span><span class="lineNoCov">          0 :                 return GF_FALSE;</span>
<span class="lineNum">    2067 </span>            :         }
<span class="lineNum">    2068 </span>            : 
<span class="lineNum">    2069 </span>            :         //check we have same hostname. If so, accept this destination as a source for our filter
<span class="lineNum">    2070 </span>            :         //- if atsc://, single instance of the filter
<span class="lineNum">    2071 </span>            :         //- if route://IP:PORT, same instance if same IP:PORT
<span class="lineNum">    2072 </span><span class="lineCov">          2 :         sep = strstr(url, &quot;://&quot;);</span>
<span class="lineNum">    2073 </span><span class="lineCov">          2 :         if (!sep) return GF_FALSE;</span>
<span class="lineNum">    2074 </span><span class="lineCov">          2 :         sep += 3;</span>
<span class="lineNum">    2075 </span><span class="lineCov">          2 :         sep = strchr(sep, '/');</span>
<span class="lineNum">    2076 </span><span class="lineCov">          2 :         if (!sep) {</span>
<span class="lineNum">    2077 </span><span class="lineNoCov">          0 :                 if (!strcmp(ctx-&gt;dst, url)) return GF_TRUE;</span>
<span class="lineNum">    2078 </span><span class="lineNoCov">          0 :                 return GF_FALSE;</span>
<span class="lineNum">    2079 </span>            :         }
<span class="lineNum">    2080 </span><span class="lineCov">          2 :         len = (u32) (sep - url);</span>
<span class="lineNum">    2081 </span><span class="lineCov">          2 :         if (!strncmp(ctx-&gt;dst, url, len)) return GF_TRUE;</span>
<span class="lineNum">    2082 </span><span class="lineNoCov">          0 :         return GF_FALSE;</span>
<span class="lineNum">    2083 </span>            : }
<span class="lineNum">    2084 </span>            : 
<span class="lineNum">    2085 </span>            : 
<span class="lineNum">    2086 </span>            : #define OFFS(_n)        #_n, offsetof(GF_ROUTEOutCtx, _n)
<span class="lineNum">    2087 </span>            : 
<span class="lineNum">    2088 </span>            : static const GF_FilterArgs ROUTEOutArgs[] =
<span class="lineNum">    2089 </span>            : {
<span class="lineNum">    2090 </span>            :         { OFFS(dst), &quot;destination URL - see filter help&quot;, GF_PROP_NAME, NULL, NULL, 0},
<span class="lineNum">    2091 </span>            :         { OFFS(ext), &quot;set extension for graph resolution, regardless of file extension&quot;, GF_PROP_NAME, NULL, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2092 </span>            :         { OFFS(mime), &quot;set mime type for graph resolution&quot;, GF_PROP_NAME, NULL, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2093 </span>            :         { OFFS(ifce), &quot;default interface to use for multicast. If NULL, the default system interface will be used&quot;, GF_PROP_STRING, NULL, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2094 </span>            :         { OFFS(carousel), &quot;carousel period in ms for repeating signaling and raw file data - see filter help&quot;, GF_PROP_UINT, &quot;1000&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2095 </span>            :         { OFFS(first_port), &quot;port number of first ROUTE session in ATSC mode&quot;, GF_PROP_UINT, &quot;6000&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2096 </span>            :         { OFFS(ip), &quot;mulicast IP address for ROUTE session in ATSC mode&quot;, GF_PROP_STRING, &quot;225.1.1.0&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2097 </span>            :         { OFFS(ttl), &quot;time-to-live for multicast packets&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, 0},
<span class="lineNum">    2098 </span>            :         { OFFS(bsid), &quot;ID for ATSC broadcast stream&quot;, GF_PROP_UINT, &quot;800&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2099 </span>            :         { OFFS(mtu), &quot;size of LCT MTU in bytes&quot;, GF_PROP_UINT, &quot;1472&quot;, NULL, 0},
<span class="lineNum">    2100 </span>            :         { OFFS(splitlct), &quot;split mode for LCT channels\n&quot;
<span class="lineNum">    2101 </span>            :                 &quot;- off: all streams are in the same LCT channel\n&quot;
<span class="lineNum">    2102 </span>            :                 &quot;- type: each new stream type results in a new LCT channel\n&quot;
<span class="lineNum">    2103 </span>            :                 &quot;- all: all streams are in dedicated LCT channel, the first stream being used for STSID signaling&quot;
<span class="lineNum">    2104 </span>            :                 , GF_PROP_UINT, &quot;off&quot;, &quot;off|type|all&quot;, 0},
<span class="lineNum">    2105 </span>            :         { OFFS(korean), &quot;use Korean version of ATSC 3.0 spec instead of US&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, 0},
<span class="lineNum">    2106 </span>            :         { OFFS(llmode), &quot;use low-latency mode&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_ARG_HINT_EXPERT},
<span class="lineNum">    2107 </span>            :         { OFFS(brinc), &quot;bitrate increase in percent when estimating timing in low latency mode - see filter help&quot;, GF_PROP_UINT, &quot;10&quot;, NULL, GF_ARG_HINT_EXPERT},
<span class="lineNum">    2108 </span>            :         { OFFS(noreg), &quot;disable rate regulation for media segments, pushing them as fast as received&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_ARG_HINT_EXPERT},
<span class="lineNum">    2109 </span>            : 
<span class="lineNum">    2110 </span>            :         { OFFS(runfor), &quot;run for the given time in ms&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, 0},
<span class="lineNum">    2111 </span>            :         {0}
<span class="lineNum">    2112 </span>            : };
<span class="lineNum">    2113 </span>            : 
<span class="lineNum">    2114 </span>            : static const GF_FilterCapability ROUTEOutCaps[] =
<span class="lineNum">    2115 </span>            : {
<span class="lineNum">    2116 </span>            :         CAP_UINT(GF_CAPS_INPUT,GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    2117 </span>            :         CAP_STRING(GF_CAPS_INPUT,GF_PROP_PID_FILE_EXT, &quot;*&quot;),
<span class="lineNum">    2118 </span>            : };
<span class="lineNum">    2119 </span>            : 
<span class="lineNum">    2120 </span>            : 
<span class="lineNum">    2121 </span>            : GF_FilterRegister ROUTEOutRegister = {
<span class="lineNum">    2122 </span>            :         .name = &quot;routeout&quot;,
<span class="lineNum">    2123 </span>            :         GF_FS_SET_DESCRIPTION(&quot;ROUTE output&quot;)
<span class="lineNum">    2124 </span>            :         GF_FS_SET_HELP(&quot;The ROUTE output filter is used to distribute a live file-based session using ROUTE.\n&quot;
<span class="lineNum">    2125 </span>            :                 &quot;The filter supports DASH and HLS inputs, ATSC3.0 signaling and generic ROUTE signaling.\n&quot;
<span class="lineNum">    2126 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2127 </span>            :                 &quot;The filter is identified using the following URL schemes:\n&quot;
<span class="lineNum">    2128 </span>            :                 &quot;- `atsc://`: session is a full ATSC 3.0 session\n&quot;
<span class="lineNum">    2129 </span>            :                 &quot;- `route://IP:port`: session is a ROUTE session running on given multicast IP and port\n&quot;
<span class="lineNum">    2130 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2131 </span>            :                 &quot;The filter only accepts input PIDs of type `FILE`.\n&quot;
<span class="lineNum">    2132 </span>            :                 &quot;- HAS Manifests files are detected by file extension and/or MIME types, and sent as part of the signaling bundle or as LCT object files for HLS subplaylists.\n&quot;
<span class="lineNum">    2133 </span>            :                 &quot;- HAS Media segments are detected using the `OrigStreamType` property, and send as LCT object files using the DASH template string.\n&quot;
<span class="lineNum">    2134 </span>            :                 &quot;- A PID without `OrigStreamType` property set is delivered as a regular LCT object file (called `raw` hereafter).\n&quot;
<span class="lineNum">    2135 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    2136 </span>            :                 &quot;For `raw` file PIDs, the filter will look for the following properties:\n&quot;
<span class="lineNum">    2137 </span>            :                 &quot;- `ROUTEName`: set resource name. If not found, uses basename of URL\n&quot;
<span class="lineNum">    2138 </span>            :                 &quot;- `ROUTECarousel`: set repeat period. If not found, uses [-carousel](). If 0, the file is only sent once\n&quot;
<span class="lineNum">    2139 </span>            :                 &quot;- `ROUTEUpload`: set resource upload time. If not found, uses [-carousel](). If 0, the file will be sent as fast as possible.\n&quot;
<span class="lineNum">    2140 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2141 </span>            :                 &quot;When DASHing for ROUTE or single service ATSC, a file extension, either in [-dst]() or in [-ext](), may be used to identify the HAS session type (DASH or HLS).\n&quot;
<span class="lineNum">    2142 </span>            :                 &quot;EX \&quot;route://IP:PORT/manifest.mpd\&quot;, \&quot;route://IP:PORT/:ext=mpd\&quot;\n&quot;
<span class="lineNum">    2143 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2144 </span>            :                 &quot;When DASHing for multi-service ATSC, forcing an extension will force all service to use the same formats.\n&quot;
<span class="lineNum">    2145 </span>            :                 &quot;EX \&quot;atsc://:ext=mpd\&quot;, \&quot;route://IP:PORT/manifest.mpd\&quot;\n&quot;
<span class="lineNum">    2146 </span>            :                 &quot;If multiple services with different formats are needed, you will need to explicit your filters:\n&quot;
<span class="lineNum">    2147 </span>            :                 &quot;EX gpac -i DASH_URL:#ServiceID=1 @ dashin:forward=file:FID=1 -i HLS_URL:#ServiceID=2 @ dashin:forward=file:FID=2 -o atsc://:SID=1,2\n&quot;
<span class="lineNum">    2148 </span>            :                 &quot;EX gpac -i MOVIE1:#ServiceID=1 @ dasher:FID=1:mname=manifest.mpd -i MOVIE2:#ServiceID=2 @ dasher:FID=2:mname=manifest.m3u8 -o atsc://:SID=1,2\n&quot;
<span class="lineNum">    2149 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2150 </span>            :                 &quot;Warning: When forwarding an existing DASH/HLS session, do NOT set any extension or manifest name.\n&quot;
<span class="lineNum">    2151 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2152 </span>            :                 &quot;By default, all streams in a service are assigned to a single route session, and differentiated by ROUTE TSI (see [-splitlct]()).\n&quot;
<span class="lineNum">    2153 </span>            :                 &quot;TSI are assigned as follows:\n&quot;
<span class="lineNum">    2154 </span>            :                 &quot;- signaling TSI is always 0\n&quot;
<span class="lineNum">    2155 </span>            :                 &quot;- raw files are assigned TSI 1 and increasing number of TOI\n&quot;
<span class="lineNum">    2156 </span>            :                 &quot;- otherwise, the first PID found is assigned TSI 10, the second TSI 20 etc ...\n&quot;
<span class="lineNum">    2157 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2158 </span>            :                 &quot;Init segments and HLS subplaylists are sent before each new segment, independently of [-carousel]().\n&quot;
<span class="lineNum">    2159 </span>            :                 &quot;# ATSC 3.0 mode\n&quot;
<span class="lineNum">    2160 </span>            :                 &quot;In this mode, the filter allows multiple service multiplexing, identified through the `ServiceID` property.\n&quot;
<span class="lineNum">    2161 </span>            :                 &quot;By default, a single multicast IP is used for route sessions, each service will be assigned a different port.\n&quot;
<span class="lineNum">    2162 </span>            :                 &quot;The filter will look for `ROUTEIP` and `ROUTEPort` properties on the incoming PID. If not found, the default [-ip]() and [-port]() will be used.\n&quot;
<span class="lineNum">    2163 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2164 </span>            :                 &quot;The ATSC short service name can be set using PID property `ShortServiceName`. If not found, `ServiceName` is checked, otherwise default to `GPAC`.\n&quot;
<span class="lineNum">    2165 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2166 </span>            :                 &quot;# ROUTE mode\n&quot;
<span class="lineNum">    2167 </span>            :                 &quot;In this mode, only a single service can be distributed by the ROUTE session.\n&quot;
<span class="lineNum">    2168 </span>            :                 &quot;Note: [-ip]() is ignored, and [-first_port]() is used if no port is specified in [-dst]().\n&quot;
<span class="lineNum">    2169 </span>            :                 &quot;The ROUTE session will include a multi-part MIME unsigned package containing manifest and S-TSID, sent on TSI=0.\n&quot;
<span class="lineNum">    2170 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2171 </span>            :                 &quot;# Low latency mode\n&quot;
<span class="lineNum">    2172 </span>            :                 &quot;When using low-latency mode, the input media segments are not re-assembled in a single packet but are instead sent as they are received.\n&quot;
<span class="lineNum">    2173 </span>            :                 &quot;In order for the real-time scheduling of data chunks to work, each fragment of the segment should have a CTS and timestamp describing its timing.\n&quot;
<span class="lineNum">    2174 </span>            :                 &quot;If this is not the case (typically when used with an existing DASH session in file mode), the scheduler will estimate CTS and duration based on the stream bitrate and segment duration. The indicated bitrate is increased by [-brinc]() percent for safety.\n&quot;
<span class="lineNum">    2175 </span>            :                 &quot;If this fails, the muxer will trigger warnings and send as fast as possible.\n&quot;
<span class="lineNum">    2176 </span>            :                 &quot;Note: The LCT objects are sent with no length (TOL header) assigned until the final segment size is known, potentially leading to a final 0-size LCT fragment signaling only the final size.\n&quot;
<span class="lineNum">    2177 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2178 </span>            :                 &quot;# Examples\n&quot;
<span class="lineNum">    2179 </span>            :                 &quot;Since the ROUTE filter only consumes files, it is required to insert:\n&quot;
<span class="lineNum">    2180 </span>            :                 &quot;- the dash demuxer in file forwarding mode when loading a DASH session\n&quot;
<span class="lineNum">    2181 </span>            :                 &quot;- the dash muxer when creating a DASH session\n&quot;
<span class="lineNum">    2182 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2183 </span>            :                 &quot;Muxing an existing DASH session in route:\n&quot;
<span class="lineNum">    2184 </span>            :                 &quot;EX gpac -i source.mpd dashin:forward=file @ -o route://225.1.1.0:6000/\n&quot;
<span class="lineNum">    2185 </span>            :                 &quot;Muxing an existing DASH session in atsc:\n&quot;
<span class="lineNum">    2186 </span>            :                 &quot;EX gpac -i source.mpd dashin:forward=file @ -o atsc://\n&quot;
<span class="lineNum">    2187 </span>            :                 &quot;Dashing and muxing in route:\n&quot;
<span class="lineNum">    2188 </span>            :                 &quot;EX gpac -i source.mp4 dasher:profile=live @ -o route://225.1.1.0:6000/manifest.mpd\n&quot;
<span class="lineNum">    2189 </span>            :                 &quot;Dashing and muxing in route Low Latency (experimental):\n&quot;
<span class="lineNum">    2190 </span>            :                 &quot;EX gpac -i source.mp4 dasher @ -o route://225.1.1.0:6000/manifest.mpd:profile=live:cdur=0.2:llmode\n&quot;
<span class="lineNum">    2191 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2192 </span>            :                 &quot;Sending a single file in ROUTE using half a second upload time, 2 seconds carousel:\n&quot;
<span class="lineNum">    2193 </span>            :                 &quot;EX gpac -i URL:#ROUTEUpload=0.5:#ROUTECarousel=2 -o route://225.1.1.0:6000/\n&quot;
<span class="lineNum">    2194 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2195 </span>            :                 &quot;Common mistakes:\n&quot;
<span class="lineNum">    2196 </span>            :                 &quot;EX gpac -i source.mpd -o route://225.1.1.0:6000/\n&quot;
<span class="lineNum">    2197 </span>            :                 &quot;This will only send the manifest file as a regular object and will not load the dash session.\n&quot;
<span class="lineNum">    2198 </span>            :                 &quot;EX gpac -i source.mpd dasher @ -o route://225.1.1.0:6000/\n&quot;
<span class="lineNum">    2199 </span>            :                 &quot;EX gpac -i source.mpd dasher @ -o route://225.1.1.0:6000/manifest.mpd\n&quot;
<span class="lineNum">    2200 </span>            :                 &quot;These will load the dash session, instantiate a new dasher filter (hence a new DASH manifest), sending the output of the dasher to ROUTE\n&quot;
<span class="lineNum">    2201 </span>            :                 &quot;EX gpac -i source.mpd dashin:forward=file @ -o route://225.1.1.0:6000/manifest.mpd\n&quot;
<span class="lineNum">    2202 </span>            :                 &quot;This will force the ROUTE muxer to only accept .mpd files, and will drop all segment files (same if [-ext]() is used).\n&quot;
<span class="lineNum">    2203 </span>            :         )
<span class="lineNum">    2204 </span>            :         .private_size = sizeof(GF_ROUTEOutCtx),
<span class="lineNum">    2205 </span>            :         .max_extra_pids = -1,
<span class="lineNum">    2206 </span>            :         .args = ROUTEOutArgs,
<span class="lineNum">    2207 </span>            :         SETCAPS(ROUTEOutCaps),
<span class="lineNum">    2208 </span>            :         .probe_url = routeout_probe_url,
<span class="lineNum">    2209 </span>            :         .initialize = routeout_initialize,
<span class="lineNum">    2210 </span>            :         .finalize = routeout_finalize,
<span class="lineNum">    2211 </span>            :         .configure_pid = routeout_configure_pid,
<span class="lineNum">    2212 </span>            :         .process = routeout_process,
<span class="lineNum">    2213 </span>            :         .use_alias = routeout_use_alias
<span class="lineNum">    2214 </span>            : };
<a name="2215"><span class="lineNum">    2215 </span>            : </a>
<span class="lineNum">    2216 </span>            : 
<span class="lineNum">    2217 </span><span class="lineCov">       2877 : const GF_FilterRegister *routeout_register(GF_FilterSession *session)</span>
<span class="lineNum">    2218 </span>            : {
<span class="lineNum">    2219 </span><span class="lineCov">       2877 :         return &amp;ROUTEOutRegister;</span>
<span class="lineNum">    2220 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

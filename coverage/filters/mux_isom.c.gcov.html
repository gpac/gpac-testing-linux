<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - filters/mux_isom.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">filters</a> - mux_isom.c<span style="font-size: 80%;"> (source / <a href="mux_isom.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">2467</td>
            <td class="headerCovTableEntry">3223</td>
            <td class="headerCovTableEntryMed">76.5 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">38</td>
            <td class="headerCovTableEntry">40</td>
            <td class="headerCovTableEntryHi">95.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2017-2021
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / ISOBMF mux filter
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/filters.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;gpac/internal/isomedia_dev.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;gpac/internal/media_dev.h&gt;
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : #ifndef GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : #define TEXT_DEFAULT_WIDTH      400
<span class="lineNum">      34 </span>            : #define TEXT_DEFAULT_HEIGHT     60
<span class="lineNum">      35 </span>            : #define TEXT_DEFAULT_FONT_SIZE  18
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #define GF_VENDOR_GPAC          GF_4CC('G','P','A','C')
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : #define ISOM_FILE_EXT &quot;mp4|mpg4|m4a|m4i|3gp|3gpp|3g2|3gp2|iso|ismv|m4s|heif|heic|iff|avci|avif|mj2|mov|qt&quot;
<span class="lineNum">      41 </span>            : #define ISOM_FILE_MIME &quot;application/x-isomedia|application/mp4|video/mp4|audio/mp4|video/3gpp|audio/3gpp|video/3gp2|audio/3gp2|video/iso.segment|audio/iso.segment|image/heif|image/heic|image/avci|video/quicktime&quot;
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : enum{
<span class="lineNum">      44 </span>            :         NALU_NONE,
<span class="lineNum">      45 </span>            :         NALU_AVC,
<span class="lineNum">      46 </span>            :         NALU_HEVC,
<span class="lineNum">      47 </span>            :         NALU_VVC
<span class="lineNum">      48 </span>            : };
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : enum
<span class="lineNum">      52 </span>            : {
<span class="lineNum">      53 </span>            :         CENC_NONE=0,
<span class="lineNum">      54 </span>            :         CENC_NEED_SETUP,
<span class="lineNum">      55 </span>            :         CENC_SETUP_DONE,
<span class="lineNum">      56 </span>            :         CENC_SETUP_ERROR
<span class="lineNum">      57 </span>            : };
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            : enum{
<span class="lineNum">      60 </span>            :         TAG_NONE,
<span class="lineNum">      61 </span>            :         TAG_STRICT,
<span class="lineNum">      62 </span>            :         TAG_ALL
<span class="lineNum">      63 </span>            : };
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span>            : typedef struct
<span class="lineNum">      67 </span>            : {
<span class="lineNum">      68 </span>            :         GF_FilterPid *ipid;
<span class="lineNum">      69 </span>            :         u32 track_num, track_id;
<span class="lineNum">      70 </span>            :         GF_ISOSample sample;
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            :         u32 src_timescale;
<span class="lineNum">      73 </span>            :         u32 tk_timescale;
<span class="lineNum">      74 </span>            :         u32 stream_type;
<span class="lineNum">      75 </span>            :         u32 codecid;
<span class="lineNum">      76 </span>            :         Bool is_encrypted;
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            :         u32 cfg_crc, enh_cfg_crc;
<span class="lineNum">      79 </span>            :         u32 dep_id;
<span class="lineNum">      80 </span>            :         u32 stsd_idx;
<span class="lineNum">      81 </span>            :         u32 clear_stsd_idx;
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            :         Bool use_dref;
<span class="lineNum">      84 </span>            :         Bool aborted;
<span class="lineNum">      85 </span>            :         Bool suspended;
<span class="lineNum">      86 </span>            :         Bool has_append;
<span class="lineNum">      87 </span>            :         Bool has_ctts;
<span class="lineNum">      88 </span>            :         s64 min_neg_ctts;
<span class="lineNum">      89 </span>            :         u32 nb_samples, samples_in_stsd;
<span class="lineNum">      90 </span>            :         u32 nb_frames_per_sample;
<span class="lineNum">      91 </span>            :         u64 ts_shift;
<span class="lineNum">      92 </span>            :         Bool has_subs;
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span>            :         Bool skip_bitrate_update;
<span class="lineNum">      95 </span>            :         Bool has_open_gop;
<span class="lineNum">      96 </span>            :         GF_FilterSAPType gdr_type;
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            :         Bool next_is_first_sample;
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            :         u32 media_profile_level;
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span>            :         Bool import_msg_header_done;
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span>            :         u32 nal_unit_size;
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            :         GF_AVCConfig *avcc, *svcc;
<span class="lineNum">     107 </span>            :         GF_HEVCConfig *hvcc, *lvcc;
<span class="lineNum">     108 </span>            :         GF_VVCConfig *vvcc;
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span>            :         u8 *inband_hdr, *inband_hdr_non_rap;
<span class="lineNum">     111 </span>            :         u32 inband_hdr_size, inband_hdr_non_rap_size;
<span class="lineNum">     112 </span>            :         u32 is_nalu;
<span class="lineNum">     113 </span>            :         Bool is_av1, is_vpx;
<span class="lineNum">     114 </span>            :         Bool fragment_done;
<span class="lineNum">     115 </span>            :         s32 ts_delay, negctts_shift;
<span class="lineNum">     116 </span>            :         Bool insert_tfdt, probe_min_ctts;
<span class="lineNum">     117 </span>            :         u64 first_dts_in_seg, next_seg_cts, cts_next;
<span class="lineNum">     118 </span>            :         u64 offset_dts;
<span class="lineNum">     119 </span>            :         u32 samples_in_frag;
<span class="lineNum">     120 </span>            :         Bool patch_tfdt;
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span>            :         //0: not cenc, 1: needs setup of stsd entry, 2: setup done
<span class="lineNum">     123 </span>            :         u32 cenc_state;
<span class="lineNum">     124 </span>            :         Bool cenc_subsamples;
<span class="lineNum">     125 </span>            :         u32 scheme_type;
<span class="lineNum">     126 </span>            :         u32 def_skip_byte_block, def_crypt_byte_block;
<span class="lineNum">     127 </span>            :         u32 def_cenc_key_info_crc;
<span class="lineNum">     128 </span>            :         const GF_PropertyValue *cenc_ki;
<span class="lineNum">     129 </span>            :         u32 cenc_key_info_crc;
<span class="lineNum">     130 </span>            :         u32 constant_IV_size;
<span class="lineNum">     131 </span>            :         Bool cenc_multikey;
<span class="lineNum">     132 </span>            :         Bool cenc_frag_protected;
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span>            :         Bool fake_track;
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span>            :         Bool has_brands;
<span class="lineNum">     137 </span>            :         Bool force_inband_inject;
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span>            :         u64 dur_in_frag;
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            :         u32 amr_mode_set;
<span class="lineNum">     142 </span>            :         Bool has_seig;
<span class="lineNum">     143 </span>            :         u64 empty_init_dur;
<span class="lineNum">     144 </span>            :         u32 raw_audio_bytes_per_sample, raw_samplerate;
<span class="lineNum">     145 </span>            :         u64 dts_patch;
<span class="lineNum">     146 </span>            : 
<span class="lineNum">     147 </span>            :         Bool is_item;
<span class="lineNum">     148 </span>            :         u32 item_id;
<span class="lineNum">     149 </span>            :         char status_type;
<span class="lineNum">     150 </span>            :         u32 last_import_pc;
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span>            :         u32 nb_frames;
<span class="lineNum">     153 </span>            :         u64 down_bytes, down_size;
<span class="lineNum">     154 </span>            :         GF_Fraction64 pid_dur;
<span class="lineNum">     155 </span>            :         //for import message
<span class="lineNum">     156 </span>            :         u64 prog_done, prog_total;
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span>            :         u32 prev_tid_group;
<span class="lineNum">     159 </span>            : 
<span class="lineNum">     160 </span>            :         Bool box_patched;
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span>            :         u64 imported_edit_sdur, imported_edit_offset;
<span class="lineNum">     163 </span>            : 
<span class="lineNum">     164 </span>            :         Bool force_ctts;
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            :         Bool is_hevc_tile_base;
<span class="lineNum">     167 </span>            :         Bool insert_pssh;
<span class="lineNum">     168 </span>            : 
<span class="lineNum">     169 </span>            :         Bool wait_sap;
<span class="lineNum">     170 </span>            :         u64 min_ts_seek_plus_one;
<span class="lineNum">     171 </span>            :         u64 clamp_ts_plus_one;
<span class="lineNum">     172 </span>            :         Bool check_seek_ts;
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span>            :         u64 max_cts, min_cts;
<span class="lineNum">     175 </span>            :         u32 max_cts_samp_dur;
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span>            : } TrackWriter;
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span>            : enum
<span class="lineNum">     180 </span>            : {
<span class="lineNum">     181 </span>            :         MP4MX_MODE_INTER=0,
<span class="lineNum">     182 </span>            :         MP4MX_MODE_FLAT,
<span class="lineNum">     183 </span>            :         MP4MX_MODE_FASTSTART,
<span class="lineNum">     184 </span>            :         MP4MX_MODE_TIGHT,
<span class="lineNum">     185 </span>            :         MP4MX_MODE_FRAG,
<span class="lineNum">     186 </span>            :         MP4MX_MODE_SFRAG,
<span class="lineNum">     187 </span>            : };
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span>            : 
<span class="lineNum">     190 </span>            : enum
<span class="lineNum">     191 </span>            : {
<span class="lineNum">     192 </span>            :         MP4MX_DASH_OFF=0,
<span class="lineNum">     193 </span>            :         MP4MX_DASH_ON,
<span class="lineNum">     194 </span>            :         MP4MX_DASH_VOD,
<span class="lineNum">     195 </span>            : };
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span>            : enum
<span class="lineNum">     198 </span>            : {
<span class="lineNum">     199 </span>            :         MP4MX_PSSH_MOOV=0,
<span class="lineNum">     200 </span>            :         MP4MX_PSSH_MOOF,
<span class="lineNum">     201 </span>            :         MP4MX_PSSH_SKIP,
<span class="lineNum">     202 </span>            : };
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span>            : enum
<span class="lineNum">     205 </span>            : {
<span class="lineNum">     206 </span>            :         MP4MX_CT_EDIT=0,
<span class="lineNum">     207 </span>            :         MP4MX_CT_NOEDIT,
<span class="lineNum">     208 </span>            :         MP4MX_CT_NEGCTTS,
<span class="lineNum">     209 </span>            : };
<span class="lineNum">     210 </span>            : 
<span class="lineNum">     211 </span>            : enum
<span class="lineNum">     212 </span>            : {
<span class="lineNum">     213 </span>            :         MP4MX_VODCACHE_ON=0,
<span class="lineNum">     214 </span>            :         MP4MX_VODCACHE_INSERT,
<span class="lineNum">     215 </span>            :         MP4MX_VODCACHE_REPLACE,
<span class="lineNum">     216 </span>            : };
<span class="lineNum">     217 </span>            : 
<span class="lineNum">     218 </span>            : enum
<span class="lineNum">     219 </span>            : {
<span class="lineNum">     220 </span>            :         MP4MX_CMAF_NO=0,
<span class="lineNum">     221 </span>            :         MP4MX_CMAF_CMFC,
<span class="lineNum">     222 </span>            :         MP4MX_CMAF_CMF2,
<span class="lineNum">     223 </span>            : };
<span class="lineNum">     224 </span>            : 
<span class="lineNum">     225 </span>            : typedef struct
<span class="lineNum">     226 </span>            : {
<span class="lineNum">     227 </span>            :         //filter args
<span class="lineNum">     228 </span>            :         GF_ISOFile *file;
<span class="lineNum">     229 </span>            :         Bool m4sys, dref;
<span class="lineNum">     230 </span>            :         GF_Fraction idur;
<span class="lineNum">     231 </span>            :         u32 pack3gp, ctmode;
<span class="lineNum">     232 </span>            :         Bool importer, pack_nal, moof_first, abs_offset, fsap, tfdt_traf, keep_utc, pps_inband;
<span class="lineNum">     233 </span>            :         u32 xps_inband, moovpad;
<span class="lineNum">     234 </span>            :         u32 block_size;
<span class="lineNum">     235 </span>            :         u32 store, tktpl, mudta;
<span class="lineNum">     236 </span>            :         s32 subs_sidx;
<span class="lineNum">     237 </span>            :         GF_Fraction cdur;
<span class="lineNum">     238 </span>            :         s32 moovts;
<span class="lineNum">     239 </span>            :         char *m4cc;
<span class="lineNum">     240 </span>            :         Bool chain_sidx;
<span class="lineNum">     241 </span>            :         u32 msn, msninc;
<span class="lineNum">     242 </span>            :         GF_Fraction64 tfdt;
<span class="lineNum">     243 </span>            :         Bool nofragdef, straf, strun, sgpd_traf, noinit;
<span class="lineNum">     244 </span>            :         u32 vodcache;
<span class="lineNum">     245 </span>            :         u32 psshs;
<span class="lineNum">     246 </span>            :         u32 trackid;
<span class="lineNum">     247 </span>            :         Bool fragdur;
<span class="lineNum">     248 </span>            :         Bool btrt;
<span class="lineNum">     249 </span>            :         Bool ssix;
<span class="lineNum">     250 </span>            :         Bool ccst;
<span class="lineNum">     251 </span>            :         s32 mediats;
<span class="lineNum">     252 </span>            :         GF_AudioSampleEntryImportMode ase;
<span class="lineNum">     253 </span>            :         char *styp;
<span class="lineNum">     254 </span>            :         Bool sseg;
<span class="lineNum">     255 </span>            :         Bool noroll;
<span class="lineNum">     256 </span>            :         Bool saio32, tfdt64;
<span class="lineNum">     257 </span>            :         u32 compress;
<span class="lineNum">     258 </span>            :         Bool trun_inter;
<span class="lineNum">     259 </span>            :         Bool truns_first;
<span class="lineNum">     260 </span>            :         char *boxpatch;
<span class="lineNum">     261 </span>            :         Bool fcomp, otyp;
<span class="lineNum">     262 </span>            :         Bool deps;
<span class="lineNum">     263 </span>            :         Bool mvex;
<span class="lineNum">     264 </span>            :         u32 sdtp_traf;
<span class="lineNum">     265 </span>            :         u32 cmaf;
<span class="lineNum">     266 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">     267 </span>            :         Bool ctrn;
<span class="lineNum">     268 </span>            :         Bool ctrni;
<span class="lineNum">     269 </span>            : #endif
<span class="lineNum">     270 </span>            :         Bool mfra;
<span class="lineNum">     271 </span>            :         Bool forcesync, refrag;
<span class="lineNum">     272 </span>            :         u32 itags;
<span class="lineNum">     273 </span>            :         Double start;
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span>            :         //internal
<span class="lineNum">     276 </span>            :         Bool owns_mov;
<span class="lineNum">     277 </span>            :         GF_FilterPid *opid;
<span class="lineNum">     278 </span>            :         Bool first_pck_sent;
<span class="lineNum">     279 </span>            : 
<span class="lineNum">     280 </span>            :         GF_List *tracks;
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span>            :         GF_BitStream *bs_r;
<span class="lineNum">     283 </span>            :         //fragmentation state
<span class="lineNum">     284 </span>            :         Bool init_movie_done, fragment_started, segment_started, insert_tfdt, insert_pssh, cdur_set;
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span>            :         u64 next_frag_start, adjusted_next_frag_start;
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span>            :         u64 current_offset;
<span class="lineNum">     289 </span>            :         u64 current_size;
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            :         u32 nb_segs, nb_frags, nb_frags_in_seg;
<span class="lineNum">     292 </span>            : 
<span class="lineNum">     293 </span>            :         GF_FilterPacket *dst_pck;
<span class="lineNum">     294 </span>            :         char *seg_name;
<span class="lineNum">     295 </span>            :         u32 dash_seg_num_plus_one;
<span class="lineNum">     296 </span>            :         Bool flush_seg;
<span class="lineNum">     297 </span>            :         u32 eos_marker;
<span class="lineNum">     298 </span>            :         TrackWriter *ref_tkw;
<span class="lineNum">     299 </span>            :         Bool single_file;
<span class="lineNum">     300 </span>            :         Bool store_output;
<span class="lineNum">     301 </span>            :         FILE *tmp_store;
<span class="lineNum">     302 </span>            :         u64 flush_size, flush_done;
<span class="lineNum">     303 </span>            : 
<span class="lineNum">     304 </span>            :         u32 dash_mode, llhls_mode;
<span class="lineNum">     305 </span>            :         GF_Fraction dash_dur;
<span class="lineNum">     306 </span>            :         Double media_dur;
<span class="lineNum">     307 </span>            :         u32 sidx_max_size, sidx_chunk_offset;
<span class="lineNum">     308 </span>            :         Bool final_sidx_flush;
<span class="lineNum">     309 </span>            :         Bool sidx_size_exact;
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span>            :         u32 *seg_sizes;
<span class="lineNum">     312 </span>            :         u32 nb_seg_sizes, alloc_seg_sizes;
<span class="lineNum">     313 </span>            :         Bool config_timing;
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span>            :         u32 major_brand_set;
<span class="lineNum">     316 </span>            :         Bool def_brand_patched;
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span>            :         Bool force_play;
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span>            :         Bool moov_inserted;
<span class="lineNum">     321 </span>            :         Bool update_report;
<span class="lineNum">     322 </span>            :         u64 total_bytes_in, total_bytes_out;
<span class="lineNum">     323 </span>            :         u32 total_samples, last_mux_pc;
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span>            :         u32 maxchunk;
<span class="lineNum">     326 </span>            :         u32 make_qt;
<span class="lineNum">     327 </span>            :         TrackWriter *prores_track;
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            :         GF_SegmentIndexBox *cloned_sidx;
<span class="lineNum">     330 </span>            :         u32 cloned_sidx_index;
<span class="lineNum">     331 </span>            :         GF_Fraction faststart_ts_regulate;
<span class="lineNum">     332 </span>            : 
<span class="lineNum">     333 </span>            :         Bool is_rewind;
<span class="lineNum">     334 </span>            :         Bool box_patched;
<span class="lineNum">     335 </span>            :         u32 cur_file_idx_plus_one;
<span class="lineNum">     336 </span>            :         char *cur_file_suffix;
<span class="lineNum">     337 </span>            :         Bool notify_filename;
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span>            :         u32 next_file_idx;
<span class="lineNum">     340 </span>            :         const char *next_file_suffix;
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span>            :         //for route scheduling
<span class="lineNum">     343 </span>            :         u64 min_cts_plus_one, next_seg_start;
<span class="lineNum">     344 </span>            :         u64 min_cts_next_frag;
<span class="lineNum">     345 </span>            : 
<span class="lineNum">     346 </span>            :         u64 frag_size, frag_offset;
<span class="lineNum">     347 </span>            :         u32 frag_num;
<span class="lineNum">     348 </span>            :         u64 frag_duration;
<span class="lineNum">     349 </span>            :         u32 frag_timescale;
<span class="lineNum">     350 </span>            :         Bool frag_has_intra;
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span>            :         u64 wait_dts_plus_one;
<span class="lineNum">     353 </span>            :         u32 wait_dts_timescale;
<span class="lineNum">     354 </span>            : } GF_MP4MuxCtx;
<span class="lineNum">     355 </span>            : 
<a name="356"><span class="lineNum">     356 </span>            : static void mp4_mux_set_hevc_groups(GF_MP4MuxCtx *ctx, TrackWriter *tkw);</a>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span><span class="lineCov">         18 : static GF_Err mp4mx_setup_dash_vod(GF_MP4MuxCtx *ctx, TrackWriter *tkw)</span>
<span class="lineNum">     359 </span>            : {
<span class="lineNum">     360 </span><span class="lineCov">         18 :         if (tkw) {</span>
<span class="lineNum">     361 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">     362 </span><span class="lineCov">         18 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_DASH_DUR);</span>
<span class="lineNum">     363 </span><span class="lineCov">         18 :                 if (p) {</span>
<span class="lineNum">     364 </span><span class="lineCov">         18 :                         ctx-&gt;dash_dur = p-&gt;value.frac;</span>
<span class="lineNum">     365 </span>            :                 }
<span class="lineNum">     366 </span><span class="lineCov">         18 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_DURATION);</span>
<span class="lineNum">     367 </span><span class="lineCov">         18 :                 if (p &amp;&amp; p-&gt;value.lfrac.den) {</span>
<span class="lineNum">     368 </span><span class="lineCov">         18 :                         Double mdur = (Double) p-&gt;value.lfrac.num;</span>
<span class="lineNum">     369 </span><span class="lineCov">         18 :                         mdur /= p-&gt;value.lfrac.den;</span>
<span class="lineNum">     370 </span><span class="lineCov">         18 :                         if (ctx-&gt;media_dur &lt; mdur) ctx-&gt;media_dur = mdur;</span>
<span class="lineNum">     371 </span>            :                 }
<span class="lineNum">     372 </span>            :         }
<span class="lineNum">     373 </span><span class="lineCov">         18 :         ctx-&gt;dash_mode = MP4MX_DASH_VOD;</span>
<span class="lineNum">     374 </span><span class="lineCov">         18 :         ctx-&gt;llhls_mode = 0;</span>
<span class="lineNum">     375 </span><span class="lineCov">         18 :         if ((ctx-&gt;vodcache==MP4MX_VODCACHE_ON) &amp;&amp; !ctx-&gt;tmp_store) {</span>
<span class="lineNum">     376 </span><span class="lineCov">         17 :                 ctx-&gt;tmp_store = gf_file_temp(NULL);</span>
<span class="lineNum">     377 </span><span class="lineCov">         17 :                 if (!ctx-&gt;tmp_store) {</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Cannot allocate temp file for VOD sidx generation\n&quot;));</span>
<span class="lineNum">     379 </span>            :                         return GF_IO_ERR;
<span class="lineNum">     380 </span>            :                 }
<span class="lineNum">     381 </span><span class="lineCov">         17 :                 if (!ctx-&gt;block_size) ctx-&gt;block_size = 10000;</span>
<span class="lineNum">     382 </span>            :         }
<span class="lineNum">     383 </span>            : 
<span class="lineNum">     384 </span>            :         return GF_OK;
<span class="lineNum">     385 </span>            : }
<a name="386"><span class="lineNum">     386 </span>            : </a>
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span><span class="lineCov">       1453 : static u32 gf_isom_stream_type_to_media_type(u32 stream_type, u32 codecid)</span>
<span class="lineNum">     389 </span>            : {
<span class="lineNum">     390 </span><span class="lineCov">       1453 :         switch (stream_type) {</span>
<span class="lineNum">     391 </span>            :         case GF_STREAM_SCENE: return GF_ISOM_MEDIA_SCENE;
<span class="lineNum">     392 </span><span class="lineCov">         13 :         case GF_STREAM_OD: return GF_ISOM_MEDIA_OD;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :         case GF_STREAM_OCR: return GF_ISOM_MEDIA_OCR;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :         case GF_STREAM_OCI: return GF_ISOM_MEDIA_OCI;</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         case GF_STREAM_MPEG7: return GF_ISOM_MEDIA_MPEG7;</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         case GF_STREAM_METADATA: return GF_ISOM_MEDIA_META;</span>
<span class="lineNum">     397 </span><span class="lineCov">        974 :         case GF_STREAM_VISUAL: return GF_ISOM_MEDIA_VISUAL;</span>
<span class="lineNum">     398 </span><span class="lineCov">        313 :         case GF_STREAM_AUDIO: return GF_ISOM_MEDIA_AUDIO;</span>
<span class="lineNum">     399 </span><span class="lineCov">        111 :         case GF_STREAM_TEXT:</span>
<span class="lineNum">     400 </span><span class="lineCov">        111 :                 if (codecid==GF_ISOM_SUBTYPE_STPP)</span>
<span class="lineNum">     401 </span>            :                         return GF_ISOM_MEDIA_MPEG_SUBT;
<span class="lineNum">     402 </span><span class="lineCov">         94 :                 if (codecid == GF_CODECID_SUBPIC)</span>
<span class="lineNum">     403 </span>            :                         return GF_ISOM_MEDIA_SUBPIC;
<span class="lineNum">     404 </span><span class="lineCov">         93 :                 return GF_ISOM_MEDIA_TEXT;</span>
<span class="lineNum">     405 </span>            :         case GF_STREAM_INTERACT: return GF_ISOM_MEDIA_SCENE;
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :         case GF_STREAM_IPMP: return GF_ISOM_MEDIA_IPMP;</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :         case GF_STREAM_MPEGJ: return GF_ISOM_MEDIA_MPEGJ;</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :         case GF_STREAM_IPMP_TOOL: return GF_ISOM_MEDIA_IPMP;</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :         case GF_STREAM_FONT: return GF_ISOM_MEDIA_MPEGJ;//TOCHECK !!</span>
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :         case GF_STREAM_PRIVATE_SCENE:</span>
<span class="lineNum">     412 </span>            :         case GF_STREAM_ENCRYPTED:
<span class="lineNum">     413 </span>            :         case GF_STREAM_FILE:
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     415 </span><span class="lineCov">         26 :         default:</span>
<span class="lineNum">     416 </span><span class="lineCov">         26 :                 return stream_type;</span>
<span class="lineNum">     417 </span>            :         }
<span class="lineNum">     418 </span>            :         return 0;
<a name="419"><span class="lineNum">     419 </span>            : }</a>
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineCov">         94 : static void mp4_mux_write_ps_list(GF_BitStream *bs, GF_List *list, u32 nalu_size_length)</span>
<span class="lineNum">     422 </span>            : {
<span class="lineNum">     423 </span><span class="lineCov">         94 :         u32 i, count = list ? gf_list_count(list) : 0;</span>
<span class="lineNum">     424 </span><span class="lineCov">        194 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     425 </span><span class="lineCov">        100 :                 GF_NALUFFParam *sl = gf_list_get(list, i);</span>
<span class="lineNum">     426 </span><span class="lineCov">        100 :                 gf_bs_write_int(bs, sl-&gt;size, 8*nalu_size_length);</span>
<span class="lineNum">     427 </span><span class="lineCov">        100 :                 gf_bs_write_data(bs, sl-&gt;data, sl-&gt;size);</span>
<span class="lineNum">     428 </span>            :         }
<a name="429"><span class="lineNum">     429 </span><span class="lineCov">         94 : }</span></a>
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineCov">         48 : static GF_List *mp4_mux_get_nalus_ps(GF_List *list, u8 type)</span>
<span class="lineNum">     432 </span>            : {
<span class="lineNum">     433 </span><span class="lineCov">         48 :         u32 i, count = gf_list_count(list);</span>
<span class="lineNum">     434 </span><span class="lineCov">         96 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     435 </span><span class="lineCov">         96 :                 GF_NALUFFParamArray *pa = gf_list_get(list, i);</span>
<span class="lineNum">     436 </span><span class="lineCov">         96 :                 if (pa-&gt;type == type) return pa-&gt;nalus;</span>
<span class="lineNum">     437 </span>            :         }
<span class="lineNum">     438 </span>            :         return NULL;
<a name="439"><span class="lineNum">     439 </span>            : }</a>
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span><span class="lineCov">         39 : static void mp4_mux_make_inband_header(GF_MP4MuxCtx *ctx, TrackWriter *tkw, Bool for_non_rap)</span>
<span class="lineNum">     442 </span>            : {
<span class="lineNum">     443 </span>            :         GF_BitStream *bs;
<span class="lineNum">     444 </span><span class="lineCov">         39 :         if (for_non_rap) {</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :                 if (tkw-&gt;inband_hdr_non_rap) gf_free(tkw-&gt;inband_hdr_non_rap);</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :                 tkw-&gt;inband_hdr_non_rap = NULL;</span>
<span class="lineNum">     447 </span>            :         } else {
<span class="lineNum">     448 </span><span class="lineCov">         39 :                 if (tkw-&gt;inband_hdr) gf_free(tkw-&gt;inband_hdr);</span>
<span class="lineNum">     449 </span><span class="lineCov">         39 :                 tkw-&gt;inband_hdr = NULL;</span>
<span class="lineNum">     450 </span>            :         }
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span><span class="lineCov">         39 :         tkw-&gt;nal_unit_size = 0;</span>
<span class="lineNum">     453 </span><span class="lineCov">         39 :         bs = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);</span>
<span class="lineNum">     454 </span><span class="lineCov">         39 :         if (tkw-&gt;avcc || tkw-&gt;svcc) {</span>
<span class="lineNum">     455 </span><span class="lineCov">         23 :                 if (tkw-&gt;avcc) {</span>
<span class="lineNum">     456 </span><span class="lineCov">         23 :                         if (!for_non_rap)</span>
<span class="lineNum">     457 </span><span class="lineCov">         23 :                                 mp4_mux_write_ps_list(bs, tkw-&gt;avcc-&gt;sequenceParameterSets, tkw-&gt;avcc-&gt;nal_unit_size);</span>
<span class="lineNum">     458 </span><span class="lineCov">         23 :                         /*if (!tkw-&gt;nal_unit_size) */tkw-&gt;nal_unit_size = tkw-&gt;avcc-&gt;nal_unit_size;</span>
<span class="lineNum">     459 </span>            :                 }
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineCov">         23 :                 if (tkw-&gt;svcc) {</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :                         if (!for_non_rap)</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                                 mp4_mux_write_ps_list(bs, tkw-&gt;svcc-&gt;sequenceParameterSets, tkw-&gt;svcc-&gt;nal_unit_size);</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :                         if (!tkw-&gt;nal_unit_size) tkw-&gt;nal_unit_size = tkw-&gt;svcc-&gt;nal_unit_size;</span>
<span class="lineNum">     465 </span>            :                 }
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineCov">         23 :                 if (tkw-&gt;avcc &amp;&amp; tkw-&gt;avcc-&gt;sequenceParameterSetExtensions &amp;&amp; !for_non_rap)</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :                         mp4_mux_write_ps_list(bs, tkw-&gt;avcc-&gt;sequenceParameterSetExtensions, tkw-&gt;avcc-&gt;nal_unit_size);</span>
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span><span class="lineCov">         23 :                 if (tkw-&gt;svcc &amp;&amp; tkw-&gt;svcc-&gt;sequenceParameterSetExtensions &amp;&amp; !for_non_rap)</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :                         mp4_mux_write_ps_list(bs, tkw-&gt;svcc-&gt;sequenceParameterSetExtensions, tkw-&gt;svcc-&gt;nal_unit_size);</span>
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span><span class="lineCov">         23 :                 if (tkw-&gt;avcc)</span>
<span class="lineNum">     474 </span><span class="lineCov">         23 :                         mp4_mux_write_ps_list(bs, tkw-&gt;avcc-&gt;pictureParameterSets, tkw-&gt;avcc-&gt;nal_unit_size);</span>
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineCov">         23 :                 if (tkw-&gt;svcc)</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :                         mp4_mux_write_ps_list(bs, tkw-&gt;svcc-&gt;pictureParameterSets, tkw-&gt;svcc-&gt;nal_unit_size);</span>
<span class="lineNum">     478 </span>            :         }
<span class="lineNum">     479 </span><span class="lineCov">         39 :         if (tkw-&gt;hvcc || tkw-&gt;lvcc) {</span>
<span class="lineNum">     480 </span><span class="lineCov">         16 :                 if (tkw-&gt;hvcc) {</span>
<span class="lineNum">     481 </span><span class="lineCov">         16 :                         if (!for_non_rap)</span>
<span class="lineNum">     482 </span><span class="lineCov">         16 :                                 mp4_mux_write_ps_list(bs, mp4_mux_get_nalus_ps(tkw-&gt;hvcc-&gt;param_array, GF_HEVC_NALU_VID_PARAM), tkw-&gt;hvcc-&gt;nal_unit_size);</span>
<span class="lineNum">     483 </span><span class="lineCov">         16 :                         if (!tkw-&gt;nal_unit_size) tkw-&gt;nal_unit_size = tkw-&gt;hvcc-&gt;nal_unit_size;</span>
<span class="lineNum">     484 </span>            :                 }
<span class="lineNum">     485 </span><span class="lineCov">         16 :                 if (tkw-&gt;lvcc) {</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :                         if (!for_non_rap)</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :                                 mp4_mux_write_ps_list(bs, mp4_mux_get_nalus_ps(tkw-&gt;lvcc-&gt;param_array, GF_HEVC_NALU_VID_PARAM), tkw-&gt;lvcc-&gt;nal_unit_size);</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :                         if (!tkw-&gt;nal_unit_size) tkw-&gt;nal_unit_size = tkw-&gt;lvcc-&gt;nal_unit_size;</span>
<span class="lineNum">     489 </span>            :                 }
<span class="lineNum">     490 </span><span class="lineCov">         16 :                 if (tkw-&gt;hvcc &amp;&amp; !for_non_rap)</span>
<span class="lineNum">     491 </span><span class="lineCov">         16 :                         mp4_mux_write_ps_list(bs, mp4_mux_get_nalus_ps(tkw-&gt;hvcc-&gt;param_array, GF_HEVC_NALU_SEQ_PARAM), tkw-&gt;hvcc-&gt;nal_unit_size);</span>
<span class="lineNum">     492 </span><span class="lineCov">         16 :                 if (tkw-&gt;lvcc &amp;&amp; !for_non_rap)</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :                         mp4_mux_write_ps_list(bs, mp4_mux_get_nalus_ps(tkw-&gt;lvcc-&gt;param_array, GF_HEVC_NALU_SEQ_PARAM), tkw-&gt;lvcc-&gt;nal_unit_size);</span>
<span class="lineNum">     494 </span><span class="lineCov">         16 :                 if (tkw-&gt;hvcc)</span>
<span class="lineNum">     495 </span><span class="lineCov">         16 :                         mp4_mux_write_ps_list(bs, mp4_mux_get_nalus_ps(tkw-&gt;hvcc-&gt;param_array, GF_HEVC_NALU_PIC_PARAM), tkw-&gt;hvcc-&gt;nal_unit_size);</span>
<span class="lineNum">     496 </span><span class="lineCov">         16 :                 if (tkw-&gt;lvcc)</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                         mp4_mux_write_ps_list(bs, mp4_mux_get_nalus_ps(tkw-&gt;lvcc-&gt;param_array, GF_HEVC_NALU_PIC_PARAM), tkw-&gt;lvcc-&gt;nal_unit_size);</span>
<span class="lineNum">     498 </span>            :         }
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span><span class="lineCov">         39 :         if (tkw-&gt;vvcc) {</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :                 if (!for_non_rap)</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :                         mp4_mux_write_ps_list(bs, mp4_mux_get_nalus_ps(tkw-&gt;vvcc-&gt;param_array, GF_VVC_NALU_VID_PARAM), tkw-&gt;vvcc-&gt;nal_unit_size);</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :                 if (!tkw-&gt;nal_unit_size) tkw-&gt;nal_unit_size = tkw-&gt;vvcc-&gt;nal_unit_size;</span>
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                 if (!for_non_rap)</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :                         mp4_mux_write_ps_list(bs, mp4_mux_get_nalus_ps(tkw-&gt;vvcc-&gt;param_array, GF_VVC_NALU_SEQ_PARAM), tkw-&gt;vvcc-&gt;nal_unit_size);</span>
<span class="lineNum">     507 </span>            : 
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                 mp4_mux_write_ps_list(bs, mp4_mux_get_nalus_ps(tkw-&gt;vvcc-&gt;param_array, GF_VVC_NALU_PIC_PARAM), tkw-&gt;vvcc-&gt;nal_unit_size);</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :                 mp4_mux_write_ps_list(bs, mp4_mux_get_nalus_ps(tkw-&gt;vvcc-&gt;param_array, GF_VVC_NALU_APS_PREFIX), tkw-&gt;vvcc-&gt;nal_unit_size);</span>
<span class="lineNum">     510 </span>            :         }
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span><span class="lineCov">         39 :         if (for_non_rap) {</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :                 gf_bs_get_content(bs, &amp;tkw-&gt;inband_hdr_non_rap, &amp;tkw-&gt;inband_hdr_non_rap_size);</span>
<span class="lineNum">     514 </span>            :         } else {
<span class="lineNum">     515 </span><span class="lineCov">         39 :                 gf_bs_get_content(bs, &amp;tkw-&gt;inband_hdr, &amp;tkw-&gt;inband_hdr_size);</span>
<span class="lineNum">     516 </span>            :         }
<span class="lineNum">     517 </span><span class="lineCov">         39 :         gf_bs_del(bs);</span>
<span class="lineNum">     518 </span>            :         //we may have cases where the param sets are updated before a non-IDR/SAP3 picture, we must inject asap at least once
<span class="lineNum">     519 </span><span class="lineCov">         39 :         tkw-&gt;force_inband_inject = GF_TRUE;</span>
<a name="520"><span class="lineNum">     520 </span><span class="lineCov">         39 : }</span></a>
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span><span class="lineCov">         66 : void mp4_mux_get_video_size(GF_MP4MuxCtx *ctx, u32 *width, u32 *height)</span>
<span class="lineNum">     523 </span>            : {
<span class="lineNum">     524 </span>            :         u32 w, h, f_w, f_h, i;
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span>            :         f_w = f_h = 0;
<span class="lineNum">     527 </span><span class="lineCov">        206 :         for (i=0; i&lt;gf_isom_get_track_count(ctx-&gt;file); i++) {</span>
<span class="lineNum">     528 </span><span class="lineCov">         74 :                 switch (gf_isom_get_media_type(ctx-&gt;file, i+1)) {</span>
<span class="lineNum">     529 </span><span class="lineCov">          5 :                 case GF_ISOM_MEDIA_SCENE:</span>
<span class="lineNum">     530 </span>            :                 case GF_ISOM_MEDIA_VISUAL:
<span class="lineNum">     531 </span><span class="lineCov">          5 :                         gf_isom_get_visual_info(ctx-&gt;file, i+1, 1, &amp;w, &amp;h);</span>
<span class="lineNum">     532 </span><span class="lineCov">          5 :                         if (w &gt; f_w) f_w = w;</span>
<span class="lineNum">     533 </span><span class="lineCov">          5 :                         if (h &gt; f_h) f_h = h;</span>
<span class="lineNum">     534 </span>            :                         //fallthrough
<span class="lineNum">     535 </span>            :                 case GF_ISOM_MEDIA_TEXT:
<span class="lineNum">     536 </span><span class="lineCov">         71 :                         gf_isom_get_track_layout_info(ctx-&gt;file, i+1, &amp;w, &amp;h, NULL, NULL, NULL);</span>
<span class="lineNum">     537 </span><span class="lineCov">         71 :                         if (w &gt; f_w) f_w = w;</span>
<span class="lineNum">     538 </span><span class="lineCov">         71 :                         if (h &gt; f_h) f_h = h;</span>
<span class="lineNum">     539 </span>            :                         break;
<span class="lineNum">     540 </span>            :                 }
<span class="lineNum">     541 </span>            :         }
<span class="lineNum">     542 </span><span class="lineCov">         66 :         (*width) = f_w ? f_w : TEXT_DEFAULT_WIDTH;</span>
<span class="lineNum">     543 </span><span class="lineCov">         66 :         (*height) = f_h ? f_h : TEXT_DEFAULT_HEIGHT;</span>
<a name="544"><span class="lineNum">     544 </span><span class="lineCov">         66 : }</span></a>
<span class="lineNum">     545 </span>            : 
<span class="lineNum">     546 </span><span class="lineCov">       1376 : static void mp4_mux_track_writer_del(TrackWriter *tkw)</span>
<span class="lineNum">     547 </span>            : {
<span class="lineNum">     548 </span><span class="lineCov">       1376 :         if (tkw-&gt;avcc) gf_odf_avc_cfg_del(tkw-&gt;avcc);</span>
<span class="lineNum">     549 </span><span class="lineCov">       1376 :         if (tkw-&gt;svcc) gf_odf_avc_cfg_del(tkw-&gt;svcc);</span>
<span class="lineNum">     550 </span><span class="lineCov">       1376 :         if (tkw-&gt;hvcc) gf_odf_hevc_cfg_del(tkw-&gt;hvcc);</span>
<span class="lineNum">     551 </span><span class="lineCov">       1376 :         if (tkw-&gt;lvcc) gf_odf_hevc_cfg_del(tkw-&gt;lvcc);</span>
<span class="lineNum">     552 </span><span class="lineCov">       1376 :         if (tkw-&gt;vvcc) gf_odf_vvc_cfg_del(tkw-&gt;vvcc);</span>
<span class="lineNum">     553 </span><span class="lineCov">       1376 :         if (tkw-&gt;inband_hdr) gf_free(tkw-&gt;inband_hdr);</span>
<span class="lineNum">     554 </span><span class="lineCov">       1376 :         if (tkw-&gt;inband_hdr_non_rap) gf_free(tkw-&gt;inband_hdr_non_rap);</span>
<span class="lineNum">     555 </span><span class="lineCov">       1376 :         gf_free(tkw);</span>
<a name="556"><span class="lineNum">     556 </span><span class="lineCov">       1376 : }</span></a>
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span><span class="lineCov">       4404 : static void mp4_mux_write_track_refs(GF_MP4MuxCtx *ctx, TrackWriter *tkw, const char *rname, u32 rtype)</span>
<span class="lineNum">     559 </span>            : {
<span class="lineNum">     560 </span>            :         u32 i;
<span class="lineNum">     561 </span><span class="lineCov">       4404 :         const GF_PropertyValue *p = gf_filter_pid_get_property_str(tkw-&gt;ipid, rname);</span>
<span class="lineNum">     562 </span><span class="lineCov">       4404 :         if (!p) return;</span>
<span class="lineNum">     563 </span><span class="lineCov">        241 :         for (i=0; i&lt;p-&gt;value.uint_list.nb_items; i++) {</span>
<span class="lineNum">     564 </span><span class="lineCov">        241 :                 gf_isom_set_track_reference(ctx-&gt;file, tkw-&gt;track_num, rtype, p-&gt;value.uint_list.vals[i]);</span>
<span class="lineNum">     565 </span>            :         }
<a name="566"><span class="lineNum">     566 </span>            : }</a>
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span><span class="lineNoCov">          0 : static void mp4mux_track_reorder(void *udta, u32 old_track_num, u32 new_track_num)</span>
<span class="lineNum">     569 </span>            : {
<span class="lineNum">     570 </span>            :         GF_MP4MuxCtx *ctx = (GF_MP4MuxCtx *) udta;
<span class="lineNum">     571 </span>            :         u32 i, count;
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :         count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :                 if (tkw-&gt;track_num==old_track_num) {</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :                         tkw-&gt;track_num = new_track_num;</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     578 </span>            :                 }
<span class="lineNum">     579 </span>            :         }
<a name="580"><span class="lineNum">     580 </span>            : }</a>
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span><span class="lineCov">        461 : static void mp4mux_reorder_tracks(GF_MP4MuxCtx *ctx)</span>
<span class="lineNum">     583 </span>            : {
<span class="lineNum">     584 </span>            :         u32 i, count, prev_num, prev_pos;
<span class="lineNum">     585 </span><span class="lineCov">        461 :         GF_List *new_tracks = gf_list_new();</span>
<span class="lineNum">     586 </span>            :         prev_num = prev_pos = 0;
<span class="lineNum">     587 </span><span class="lineCov">        461 :         count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">     588 </span><span class="lineCov">        469 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     589 </span><span class="lineCov">        469 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">     590 </span><span class="lineCov">        469 :                 if (tkw-&gt;track_num&lt;prev_num) {</span>
<span class="lineNum">     591 </span><span class="lineCov">          1 :                         gf_list_insert(new_tracks, tkw, prev_pos);</span>
<span class="lineNum">     592 </span>            :                 } else {
<span class="lineNum">     593 </span><span class="lineCov">        468 :                         gf_list_add(new_tracks, tkw);</span>
<span class="lineNum">     594 </span>            :                 }
<span class="lineNum">     595 </span><span class="lineCov">        469 :                 prev_pos = gf_list_count(new_tracks) - 1;</span>
<span class="lineNum">     596 </span><span class="lineCov">        469 :                 prev_num = tkw-&gt;track_num;</span>
<span class="lineNum">     597 </span>            :         }
<span class="lineNum">     598 </span><span class="lineCov">        461 :         if (gf_list_count(new_tracks)!=count) {</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :                 gf_list_del(new_tracks);</span>
<span class="lineNum">     600 </span>            :                 return;
<span class="lineNum">     601 </span>            :         }
<span class="lineNum">     602 </span><span class="lineCov">        461 :         gf_list_del(ctx-&gt;tracks);</span>
<span class="lineNum">     603 </span><span class="lineCov">        461 :         ctx-&gt;tracks = new_tracks;</span>
<a name="604"><span class="lineNum">     604 </span>            : }</a>
<span class="lineNum">     605 </span>            : 
<span class="lineNum">     606 </span><span class="lineCov">       1461 : static void mp4_mux_set_tags(GF_MP4MuxCtx *ctx, TrackWriter *tkw)</span>
<span class="lineNum">     607 </span>            : {
<span class="lineNum">     608 </span><span class="lineCov">       1461 :         u32 idx=0;</span>
<span class="lineNum">     609 </span><span class="lineCov">       1461 :         if (ctx-&gt;itags==TAG_NONE) return;</span>
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span>            :         while (1) {
<span class="lineNum">     612 </span>            :                 GF_Err e;
<span class="lineNum">     613 </span>            :                 u32 len;
<span class="lineNum">     614 </span><span class="lineCov">      42054 :                 u32 prop_4cc=0;</span>
<span class="lineNum">     615 </span>            :                 u32 itag;
<span class="lineNum">     616 </span>            :                 s32 tag_idx;
<span class="lineNum">     617 </span><span class="lineCov">      42054 :                 const char *tag_name=NULL;</span>
<span class="lineNum">     618 </span><span class="lineCov">      42054 :                 const GF_PropertyValue *tag = gf_filter_pid_enum_properties(tkw-&gt;ipid, &amp;idx, &amp;prop_4cc, &amp;tag_name);</span>
<span class="lineNum">     619 </span><span class="lineCov">      42054 :                 if (!tag) break;</span>
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span><span class="lineCov">      40593 :                 if (prop_4cc==GF_PROP_PID_COVER_ART) {</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :                         e = gf_isom_apple_set_tag(ctx-&gt;file, GF_ISOM_ITUNE_COVER_ART, tag-&gt;value.data.ptr, tag-&gt;value.data.size, 0, 0);</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :                         if (e) {</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to set cover art: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">     625 </span>            :                         }
<span class="lineNum">     626 </span>            :                 }
<span class="lineNum">     627 </span><span class="lineCov">      40593 :                 if (!tag_name)</span>
<span class="lineNum">     628 </span><span class="lineCov">      80898 :                         continue;</span>
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span><span class="lineCov">        288 :                 tag_idx = gf_itags_find_by_name(tag_name);</span>
<span class="lineNum">     631 </span><span class="lineCov">        288 :                 if (tag_idx&gt;=0) {</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :                         itag = gf_itags_get_itag(tag_idx);</span>
<span class="lineNum">     633 </span>            :                 } else {
<span class="lineNum">     634 </span><span class="lineCov">        288 :                         if (ctx-&gt;itags==TAG_STRICT)</span>
<span class="lineNum">     635 </span><span class="lineCov">        288 :                                 continue;</span>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :                         if (strnicmp(tag_name, &quot;tag_&quot;, 4))</span>
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     639 </span>            : 
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :                         tag_name += 4;</span>
<span class="lineNum">     641 </span>            : 
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unrecognized tag %s: %s\n&quot;, tag_name, tag-&gt;value.string));</span>
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :                         if (strlen(tag_name)==4) {</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :                                 itag = GF_4CC(tag_name[0], tag_name[1], tag_name[2], tag_name[3]);</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :                         } else if (strlen(tag_name)==3) {</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :                                 itag = GF_4CC(0xA9, tag_name[0], tag_name[1], tag_name[2]);</span>
<span class="lineNum">     648 </span>            :                         } else {
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :                                 itag = gf_crc_32(tag_name, (u32) strlen(tag_name));</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[MP4Mux] Tag name %s is not a 4CC, using CRC32 %08X as value\n&quot;, tag_name, itag));</span>
<span class="lineNum">     651 </span>            :                         }
<span class="lineNum">     652 </span>            :                 }
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :                 switch (tag-&gt;type) {</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :                 case GF_PROP_STRING:</span>
<span class="lineNum">     656 </span>            :                 case GF_PROP_NAME:
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :                         len = tag-&gt;value.string ? (u32) strlen(tag-&gt;value.string) : 0;</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :                         e = gf_isom_apple_set_tag(ctx-&gt;file, GF_ISOM_ITUNE_COVER_ART, tag-&gt;value.string, len, 0, 0);</span>
<span class="lineNum">     659 </span>            :                         break;
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :                 case GF_PROP_BOOL:</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :                         e = gf_isom_apple_set_tag(ctx-&gt;file, itag, NULL, 0, tag-&gt;value.boolean, 0);</span>
<span class="lineNum">     662 </span>            :                         break;
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :                 case GF_PROP_UINT:</span>
<span class="lineNum">     664 </span>            :                 case GF_PROP_4CC:
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :                         e = gf_isom_apple_set_tag(ctx-&gt;file, itag, NULL, 0, tag-&gt;value.uint, 0);</span>
<span class="lineNum">     666 </span>            :                         break;
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :                 case GF_PROP_LUINT:</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :                         e = gf_isom_apple_set_tag(ctx-&gt;file, itag, NULL, 0, tag-&gt;value.longuint, 0);</span>
<span class="lineNum">     669 </span>            :                         break;
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :                 case GF_PROP_FRACTION:</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :                         e = gf_isom_apple_set_tag(ctx-&gt;file, itag, NULL, 0, tag-&gt;value.frac.num, tag-&gt;value.frac.den);</span>
<span class="lineNum">     672 </span>            :                         break;
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :                 case GF_PROP_DATA:</span>
<span class="lineNum">     674 </span>            :                 case GF_PROP_CONST_DATA:
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :                         e = gf_isom_apple_set_tag(ctx-&gt;file, itag, tag-&gt;value.data.ptr, tag-&gt;value.data.size, 0, 0);</span>
<span class="lineNum">     676 </span>            :                         break;
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :                 default:</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to set tag %s: invalid data format\n&quot;, gf_itags_get_name(tag_idx) ));</span>
<span class="lineNum">     679 </span>            :                         e = GF_OK;
<span class="lineNum">     680 </span>            :                         break;
<span class="lineNum">     681 </span>            :                 }
<span class="lineNum">     682 </span>            : 
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                 if (e) {</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to set tag %s: %s\n&quot;, tag_name, gf_error_to_string(e)));</span>
<span class="lineNum">     685 </span>            :                 }
<span class="lineNum">     686 </span>            :         }
<span class="lineNum">     687 </span>            : }
<a name="688"><span class="lineNum">     688 </span>            : </a>
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineCov">       2794 : static GF_Err mp4_mux_setup_pid(GF_Filter *filter, GF_FilterPid *pid, Bool is_true_pid)</span>
<span class="lineNum">     691 </span>            : {
<span class="lineNum">     692 </span>            :         void mux_assign_mime_file_ext(GF_FilterPid *ipid, GF_FilterPid *opid, const char *file_exts, const char *mime_types, const char *def_ext);
<span class="lineNum">     693 </span>            :         Bool use_m4sys = GF_FALSE;
<span class="lineNum">     694 </span>            :         Bool use_tx3g = GF_FALSE;
<span class="lineNum">     695 </span>            :         Bool use_webvtt = GF_FALSE;
<span class="lineNum">     696 </span>            :         Bool needs_track = GF_FALSE;
<span class="lineNum">     697 </span>            :         u32 needs_sample_entry = 0; //1: change of codecID, 2 change of decoder config
<span class="lineNum">     698 </span>            :         Bool use_gen_sample_entry = GF_FALSE;
<span class="lineNum">     699 </span>            :         Bool use_3gpp_config = GF_FALSE;
<span class="lineNum">     700 </span>            :         Bool use_ac3_entry = GF_FALSE;
<span class="lineNum">     701 </span>            :         Bool use_flac_entry = GF_FALSE;
<span class="lineNum">     702 </span>            :         Bool use_avc = GF_FALSE;
<span class="lineNum">     703 </span>            :         Bool use_hevc = GF_FALSE;
<span class="lineNum">     704 </span>            :         Bool use_vvc = GF_FALSE;
<span class="lineNum">     705 </span>            :         Bool use_hvt1 = GF_FALSE;
<span class="lineNum">     706 </span>            :         Bool use_av1 = GF_FALSE;
<span class="lineNum">     707 </span>            :         Bool use_vpX = GF_FALSE;
<span class="lineNum">     708 </span>            :         Bool use_mj2 = GF_FALSE;
<span class="lineNum">     709 </span>            :         Bool use_opus = GF_FALSE;
<span class="lineNum">     710 </span>            :         Bool use_dref = GF_FALSE;
<span class="lineNum">     711 </span>            :         Bool skip_dsi = GF_FALSE;
<span class="lineNum">     712 </span>            :         Bool is_text_subs = GF_FALSE;
<span class="lineNum">     713 </span>            :         Bool force_colr = GF_FALSE;
<span class="lineNum">     714 </span>            :         u32 m_subtype=0;
<span class="lineNum">     715 </span>            :         u32 m_subtype_src=0;
<span class="lineNum">     716 </span>            :         u32 m_subtype_alt_raw=0;
<span class="lineNum">     717 </span>            :         u32 raw_bitdepth=0;
<span class="lineNum">     718 </span>            :         u32 override_stype=0;
<span class="lineNum">     719 </span>            :         u32 width, height, sr, nb_chan, nb_bps, z_order, txt_fsize;
<span class="lineNum">     720 </span>            :         u64 ch_layout;
<span class="lineNum">     721 </span>            :         GF_Fraction fps, sar;
<span class="lineNum">     722 </span>            :         GF_List *multi_pid_stsd = NULL;
<span class="lineNum">     723 </span>            :         u32 multi_pid_idx = 0;
<span class="lineNum">     724 </span>            :         GF_FilterPid *orig_pid = NULL;
<span class="lineNum">     725 </span>            :         u32 codec_id;
<span class="lineNum">     726 </span>            :         u32 frames_per_sample_backup=0;
<span class="lineNum">     727 </span>            :         u32 is_nalu_backup = NALU_NONE;
<span class="lineNum">     728 </span>            :         Bool is_tile_base = GF_FALSE;
<span class="lineNum">     729 </span>            :         Bool unknown_generic = GF_FALSE;
<span class="lineNum">     730 </span>            :         u32 multi_pid_final_stsd_idx = 0;
<span class="lineNum">     731 </span>            :         u32 audio_pli=0;
<span class="lineNum">     732 </span>            :         Bool force_tk_layout = GF_FALSE;
<span class="lineNum">     733 </span>            :         Bool force_mix_xps = GF_FALSE;
<span class="lineNum">     734 </span>            :         Bool make_inband_headers = GF_FALSE;
<span class="lineNum">     735 </span>            :         Bool is_prores = GF_FALSE;
<span class="lineNum">     736 </span>            : 
<span class="lineNum">     737 </span>            :         const char *lang_name = NULL;
<span class="lineNum">     738 </span>            :         const char *comp_name = NULL;
<span class="lineNum">     739 </span>            :         const char *imp_name = NULL;
<span class="lineNum">     740 </span>            :         const char *src_url = NULL;
<span class="lineNum">     741 </span>            :         const char *meta_mime = NULL;
<span class="lineNum">     742 </span>            :         const char *meta_encoding = NULL;
<span class="lineNum">     743 </span>            :         const char *meta_config = NULL;
<span class="lineNum">     744 </span>            :         const char *meta_xmlns = NULL;
<span class="lineNum">     745 </span>            :         const char *meta_schemaloc = NULL;
<span class="lineNum">     746 </span>            :         const char *meta_auxmimes = NULL;
<span class="lineNum">     747 </span>            :         const char *meta_content_encoding = NULL;
<span class="lineNum">     748 </span>            :         char *txt_font = NULL;
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span>            :         u32 i, count, reuse_stsd = 0;
<span class="lineNum">     751 </span>            :         GF_Err e;
<span class="lineNum">     752 </span>            :         const GF_PropertyValue *dsi=NULL;
<span class="lineNum">     753 </span>            :         const GF_PropertyValue *enh_dsi=NULL;
<span class="lineNum">     754 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">     755 </span><span class="lineCov">       2794 :         GF_MP4MuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">     756 </span><span class="lineCov">       2794 :         GF_AudioSampleEntryImportMode ase_mode = ctx-&gt;ase;</span>
<span class="lineNum">     757 </span>            :         TrackWriter *tkw;
<span class="lineNum">     758 </span>            : 
<span class="lineNum">     759 </span><span class="lineCov">       2794 :         if (ctx-&gt;owns_mov &amp;&amp; !ctx-&gt;opid) {</span>
<span class="lineNum">     760 </span>            :                 char *dst;
<span class="lineNum">     761 </span><span class="lineCov">        664 :                 ctx-&gt;opid = gf_filter_pid_new(filter);</span>
<span class="lineNum">     762 </span>            : 
<span class="lineNum">     763 </span><span class="lineCov">        664 :                 dst = gf_filter_get_dst_name(filter);</span>
<span class="lineNum">     764 </span><span class="lineCov">        664 :                 if (dst) {</span>
<span class="lineNum">     765 </span><span class="lineCov">        664 :                         char *ext = gf_file_ext_start(dst);</span>
<span class="lineNum">     766 </span><span class="lineCov">        664 :                         if (ext &amp;&amp; (!stricmp(ext, &quot;.mov&quot;) || !stricmp(ext, &quot;.qt&quot;)) ) {</span>
<span class="lineNum">     767 </span><span class="lineCov">          1 :                                 ctx-&gt;make_qt = 1;</span>
<span class="lineNum">     768 </span>            :                         }
<span class="lineNum">     769 </span><span class="lineCov">        664 :                         gf_free(dst);</span>
<span class="lineNum">     770 </span>            :                 }
<span class="lineNum">     771 </span>            :         }
<span class="lineNum">     772 </span>            :         //copy properties at init or reconfig
<span class="lineNum">     773 </span><span class="lineCov">       2794 :         if (ctx-&gt;opid &amp;&amp; is_true_pid) {</span>
<span class="lineNum">     774 </span><span class="lineCov">       1439 :                 gf_filter_pid_copy_properties(ctx-&gt;opid, pid);</span>
<span class="lineNum">     775 </span><span class="lineCov">       1439 :                 if (gf_list_count(ctx-&gt;tracks)&gt;1)</span>
<span class="lineNum">     776 </span><span class="lineCov">        145 :                         gf_filter_pid_set_name(ctx-&gt;opid, &quot;isobmf_mux&quot;);</span>
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span><span class="lineCov">       1439 :                 gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_DECODER_CONFIG, NULL);</span>
<span class="lineNum">     779 </span><span class="lineCov">       1439 :                 gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_DECODER_CONFIG_ENHANCEMENT, NULL);</span>
<span class="lineNum">     780 </span><span class="lineCov">       1439 :                 gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_CODECID, NULL);</span>
<span class="lineNum">     781 </span><span class="lineCov">       1439 :                 gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_UNFRAMED, NULL);</span>
<span class="lineNum">     782 </span><span class="lineCov">       1439 :                 gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_STREAM_TYPE, &amp;PROP_UINT(GF_STREAM_FILE) );</span>
<span class="lineNum">     783 </span>            : 
<span class="lineNum">     784 </span><span class="lineCov">       1439 :                 mux_assign_mime_file_ext(pid, ctx-&gt;opid, ISOM_FILE_EXT, ISOM_FILE_MIME, NULL);</span>
<span class="lineNum">     785 </span>            :                 
<span class="lineNum">     786 </span><span class="lineCov">       1439 :                 gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_DASH_MODE, NULL);</span>
<span class="lineNum">     787 </span>            :                 //we dispatch timing in milliseconds
<span class="lineNum">     788 </span><span class="lineCov">       1439 :                 gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_TIMESCALE, &amp;PROP_UINT(1000));</span>
<span class="lineNum">     789 </span><span class="lineCov">       1439 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_STREAM_TYPE);</span>
<span class="lineNum">     790 </span><span class="lineCov">       1439 :                 if (p)</span>
<span class="lineNum">     791 </span><span class="lineCov">       1439 :                         gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_ORIG_STREAM_TYPE, &amp;PROP_UINT(p-&gt;value.uint));</span>
<span class="lineNum">     792 </span>            : 
<span class="lineNum">     793 </span><span class="lineCov">       1439 :                 switch (ctx-&gt;store) {</span>
<span class="lineNum">     794 </span><span class="lineCov">          2 :                 case MP4MX_MODE_FLAT:</span>
<span class="lineNum">     795 </span>            :                 case MP4MX_MODE_FASTSTART:
<span class="lineNum">     796 </span><span class="lineCov">          2 :                         gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_DISABLE_PROGRESSIVE, &amp;PROP_UINT(GF_PID_FILE_PATCH_INSERT) );</span>
<span class="lineNum">     797 </span><span class="lineCov">          2 :                         break;</span>
<span class="lineNum">     798 </span><span class="lineCov">        894 :                 case MP4MX_MODE_INTER:</span>
<span class="lineNum">     799 </span>            :                 case MP4MX_MODE_TIGHT:
<span class="lineNum">     800 </span><span class="lineCov">        894 :                         gf_filter_pid_allow_direct_dispatch(ctx-&gt;opid);</span>
<span class="lineNum">     801 </span><span class="lineCov">        894 :                         break;</span>
<span class="lineNum">     802 </span>            :                 }
<span class="lineNum">     803 </span>            :         }
<span class="lineNum">     804 </span>            : 
<span class="lineNum">     805 </span><span class="lineCov">       2794 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_TILE_BASE);</span>
<span class="lineNum">     806 </span><span class="lineCov">       2794 :         if (p &amp;&amp; p-&gt;value.boolean)</span>
<span class="lineNum">     807 </span>            :                 is_tile_base = GF_TRUE;
<span class="lineNum">     808 </span>            : 
<span class="lineNum">     809 </span><span class="lineCov">       2794 :         if (is_true_pid &amp;&amp; !is_tile_base) {</span>
<span class="lineNum">     810 </span><span class="lineCov">       2762 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_DASH_MULTI_TRACK);</span>
<span class="lineNum">     811 </span><span class="lineCov">       2762 :                 if (p) {</span>
<span class="lineNum">     812 </span>            :                         u32 j, count2;
<span class="lineNum">     813 </span><span class="lineCov">          3 :                         GF_List *multi_tracks = p-&gt;value.ptr;</span>
<span class="lineNum">     814 </span><span class="lineCov">          3 :                         count = gf_list_count(multi_tracks);</span>
<span class="lineNum">     815 </span><span class="lineCov">          6 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     816 </span><span class="lineCov">          3 :                                 GF_FilterPid *a_ipid = gf_list_get(multi_tracks, i);</span>
<span class="lineNum">     817 </span><span class="lineCov">          3 :                                 const GF_PropertyValue *a_pidid = gf_filter_pid_get_property(a_ipid, GF_PROP_PID_ID);</span>
<span class="lineNum">     818 </span><span class="lineCov">          3 :                                 count2 = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">     819 </span><span class="lineCov">          3 :                                 for (j=0; j&lt;count2; j++) {</span>
<span class="lineNum">     820 </span><span class="lineCov">          3 :                                         TrackWriter *atkw = gf_list_get(ctx-&gt;tracks, j);</span>
<span class="lineNum">     821 </span><span class="lineCov">          3 :                                         const GF_PropertyValue *c_pidid = gf_filter_pid_get_property(atkw-&gt;ipid, GF_PROP_PID_ID);</span>
<span class="lineNum">     822 </span><span class="lineCov">          3 :                                         if (gf_props_equal(a_pidid, c_pidid)) {</span>
<span class="lineNum">     823 </span>            :                                                 a_ipid = NULL;
<span class="lineNum">     824 </span>            :                                                 break;
<span class="lineNum">     825 </span>            :                                         }
<span class="lineNum">     826 </span>            :                                 }
<span class="lineNum">     827 </span><span class="lineCov">          3 :                                 if (a_ipid)</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :                                         mp4_mux_setup_pid(filter, a_ipid, GF_FALSE);</span>
<span class="lineNum">     829 </span>            :                         }
<span class="lineNum">     830 </span>            :                 }
<span class="lineNum">     831 </span>            :         }
<span class="lineNum">     832 </span>            : 
<span class="lineNum">     833 </span><span class="lineCov">       2794 :         audio_pli = gf_isom_get_pl_indication(ctx-&gt;file, GF_ISOM_PL_AUDIO);</span>
<span class="lineNum">     834 </span>            : 
<span class="lineNum">     835 </span>            :         //new pid ?
<span class="lineNum">     836 </span><span class="lineCov">       2794 :         tkw = gf_filter_pid_get_udta(pid);</span>
<span class="lineNum">     837 </span><span class="lineCov">       2794 :         if (!tkw) {</span>
<span class="lineNum">     838 </span>            :                 GF_FilterEvent evt;
<span class="lineNum">     839 </span><span class="lineCov">       1387 :                 GF_SAFEALLOC(tkw, TrackWriter);</span>
<span class="lineNum">     840 </span><span class="lineCov">       1387 :                 if (!tkw) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     841 </span>            :                 
<span class="lineNum">     842 </span><span class="lineCov">       1387 :                 gf_list_add(ctx-&gt;tracks, tkw);</span>
<span class="lineNum">     843 </span><span class="lineCov">       1387 :                 tkw-&gt;ipid = pid;</span>
<span class="lineNum">     844 </span><span class="lineCov">       1387 :                 tkw-&gt;fake_track = !is_true_pid;</span>
<span class="lineNum">     845 </span><span class="lineCov">       1387 :                 tkw-&gt;min_cts = (u64) -1;</span>
<span class="lineNum">     846 </span>            : 
<span class="lineNum">     847 </span><span class="lineCov">       1387 :                 if (is_true_pid) {</span>
<span class="lineNum">     848 </span><span class="lineCov">       1360 :                         gf_filter_pid_set_udta(pid, tkw);</span>
<span class="lineNum">     849 </span>            : 
<span class="lineNum">     850 </span><span class="lineCov">       1360 :                         tkw-&gt;is_hevc_tile_base = is_tile_base;</span>
<span class="lineNum">     851 </span>            : #ifdef GPAC_ENABLE_COVERAGE
<span class="lineNum">     852 </span><span class="lineCov">       1360 :                         if (gf_sys_is_cov_mode()) {</span>
<span class="lineNum">     853 </span><span class="lineCov">       1359 :                                 gf_filter_pid_get_min_pck_duration(pid);</span>
<span class="lineNum">     854 </span>            :                         }
<span class="lineNum">     855 </span>            : #endif
<span class="lineNum">     856 </span><span class="lineCov">       1360 :                         if (!ctx-&gt;owns_mov || ctx-&gt;force_play) {</span>
<span class="lineNum">     857 </span><span class="lineCov">        624 :                                 if (!ctx-&gt;owns_mov) {</span>
<span class="lineNum">     858 </span><span class="lineCov">        615 :                                         if (ctx-&gt;start != 0)</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :                                                 tkw-&gt;wait_sap = GF_TRUE;</span>
<span class="lineNum">     860 </span><span class="lineCov">        615 :                                         gf_filter_pid_init_play_event(pid, &amp;evt, ctx-&gt;start, 0, &quot;MP4Mux&quot;);</span>
<span class="lineNum">     861 </span>            :                                 } else {
<span class="lineNum">     862 </span><span class="lineCov">          9 :                                         GF_FEVT_INIT(evt, GF_FEVT_PLAY, pid);</span>
<span class="lineNum">     863 </span>            :                                 }
<span class="lineNum">     864 </span><span class="lineCov">        624 :                                 gf_filter_pid_send_event(pid, &amp;evt);</span>
<span class="lineNum">     865 </span>            :                         }
<span class="lineNum">     866 </span><span class="lineCov">       1360 :                         gf_filter_pid_set_framing_mode(pid, GF_TRUE);</span>
<span class="lineNum">     867 </span>            : 
<span class="lineNum">     868 </span><span class="lineCov">       1360 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_ITEM_ID);</span>
<span class="lineNum">     869 </span><span class="lineCov">       1360 :                         if (p) {</span>
<span class="lineNum">     870 </span><span class="lineCov">         32 :                                 tkw-&gt;is_item = GF_TRUE;</span>
<span class="lineNum">     871 </span>            :                         } else {
<span class="lineNum">     872 </span><span class="lineCov">       1328 :                                 ctx-&gt;config_timing = GF_TRUE;</span>
<span class="lineNum">     873 </span><span class="lineCov">       1328 :                                 ctx-&gt;update_report = GF_TRUE;</span>
<span class="lineNum">     874 </span>            :                         }
<span class="lineNum">     875 </span>            :                 }
<span class="lineNum">     876 </span>            :         }
<span class="lineNum">     877 </span>            : 
<span class="lineNum">     878 </span>            :         //check change of pid config
<span class="lineNum">     879 </span><span class="lineCov">       2794 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_DEPENDENCY_ID);</span>
<span class="lineNum">     880 </span><span class="lineCov">       2794 :         if (p) {</span>
<span class="lineNum">     881 </span><span class="lineCov">         83 :                 if (p-&gt;value.uint!=tkw-&gt;dep_id) needs_track = GF_TRUE;</span>
<span class="lineNum">     882 </span><span class="lineCov">         83 :                 tkw-&gt;dep_id = p-&gt;value.uint;</span>
<span class="lineNum">     883 </span>            :         }
<span class="lineNum">     884 </span>            : 
<span class="lineNum">     885 </span>            :         //check change of pid config
<span class="lineNum">     886 </span><span class="lineCov">       2794 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_CODECID);</span>
<span class="lineNum">     887 </span><span class="lineCov">       2794 :         if (p) {</span>
<span class="lineNum">     888 </span><span class="lineCov">       2794 :                 if (p-&gt;value.uint!=tkw-&gt;codecid) needs_sample_entry = 1;</span>
<span class="lineNum">     889 </span><span class="lineCov">       2794 :                 tkw-&gt;codecid = p-&gt;value.uint;</span>
<span class="lineNum">     890 </span>            :         }
<span class="lineNum">     891 </span>            : 
<span class="lineNum">     892 </span><span class="lineCov">       2794 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_STREAM_TYPE);</span>
<span class="lineNum">     893 </span><span class="lineCov">       2794 :         if (p) {</span>
<span class="lineNum">     894 </span><span class="lineCov">       2794 :                 u32 stype = p-&gt;value.uint;</span>
<span class="lineNum">     895 </span><span class="lineCov">       2794 :                 if (tkw-&gt;is_encrypted &amp;&amp; (p-&gt;value.uint==GF_STREAM_ENCRYPTED) ) {</span>
<span class="lineNum">     896 </span><span class="lineCov">        336 :                         stype = gf_codecid_type(tkw-&gt;codecid);</span>
<span class="lineNum">     897 </span>            :                 }
<span class="lineNum">     898 </span><span class="lineCov">       2794 :                 if (stype != tkw-&gt;stream_type) {</span>
<span class="lineNum">     899 </span>            :                         needs_track = GF_TRUE;
<span class="lineNum">     900 </span><span class="lineCov">       1387 :                         tkw-&gt;stream_type = stype;</span>
<span class="lineNum">     901 </span><span class="lineCov">       1387 :                         const char *name = gf_stream_type_name(stype);</span>
<span class="lineNum">     902 </span><span class="lineCov">       1387 :                         tkw-&gt;status_type = name ? name[0] : 'U';</span>
<span class="lineNum">     903 </span>            :                 }
<span class="lineNum">     904 </span>            :         }
<span class="lineNum">     905 </span>            : 
<span class="lineNum">     906 </span><span class="lineCov">       2794 :         dsi = gf_filter_pid_get_property(pid, GF_PROP_PID_DECODER_CONFIG);</span>
<span class="lineNum">     907 </span><span class="lineCov">       2794 :         if (dsi) {</span>
<span class="lineNum">     908 </span><span class="lineCov">       2499 :                 u32 cfg_crc = gf_crc_32(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">     909 </span><span class="lineCov">       2499 :                 if (cfg_crc!=tkw-&gt;cfg_crc) needs_sample_entry = 2;</span>
<span class="lineNum">     910 </span><span class="lineCov">       2499 :                 tkw-&gt;cfg_crc = cfg_crc;</span>
<span class="lineNum">     911 </span><span class="lineCov">        295 :         } else if (tkw-&gt;cfg_crc) {</span>
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :                 tkw-&gt;cfg_crc = 0;</span>
<span class="lineNum">     913 </span>            :                 needs_sample_entry = 2;
<span class="lineNum">     914 </span>            :         }
<span class="lineNum">     915 </span>            : 
<span class="lineNum">     916 </span><span class="lineCov">       2794 :         enh_dsi = gf_filter_pid_get_property(pid, GF_PROP_PID_DECODER_CONFIG_ENHANCEMENT);</span>
<span class="lineNum">     917 </span><span class="lineCov">       2810 :         if (enh_dsi &amp;&amp; (enh_dsi-&gt;type==GF_PROP_DATA) ) {</span>
<span class="lineNum">     918 </span><span class="lineCov">         16 :                 u32 cfg_crc = gf_crc_32(enh_dsi-&gt;value.data.ptr, enh_dsi-&gt;value.data.size);</span>
<span class="lineNum">     919 </span><span class="lineCov">         16 :                 if (cfg_crc!=tkw-&gt;enh_cfg_crc) needs_sample_entry = 2;</span>
<span class="lineNum">     920 </span><span class="lineCov">         16 :                 tkw-&gt;enh_cfg_crc = cfg_crc;</span>
<span class="lineNum">     921 </span><span class="lineCov">       2778 :         } else if (tkw-&gt;enh_cfg_crc) {</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :                 tkw-&gt;enh_cfg_crc = 0;</span>
<span class="lineNum">     923 </span>            :                 needs_sample_entry = 2;
<span class="lineNum">     924 </span>            :         }
<span class="lineNum">     925 </span>            : 
<span class="lineNum">     926 </span>            :         //TODO: try to merge PPS/SPS for AVC and HEVC rather than creating a new sample description
<span class="lineNum">     927 </span>            : 
<span class="lineNum">     928 </span><span class="lineCov">       2794 :         switch (tkw-&gt;codecid) {</span>
<span class="lineNum">     929 </span><span class="lineCov">       1245 :         case GF_CODECID_AAC_MPEG4:</span>
<span class="lineNum">     930 </span>            :         case GF_CODECID_AAC_MPEG2_MP:
<span class="lineNum">     931 </span>            :         case GF_CODECID_AAC_MPEG2_LCP:
<span class="lineNum">     932 </span>            :         case GF_CODECID_AAC_MPEG2_SSRP:
<span class="lineNum">     933 </span>            :         case GF_CODECID_USAC:
<span class="lineNum">     934 </span>            :         case GF_CODECID_MPEG4_PART2:
<span class="lineNum">     935 </span>            :         case GF_CODECID_AVC:
<span class="lineNum">     936 </span>            :         case GF_CODECID_SVC:
<span class="lineNum">     937 </span>            :         case GF_CODECID_HEVC:
<span class="lineNum">     938 </span>            :         case GF_CODECID_LHVC:
<span class="lineNum">     939 </span><span class="lineCov">       1245 :                 if (!dsi &amp;&amp; !enh_dsi) return GF_OK;</span>
<span class="lineNum">     940 </span>            :                 break;
<span class="lineNum">     941 </span><span class="lineCov">          4 :         case GF_CODECID_APCH:</span>
<span class="lineNum">     942 </span>            :         case GF_CODECID_APCO:
<span class="lineNum">     943 </span>            :         case GF_CODECID_APCN:
<span class="lineNum">     944 </span>            :         case GF_CODECID_APCS:
<span class="lineNum">     945 </span>            :         case GF_CODECID_AP4X:
<span class="lineNum">     946 </span>            :         case GF_CODECID_AP4H:
<span class="lineNum">     947 </span><span class="lineCov">          4 :                 if (!ctx-&gt;make_qt) {</span>
<span class="lineNum">     948 </span><span class="lineCov">          2 :                         GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[MP4Mux] ProRes track detected, muxing to QTFF even though ISOBMFF was asked\n&quot;));</span>
<span class="lineNum">     949 </span><span class="lineCov">          2 :                         ctx-&gt;make_qt = 2;</span>
<span class="lineNum">     950 </span>            :                 }
<span class="lineNum">     951 </span><span class="lineCov">          4 :                 if (ctx-&gt;prores_track &amp;&amp; (ctx-&gt;prores_track != tkw)) {</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] More than one ProRes track detected, result might be non compliant\n&quot;));</span>
<span class="lineNum">     953 </span>            :                 }
<span class="lineNum">     954 </span>            :                 is_prores = GF_TRUE;
<span class="lineNum">     955 </span>            :                 break;
<span class="lineNum">     956 </span>            :         default:
<span class="lineNum">     957 </span>            :                 break;
<span class="lineNum">     958 </span>            :         }
<span class="lineNum">     959 </span><span class="lineCov">       2786 :         if (!tkw-&gt;track_num) {</span>
<span class="lineNum">     960 </span>            :                 needs_sample_entry = 1;
<span class="lineNum">     961 </span>            :                 needs_track = GF_TRUE;
<span class="lineNum">     962 </span>            :         }
<span class="lineNum">     963 </span>            : 
<span class="lineNum">     964 </span><span class="lineCov">       2786 :         if (ctx-&gt;make_qt) {</span>
<span class="lineNum">     965 </span><span class="lineCov">          4 :                 gf_isom_remove_root_od(ctx-&gt;file);</span>
<span class="lineNum">     966 </span><span class="lineCov">          4 :                 gf_isom_set_brand_info(ctx-&gt;file, GF_ISOM_BRAND_QT, 512);</span>
<span class="lineNum">     967 </span><span class="lineCov">          4 :                 gf_isom_reset_alt_brands(ctx-&gt;file);</span>
<span class="lineNum">     968 </span><span class="lineCov">          4 :                 tkw-&gt;has_brands = GF_TRUE;</span>
<span class="lineNum">     969 </span><span class="lineCov">          4 :                 ctx-&gt;major_brand_set = GF_ISOM_BRAND_QT;</span>
<span class="lineNum">     970 </span><span class="lineCov">          4 :                 ctx-&gt;btrt = GF_FALSE;</span>
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span><span class="lineCov">          4 :                 if (is_prores &amp;&amp; !ctx-&gt;prores_track) {</span>
<span class="lineNum">     973 </span><span class="lineCov">          3 :                         ctx-&gt;prores_track = tkw;</span>
<span class="lineNum">     974 </span>            :                 }
<span class="lineNum">     975 </span>            :         }
<span class="lineNum">     976 </span>            : 
<span class="lineNum">     977 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_URL);</span>
<span class="lineNum">     978 </span><span class="lineCov">       2786 :         if (p) src_url = p-&gt;value.string;</span>
<span class="lineNum">     979 </span>            : 
<span class="lineNum">     980 </span>            : 
<span class="lineNum">     981 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_DASH_MODE);</span>
<span class="lineNum">     982 </span><span class="lineCov">       2786 :         if (p) {</span>
<span class="lineNum">     983 </span><span class="lineCov">        360 :                 ctx-&gt;dash_mode = MP4MX_DASH_ON;</span>
<span class="lineNum">     984 </span><span class="lineCov">        360 :                 if (p-&gt;value.uint==2) {</span>
<span class="lineNum">     985 </span><span class="lineCov">         18 :                         e = mp4mx_setup_dash_vod(ctx, tkw);</span>
<span class="lineNum">     986 </span><span class="lineCov">         18 :                         if (e) return e;</span>
<span class="lineNum">     987 </span>            :                 }
<span class="lineNum">     988 </span>            :         }
<span class="lineNum">     989 </span>            :         //we consider that when muxing single segments, we are always in DASH, not VoD mode
<span class="lineNum">     990 </span><span class="lineCov">       2426 :         else if (ctx-&gt;noinit) {</span>
<span class="lineNum">     991 </span><span class="lineCov">          3 :                 ctx-&gt;dash_mode = MP4MX_DASH_ON;</span>
<span class="lineNum">     992 </span>            :         }
<span class="lineNum">     993 </span>            : 
<span class="lineNum">     994 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_LLHLS);</span>
<span class="lineNum">     995 </span><span class="lineCov">       2786 :         ctx-&gt;llhls_mode = p ? p-&gt;value.uint : 0;</span>
<span class="lineNum">     996 </span>            :         //insert tfdt in each traf for LL-HLS so that correct timing can be found when doing in-segment tune-in
<span class="lineNum">     997 </span><span class="lineCov">       2786 :         if (ctx-&gt;llhls_mode) {</span>
<span class="lineNum">     998 </span><span class="lineCov">         12 :                 ctx-&gt;tfdt_traf = GF_TRUE;</span>
<span class="lineNum">     999 </span><span class="lineCov">         12 :                 ctx-&gt;store = MP4MX_MODE_SFRAG;</span>
<span class="lineNum">    1000 </span>            :         }
<span class="lineNum">    1001 </span>            : 
<span class="lineNum">    1002 </span><span class="lineCov">       2786 :         if (!ctx-&gt;cdur_set) {</span>
<span class="lineNum">    1003 </span><span class="lineCov">       1272 :                 ctx-&gt;cdur_set = GF_TRUE;</span>
<span class="lineNum">    1004 </span><span class="lineCov">       1272 :                 if (ctx-&gt;cdur.num&lt;0) {</span>
<span class="lineNum">    1005 </span><span class="lineCov">       1022 :                         if (ctx-&gt;make_qt) {</span>
<span class="lineNum">    1006 </span><span class="lineCov">          3 :                                 ctx-&gt;cdur.num = 1000;</span>
<span class="lineNum">    1007 </span><span class="lineCov">          3 :                                 ctx-&gt;cdur.den = 2000;</span>
<span class="lineNum">    1008 </span>            :                         } else {
<span class="lineNum">    1009 </span><span class="lineCov">       1019 :                                 ctx-&gt;cdur.num = 1000;</span>
<span class="lineNum">    1010 </span><span class="lineCov">       1019 :                                 ctx-&gt;cdur.den = 1000;</span>
<span class="lineNum">    1011 </span><span class="lineCov">       1019 :                                 if (ctx-&gt;dash_mode)</span>
<span class="lineNum">    1012 </span><span class="lineCov">        301 :                                         ctx-&gt;fragdur = GF_FALSE;</span>
<span class="lineNum">    1013 </span>            :                         }
<span class="lineNum">    1014 </span><span class="lineCov">        250 :                 } else if (ctx-&gt;dash_mode)</span>
<span class="lineNum">    1015 </span><span class="lineCov">         26 :                         ctx-&gt;fragdur = GF_TRUE;</span>
<span class="lineNum">    1016 </span>            :         }
<span class="lineNum">    1017 </span>            : 
<span class="lineNum">    1018 </span><span class="lineCov">       2786 :         if (needs_track) {</span>
<span class="lineNum">    1019 </span><span class="lineCov">       1501 :                 if (ctx-&gt;init_movie_done) {</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Cannot add track to already finalized movie in fragmented file, will request a new muxer for that track\n&quot;));</span>
<span class="lineNum">    1021 </span>            :                         return GF_REQUIRES_NEW_INSTANCE;
<span class="lineNum">    1022 </span>            :                 }
<span class="lineNum">    1023 </span><span class="lineCov">       1501 :                 if (tkw-&gt;is_item) {</span>
<span class="lineNum">    1024 </span>            :                         needs_track = GF_FALSE;
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span><span class="lineCov">         48 :                         if (tkw-&gt;stream_type == GF_STREAM_ENCRYPTED) {</span>
<span class="lineNum">    1027 </span><span class="lineCov">         10 :                                 tkw-&gt;is_encrypted = GF_TRUE;</span>
<span class="lineNum">    1028 </span><span class="lineCov">         10 :                                 tkw-&gt;stream_type = gf_codecid_type(tkw-&gt;codecid);</span>
<span class="lineNum">    1029 </span><span class="lineCov">         10 :                                 tkw-&gt;insert_pssh = GF_TRUE;</span>
<span class="lineNum">    1030 </span>            :                         }
<span class="lineNum">    1031 </span>            :                 }
<span class="lineNum">    1032 </span>            :         }
<span class="lineNum">    1033 </span>            : 
<span class="lineNum">    1034 </span><span class="lineCov">       2738 :         if (needs_track) {</span>
<span class="lineNum">    1035 </span>            :                 u32 tkid=0;
<span class="lineNum">    1036 </span>            :                 u32 tk_idx=0;
<span class="lineNum">    1037 </span>            :                 u32 mtype=0;
<span class="lineNum">    1038 </span>            :                 u32 target_timescale = 0;
<span class="lineNum">    1039 </span>            : 
<span class="lineNum">    1040 </span><span class="lineCov">       1453 :                 if (ctx-&gt;make_qt &amp;&amp; (tkw-&gt;stream_type==GF_STREAM_VISUAL)) {</span>
<span class="lineNum">    1041 </span><span class="lineCov">          3 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_FPS);</span>
<span class="lineNum">    1042 </span><span class="lineCov">          3 :                         if (p) {</span>
<span class="lineNum">    1043 </span><span class="lineCov">          3 :                                 u32 ts=p-&gt;value.frac.num, inc=p-&gt;value.frac.den;</span>
<span class="lineNum">    1044 </span><span class="lineCov">          3 :                                 if (inc * 24000 == ts * 1001) target_timescale = 24000;</span>
<span class="lineNum">    1045 </span><span class="lineCov">          3 :                                 else if (inc * 2400 == ts * 100) target_timescale = 2400;</span>
<span class="lineNum">    1046 </span><span class="lineCov">          3 :                                 else if (inc * 2500 == ts * 100) target_timescale = 2500;</span>
<span class="lineNum">    1047 </span><span class="lineCov">          1 :                                 else if (inc * 30000 == ts * 1001) target_timescale = 30000;</span>
<span class="lineNum">    1048 </span><span class="lineCov">          1 :                                 else if (inc * 2997 == ts * 100) target_timescale = 30000;</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :                                 else if (inc * 3000 == ts * 100) target_timescale = 3000;</span>
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :                                 else if (inc * 5000 == ts * 100) target_timescale = 5000;</span>
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :                                 else if (inc * 60000 == ts * 1001) target_timescale = 60000;</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :                                 else if (inc * 5994 == ts * 100) target_timescale = 60000;</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :                                 else if (is_prores) {</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[ProRes] Unrecognized frame rate %g\n&quot;, ((Double)ts)/inc ));</span>
<span class="lineNum">    1055 </span>            :                                         return GF_NON_COMPLIANT_BITSTREAM;
<span class="lineNum">    1056 </span>            :                                 }
<span class="lineNum">    1057 </span>            :                         }
<span class="lineNum">    1058 </span><span class="lineCov">          3 :                         if (!ctx-&gt;prores_track)</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :                                 ctx-&gt;prores_track = tkw;</span>
<span class="lineNum">    1060 </span>            :                 }
<span class="lineNum">    1061 </span>            : 
<span class="lineNum">    1062 </span><span class="lineCov">       1453 :                 if (!ctx-&gt;moov_inserted) {</span>
<span class="lineNum">    1063 </span><span class="lineCov">       1453 :                         if (target_timescale) {</span>
<span class="lineNum">    1064 </span><span class="lineCov">          3 :                                 ctx-&gt;moovts = target_timescale;</span>
<span class="lineNum">    1065 </span><span class="lineCov">          3 :                                 gf_isom_set_timescale(ctx-&gt;file, target_timescale);</span>
<span class="lineNum">    1066 </span><span class="lineCov">       1450 :                         } else if (ctx-&gt;moovts&gt;=0) {</span>
<span class="lineNum">    1067 </span><span class="lineCov">       1446 :                                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ISOM_MOVIE_TIME);</span>
<span class="lineNum">    1068 </span><span class="lineCov">       1446 :                                 if (p &amp;&amp; p-&gt;value.lfrac.den) {</span>
<span class="lineNum">    1069 </span><span class="lineCov">        612 :                                         gf_isom_set_timescale(ctx-&gt;file, (u32) p-&gt;value.lfrac.den);</span>
<span class="lineNum">    1070 </span><span class="lineCov">        612 :                                         ctx-&gt;moovts = (u32) p-&gt;value.lfrac.den;</span>
<span class="lineNum">    1071 </span>            :                                 } else {
<span class="lineNum">    1072 </span><span class="lineCov">        834 :                                         gf_isom_set_timescale(ctx-&gt;file, ctx-&gt;moovts);</span>
<span class="lineNum">    1073 </span>            :                                 }
<span class="lineNum">    1074 </span>            :                         }
<span class="lineNum">    1075 </span><span class="lineCov">       1453 :                         if (ctx-&gt;store==MP4MX_MODE_FASTSTART) {</span>
<span class="lineNum">    1076 </span><span class="lineCov">          4 :                                 gf_isom_make_interleave_ex(ctx-&gt;file, &amp;ctx-&gt;cdur);</span>
<span class="lineNum">    1077 </span>            :                         }
<span class="lineNum">    1078 </span>            :                 }
<span class="lineNum">    1079 </span>            : 
<span class="lineNum">    1080 </span>            :                 //assign some defaults
<span class="lineNum">    1081 </span><span class="lineCov">       1453 :                 tkw-&gt;src_timescale = 0;</span>
<span class="lineNum">    1082 </span><span class="lineCov">       1453 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_TIMESCALE);</span>
<span class="lineNum">    1083 </span><span class="lineCov">       1453 :                 if (p) tkw-&gt;src_timescale = p-&gt;value.uint;</span>
<span class="lineNum">    1084 </span>            : 
<span class="lineNum">    1085 </span>            :                 u32 mtimescale = 1000;
<span class="lineNum">    1086 </span><span class="lineCov">       1453 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_SAMPLE_RATE);</span>
<span class="lineNum">    1087 </span><span class="lineCov">       1453 :                 if (p) mtimescale = p-&gt;value.uint;</span>
<span class="lineNum">    1088 </span>            :                 else {
<span class="lineNum">    1089 </span><span class="lineCov">       1161 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_FPS);</span>
<span class="lineNum">    1090 </span><span class="lineCov">       1161 :                         if (p &amp;&amp; p-&gt;value.frac.den) mtimescale = p-&gt;value.frac.den;</span>
<span class="lineNum">    1091 </span>            :                 }
<span class="lineNum">    1092 </span><span class="lineCov">       1453 :                 if (!tkw-&gt;src_timescale) {</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] No timescale specified, guessing from media: %d\n&quot;, mtimescale));</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :                         tkw-&gt;src_timescale = mtimescale;</span>
<span class="lineNum">    1095 </span>            :                 }
<span class="lineNum">    1096 </span><span class="lineCov">       1453 :                 if (target_timescale) tkw-&gt;tk_timescale = target_timescale;</span>
<span class="lineNum">    1097 </span><span class="lineCov">       1450 :                 else if (ctx-&gt;mediats&gt;0) tkw-&gt;tk_timescale = ctx-&gt;mediats;</span>
<span class="lineNum">    1098 </span><span class="lineCov">       1450 :                 else if (ctx-&gt;mediats&lt;0) tkw-&gt;tk_timescale = mtimescale;</span>
<span class="lineNum">    1099 </span><span class="lineCov">       1450 :                 else tkw-&gt;tk_timescale = tkw-&gt;src_timescale;</span>
<span class="lineNum">    1100 </span>            : 
<span class="lineNum">    1101 </span><span class="lineCov">       1453 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ESID);</span>
<span class="lineNum">    1102 </span><span class="lineCov">       1453 :                 if (!p) p = gf_filter_pid_get_property(pid, GF_PROP_PID_ID);</span>
<span class="lineNum">    1103 </span><span class="lineCov">       1453 :                 if (p) tkid = p-&gt;value.uint;</span>
<span class="lineNum">    1104 </span>            : 
<span class="lineNum">    1105 </span><span class="lineCov">       1453 :                 if (ctx-&gt;trackid) tkid = ctx-&gt;trackid;</span>
<span class="lineNum">    1106 </span>            : 
<span class="lineNum">    1107 </span><span class="lineCov">       1453 :                 if (tkw-&gt;stream_type == GF_STREAM_ENCRYPTED) {</span>
<span class="lineNum">    1108 </span><span class="lineCov">        229 :                         tkw-&gt;is_encrypted = GF_TRUE;</span>
<span class="lineNum">    1109 </span><span class="lineCov">        229 :                         tkw-&gt;stream_type = gf_codecid_type(tkw-&gt;codecid);</span>
<span class="lineNum">    1110 </span>            :                 }
<span class="lineNum">    1111 </span><span class="lineCov">       1453 :                 mtype = gf_isom_stream_type_to_media_type(tkw-&gt;stream_type, tkw-&gt;codecid);</span>
<span class="lineNum">    1112 </span>            : 
<span class="lineNum">    1113 </span><span class="lineCov">       1453 :                 if (ctx-&gt;moovts&lt;0) {</span>
<span class="lineNum">    1114 </span><span class="lineCov">          4 :                         ctx-&gt;moovts = tkw-&gt;tk_timescale;</span>
<span class="lineNum">    1115 </span><span class="lineCov">          4 :                         gf_isom_set_timescale(ctx-&gt;file, (u32) ctx-&gt;moovts);</span>
<span class="lineNum">    1116 </span>            :                 }
<span class="lineNum">    1117 </span>            : 
<span class="lineNum">    1118 </span><span class="lineCov">       1453 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_MUX_INDEX);</span>
<span class="lineNum">    1119 </span><span class="lineCov">       1453 :                 if (p) {</span>
<span class="lineNum">    1120 </span><span class="lineCov">        461 :                         tk_idx = p-&gt;value.uint;</span>
<span class="lineNum">    1121 </span><span class="lineCov">        461 :                         if (!ctx-&gt;owns_mov) {</span>
<span class="lineNum">    1122 </span><span class="lineCov">        461 :                                 u32 nb_dst_tk = gf_isom_get_track_count(ctx-&gt;file);</span>
<span class="lineNum">    1123 </span><span class="lineCov">        461 :                                 if (tk_idx &lt; nb_dst_tk) {</span>
<span class="lineNum">    1124 </span>            :                                         tk_idx = nb_dst_tk;
<span class="lineNum">    1125 </span>            :                                 }
<span class="lineNum">    1126 </span>            :                         }
<span class="lineNum">    1127 </span>            :                 }
<span class="lineNum">    1128 </span>            : 
<span class="lineNum">    1129 </span><span class="lineCov">       1453 :                 if (ctx-&gt;keep_utc) {</span>
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :                         if (!gf_isom_get_track_count(ctx-&gt;file)) {</span>
<span class="lineNum">    1131 </span>            :                                 u64 create_date=0, modif_date=0;
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :                                 p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;isom:creation_date&quot;);</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :                                 if (p &amp;&amp; (p-&gt;type==GF_PROP_LUINT)) create_date = p-&gt;value.longuint;</span>
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :                                 p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;isom:modification_date&quot;);</span>
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :                                 if (p &amp;&amp; (p-&gt;type==GF_PROP_LUINT)) modif_date = p-&gt;value.longuint;</span>
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :                                 if (create_date &amp;&amp; modif_date)</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :                                         gf_isom_set_creation_time(ctx-&gt;file, create_date, modif_date);</span>
<span class="lineNum">    1139 </span>            :                         }
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :                         gf_isom_keep_utc_times(ctx-&gt;file, GF_TRUE);</span>
<span class="lineNum">    1141 </span>            :                 }
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span><span class="lineCov">       1453 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ISOM_TRACK_TEMPLATE);</span>
<span class="lineNum">    1144 </span><span class="lineCov">       1453 :                 if (ctx-&gt;tktpl &amp;&amp; p &amp;&amp; p-&gt;value.data.ptr) {</span>
<span class="lineNum">    1145 </span><span class="lineCov">        615 :                         Bool udta_only = (ctx-&gt;tktpl==2) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1146 </span>            : 
<span class="lineNum">    1147 </span>            : 
<span class="lineNum">    1148 </span><span class="lineCov">        615 :                         tkw-&gt;track_num = gf_isom_new_track_from_template(ctx-&gt;file, tkid, mtype, tkw-&gt;tk_timescale, p-&gt;value.data.ptr, p-&gt;value.data.size, udta_only);</span>
<span class="lineNum">    1149 </span><span class="lineCov">        615 :                         if (!tkw-&gt;track_num) {</span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :                                 tkw-&gt;track_num = gf_isom_new_track_from_template(ctx-&gt;file, 0, mtype, tkw-&gt;tk_timescale, p-&gt;value.data.ptr, p-&gt;value.data.size, udta_only);</span>
<span class="lineNum">    1151 </span>            :                         }
<span class="lineNum">    1152 </span>            :                         //purge all track references we inject internally
<span class="lineNum">    1153 </span><span class="lineCov">        615 :                         if (tkw-&gt;track_num) {</span>
<span class="lineNum">    1154 </span><span class="lineCov">        615 :                                 gf_isom_remove_track_reference(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_REF_SCAL);</span>
<span class="lineNum">    1155 </span><span class="lineCov">        615 :                                 gf_isom_remove_track_reference(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_REF_SABT);</span>
<span class="lineNum">    1156 </span><span class="lineCov">        615 :                                 gf_isom_remove_track_reference(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_REF_TBAS);</span>
<span class="lineNum">    1157 </span><span class="lineCov">        615 :                                 gf_isom_remove_track_reference(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_REF_OREF);</span>
<span class="lineNum">    1158 </span><span class="lineCov">        615 :                                 gf_isom_remove_track_reference(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_REF_BASE);</span>
<span class="lineNum">    1159 </span>            :                         }
<span class="lineNum">    1160 </span>            : 
<span class="lineNum">    1161 </span><span class="lineCov">        615 :                         if (!ctx-&gt;btrt) {</span>
<span class="lineNum">    1162 </span><span class="lineCov">          1 :                                 gf_isom_update_bitrate(ctx-&gt;file, tkw-&gt;track_num, 0, 0, 0, 0);</span>
<span class="lineNum">    1163 </span>            :                         }
<span class="lineNum">    1164 </span>            :                 } else {
<span class="lineNum">    1165 </span><span class="lineCov">        838 :                         if (!mtype) {</span>
<span class="lineNum">    1166 </span>            :                                 mtype = GF_4CC('u','n','k','n');
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to find ISOM media type for stream type %s codec %s\n&quot;, gf_stream_type_name(tkw-&gt;stream_type), gf_codecid_name(tkw-&gt;codecid) ));</span>
<span class="lineNum">    1168 </span>            :                         }
<span class="lineNum">    1169 </span><span class="lineCov">        838 :                         if (!tkid) tkid = tk_idx;</span>
<span class="lineNum">    1170 </span>            : 
<span class="lineNum">    1171 </span><span class="lineCov">        838 :                         tkw-&gt;track_num = gf_isom_new_track(ctx-&gt;file, tkid, mtype, tkw-&gt;tk_timescale);</span>
<span class="lineNum">    1172 </span><span class="lineCov">        838 :                         if (!tkw-&gt;track_num) {</span>
<span class="lineNum">    1173 </span><span class="lineCov">         13 :                                 tkw-&gt;track_num = gf_isom_new_track(ctx-&gt;file, 0, mtype, tkw-&gt;tk_timescale);</span>
<span class="lineNum">    1174 </span>            :                         }
<span class="lineNum">    1175 </span>            :                         //FIXME once we finally merge to filters, there is an old bug in isobmff initializing the width and height to 320x240 which breaks text import
<span class="lineNum">    1176 </span>            :                         //this should be removed and hashes regenerated
<span class="lineNum">    1177 </span><span class="lineCov">        838 :                         gf_isom_set_track_layout_info(ctx-&gt;file, tkw-&gt;track_num, 0, 0, 0, 0, 0);</span>
<span class="lineNum">    1178 </span>            : 
<span class="lineNum">    1179 </span><span class="lineCov">        838 :                         if (!gf_sys_is_test_mode()) {</span>
<span class="lineNum">    1180 </span><span class="lineCov">          1 :                                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_URL);</span>
<span class="lineNum">    1181 </span><span class="lineCov">          1 :                                 if (tkw-&gt;track_num &amp;&amp; p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    1182 </span>            :                                         char szHName[1025];
<span class="lineNum">    1183 </span><span class="lineCov">          1 :                                         char *f = gf_file_basename(p-&gt;value.string);</span>
<span class="lineNum">    1184 </span><span class="lineCov">          1 :                                         szHName[1024]=0;</span>
<span class="lineNum">    1185 </span><span class="lineCov">          1 :                                         snprintf(szHName, 1024, &quot;*%s@GPAC%s&quot;, f ? f : &quot;&quot;, gf_gpac_version() );</span>
<span class="lineNum">    1186 </span><span class="lineCov">          1 :                                         gf_isom_set_handler_name(ctx-&gt;file, tkw-&gt;track_num, szHName);</span>
<span class="lineNum">    1187 </span>            :                                 }
<span class="lineNum">    1188 </span>            :                         }
<span class="lineNum">    1189 </span>            :                 }
<span class="lineNum">    1190 </span>            : 
<span class="lineNum">    1191 </span><span class="lineCov">       1453 :                 if (!tkw-&gt;track_num) {</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :                         e = gf_isom_last_error(ctx-&gt;file);</span>
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to create new track: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    1194 </span>            :                         return e;
<span class="lineNum">    1195 </span>            :                 }
<span class="lineNum">    1196 </span><span class="lineCov">       1453 :                 tkw-&gt;track_id = gf_isom_get_track_id(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    1197 </span><span class="lineCov">       1453 :                 tkw-&gt;next_is_first_sample = GF_TRUE;</span>
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span>            :                 //TODO: this should be the case for any new file since the redefinition of  track_in_movie and track_in_preview in ISOBMFF
<span class="lineNum">    1200 </span>            :                 //This will require modifying ALL our isobmf hashes
<span class="lineNum">    1201 </span><span class="lineCov">       1453 :                 if (ctx-&gt;cmaf) {</span>
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :                         gf_isom_set_track_flags(ctx-&gt;file, tkw-&gt;track_num, 0x7, GF_ISOM_TKFLAGS_SET);</span>
<span class="lineNum">    1203 </span>            :                 }
<span class="lineNum">    1204 </span>            : 
<span class="lineNum">    1205 </span><span class="lineCov">       1453 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_ISOM_TRACK_FLAGS);</span>
<span class="lineNum">    1206 </span><span class="lineCov">       1453 :                 if (p) {</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :                         gf_isom_set_track_flags(ctx-&gt;file, tkw-&gt;track_num, p-&gt;value.uint, GF_ISOM_TKFLAGS_SET);</span>
<span class="lineNum">    1208 </span>            :                 } else {
<span class="lineNum">    1209 </span><span class="lineCov">       1453 :                         gf_isom_set_track_enabled(ctx-&gt;file, tkw-&gt;track_num, GF_TRUE);</span>
<span class="lineNum">    1210 </span>            :                 }
<span class="lineNum">    1211 </span>            : 
<span class="lineNum">    1212 </span>            :                 //if we have a subtype set for the pid, use it
<span class="lineNum">    1213 </span><span class="lineCov">       1453 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_SUBTYPE);</span>
<span class="lineNum">    1214 </span><span class="lineCov">       1453 :                 if (p) gf_isom_set_media_type(ctx-&gt;file, tkw-&gt;track_num, p-&gt;value.uint);</span>
<span class="lineNum">    1215 </span>            : 
<span class="lineNum">    1216 </span><span class="lineCov">       1453 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_ISOM_HANDLER);</span>
<span class="lineNum">    1217 </span><span class="lineCov">       1453 :                 if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :                         gf_isom_set_handler_name(ctx-&gt;file, tkw-&gt;track_num, p-&gt;value.string);</span>
<span class="lineNum">    1219 </span>            :                 }
<span class="lineNum">    1220 </span>            : 
<span class="lineNum">    1221 </span><span class="lineCov">       1453 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_ISOM_TRACK_MATRIX);</span>
<span class="lineNum">    1222 </span><span class="lineCov">       1453 :                 if (p &amp;&amp; (p-&gt;value.uint_list.nb_items==9)) {</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :                         gf_isom_set_track_matrix(ctx-&gt;file, tkw-&gt;track_num, (s32 *) p-&gt;value.uint_list.vals);</span>
<span class="lineNum">    1224 </span>            :                 }
<span class="lineNum">    1225 </span>            : 
<span class="lineNum">    1226 </span><span class="lineCov">       1453 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_SRC_MAGIC);</span>
<span class="lineNum">    1227 </span><span class="lineCov">       1453 :                 if (p) {</span>
<span class="lineNum">    1228 </span><span class="lineCov">        561 :                         gf_isom_set_track_magic(ctx-&gt;file, tkw-&gt;track_num, p-&gt;value.longuint);</span>
<span class="lineNum">    1229 </span>            :                 }
<span class="lineNum">    1230 </span><span class="lineCov">       1453 :                 if (tk_idx) {</span>
<span class="lineNum">    1231 </span><span class="lineCov">        461 :                         gf_isom_set_track_index(ctx-&gt;file, tkw-&gt;track_num, tk_idx, mp4mux_track_reorder, ctx);</span>
<span class="lineNum">    1232 </span><span class="lineCov">        461 :                         mp4mux_reorder_tracks(ctx);</span>
<span class="lineNum">    1233 </span>            :                 }
<span class="lineNum">    1234 </span>            : 
<span class="lineNum">    1235 </span>            :                 //by default use cttsv1 (negative ctts)
<span class="lineNum">    1236 </span><span class="lineCov">       1453 :                 gf_isom_set_composition_offset_mode(ctx-&gt;file, tkw-&gt;track_num, GF_TRUE);</span>
<span class="lineNum">    1237 </span>            : 
<span class="lineNum">    1238 </span><span class="lineCov">       1453 :                 p = ctx-&gt;make_qt ? NULL : gf_filter_pid_get_property(pid, GF_PROP_PID_PROFILE_LEVEL);</span>
<span class="lineNum">    1239 </span><span class="lineCov">       1450 :                 if (p) {</span>
<span class="lineNum">    1240 </span><span class="lineCov">        512 :                         tkw-&gt;media_profile_level = p-&gt;value.uint;</span>
<span class="lineNum">    1241 </span><span class="lineCov">        512 :                         if (tkw-&gt;stream_type == GF_STREAM_AUDIO) {</span>
<span class="lineNum">    1242 </span>            :                                 //patch to align old arch (IOD not written in dash) with new
<span class="lineNum">    1243 </span><span class="lineCov">        203 :                                 if (!ctx-&gt;dash_mode) {</span>
<span class="lineNum">    1244 </span><span class="lineCov">        142 :                                         gf_isom_set_pl_indication(ctx-&gt;file, GF_ISOM_PL_AUDIO, p-&gt;value.uint);</span>
<span class="lineNum">    1245 </span>            :                                 }
<span class="lineNum">    1246 </span><span class="lineCov">        309 :                         } else if (tkw-&gt;stream_type == GF_STREAM_VISUAL) {</span>
<span class="lineNum">    1247 </span>            :                                 //patch to align old arch (IOD not written in dash) with new
<span class="lineNum">    1248 </span><span class="lineCov">        309 :                                 if (!ctx-&gt;dash_mode) {</span>
<span class="lineNum">    1249 </span><span class="lineCov">        167 :                                         gf_isom_set_pl_indication(ctx-&gt;file, GF_ISOM_PL_VISUAL, p-&gt;value.uint);</span>
<span class="lineNum">    1250 </span>            :                                 }
<span class="lineNum">    1251 </span>            :                         }
<span class="lineNum">    1252 </span>            :                 }
<span class="lineNum">    1253 </span>            : 
<span class="lineNum">    1254 </span><span class="lineCov">       1453 :                 if (ctx-&gt;mudta &amp;&amp; gf_isom_get_track_count(ctx-&gt;file)==1) {</span>
<span class="lineNum">    1255 </span><span class="lineCov">       1213 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_ISOM_UDTA);</span>
<span class="lineNum">    1256 </span><span class="lineCov">       1213 :                         if (ctx-&gt;tktpl &amp;&amp; p &amp;&amp; p-&gt;value.data.ptr) {</span>
<span class="lineNum">    1257 </span><span class="lineCov">        164 :                                 gf_isom_load_extra_boxes(ctx-&gt;file, p-&gt;value.data.ptr, p-&gt;value.data.size, (ctx-&gt;mudta==2) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    1258 </span>            :                         }
<span class="lineNum">    1259 </span>            :                 }
<span class="lineNum">    1260 </span>            : 
<span class="lineNum">    1261 </span><span class="lineCov">       1453 :                 if (ctx-&gt;sgpd_traf)</span>
<span class="lineNum">    1262 </span><span class="lineCov">          1 :                         gf_isom_set_sample_group_in_traf(ctx-&gt;file);</span>
<span class="lineNum">    1263 </span>            : 
<span class="lineNum">    1264 </span><span class="lineCov">       1453 :                 if (ctx-&gt;noroll) {</span>
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :                         gf_isom_remove_sample_group(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_SAMPLE_GROUP_ROLL);</span>
<span class="lineNum">    1266 </span>            :                 }
<span class="lineNum">    1267 </span>            : 
<span class="lineNum">    1268 </span>            : 
<span class="lineNum">    1269 </span><span class="lineCov">       1453 :                 if (ctx-&gt;dash_mode==MP4MX_DASH_VOD) {</span>
<span class="lineNum">    1270 </span><span class="lineCov">         18 :                         Bool use_cache = (ctx-&gt;vodcache == MP4MX_VODCACHE_ON) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1271 </span><span class="lineCov">         18 :                         if ((ctx-&gt;vodcache == MP4MX_VODCACHE_REPLACE) &amp;&amp; (!ctx-&gt;media_dur || !ctx-&gt;dash_dur.num) ) {</span>
<span class="lineNum">    1272 </span>            :                                 use_cache = GF_TRUE;
<span class="lineNum">    1273 </span>            :                         }
<span class="lineNum">    1274 </span>            : 
<span class="lineNum">    1275 </span><span class="lineCov">         18 :                         if (ctx-&gt;vodcache==MP4MX_VODCACHE_INSERT) {</span>
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_DISABLE_PROGRESSIVE, &amp;PROP_UINT(GF_PID_FILE_PATCH_INSERT) );</span>
<span class="lineNum">    1277 </span>            :                         }
<span class="lineNum">    1278 </span><span class="lineCov">         18 :                         else if (!use_cache) {</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_DISABLE_PROGRESSIVE, &amp;PROP_UINT(GF_PID_FILE_PATCH_REPLACE) );</span>
<span class="lineNum">    1280 </span>            :                         }
<span class="lineNum">    1281 </span>            :                 }
<span class="lineNum">    1282 </span>            : 
<span class="lineNum">    1283 </span><span class="lineCov">       1453 :                 if (gf_sys_old_arch_compat()) {</span>
<span class="lineNum">    1284 </span><span class="lineCov">       1433 :                         p = gf_filter_pid_get_property_str(pid, &quot;isom_force_ctts&quot;);</span>
<span class="lineNum">    1285 </span><span class="lineCov">       1433 :                         if (p &amp;&amp; p-&gt;value.boolean) tkw-&gt;force_ctts = GF_TRUE;</span>
<span class="lineNum">    1286 </span>            :                 }
<span class="lineNum">    1287 </span>            :         }
<span class="lineNum">    1288 </span>            : 
<span class="lineNum">    1289 </span><span class="lineCov">       2786 :         if (!tkw-&gt;has_brands) {</span>
<span class="lineNum">    1290 </span>            :                 Bool is_isom = GF_FALSE;
<span class="lineNum">    1291 </span><span class="lineCov">       2194 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ISOM_MBRAND);</span>
<span class="lineNum">    1292 </span><span class="lineCov">       2194 :                 if (p) {</span>
<span class="lineNum">    1293 </span><span class="lineCov">        532 :                         if (!ctx-&gt;major_brand_set) {</span>
<span class="lineNum">    1294 </span><span class="lineCov">        478 :                                 gf_isom_set_brand_info(ctx-&gt;file, p-&gt;value.uint, 1);</span>
<span class="lineNum">    1295 </span><span class="lineCov">        478 :                                 ctx-&gt;major_brand_set = p-&gt;value.uint;</span>
<span class="lineNum">    1296 </span>            :                         } else {
<span class="lineNum">    1297 </span><span class="lineCov">         54 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, p-&gt;value.uint, GF_TRUE);</span>
<span class="lineNum">    1298 </span>            :                         }
<span class="lineNum">    1299 </span><span class="lineCov">        532 :                         if (p-&gt;value.uint == GF_ISOM_BRAND_ISOM) is_isom = GF_TRUE;</span>
<span class="lineNum">    1300 </span>            :                 }
<span class="lineNum">    1301 </span><span class="lineCov">       2194 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ISOM_BRANDS);</span>
<span class="lineNum">    1302 </span><span class="lineCov">       2194 :                 if (p &amp;&amp; p-&gt;value.uint_list.nb_items) {</span>
<span class="lineNum">    1303 </span><span class="lineCov">        532 :                         tkw-&gt;has_brands = GF_TRUE;</span>
<span class="lineNum">    1304 </span><span class="lineCov">        532 :                         if (!ctx-&gt;major_brand_set) {</span>
<span class="lineNum">    1305 </span><span class="lineNoCov">          0 :                                 ctx-&gt;major_brand_set = p-&gt;value.uint_list.vals[0];</span>
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :                                 gf_isom_set_brand_info(ctx-&gt;file, p-&gt;value.uint_list.vals[0], 1);</span>
<span class="lineNum">    1307 </span>            :                         }
<span class="lineNum">    1308 </span>            :                         //reset alt brands, push old ones
<span class="lineNum">    1309 </span><span class="lineCov">        532 :                         gf_isom_reset_alt_brands_ex(ctx-&gt;file, GF_TRUE);</span>
<span class="lineNum">    1310 </span><span class="lineCov">       1424 :                         for (i=0; i&lt;p-&gt;value.uint_list.nb_items; i++) {</span>
<span class="lineNum">    1311 </span><span class="lineCov">        892 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, p-&gt;value.uint_list.vals[i], GF_TRUE);</span>
<span class="lineNum">    1312 </span><span class="lineCov">        892 :                                 if (p-&gt;value.uint_list.vals[i] == GF_ISOM_BRAND_ISOM) is_isom = GF_TRUE;</span>
<span class="lineNum">    1313 </span>            :                         }
<span class="lineNum">    1314 </span>            :                         //and in case it was not present add major brand
<span class="lineNum">    1315 </span><span class="lineCov">        532 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, ctx-&gt;major_brand_set, GF_TRUE);</span>
<span class="lineNum">    1316 </span>            :                 }
<span class="lineNum">    1317 </span><span class="lineCov">       2194 :                 if (!ctx-&gt;m4sys &amp;&amp; !is_isom &amp;&amp; !ctx-&gt;def_brand_patched) {</span>
<span class="lineNum">    1318 </span>            :                         //remove default brand
<span class="lineNum">    1319 </span><span class="lineCov">        945 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISOM, GF_FALSE);</span>
<span class="lineNum">    1320 </span><span class="lineCov">        945 :                         ctx-&gt;def_brand_patched = GF_TRUE;</span>
<span class="lineNum">    1321 </span>            :                 }
<span class="lineNum">    1322 </span>            : 
<span class="lineNum">    1323 </span><span class="lineCov">       2194 :                 if (ctx-&gt;cmaf) {</span>
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, (ctx-&gt;cmaf==MP4MX_CMAF_CMF2) ? GF_ISOM_BRAND_CMF2 : GF_ISOM_BRAND_CMFC, GF_TRUE);</span>
<span class="lineNum">    1325 </span>            :                 }
<span class="lineNum">    1326 </span>            :         }
<span class="lineNum">    1327 </span>            : 
<span class="lineNum">    1328 </span><span class="lineCov">       2786 :         width = height = sr = nb_chan = z_order = txt_fsize = 0;</span>
<span class="lineNum">    1329 </span>            :         nb_bps = 16;
<span class="lineNum">    1330 </span>            :         ch_layout = 0;
<span class="lineNum">    1331 </span>            :         fps.num = 25;
<span class="lineNum">    1332 </span>            :         fps.den = 1;
<span class="lineNum">    1333 </span>            :         sar.num = sar.den = 0;
<span class="lineNum">    1334 </span><span class="lineCov">       2786 :         codec_id = tkw-&gt;codecid;</span>
<span class="lineNum">    1335 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_DASH_MULTI_PID);</span>
<span class="lineNum">    1336 </span><span class="lineCov">       2786 :         if (p) {</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :                 multi_pid_stsd = p-&gt;value.ptr;</span>
<span class="lineNum">    1338 </span>            : 
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_DASH_MULTI_PID_IDX);</span>
<span class="lineNum">    1340 </span>            :                 assert(p);
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :                 multi_pid_final_stsd_idx = p-&gt;value.uint;</span>
<span class="lineNum">    1342 </span>            : 
<span class="lineNum">    1343 </span>            :                 //should never be the case
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :                 ctx-&gt;xps_inband = 0;</span>
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :                 ctx-&gt;dref = GF_FALSE;</span>
<span class="lineNum">    1346 </span>            :                 orig_pid = pid;
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :                 goto multipid_stsd_setup;</span>
<span class="lineNum">    1348 </span>            :         }
<span class="lineNum">    1349 </span>            : 
<span class="lineNum">    1350 </span>            : 
<span class="lineNum">    1351 </span>            :         //WARNING !! from this point on until the goto multipid_stsd_setup, use pid and not tkw-&gt;ipid
<span class="lineNum">    1352 </span>            :         //so that we setup the sample entry properly for each PIDs
<span class="lineNum">    1353 </span><span class="lineCov">       2786 : sample_entry_setup:</span>
<span class="lineNum">    1354 </span>            : 
<span class="lineNum">    1355 </span><span class="lineCov">       2786 :         use_m4sys = ctx-&gt;m4sys;</span>
<span class="lineNum">    1356 </span>            :         use_gen_sample_entry = GF_TRUE;
<span class="lineNum">    1357 </span><span class="lineCov">       2786 :         use_dref = ctx-&gt;dref;</span>
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_WIDTH);</span>
<span class="lineNum">    1360 </span><span class="lineCov">       2786 :         if (p) width = p-&gt;value.uint;</span>
<span class="lineNum">    1361 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_HEIGHT);</span>
<span class="lineNum">    1362 </span><span class="lineCov">       2786 :         if (p) height = p-&gt;value.uint;</span>
<span class="lineNum">    1363 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_FPS);</span>
<span class="lineNum">    1364 </span><span class="lineCov">       2786 :         if (p) fps = p-&gt;value.frac;</span>
<span class="lineNum">    1365 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_SAR);</span>
<span class="lineNum">    1366 </span><span class="lineCov">       2786 :         if (p) sar = p-&gt;value.frac;</span>
<span class="lineNum">    1367 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_ZORDER);</span>
<span class="lineNum">    1368 </span><span class="lineCov">       2786 :         if (p) z_order = p-&gt;value.uint;</span>
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_SAMPLE_RATE);</span>
<span class="lineNum">    1371 </span><span class="lineCov">       2786 :         if (p) sr = p-&gt;value.uint;</span>
<span class="lineNum">    1372 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_NUM_CHANNELS);</span>
<span class="lineNum">    1373 </span><span class="lineCov">       2786 :         if (p) nb_chan = p-&gt;value.uint;</span>
<span class="lineNum">    1374 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_AUDIO_BPS);</span>
<span class="lineNum">    1375 </span><span class="lineCov">       2786 :         if (p) nb_bps = p-&gt;value.uint;</span>
<span class="lineNum">    1376 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_CHANNEL_LAYOUT);</span>
<span class="lineNum">    1377 </span><span class="lineCov">       2786 :         if (p) ch_layout = p-&gt;value.longuint;</span>
<span class="lineNum">    1378 </span>            : 
<span class="lineNum">    1379 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_LANGUAGE);</span>
<span class="lineNum">    1380 </span><span class="lineCov">       2786 :         if (p) lang_name = p-&gt;value.string;</span>
<span class="lineNum">    1381 </span>            : 
<span class="lineNum">    1382 </span><span class="lineCov">       2786 :         if (is_true_pid) {</span>
<span class="lineNum">    1383 </span><span class="lineCov">       2759 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_NB_FRAMES);</span>
<span class="lineNum">    1384 </span><span class="lineCov">       2759 :                 if (p) tkw-&gt;nb_frames = p-&gt;value.uint;</span>
<span class="lineNum">    1385 </span><span class="lineCov">       1595 :                 else tkw-&gt;nb_frames = 0;</span>
<span class="lineNum">    1386 </span>            :         }
<span class="lineNum">    1387 </span><span class="lineCov">       2786 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_ISOM_SUBTYPE);</span>
<span class="lineNum">    1388 </span><span class="lineCov">       2786 :         if (p) m_subtype_src = p-&gt;value.uint;</span>
<span class="lineNum">    1389 </span>            : 
<span class="lineNum">    1390 </span>            : 
<span class="lineNum">    1391 </span>            :         //get our subtype
<span class="lineNum">    1392 </span><span class="lineCov">       2786 :         switch (codec_id) {</span>
<span class="lineNum">    1393 </span><span class="lineCov">         82 :         case GF_CODECID_MPEG_AUDIO:</span>
<span class="lineNum">    1394 </span>            :         case GF_CODECID_MPEG2_PART3:
<span class="lineNum">    1395 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_MP3;
<span class="lineNum">    1396 </span>            :                 comp_name = &quot;MP3&quot;;
<span class="lineNum">    1397 </span>            :                 //if source had a DSI, this was mpeg4 systems signaling, reuse that
<span class="lineNum">    1398 </span><span class="lineCov">         82 :                 if (dsi)</span>
<span class="lineNum">    1399 </span>            :                         use_m4sys = GF_TRUE;
<span class="lineNum">    1400 </span>            :                 break;
<span class="lineNum">    1401 </span><span class="lineCov">        350 :         case GF_CODECID_AAC_MPEG4:</span>
<span class="lineNum">    1402 </span>            :         case GF_CODECID_AAC_MPEG2_MP:
<span class="lineNum">    1403 </span>            :         case GF_CODECID_AAC_MPEG2_LCP:
<span class="lineNum">    1404 </span>            :         case GF_CODECID_AAC_MPEG2_SSRP:
<span class="lineNum">    1405 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_MPEG4;
<span class="lineNum">    1406 </span>            :                 use_m4sys = GF_TRUE;
<span class="lineNum">    1407 </span>            :                 comp_name = &quot;AAC&quot;;
<span class="lineNum">    1408 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1409 </span>            : 
<span class="lineNum">    1410 </span><span class="lineCov">        350 :                 if (ctx-&gt;importer) {</span>
<span class="lineNum">    1411 </span><span class="lineCov">         74 :                         const char *pid_args = gf_filter_pid_get_args(pid);</span>
<span class="lineNum">    1412 </span><span class="lineCov">         74 :                         if (pid_args) {</span>
<span class="lineNum">    1413 </span><span class="lineCov">         74 :                                 Bool sbr_i = strstr(pid_args, &quot;sbr=imp&quot;) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1414 </span><span class="lineCov">         74 :                                 Bool sbr_x = strstr(pid_args, &quot;sbr=exp&quot;) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1415 </span><span class="lineCov">         74 :                                 Bool ps_i = strstr(pid_args, &quot;ps=imp&quot;) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1416 </span><span class="lineCov">         74 :                                 Bool ps_x = strstr(pid_args, &quot;ps=exp&quot;) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1417 </span>            : 
<span class="lineNum">    1418 </span><span class="lineCov">         74 :                                 if (sbr_x) {</span>
<span class="lineNum">    1419 </span><span class="lineCov">          3 :                                         if (ps_i) imp_name = &quot;AAC explicit SBR implict PS&quot;;</span>
<span class="lineNum">    1420 </span><span class="lineCov">          2 :                                         else if (ps_x) imp_name = &quot;AAC explicit SBR+PS&quot;;</span>
<span class="lineNum">    1421 </span>            :                                         else imp_name = &quot;AAC explicit SBR&quot;;
<span class="lineNum">    1422 </span><span class="lineCov">         71 :                                 } else if (sbr_i) {</span>
<span class="lineNum">    1423 </span><span class="lineCov">          3 :                                         if (ps_i) imp_name = &quot;AAC implicit SBR+PS&quot;;</span>
<span class="lineNum">    1424 </span><span class="lineCov">          2 :                                         else if (ps_x) imp_name = &quot;AAC implicit SBR explicit PS&quot;;</span>
<span class="lineNum">    1425 </span>            :                                         else imp_name = &quot;AAC implicit SBR&quot;;
<span class="lineNum">    1426 </span>            :                                 } else {
<span class="lineNum">    1427 </span><span class="lineCov">         68 :                                         if (ps_i) imp_name = &quot;AAC implicit PS&quot;;</span>
<span class="lineNum">    1428 </span><span class="lineCov">         67 :                                         else if (ps_x) imp_name = &quot;AAC explicit PS&quot;;</span>
<span class="lineNum">    1429 </span>            :                                         else imp_name = &quot;AAC &quot;;
<span class="lineNum">    1430 </span>            :                                 }
<span class="lineNum">    1431 </span>            :                         }
<span class="lineNum">    1432 </span>            :                 }
<span class="lineNum">    1433 </span>            :                 break;
<span class="lineNum">    1434 </span>            :         case GF_CODECID_USAC:
<span class="lineNum">    1435 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_MPEG4;
<span class="lineNum">    1436 </span>            :                 use_m4sys = GF_TRUE;
<span class="lineNum">    1437 </span>            :                 comp_name = &quot;xHE-AAC / USAC&quot;;
<span class="lineNum">    1438 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1439 </span>            :                 break;
<span class="lineNum">    1440 </span><span class="lineCov">         38 :         case GF_CODECID_JPEG:</span>
<span class="lineNum">    1441 </span>            :                 m_subtype = GF_ISOM_BOX_TYPE_JPEG;
<span class="lineNum">    1442 </span>            :                 comp_name = &quot;JPEG&quot;;
<span class="lineNum">    1443 </span><span class="lineCov">         38 :                 break;</span>
<span class="lineNum">    1444 </span><span class="lineCov">         21 :         case GF_CODECID_PNG:</span>
<span class="lineNum">    1445 </span>            :                 m_subtype = GF_ISOM_BOX_TYPE_PNG;
<span class="lineNum">    1446 </span>            :                 comp_name = &quot;PNG&quot;;
<span class="lineNum">    1447 </span><span class="lineCov">         21 :                 break;</span>
<span class="lineNum">    1448 </span><span class="lineCov">          7 :         case GF_CODECID_J2K:</span>
<span class="lineNum">    1449 </span>            :                 m_subtype = GF_ISOM_BOX_TYPE_MJP2;
<span class="lineNum">    1450 </span>            :                 comp_name = &quot;JPEG2000&quot;;
<span class="lineNum">    1451 </span>            :                 use_mj2 = GF_TRUE;
<span class="lineNum">    1452 </span><span class="lineCov">          7 :                 break;</span>
<span class="lineNum">    1453 </span>            : 
<span class="lineNum">    1454 </span><span class="lineCov">          8 :         case GF_CODECID_AMR:</span>
<span class="lineNum">    1455 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_3GP_AMR;
<span class="lineNum">    1456 </span>            :                 comp_name = &quot;AMR&quot;;
<span class="lineNum">    1457 </span>            :                 use_3gpp_config = GF_TRUE;
<span class="lineNum">    1458 </span><span class="lineCov">          8 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_AMR_MODE_SET);</span>
<span class="lineNum">    1459 </span><span class="lineCov">          8 :                 if (p &amp;&amp; (p-&gt;value.uint!=tkw-&gt;amr_mode_set)) {</span>
<span class="lineNum">    1460 </span><span class="lineCov">          3 :                         tkw-&gt;amr_mode_set = p-&gt;value.uint;</span>
<span class="lineNum">    1461 </span>            :                         needs_sample_entry = 2;
<span class="lineNum">    1462 </span>            :                 }
<span class="lineNum">    1463 </span>            :                 break;
<span class="lineNum">    1464 </span><span class="lineCov">          4 :         case GF_CODECID_AMR_WB:</span>
<span class="lineNum">    1465 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_3GP_AMR_WB;
<span class="lineNum">    1466 </span>            :                 comp_name = &quot;AMR-WB&quot;;
<span class="lineNum">    1467 </span>            :                 use_3gpp_config = GF_TRUE;
<span class="lineNum">    1468 </span><span class="lineCov">          4 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_AMR_MODE_SET);</span>
<span class="lineNum">    1469 </span><span class="lineCov">          4 :                 if (p &amp;&amp; (p-&gt;value.uint!=tkw-&gt;amr_mode_set)) {</span>
<span class="lineNum">    1470 </span><span class="lineCov">          2 :                         tkw-&gt;amr_mode_set = p-&gt;value.uint;</span>
<span class="lineNum">    1471 </span>            :                         needs_sample_entry = 2;
<span class="lineNum">    1472 </span>            :                 }
<span class="lineNum">    1473 </span>            :                 break;
<span class="lineNum">    1474 </span><span class="lineCov">          1 :         case GF_CODECID_EVRC:</span>
<span class="lineNum">    1475 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_3GP_EVRC;
<span class="lineNum">    1476 </span>            :                 comp_name = &quot;EVRC&quot;;
<span class="lineNum">    1477 </span>            :                 use_3gpp_config = GF_TRUE;
<span class="lineNum">    1478 </span><span class="lineCov">          1 :                 break;</span>
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :         case GF_CODECID_SMV:</span>
<span class="lineNum">    1480 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_3GP_SMV;
<span class="lineNum">    1481 </span>            :                 comp_name = &quot;SMV&quot;;
<span class="lineNum">    1482 </span>            :                 use_3gpp_config = GF_TRUE;
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1484 </span><span class="lineCov">          3 :         case GF_CODECID_QCELP:</span>
<span class="lineNum">    1485 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_3GP_QCELP;
<span class="lineNum">    1486 </span>            :                 comp_name = &quot;QCELP&quot;;
<span class="lineNum">    1487 </span>            :                 use_3gpp_config = GF_TRUE;
<span class="lineNum">    1488 </span><span class="lineCov">          3 :                 break;</span>
<span class="lineNum">    1489 </span><span class="lineCov">          5 :         case GF_CODECID_S263:</span>
<span class="lineNum">    1490 </span>            :         case GF_CODECID_H263:
<span class="lineNum">    1491 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_3GP_H263;
<span class="lineNum">    1492 </span>            :                 comp_name = &quot;H263&quot;;
<span class="lineNum">    1493 </span>            :                 use_3gpp_config = GF_TRUE;
<span class="lineNum">    1494 </span><span class="lineCov">          5 :                 break;</span>
<span class="lineNum">    1495 </span><span class="lineCov">          9 :         case GF_CODECID_AC3:</span>
<span class="lineNum">    1496 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_AC3;
<span class="lineNum">    1497 </span>            :                 comp_name = &quot;AC-3&quot;;
<span class="lineNum">    1498 </span>            :                 use_ac3_entry = GF_TRUE;
<span class="lineNum">    1499 </span><span class="lineCov">          9 :                 break;</span>
<span class="lineNum">    1500 </span><span class="lineCov">          2 :         case GF_CODECID_EAC3:</span>
<span class="lineNum">    1501 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_AC3;
<span class="lineNum">    1502 </span>            :                 comp_name = &quot;EAC-3&quot;;
<span class="lineNum">    1503 </span>            :                 use_ac3_entry = GF_TRUE;
<span class="lineNum">    1504 </span><span class="lineCov">          2 :                 break;</span>
<span class="lineNum">    1505 </span><span class="lineCov">          1 :         case GF_CODECID_MPHA:</span>
<span class="lineNum">    1506 </span><span class="lineCov">          1 :                 if ((m_subtype_src!=GF_ISOM_SUBTYPE_MH3D_MHA1) &amp;&amp; (m_subtype_src!=GF_ISOM_SUBTYPE_MH3D_MHA2))</span>
<span class="lineNum">    1507 </span>            :                         m_subtype = GF_ISOM_SUBTYPE_MH3D_MHA1;
<span class="lineNum">    1508 </span>            :                 else
<span class="lineNum">    1509 </span>            :                         m_subtype = m_subtype_src;
<span class="lineNum">    1510 </span>            :                 comp_name = &quot;MPEG-H Audio&quot;;
<span class="lineNum">    1511 </span>            :                 nb_chan = 0;
<span class="lineNum">    1512 </span>            :                 break;
<span class="lineNum">    1513 </span><span class="lineCov">          2 :         case GF_CODECID_MHAS:</span>
<span class="lineNum">    1514 </span><span class="lineCov">          2 :                 if ((m_subtype_src!=GF_ISOM_SUBTYPE_MH3D_MHM1) &amp;&amp; (m_subtype_src!=GF_ISOM_SUBTYPE_MH3D_MHM2))</span>
<span class="lineNum">    1515 </span>            :                         m_subtype = GF_ISOM_SUBTYPE_MH3D_MHM1;
<span class="lineNum">    1516 </span>            :                 else
<span class="lineNum">    1517 </span>            :                         m_subtype = m_subtype_src;
<span class="lineNum">    1518 </span>            :                 comp_name = &quot;MPEG-H AudioMux&quot;;
<span class="lineNum">    1519 </span>            :                 nb_chan = 0;
<span class="lineNum">    1520 </span>            :                 break;
<span class="lineNum">    1521 </span><span class="lineCov">          2 :         case GF_CODECID_FLAC:</span>
<span class="lineNum">    1522 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_FLAC;
<span class="lineNum">    1523 </span>            :                 comp_name = &quot;FLAC&quot;;
<span class="lineNum">    1524 </span>            :                 use_flac_entry = GF_TRUE;
<span class="lineNum">    1525 </span><span class="lineCov">          2 :                 break;</span>
<span class="lineNum">    1526 </span><span class="lineCov">          2 :         case GF_CODECID_OPUS:</span>
<span class="lineNum">    1527 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_OPUS;
<span class="lineNum">    1528 </span>            :                 comp_name = &quot;Opus&quot;;
<span class="lineNum">    1529 </span>            :                 use_opus = GF_TRUE;
<span class="lineNum">    1530 </span><span class="lineCov">          2 :                 break;</span>
<span class="lineNum">    1531 </span><span class="lineCov">         86 :         case GF_CODECID_MPEG4_PART2:</span>
<span class="lineNum">    1532 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_MPEG4;
<span class="lineNum">    1533 </span>            :                 use_m4sys = GF_TRUE;
<span class="lineNum">    1534 </span>            :                 comp_name = &quot;MPEG-4 Visual Part 2&quot;;
<span class="lineNum">    1535 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1536 </span><span class="lineCov">         86 :                 break;</span>
<span class="lineNum">    1537 </span><span class="lineCov">        519 :         case GF_CODECID_AVC:</span>
<span class="lineNum">    1538 </span>            :         case GF_CODECID_SVC:
<span class="lineNum">    1539 </span><span class="lineCov">        519 :                 m_subtype = ((ctx-&gt;xps_inband==1) || (ctx-&gt;xps_inband==2)) ? GF_ISOM_SUBTYPE_AVC3_H264 : GF_ISOM_SUBTYPE_AVC_H264;</span>
<span class="lineNum">    1540 </span>            :                 use_avc = GF_TRUE;
<span class="lineNum">    1541 </span><span class="lineCov">        519 :                 comp_name = (codec_id == GF_CODECID_SVC) ? &quot;MPEG-4 SVC&quot; : &quot;MPEG-4 AVC&quot;;</span>
<span class="lineNum">    1542 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1543 </span><span class="lineCov">        519 :                 if (ctx-&gt;xps_inband) {</span>
<span class="lineNum">    1544 </span>            :                         use_m4sys = GF_FALSE;
<span class="lineNum">    1545 </span><span class="lineCov">         23 :                         if (ctx-&gt;xps_inband==1) skip_dsi = GF_TRUE;</span>
<span class="lineNum">    1546 </span>            :                 }
<span class="lineNum">    1547 </span>            :                 break;
<span class="lineNum">    1548 </span><span class="lineCov">        280 :         case GF_CODECID_HEVC:</span>
<span class="lineNum">    1549 </span>            :         case GF_CODECID_LHVC:
<span class="lineNum">    1550 </span><span class="lineCov">        280 :                 m_subtype = ((ctx-&gt;xps_inband==1) || (ctx-&gt;xps_inband==2)) ? GF_ISOM_SUBTYPE_HEV1  : GF_ISOM_SUBTYPE_HVC1;</span>
<span class="lineNum">    1551 </span>            :                 use_hevc = GF_TRUE;
<span class="lineNum">    1552 </span><span class="lineCov">        280 :                 comp_name = (codec_id == GF_CODECID_LHVC) ? &quot;L-HEVC&quot; : &quot;HEVC&quot;;</span>
<span class="lineNum">    1553 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1554 </span><span class="lineCov">        280 :                 if (ctx-&gt;xps_inband) {</span>
<span class="lineNum">    1555 </span>            :                         use_m4sys = GF_FALSE;
<span class="lineNum">    1556 </span><span class="lineCov">         16 :                         if (ctx-&gt;xps_inband==1) skip_dsi = GF_TRUE;</span>
<span class="lineNum">    1557 </span>            :                 }
<span class="lineNum">    1558 </span><span class="lineCov">        280 :                 if (codec_id==GF_CODECID_HEVC_TILES) {</span>
<span class="lineNum">    1559 </span>            :                         m_subtype = GF_ISOM_SUBTYPE_HVT1;
<span class="lineNum">    1560 </span>            :                         skip_dsi = GF_TRUE;
<span class="lineNum">    1561 </span>            :                 }
<span class="lineNum">    1562 </span>            :                 break;
<span class="lineNum">    1563 </span><span class="lineCov">         78 :         case GF_CODECID_HEVC_TILES:</span>
<span class="lineNum">    1564 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_HVT1;
<span class="lineNum">    1565 </span>            :                 skip_dsi = GF_TRUE;
<span class="lineNum">    1566 </span>            :                 use_hvt1 = GF_TRUE;
<span class="lineNum">    1567 </span>            :                 use_m4sys = GF_FALSE;
<span class="lineNum">    1568 </span>            :                 comp_name = &quot;HEVC Tiles&quot;;
<span class="lineNum">    1569 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1570 </span><span class="lineCov">         78 :                 break;</span>
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :         case GF_CODECID_VVC:</span>
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 :                 m_subtype = ((ctx-&gt;xps_inband==1) || (ctx-&gt;xps_inband==2)) ? GF_ISOM_SUBTYPE_VVI1  : GF_ISOM_SUBTYPE_VVC1;</span>
<span class="lineNum">    1573 </span>            :                 use_vvc = GF_TRUE;
<span class="lineNum">    1574 </span>            :                 comp_name = &quot;HEVC&quot;;
<span class="lineNum">    1575 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1576 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;xps_inband==1) skip_dsi = GF_TRUE;</span>
<span class="lineNum">    1577 </span>            :                 break;
<span class="lineNum">    1578 </span><span class="lineCov">         45 :         case GF_CODECID_MPEG1:</span>
<span class="lineNum">    1579 </span>            :         case GF_CODECID_MPEG2_422:
<span class="lineNum">    1580 </span>            :         case GF_CODECID_MPEG2_SNR:
<span class="lineNum">    1581 </span>            :         case GF_CODECID_MPEG2_HIGH:
<span class="lineNum">    1582 </span>            :         case GF_CODECID_MPEG2_MAIN:
<span class="lineNum">    1583 </span>            :         case GF_CODECID_MPEG2_SIMPLE:
<span class="lineNum">    1584 </span>            :         case GF_CODECID_MPEG2_SPATIAL:
<span class="lineNum">    1585 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_MPEG4;
<span class="lineNum">    1586 </span>            :                 use_m4sys = GF_TRUE;
<span class="lineNum">    1587 </span>            :                 comp_name = &quot;MPEG-2 Video&quot;;
<span class="lineNum">    1588 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1589 </span><span class="lineCov">         45 :                 break;</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :         case 0:</span>
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] muxing codecID %d not yet implemented - patch welcome\n&quot;, codec_id));</span>
<span class="lineNum">    1592 </span>            :                 return GF_NOT_SUPPORTED;
<span class="lineNum">    1593 </span>            : 
<span class="lineNum">    1594 </span><span class="lineCov">         45 :         case GF_ISOM_SUBTYPE_TX3G:</span>
<span class="lineNum">    1595 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_TX3G;
<span class="lineNum">    1596 </span>            :                 use_tx3g = GF_TRUE;
<span class="lineNum">    1597 </span>            :                 comp_name = &quot;Timed Text&quot;;
<span class="lineNum">    1598 </span>            :                 is_text_subs = GF_TRUE;
<span class="lineNum">    1599 </span><span class="lineCov">         45 :                 break;</span>
<span class="lineNum">    1600 </span><span class="lineCov">         42 :         case GF_ISOM_SUBTYPE_WVTT:</span>
<span class="lineNum">    1601 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_WVTT;
<span class="lineNum">    1602 </span>            :                 use_webvtt = GF_TRUE;
<span class="lineNum">    1603 </span>            :                 comp_name = &quot;WebVTT&quot;;
<span class="lineNum">    1604 </span>            :                 is_text_subs = GF_TRUE;
<span class="lineNum">    1605 </span><span class="lineCov">         42 :                 break;</span>
<span class="lineNum">    1606 </span><span class="lineCov">          1 :         case GF_CODECID_SUBPIC:</span>
<span class="lineNum">    1607 </span>            :                 use_m4sys = GF_TRUE;
<span class="lineNum">    1608 </span>            :                 override_stype = GF_STREAM_ND_SUBPIC;
<span class="lineNum">    1609 </span>            :                 comp_name = &quot;VobSub&quot;;
<span class="lineNum">    1610 </span><span class="lineCov">          1 :                 break;</span>
<span class="lineNum">    1611 </span><span class="lineCov">          1 :         case GF_CODECID_TEXT_MPEG4:</span>
<span class="lineNum">    1612 </span>            :                 use_m4sys = GF_TRUE;
<span class="lineNum">    1613 </span><span class="lineCov">          1 :                 gf_isom_set_media_type(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_MEDIA_SCENE);</span>
<span class="lineNum">    1614 </span>            :                 comp_name = &quot;MPEG4 Streaming Text&quot;;
<span class="lineNum">    1615 </span><span class="lineCov">          1 :                 break;</span>
<span class="lineNum">    1616 </span><span class="lineCov">        226 :         case GF_CODECID_AV1:</span>
<span class="lineNum">    1617 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1618 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_AV01;
<span class="lineNum">    1619 </span>            :                 use_av1 = GF_TRUE;
<span class="lineNum">    1620 </span>            :                 comp_name = &quot;AOM AV1 Video&quot;;
<span class="lineNum">    1621 </span><span class="lineCov">        226 :                 break;</span>
<span class="lineNum">    1622 </span>            : 
<span class="lineNum">    1623 </span><span class="lineCov">          1 :         case GF_CODECID_VP8:</span>
<span class="lineNum">    1624 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1625 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_VP08;
<span class="lineNum">    1626 </span>            :                 use_vpX = GF_TRUE;
<span class="lineNum">    1627 </span>            :                 comp_name = &quot;VP8 Video&quot;;
<span class="lineNum">    1628 </span><span class="lineCov">          1 :                 break;</span>
<span class="lineNum">    1629 </span><span class="lineCov">        132 :         case GF_CODECID_VP9:</span>
<span class="lineNum">    1630 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1631 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_VP09;
<span class="lineNum">    1632 </span>            :                 use_vpX = GF_TRUE;
<span class="lineNum">    1633 </span>            :                 comp_name = &quot;VP9 Video&quot;;
<span class="lineNum">    1634 </span><span class="lineCov">        132 :                 break;</span>
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :         case GF_CODECID_VP10:</span>
<span class="lineNum">    1636 </span>            :                 use_gen_sample_entry = GF_FALSE;
<span class="lineNum">    1637 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_VP10;
<span class="lineNum">    1638 </span>            :                 use_vpX = GF_TRUE;
<span class="lineNum">    1639 </span>            :                 comp_name = &quot;VP10 Video&quot;;
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1641 </span>            : 
<span class="lineNum">    1642 </span><span class="lineCov">         10 :         case GF_CODECID_VORBIS:</span>
<span class="lineNum">    1643 </span>            :         case GF_CODECID_THEORA:
<span class="lineNum">    1644 </span>            :                 use_m4sys = GF_TRUE;
<span class="lineNum">    1645 </span><span class="lineCov">         10 :                 break;</span>
<span class="lineNum">    1646 </span>            : 
<span class="lineNum">    1647 </span><span class="lineCov">        693 :         case GF_CODECID_TRUEHD:</span>
<span class="lineNum">    1648 </span>            :                 m_subtype = GF_ISOM_SUBTYPE_MLPA;
<span class="lineNum">    1649 </span>            :                 comp_name = &quot;Dolby TrueHD&quot;;
<span class="lineNum">    1650 </span><span class="lineCov">        693 :                 break;</span>
<span class="lineNum">    1651 </span>            : 
<span class="lineNum">    1652 </span>            : 
<span class="lineNum">    1653 </span><span class="lineCov">         27 :         case GF_CODECID_BIFS:</span>
<span class="lineNum">    1654 </span>            : /* ==  GF_CODECID_OD_V1:*/
<span class="lineNum">    1655 </span>            :         case GF_CODECID_BIFS_V2:
<span class="lineNum">    1656 </span>            : /*      == GF_CODECID_OD_V2:*/
<span class="lineNum">    1657 </span>            :         case GF_CODECID_BIFS_EXTENDED:
<span class="lineNum">    1658 </span>            :         case GF_CODECID_LASER:
<span class="lineNum">    1659 </span>            :                 use_m4sys = GF_TRUE;
<span class="lineNum">    1660 </span><span class="lineCov">         27 :                 break;</span>
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 :         case GF_CODECID_V210:</span>
<span class="lineNum">    1662 </span>            :                 m_subtype = GF_QT_SUBTYPE_YUV422_10;
<span class="lineNum">    1663 </span>            :                 comp_name = &quot;v210 YUV 422 10 bit&quot;;
<span class="lineNum">    1664 </span>            :                 use_gen_sample_entry = GF_TRUE;
<span class="lineNum">    1665 </span>            :                 unknown_generic = GF_FALSE;
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1667 </span>            : 
<span class="lineNum">    1668 </span><span class="lineCov">          6 :         case GF_CODECID_RAW:</span>
<span class="lineNum">    1669 </span>            :                 m_subtype = codec_id;
<span class="lineNum">    1670 </span>            :                 unknown_generic = GF_TRUE;
<span class="lineNum">    1671 </span>            :                 use_gen_sample_entry = GF_TRUE;
<span class="lineNum">    1672 </span>            :                 use_m4sys = GF_FALSE;
<span class="lineNum">    1673 </span><span class="lineCov">          6 :                 tkw-&gt;skip_bitrate_update = GF_TRUE;</span>
<span class="lineNum">    1674 </span><span class="lineCov">          6 :                 if (tkw-&gt;stream_type == GF_STREAM_AUDIO) {</span>
<span class="lineNum">    1675 </span>            :                         u32 req_non_planar_type = 0;
<span class="lineNum">    1676 </span><span class="lineCov">          5 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_AUDIO_FORMAT);</span>
<span class="lineNum">    1677 </span><span class="lineCov">          5 :                         if (!p) break;</span>
<span class="lineNum">    1678 </span>            :                         comp_name = &quot;RawAudio&quot;;
<span class="lineNum">    1679 </span>            :                         unknown_generic = GF_FALSE;
<span class="lineNum">    1680 </span>            :                         //m_subtype used for QTFF-style raw media, m_subtype_alt_raw for ISOBMFF raw audio
<span class="lineNum">    1681 </span><span class="lineCov">          5 :                         switch (p-&gt;value.uint) {</span>
<span class="lineNum">    1682 </span><span class="lineNoCov">          0 :                         case GF_AUDIO_FMT_U8P:</span>
<span class="lineNum">    1683 </span>            :                                 req_non_planar_type = GF_AUDIO_FMT_U8;
<span class="lineNum">    1684 </span>            :                         case GF_AUDIO_FMT_U8:
<span class="lineNum">    1685 </span>            :                                 m_subtype = GF_QT_SUBTYPE_RAW;
<span class="lineNum">    1686 </span>            :                                 break;
<span class="lineNum">    1687 </span><span class="lineNoCov">          0 :                         case GF_AUDIO_FMT_S16P:</span>
<span class="lineNum">    1688 </span>            :                                 req_non_planar_type = GF_AUDIO_FMT_S16;
<span class="lineNum">    1689 </span>            :                         case GF_AUDIO_FMT_S16:
<span class="lineNum">    1690 </span>            :                                 m_subtype = GF_QT_SUBTYPE_SOWT;
<span class="lineNum">    1691 </span>            :                                 m_subtype_alt_raw = GF_ISOM_SUBTYPE_IPCM;
<span class="lineNum">    1692 </span>            :                                 break;
<span class="lineNum">    1693 </span><span class="lineNoCov">          0 :                         case GF_AUDIO_FMT_S24P:</span>
<span class="lineNum">    1694 </span>            :                                 req_non_planar_type = GF_AUDIO_FMT_S24;
<span class="lineNum">    1695 </span>            :                         case GF_AUDIO_FMT_S24:
<span class="lineNum">    1696 </span>            :                                 m_subtype = GF_QT_SUBTYPE_IN24;
<span class="lineNum">    1697 </span>            :                                 m_subtype_alt_raw = GF_ISOM_SUBTYPE_IPCM;
<span class="lineNum">    1698 </span>            :                                 break;
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :                         case GF_AUDIO_FMT_S32P:</span>
<span class="lineNum">    1700 </span>            :                                 req_non_planar_type = GF_AUDIO_FMT_S32P;
<span class="lineNum">    1701 </span>            :                         case GF_AUDIO_FMT_S32:
<span class="lineNum">    1702 </span>            :                                 m_subtype = GF_QT_SUBTYPE_IN32;
<span class="lineNum">    1703 </span>            :                                 m_subtype_alt_raw = GF_ISOM_SUBTYPE_IPCM;
<span class="lineNum">    1704 </span>            :                                 break;
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :                         case GF_AUDIO_FMT_FLTP:</span>
<span class="lineNum">    1706 </span>            :                                 req_non_planar_type = GF_AUDIO_FMT_FLTP;
<span class="lineNum">    1707 </span>            :                         case GF_AUDIO_FMT_FLT:
<span class="lineNum">    1708 </span>            :                                 m_subtype = GF_QT_SUBTYPE_FL32;
<span class="lineNum">    1709 </span>            :                                 m_subtype_alt_raw = GF_ISOM_SUBTYPE_FPCM;
<span class="lineNum">    1710 </span>            :                                 break;
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :                         case GF_AUDIO_FMT_DBLP:</span>
<span class="lineNum">    1712 </span>            :                                 req_non_planar_type = GF_AUDIO_FMT_DBL;
<span class="lineNum">    1713 </span>            :                         case GF_AUDIO_FMT_DBL:
<span class="lineNum">    1714 </span>            :                                 m_subtype = GF_QT_SUBTYPE_FL64;
<span class="lineNum">    1715 </span>            :                                 m_subtype_alt_raw = GF_ISOM_SUBTYPE_FPCM;
<span class="lineNum">    1716 </span>            :                                 break;
<span class="lineNum">    1717 </span>            :                         default:
<span class="lineNum">    1718 </span>            :                                 unknown_generic = GF_TRUE;
<span class="lineNum">    1719 </span>            :                                 m_subtype = p-&gt;value.uint;
<span class="lineNum">    1720 </span>            :                                 break;
<span class="lineNum">    1721 </span>            :                         }
<span class="lineNum">    1722 </span><span class="lineCov">          5 :                         if (req_non_planar_type) {</span>
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :                                 if (is_true_pid)</span>
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_negociate_property(pid, GF_PROP_PID_AUDIO_FORMAT, &amp;PROP_UINT(GF_AUDIO_FMT_S16));</span>
<span class="lineNum">    1725 </span>            :                                 else {
<span class="lineNum">    1726 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] raw audio format planar in DASH multi-stsd mode is not supported, try assigning a resampler before the dasher\n&quot;));</span>
<span class="lineNum">    1727 </span>            :                                         return GF_NOT_SUPPORTED;
<span class="lineNum">    1728 </span>            :                                 }
<span class="lineNum">    1729 </span>            :                         }
<span class="lineNum">    1730 </span><span class="lineCov">          5 :                         raw_bitdepth = gf_audio_fmt_bit_depth(p-&gt;value.uint);</span>
<span class="lineNum">    1731 </span>            :                         tkw-&gt;raw_audio_bytes_per_sample = raw_bitdepth;
<span class="lineNum">    1732 </span><span class="lineCov">          5 :                         tkw-&gt;raw_audio_bytes_per_sample *= nb_chan;</span>
<span class="lineNum">    1733 </span><span class="lineCov">          5 :                         tkw-&gt;raw_audio_bytes_per_sample /= 8;</span>
<span class="lineNum">    1734 </span><span class="lineCov">          5 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_SAMPLE_RATE);</span>
<span class="lineNum">    1735 </span><span class="lineCov">          5 :                         tkw-&gt;raw_samplerate = p ? p-&gt;value.uint : 0;</span>
<span class="lineNum">    1736 </span>            :                         //force timescale to be samplerate, except if explicit overwrite
<span class="lineNum">    1737 </span><span class="lineCov">          5 :                         if (ctx-&gt;mediats==0)</span>
<span class="lineNum">    1738 </span><span class="lineCov">          5 :                                 tkw-&gt;tk_timescale = tkw-&gt;raw_samplerate;</span>
<span class="lineNum">    1739 </span>            :                 }
<span class="lineNum">    1740 </span><span class="lineCov">          1 :                 else if (tkw-&gt;stream_type == GF_STREAM_VISUAL) {</span>
<span class="lineNum">    1741 </span><span class="lineCov">          1 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_PIXFMT);</span>
<span class="lineNum">    1742 </span><span class="lineCov">          1 :                         if (!p) break;</span>
<span class="lineNum">    1743 </span>            :                         comp_name = &quot;RawVideo&quot;;
<span class="lineNum">    1744 </span>            :                         unknown_generic = GF_FALSE;
<span class="lineNum">    1745 </span><span class="lineCov">          1 :                         tkw-&gt;skip_bitrate_update = GF_TRUE;</span>
<span class="lineNum">    1746 </span>            : 
<span class="lineNum">    1747 </span><span class="lineCov">          1 :                         m_subtype = gf_pixel_fmt_to_qt_type(p-&gt;value.uint);</span>
<span class="lineNum">    1748 </span><span class="lineCov">          1 :                         if (m_subtype) {</span>
<span class="lineNum">    1749 </span><span class="lineCov">          1 :                                 if (gf_pixel_fmt_is_yuv(p-&gt;value.uint))</span>
<span class="lineNum">    1750 </span>            :                                         force_colr = GF_TRUE;
<span class="lineNum">    1751 </span>            :                         } else {
<span class="lineNum">    1752 </span>            :                                 unknown_generic = GF_TRUE;
<span class="lineNum">    1753 </span><span class="lineNoCov">          0 :                                 m_subtype = p-&gt;value.uint;</span>
<span class="lineNum">    1754 </span>            :                         }
<span class="lineNum">    1755 </span>            :                 }
<span class="lineNum">    1756 </span>            :                 break;
<span class="lineNum">    1757 </span>            : 
<span class="lineNum">    1758 </span><span class="lineCov">         55 :         default:</span>
<span class="lineNum">    1759 </span>            :                 m_subtype = codec_id;
<span class="lineNum">    1760 </span>            :                 unknown_generic = GF_TRUE;
<span class="lineNum">    1761 </span>            :                 use_gen_sample_entry = GF_TRUE;
<span class="lineNum">    1762 </span>            :                 use_m4sys = GF_FALSE;
<span class="lineNum">    1763 </span><span class="lineCov">         55 :                 if (is_prores)</span>
<span class="lineNum">    1764 </span>            :                         unknown_generic = GF_FALSE;
<span class="lineNum">    1765 </span>            : 
<span class="lineNum">    1766 </span><span class="lineCov">         55 :                 p = gf_filter_pid_get_property_str(pid, &quot;meta:mime&quot;);</span>
<span class="lineNum">    1767 </span><span class="lineCov">         55 :                 if (p) meta_mime = p-&gt;value.string;</span>
<span class="lineNum">    1768 </span><span class="lineCov">         55 :                 p = gf_filter_pid_get_property_str(pid, &quot;meta:encoding&quot;);</span>
<span class="lineNum">    1769 </span><span class="lineCov">         55 :                 if (p) meta_encoding = p-&gt;value.string;</span>
<span class="lineNum">    1770 </span><span class="lineCov">         55 :                 p = gf_filter_pid_get_property_str(pid, &quot;meta:content_encoding&quot;);</span>
<span class="lineNum">    1771 </span><span class="lineCov">         55 :                 if (p) meta_content_encoding = p-&gt;value.string;</span>
<span class="lineNum">    1772 </span><span class="lineCov">         55 :                 p = gf_filter_pid_get_property_str(pid, &quot;meta:xmlns&quot;);</span>
<span class="lineNum">    1773 </span><span class="lineCov">         55 :                 if (p) meta_xmlns = p-&gt;value.string;</span>
<span class="lineNum">    1774 </span><span class="lineCov">         55 :                 p = gf_filter_pid_get_property_str(pid, &quot;meta:schemaloc&quot;);</span>
<span class="lineNum">    1775 </span><span class="lineCov">         55 :                 if (p) meta_schemaloc = p-&gt;value.string;</span>
<span class="lineNum">    1776 </span><span class="lineCov">         55 :                 p = gf_filter_pid_get_property_str(pid, &quot;meta:aux_mimes&quot;);</span>
<span class="lineNum">    1777 </span><span class="lineCov">         55 :                 if (p) meta_auxmimes = p-&gt;value.string;</span>
<span class="lineNum">    1778 </span>            :                 break;
<span class="lineNum">    1779 </span>            :         }
<span class="lineNum">    1780 </span><span class="lineCov">       2786 :         if (!comp_name) comp_name = gf_codecid_name(codec_id);</span>
<span class="lineNum">    1781 </span><span class="lineCov">       2786 :         if (!comp_name) comp_name = gf_4cc_to_str(m_subtype);</span>
<span class="lineNum">    1782 </span>            : 
<span class="lineNum">    1783 </span><span class="lineCov">       2786 :         if (dsi)</span>
<span class="lineNum">    1784 </span><span class="lineCov">       2499 :                 meta_config = dsi-&gt;value.data.ptr;</span>
<span class="lineNum">    1785 </span>            : 
<span class="lineNum">    1786 </span><span class="lineCov">       2786 :         if (is_text_subs &amp;&amp; !width &amp;&amp; !height) {</span>
<span class="lineNum">    1787 </span><span class="lineCov">         66 :                 mp4_mux_get_video_size(ctx, &amp;width, &amp;height);</span>
<span class="lineNum">    1788 </span>            :         }
<span class="lineNum">    1789 </span>            : 
<span class="lineNum">    1790 </span><span class="lineCov">       2786 :         if (!ctx-&gt;init_movie_done &amp;&amp; !tkw-&gt;nb_samples &amp;&amp; (ctx-&gt;mediats&lt;0) &amp;&amp; (tkw-&gt;tk_timescale==1000)) {</span>
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :                 if (sr) {</span>
<span class="lineNum">    1792 </span><span class="lineNoCov">          0 :                         tkw-&gt;tk_timescale = sr;</span>
<span class="lineNum">    1793 </span><span class="lineNoCov">          0 :                         gf_isom_set_media_timescale(ctx-&gt;file, tkw-&gt;track_num, sr, 0, 1);</span>
<span class="lineNum">    1794 </span>            :                 }
<span class="lineNum">    1795 </span><span class="lineNoCov">          0 :                 else if (width &amp;&amp; fps.den) {</span>
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :                         tkw-&gt;tk_timescale = fps.den;</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :                         gf_isom_set_media_timescale(ctx-&gt;file, tkw-&gt;track_num, fps.den, 0, 1);</span>
<span class="lineNum">    1798 </span>            :                 }
<span class="lineNum">    1799 </span>            :         }
<span class="lineNum">    1800 </span><span class="lineCov">       4332 :         if (!needs_sample_entry || tkw-&gt;is_item) {</span>
<span class="lineNum">    1801 </span>            :                 goto sample_entry_done;
<span class="lineNum">    1802 </span>            :         }
<span class="lineNum">    1803 </span>            : 
<span class="lineNum">    1804 </span>            :         //we are fragmented, init movie done, we cannot update the sample description
<span class="lineNum">    1805 </span><span class="lineCov">       1498 :         if (ctx-&gt;init_movie_done) {</span>
<span class="lineNum">    1806 </span><span class="lineCov">          8 :                 if (needs_sample_entry==1) {</span>
<span class="lineNum">    1807 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Cannot create a new sample description entry (codec change) for finalized movie in fragmented mode\n&quot;));</span>
<span class="lineNum">    1808 </span>            :                         return GF_NOT_SUPPORTED;
<span class="lineNum">    1809 </span>            :                 }
<span class="lineNum">    1810 </span>            :                 force_mix_xps = GF_TRUE;
<span class="lineNum">    1811 </span><span class="lineCov">       1490 :         } else if (ctx-&gt;store &lt; MP4MX_MODE_FRAG) {</span>
<span class="lineNum">    1812 </span><span class="lineCov">       1099 :                 if ((needs_sample_entry==2) &amp;&amp; (ctx-&gt;xps_inband==2)) {</span>
<span class="lineNum">    1813 </span>            :                         force_mix_xps = GF_TRUE;
<span class="lineNum">    1814 </span>            :                 }
<span class="lineNum">    1815 </span><span class="lineCov">       1092 :                 else if ((needs_sample_entry==2) &amp;&amp; ((ctx-&gt;xps_inband==1)||(ctx-&gt;xps_inband==3)) ) {</span>
<span class="lineNum">    1816 </span>            :                         needs_sample_entry = 0;
<span class="lineNum">    1817 </span>            :                         make_inband_headers = GF_TRUE;
<span class="lineNum">    1818 </span>            :                 }
<span class="lineNum">    1819 </span>            :         }
<span class="lineNum">    1820 </span>            :         
<span class="lineNum">    1821 </span><span class="lineCov">       1498 :         if (force_mix_xps) {</span>
<span class="lineNum">    1822 </span>            : 
<span class="lineNum">    1823 </span>            :                 //for AVC and HEVC, move to inband params if config changed
<span class="lineNum">    1824 </span><span class="lineCov">         15 :                 if (use_avc &amp;&amp; dsi) {</span>
<span class="lineNum">    1825 </span><span class="lineCov">          9 :                         if (tkw-&gt;avcc) gf_odf_avc_cfg_del(tkw-&gt;avcc);</span>
<span class="lineNum">    1826 </span>            : 
<span class="lineNum">    1827 </span><span class="lineCov">          9 :                         tkw-&gt;avcc = gf_odf_avc_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">    1828 </span>            : 
<span class="lineNum">    1829 </span><span class="lineCov">          9 :                         if (enh_dsi) {</span>
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 :                                 if (tkw-&gt;svcc) gf_odf_avc_cfg_del(tkw-&gt;svcc);</span>
<span class="lineNum">    1831 </span><span class="lineNoCov">          0 :                                 tkw-&gt;svcc = gf_odf_avc_cfg_read(enh_dsi-&gt;value.data.ptr, enh_dsi-&gt;value.data.size);</span>
<span class="lineNum">    1832 </span>            :                         }
<span class="lineNum">    1833 </span><span class="lineCov">          9 :                         if (!ctx-&gt;xps_inband) {</span>
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;init_movie_done) {</span>
<span class="lineNum">    1835 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] AVC config update after movie has been finalized, moving all SPS/PPS inband (file might not be compliant)\n&quot;));</span>
<span class="lineNum">    1836 </span>            :                                 }
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :                                 ctx-&gt;xps_inband = 2;</span>
<span class="lineNum">    1838 </span>            :                         }
<span class="lineNum">    1839 </span><span class="lineCov">          9 :                         mp4_mux_make_inband_header(ctx, tkw, GF_FALSE);</span>
<span class="lineNum">    1840 </span><span class="lineCov">          9 :                         if (ctx-&gt;pps_inband)</span>
<span class="lineNum">    1841 </span><span class="lineNoCov">          0 :                                 mp4_mux_make_inband_header(ctx, tkw, GF_TRUE);</span>
<span class="lineNum">    1842 </span>            :                         return GF_OK;
<span class="lineNum">    1843 </span>            :                 }
<span class="lineNum">    1844 </span><span class="lineCov">          6 :                 else if (use_hevc &amp;&amp; dsi) {</span>
<span class="lineNum">    1845 </span><span class="lineCov">          6 :                         if (tkw-&gt;hvcc) gf_odf_hevc_cfg_del(tkw-&gt;hvcc);</span>
<span class="lineNum">    1846 </span><span class="lineCov">          6 :                         tkw-&gt;hvcc = gf_odf_hevc_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size,  (codec_id == GF_CODECID_LHVC) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    1847 </span>            : 
<span class="lineNum">    1848 </span><span class="lineCov">          6 :                         if (enh_dsi) {</span>
<span class="lineNum">    1849 </span><span class="lineNoCov">          0 :                                 if (tkw-&gt;lvcc) gf_odf_hevc_cfg_del(tkw-&gt;lvcc);</span>
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 :                                 tkw-&gt;lvcc = gf_odf_hevc_cfg_read(enh_dsi-&gt;value.data.ptr, enh_dsi-&gt;value.data.size, GF_TRUE);</span>
<span class="lineNum">    1851 </span>            :                         }
<span class="lineNum">    1852 </span><span class="lineCov">          6 :                         if (!ctx-&gt;xps_inband) {</span>
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;init_movie_done) {</span>
<span class="lineNum">    1854 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] HEVC config update after movie has been finalized, moving all SPS/PPS inband (file might not be compliant)\n&quot;));</span>
<span class="lineNum">    1855 </span>            :                                 }
<span class="lineNum">    1856 </span><span class="lineNoCov">          0 :                                 ctx-&gt;xps_inband = 2;</span>
<span class="lineNum">    1857 </span>            :                         }
<span class="lineNum">    1858 </span><span class="lineCov">          6 :                         mp4_mux_make_inband_header(ctx, tkw, GF_FALSE);</span>
<span class="lineNum">    1859 </span><span class="lineCov">          6 :                         if (ctx-&gt;pps_inband)</span>
<span class="lineNum">    1860 </span><span class="lineNoCov">          0 :                                 mp4_mux_make_inband_header(ctx, tkw, GF_TRUE);</span>
<span class="lineNum">    1861 </span>            :                         return GF_OK;
<span class="lineNum">    1862 </span>            :                 }
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :                 else if (use_vvc &amp;&amp; dsi) {</span>
<span class="lineNum">    1864 </span><span class="lineNoCov">          0 :                         if (tkw-&gt;vvcc) gf_odf_vvc_cfg_del(tkw-&gt;vvcc);</span>
<span class="lineNum">    1865 </span><span class="lineNoCov">          0 :                         tkw-&gt;vvcc = gf_odf_vvc_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">    1866 </span>            : 
<span class="lineNum">    1867 </span><span class="lineNoCov">          0 :                         if (!ctx-&gt;xps_inband) {</span>
<span class="lineNum">    1868 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;init_movie_done) {</span>
<span class="lineNum">    1869 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] VVC config update after movie has been finalized, moving all SPS/PPS inband (file might not be compliant)\n&quot;));</span>
<span class="lineNum">    1870 </span>            :                                 }
<span class="lineNum">    1871 </span><span class="lineNoCov">          0 :                                 ctx-&gt;xps_inband = 2;</span>
<span class="lineNum">    1872 </span>            :                         }
<span class="lineNum">    1873 </span><span class="lineNoCov">          0 :                         mp4_mux_make_inband_header(ctx, tkw, GF_FALSE);</span>
<span class="lineNum">    1874 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;pps_inband)</span>
<span class="lineNum">    1875 </span><span class="lineNoCov">          0 :                                 mp4_mux_make_inband_header(ctx, tkw, GF_TRUE);</span>
<span class="lineNum">    1876 </span>            :                         return GF_OK;
<span class="lineNum">    1877 </span>            :                 }
<span class="lineNum">    1878 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Cannot create a new sample description entry (config changed) for finalized movie in fragmented mode\n&quot;));</span>
<span class="lineNum">    1879 </span>            :                 return GF_NOT_SUPPORTED;
<span class="lineNum">    1880 </span>            :         }
<span class="lineNum">    1881 </span>            : 
<span class="lineNum">    1882 </span>            : 
<span class="lineNum">    1883 </span>            :         //little optim here: if no samples were added on the stream description remove it
<span class="lineNum">    1884 </span><span class="lineCov">       1483 :         if (!tkw-&gt;samples_in_stsd &amp;&amp; tkw-&gt;stsd_idx) {</span>
<span class="lineNum">    1885 </span><span class="lineCov">         14 :                 gf_isom_remove_stream_description(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx);</span>
<span class="lineNum">    1886 </span>            :         }
<span class="lineNum">    1887 </span>            : 
<span class="lineNum">    1888 </span><span class="lineCov">       1483 :         if (!use_dref) src_url = NULL;</span>
<span class="lineNum">    1889 </span>            : 
<span class="lineNum">    1890 </span><span class="lineCov">       1483 :         if (use_m4sys &amp;&amp; !gf_codecid_oti(codec_id)) {</span>
<span class="lineNum">    1891 </span>            :                 use_m4sys = GF_FALSE;
<span class="lineNum">    1892 </span>            :         }
<span class="lineNum">    1893 </span>            :         //nope, create sample entry
<span class="lineNum">    1894 </span><span class="lineCov">       1482 :         if (use_m4sys) {</span>
<span class="lineNum">    1895 </span><span class="lineCov">        401 :                 GF_ESD *esd = gf_odf_desc_esd_new(2);</span>
<span class="lineNum">    1896 </span><span class="lineCov">        401 :                 esd-&gt;decoderConfig-&gt;streamType = override_stype ? override_stype : tkw-&gt;stream_type;</span>
<span class="lineNum">    1897 </span><span class="lineCov">        401 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = gf_codecid_oti(codec_id);</span>
<span class="lineNum">    1898 </span><span class="lineCov">        401 :                 if (!esd-&gt;decoderConfig-&gt;objectTypeIndication) {</span>
<span class="lineNum">    1899 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Codec %s does not have an official MPEG-4 systems mapping, cannot mux\n&quot;, gf_codecid_name(codec_id) ));</span>
<span class="lineNum">    1900 </span>            :                         return GF_NOT_SUPPORTED;
<span class="lineNum">    1901 </span>            : 
<span class="lineNum">    1902 </span>            :                 }
<span class="lineNum">    1903 </span><span class="lineCov">        401 :                 esd-&gt;slConfig-&gt;timestampResolution = tkw-&gt;tk_timescale;</span>
<span class="lineNum">    1904 </span><span class="lineCov">        401 :                 if (dsi &amp;&amp; !skip_dsi) {</span>
<span class="lineNum">    1905 </span><span class="lineCov">        355 :                         esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data = dsi-&gt;value.data.ptr;</span>
<span class="lineNum">    1906 </span><span class="lineCov">        355 :                         esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;dataLength = dsi-&gt;value.data.size;</span>
<span class="lineNum">    1907 </span>            :                 }
<span class="lineNum">    1908 </span>            : 
<span class="lineNum">    1909 </span><span class="lineCov">        401 :                 e = gf_isom_new_mpeg4_description(ctx-&gt;file, tkw-&gt;track_num, esd, (char *)src_url, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    1910 </span><span class="lineCov">        401 :                 if (dsi &amp;&amp; !skip_dsi) {</span>
<span class="lineNum">    1911 </span><span class="lineCov">        355 :                         esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data = NULL;</span>
<span class="lineNum">    1912 </span><span class="lineCov">        355 :                         esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;dataLength = 0;</span>
<span class="lineNum">    1913 </span>            :                 }
<span class="lineNum">    1914 </span><span class="lineCov">        401 :                 gf_odf_desc_del((GF_Descriptor *) esd);</span>
<span class="lineNum">    1915 </span>            : 
<span class="lineNum">    1916 </span><span class="lineCov">        401 :                 if (e) {</span>
<span class="lineNum">    1917 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new MPEG-4 Systems sample description for stream type %d OTI %d: %s\n&quot;, tkw-&gt;stream_type, codec_id, gf_error_to_string(e) ));</span>
<span class="lineNum">    1918 </span>            :                         return e;
<span class="lineNum">    1919 </span>            :                 }
<span class="lineNum">    1920 </span>            : 
<span class="lineNum">    1921 </span><span class="lineCov">        401 :                 tkw-&gt;use_dref = src_url ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1922 </span>            : 
<span class="lineNum">    1923 </span><span class="lineCov">        401 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_IN_IOD);</span>
<span class="lineNum">    1924 </span><span class="lineCov">        401 :                 if (p &amp;&amp; p-&gt;value.boolean)</span>
<span class="lineNum">    1925 </span><span class="lineCov">         27 :                         gf_isom_add_track_to_root_od(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    1926 </span>            : 
<span class="lineNum">    1927 </span>            : 
<span class="lineNum">    1928 </span>            : #ifndef GPAC_DISABLE_AV_PARSERS
<span class="lineNum">    1929 </span><span class="lineCov">        401 :                 if (dsi &amp;&amp; (tkw-&gt;stream_type==GF_STREAM_AUDIO)) {</span>
<span class="lineNum">    1930 </span>            :                         GF_M4ADecSpecInfo acfg;
<span class="lineNum">    1931 </span><span class="lineCov">        216 :                         gf_m4a_get_config(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size, &amp;acfg);</span>
<span class="lineNum">    1932 </span><span class="lineCov">        216 :                         audio_pli = acfg.audioPL;</span>
<span class="lineNum">    1933 </span>            :                 }
<span class="lineNum">    1934 </span>            :                 //patch to align old arch (IOD not written in dash) with new
<span class="lineNum">    1935 </span><span class="lineCov">        401 :                 if (audio_pli &amp;&amp; !ctx-&gt;dash_mode)</span>
<span class="lineNum">    1936 </span><span class="lineCov">        278 :                         gf_isom_set_pl_indication(ctx-&gt;file, GF_ISOM_PL_AUDIO, audio_pli);</span>
<span class="lineNum">    1937 </span>            : #endif
<span class="lineNum">    1938 </span>            : 
<span class="lineNum">    1939 </span><span class="lineCov">       1082 :         } else if (use_avc) {</span>
<span class="lineNum">    1940 </span><span class="lineCov">        397 :                 if (tkw-&gt;avcc) gf_odf_avc_cfg_del(tkw-&gt;avcc);</span>
<span class="lineNum">    1941 </span>            : 
<span class="lineNum">    1942 </span>            :                 //not yet known
<span class="lineNum">    1943 </span><span class="lineCov">        397 :                 if (!dsi &amp;&amp; !enh_dsi) return GF_OK;</span>
<span class="lineNum">    1944 </span>            : 
<span class="lineNum">    1945 </span><span class="lineCov">        397 :                 if (!dsi) {</span>
<span class="lineNum">    1946 </span>            :                         dsi = enh_dsi;
<span class="lineNum">    1947 </span>            :                         enh_dsi = NULL;
<span class="lineNum">    1948 </span>            :                 }
<span class="lineNum">    1949 </span><span class="lineCov">        397 :                 tkw-&gt;avcc = gf_odf_avc_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">    1950 </span>            : 
<span class="lineNum">    1951 </span><span class="lineCov">        397 :                 if (needs_sample_entry) {</span>
<span class="lineNum">    1952 </span>            : 
<span class="lineNum">    1953 </span><span class="lineCov">        393 :                         if (tkw-&gt;codecid == GF_CODECID_SVC) {</span>
<span class="lineNum">    1954 </span><span class="lineCov">          2 :                                 e = gf_isom_svc_config_new(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;avcc, NULL, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    1955 </span><span class="lineCov">        391 :                         } else if (tkw-&gt;codecid == GF_CODECID_MVC) {</span>
<span class="lineNum">    1956 </span><span class="lineNoCov">          0 :                                 e = gf_isom_mvc_config_new(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;avcc, NULL, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    1957 </span>            :                         } else {
<span class="lineNum">    1958 </span><span class="lineCov">        391 :                                 e = gf_isom_avc_config_new(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;avcc, NULL, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    1959 </span>            :                         }
<span class="lineNum">    1960 </span>            : 
<span class="lineNum">    1961 </span><span class="lineCov">        393 :                         if (!e &amp;&amp; enh_dsi) {</span>
<span class="lineNum">    1962 </span><span class="lineCov">          6 :                                 if (tkw-&gt;svcc) gf_odf_avc_cfg_del(tkw-&gt;svcc);</span>
<span class="lineNum">    1963 </span><span class="lineCov">          6 :                                 tkw-&gt;svcc = gf_odf_avc_cfg_read(enh_dsi-&gt;value.data.ptr, enh_dsi-&gt;value.data.size);</span>
<span class="lineNum">    1964 </span><span class="lineCov">          6 :                                 if (tkw-&gt;svcc) {</span>
<span class="lineNum">    1965 </span><span class="lineCov">          6 :                                         if ((tkw-&gt;svcc-&gt;AVCProfileIndication==118) || (tkw-&gt;svcc-&gt;AVCProfileIndication==128)) {</span>
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :                                                 e = gf_isom_mvc_config_update(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, tkw-&gt;svcc, GF_TRUE);</span>
<span class="lineNum">    1967 </span>            :                                         } else {
<span class="lineNum">    1968 </span><span class="lineCov">          6 :                                                 e = gf_isom_svc_config_update(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, tkw-&gt;svcc, GF_TRUE);</span>
<span class="lineNum">    1969 </span>            :                                         }
<span class="lineNum">    1970 </span><span class="lineCov">          6 :                                         if (e) {</span>
<span class="lineNum">    1971 </span><span class="lineNoCov">          0 :                                                 gf_odf_avc_cfg_del(tkw-&gt;svcc);</span>
<span class="lineNum">    1972 </span><span class="lineNoCov">          0 :                                                 tkw-&gt;svcc = NULL;</span>
<span class="lineNum">    1973 </span>            :                                         }
<span class="lineNum">    1974 </span>            : 
<span class="lineNum">    1975 </span><span class="lineCov">          6 :                                         if (ctx-&gt;xps_inband) {</span>
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :                                                 gf_isom_avc_set_inband_config(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, (ctx-&gt;xps_inband==2) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    1977 </span>            :                                         }
<span class="lineNum">    1978 </span>            :                                 }
<span class="lineNum">    1979 </span>            :                         }
<span class="lineNum">    1980 </span><span class="lineCov">        393 :                         if (e) {</span>
<span class="lineNum">    1981 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new AVC sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    1982 </span>            :                                 return e;
<span class="lineNum">    1983 </span>            :                         }
<span class="lineNum">    1984 </span>            :                 }
<span class="lineNum">    1985 </span>            :                 
<span class="lineNum">    1986 </span><span class="lineCov">        397 :                 if (ctx-&gt;xps_inband) {</span>
<span class="lineNum">    1987 </span>            :                         //this will cleanup all PS in avcC / svcC
<span class="lineNum">    1988 </span><span class="lineCov">         14 :                         gf_isom_avc_set_inband_config(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, (ctx-&gt;xps_inband==2) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    1989 </span><span class="lineCov">         14 :                         if (ctx-&gt;xps_inband==2) make_inband_headers = GF_TRUE;</span>
<span class="lineNum">    1990 </span>            :                 } else {
<span class="lineNum">    1991 </span><span class="lineCov">        383 :                         gf_odf_avc_cfg_del(tkw-&gt;avcc);</span>
<span class="lineNum">    1992 </span><span class="lineCov">        383 :                         tkw-&gt;avcc = NULL;</span>
<span class="lineNum">    1993 </span>            :                 }
<span class="lineNum">    1994 </span>            :                 //patch to align old arch with filters
<span class="lineNum">    1995 </span><span class="lineCov">        397 :                 if (!ctx-&gt;dash_mode &amp;&amp; !ctx-&gt;make_qt &amp;&amp; !gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_ISOM_TREX_TEMPLATE) )</span>
<span class="lineNum">    1996 </span><span class="lineCov">        246 :                         gf_isom_set_pl_indication(ctx-&gt;file, GF_ISOM_PL_VISUAL, 0x7F);</span>
<span class="lineNum">    1997 </span>            : 
<span class="lineNum">    1998 </span><span class="lineCov">        397 :                 if (!tkw-&gt;has_brands)</span>
<span class="lineNum">    1999 </span><span class="lineCov">        210 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_AVC1, GF_TRUE);</span>
<span class="lineNum">    2000 </span>            : 
<span class="lineNum">    2001 </span><span class="lineCov">        397 :                 tkw-&gt;is_nalu = NALU_AVC;</span>
<span class="lineNum">    2002 </span>            : 
<span class="lineNum">    2003 </span><span class="lineCov">        397 :                 tkw-&gt;use_dref = GF_FALSE;</span>
<span class="lineNum">    2004 </span>            : 
<span class="lineNum">    2005 </span><span class="lineCov">        685 :         } else if (use_hvt1) {</span>
<span class="lineNum">    2006 </span><span class="lineCov">         78 :                 if (tkw-&gt;hvcc) gf_odf_hevc_cfg_del(tkw-&gt;hvcc);</span>
<span class="lineNum">    2007 </span><span class="lineCov">         78 :                 tkw-&gt;hvcc = gf_odf_hevc_cfg_new();</span>
<span class="lineNum">    2008 </span><span class="lineCov">         78 :                 e = gf_isom_hevc_config_new(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;hvcc, NULL, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2009 </span><span class="lineCov">         78 :                 if (!e) {</span>
<span class="lineNum">    2010 </span><span class="lineCov">         78 :                         gf_isom_hevc_set_tile_config(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, NULL, GF_FALSE);</span>
<span class="lineNum">    2011 </span>            :                 }
<span class="lineNum">    2012 </span><span class="lineCov">         78 :                 gf_odf_hevc_cfg_del(tkw-&gt;hvcc);</span>
<span class="lineNum">    2013 </span><span class="lineCov">         78 :                 tkw-&gt;hvcc = NULL;</span>
<span class="lineNum">    2014 </span><span class="lineCov">         78 :                 tkw-&gt;is_nalu = NALU_HEVC;</span>
<span class="lineNum">    2015 </span><span class="lineCov">         78 :                 tkw-&gt;use_dref = GF_FALSE;</span>
<span class="lineNum">    2016 </span><span class="lineCov">         78 :                 if (!tkw-&gt;has_brands)</span>
<span class="lineNum">    2017 </span><span class="lineCov">         33 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_HVTI, GF_TRUE);</span>
<span class="lineNum">    2018 </span><span class="lineCov">        607 :         } else if (use_hevc) {</span>
<span class="lineNum">    2019 </span><span class="lineCov">        154 :                 if (tkw-&gt;hvcc) gf_odf_hevc_cfg_del(tkw-&gt;hvcc);</span>
<span class="lineNum">    2020 </span>            : 
<span class="lineNum">    2021 </span><span class="lineCov">        154 :                 if (!dsi &amp;&amp; !enh_dsi) {</span>
<span class="lineNum">    2022 </span>            :                         //not yet known
<span class="lineNum">    2023 </span>            :                         return GF_OK;
<span class="lineNum">    2024 </span>            :                 }
<span class="lineNum">    2025 </span><span class="lineCov">        154 :                 if (dsi) {</span>
<span class="lineNum">    2026 </span><span class="lineCov">        154 :                         tkw-&gt;hvcc = gf_odf_hevc_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size,  (codec_id == GF_CODECID_LHVC) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    2027 </span>            :                 } else {
<span class="lineNum">    2028 </span><span class="lineNoCov">          0 :                         tkw-&gt;hvcc = gf_odf_hevc_cfg_new();</span>
<span class="lineNum">    2029 </span>            :                 }
<span class="lineNum">    2030 </span><span class="lineCov">        154 :                 tkw-&gt;is_nalu = NALU_HEVC;</span>
<span class="lineNum">    2031 </span>            : 
<span class="lineNum">    2032 </span><span class="lineCov">        154 :                 if (needs_sample_entry) {</span>
<span class="lineNum">    2033 </span><span class="lineCov">        151 :                         e = gf_isom_hevc_config_new(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;hvcc, NULL, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2034 </span>            : 
<span class="lineNum">    2035 </span><span class="lineCov">        151 :                         if (!tkw-&gt;has_brands) {</span>
<span class="lineNum">    2036 </span><span class="lineCov">         95 :                                 gf_isom_set_brand_info(ctx-&gt;file, GF_ISOM_BRAND_ISO4, 1);</span>
<span class="lineNum">    2037 </span><span class="lineCov">         95 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISOM, GF_FALSE);</span>
<span class="lineNum">    2038 </span>            :                         }
<span class="lineNum">    2039 </span>            :                         //patch for old arch
<span class="lineNum">    2040 </span><span class="lineCov">         56 :                         else if (ctx-&gt;dash_mode) {</span>
<span class="lineNum">    2041 </span>            :                                 Bool force_brand=GF_FALSE;
<span class="lineNum">    2042 </span><span class="lineCov">         22 :                                 if (((ctx-&gt;major_brand_set&gt;&gt;24)=='i') &amp;&amp; (((ctx-&gt;major_brand_set&gt;&gt;16)&amp;0xFF)=='s') &amp;&amp; (((ctx-&gt;major_brand_set&gt;&gt;8)&amp;0xFF)=='o')) {</span>
<span class="lineNum">    2043 </span><span class="lineCov">         22 :                                         if ( (ctx-&gt;major_brand_set&amp;0xFF) &lt;'6') force_brand=GF_TRUE;</span>
<span class="lineNum">    2044 </span>            :                                 }
<span class="lineNum">    2045 </span>            : 
<span class="lineNum">    2046 </span><span class="lineCov">          1 :                                 if (!force_brand &amp;&amp; ctx-&gt;major_brand_set) {</span>
<span class="lineNum">    2047 </span><span class="lineCov">          1 :                                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO6, GF_TRUE);</span>
<span class="lineNum">    2048 </span>            :                                 } else {
<span class="lineNum">    2049 </span><span class="lineCov">         21 :                                         gf_isom_set_brand_info(ctx-&gt;file, GF_ISOM_BRAND_ISO6, 1);</span>
<span class="lineNum">    2050 </span><span class="lineCov">         21 :                                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISOM, GF_FALSE);</span>
<span class="lineNum">    2051 </span>            :                                 }
<span class="lineNum">    2052 </span>            :                         }
<span class="lineNum">    2053 </span>            : 
<span class="lineNum">    2054 </span><span class="lineCov">        151 :                         if (!e &amp;&amp; enh_dsi) {</span>
<span class="lineNum">    2055 </span><span class="lineCov">          8 :                                 if (tkw-&gt;lvcc) gf_odf_hevc_cfg_del(tkw-&gt;lvcc);</span>
<span class="lineNum">    2056 </span><span class="lineCov">          8 :                                 tkw-&gt;lvcc = gf_odf_hevc_cfg_read(enh_dsi-&gt;value.data.ptr, enh_dsi-&gt;value.data.size, GF_TRUE);</span>
<span class="lineNum">    2057 </span><span class="lineCov">          8 :                                 if (tkw-&gt;lvcc) {</span>
<span class="lineNum">    2058 </span><span class="lineCov">          8 :                                         e = gf_isom_lhvc_config_update(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, tkw-&gt;lvcc, dsi ? GF_ISOM_LEHVC_WITH_BASE_BACKWARD : GF_ISOM_LEHVC_ONLY);</span>
<span class="lineNum">    2059 </span><span class="lineCov">          8 :                                         if (e) {</span>
<span class="lineNum">    2060 </span><span class="lineNoCov">          0 :                                                 gf_odf_hevc_cfg_del(tkw-&gt;lvcc);</span>
<span class="lineNum">    2061 </span><span class="lineNoCov">          0 :                                                 tkw-&gt;lvcc = NULL;</span>
<span class="lineNum">    2062 </span>            :                                         }
<span class="lineNum">    2063 </span>            : 
<span class="lineNum">    2064 </span><span class="lineCov">          8 :                                         if (!dsi &amp;&amp; ctx-&gt;xps_inband) {</span>
<span class="lineNum">    2065 </span><span class="lineNoCov">          0 :                                                 gf_isom_hevc_set_inband_config(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, (ctx-&gt;xps_inband==2) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    2066 </span>            :                                         }
<span class="lineNum">    2067 </span>            :                                 }
<span class="lineNum">    2068 </span><span class="lineCov">        143 :                         } else if (codec_id == GF_CODECID_LHVC) {</span>
<span class="lineNum">    2069 </span><span class="lineNoCov">          0 :                                 gf_isom_lhvc_config_update(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, tkw-&gt;hvcc, GF_ISOM_LEHVC_ONLY);</span>
<span class="lineNum">    2070 </span><span class="lineCov">        143 :                         } else if (is_tile_base) {</span>
<span class="lineNum">    2071 </span><span class="lineCov">          5 :                                 gf_isom_lhvc_config_update(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, tkw-&gt;hvcc, GF_ISOM_HEVC_TILE_BASE);</span>
<span class="lineNum">    2072 </span>            :                         }
<span class="lineNum">    2073 </span><span class="lineCov">        151 :                         if (e) {</span>
<span class="lineNum">    2074 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new HEVC sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2075 </span>            :                                 return e;
<span class="lineNum">    2076 </span>            :                         }
<span class="lineNum">    2077 </span>            :                 }
<span class="lineNum">    2078 </span>            : 
<span class="lineNum">    2079 </span><span class="lineCov">        154 :                 if (dsi &amp;&amp; ctx-&gt;xps_inband) {</span>
<span class="lineNum">    2080 </span>            :                         //this will cleanup all PS in avcC / svcC
<span class="lineNum">    2081 </span><span class="lineCov">         10 :                         gf_isom_hevc_set_inband_config(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, (ctx-&gt;xps_inband==2) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    2082 </span>            :                 } else {
<span class="lineNum">    2083 </span><span class="lineCov">        144 :                         gf_odf_hevc_cfg_del(tkw-&gt;hvcc);</span>
<span class="lineNum">    2084 </span><span class="lineCov">        144 :                         tkw-&gt;hvcc = NULL;</span>
<span class="lineNum">    2085 </span>            :                 }
<span class="lineNum">    2086 </span>            : 
<span class="lineNum">    2087 </span><span class="lineCov">        154 :                 tkw-&gt;use_dref = GF_FALSE;</span>
<span class="lineNum">    2088 </span><span class="lineCov">        453 :         } else if (use_vvc) {</span>
<span class="lineNum">    2089 </span><span class="lineNoCov">          0 :                 if (tkw-&gt;vvcc) gf_odf_vvc_cfg_del(tkw-&gt;vvcc);</span>
<span class="lineNum">    2090 </span>            : 
<span class="lineNum">    2091 </span><span class="lineNoCov">          0 :                 if (!dsi) {</span>
<span class="lineNum">    2092 </span>            :                         //not yet known
<span class="lineNum">    2093 </span>            :                         return GF_OK;
<span class="lineNum">    2094 </span>            :                 }
<span class="lineNum">    2095 </span><span class="lineNoCov">          0 :                 tkw-&gt;vvcc = gf_odf_vvc_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">    2096 </span>            : 
<span class="lineNum">    2097 </span><span class="lineNoCov">          0 :                 tkw-&gt;is_nalu = NALU_VVC;</span>
<span class="lineNum">    2098 </span>            : 
<span class="lineNum">    2099 </span><span class="lineNoCov">          0 :                 if (needs_sample_entry) {</span>
<span class="lineNum">    2100 </span><span class="lineNoCov">          0 :                         e = gf_isom_vvc_config_new(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;vvcc, NULL, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2101 </span>            : 
<span class="lineNum">    2102 </span><span class="lineNoCov">          0 :                         if (!tkw-&gt;has_brands) {</span>
<span class="lineNum">    2103 </span><span class="lineNoCov">          0 :                                 gf_isom_set_brand_info(ctx-&gt;file, GF_ISOM_BRAND_ISO4, 1);</span>
<span class="lineNum">    2104 </span><span class="lineNoCov">          0 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISOM, GF_FALSE);</span>
<span class="lineNum">    2105 </span>            :                         }
<span class="lineNum">    2106 </span>            :                         //patch for old arch
<span class="lineNum">    2107 </span><span class="lineNoCov">          0 :                         else if (ctx-&gt;dash_mode) {</span>
<span class="lineNum">    2108 </span>            :                                 Bool force_brand=GF_FALSE;
<span class="lineNum">    2109 </span><span class="lineNoCov">          0 :                                 if (((ctx-&gt;major_brand_set&gt;&gt;24)=='i') &amp;&amp; (((ctx-&gt;major_brand_set&gt;&gt;16)&amp;0xFF)=='s') &amp;&amp; (((ctx-&gt;major_brand_set&gt;&gt;8)&amp;0xFF)=='o')) {</span>
<span class="lineNum">    2110 </span><span class="lineNoCov">          0 :                                         if ( (ctx-&gt;major_brand_set&amp;0xFF) &lt;'6') force_brand=GF_TRUE;</span>
<span class="lineNum">    2111 </span>            :                                 }
<span class="lineNum">    2112 </span>            : 
<span class="lineNum">    2113 </span><span class="lineNoCov">          0 :                                 if (!force_brand &amp;&amp; ctx-&gt;major_brand_set) {</span>
<span class="lineNum">    2114 </span><span class="lineNoCov">          0 :                                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO6, GF_TRUE);</span>
<span class="lineNum">    2115 </span>            :                                 } else {
<span class="lineNum">    2116 </span><span class="lineNoCov">          0 :                                         gf_isom_set_brand_info(ctx-&gt;file, GF_ISOM_BRAND_ISO6, 1);</span>
<span class="lineNum">    2117 </span><span class="lineNoCov">          0 :                                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISOM, GF_FALSE);</span>
<span class="lineNum">    2118 </span>            :                                 }
<span class="lineNum">    2119 </span>            :                         }
<span class="lineNum">    2120 </span>            : 
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :                         if (e) {</span>
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new HEVC sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2123 </span>            :                                 return e;
<span class="lineNum">    2124 </span>            :                         }
<span class="lineNum">    2125 </span>            :                 }
<span class="lineNum">    2126 </span>            : 
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;xps_inband) {</span>
<span class="lineNum">    2128 </span>            :                         //this will cleanup all PS in vvcC
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :                         gf_isom_vvc_set_inband_config(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, (ctx-&gt;xps_inband==2) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    2130 </span>            :                 } else {
<span class="lineNum">    2131 </span><span class="lineNoCov">          0 :                         gf_odf_vvc_cfg_del(tkw-&gt;vvcc);</span>
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :                         tkw-&gt;vvcc = NULL;</span>
<span class="lineNum">    2133 </span>            :                 }
<span class="lineNum">    2134 </span>            : 
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :                 tkw-&gt;use_dref = GF_FALSE;</span>
<span class="lineNum">    2136 </span><span class="lineCov">        453 :         } else if (use_av1) {</span>
<span class="lineNum">    2137 </span>            :                 GF_AV1Config *av1c;
<span class="lineNum">    2138 </span>            : 
<span class="lineNum">    2139 </span><span class="lineCov">        154 :                 if (!dsi) {</span>
<span class="lineNum">    2140 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] No decoder specific info found for AV1\n&quot;));</span>
<span class="lineNum">    2141 </span>            :                         return GF_NON_COMPLIANT_BITSTREAM;
<span class="lineNum">    2142 </span>            :                 }
<span class="lineNum">    2143 </span><span class="lineCov">        154 :                 av1c = gf_odf_av1_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">    2144 </span><span class="lineCov">        154 :                 if (!av1c) {</span>
<span class="lineNum">    2145 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to parser AV1 decoder specific info\n&quot;));</span>
<span class="lineNum">    2146 </span>            :                         return GF_NON_COMPLIANT_BITSTREAM;
<span class="lineNum">    2147 </span>            :                 }
<span class="lineNum">    2148 </span>            : 
<span class="lineNum">    2149 </span><span class="lineCov">        154 :                 e = gf_isom_av1_config_new(ctx-&gt;file, tkw-&gt;track_num, av1c, (char *) src_url, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2150 </span><span class="lineCov">        154 :                 if (e) {</span>
<span class="lineNum">    2151 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new AV1 sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2152 </span>            :                         return e;
<span class="lineNum">    2153 </span>            :                 }
<span class="lineNum">    2154 </span><span class="lineCov">        154 :                 tkw-&gt;is_av1 = GF_TRUE;</span>
<span class="lineNum">    2155 </span>            : 
<span class="lineNum">    2156 </span><span class="lineCov">        154 :                 if (!tkw-&gt;has_brands) {</span>
<span class="lineNum">    2157 </span><span class="lineCov">         64 :                         gf_isom_set_brand_info(ctx-&gt;file, GF_ISOM_BRAND_ISO4, 1);</span>
<span class="lineNum">    2158 </span><span class="lineCov">         64 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISOM, GF_FALSE);</span>
<span class="lineNum">    2159 </span><span class="lineCov">         64 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_AV01, GF_TRUE);</span>
<span class="lineNum">    2160 </span>            :                 }
<span class="lineNum">    2161 </span>            : 
<span class="lineNum">    2162 </span><span class="lineCov">        154 :                 gf_odf_av1_cfg_del(av1c);</span>
<span class="lineNum">    2163 </span><span class="lineCov">        299 :         } else if (use_vpX) {</span>
<span class="lineNum">    2164 </span>            :                 GF_VPConfig *vpc;
<span class="lineNum">    2165 </span>            : 
<span class="lineNum">    2166 </span><span class="lineCov">         28 :                 if (!dsi) {</span>
<span class="lineNum">    2167 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] No decoder specific info found for %s\n&quot;, gf_4cc_to_str(codec_id) ));</span>
<span class="lineNum">    2168 </span>            :                         return GF_NON_COMPLIANT_BITSTREAM;
<span class="lineNum">    2169 </span>            :                 }
<span class="lineNum">    2170 </span><span class="lineCov">         28 :                 vpc = gf_odf_vp_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">    2171 </span><span class="lineCov">         28 :                 if (!vpc) {</span>
<span class="lineNum">    2172 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to parser %s decoder specific info\n&quot;, gf_4cc_to_str(codec_id)));</span>
<span class="lineNum">    2173 </span>            :                         return GF_NON_COMPLIANT_BITSTREAM;
<span class="lineNum">    2174 </span>            :                 }
<span class="lineNum">    2175 </span>            : 
<span class="lineNum">    2176 </span><span class="lineCov">         28 :                 e = gf_isom_vp_config_new(ctx-&gt;file, tkw-&gt;track_num, vpc, (char *) src_url, NULL, &amp;tkw-&gt;stsd_idx, m_subtype);</span>
<span class="lineNum">    2177 </span><span class="lineCov">         28 :                 if (e) {</span>
<span class="lineNum">    2178 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new %s sample description: %s\n&quot;, gf_4cc_to_str(codec_id), gf_error_to_string(e) ));</span>
<span class="lineNum">    2179 </span>            :                         return e;
<span class="lineNum">    2180 </span>            :                 }
<span class="lineNum">    2181 </span><span class="lineCov">         28 :                 tkw-&gt;is_vpx = GF_TRUE;</span>
<span class="lineNum">    2182 </span><span class="lineCov">         28 :                 gf_odf_vp_cfg_del(vpc);</span>
<span class="lineNum">    2183 </span><span class="lineCov">        271 :         } else if (use_3gpp_config) {</span>
<span class="lineNum">    2184 </span>            :                 GF_3GPConfig gpp_cfg;
<span class="lineNum">    2185 </span>            :                 memset(&amp;gpp_cfg, 0, sizeof(GF_3GPConfig));
<span class="lineNum">    2186 </span><span class="lineCov">         21 :                 gpp_cfg.type = m_subtype;</span>
<span class="lineNum">    2187 </span><span class="lineCov">         21 :                 gpp_cfg.vendor = GF_VENDOR_GPAC;</span>
<span class="lineNum">    2188 </span>            : 
<span class="lineNum">    2189 </span><span class="lineCov">         21 :                 if (use_dref) {</span>
<span class="lineNum">    2190 </span><span class="lineNoCov">          0 :                         gpp_cfg.frames_per_sample  = 1;</span>
<span class="lineNum">    2191 </span>            :                 } else {
<span class="lineNum">    2192 </span><span class="lineCov">         21 :                         gpp_cfg.frames_per_sample = ctx-&gt;pack3gp;</span>
<span class="lineNum">    2193 </span><span class="lineCov">         21 :                         if (!gpp_cfg.frames_per_sample) gpp_cfg.frames_per_sample  = 1;</span>
<span class="lineNum">    2194 </span><span class="lineCov">         21 :                         else if (gpp_cfg.frames_per_sample &gt;15) gpp_cfg.frames_per_sample = 15;</span>
<span class="lineNum">    2195 </span>            :                 }
<span class="lineNum">    2196 </span><span class="lineCov">         21 :                 gpp_cfg.AMR_mode_set = tkw-&gt;amr_mode_set;</span>
<span class="lineNum">    2197 </span><span class="lineCov">         21 :                 if (tkw-&gt;stream_type==GF_STREAM_VISUAL) {</span>
<span class="lineNum">    2198 </span>            :                         /*FIXME - we need more in-depth parsing of the bitstream to detect P3@L10 (streaming wireless)*/
<span class="lineNum">    2199 </span><span class="lineCov">          5 :                         gpp_cfg.H263_profile = 0;</span>
<span class="lineNum">    2200 </span><span class="lineCov">          5 :                         gpp_cfg.H263_level = 10;</span>
<span class="lineNum">    2201 </span><span class="lineCov">          5 :                         gpp_cfg.frames_per_sample = 0;</span>
<span class="lineNum">    2202 </span>            :                 }
<span class="lineNum">    2203 </span><span class="lineCov">         21 :                 tkw-&gt;nb_frames_per_sample = gpp_cfg.frames_per_sample;</span>
<span class="lineNum">    2204 </span>            : 
<span class="lineNum">    2205 </span><span class="lineCov">         21 :                 e = gf_isom_3gp_config_new(ctx-&gt;file, tkw-&gt;track_num, &amp;gpp_cfg, (char *) src_url, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2206 </span><span class="lineCov">         21 :                 if (e) {</span>
<span class="lineNum">    2207 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new 3GPP audio sample description for stream type %d codecid %d: %s\n&quot;, tkw-&gt;stream_type, codec_id, gf_error_to_string(e) ));</span>
<span class="lineNum">    2208 </span><span class="lineNoCov">          0 :                         return e;</span>
<span class="lineNum">    2209 </span>            :                 }
<span class="lineNum">    2210 </span><span class="lineCov">         21 :                 tkw-&gt;use_dref = src_url ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2211 </span>            : 
<span class="lineNum">    2212 </span><span class="lineCov">         21 :                 if (!tkw-&gt;has_brands) {</span>
<span class="lineNum">    2213 </span><span class="lineCov">         21 :                         switch (gpp_cfg.type) {</span>
<span class="lineNum">    2214 </span><span class="lineCov">          4 :                         case GF_ISOM_SUBTYPE_3GP_QCELP:</span>
<span class="lineNum">    2215 </span>            :                         case GF_ISOM_SUBTYPE_3GP_EVRC:
<span class="lineNum">    2216 </span>            :                         case GF_ISOM_SUBTYPE_3GP_SMV:
<span class="lineNum">    2217 </span><span class="lineCov">          4 :                                 gf_isom_set_brand_info(ctx-&gt;file, GF_ISOM_BRAND_3G2A, 65536);</span>
<span class="lineNum">    2218 </span><span class="lineCov">          4 :                                 break;</span>
<span class="lineNum">    2219 </span><span class="lineCov">          5 :                         case GF_ISOM_SUBTYPE_3GP_H263:</span>
<span class="lineNum">    2220 </span><span class="lineCov">          5 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_3GG6, GF_TRUE);</span>
<span class="lineNum">    2221 </span><span class="lineCov">          5 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_3GG5, GF_TRUE);</span>
<span class="lineNum">    2222 </span><span class="lineCov">          5 :                                 break;</span>
<span class="lineNum">    2223 </span>            :                         }
<span class="lineNum">    2224 </span>            :                 }
<span class="lineNum">    2225 </span><span class="lineCov">         21 :                 tkw-&gt;skip_bitrate_update = GF_TRUE;</span>
<span class="lineNum">    2226 </span><span class="lineCov">        250 :         } else if (use_ac3_entry) {</span>
<span class="lineNum">    2227 </span>            :                 GF_AC3Config ac3cfg;
<span class="lineNum">    2228 </span>            :                 memset(&amp;ac3cfg, 0, sizeof(GF_AC3Config));
<span class="lineNum">    2229 </span>            : 
<span class="lineNum">    2230 </span><span class="lineCov">         11 :                 if (dsi) {</span>
<span class="lineNum">    2231 </span><span class="lineCov">          8 :                         gf_odf_ac3_config_parse(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size, (codec_id==GF_CODECID_EAC3) ? GF_TRUE : GF_FALSE, &amp;ac3cfg);</span>
<span class="lineNum">    2232 </span>            :                 }
<span class="lineNum">    2233 </span><span class="lineCov">         11 :                 e = gf_isom_ac3_config_new(ctx-&gt;file, tkw-&gt;track_num, &amp;ac3cfg, (char *)src_url, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2234 </span><span class="lineCov">         11 :                 if (e) {</span>
<span class="lineNum">    2235 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new AC3 audio sample description for stream type %d codecid %d: %s\n&quot;, tkw-&gt;stream_type, codec_id, gf_error_to_string(e) ));</span>
<span class="lineNum">    2236 </span><span class="lineNoCov">          0 :                         return e;</span>
<span class="lineNum">    2237 </span>            :                 }
<span class="lineNum">    2238 </span><span class="lineCov">         11 :                 tkw-&gt;use_dref = src_url ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2239 </span><span class="lineCov">        239 :         } else if (use_flac_entry) {</span>
<span class="lineNum">    2240 </span><span class="lineCov">          2 :                 e = gf_isom_flac_config_new(ctx-&gt;file, tkw-&gt;track_num, dsi ? dsi-&gt;value.data.ptr : NULL, dsi ? dsi-&gt;value.data.size : 0, (char *)src_url, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2241 </span><span class="lineCov">          2 :                 if (e) {</span>
<span class="lineNum">    2242 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new FLAC audio sample description for stream type %d codecid %d: %s\n&quot;, tkw-&gt;stream_type, codec_id, gf_error_to_string(e) ));</span>
<span class="lineNum">    2243 </span>            :                         return e;
<span class="lineNum">    2244 </span>            :                 }
<span class="lineNum">    2245 </span><span class="lineCov">          2 :                 tkw-&gt;use_dref = src_url ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2246 </span><span class="lineCov">        237 :         } else if (use_opus) {</span>
<span class="lineNum">    2247 </span><span class="lineCov">          2 :                 GF_OpusSpecificBox *opus_cfg = NULL;</span>
<span class="lineNum">    2248 </span>            :                 GF_BitStream *bs;
<span class="lineNum">    2249 </span>            : 
<span class="lineNum">    2250 </span><span class="lineCov">          2 :                 if (!dsi) {</span>
<span class="lineNum">    2251 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] No decoder specific info found for opus\n&quot; ));</span>
<span class="lineNum">    2252 </span><span class="lineNoCov">          0 :                         return GF_NON_COMPLIANT_BITSTREAM;</span>
<span class="lineNum">    2253 </span>            :                 }
<span class="lineNum">    2254 </span>            : 
<span class="lineNum">    2255 </span><span class="lineCov">          2 :                 bs = gf_bs_new(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size, GF_BITSTREAM_READ);</span>
<span class="lineNum">    2256 </span><span class="lineCov">          2 :                 e = gf_isom_box_parse((GF_Box**)&amp;opus_cfg, bs);</span>
<span class="lineNum">    2257 </span><span class="lineCov">          2 :                 gf_bs_del(bs);</span>
<span class="lineNum">    2258 </span><span class="lineCov">          2 :                 if (e) {</span>
<span class="lineNum">    2259 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error parsing opus configuration data: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2260 </span>            :                         return e;
<span class="lineNum">    2261 </span>            :                 }
<span class="lineNum">    2262 </span>            : 
<span class="lineNum">    2263 </span><span class="lineCov">          2 :                 e = gf_isom_opus_config_new(ctx-&gt;file, tkw-&gt;track_num, opus_cfg, (char *)src_url, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2264 </span><span class="lineCov">          2 :                 if (opus_cfg) gf_isom_box_del((GF_Box*)opus_cfg);</span>
<span class="lineNum">    2265 </span><span class="lineCov">          2 :                 if (e) {</span>
<span class="lineNum">    2266 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new AC3 audio sample description for stream type %d codecid %d: %s\n&quot;, tkw-&gt;stream_type, codec_id, gf_error_to_string(e) ));</span>
<span class="lineNum">    2267 </span>            :                         return e;
<span class="lineNum">    2268 </span>            :                 }
<span class="lineNum">    2269 </span><span class="lineCov">          2 :                 tkw-&gt;use_dref = src_url ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2270 </span><span class="lineCov">        235 :         } else if (m_subtype == GF_ISOM_SUBTYPE_METX) {</span>
<span class="lineNum">    2271 </span>            :                 comp_name = &quot;XML Metadata&quot;;
<span class="lineNum">    2272 </span><span class="lineCov">          3 :                 e = gf_isom_new_xml_metadata_description(ctx-&gt;file, tkw-&gt;track_num, meta_xmlns, meta_schemaloc, meta_encoding, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2273 </span><span class="lineCov">          3 :                 if (e) {</span>
<span class="lineNum">    2274 </span><span class="lineCov">          1 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new METX sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2275 </span>            :                         return e;
<span class="lineNum">    2276 </span>            :                 }
<span class="lineNum">    2277 </span><span class="lineCov">        232 :         } else if (m_subtype == GF_ISOM_SUBTYPE_METT) {</span>
<span class="lineNum">    2278 </span>            :                 comp_name = &quot;Text Metadata&quot;;
<span class="lineNum">    2279 </span><span class="lineCov">          8 :                 e = gf_isom_new_stxt_description(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_SUBTYPE_METT, meta_mime, meta_encoding, meta_config, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2280 </span><span class="lineCov">          8 :                 if (e) {</span>
<span class="lineNum">    2281 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new METT sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2282 </span>            :                         return e;
<span class="lineNum">    2283 </span>            :                 }
<span class="lineNum">    2284 </span><span class="lineCov">        224 :         } else if (m_subtype == GF_ISOM_SUBTYPE_STPP) {</span>
<span class="lineNum">    2285 </span><span class="lineCov">         21 :                 if (meta_xmlns &amp;&amp; !strcmp(meta_xmlns, &quot;http://www.w3.org/ns/ttml&quot;)) {</span>
<span class="lineNum">    2286 </span>            :                         comp_name = &quot;TTML&quot;;
<span class="lineNum">    2287 </span>            :                 } else {
<span class="lineNum">    2288 </span>            :                         comp_name = &quot;XML Subtitle&quot;;
<span class="lineNum">    2289 </span>            :                 }
<span class="lineNum">    2290 </span><span class="lineCov">         21 :                 e = gf_isom_new_xml_subtitle_description(ctx-&gt;file, tkw-&gt;track_num, meta_xmlns, meta_schemaloc, meta_auxmimes, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2291 </span><span class="lineCov">         21 :                 if (e) {</span>
<span class="lineNum">    2292 </span><span class="lineCov">          1 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new XML subtitle sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2293 </span>            :                         return e;
<span class="lineNum">    2294 </span>            :                 }
<span class="lineNum">    2295 </span>            : 
<span class="lineNum">    2296 </span>            :                 //CMAF 11.3.2
<span class="lineNum">    2297 </span><span class="lineCov">         20 :                 if (ctx-&gt;cmaf) {</span>
<span class="lineNum">    2298 </span><span class="lineNoCov">          0 :                         if (!meta_mime) meta_mime = gf_isom_subtitle_get_mime(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :                         if (!meta_mime || (!strstr(meta_mime, &quot;im1t&quot;) &amp;&amp; !strstr(meta_mime, &quot;im1i&quot;))) {</span>
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :                                 gf_isom_subtitle_set_mime(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, &quot;application/ttml+xml;codecs=im1t&quot;);</span>
<span class="lineNum">    2301 </span>            :                         }
<span class="lineNum">    2302 </span>            :                 }
<span class="lineNum">    2303 </span>            : 
<span class="lineNum">    2304 </span>            : 
<span class="lineNum">    2305 </span><span class="lineCov">        203 :         } else if ((m_subtype == GF_ISOM_SUBTYPE_SBTT) || (m_subtype == GF_ISOM_SUBTYPE_STXT) ) {</span>
<span class="lineNum">    2306 </span><span class="lineCov">         17 :                 comp_name = (m_subtype == GF_ISOM_SUBTYPE_STXT) ? &quot;Simple Timed Text&quot; : &quot;Textual Subtitle&quot;;</span>
<span class="lineNum">    2307 </span><span class="lineCov">         17 :                 e = gf_isom_new_stxt_description(ctx-&gt;file, tkw-&gt;track_num, m_subtype, meta_mime, meta_content_encoding, meta_config, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2308 </span><span class="lineCov">         17 :                 if (e) {</span>
<span class="lineNum">    2309 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new %s sample description: %s\n&quot;, gf_4cc_to_str(m_subtype), gf_error_to_string(e) ));</span>
<span class="lineNum">    2310 </span>            :                         return e;
<span class="lineNum">    2311 </span>            :                 }
<span class="lineNum">    2312 </span><span class="lineCov">         17 :                 if (m_subtype == GF_ISOM_SUBTYPE_STXT) force_tk_layout = GF_TRUE;</span>
<span class="lineNum">    2313 </span><span class="lineCov">        186 :         } else if (use_tx3g) {</span>
<span class="lineNum">    2314 </span>            :                 GF_TextSampleDescriptor *txtc;
<span class="lineNum">    2315 </span><span class="lineCov">         45 :                 if (!dsi) {</span>
<span class="lineNum">    2316 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] No decoder specific info found for TX3G\n&quot;));</span>
<span class="lineNum">    2317 </span>            :                         return GF_NON_COMPLIANT_BITSTREAM;
<span class="lineNum">    2318 </span>            :                 }
<span class="lineNum">    2319 </span><span class="lineCov">         45 :                 txtc = gf_odf_tx3g_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">    2320 </span><span class="lineCov">         45 :                 if (!txtc) {</span>
<span class="lineNum">    2321 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to parse TX3G config\n&quot;));</span>
<span class="lineNum">    2322 </span>            :                         return GF_NON_COMPLIANT_BITSTREAM;
<span class="lineNum">    2323 </span>            :                 }
<span class="lineNum">    2324 </span>            : 
<span class="lineNum">    2325 </span><span class="lineCov">         45 :                 if (!txtc-&gt;default_pos.right) txtc-&gt;default_pos.right = width + txtc-&gt;default_pos.left;</span>
<span class="lineNum">    2326 </span><span class="lineCov">         45 :                 if (!txtc-&gt;default_pos.bottom) txtc-&gt;default_pos.bottom = height + txtc-&gt;default_pos.top;</span>
<span class="lineNum">    2327 </span>            : 
<span class="lineNum">    2328 </span>            : 
<span class="lineNum">    2329 </span><span class="lineCov">         45 :                 e = gf_isom_new_text_description(ctx-&gt;file, tkw-&gt;track_num, txtc, NULL, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2330 </span><span class="lineCov">         45 :                 if (e) {</span>
<span class="lineNum">    2331 </span><span class="lineNoCov">          0 :                         gf_odf_desc_del((GF_Descriptor *)txtc);</span>
<span class="lineNum">    2332 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new %s sample description: %s\n&quot;, gf_4cc_to_str(m_subtype), gf_error_to_string(e) ));</span>
<span class="lineNum">    2333 </span>            :                         return e;
<span class="lineNum">    2334 </span>            :                 }
<span class="lineNum">    2335 </span><span class="lineCov">         45 :                 if (ctx-&gt;importer) {</span>
<span class="lineNum">    2336 </span><span class="lineCov">         29 :                         txt_fsize = txtc-&gt;default_style.font_size;</span>
<span class="lineNum">    2337 </span><span class="lineCov">         29 :                         if (txtc-&gt;font_count &amp;&amp; txtc-&gt;fonts[0].fontName) txt_font = gf_strdup(txtc-&gt;fonts[0].fontName);</span>
<span class="lineNum">    2338 </span>            :                 }
<span class="lineNum">    2339 </span><span class="lineCov">         45 :                 gf_odf_desc_del((GF_Descriptor *)txtc);</span>
<span class="lineNum">    2340 </span>            : 
<span class="lineNum">    2341 </span><span class="lineCov">         45 :                 tkw-&gt;skip_bitrate_update = GF_TRUE;</span>
<span class="lineNum">    2342 </span><span class="lineCov">        141 :         } else if (use_webvtt) {</span>
<span class="lineNum">    2343 </span><span class="lineCov">         42 :                 e = gf_isom_new_webvtt_description(ctx-&gt;file, tkw-&gt;track_num, NULL, NULL, &amp;tkw-&gt;stsd_idx, dsi ? dsi-&gt;value.data.ptr : NULL);</span>
<span class="lineNum">    2344 </span><span class="lineCov">         42 :                 if (e) {</span>
<span class="lineNum">    2345 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new %s sample description: %s\n&quot;, gf_4cc_to_str(m_subtype), gf_error_to_string(e) ));</span>
<span class="lineNum">    2346 </span>            :                         return e;
<span class="lineNum">    2347 </span>            :                 }
<span class="lineNum">    2348 </span><span class="lineCov">         42 :                 tkw-&gt;skip_bitrate_update = GF_TRUE;</span>
<span class="lineNum">    2349 </span><span class="lineCov">         99 :         } else if (use_mj2) {</span>
<span class="lineNum">    2350 </span><span class="lineCov">          7 :                 e = gf_isom_new_mj2k_description(ctx-&gt;file, tkw-&gt;track_num, NULL, NULL, &amp;tkw-&gt;stsd_idx, dsi ? dsi-&gt;value.data.ptr : NULL, dsi ? dsi-&gt;value.data.size : 0);</span>
<span class="lineNum">    2351 </span><span class="lineCov">          7 :                 if (e) {</span>
<span class="lineNum">    2352 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new %s sample description: %s\n&quot;, gf_4cc_to_str(m_subtype), gf_error_to_string(e) ));</span>
<span class="lineNum">    2353 </span>            :                         return e;
<span class="lineNum">    2354 </span>            :                 }
<span class="lineNum">    2355 </span><span class="lineCov">         92 :         } else if (codec_id==GF_CODECID_TMCD) {</span>
<span class="lineNum">    2356 </span>            :                 u32 tmcd_flags=0, tmcd_fps_num=0, tmcd_fps_den=0;
<span class="lineNum">    2357 </span>            :                 s32 tmcd_fpt=0;
<span class="lineNum">    2358 </span>            : 
<span class="lineNum">    2359 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property_str(pid, &quot;tmcd:flags&quot;);</span>
<span class="lineNum">    2360 </span><span class="lineNoCov">          0 :                 if (p) tmcd_flags = p-&gt;value.uint;</span>
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property_str(pid, &quot;tmcd:framerate&quot;);</span>
<span class="lineNum">    2362 </span><span class="lineNoCov">          0 :                 if (p) {</span>
<span class="lineNum">    2363 </span><span class="lineNoCov">          0 :                         tmcd_fps_num = p-&gt;value.frac.num;</span>
<span class="lineNum">    2364 </span><span class="lineNoCov">          0 :                         tmcd_fps_den = p-&gt;value.frac.den;</span>
<span class="lineNum">    2365 </span>            :                 }
<span class="lineNum">    2366 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property_str(pid, &quot;tmcd:frames_per_tick&quot;);</span>
<span class="lineNum">    2367 </span><span class="lineNoCov">          0 :                 if (p) tmcd_fpt = p-&gt;value.uint;</span>
<span class="lineNum">    2368 </span><span class="lineNoCov">          0 :                 if (tkw-&gt;tk_timescale != tmcd_fps_num) {</span>
<span class="lineNum">    2369 </span><span class="lineNoCov">          0 :                         tmcd_fps_den *= tmcd_fps_num;</span>
<span class="lineNum">    2370 </span><span class="lineNoCov">          0 :                         tmcd_fps_den /= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    2371 </span>            :                 }
<span class="lineNum">    2372 </span>            : 
<span class="lineNum">    2373 </span><span class="lineNoCov">          0 :                 e = gf_isom_tmcd_config_new(ctx-&gt;file, tkw-&gt;track_num, tmcd_fps_num, tmcd_fps_den, tmcd_fpt, (tmcd_flags &amp; 0x1), (tmcd_flags &amp; 0x8), &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2374 </span><span class="lineNoCov">          0 :                 if (e) {</span>
<span class="lineNum">    2375 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new tmcd sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2376 </span>            :                         return e;
<span class="lineNum">    2377 </span>            :                 }
<span class="lineNum">    2378 </span><span class="lineCov">         92 :         } else if (codec_id==GF_CODECID_DIMS) {</span>
<span class="lineNum">    2379 </span>            :                 GF_DIMSDescription dims_c;
<span class="lineNum">    2380 </span>            :                 memset(&amp;dims_c, 0, sizeof(GF_DIMSDescription));
<span class="lineNum">    2381 </span><span class="lineCov">          2 :                 dims_c.contentEncoding = meta_content_encoding;</span>
<span class="lineNum">    2382 </span><span class="lineCov">          2 :                 dims_c.mime_type = meta_mime;</span>
<span class="lineNum">    2383 </span><span class="lineCov">          2 :                 dims_c.textEncoding = meta_encoding;</span>
<span class="lineNum">    2384 </span><span class="lineCov">          2 :                 dims_c.xml_schema_loc = meta_xmlns;</span>
<span class="lineNum">    2385 </span>            : 
<span class="lineNum">    2386 </span><span class="lineCov">          2 :                 p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;dims:profile&quot;);</span>
<span class="lineNum">    2387 </span><span class="lineCov">          2 :                 if (p) dims_c.profile = p-&gt;value.uint;</span>
<span class="lineNum">    2388 </span><span class="lineCov">          2 :                 p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;dims:level&quot;);</span>
<span class="lineNum">    2389 </span><span class="lineCov">          2 :                 if (p) dims_c.level = p-&gt;value.uint;</span>
<span class="lineNum">    2390 </span><span class="lineCov">          2 :                 p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;dims:pathComponents&quot;);</span>
<span class="lineNum">    2391 </span><span class="lineCov">          2 :                 if (p) dims_c.pathComponents = p-&gt;value.uint;</span>
<span class="lineNum">    2392 </span><span class="lineCov">          2 :                 p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;dims:fullRequestHost&quot;);</span>
<span class="lineNum">    2393 </span><span class="lineCov">          2 :                 if (p) dims_c.fullRequestHost = p-&gt;value.uint;</span>
<span class="lineNum">    2394 </span><span class="lineCov">          2 :                 p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;dims:streamType&quot;);</span>
<span class="lineNum">    2395 </span><span class="lineCov">          2 :                 if (p) dims_c.streamType = p-&gt;value.boolean;</span>
<span class="lineNum">    2396 </span><span class="lineCov">          2 :                 p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;dims:redundant&quot;);</span>
<span class="lineNum">    2397 </span><span class="lineCov">          2 :                 if (p) dims_c.containsRedundant = p-&gt;value.uint;</span>
<span class="lineNum">    2398 </span><span class="lineCov">          2 :                 p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;dims:scriptTypes&quot;);</span>
<span class="lineNum">    2399 </span><span class="lineCov">          2 :                 if (p) dims_c.content_script_types = p-&gt;value.string;</span>
<span class="lineNum">    2400 </span>            : 
<span class="lineNum">    2401 </span><span class="lineCov">          2 :                 e = gf_isom_new_dims_description(ctx-&gt;file, tkw-&gt;track_num, &amp;dims_c, NULL, NULL, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2402 </span><span class="lineCov">          2 :                 if (e) {</span>
<span class="lineNum">    2403 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new DIMS sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2404 </span><span class="lineNoCov">          0 :                         return e;</span>
<span class="lineNum">    2405 </span>            :                 }
<span class="lineNum">    2406 </span><span class="lineCov">         90 :         } else if (codec_id==GF_CODECID_MPHA) {</span>
<span class="lineNum">    2407 </span>            :                 //not ready yet
<span class="lineNum">    2408 </span><span class="lineCov">          1 :                 if (!dsi) return GF_OK;</span>
<span class="lineNum">    2409 </span>            : 
<span class="lineNum">    2410 </span><span class="lineCov">          1 :                 e = gf_isom_new_mpha_description(ctx-&gt;file, tkw-&gt;track_num, NULL, NULL, &amp;tkw-&gt;stsd_idx, dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">    2411 </span><span class="lineCov">          1 :                 if (e) {</span>
<span class="lineNum">    2412 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new MPEG-H Audio sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2413 </span>            :                         return e;
<span class="lineNum">    2414 </span>            :                 }
<span class="lineNum">    2415 </span><span class="lineCov">         89 :         } else if (codec_id==GF_CODECID_TRUEHD) {</span>
<span class="lineNum">    2416 </span>            :                 u32 fmt=0, prate=0;
<span class="lineNum">    2417 </span>            :                 //not ready yet
<span class="lineNum">    2418 </span><span class="lineCov">          1 :                 if (!dsi) return GF_OK;</span>
<span class="lineNum">    2419 </span><span class="lineCov">          1 :                 if (dsi-&gt;value.data.size &lt; 6) return GF_NON_COMPLIANT_BITSTREAM;</span>
<span class="lineNum">    2420 </span>            : 
<span class="lineNum">    2421 </span><span class="lineCov">          1 :                 fmt = dsi-&gt;value.data.ptr[0];</span>
<span class="lineNum">    2422 </span><span class="lineCov">          1 :                 fmt &lt;&lt;= 8;</span>
<span class="lineNum">    2423 </span><span class="lineCov">          1 :                 fmt |= dsi-&gt;value.data.ptr[1];</span>
<span class="lineNum">    2424 </span><span class="lineCov">          1 :                 prate = dsi-&gt;value.data.ptr[2];</span>
<span class="lineNum">    2425 </span><span class="lineCov">          1 :                 prate &lt;&lt;= 8;</span>
<span class="lineNum">    2426 </span><span class="lineCov">          1 :                 prate |= dsi-&gt;value.data.ptr[3];</span>
<span class="lineNum">    2427 </span><span class="lineCov">          1 :                 prate &gt;&gt;= 1;</span>
<span class="lineNum">    2428 </span>            : 
<span class="lineNum">    2429 </span><span class="lineCov">          1 :                 e = gf_isom_truehd_config_new(ctx-&gt;file, tkw-&gt;track_num, (char *)src_url, NULL, fmt, prate, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2430 </span><span class="lineCov">          1 :                 if (e) {</span>
<span class="lineNum">    2431 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new TrueHD Audio sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2432 </span>            :                         return e;
<span class="lineNum">    2433 </span>            :                 }
<span class="lineNum">    2434 </span><span class="lineCov">         88 :         } else if (use_gen_sample_entry) {</span>
<span class="lineNum">    2435 </span>            :                 u8 isor_ext_buf[14];
<span class="lineNum">    2436 </span>            :                 u32 len = 0;
<span class="lineNum">    2437 </span>            :                 GF_GenericSampleDescription udesc;
<span class="lineNum">    2438 </span>            :                 memset(&amp;udesc, 0, sizeof(GF_GenericSampleDescription));
<span class="lineNum">    2439 </span>            : 
<span class="lineNum">    2440 </span><span class="lineCov">         88 :                 if (!comp_name) comp_name = &quot;Unknown&quot;;</span>
<span class="lineNum">    2441 </span><span class="lineCov">         88 :                 len = (u32) strlen(comp_name);</span>
<span class="lineNum">    2442 </span><span class="lineCov">         88 :                 if (len&gt;32) len = 32;</span>
<span class="lineNum">    2443 </span><span class="lineCov">         88 :                 udesc.compressor_name[0] = len;</span>
<span class="lineNum">    2444 </span><span class="lineCov">         88 :                 memcpy(udesc.compressor_name+1, comp_name, len);</span>
<span class="lineNum">    2445 </span><span class="lineCov">         88 :                 if ((codec_id==GF_CODECID_RAW) || unknown_generic)</span>
<span class="lineNum">    2446 </span><span class="lineCov">          6 :                         udesc.vendor_code = GF_4CC('G','P','A','C');</span>
<span class="lineNum">    2447 </span>            : 
<span class="lineNum">    2448 </span><span class="lineCov">         88 :                 udesc.samplerate = sr;</span>
<span class="lineNum">    2449 </span><span class="lineCov">         88 :                 udesc.nb_channels = nb_chan;</span>
<span class="lineNum">    2450 </span><span class="lineCov">         88 :                 if (codec_id==GF_CODECID_RAW) {</span>
<span class="lineNum">    2451 </span><span class="lineCov">          6 :                         if (ase_mode==GF_IMPORT_AUDIO_SAMPLE_ENTRY_v1_MPEG) {</span>
<span class="lineNum">    2452 </span>            :                                 m_subtype = m_subtype_alt_raw;
<span class="lineNum">    2453 </span><span class="lineCov">          5 :                                 udesc.extension_buf_size = 14;</span>
<span class="lineNum">    2454 </span><span class="lineCov">          5 :                                 udesc.extension_buf = isor_ext_buf;</span>
<span class="lineNum">    2455 </span>            :                                 memset(isor_ext_buf, 0, sizeof(u8)*14);
<span class="lineNum">    2456 </span><span class="lineCov">          5 :                                 isor_ext_buf[3] = 14;</span>
<span class="lineNum">    2457 </span><span class="lineCov">          5 :                                 isor_ext_buf[4] = 'p';</span>
<span class="lineNum">    2458 </span><span class="lineCov">          5 :                                 isor_ext_buf[5] = 'c';</span>
<span class="lineNum">    2459 </span><span class="lineCov">          5 :                                 isor_ext_buf[6] = 'm';</span>
<span class="lineNum">    2460 </span><span class="lineCov">          5 :                                 isor_ext_buf[7] = 'C';</span>
<span class="lineNum">    2461 </span><span class="lineCov">          5 :                                 isor_ext_buf[12] = 1; //little endian only for now</span>
<span class="lineNum">    2462 </span><span class="lineCov">          5 :                                 isor_ext_buf[13] = raw_bitdepth; //little endian only for now</span>
<span class="lineNum">    2463 </span>            :                         } else {
<span class="lineNum">    2464 </span><span class="lineCov">          1 :                                 udesc.is_qtff = GF_TRUE;</span>
<span class="lineNum">    2465 </span><span class="lineCov">          1 :                                 udesc.version = 1;</span>
<span class="lineNum">    2466 </span>            :                                 ase_mode = GF_IMPORT_AUDIO_SAMPLE_ENTRY_v1_QTFF;
<span class="lineNum">    2467 </span>            :                         }
<span class="lineNum">    2468 </span>            :                 }
<span class="lineNum">    2469 </span><span class="lineCov">         88 :                 udesc.codec_tag = m_subtype;</span>
<span class="lineNum">    2470 </span><span class="lineCov">         88 :                 udesc.width = width;</span>
<span class="lineNum">    2471 </span><span class="lineCov">         88 :                 udesc.height = height;</span>
<span class="lineNum">    2472 </span><span class="lineCov">         88 :                 if (width) {</span>
<span class="lineNum">    2473 </span><span class="lineCov">         20 :                         udesc.v_res = 72;</span>
<span class="lineNum">    2474 </span><span class="lineCov">         20 :                         udesc.h_res = 72;</span>
<span class="lineNum">    2475 </span><span class="lineCov">         20 :                         udesc.depth = 24;</span>
<span class="lineNum">    2476 </span>            :                 }
<span class="lineNum">    2477 </span><span class="lineCov">         88 :                 if (unknown_generic) {</span>
<span class="lineNum">    2478 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] muxing unknown codec ID %s, using generic sample entry with 4CC \&quot;%s\&quot;\n&quot;, gf_codecid_name(codec_id), gf_4cc_to_str(m_subtype) ));</span>
<span class="lineNum">    2479 </span>            :                 }
<span class="lineNum">    2480 </span>            :                 
<span class="lineNum">    2481 </span><span class="lineCov">         88 :                 e = gf_isom_new_generic_sample_description(ctx-&gt;file, tkw-&gt;track_num, (char *)src_url, NULL, &amp;udesc, &amp;tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2482 </span><span class="lineCov">         88 :                 if (e) {</span>
<span class="lineNum">    2483 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error creating new sample description for stream type %d codecid %d: %s\n&quot;, tkw-&gt;stream_type, codec_id, gf_error_to_string(e) ));</span>
<span class="lineNum">    2484 </span><span class="lineNoCov">          0 :                         return e;</span>
<span class="lineNum">    2485 </span>            :                 }
<span class="lineNum">    2486 </span><span class="lineCov">         88 :                 tkw-&gt;use_dref = src_url ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2487 </span>            :         } else {
<span class="lineNum">    2488 </span>            :                 assert(0);
<span class="lineNum">    2489 </span>            :         }
<span class="lineNum">    2490 </span>            : 
<span class="lineNum">    2491 </span><span class="lineCov">       1481 :         if (ctx-&gt;btrt &amp;&amp; !tkw-&gt;skip_bitrate_update) {</span>
<span class="lineNum">    2492 </span>            :                 u32 avg_rate, max_rate, dbsize;
<span class="lineNum">    2493 </span><span class="lineCov">       1364 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_BITRATE);</span>
<span class="lineNum">    2494 </span><span class="lineCov">       1364 :                 avg_rate = p ? p-&gt;value.uint : 0;</span>
<span class="lineNum">    2495 </span><span class="lineCov">       1364 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_MAXRATE);</span>
<span class="lineNum">    2496 </span><span class="lineCov">       1364 :                 max_rate = p ? p-&gt;value.uint : 0;</span>
<span class="lineNum">    2497 </span><span class="lineCov">       1364 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_DBSIZE);</span>
<span class="lineNum">    2498 </span><span class="lineCov">       1364 :                 dbsize = p ? p-&gt;value.uint : 0;</span>
<span class="lineNum">    2499 </span>            : 
<span class="lineNum">    2500 </span><span class="lineCov">       1364 :                 if (avg_rate &amp;&amp; max_rate) {</span>
<span class="lineNum">    2501 </span><span class="lineCov">        580 :                         gf_isom_update_bitrate(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, avg_rate, max_rate, dbsize);</span>
<span class="lineNum">    2502 </span>            :                 }
<span class="lineNum">    2503 </span>            :         } else {
<span class="lineNum">    2504 </span><span class="lineCov">        117 :                 gf_isom_update_bitrate(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, 0, 0, 0);</span>
<span class="lineNum">    2505 </span>            :         }
<span class="lineNum">    2506 </span>            : 
<span class="lineNum">    2507 </span><span class="lineCov">       1481 : multipid_stsd_setup:</span>
<span class="lineNum">    2508 </span><span class="lineCov">       1481 :         if (multi_pid_stsd) {</span>
<span class="lineNum">    2509 </span><span class="lineNoCov">          0 :                 if (multi_pid_idx&lt;gf_list_count(multi_pid_stsd)) {</span>
<span class="lineNum">    2510 </span>            : 
<span class="lineNum">    2511 </span><span class="lineNoCov">          0 :                         if (multi_pid_final_stsd_idx == multi_pid_idx) {</span>
<span class="lineNum">    2512 </span><span class="lineNoCov">          0 :                                 frames_per_sample_backup = tkw-&gt;nb_frames_per_sample;</span>
<span class="lineNum">    2513 </span><span class="lineNoCov">          0 :                                 is_nalu_backup = tkw-&gt;is_nalu;</span>
<span class="lineNum">    2514 </span>            :                         }
<span class="lineNum">    2515 </span><span class="lineNoCov">          0 :                         pid = gf_list_get(multi_pid_stsd, multi_pid_idx);</span>
<span class="lineNum">    2516 </span><span class="lineNoCov">          0 :                         multi_pid_idx ++;</span>
<span class="lineNum">    2517 </span>            :                         //reload codecID, decoder config and enhancement decoder config
<span class="lineNum">    2518 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_CODECID);</span>
<span class="lineNum">    2519 </span><span class="lineNoCov">          0 :                         if (p) codec_id = p-&gt;value.uint;</span>
<span class="lineNum">    2520 </span><span class="lineNoCov">          0 :                         dsi = gf_filter_pid_get_property(pid, GF_PROP_PID_DECODER_CONFIG);</span>
<span class="lineNum">    2521 </span><span class="lineNoCov">          0 :                         enh_dsi = gf_filter_pid_get_property(pid, GF_PROP_PID_DECODER_CONFIG_ENHANCEMENT);</span>
<span class="lineNum">    2522 </span>            :                         //force stsd idx to be 0 to avoid removing the stsd
<span class="lineNum">    2523 </span><span class="lineNoCov">          0 :                         tkw-&gt;stsd_idx = 0;</span>
<span class="lineNum">    2524 </span><span class="lineNoCov">          0 :                         goto sample_entry_setup;</span>
<span class="lineNum">    2525 </span>            :                 }
<span class="lineNum">    2526 </span><span class="lineNoCov">          0 :                 tkw-&gt;stsd_idx = multi_pid_final_stsd_idx;</span>
<span class="lineNum">    2527 </span>            :                 //restore input pid
<span class="lineNum">    2528 </span>            :                 pid = orig_pid;
<span class="lineNum">    2529 </span><span class="lineNoCov">          0 :                 codec_id = tkw-&gt;codecid;</span>
<span class="lineNum">    2530 </span>            : 
<span class="lineNum">    2531 </span><span class="lineNoCov">          0 :                 tkw-&gt;is_nalu = is_nalu_backup;</span>
<span class="lineNum">    2532 </span><span class="lineNoCov">          0 :                 tkw-&gt;nb_frames_per_sample = frames_per_sample_backup;</span>
<span class="lineNum">    2533 </span>            :         }
<span class="lineNum">    2534 </span>            : 
<span class="lineNum">    2535 </span>            : 
<span class="lineNum">    2536 </span>            :         //final opt: we couldn't detect before if the same stsd was possible, now that we have create a new one, check again
<span class="lineNum">    2537 </span><span class="lineCov">       1481 :         if (needs_sample_entry) {</span>
<span class="lineNum">    2538 </span>            :                 reuse_stsd = 0;
<span class="lineNum">    2539 </span>            :                 //don't try to reuse STSDs in multi STSD setup for DASH
<span class="lineNum">    2540 </span><span class="lineCov">       1474 :                 if (multi_pid_stsd) count = 0;</span>
<span class="lineNum">    2541 </span><span class="lineCov">       1474 :                 else count = gf_isom_get_sample_description_count(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    2542 </span><span class="lineCov">       4423 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2543 </span><span class="lineCov">       1480 :                         if (i+1 == tkw-&gt;stsd_idx) continue;</span>
<span class="lineNum">    2544 </span>            : 
<span class="lineNum">    2545 </span><span class="lineCov">         11 :                         if (gf_isom_is_same_sample_description(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, ctx-&gt;file, tkw-&gt;track_num, i+1) ) {</span>
<span class="lineNum">    2546 </span><span class="lineCov">          5 :                                 gf_isom_remove_stream_description(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2547 </span><span class="lineCov">          5 :                                 tkw-&gt;stsd_idx = i+1;</span>
<span class="lineNum">    2548 </span>            :                                 reuse_stsd = 1;
<span class="lineNum">    2549 </span>            :                                 break;
<span class="lineNum">    2550 </span>            :                         }
<span class="lineNum">    2551 </span>            :                 }
<span class="lineNum">    2552 </span>            :                 if (!reuse_stsd) {
<span class="lineNum">    2553 </span><span class="lineCov">       1469 :                         tkw-&gt;samples_in_stsd = 0;</span>
<span class="lineNum">    2554 </span><span class="lineCov">          5 :                 } else if (use_3gpp_config) {</span>
<span class="lineNum">    2555 </span><span class="lineNoCov">          0 :                         GF_3GPConfig *gpp_cfg = gf_isom_3gp_config_get(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2556 </span><span class="lineNoCov">          0 :                         if (gpp_cfg) {</span>
<span class="lineNum">    2557 </span><span class="lineNoCov">          0 :                                 gpp_cfg-&gt;AMR_mode_set = tkw-&gt;amr_mode_set;</span>
<span class="lineNum">    2558 </span><span class="lineNoCov">          0 :                                 gf_isom_3gp_config_update(ctx-&gt;file, tkw-&gt;track_num, gpp_cfg, tkw-&gt;stsd_idx);</span>
<span class="lineNum">    2559 </span><span class="lineNoCov">          0 :                                 gf_free(gpp_cfg);</span>
<span class="lineNum">    2560 </span>            :                         }
<span class="lineNum">    2561 </span>            :                 }
<span class="lineNum">    2562 </span>            :         }
<span class="lineNum">    2563 </span>            : 
<span class="lineNum">    2564 </span><span class="lineCov">       1481 :         if (tkw-&gt;is_encrypted) {</span>
<span class="lineNum">    2565 </span>            :                 const char *scheme_uri=NULL;
<span class="lineNum">    2566 </span>            :                 const char *kms_uri=NULL;
<span class="lineNum">    2567 </span>            :                 u32 scheme_version=0;
<span class="lineNum">    2568 </span>            :                 u32 scheme_type = 0;
<span class="lineNum">    2569 </span>            :                 Bool is_sel_enc = GF_FALSE;
<span class="lineNum">    2570 </span>            :                 u32 KI_length=0;
<span class="lineNum">    2571 </span>            :                 u32 IV_length=0;
<span class="lineNum">    2572 </span>            :                 /*todo !*/
<span class="lineNum">    2573 </span>            :                 const char *oma_contentID=0;
<span class="lineNum">    2574 </span>            :                 u32 oma_encryption_type=0;
<span class="lineNum">    2575 </span>            :                 u64 oma_plainTextLength=0;
<span class="lineNum">    2576 </span>            :                 const char *oma_textual_headers=NULL;
<span class="lineNum">    2577 </span>            :                 u32 textual_headers_len=0;
<span class="lineNum">    2578 </span>            : 
<span class="lineNum">    2579 </span><span class="lineCov">        229 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_PROTECTION_SCHEME_TYPE);</span>
<span class="lineNum">    2580 </span><span class="lineCov">        229 :                 if (p) scheme_type = p-&gt;value.uint;</span>
<span class="lineNum">    2581 </span><span class="lineCov">        229 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_PROTECTION_SCHEME_VERSION);</span>
<span class="lineNum">    2582 </span><span class="lineCov">        229 :                 if (p) scheme_version = p-&gt;value.uint;</span>
<span class="lineNum">    2583 </span><span class="lineCov">        229 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_PROTECTION_SCHEME_URI);</span>
<span class="lineNum">    2584 </span><span class="lineCov">        229 :                 if (p) scheme_uri = p-&gt;value.string;</span>
<span class="lineNum">    2585 </span><span class="lineCov">        229 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_PROTECTION_KMS_URI);</span>
<span class="lineNum">    2586 </span><span class="lineCov">        229 :                 if (p) kms_uri = p-&gt;value.string;</span>
<span class="lineNum">    2587 </span>            : 
<span class="lineNum">    2588 </span><span class="lineCov">        229 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ISMA_SELECTIVE_ENC);</span>
<span class="lineNum">    2589 </span><span class="lineCov">        229 :                 if (p) is_sel_enc = p-&gt;value.boolean;</span>
<span class="lineNum">    2590 </span><span class="lineCov">        229 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ISMA_IV_LENGTH);</span>
<span class="lineNum">    2591 </span><span class="lineCov">        229 :                 if (p) IV_length = p-&gt;value.uint;</span>
<span class="lineNum">    2592 </span><span class="lineCov">        229 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ISMA_KI_LENGTH);</span>
<span class="lineNum">    2593 </span><span class="lineCov">        229 :                 if (p) KI_length = p-&gt;value.uint;</span>
<span class="lineNum">    2594 </span>            : 
<span class="lineNum">    2595 </span><span class="lineCov">        229 :                 tkw-&gt;scheme_type = scheme_type;</span>
<span class="lineNum">    2596 </span><span class="lineCov">        229 :                 switch (scheme_type) {</span>
<span class="lineNum">    2597 </span><span class="lineCov">         11 :                 case GF_ISOM_ISMACRYP_SCHEME:</span>
<span class="lineNum">    2598 </span><span class="lineCov">         11 :                         gf_isom_set_ismacryp_protection(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, scheme_type, scheme_version, (char *) scheme_uri, (char *) kms_uri, is_sel_enc, KI_length, IV_length);</span>
<span class="lineNum">    2599 </span><span class="lineCov">         11 :                         break;</span>
<span class="lineNum">    2600 </span><span class="lineNoCov">          0 :                 case GF_ISOM_OMADRM_SCHEME:</span>
<span class="lineNum">    2601 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_OMA_CRYPT_TYPE);</span>
<span class="lineNum">    2602 </span><span class="lineNoCov">          0 :                         if (p) oma_encryption_type = p-&gt;value.uint;</span>
<span class="lineNum">    2603 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_OMA_CID);</span>
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 :                         if (p) oma_contentID = p-&gt;value.string;</span>
<span class="lineNum">    2605 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_OMA_TXT_HDR);</span>
<span class="lineNum">    2606 </span><span class="lineNoCov">          0 :                         if (p) oma_textual_headers = p-&gt;value.string;</span>
<span class="lineNum">    2607 </span><span class="lineNoCov">          0 :                         if (oma_textual_headers) textual_headers_len = (u32) strlen(oma_textual_headers);</span>
<span class="lineNum">    2608 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_OMA_CLEAR_LEN);</span>
<span class="lineNum">    2609 </span><span class="lineNoCov">          0 :                         if (p) oma_plainTextLength = p-&gt;value.longuint;</span>
<span class="lineNum">    2610 </span><span class="lineNoCov">          0 :                         gf_isom_set_oma_protection(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, (char *) oma_contentID, (char*) kms_uri, oma_encryption_type, oma_plainTextLength, (char*)oma_textual_headers, textual_headers_len,</span>
<span class="lineNum">    2611 </span>            :                                   is_sel_enc, KI_length, IV_length);
<span class="lineNum">    2612 </span>            : 
<span class="lineNum">    2613 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2614 </span><span class="lineCov">         10 :                 case GF_ISOM_ADOBE_SCHEME:</span>
<span class="lineNum">    2615 </span><span class="lineCov">         10 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_ADOBE_CRYPT_META);</span>
<span class="lineNum">    2616 </span><span class="lineCov">         10 :                         gf_isom_set_adobe_protection(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, scheme_type, 1/*scheme_version*/, 1/*is_sel_enc*/,p ? p-&gt;value.data.ptr : NULL, p ? p-&gt;value.data.size : 0);</span>
<span class="lineNum">    2617 </span><span class="lineCov">         10 :                         break;</span>
<span class="lineNum">    2618 </span><span class="lineCov">        208 :                 case GF_ISOM_PIFF_SCHEME:</span>
<span class="lineNum">    2619 </span>            :                 case GF_ISOM_CENC_SCHEME:
<span class="lineNum">    2620 </span>            :                 case GF_ISOM_CENS_SCHEME:
<span class="lineNum">    2621 </span>            :                 case GF_ISOM_CBC_SCHEME:
<span class="lineNum">    2622 </span>            :                 case GF_ISOM_CBCS_SCHEME:
<span class="lineNum">    2623 </span><span class="lineCov">        208 :                         tkw-&gt;cenc_state = CENC_NEED_SETUP;</span>
<span class="lineNum">    2624 </span><span class="lineCov">        208 :                         if (tkw-&gt;is_nalu || tkw-&gt;is_av1 || tkw-&gt;is_vpx) tkw-&gt;cenc_subsamples = GF_TRUE;</span>
<span class="lineNum">    2625 </span>            :                         break;
<span class="lineNum">    2626 </span><span class="lineNoCov">          0 :                 default:</span>
<span class="lineNum">    2627 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unrecognized protection scheme type %s, using generic signaling\n&quot;, gf_4cc_to_str(tkw-&gt;stream_type) ));</span>
<span class="lineNum">    2628 </span><span class="lineNoCov">          0 :                         switch (tkw-&gt;stream_type) {</span>
<span class="lineNum">    2629 </span><span class="lineNoCov">          0 :                         case GF_STREAM_VISUAL:</span>
<span class="lineNum">    2630 </span><span class="lineNoCov">          0 :                                 gf_isom_set_media_type(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_BOX_TYPE_ENCV);</span>
<span class="lineNum">    2631 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    2632 </span><span class="lineNoCov">          0 :                         case GF_STREAM_AUDIO:</span>
<span class="lineNum">    2633 </span><span class="lineNoCov">          0 :                                 gf_isom_set_media_type(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_BOX_TYPE_ENCA);</span>
<span class="lineNum">    2634 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    2635 </span><span class="lineNoCov">          0 :                         case GF_STREAM_TEXT:</span>
<span class="lineNum">    2636 </span><span class="lineNoCov">          0 :                                 gf_isom_set_media_type(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_BOX_TYPE_ENCT);</span>
<span class="lineNum">    2637 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    2638 </span><span class="lineNoCov">          0 :                         case GF_STREAM_FONT:</span>
<span class="lineNum">    2639 </span><span class="lineNoCov">          0 :                                 gf_isom_set_media_type(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_BOX_TYPE_ENCF);</span>
<span class="lineNum">    2640 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    2641 </span><span class="lineNoCov">          0 :                         default:</span>
<span class="lineNum">    2642 </span><span class="lineNoCov">          0 :                                 gf_isom_set_media_type(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_BOX_TYPE_ENCS);</span>
<span class="lineNum">    2643 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    2644 </span>            :                         }
<span class="lineNum">    2645 </span><span class="lineNoCov">          0 :                         gf_isom_set_generic_protection(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, scheme_type, scheme_version, (char*)scheme_uri, (char*)kms_uri);</span>
<span class="lineNum">    2646 </span>            :                 }
<span class="lineNum">    2647 </span>            :         } else {
<span class="lineNum">    2648 </span>            :                 //in case we used track template
<span class="lineNum">    2649 </span><span class="lineCov">       1252 :                 gf_isom_remove_samp_enc_box(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    2650 </span><span class="lineCov">       1252 :                 gf_isom_remove_samp_group_box(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    2651 </span>            :         }
<span class="lineNum">    2652 </span>            : 
<span class="lineNum">    2653 </span><span class="lineCov">       1481 :         if (is_true_pid) {</span>
<span class="lineNum">    2654 </span><span class="lineCov">       1454 :                 mp4_mux_write_track_refs(ctx, tkw, &quot;isom:scal&quot;, GF_ISOM_REF_SCAL);</span>
<span class="lineNum">    2655 </span><span class="lineCov">       1454 :                 mp4_mux_write_track_refs(ctx, tkw, &quot;isom:sabt&quot;, GF_ISOM_REF_SABT);</span>
<span class="lineNum">    2656 </span><span class="lineCov">       1454 :                 mp4_mux_write_track_refs(ctx, tkw, &quot;isom:tbas&quot;, GF_ISOM_REF_TBAS);</span>
<span class="lineNum">    2657 </span>            :                 //whenever we add a new tile track, rewrite sabt on main tile track
<span class="lineNum">    2658 </span><span class="lineCov">       1454 :                 if (codec_id==GF_CODECID_HEVC_TILES) {</span>
<span class="lineNum">    2659 </span><span class="lineCov">         51 :                         count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    2660 </span><span class="lineCov">        168 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2661 </span><span class="lineCov">        117 :                                 TrackWriter *base_tk = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    2662 </span><span class="lineCov">        117 :                                 if (base_tk-&gt;is_hevc_tile_base)</span>
<span class="lineNum">    2663 </span><span class="lineCov">         15 :                                         mp4_mux_write_track_refs(ctx, base_tk, &quot;isom:sabt&quot;, GF_ISOM_REF_SABT);</span>
<span class="lineNum">    2664 </span>            :                         }
<span class="lineNum">    2665 </span>            :                 }
<span class="lineNum">    2666 </span>            : 
<span class="lineNum">    2667 </span>            :                 //check if we have sample-accurate seek info for the pid. If so, enable seek ts checking
<span class="lineNum">    2668 </span><span class="lineCov">       1454 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PCK_SKIP_BEGIN);</span>
<span class="lineNum">    2669 </span><span class="lineCov">       1454 :                 if (p &amp;&amp; p-&gt;value.sint)</span>
<span class="lineNum">    2670 </span><span class="lineCov">         10 :                         tkw-&gt;check_seek_ts = GF_TRUE;</span>
<span class="lineNum">    2671 </span>            : 
<span class="lineNum">    2672 </span><span class="lineCov">         27 :         } else if (codec_id==GF_CODECID_HEVC_TILES) {</span>
<span class="lineNum">    2673 </span><span class="lineCov">         27 :                 mp4_mux_write_track_refs(ctx, tkw, &quot;isom:tbas&quot;, GF_ISOM_REF_TBAS);</span>
<span class="lineNum">    2674 </span>            :         }
<span class="lineNum">    2675 </span>            : 
<span class="lineNum">    2676 </span><span class="lineCov">       1481 :         if (is_true_pid &amp;&amp; ctx-&gt;dash_mode &amp;&amp; is_tile_base) {</span>
<span class="lineNum">    2677 </span><span class="lineCov">          3 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_DASH_MULTI_TRACK);</span>
<span class="lineNum">    2678 </span><span class="lineCov">          3 :                 if (p) {</span>
<span class="lineNum">    2679 </span><span class="lineCov">          3 :                         GF_List *multi_tracks = p-&gt;value.ptr;</span>
<span class="lineNum">    2680 </span><span class="lineCov">          3 :                         count = gf_list_count(multi_tracks);</span>
<span class="lineNum">    2681 </span><span class="lineCov">         30 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2682 </span><span class="lineCov">         27 :                                 GF_FilterPid *a_ipid = gf_list_get(multi_tracks, i);</span>
<span class="lineNum">    2683 </span><span class="lineCov">         27 :                                 mp4_mux_setup_pid(filter, a_ipid, GF_FALSE);</span>
<span class="lineNum">    2684 </span>            :                         }
<span class="lineNum">    2685 </span>            :                 }
<span class="lineNum">    2686 </span>            :         }
<span class="lineNum">    2687 </span>            : 
<span class="lineNum">    2688 </span><span class="lineCov">       1481 :         if (width) {</span>
<span class="lineNum">    2689 </span><span class="lineCov">       1082 :                 if (ctx-&gt;ccst) {</span>
<span class="lineNum">    2690 </span><span class="lineNoCov">          0 :                         e = gf_isom_set_image_sequence_coding_constraints(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, GF_FALSE, GF_FALSE, GF_TRUE, 15);</span>
<span class="lineNum">    2691 </span><span class="lineNoCov">          0 :                         if (e) {</span>
<span class="lineNum">    2692 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to set coding constraints parameter: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2693 </span>            :                         }
<span class="lineNum">    2694 </span>            :                 }
<span class="lineNum">    2695 </span><span class="lineCov">       1082 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_ALPHA);</span>
<span class="lineNum">    2696 </span><span class="lineCov">       1083 :                 if (p &amp;&amp; p-&gt;value.boolean) {</span>
<span class="lineNum">    2697 </span><span class="lineCov">          1 :                         e = gf_isom_set_image_sequence_alpha(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, GF_FALSE);</span>
<span class="lineNum">    2698 </span><span class="lineCov">          1 :                         if (e) {</span>
<span class="lineNum">    2699 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to set alpha config: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    2700 </span>            :                         }
<span class="lineNum">    2701 </span>            :                 }
<span class="lineNum">    2702 </span>            :         }
<span class="lineNum">    2703 </span>            : 
<span class="lineNum">    2704 </span><span class="lineCov">       5538 : sample_entry_done:</span>
<span class="lineNum">    2705 </span><span class="lineCov">       2769 :         if (!tkw-&gt;is_item) {</span>
<span class="lineNum">    2706 </span><span class="lineCov">       2721 :                 if (ctx-&gt;maxchunk)</span>
<span class="lineNum">    2707 </span><span class="lineNoCov">          0 :                         gf_isom_hint_max_chunk_size(ctx-&gt;file, tkw-&gt;track_num, ctx-&gt;maxchunk);</span>
<span class="lineNum">    2708 </span>            : 
<span class="lineNum">    2709 </span><span class="lineCov">       2721 :                 if (ctx-&gt;store==MP4MX_MODE_FLAT)</span>
<span class="lineNum">    2710 </span><span class="lineNoCov">          0 :                         gf_isom_hint_max_chunk_duration(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;tk_timescale * ctx-&gt;cdur.num / ctx-&gt;cdur.den);</span>
<span class="lineNum">    2711 </span>            : 
<span class="lineNum">    2712 </span><span class="lineCov">       2721 :                 if (sr) {</span>
<span class="lineNum">    2713 </span><span class="lineCov">       1150 :                         if (use_flac_entry) {</span>
<span class="lineNum">    2714 </span><span class="lineCov">          2 :                                 while (sr&gt;65535) {</span>
<span class="lineNum">    2715 </span><span class="lineNoCov">          0 :                                         u32 val = sr/2;</span>
<span class="lineNum">    2716 </span><span class="lineNoCov">          0 :                                         if (val*2 != sr) {</span>
<span class="lineNum">    2717 </span>            :                                                 sr=65535;
<span class="lineNum">    2718 </span>            :                                                 break;
<span class="lineNum">    2719 </span>            :                                         }
<span class="lineNum">    2720 </span>            :                                         sr = val;
<span class="lineNum">    2721 </span>            :                                 }
<span class="lineNum">    2722 </span>            :                         }
<span class="lineNum">    2723 </span><span class="lineCov">       1150 :                         gf_isom_set_audio_info(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, sr, nb_chan, nb_bps, ctx-&gt;make_qt ? GF_IMPORT_AUDIO_SAMPLE_ENTRY_v1_QTFF : ase_mode);</span>
<span class="lineNum">    2724 </span><span class="lineCov">       1150 :                         if ((m_subtype==GF_ISOM_SUBTYPE_IPCM) || (m_subtype==GF_ISOM_SUBTYPE_FPCM)) {</span>
<span class="lineNum">    2725 </span>            :                                 GF_AudioChannelLayout layout;
<span class="lineNum">    2726 </span>            :                                 memset(&amp;layout, 0, sizeof(GF_AudioChannelLayout));
<span class="lineNum">    2727 </span><span class="lineCov">          5 :                                 layout.stream_structure = 1;</span>
<span class="lineNum">    2728 </span><span class="lineCov">          5 :                                 layout.channels_count = nb_chan;</span>
<span class="lineNum">    2729 </span><span class="lineCov">          5 :                                 if (ch_layout)</span>
<span class="lineNum">    2730 </span><span class="lineNoCov">          0 :                                         layout.definedLayout = gf_audio_fmt_get_cicp_from_layout(ch_layout);</span>
<span class="lineNum">    2731 </span>            :                                 else
<span class="lineNum">    2732 </span><span class="lineCov">          5 :                                         layout.definedLayout = gf_audio_fmt_get_cicp_layout(nb_chan, 0, 0);</span>
<span class="lineNum">    2733 </span><span class="lineCov">          5 :                                 gf_isom_set_audio_layout(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, &amp;layout);</span>
<span class="lineNum">    2734 </span>            :                         }
<span class="lineNum">    2735 </span>            :                 }
<span class="lineNum">    2736 </span><span class="lineCov">       1571 :                 else if (width) {</span>
<span class="lineNum">    2737 </span><span class="lineCov">       1458 :                         u32 colour_type=0;</span>
<span class="lineNum">    2738 </span><span class="lineCov">       1458 :                         u16 colour_primaries=0, transfer_characteristics=0, matrix_coefficients=0;</span>
<span class="lineNum">    2739 </span><span class="lineCov">       1458 :                         Bool full_range_flag=GF_FALSE;</span>
<span class="lineNum">    2740 </span>            : 
<span class="lineNum">    2741 </span><span class="lineCov">       1458 :                         gf_isom_set_visual_info(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, width, height);</span>
<span class="lineNum">    2742 </span><span class="lineCov">       1458 :                         if (sar.den) {</span>
<span class="lineNum">    2743 </span><span class="lineCov">        113 :                                 if (sar.num != sar.den) {</span>
<span class="lineNum">    2744 </span><span class="lineCov">         26 :                                         gf_isom_set_pixel_aspect_ratio(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, sar.num, sar.den, GF_FALSE);</span>
<span class="lineNum">    2745 </span><span class="lineCov">         26 :                                         width = width * sar.num / sar.den;</span>
<span class="lineNum">    2746 </span>            :                                 }
<span class="lineNum">    2747 </span>            :                                 //old importer did not set PASP for
<span class="lineNum">    2748 </span><span class="lineCov">         87 :                                 else if (!gf_sys_old_arch_compat() || (codec_id!=GF_CODECID_MPEG4_PART2) ) {</span>
<span class="lineNum">    2749 </span><span class="lineCov">         39 :                                         gf_isom_set_pixel_aspect_ratio(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, 1, 1, GF_TRUE);</span>
<span class="lineNum">    2750 </span>            :                                 }
<span class="lineNum">    2751 </span>            :                         }
<span class="lineNum">    2752 </span>            : 
<span class="lineNum">    2753 </span><span class="lineCov">       1458 :                         gf_isom_set_track_layout_info(ctx-&gt;file, tkw-&gt;track_num, width&lt;&lt;16, height&lt;&lt;16, 0, 0, z_order);</span>
<span class="lineNum">    2754 </span><span class="lineCov">       1458 :                         if (codec_id==GF_CODECID_HEVC_TILES) {</span>
<span class="lineNum">    2755 </span><span class="lineCov">         78 :                                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ORIG_SIZE);</span>
<span class="lineNum">    2756 </span><span class="lineCov">         78 :                                 if (p) {</span>
<span class="lineNum">    2757 </span><span class="lineCov">         45 :                                         gf_isom_set_track_layout_info(ctx-&gt;file, tkw-&gt;track_num, p-&gt;value.vec2i.x&lt;&lt;16, p-&gt;value.vec2i.y&lt;&lt;16, 0, 0, z_order);</span>
<span class="lineNum">    2758 </span>            :                                 }
<span class="lineNum">    2759 </span>            :                         }
<span class="lineNum">    2760 </span>            : 
<span class="lineNum">    2761 </span><span class="lineCov">       1458 :                         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_COLR_PRIMARIES);</span>
<span class="lineNum">    2762 </span><span class="lineCov">       1458 :                         if (p) colour_primaries = p-&gt;value.uint;</span>
<span class="lineNum">    2763 </span><span class="lineCov">       1458 :                         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_COLR_TRANSFER);</span>
<span class="lineNum">    2764 </span><span class="lineCov">       1458 :                         if (p) transfer_characteristics = p-&gt;value.uint;</span>
<span class="lineNum">    2765 </span><span class="lineCov">       1458 :                         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_COLR_MX);</span>
<span class="lineNum">    2766 </span><span class="lineCov">       1458 :                         if (p) matrix_coefficients = p-&gt;value.uint;</span>
<span class="lineNum">    2767 </span><span class="lineCov">       1458 :                         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_COLR_RANGE);</span>
<span class="lineNum">    2768 </span><span class="lineCov">       1458 :                         if (p) full_range_flag = p-&gt;value.boolean;</span>
<span class="lineNum">    2769 </span>            : 
<span class="lineNum">    2770 </span><span class="lineCov">       1458 :                         if (ctx-&gt;cmaf) {</span>
<span class="lineNum">    2771 </span><span class="lineNoCov">          0 :                                 u32 hspac=0, vspac=0;</span>
<span class="lineNum">    2772 </span>            :                                 force_colr = GF_TRUE;
<span class="lineNum">    2773 </span><span class="lineNoCov">          0 :                                 gf_isom_get_pixel_aspect_ratio(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, &amp;hspac, &amp;vspac);</span>
<span class="lineNum">    2774 </span><span class="lineNoCov">          0 :                                 if (hspac &amp;&amp; vspac) {</span>
<span class="lineNum">    2775 </span><span class="lineNoCov">          0 :                                         sar.num = hspac;</span>
<span class="lineNum">    2776 </span><span class="lineNoCov">          0 :                                         sar.den = vspac;</span>
<span class="lineNum">    2777 </span>            :                                 } else {
<span class="lineNum">    2778 </span>            :                                         sar.den = 0;
<span class="lineNum">    2779 </span>            :                                 }
<span class="lineNum">    2780 </span>            :                         }
<span class="lineNum">    2781 </span>            : 
<span class="lineNum">    2782 </span><span class="lineCov">       1458 :                         if ((ctx-&gt;prores_track == tkw) || force_colr) {</span>
<span class="lineNum">    2783 </span>            :                                 u32 colr_mode;
<span class="lineNum">    2784 </span>            : 
<span class="lineNum">    2785 </span><span class="lineCov">          4 :                                 if ((ctx-&gt;prores_track == tkw) || ctx-&gt;make_qt)</span>
<span class="lineNum">    2786 </span>            :                                         colr_mode = GF_4CC('n','c','l','c');
<span class="lineNum">    2787 </span>            :                                 else
<span class="lineNum">    2788 </span>            :                                         colr_mode = GF_4CC('n','c','l','x');
<span class="lineNum">    2789 </span>            : 
<span class="lineNum">    2790 </span>            : 
<span class="lineNum">    2791 </span>            :                                 //other conditions were set above, here we force 1:1 pasp box even if no sar or 1:1
<span class="lineNum">    2792 </span><span class="lineCov">          4 :                                 if (!sar.den || (sar.num == 1)) {</span>
<span class="lineNum">    2793 </span><span class="lineCov">          3 :                                         gf_isom_set_pixel_aspect_ratio(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, -1, -1, GF_TRUE);</span>
<span class="lineNum">    2794 </span>            :                                 }
<span class="lineNum">    2795 </span>            : 
<span class="lineNum">    2796 </span><span class="lineCov">          4 :                                 if (colour_primaries || transfer_characteristics || matrix_coefficients) {</span>
<span class="lineNum">    2797 </span><span class="lineCov">          2 :                                         gf_isom_set_visual_color_info(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, colr_mode, colour_primaries, transfer_characteristics, matrix_coefficients, GF_FALSE, NULL, 0);</span>
<span class="lineNum">    2798 </span>            :                                 } else {
<span class="lineNum">    2799 </span><span class="lineCov">          2 :                                         e = gf_isom_get_color_info(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, &amp;colour_type, &amp;colour_primaries, &amp;transfer_characteristics, &amp;matrix_coefficients, &amp;full_range_flag);</span>
<span class="lineNum">    2800 </span><span class="lineCov">          2 :                                         if (e==GF_NOT_FOUND) {</span>
<span class="lineNum">    2801 </span><span class="lineCov">          1 :                                                 e = gf_media_get_color_info(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, &amp;colour_type, &amp;colour_primaries, &amp;transfer_characteristics, &amp;matrix_coefficients, &amp;full_range_flag);</span>
<span class="lineNum">    2802 </span><span class="lineCov">          1 :                                                 if (e)</span>
<span class="lineNum">    2803 </span>            :                                                         e = GF_NOT_FOUND;
<span class="lineNum">    2804 </span>            :                                         }
<span class="lineNum">    2805 </span><span class="lineCov">          1 :                                         if (e==GF_NOT_FOUND) {</span>
<span class="lineNum">    2806 </span><span class="lineCov">          1 :                                                 colour_primaries = 1;</span>
<span class="lineNum">    2807 </span><span class="lineCov">          1 :                                                 transfer_characteristics = 1;</span>
<span class="lineNum">    2808 </span><span class="lineCov">          1 :                                                 matrix_coefficients = 1;</span>
<span class="lineNum">    2809 </span><span class="lineCov">          1 :                                                 full_range_flag = GF_FALSE;</span>
<span class="lineNum">    2810 </span><span class="lineCov">          1 :                                                 if (ctx-&gt;make_qt==1) {</span>
<span class="lineNum">    2811 </span><span class="lineNoCov">          0 :                                                         GF_LOG(GF_LOG_WARNING, GF_LOG_AUTHOR, (&quot;[ProRes] No color info present in visual track, defaulting to BT709\n&quot;));</span>
<span class="lineNum">    2812 </span>            :                                                 }
<span class="lineNum">    2813 </span><span class="lineCov">          1 :                                                 else if (ctx-&gt;cmaf) {</span>
<span class="lineNum">    2814 </span><span class="lineNoCov">          0 :                                                         GF_LOG(GF_LOG_WARNING, GF_LOG_AUTHOR, (&quot;[CMAF] No color info present in visual track, defaulting to BT709\n&quot;));</span>
<span class="lineNum">    2815 </span>            :                                                 }
<span class="lineNum">    2816 </span>            :                                         }
<span class="lineNum">    2817 </span><span class="lineCov">          2 :                                         gf_isom_set_visual_color_info(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, colr_mode, colour_primaries, transfer_characteristics, matrix_coefficients, full_range_flag, NULL, 0);</span>
<span class="lineNum">    2818 </span>            :                                 }
<span class="lineNum">    2819 </span>            : 
<span class="lineNum">    2820 </span><span class="lineCov">          4 :                                 if (ctx-&gt;prores_track == tkw) {</span>
<span class="lineNum">    2821 </span>            :                                         u32 chunk_size;
<span class="lineNum">    2822 </span><span class="lineCov">          4 :                                         if ((width&lt;=720) &amp;&amp; (height&lt;=576)) chunk_size = 2000000;</span>
<span class="lineNum">    2823 </span>            :                                         else chunk_size = 4000000;
<span class="lineNum">    2824 </span><span class="lineCov">          4 :                                         gf_isom_hint_max_chunk_size(ctx-&gt;file, tkw-&gt;track_num, chunk_size);</span>
<span class="lineNum">    2825 </span>            :                                 }
<span class="lineNum">    2826 </span>            :                         } else {
<span class="lineNum">    2827 </span><span class="lineCov">       1454 :                                 if (colour_primaries || transfer_characteristics || matrix_coefficients) {</span>
<span class="lineNum">    2828 </span><span class="lineCov">         75 :                                         gf_isom_set_visual_color_info(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, GF_4CC('n','c','l','x'), colour_primaries, transfer_characteristics, matrix_coefficients, full_range_flag, NULL, 0);</span>
<span class="lineNum">    2829 </span>            :                                 }
<span class="lineNum">    2830 </span>            : 
<span class="lineNum">    2831 </span>            :                         }
<span class="lineNum">    2832 </span>            :                 }
<span class="lineNum">    2833 </span>            :                 //default for old arch
<span class="lineNum">    2834 </span><span class="lineCov">        113 :                 else if (force_tk_layout</span>
<span class="lineNum">    2835 </span><span class="lineCov">        106 :                         || (use_m4sys &amp;&amp; (tkw-&gt;stream_type==GF_STREAM_VISUAL) &amp;&amp; !width &amp;&amp; !height)</span>
<span class="lineNum">    2836 </span>            :                 )  {
<span class="lineNum">    2837 </span><span class="lineCov">         35 :                         gf_isom_set_track_layout_info(ctx-&gt;file, tkw-&gt;track_num, 320&lt;&lt;16, 240&lt;&lt;16, 0, 0, 0);</span>
<span class="lineNum">    2838 </span>            :                 }
<span class="lineNum">    2839 </span>            : 
<span class="lineNum">    2840 </span><span class="lineCov">       2721 :                 if (lang_name) gf_isom_set_media_language(ctx-&gt;file, tkw-&gt;track_num, (char*)lang_name);</span>
<span class="lineNum">    2841 </span>            : 
<span class="lineNum">    2842 </span><span class="lineCov">       2721 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_ISOM_STSD_TEMPLATE);</span>
<span class="lineNum">    2843 </span><span class="lineCov">       2721 :                 if (ctx-&gt;tktpl &amp;&amp; p &amp;&amp; p-&gt;value.data.ptr) {</span>
<span class="lineNum">    2844 </span><span class="lineCov">       1109 :                         gf_isom_update_sample_description_from_template(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, p-&gt;value.data.ptr, p-&gt;value.data.size);</span>
<span class="lineNum">    2845 </span>            :                 }
<span class="lineNum">    2846 </span>            :         }
<span class="lineNum">    2847 </span>            : 
<span class="lineNum">    2848 </span><span class="lineCov">       2769 :         if (tkw-&gt;is_encrypted) {</span>
<span class="lineNum">    2849 </span><span class="lineCov">        575 :                 tkw-&gt;cenc_ki = gf_filter_pid_get_property(pid, GF_PROP_PID_CENC_KEY_INFO);</span>
<span class="lineNum">    2850 </span><span class="lineCov">        575 :                 if (tkw-&gt;cenc_ki &amp;&amp; ((tkw-&gt;cenc_ki-&gt;type != GF_PROP_DATA) || !gf_cenc_validate_key_info(tkw-&gt;cenc_ki-&gt;value.data.ptr, tkw-&gt;cenc_ki-&gt;value.data.size))</span>
<span class="lineNum">    2851 </span>            :                 ) {
<span class="lineNum">    2852 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Invalid CENC key info\n&quot;));</span>
<span class="lineNum">    2853 </span><span class="lineNoCov">          0 :                         tkw-&gt;cenc_ki = NULL;</span>
<span class="lineNum">    2854 </span>            :                 }
<span class="lineNum">    2855 </span>            : 
<span class="lineNum">    2856 </span><span class="lineCov">        575 :                 tkw-&gt;constant_IV_size = 0;</span>
<span class="lineNum">    2857 </span><span class="lineCov">        575 :                 if (tkw-&gt;cenc_ki &amp;&amp; tkw-&gt;cenc_ki-&gt;value.data.ptr) {</span>
<span class="lineNum">    2858 </span><span class="lineCov">        554 :                         tkw-&gt;cenc_multikey = tkw-&gt;cenc_ki-&gt;value.data.ptr[0] ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2859 </span>            : 
<span class="lineNum">    2860 </span><span class="lineCov">        554 :                         if (!tkw-&gt;cenc_ki-&gt;value.data.ptr[3])</span>
<span class="lineNum">    2861 </span><span class="lineCov">         19 :                                 tkw-&gt;constant_IV_size = !tkw-&gt;cenc_ki-&gt;value.data.ptr[20];</span>
<span class="lineNum">    2862 </span>            : 
<span class="lineNum">    2863 </span><span class="lineCov">        554 :                         tkw-&gt;cenc_key_info_crc = gf_crc_32(tkw-&gt;cenc_ki-&gt;value.data.ptr, tkw-&gt;cenc_ki-&gt;value.data.size);</span>
<span class="lineNum">    2864 </span>            :                 }
<span class="lineNum">    2865 </span>            :         }
<span class="lineNum">    2866 </span>            : 
<span class="lineNum">    2867 </span><span class="lineCov">       2769 :         if (is_true_pid) {</span>
<span class="lineNum">    2868 </span><span class="lineCov">       2742 :                 const GF_PropertyValue *ster = gf_filter_pid_get_property(pid, GF_PROP_PID_STEREO_TYPE);</span>
<span class="lineNum">    2869 </span><span class="lineCov">       2742 :                 const GF_PropertyValue *proj = gf_filter_pid_get_property(pid, GF_PROP_PID_PROJECTION_TYPE);</span>
<span class="lineNum">    2870 </span><span class="lineCov">       2742 :                 const GF_PropertyValue *pose = gf_filter_pid_get_property(pid, GF_PROP_PID_VR_POSE);</span>
<span class="lineNum">    2871 </span>            : 
<span class="lineNum">    2872 </span><span class="lineCov">       2742 :                 if (ster || proj) {</span>
<span class="lineNum">    2873 </span>            :                         GF_ISOM_Y3D_Info yt3d;
<span class="lineNum">    2874 </span>            :                         memset(&amp;yt3d, 0, sizeof(GF_ISOM_Y3D_Info));
<span class="lineNum">    2875 </span><span class="lineNoCov">          0 :                         yt3d.projection_type = proj ? proj-&gt;value.uint : 0;</span>
<span class="lineNum">    2876 </span><span class="lineNoCov">          0 :                         yt3d.stereo_type = ster ? ster-&gt;value.uint : 0;</span>
<span class="lineNum">    2877 </span><span class="lineNoCov">          0 :                         if (pose) {</span>
<span class="lineNum">    2878 </span><span class="lineNoCov">          0 :                                 yt3d.pose_present = GF_TRUE;</span>
<span class="lineNum">    2879 </span><span class="lineNoCov">          0 :                                 yt3d.yaw = pose-&gt;value.vec3i.x;</span>
<span class="lineNum">    2880 </span><span class="lineNoCov">          0 :                                 yt3d.pitch = pose-&gt;value.vec3i.y;</span>
<span class="lineNum">    2881 </span><span class="lineNoCov">          0 :                                 yt3d.roll = pose-&gt;value.vec3i.z;</span>
<span class="lineNum">    2882 </span><span class="lineNoCov">          0 :                                 yt3d.stereo_type = ster ? ster-&gt;value.uint : 0;</span>
<span class="lineNum">    2883 </span>            :                         }
<span class="lineNum">    2884 </span><span class="lineNoCov">          0 :                         if (yt3d.projection_type==GF_PROJ360_CUBE_MAP) {</span>
<span class="lineNum">    2885 </span><span class="lineNoCov">          0 :                                 proj = gf_filter_pid_get_property(pid, GF_PROP_PID_CUBE_MAP_PAD);</span>
<span class="lineNum">    2886 </span><span class="lineNoCov">          0 :                                 yt3d.padding = proj ? proj-&gt;value.uint : 0;</span>
<span class="lineNum">    2887 </span>            :                         }
<span class="lineNum">    2888 </span><span class="lineNoCov">          0 :                         else if (yt3d.projection_type==GF_PROJ360_EQR) {</span>
<span class="lineNum">    2889 </span><span class="lineNoCov">          0 :                                 proj = gf_filter_pid_get_property(pid, GF_PROP_PID_EQR_CLAMP);</span>
<span class="lineNum">    2890 </span><span class="lineNoCov">          0 :                                 if (proj) {</span>
<span class="lineNum">    2891 </span><span class="lineNoCov">          0 :                                         yt3d.top = proj-&gt;value.vec4i.x;</span>
<span class="lineNum">    2892 </span><span class="lineNoCov">          0 :                                         yt3d.bottom = proj-&gt;value.vec4i.y;</span>
<span class="lineNum">    2893 </span><span class="lineNoCov">          0 :                                         yt3d.left = proj-&gt;value.vec4i.z;</span>
<span class="lineNum">    2894 </span><span class="lineNoCov">          0 :                                         yt3d.right = proj-&gt;value.vec4i.w;</span>
<span class="lineNum">    2895 </span>            :                                 }
<span class="lineNum">    2896 </span>            :                         }
<span class="lineNum">    2897 </span><span class="lineNoCov">          0 :                         gf_isom_set_y3d_info(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, &amp;yt3d);</span>
<span class="lineNum">    2898 </span>            :                 }
<span class="lineNum">    2899 </span>            :         }
<span class="lineNum">    2900 </span>            : 
<span class="lineNum">    2901 </span>            : 
<span class="lineNum">    2902 </span><span class="lineCov">       2769 :         if (is_true_pid &amp;&amp; ctx-&gt;importer &amp;&amp; !tkw-&gt;import_msg_header_done) {</span>
<span class="lineNum">    2903 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">    2904 </span><span class="lineCov">        613 :                 const char *dst_type = tkw-&gt;is_item ? &quot;Item Importing&quot; : &quot;Track Importing&quot;;</span>
<span class="lineNum">    2905 </span>            : #endif
<span class="lineNum">    2906 </span><span class="lineCov">        613 :                 tkw-&gt;import_msg_header_done = GF_TRUE;</span>
<span class="lineNum">    2907 </span><span class="lineCov">        613 :                 if (!imp_name) imp_name = comp_name;</span>
<span class="lineNum">    2908 </span><span class="lineCov">        613 :                 if (sr) {</span>
<span class="lineNum">    2909 </span><span class="lineCov">        120 :                         if (nb_chan) {</span>
<span class="lineNum">    2910 </span><span class="lineCov">        119 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;%s %s - SampleRate %d Num Channels %d\n&quot;, dst_type, imp_name, sr, nb_chan));</span>
<span class="lineNum">    2911 </span>            :                         } else {
<span class="lineNum">    2912 </span><span class="lineCov">          1 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;%s %s - SampleRate %d\n&quot;, dst_type, imp_name, sr));</span>
<span class="lineNum">    2913 </span>            :                         }
<span class="lineNum">    2914 </span><span class="lineCov">        493 :                 } else if (is_text_subs) {</span>
<span class="lineNum">    2915 </span><span class="lineCov">         70 :                         if (txt_fsize || txt_font) {</span>
<span class="lineNum">    2916 </span><span class="lineCov">         28 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;%s %s - Text track %d x %d font %s (size %d) layer %d\n&quot;, dst_type, imp_name, width, height, txt_font ? txt_font : &quot;unspecified&quot;, txt_fsize, z_order));</span>
<span class="lineNum">    2917 </span>            :                         } else {
<span class="lineNum">    2918 </span><span class="lineCov">         42 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;%s %s - Text track %d x %d layer %d\n&quot;, dst_type, imp_name, width, height, z_order));</span>
<span class="lineNum">    2919 </span>            : 
<span class="lineNum">    2920 </span>            :                         }
<span class="lineNum">    2921 </span><span class="lineCov">        423 :                 } else if (width) {</span>
<span class="lineNum">    2922 </span><span class="lineCov">        379 :                         if (sar.den &amp;&amp; sar.num) {</span>
<span class="lineNum">    2923 </span><span class="lineCov">         37 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;%s %s - Width %d Height %d FPS %d/%d SAR %d/%u\n&quot;, dst_type, imp_name, width, height, fps.num, fps.den, sar.num, sar.den));</span>
<span class="lineNum">    2924 </span>            :                         } else {
<span class="lineNum">    2925 </span><span class="lineCov">        342 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;%s %s - Width %d Height %d FPS %d/%d\n&quot;, dst_type, imp_name, width, height, fps.num, fps.den));</span>
<span class="lineNum">    2926 </span>            :                         }
<span class="lineNum">    2927 </span>            :                 } else {
<span class="lineNum">    2928 </span><span class="lineCov">         44 :                         GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;%s %s\n&quot;, dst_type, imp_name));</span>
<span class="lineNum">    2929 </span>            :                 }
<span class="lineNum">    2930 </span>            : #ifndef GPAC_DISABLE_AV_PARSERS
<span class="lineNum">    2931 </span><span class="lineCov">        613 :                 if (tkw-&gt;svcc) {</span>
<span class="lineNum">    2932 </span>            :                         AVCState avc;
<span class="lineNum">    2933 </span>            :                         memset(&amp;avc, 0, sizeof(AVCState));
<span class="lineNum">    2934 </span><span class="lineCov">          3 :                         count = gf_list_count(tkw-&gt;svcc-&gt;sequenceParameterSets);</span>
<span class="lineNum">    2935 </span><span class="lineCov">          8 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2936 </span><span class="lineCov">          5 :                                 GF_NALUFFParam *sl = gf_list_get(tkw-&gt;svcc-&gt;sequenceParameterSets, i);</span>
<span class="lineNum">    2937 </span><span class="lineCov">          5 :                                 u8 nal_type = sl-&gt;data[0] &amp; 0x1F;</span>
<span class="lineNum">    2938 </span><span class="lineCov">          5 :                                 Bool is_subseq = (nal_type == GF_AVC_NALU_SVC_SUBSEQ_PARAM) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2939 </span><span class="lineCov">          5 :                                 s32 ps_idx = gf_avc_read_sps(sl-&gt;data, sl-&gt;size, &amp;avc, is_subseq, NULL);</span>
<span class="lineNum">    2940 </span><span class="lineCov">          5 :                                 if (ps_idx&gt;=0) {</span>
<span class="lineNum">    2941 </span><span class="lineCov">          5 :                                         GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;SVC Detected - SSPS ID %d - frame size %d x %d\n&quot;, ps_idx-GF_SVC_SSPS_ID_SHIFT, avc.sps[ps_idx].width, avc.sps[ps_idx].height ));</span>
<span class="lineNum">    2942 </span>            : 
<span class="lineNum">    2943 </span>            :                                 }
<span class="lineNum">    2944 </span>            :                         }
<span class="lineNum">    2945 </span>            :                 }
<span class="lineNum">    2946 </span>            : #endif
<span class="lineNum">    2947 </span>            : 
<span class="lineNum">    2948 </span>            :         }
<span class="lineNum">    2949 </span><span class="lineCov">       2769 :         if (txt_font) gf_free(txt_font);</span>
<span class="lineNum">    2950 </span><span class="lineCov">       2769 :         if (!ctx-&gt;xps_inband || tkw-&gt;is_item) {</span>
<span class="lineNum">    2951 </span><span class="lineCov">       2745 :                 if (tkw-&gt;svcc) {</span>
<span class="lineNum">    2952 </span><span class="lineCov">          6 :                         gf_odf_avc_cfg_del(tkw-&gt;svcc);</span>
<span class="lineNum">    2953 </span><span class="lineCov">          6 :                         tkw-&gt;svcc = NULL;</span>
<span class="lineNum">    2954 </span>            :                 }
<span class="lineNum">    2955 </span><span class="lineCov">       2745 :                 if (tkw-&gt;lvcc) {</span>
<span class="lineNum">    2956 </span><span class="lineCov">          8 :                         gf_odf_hevc_cfg_del(tkw-&gt;lvcc);</span>
<span class="lineNum">    2957 </span><span class="lineCov">          8 :                         tkw-&gt;lvcc = NULL;</span>
<span class="lineNum">    2958 </span>            :                 }
<span class="lineNum">    2959 </span><span class="lineCov">         24 :         } else if (needs_sample_entry || make_inband_headers) {</span>
<span class="lineNum">    2960 </span><span class="lineCov">         24 :                 mp4_mux_make_inband_header(ctx, tkw, GF_FALSE);</span>
<span class="lineNum">    2961 </span><span class="lineCov">         24 :                 if (ctx-&gt;pps_inband)</span>
<span class="lineNum">    2962 </span><span class="lineNoCov">          0 :                         mp4_mux_make_inband_header(ctx, tkw, GF_TRUE);</span>
<span class="lineNum">    2963 </span>            :         }
<span class="lineNum">    2964 </span>            : 
<span class="lineNum">    2965 </span><span class="lineCov">       2769 :         tkw-&gt;negctts_shift = 0;</span>
<span class="lineNum">    2966 </span><span class="lineCov">       2769 :         tkw-&gt;probe_min_ctts = GF_FALSE;</span>
<span class="lineNum">    2967 </span><span class="lineCov">       2769 :         if (is_true_pid &amp;&amp; !tkw-&gt;nb_samples &amp;&amp; !tkw-&gt;is_item) {</span>
<span class="lineNum">    2968 </span>            :                 Bool use_negccts = GF_FALSE;
<span class="lineNum">    2969 </span>            :                 Bool remove_edits = GF_FALSE;
<span class="lineNum">    2970 </span><span class="lineCov">       1461 :                 s64 moffset=0;</span>
<span class="lineNum">    2971 </span><span class="lineCov">       1461 :                 ctx-&gt;config_timing = GF_TRUE;</span>
<span class="lineNum">    2972 </span><span class="lineCov">       1461 :                 ctx-&gt;update_report = GF_TRUE;</span>
<span class="lineNum">    2973 </span>            : 
<span class="lineNum">    2974 </span>            :                 //if we have an edit list (due to track template) only providing media offset, trash it
<span class="lineNum">    2975 </span><span class="lineCov">       1461 :                 if (!gf_isom_get_edit_list_type(ctx-&gt;file, tkw-&gt;track_num, &amp;moffset)) {</span>
<span class="lineNum">    2976 </span><span class="lineCov">       1461 :                         if (!gf_sys_old_arch_compat()) {</span>
<span class="lineNum">    2977 </span><span class="lineCov">         11 :                                 gf_isom_remove_edits(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    2978 </span>            :                         } else {
<span class="lineNum">    2979 </span>            :                                 //old arch compat: if we had a simple edit list in source, keep dur and offset
<span class="lineNum">    2980 </span>            :                                 //and avoid rewriting it when recomputing edit for b-frames
<span class="lineNum">    2981 </span>            :                                 u64 etime, sdur;
<span class="lineNum">    2982 </span>            :                                 GF_ISOEditType etype;
<span class="lineNum">    2983 </span><span class="lineCov">       1450 :                                 gf_isom_get_edit(ctx-&gt;file, tkw-&gt;track_num, 1, &amp;etime, &amp;sdur, &amp;moffset, &amp;etype);</span>
<span class="lineNum">    2984 </span><span class="lineCov">       1450 :                                 if (!etime &amp;&amp; sdur) {</span>
<span class="lineNum">    2985 </span><span class="lineCov">        192 :                                         tkw-&gt;imported_edit_sdur = sdur;</span>
<span class="lineNum">    2986 </span><span class="lineCov">        192 :                                         tkw-&gt;imported_edit_offset = moffset;</span>
<span class="lineNum">    2987 </span>            :                                 }
<span class="lineNum">    2988 </span>            :                                 remove_edits = GF_TRUE;
<span class="lineNum">    2989 </span>            :                         }
<span class="lineNum">    2990 </span>            :                 }
<span class="lineNum">    2991 </span><span class="lineCov">       1461 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_DELAY);</span>
<span class="lineNum">    2992 </span><span class="lineCov">       1461 :                 if (p) {</span>
<span class="lineNum">    2993 </span>            :                         //media skip
<span class="lineNum">    2994 </span><span class="lineCov">        136 :                         if (p-&gt;value.longsint &lt; 0) {</span>
<span class="lineNum">    2995 </span>            :                                 //if cmf2, remove edits and use negctss
<span class="lineNum">    2996 </span><span class="lineCov">        136 :                                 if ((ctx-&gt;cmaf==MP4MX_CMAF_CMF2) &amp;&amp; (tkw-&gt;stream_type==GF_STREAM_VISUAL)) {</span>
<span class="lineNum">    2997 </span><span class="lineNoCov">          0 :                                         ctx-&gt;ctmode = MP4MX_CT_NEGCTTS;</span>
<span class="lineNum">    2998 </span><span class="lineNoCov">          0 :                                         gf_isom_remove_edits(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    2999 </span><span class="lineNoCov">          0 :                                         use_negccts = GF_TRUE;</span>
<span class="lineNum">    3000 </span>            :                                 }
<span class="lineNum">    3001 </span><span class="lineCov">        136 :                                 else if ((ctx-&gt;ctmode==MP4MX_CT_NEGCTTS) &amp;&amp; (tkw-&gt;stream_type==GF_STREAM_VISUAL)) {</span>
<span class="lineNum">    3002 </span>            :                                         use_negccts = GF_TRUE;
<span class="lineNum">    3003 </span>            :                                 } else {
<span class="lineNum">    3004 </span><span class="lineCov">        136 :                                         if (remove_edits) {</span>
<span class="lineNum">    3005 </span><span class="lineCov">        136 :                                                 gf_isom_remove_edits(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    3006 </span>            :                                         }
<span class="lineNum">    3007 </span><span class="lineCov">        136 :                                         gf_isom_set_edit(ctx-&gt;file, tkw-&gt;track_num, 0, 0, -p-&gt;value.longsint, GF_ISOM_EDIT_NORMAL);</span>
<span class="lineNum">    3008 </span>            :                                 }
<span class="lineNum">    3009 </span>            :                         }
<span class="lineNum">    3010 </span>            :                         //media delay
<span class="lineNum">    3011 </span><span class="lineNoCov">          0 :                         else if (p-&gt;value.longsint &gt; 0) {</span>
<span class="lineNum">    3012 </span>            :                                 //if cmaf (whether cmfc or cmf2), remove edits and add delay to tfdt
<span class="lineNum">    3013 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;cmaf) {</span>
<span class="lineNum">    3014 </span><span class="lineNoCov">          0 :                                         gf_isom_remove_edits(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    3015 </span><span class="lineNoCov">          0 :                                         tkw-&gt;patch_tfdt = GF_TRUE;</span>
<span class="lineNum">    3016 </span>            :                                 } else {
<span class="lineNum">    3017 </span>            :                                         s64 dur = p-&gt;value.longsint;
<span class="lineNum">    3018 </span><span class="lineNoCov">          0 :                                         dur *= (u32) ctx-&gt;moovts;</span>
<span class="lineNum">    3019 </span><span class="lineNoCov">          0 :                                         dur /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    3020 </span><span class="lineNoCov">          0 :                                         if (remove_edits) {</span>
<span class="lineNum">    3021 </span><span class="lineNoCov">          0 :                                                 gf_isom_remove_edits(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    3022 </span>            :                                         }
<span class="lineNum">    3023 </span><span class="lineNoCov">          0 :                                         gf_isom_set_edit(ctx-&gt;file, tkw-&gt;track_num, 0, dur, 0, GF_ISOM_EDIT_DWELL);</span>
<span class="lineNum">    3024 </span><span class="lineNoCov">          0 :                                         gf_isom_set_edit(ctx-&gt;file, tkw-&gt;track_num, dur, 0, 0, GF_ISOM_EDIT_NORMAL);</span>
<span class="lineNum">    3025 </span>            :                                 }
<span class="lineNum">    3026 </span>            :                         }
<span class="lineNum">    3027 </span><span class="lineCov">        136 :                         tkw-&gt;ts_delay = p-&gt;value.sint;</span>
<span class="lineNum">    3028 </span><span class="lineCov">       1325 :                 } else if (tkw-&gt;stream_type==GF_STREAM_VISUAL) {</span>
<span class="lineNum">    3029 </span><span class="lineCov">        824 :                         tkw-&gt;probe_min_ctts = GF_TRUE;</span>
<span class="lineNum">    3030 </span>            :                 }
<span class="lineNum">    3031 </span><span class="lineCov">        136 :                 if (use_negccts) {</span>
<span class="lineNum">    3032 </span><span class="lineNoCov">          0 :                         gf_isom_set_composition_offset_mode(ctx-&gt;file, tkw-&gt;track_num, GF_TRUE);</span>
<span class="lineNum">    3033 </span>            : 
<span class="lineNum">    3034 </span><span class="lineNoCov">          0 :                         if (!tkw-&gt;has_brands) {</span>
<span class="lineNum">    3035 </span><span class="lineNoCov">          0 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO4, GF_TRUE);</span>
<span class="lineNum">    3036 </span><span class="lineNoCov">          0 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISOM, GF_FALSE);</span>
<span class="lineNum">    3037 </span><span class="lineNoCov">          0 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO1, GF_FALSE);</span>
<span class="lineNum">    3038 </span><span class="lineNoCov">          0 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO2, GF_FALSE);</span>
<span class="lineNum">    3039 </span><span class="lineNoCov">          0 :                                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO3, GF_FALSE);</span>
<span class="lineNum">    3040 </span>            :                         }
<span class="lineNum">    3041 </span>            : 
<span class="lineNum">    3042 </span><span class="lineNoCov">          0 :                         tkw-&gt;negctts_shift = (tkw-&gt;ts_delay&lt;0) ? -tkw-&gt;ts_delay : 0;</span>
<span class="lineNum">    3043 </span>            :                 } else {
<span class="lineNum">    3044 </span>            :                         //this will remove any cslg in the track due to template
<span class="lineNum">    3045 </span><span class="lineCov">       1461 :                         gf_isom_set_composition_offset_mode(ctx-&gt;file, tkw-&gt;track_num, GF_FALSE);</span>
<span class="lineNum">    3046 </span>            :                 }
<span class="lineNum">    3047 </span>            : 
<span class="lineNum">    3048 </span><span class="lineCov">       1461 :                 mp4_mux_set_tags(ctx, tkw);</span>
<span class="lineNum">    3049 </span>            :         }
<span class="lineNum">    3050 </span>            :         return GF_OK;
<span class="lineNum">    3051 </span>            : }
<span class="lineNum">    3052 </span>            : 
<span class="lineNum">    3053 </span>            : static GF_Err mp4_mux_flush_fragmented(GF_Filter *filter, GF_MP4MuxCtx *ctx);
<a name="3054"><span class="lineNum">    3054 </span>            : static GF_Err mp4_mux_done(GF_Filter *filter, GF_MP4MuxCtx *ctx, Bool is_final);</a>
<span class="lineNum">    3055 </span>            : 
<span class="lineNum">    3056 </span><span class="lineCov">       2778 : static GF_Err mp4_mux_configure_pid(GF_Filter *filter, GF_FilterPid *pid, Bool is_remove)</span>
<span class="lineNum">    3057 </span>            : {
<span class="lineNum">    3058 </span><span class="lineCov">       2778 :         GF_MP4MuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    3059 </span>            : 
<span class="lineNum">    3060 </span><span class="lineCov">       2778 :         if (is_remove) {</span>
<span class="lineNum">    3061 </span><span class="lineCov">         11 :                 TrackWriter *tkw = gf_filter_pid_get_udta(pid);</span>
<span class="lineNum">    3062 </span><span class="lineCov">         11 :                 if (tkw) {</span>
<span class="lineNum">    3063 </span><span class="lineCov">         11 :                         gf_list_del_item(ctx-&gt;tracks, tkw);</span>
<span class="lineNum">    3064 </span><span class="lineCov">         11 :                         gf_free(tkw);</span>
<span class="lineNum">    3065 </span>            :                 }
<span class="lineNum">    3066 </span>            :                 //removing last pid
<span class="lineNum">    3067 </span><span class="lineCov">         11 :                 if (ctx-&gt;opid &amp;&amp; !gf_list_count(ctx-&gt;tracks)) {</span>
<span class="lineNum">    3068 </span><span class="lineCov">          9 :                         if (ctx-&gt;file) {</span>
<span class="lineNum">    3069 </span>            :                                 //non-frag file, flush file
<span class="lineNum">    3070 </span><span class="lineCov">          9 :                                 if (!ctx-&gt;init_movie_done) {</span>
<span class="lineNum">    3071 </span><span class="lineNoCov">          0 :                                         mp4_mux_done(filter, ctx, GF_TRUE);</span>
<span class="lineNum">    3072 </span>            :                                 }
<span class="lineNum">    3073 </span>            :                         } else {
<span class="lineNum">    3074 </span><span class="lineNoCov">          0 :                                 while (ctx-&gt;flush_size) {</span>
<span class="lineNum">    3075 </span><span class="lineNoCov">          0 :                                         GF_Err e = mp4_mux_flush_fragmented(filter, ctx);</span>
<span class="lineNum">    3076 </span><span class="lineNoCov">          0 :                                         if (e) break;</span>
<span class="lineNum">    3077 </span>            :                                 }
<span class="lineNum">    3078 </span>            :                         }
<span class="lineNum">    3079 </span>            :                         //delete output pid (to flush destruction of filter chain)
<span class="lineNum">    3080 </span><span class="lineCov">          9 :                         gf_filter_pid_remove(ctx-&gt;opid);</span>
<span class="lineNum">    3081 </span><span class="lineCov">          9 :                         ctx-&gt;opid = NULL;</span>
<span class="lineNum">    3082 </span>            :                 }
<span class="lineNum">    3083 </span>            :                 return GF_OK;
<span class="lineNum">    3084 </span>            :         }
<span class="lineNum">    3085 </span><span class="lineCov">       2767 :         return mp4_mux_setup_pid(filter, pid, GF_TRUE);</span>
<a name="3086"><span class="lineNum">    3086 </span>            : }</a>
<span class="lineNum">    3087 </span>            : 
<span class="lineNum">    3088 </span><span class="lineCov">     283757 : static Bool mp4_mux_process_event(GF_Filter *filter, const GF_FilterEvent *evt)</span>
<span class="lineNum">    3089 </span>            : {
<span class="lineNum">    3090 </span><span class="lineCov">     283757 :         GF_MP4MuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    3091 </span>            : 
<span class="lineNum">    3092 </span><span class="lineCov">     283757 :         if (evt-&gt;base.on_pid &amp;&amp; (evt-&gt;base.type==GF_FEVT_INFO_UPDATE) ) {</span>
<span class="lineNum">    3093 </span><span class="lineCov">     283068 :                 TrackWriter *tkw = gf_filter_pid_get_udta(evt-&gt;base.on_pid);</span>
<span class="lineNum">    3094 </span><span class="lineCov">     283068 :                 if (tkw) {</span>
<span class="lineNum">    3095 </span><span class="lineCov">     283068 :                         GF_PropertyEntry *pe=NULL;</span>
<span class="lineNum">    3096 </span>            :                         const GF_PropertyValue *p;
<span class="lineNum">    3097 </span><span class="lineCov">     283068 :                         p = gf_filter_pid_get_info(tkw-&gt;ipid, GF_PROP_PID_DOWN_BYTES, &amp;pe);</span>
<span class="lineNum">    3098 </span><span class="lineCov">     283068 :                         if (p) tkw-&gt;down_bytes = p-&gt;value.longuint;</span>
<span class="lineNum">    3099 </span>            : 
<span class="lineNum">    3100 </span><span class="lineCov">     283068 :                         p = gf_filter_pid_get_info(tkw-&gt;ipid, GF_PROP_PID_DOWN_SIZE, &amp;pe);</span>
<span class="lineNum">    3101 </span><span class="lineCov">     283068 :                         if (p) tkw-&gt;down_size = p-&gt;value.longuint;</span>
<span class="lineNum">    3102 </span>            : 
<span class="lineNum">    3103 </span><span class="lineCov">     283068 :                         gf_filter_release_property(pe);</span>
<span class="lineNum">    3104 </span>            :                 }
<span class="lineNum">    3105 </span>            : 
<span class="lineNum">    3106 </span>            :                 return GF_FALSE;
<span class="lineNum">    3107 </span>            :         }
<span class="lineNum">    3108 </span><span class="lineCov">        689 :         if (!evt-&gt;base.on_pid &amp;&amp; (evt-&gt;base.type==GF_FEVT_STOP) ) {</span>
<span class="lineNum">    3109 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;file &amp;&amp; ctx-&gt;owns_mov) {</span>
<span class="lineNum">    3110 </span><span class="lineNoCov">          0 :                         mp4_mux_done(filter, ctx, GF_TRUE);</span>
<span class="lineNum">    3111 </span>            :                 }
<span class="lineNum">    3112 </span>            :         }
<span class="lineNum">    3113 </span><span class="lineCov">        689 :         if (evt-&gt;base.on_pid &amp;&amp; (evt-&gt;base.type==GF_FEVT_PLAY) ) {</span>
<span class="lineNum">    3114 </span>            :                 u32 i, count;
<span class="lineNum">    3115 </span>            :                 GF_FilterEvent anevt;
<span class="lineNum">    3116 </span><span class="lineCov">        663 :                 ctx-&gt;force_play = GF_TRUE;</span>
<span class="lineNum">    3117 </span><span class="lineCov">        663 :                 if (evt-&gt;play.speed&lt;0)</span>
<span class="lineNum">    3118 </span><span class="lineCov">          1 :                         ctx-&gt;is_rewind = GF_TRUE;</span>
<span class="lineNum">    3119 </span>            : 
<span class="lineNum">    3120 </span><span class="lineCov">        663 :                 if (ctx-&gt;start == 0)</span>
<span class="lineNum">    3121 </span>            :                         return GF_FALSE;
<span class="lineNum">    3122 </span>            : 
<span class="lineNum">    3123 </span><span class="lineNoCov">          0 :                 count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    3124 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    3125 </span><span class="lineNoCov">          0 :                         TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    3126 </span><span class="lineNoCov">          0 :                         if (tkw-&gt;fake_track) continue;</span>
<span class="lineNum">    3127 </span>            : 
<span class="lineNum">    3128 </span><span class="lineNoCov">          0 :                         anevt.play = evt-&gt;play;</span>
<span class="lineNum">    3129 </span><span class="lineNoCov">          0 :                         gf_filter_pid_init_play_event(tkw-&gt;ipid, &amp;anevt, ctx-&gt;start, 0, &quot;MP4Mux&quot;);</span>
<span class="lineNum">    3130 </span><span class="lineNoCov">          0 :                         if (anevt.play.start_range &gt; 0)</span>
<span class="lineNum">    3131 </span><span class="lineNoCov">          0 :                                 tkw-&gt;wait_sap = GF_TRUE;</span>
<span class="lineNum">    3132 </span>            : 
<span class="lineNum">    3133 </span><span class="lineNoCov">          0 :                         gf_filter_pid_send_event(tkw-&gt;ipid, &amp;anevt);</span>
<span class="lineNum">    3134 </span>            :                 }
<span class="lineNum">    3135 </span>            :                 return GF_TRUE;
<span class="lineNum">    3136 </span>            :         }
<span class="lineNum">    3137 </span>            :         return GF_FALSE;
<span class="lineNum">    3138 </span>            : }
<span class="lineNum">    3139 </span>            : 
<span class="lineNum">    3140 </span>            : enum
<span class="lineNum">    3141 </span>            : {
<span class="lineNum">    3142 </span>            :         CENC_CONFIG=0,
<span class="lineNum">    3143 </span>            :         CENC_ADD_NORMAL,
<span class="lineNum">    3144 </span>            :         CENC_ADD_FRAG,
<a name="3145"><span class="lineNum">    3145 </span>            : };</a>
<span class="lineNum">    3146 </span>            : 
<span class="lineNum">    3147 </span><span class="lineCov">        218 : static void mp4_mux_cenc_insert_pssh(GF_MP4MuxCtx *ctx, TrackWriter *tkw)</span>
<span class="lineNum">    3148 </span>            : {
<span class="lineNum">    3149 </span>            :         bin128 *keyIDs=NULL;
<span class="lineNum">    3150 </span>            :         u32 max_keys = 0;
<span class="lineNum">    3151 </span>            :         u32 i, nb_pssh;
<span class="lineNum">    3152 </span>            : 
<span class="lineNum">    3153 </span>            :         //set pssh
<span class="lineNum">    3154 </span><span class="lineCov">        218 :         const GF_PropertyValue *p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_CENC_PSSH);</span>
<span class="lineNum">    3155 </span><span class="lineCov">        218 :         if (!p) return;</span>
<span class="lineNum">    3156 </span>            : 
<span class="lineNum">    3157 </span><span class="lineCov">        218 :         if (!ctx-&gt;bs_r) ctx-&gt;bs_r = gf_bs_new(p-&gt;value.data.ptr, p-&gt;value.data.size, GF_BITSTREAM_READ);</span>
<span class="lineNum">    3158 </span><span class="lineNoCov">          0 :         else gf_bs_reassign_buffer(ctx-&gt;bs_r, p-&gt;value.data.ptr, p-&gt;value.data.size);</span>
<span class="lineNum">    3159 </span>            : 
<span class="lineNum">    3160 </span><span class="lineCov">        218 :         nb_pssh = gf_bs_read_u32(ctx-&gt;bs_r);</span>
<span class="lineNum">    3161 </span><span class="lineCov">        296 :         for (i = 0; i &lt; nb_pssh; i++) {</span>
<span class="lineNum">    3162 </span>            :                 u32 mode;
<span class="lineNum">    3163 </span>            :                 bin128 sysID;
<span class="lineNum">    3164 </span>            :                 u32 j, kid_count, version=0;
<span class="lineNum">    3165 </span>            :                 char *data;
<span class="lineNum">    3166 </span>            :                 u32 len;
<span class="lineNum">    3167 </span>            : 
<span class="lineNum">    3168 </span><span class="lineCov">        296 :                 gf_bs_read_data(ctx-&gt;bs_r, sysID, 16);</span>
<span class="lineNum">    3169 </span><span class="lineCov">        296 :                 version = gf_bs_read_u32(ctx-&gt;bs_r);</span>
<span class="lineNum">    3170 </span><span class="lineCov">        296 :                 kid_count = gf_bs_read_u32(ctx-&gt;bs_r);</span>
<span class="lineNum">    3171 </span>            : 
<span class="lineNum">    3172 </span><span class="lineCov">        296 :                 if (kid_count&gt;=max_keys) {</span>
<span class="lineNum">    3173 </span>            :                         max_keys = kid_count;
<span class="lineNum">    3174 </span><span class="lineCov">        296 :                         keyIDs = gf_realloc(keyIDs, sizeof(bin128)*max_keys);</span>
<span class="lineNum">    3175 </span>            :                 }
<span class="lineNum">    3176 </span><span class="lineCov">        273 :                 for (j=0; j&lt;kid_count; j++) {</span>
<span class="lineNum">    3177 </span><span class="lineCov">        273 :                         gf_bs_read_data(ctx-&gt;bs_r, keyIDs[j], 16);</span>
<span class="lineNum">    3178 </span>            :                 }
<span class="lineNum">    3179 </span><span class="lineCov">        296 :                 len = gf_bs_read_u32(ctx-&gt;bs_r);</span>
<span class="lineNum">    3180 </span><span class="lineCov">        296 :                 data = p-&gt;value.data.ptr + gf_bs_get_position(ctx-&gt;bs_r);</span>
<span class="lineNum">    3181 </span>            : 
<span class="lineNum">    3182 </span><span class="lineCov">        296 :                 if (tkw-&gt;is_item) mode = 2;</span>
<span class="lineNum">    3183 </span><span class="lineCov">        281 :                 else if (tkw-&gt;scheme_type==GF_ISOM_PIFF_SCHEME) mode = 1;</span>
<span class="lineNum">    3184 </span>            :                 else mode = 0;
<span class="lineNum">    3185 </span>            : 
<span class="lineNum">    3186 </span><span class="lineCov">        296 :                 gf_cenc_set_pssh(ctx-&gt;file, sysID, version, kid_count, keyIDs, data, len, mode);</span>
<span class="lineNum">    3187 </span><span class="lineCov">        296 :                 gf_bs_skip_bytes(ctx-&gt;bs_r, len);</span>
<span class="lineNum">    3188 </span>            :         }
<span class="lineNum">    3189 </span><span class="lineCov">        218 :         if (keyIDs) gf_free(keyIDs);</span>
<a name="3190"><span class="lineNum">    3190 </span>            : }</a>
<span class="lineNum">    3191 </span>            : 
<span class="lineNum">    3192 </span><span class="lineCov">      41855 : static GF_Err mp4_mux_cenc_update(GF_MP4MuxCtx *ctx, TrackWriter *tkw, GF_FilterPacket *pck, u32 act_type, u32 pck_size)</span>
<span class="lineNum">    3193 </span>            : {
<span class="lineNum">    3194 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">    3195 </span>            :         GF_Err e;
<span class="lineNum">    3196 </span>            :         Bool pck_is_encrypted;
<span class="lineNum">    3197 </span>            :         u32 skip_byte_block=0, crypt_byte_block=0;
<span class="lineNum">    3198 </span>            :         u32 IV_size=0;
<span class="lineNum">    3199 </span>            :         u32 scheme_type=0;
<span class="lineNum">    3200 </span>            :         u32 scheme_version=0;
<span class="lineNum">    3201 </span>            :         u8 *fake_sai = NULL;
<span class="lineNum">    3202 </span>            :         u8 *sai = NULL;
<span class="lineNum">    3203 </span>            :         u32 sai_size = 0;
<span class="lineNum">    3204 </span>            :         Bool needs_seig = GF_FALSE;
<span class="lineNum">    3205 </span>            :         u32 sample_num;
<span class="lineNum">    3206 </span>            : 
<span class="lineNum">    3207 </span><span class="lineCov">      41855 :         if (tkw-&gt;cenc_state == CENC_SETUP_ERROR)</span>
<span class="lineNum">    3208 </span>            :                 return GF_SERVICE_ERROR;
<span class="lineNum">    3209 </span>            : 
<span class="lineNum">    3210 </span><span class="lineCov">      41855 :         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_CENC_PATTERN);</span>
<span class="lineNum">    3211 </span><span class="lineCov">      41855 :         if (p) {</span>
<span class="lineNum">    3212 </span><span class="lineCov">       8697 :                 skip_byte_block = p-&gt;value.frac.num;</span>
<span class="lineNum">    3213 </span><span class="lineCov">       8697 :                 crypt_byte_block = p-&gt;value.frac.den;</span>
<span class="lineNum">    3214 </span>            :         }
<span class="lineNum">    3215 </span>            : 
<span class="lineNum">    3216 </span><span class="lineCov">      41855 :         if (pck) {</span>
<span class="lineNum">    3217 </span><span class="lineCov">      41854 :                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_CENC_SAI);</span>
<span class="lineNum">    3218 </span><span class="lineCov">      41854 :                 if (p) {</span>
<span class="lineNum">    3219 </span><span class="lineCov">      36201 :                         sai = p-&gt;value.data.ptr;</span>
<span class="lineNum">    3220 </span><span class="lineCov">      36201 :                         sai_size = p-&gt;value.data.size;</span>
<span class="lineNum">    3221 </span>            :                 }
<span class="lineNum">    3222 </span>            :         }
<span class="lineNum">    3223 </span>            : 
<span class="lineNum">    3224 </span>            : 
<span class="lineNum">    3225 </span><span class="lineCov">      41855 :         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_PROTECTION_SCHEME_TYPE);</span>
<span class="lineNum">    3226 </span><span class="lineCov">      41855 :         if (p) scheme_type = p-&gt;value.uint;</span>
<span class="lineNum">    3227 </span><span class="lineCov">      41855 :         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_PROTECTION_SCHEME_VERSION);</span>
<span class="lineNum">    3228 </span><span class="lineCov">      41855 :         if (p) scheme_version = p-&gt;value.uint;</span>
<span class="lineNum">    3229 </span>            : 
<span class="lineNum">    3230 </span>            :         //initial setup
<span class="lineNum">    3231 </span><span class="lineCov">      41855 :         if (tkw-&gt;cenc_state==CENC_NEED_SETUP) {</span>
<span class="lineNum">    3232 </span>            :                 u32 cenc_stsd_mode=0;
<span class="lineNum">    3233 </span>            :                 u32 container_type = GF_ISOM_BOX_TYPE_SENC;
<span class="lineNum">    3234 </span>            : 
<span class="lineNum">    3235 </span><span class="lineCov">        208 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_CENC_STSD_MODE);</span>
<span class="lineNum">    3236 </span><span class="lineCov">        208 :                 if (p) cenc_stsd_mode = p-&gt;value.uint;</span>
<span class="lineNum">    3237 </span>            : 
<span class="lineNum">    3238 </span><span class="lineCov">        208 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_ENCRYPTED);</span>
<span class="lineNum">    3239 </span><span class="lineCov">        208 :                 if (p) pck_is_encrypted = p-&gt;value.boolean;</span>
<span class="lineNum">    3240 </span>            :                 else pck_is_encrypted = GF_FALSE;
<span class="lineNum">    3241 </span>            : 
<span class="lineNum">    3242 </span>            : 
<span class="lineNum">    3243 </span><span class="lineCov">        208 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_CENC_STORE);</span>
<span class="lineNum">    3244 </span><span class="lineCov">        208 :                 if (p &amp;&amp; p-&gt;value.uint) container_type = p-&gt;value.uint;</span>
<span class="lineNum">    3245 </span>            : 
<span class="lineNum">    3246 </span><span class="lineCov">        208 :                 tkw-&gt;clear_stsd_idx = 0;</span>
<span class="lineNum">    3247 </span><span class="lineCov">        208 :                 if (cenc_stsd_mode) {</span>
<span class="lineNum">    3248 </span>            :                         u32 clone_stsd_idx;
<span class="lineNum">    3249 </span><span class="lineCov">          6 :                         e = gf_isom_clone_sample_description(ctx-&gt;file, tkw-&gt;track_num, ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, NULL, NULL, &amp;clone_stsd_idx);</span>
<span class="lineNum">    3250 </span><span class="lineCov">          6 :                         if (e) {</span>
<span class="lineNum">    3251 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to clone sample description: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    3252 </span><span class="lineNoCov">          0 :                                 return e;</span>
<span class="lineNum">    3253 </span>            :                         }
<span class="lineNum">    3254 </span>            :                         //before
<span class="lineNum">    3255 </span><span class="lineCov">          6 :                         if (cenc_stsd_mode==1) {</span>
<span class="lineNum">    3256 </span><span class="lineCov">          2 :                                 tkw-&gt;clear_stsd_idx = tkw-&gt;stsd_idx;</span>
<span class="lineNum">    3257 </span><span class="lineCov">          2 :                                 tkw-&gt;stsd_idx = clone_stsd_idx;</span>
<span class="lineNum">    3258 </span>            :                         }
<span class="lineNum">    3259 </span>            :                         //after
<span class="lineNum">    3260 </span>            :                         else {
<span class="lineNum">    3261 </span><span class="lineCov">          4 :                                 tkw-&gt;clear_stsd_idx = clone_stsd_idx;</span>
<span class="lineNum">    3262 </span>            :                         }
<span class="lineNum">    3263 </span>            :                 }
<span class="lineNum">    3264 </span>            : 
<span class="lineNum">    3265 </span><span class="lineCov">        208 :                 tkw-&gt;cenc_state = CENC_SETUP_DONE;</span>
<span class="lineNum">    3266 </span><span class="lineCov">        208 :                 tkw-&gt;def_cenc_key_info_crc = tkw-&gt;cenc_key_info_crc;</span>
<span class="lineNum">    3267 </span><span class="lineCov">        208 :                 e = gf_isom_set_cenc_protection(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, scheme_type, scheme_version, pck_is_encrypted, crypt_byte_block, skip_byte_block, tkw-&gt;cenc_ki-&gt;value.data.ptr, tkw-&gt;cenc_ki-&gt;value.data.size);</span>
<span class="lineNum">    3268 </span>            : 
<span class="lineNum">    3269 </span><span class="lineCov">        208 :                 if (e) {</span>
<span class="lineNum">    3270 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to setup CENC information: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    3271 </span><span class="lineNoCov">          0 :                         tkw-&gt;cenc_state = CENC_SETUP_ERROR;</span>
<span class="lineNum">    3272 </span>            :                         return e;
<span class="lineNum">    3273 </span>            :                 }
<span class="lineNum">    3274 </span>            : 
<span class="lineNum">    3275 </span><span class="lineCov">        208 :                 if (ctx-&gt;psshs == MP4MX_PSSH_MOOV)</span>
<span class="lineNum">    3276 </span><span class="lineCov">        208 :                         mp4_mux_cenc_insert_pssh(ctx, tkw);</span>
<span class="lineNum">    3277 </span>            : 
<span class="lineNum">    3278 </span><span class="lineCov">        208 :                 tkw-&gt;def_crypt_byte_block = crypt_byte_block;</span>
<span class="lineNum">    3279 </span><span class="lineCov">        208 :                 tkw-&gt;def_skip_byte_block = skip_byte_block;</span>
<span class="lineNum">    3280 </span>            : 
<span class="lineNum">    3281 </span><span class="lineCov">        208 :                 if (!tkw-&gt;has_brands &amp;&amp; (scheme_type==GF_ISOM_OMADRM_SCHEME))</span>
<span class="lineNum">    3282 </span><span class="lineNoCov">          0 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_OPF2, GF_TRUE);</span>
<span class="lineNum">    3283 </span>            : 
<span class="lineNum">    3284 </span><span class="lineCov">        208 :                 if (container_type) {</span>
<span class="lineNum">    3285 </span><span class="lineCov">        208 :                         if (container_type==GF_ISOM_BOX_UUID_PSEC) {</span>
<span class="lineNum">    3286 </span><span class="lineCov">         12 :                                 e = gf_isom_piff_allocate_storage(ctx-&gt;file, tkw-&gt;track_num, 0, 0, NULL);</span>
<span class="lineNum">    3287 </span>            :                         } else {
<span class="lineNum">    3288 </span><span class="lineCov">        196 :                                 e = gf_isom_cenc_allocate_storage(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    3289 </span>            :                         }
<span class="lineNum">    3290 </span><span class="lineCov">        208 :                         if (e) {</span>
<span class="lineNum">    3291 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to setup CENC storage: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    3292 </span><span class="lineNoCov">          0 :                                 tkw-&gt;cenc_state = CENC_SETUP_ERROR;</span>
<span class="lineNum">    3293 </span>            :                                 return e;
<span class="lineNum">    3294 </span>            :                         }
<span class="lineNum">    3295 </span>            :                 }
<span class="lineNum">    3296 </span>            :         }
<span class="lineNum">    3297 </span><span class="lineCov">      41855 :         if (act_type==CENC_CONFIG) return GF_OK;</span>
<span class="lineNum">    3298 </span>            : 
<span class="lineNum">    3299 </span>            :         pck_is_encrypted = GF_FALSE;
<span class="lineNum">    3300 </span><span class="lineCov">      41647 :         if (pck)</span>
<span class="lineNum">    3301 </span><span class="lineCov">      41647 :                 pck_is_encrypted = gf_filter_pck_get_crypt_flags(pck);</span>
<span class="lineNum">    3302 </span>            : 
<span class="lineNum">    3303 </span>            :         //!! tkw-&gt;nb_samples / tkw-&gt;samples_in_frag not yet incremented !!
<span class="lineNum">    3304 </span><span class="lineCov">      41647 :         if (act_type == CENC_ADD_FRAG) {</span>
<span class="lineNum">    3305 </span><span class="lineCov">      20396 :                 sample_num = tkw-&gt;samples_in_frag + 1;</span>
<span class="lineNum">    3306 </span>            : 
<span class="lineNum">    3307 </span><span class="lineCov">      20396 :                 if (ctx-&gt;cmaf) {</span>
<span class="lineNum">    3308 </span><span class="lineNoCov">          0 :                         if (!tkw-&gt;samples_in_frag) {</span>
<span class="lineNum">    3309 </span><span class="lineNoCov">          0 :                                 tkw-&gt;cenc_frag_protected = pck_is_encrypted;</span>
<span class="lineNum">    3310 </span>            :                         } else {
<span class="lineNum">    3311 </span><span class="lineNoCov">          0 :                                 if (tkw-&gt;cenc_frag_protected != pck_is_encrypted) {</span>
<span class="lineNum">    3312 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] CMAF forbids mixing protected and unprotected samples in a single fragment, please re-encrypt or change target segment duration\n&quot;));</span>
<span class="lineNum">    3313 </span>            :                                         return GF_NON_COMPLIANT_BITSTREAM;
<span class="lineNum">    3314 </span>            :                                 }
<span class="lineNum">    3315 </span>            :                         }
<span class="lineNum">    3316 </span>            :                 }
<span class="lineNum">    3317 </span>            :         } else {
<span class="lineNum">    3318 </span><span class="lineCov">      21251 :                 sample_num = tkw-&gt;nb_samples + 1;</span>
<span class="lineNum">    3319 </span>            :         }
<span class="lineNum">    3320 </span><span class="lineCov">      41647 :         if (!pck_is_encrypted) {</span>
<span class="lineNum">    3321 </span><span class="lineCov">       4983 :                 if (tkw-&gt;clear_stsd_idx) {</span>
<span class="lineNum">    3322 </span><span class="lineCov">        546 :                         if (act_type==CENC_ADD_FRAG) {</span>
<span class="lineNum">    3323 </span><span class="lineCov">        273 :                                 return gf_isom_fragment_set_cenc_sai(ctx-&gt;file, tkw-&gt;track_id, NULL, 0, GF_FALSE, ctx-&gt;saio32, tkw-&gt;cenc_multikey);</span>
<span class="lineNum">    3324 </span>            :                         } else {
<span class="lineNum">    3325 </span><span class="lineCov">        273 :                                 return gf_isom_track_cenc_add_sample_info(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_BOX_TYPE_SENC, NULL, 0, tkw-&gt;cenc_subsamples, ctx-&gt;saio32, tkw-&gt;cenc_multikey);</span>
<span class="lineNum">    3326 </span>            :                         }
<span class="lineNum">    3327 </span>            :                 } else {
<span class="lineNum">    3328 </span>            :                         char dumb_key[20];
<span class="lineNum">    3329 </span>            :                         memset(dumb_key, 0, 20); //dumb key, IV size 0, not protected
<span class="lineNum">    3330 </span><span class="lineCov">       4437 :                         e = gf_isom_set_sample_cenc_group(ctx-&gt;file, tkw-&gt;track_num, sample_num, GF_FALSE, 0, 0, dumb_key, 20);</span>
<span class="lineNum">    3331 </span>            :                         IV_size = 0;
<span class="lineNum">    3332 </span><span class="lineCov">       4437 :                         tkw-&gt;has_seig = GF_TRUE;</span>
<span class="lineNum">    3333 </span>            :                 }
<span class="lineNum">    3334 </span>            :         } else {
<span class="lineNum">    3335 </span>            :         
<span class="lineNum">    3336 </span>            :                 e = GF_OK;
<span class="lineNum">    3337 </span>            :                 //multikey ALWAYS uses seig
<span class="lineNum">    3338 </span><span class="lineCov">      36664 :                 if (tkw-&gt;cenc_ki-&gt;value.data.ptr[0])</span>
<span class="lineNum">    3339 </span>            :                         needs_seig = GF_TRUE;
<span class="lineNum">    3340 </span><span class="lineCov">      34414 :                 else if (tkw-&gt;def_crypt_byte_block != crypt_byte_block)</span>
<span class="lineNum">    3341 </span>            :                         needs_seig = GF_TRUE;
<span class="lineNum">    3342 </span><span class="lineCov">      34414 :                 else if (tkw-&gt;def_skip_byte_block != skip_byte_block)</span>
<span class="lineNum">    3343 </span>            :                         needs_seig = GF_TRUE;
<span class="lineNum">    3344 </span><span class="lineCov">      34414 :                 else if (tkw-&gt;def_cenc_key_info_crc != tkw-&gt;cenc_key_info_crc)</span>
<span class="lineNum">    3345 </span>            :                         needs_seig = GF_TRUE;
<span class="lineNum">    3346 </span>            : 
<span class="lineNum">    3347 </span>            :                 if (needs_seig) {
<span class="lineNum">    3348 </span><span class="lineCov">       4102 :                         e = gf_isom_set_sample_cenc_group(ctx-&gt;file, tkw-&gt;track_num, sample_num, 1, crypt_byte_block, skip_byte_block, tkw-&gt;cenc_ki-&gt;value.data.ptr, tkw-&gt;cenc_ki-&gt;value.data.size);</span>
<span class="lineNum">    3349 </span><span class="lineCov">       4102 :                         tkw-&gt;has_seig = GF_TRUE;</span>
<span class="lineNum">    3350 </span><span class="lineCov">      32562 :                 } else if (tkw-&gt;has_seig) {</span>
<span class="lineNum">    3351 </span><span class="lineCov">        690 :                         e = gf_isom_set_sample_cenc_default_group(ctx-&gt;file, tkw-&gt;track_num, sample_num);</span>
<span class="lineNum">    3352 </span>            :                 }
<span class="lineNum">    3353 </span>            :         }
<span class="lineNum">    3354 </span><span class="lineCov">       9229 :         if (e) {</span>
<span class="lineNum">    3355 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to set sample encryption group entry: %s)\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    3356 </span>            :                 return e;
<span class="lineNum">    3357 </span>            :         }
<span class="lineNum">    3358 </span>            : 
<span class="lineNum">    3359 </span><span class="lineCov">      41101 :         if (!sai) {</span>
<span class="lineNum">    3360 </span><span class="lineCov">       5098 :                 if (tkw-&gt;constant_IV_size &amp;&amp; !tkw-&gt;cenc_subsamples)</span>
<span class="lineNum">    3361 </span>            :                         return GF_OK;
<span class="lineNum">    3362 </span>            : 
<span class="lineNum">    3363 </span>            :                 if (IV_size) {
<span class="lineNum">    3364 </span>            :                         //generate clear SAI data with a non-0 IV
<span class="lineNum">    3365 </span>            :                         u32 olen = pck_size;
<span class="lineNum">    3366 </span>            :                         GF_BitStream *bs = gf_bs_new(NULL, 9, GF_BITSTREAM_WRITE);
<span class="lineNum">    3367 </span>            :                         if (tkw-&gt;cenc_multikey) {
<span class="lineNum">    3368 </span>            :                                 gf_bs_write_u16(bs, 0);
<span class="lineNum">    3369 </span>            :                         } else {
<span class="lineNum">    3370 </span>            :                                 gf_bs_write_long_int(bs, 0, IV_size*8);
<span class="lineNum">    3371 </span>            :                         }
<span class="lineNum">    3372 </span>            : 
<span class="lineNum">    3373 </span>            :                         if (tkw-&gt;cenc_subsamples) {
<span class="lineNum">    3374 </span>            :                                 u32 i;
<span class="lineNum">    3375 </span>            :                                 u32 subsample_count = 1;
<span class="lineNum">    3376 </span>            :                                 while (olen&gt;0xFFFF) {
<span class="lineNum">    3377 </span>            :                                         olen -= 0xFFFF;
<span class="lineNum">    3378 </span>            :                                         subsample_count ++;
<span class="lineNum">    3379 </span>            :                                 }
<span class="lineNum">    3380 </span>            :                                 gf_bs_write_u16(bs, subsample_count);
<span class="lineNum">    3381 </span>            :                                 olen = pck_size;
<span class="lineNum">    3382 </span>            :                                 for (i = 0; i &lt; subsample_count; i++) {
<span class="lineNum">    3383 </span>            :                                         u32 clear_size;
<span class="lineNum">    3384 </span>            :                                         if (olen&lt;0xFFFF) {
<span class="lineNum">    3385 </span>            :                                                 clear_size = olen;
<span class="lineNum">    3386 </span>            :                                         } else {
<span class="lineNum">    3387 </span>            :                                                 clear_size = 0xFFFF;
<span class="lineNum">    3388 </span>            :                                                 olen -= 0xFFFF;
<span class="lineNum">    3389 </span>            :                                         }
<span class="lineNum">    3390 </span>            : 
<span class="lineNum">    3391 </span>            :                                         if (tkw-&gt;cenc_multikey)
<span class="lineNum">    3392 </span>            :                                                 gf_bs_write_u16(bs, 0);
<span class="lineNum">    3393 </span>            :                                         gf_bs_write_u16(bs, clear_size);
<span class="lineNum">    3394 </span>            :                                         gf_bs_write_u32(bs, 0);
<span class="lineNum">    3395 </span>            :                                 }
<span class="lineNum">    3396 </span>            :                         }
<span class="lineNum">    3397 </span>            :                         gf_bs_get_content(bs, &amp;fake_sai, &amp;sai_size);
<span class="lineNum">    3398 </span>            :                         gf_bs_del(bs);
<span class="lineNum">    3399 </span>            :                         sai = fake_sai;
<span class="lineNum">    3400 </span>            :                 }
<span class="lineNum">    3401 </span>            :         }
<span class="lineNum">    3402 </span>            : 
<span class="lineNum">    3403 </span><span class="lineCov">      41101 :         if (act_type==CENC_ADD_FRAG) {</span>
<span class="lineNum">    3404 </span><span class="lineCov">      20123 :                 if (pck_is_encrypted) {</span>
<span class="lineNum">    3405 </span><span class="lineCov">      17990 :                         e = gf_isom_fragment_set_cenc_sai(ctx-&gt;file, tkw-&gt;track_id, sai, sai_size, tkw-&gt;cenc_subsamples, ctx-&gt;saio32, tkw-&gt;cenc_multikey);</span>
<span class="lineNum">    3406 </span>            :                 } else {
<span class="lineNum">    3407 </span><span class="lineCov">       2133 :                         e = gf_isom_fragment_set_cenc_sai(ctx-&gt;file, tkw-&gt;track_id, NULL, 0, GF_FALSE, ctx-&gt;saio32, tkw-&gt;cenc_multikey);</span>
<span class="lineNum">    3408 </span>            :                 }
<span class="lineNum">    3409 </span>            :         } else {
<span class="lineNum">    3410 </span><span class="lineCov">      20978 :                 if (sai) {</span>
<span class="lineNum">    3411 </span><span class="lineCov">      18344 :                         e = gf_isom_track_cenc_add_sample_info(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_BOX_TYPE_SENC, sai, sai_size, tkw-&gt;cenc_subsamples, ctx-&gt;saio32, tkw-&gt;cenc_multikey);</span>
<span class="lineNum">    3412 </span><span class="lineCov">       2634 :                 } else if (!pck_is_encrypted) {</span>
<span class="lineNum">    3413 </span><span class="lineCov">       2304 :                         e = gf_isom_track_cenc_add_sample_info(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_BOX_TYPE_SENC, NULL, 0, tkw-&gt;cenc_subsamples, ctx-&gt;saio32, tkw-&gt;cenc_multikey);</span>
<span class="lineNum">    3414 </span>            :                 }
<span class="lineNum">    3415 </span>            :         }
<span class="lineNum">    3416 </span>            :         if (fake_sai) gf_free(fake_sai);
<span class="lineNum">    3417 </span>            :         return e;
<a name="3418"><span class="lineNum">    3418 </span>            : }</a>
<span class="lineNum">    3419 </span>            : 
<span class="lineNum">    3420 </span><span class="lineNoCov">          0 : GF_FilterSAPType mp4_mux_get_sap(GF_MP4MuxCtx *ctx, GF_FilterPacket *pck)</span>
<span class="lineNum">    3421 </span>            : {
<span class="lineNum">    3422 </span><span class="lineCov">     562170 :         GF_FilterSAPType sap = gf_filter_pck_get_sap(pck);</span>
<span class="lineNum">    3423 </span><span class="lineCov">     562170 :         if (!sap) return sap;</span>
<span class="lineNum">    3424 </span><span class="lineCov">     196556 :         if (ctx-&gt;forcesync) return GF_FILTER_SAP_1;</span>
<span class="lineNum">    3425 </span><span class="lineNoCov">          0 :         return sap;</span>
<a name="3426"><span class="lineNum">    3426 </span>            : }</a>
<span class="lineNum">    3427 </span>            : 
<span class="lineNum">    3428 </span><span class="lineCov">     562238 : static GF_Err mp4_mux_process_sample(GF_MP4MuxCtx *ctx, TrackWriter *tkw, GF_FilterPacket *pck, Bool for_fragment)</span>
<span class="lineNum">    3429 </span>            : {
<span class="lineNum">    3430 </span>            :         GF_Err e=GF_OK;
<span class="lineNum">    3431 </span>            :         u64 cts, prev_dts;
<span class="lineNum">    3432 </span>            :         u32 prev_size=0;
<span class="lineNum">    3433 </span>            :         u32 duration = 0;
<span class="lineNum">    3434 </span>            :         u32 timescale = 0;
<span class="lineNum">    3435 </span>            :         const GF_PropertyValue *subs;
<span class="lineNum">    3436 </span>            :         GF_FilterSAPType sap_type;
<span class="lineNum">    3437 </span>            :         u32 insert_subsample_dsi_size = 0;
<span class="lineNum">    3438 </span>            :         u32 first_nal_is_audelim = GF_FALSE;
<span class="lineNum">    3439 </span><span class="lineCov">     562238 :         u32 sample_desc_index = tkw-&gt;stsd_idx;</span>
<span class="lineNum">    3440 </span>            : 
<span class="lineNum">    3441 </span><span class="lineCov">     562238 :         timescale = gf_filter_pck_get_timescale(pck);</span>
<span class="lineNum">    3442 </span>            : 
<span class="lineNum">    3443 </span><span class="lineCov">     562238 :         prev_dts = tkw-&gt;nb_samples ? tkw-&gt;sample.DTS : GF_FILTER_NO_TS;</span>
<span class="lineNum">    3444 </span><span class="lineCov">     562238 :         prev_size = tkw-&gt;sample.dataLength;</span>
<span class="lineNum">    3445 </span><span class="lineCov">     562238 :         tkw-&gt;sample.CTS_Offset = 0;</span>
<span class="lineNum">    3446 </span><span class="lineCov">     562238 :         tkw-&gt;sample.data = (char *)gf_filter_pck_get_data(pck, &amp;tkw-&gt;sample.dataLength);</span>
<span class="lineNum">    3447 </span>            : 
<span class="lineNum">    3448 </span><span class="lineCov">     562238 :         ctx-&gt;update_report = GF_TRUE;</span>
<span class="lineNum">    3449 </span><span class="lineCov">     562238 :         ctx-&gt;total_bytes_in += tkw-&gt;sample.dataLength;</span>
<span class="lineNum">    3450 </span><span class="lineCov">     562238 :         ctx-&gt;total_samples++;</span>
<span class="lineNum">    3451 </span>            : 
<span class="lineNum">    3452 </span><span class="lineCov">     562238 :         tkw-&gt;sample.DTS = gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">    3453 </span><span class="lineCov">     562238 :         cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    3454 </span>            : 
<span class="lineNum">    3455 </span><span class="lineCov">     562238 :         if (tkw-&gt;sample.DTS == GF_FILTER_NO_TS) {</span>
<span class="lineNum">    3456 </span><span class="lineNoCov">          0 :                 if (cts == GF_FILTER_NO_TS) {</span>
<span class="lineNum">    3457 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Sample with no DTS/CTS, cannot add (last DTS &quot;LLU&quot;, last size %d)\n&quot;, prev_dts, prev_size ));</span>
<span class="lineNum">    3458 </span>            :                         return GF_NON_COMPLIANT_BITSTREAM;
<span class="lineNum">    3459 </span>            :                 } else {
<span class="lineNum">    3460 </span><span class="lineNoCov">          0 :                         u32 min_pck_dur = gf_filter_pid_get_min_pck_duration(tkw-&gt;ipid);</span>
<span class="lineNum">    3461 </span><span class="lineNoCov">          0 :                         if (min_pck_dur) {</span>
<span class="lineNum">    3462 </span><span class="lineNoCov">          0 :                                 tkw-&gt;sample.DTS = prev_dts;</span>
<span class="lineNum">    3463 </span><span class="lineNoCov">          0 :                                 if (timescale != tkw-&gt;tk_timescale) {</span>
<span class="lineNum">    3464 </span><span class="lineNoCov">          0 :                                         tkw-&gt;sample.DTS *= timescale;</span>
<span class="lineNum">    3465 </span><span class="lineNoCov">          0 :                                         tkw-&gt;sample.DTS /= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    3466 </span>            :                                 }
<span class="lineNum">    3467 </span><span class="lineNoCov">          0 :                                 tkw-&gt;sample.DTS += min_pck_dur;</span>
<span class="lineNum">    3468 </span>            :                         } else {
<span class="lineNum">    3469 </span><span class="lineNoCov">          0 :                                 tkw-&gt;sample.DTS = cts;</span>
<span class="lineNum">    3470 </span>            :                         }
<span class="lineNum">    3471 </span>            :                 }
<span class="lineNum">    3472 </span>            :         } else {
<span class="lineNum">    3473 </span><span class="lineCov">     562238 :                 tkw-&gt;sample.CTS_Offset = (s32) ((s64) cts - (s64) tkw-&gt;sample.DTS);</span>
<span class="lineNum">    3474 </span>            :         }
<span class="lineNum">    3475 </span>            : 
<span class="lineNum">    3476 </span>            :         //tkw-&gt;ts_shift is in source timescale, apply it before rescaling TSs/duration
<span class="lineNum">    3477 </span><span class="lineCov">     562238 :         if (tkw-&gt;ts_shift) {</span>
<span class="lineNum">    3478 </span><span class="lineCov">      17980 :                 if (ctx-&gt;is_rewind) {</span>
<span class="lineNum">    3479 </span><span class="lineCov">         30 :                         if (tkw-&gt;sample.DTS &lt;= tkw-&gt;ts_shift) {</span>
<span class="lineNum">    3480 </span><span class="lineCov">         30 :                                 tkw-&gt;sample.DTS = tkw-&gt;ts_shift - tkw-&gt;sample.DTS;</span>
<span class="lineNum">    3481 </span><span class="lineCov">         30 :                                 cts = tkw-&gt;ts_shift - cts;</span>
<span class="lineNum">    3482 </span>            :                         } else {
<span class="lineNum">    3483 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] broken timing in track, initial ts &quot;LLU&quot; less than TS &quot;LLU&quot;\n&quot;, tkw-&gt;ts_shift, tkw-&gt;sample.DTS));</span>
<span class="lineNum">    3484 </span>            :                         }
<span class="lineNum">    3485 </span>            :                 } else {
<span class="lineNum">    3486 </span><span class="lineCov">      17950 :                         if (tkw-&gt;sample.DTS &gt;= tkw-&gt;ts_shift) {</span>
<span class="lineNum">    3487 </span><span class="lineCov">      17950 :                                 tkw-&gt;sample.DTS -= tkw-&gt;ts_shift;</span>
<span class="lineNum">    3488 </span><span class="lineCov">      17950 :                                 cts -= tkw-&gt;ts_shift;</span>
<span class="lineNum">    3489 </span>            :                         } else {
<span class="lineNum">    3490 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] broken timing in track, initial ts &quot;LLU&quot; greater than TS &quot;LLU&quot;\n&quot;, tkw-&gt;ts_shift, tkw-&gt;sample.DTS));</span>
<span class="lineNum">    3491 </span>            :                         }
<span class="lineNum">    3492 </span>            :                 }
<span class="lineNum">    3493 </span>            :         }
<span class="lineNum">    3494 </span>            : 
<span class="lineNum">    3495 </span>            :         //sample-accurate seek info, start logging min CTS of packets marked as non-sync
<span class="lineNum">    3496 </span><span class="lineCov">     562238 :         if (tkw-&gt;check_seek_ts &amp;&amp; !gf_filter_pck_get_seek_flag(pck)) {</span>
<span class="lineNum">    3497 </span>            :                 u64 ts_check = cts;
<span class="lineNum">    3498 </span><span class="lineCov">         20 :                 subs = gf_filter_pck_get_property(pck, GF_PROP_PCK_SKIP_BEGIN);</span>
<span class="lineNum">    3499 </span><span class="lineCov">         20 :                 if (subs)</span>
<span class="lineNum">    3500 </span><span class="lineCov">          8 :                         ts_check += subs-&gt;value.uint;</span>
<span class="lineNum">    3501 </span>            : 
<span class="lineNum">    3502 </span><span class="lineCov">         20 :                 if (!tkw-&gt;min_ts_seek_plus_one) {</span>
<span class="lineNum">    3503 </span><span class="lineCov">          6 :                         tkw-&gt;min_ts_seek_plus_one = ts_check + 1;</span>
<span class="lineNum">    3504 </span><span class="lineCov">         14 :                 } else if (tkw-&gt;min_ts_seek_plus_one &gt; ts_check + 1) {</span>
<span class="lineNum">    3505 </span><span class="lineCov">          4 :                         tkw-&gt;min_ts_seek_plus_one = ts_check + 1;</span>
<span class="lineNum">    3506 </span>            :                 } else {
<span class="lineNum">    3507 </span>            :                         //TS is greater than last non-seek packet TS, we're done seeking
<span class="lineNum">    3508 </span><span class="lineCov">         10 :                         tkw-&gt;check_seek_ts = GF_FALSE;</span>
<span class="lineNum">    3509 </span>            :                 }
<span class="lineNum">    3510 </span>            :         }
<span class="lineNum">    3511 </span>            : 
<span class="lineNum">    3512 </span><span class="lineCov">     562238 :         duration = gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">    3513 </span><span class="lineCov">     562238 :         if (timescale != tkw-&gt;tk_timescale) {</span>
<span class="lineNum">    3514 </span>            :                 s64 ctso;
<span class="lineNum">    3515 </span><span class="lineCov">         92 :                 tkw-&gt;sample.DTS *= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    3516 </span><span class="lineCov">         92 :                 tkw-&gt;sample.DTS /= timescale;</span>
<span class="lineNum">    3517 </span><span class="lineCov">         92 :                 ctso = (s64) tkw-&gt;sample.CTS_Offset;</span>
<span class="lineNum">    3518 </span><span class="lineCov">         92 :                 ctso *= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    3519 </span><span class="lineCov">         92 :                 ctso /= timescale;</span>
<span class="lineNum">    3520 </span><span class="lineCov">         92 :                 tkw-&gt;sample.CTS_Offset = (s32) ctso;</span>
<span class="lineNum">    3521 </span><span class="lineCov">         92 :                 duration *= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    3522 </span><span class="lineCov">         92 :                 duration /= timescale;</span>
<span class="lineNum">    3523 </span>            :         }
<span class="lineNum">    3524 </span>            : 
<span class="lineNum">    3525 </span>            : 
<span class="lineNum">    3526 </span><span class="lineCov">     562238 :         tkw-&gt;sample.IsRAP = 0;</span>
<span class="lineNum">    3527 </span><span class="lineCov">     562238 :         if (tkw-&gt;codecid==GF_CODECID_RAW) {</span>
<span class="lineNum">    3528 </span>            :                 sap_type = GF_FILTER_SAP_1;
<span class="lineNum">    3529 </span>            :         } else {
<span class="lineNum">    3530 </span>            :                 sap_type = mp4_mux_get_sap(ctx, pck);
<span class="lineNum">    3531 </span>            :         }
<span class="lineNum">    3532 </span><span class="lineCov">     562118 :         if (sap_type==GF_FILTER_SAP_1)</span>
<span class="lineNum">    3533 </span><span class="lineCov">     195683 :                 tkw-&gt;sample.IsRAP = SAP_TYPE_1;</span>
<span class="lineNum">    3534 </span><span class="lineCov">     366555 :         else if ( (sap_type == GF_FILTER_SAP_4) &amp;&amp; (tkw-&gt;stream_type != GF_STREAM_VISUAL) )</span>
<span class="lineNum">    3535 </span><span class="lineNoCov">          0 :                 tkw-&gt;sample.IsRAP = SAP_TYPE_1;</span>
<span class="lineNum">    3536 </span>            : 
<span class="lineNum">    3537 </span>            :         /*RFC8216bis is not clear here:
<span class="lineNum">    3538 </span>            :         &quot;if the Partial Segment contains an independent frame.&quot;
<span class="lineNum">    3539 </span>            :                 -&gt; this would allow SAP1,2,3 (independent being only defined for segments)
<span class="lineNum">    3540 </span>            : 
<span class="lineNum">    3541 </span>            :         but
<span class="lineNum">    3542 </span>            : 
<span class="lineNum">    3543 </span>            :         &quot;Partial Segment containing an independent frame SHOULD carry it to increase the efficiency with which clients can join and switch Renditions&quot;
<span class="lineNum">    3544 </span>            :                 -&gt; if used for switching, this only allows SAP 1 and 2
<span class="lineNum">    3545 </span>            : 
<span class="lineNum">    3546 </span>            :         Spec should be fixed to allow for both cases (fast tune-in or in-segment switchingà)
<span class="lineNum">    3547 </span>            :         */
<span class="lineNum">    3548 </span><span class="lineCov">     562238 :         if ((tkw-&gt;sample.IsRAP == SAP_TYPE_1) || (tkw-&gt;sample.IsRAP == SAP_TYPE_2))</span>
<span class="lineNum">    3549 </span><span class="lineCov">     195683 :                 ctx-&gt;frag_has_intra = GF_TRUE;</span>
<span class="lineNum">    3550 </span>            : 
<span class="lineNum">    3551 </span><span class="lineCov">     562238 :         tkw-&gt;sample.DTS += tkw-&gt;dts_patch;</span>
<span class="lineNum">    3552 </span><span class="lineCov">     562238 :         if (tkw-&gt;nb_samples &amp;&amp; (prev_dts &gt;= tkw-&gt;sample.DTS) ) {</span>
<span class="lineNum">    3553 </span>            :                 //the fragmented API will patch the duration on the fly
<span class="lineNum">    3554 </span><span class="lineCov">          7 :                 if (!for_fragment) {</span>
<span class="lineNum">    3555 </span><span class="lineCov">          4 :                         gf_isom_patch_last_sample_duration(ctx-&gt;file, tkw-&gt;track_num, prev_dts ? prev_dts : 1);</span>
<span class="lineNum">    3556 </span>            :                 }
<span class="lineNum">    3557 </span><span class="lineCov">          7 :                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] PID %s ID %d Sample %d with DTS &quot;LLU&quot; less than previous sample DTS &quot;LLU&quot;, adjusting prev sample duration\n&quot;, gf_filter_pid_get_name(tkw-&gt;ipid), tkw-&gt;track_id, tkw-&gt;nb_samples+1, tkw-&gt;sample.DTS, prev_dts ));</span>
<span class="lineNum">    3558 </span>            : 
<span class="lineNum">    3559 </span><span class="lineCov">          7 :                 if (prev_dts) {</span>
<span class="lineNum">    3560 </span><span class="lineCov">          7 :                         tkw-&gt;dts_patch = prev_dts - tkw-&gt;sample.DTS;</span>
<span class="lineNum">    3561 </span><span class="lineCov">          7 :                         tkw-&gt;sample.DTS += tkw-&gt;dts_patch;</span>
<span class="lineNum">    3562 </span>            :                 } else {
<span class="lineNum">    3563 </span><span class="lineNoCov">          0 :                         tkw-&gt;sample.DTS += 1;</span>
<span class="lineNum">    3564 </span><span class="lineNoCov">          0 :                         if (tkw-&gt;sample.CTS_Offset) tkw-&gt;sample.CTS_Offset -= 1;</span>
<span class="lineNum">    3565 </span><span class="lineNoCov">          0 :                         duration-=1;</span>
<span class="lineNum">    3566 </span>            :                 }
<span class="lineNum">    3567 </span>            :         }
<span class="lineNum">    3568 </span>            : 
<span class="lineNum">    3569 </span>            : 
<span class="lineNum">    3570 </span><span class="lineCov">     562238 :         if (tkw-&gt;negctts_shift)</span>
<span class="lineNum">    3571 </span><span class="lineNoCov">          0 :                 tkw-&gt;sample.CTS_Offset -= tkw-&gt;negctts_shift;</span>
<span class="lineNum">    3572 </span>            : 
<span class="lineNum">    3573 </span><span class="lineCov">     562238 :         if (tkw-&gt;probe_min_ctts) {</span>
<span class="lineNum">    3574 </span><span class="lineCov">     334953 :                 s32 diff = (s32) ((s64) cts - (s64) tkw-&gt;sample.DTS);</span>
<span class="lineNum">    3575 </span><span class="lineCov">     334953 :                 if (diff &lt; tkw-&gt;min_neg_ctts)</span>
<span class="lineNum">    3576 </span><span class="lineCov">        246 :                         tkw-&gt;min_neg_ctts = diff;</span>
<span class="lineNum">    3577 </span>            :         }
<span class="lineNum">    3578 </span><span class="lineCov">     562238 :         if (tkw-&gt;sample.CTS_Offset) tkw-&gt;has_ctts = GF_TRUE;</span>
<span class="lineNum">    3579 </span>            : 
<span class="lineNum">    3580 </span><span class="lineCov">     562238 :         if (tkw-&gt;sample.CTS_Offset &lt; tkw-&gt;min_neg_ctts)</span>
<span class="lineNum">    3581 </span><span class="lineNoCov">          0 :                 tkw-&gt;min_neg_ctts = tkw-&gt;sample.CTS_Offset;</span>
<span class="lineNum">    3582 </span>            : 
<span class="lineNum">    3583 </span><span class="lineCov">     562238 :         tkw-&gt;sample.nb_pack = 0;</span>
<span class="lineNum">    3584 </span><span class="lineCov">     562238 :         if (tkw-&gt;raw_audio_bytes_per_sample) {</span>
<span class="lineNum">    3585 </span><span class="lineCov">         90 :                 tkw-&gt;sample.nb_pack = tkw-&gt;sample.dataLength / tkw-&gt;raw_audio_bytes_per_sample;</span>
<span class="lineNum">    3586 </span><span class="lineCov">         90 :                 if (tkw-&gt;sample.nb_pack) {</span>
<span class="lineNum">    3587 </span>            :                         duration = 1;
<span class="lineNum">    3588 </span><span class="lineCov">         90 :                         if (tkw-&gt;raw_samplerate &amp;&amp; (tkw-&gt;tk_timescale != tkw-&gt;raw_samplerate)) {</span>
<span class="lineNum">    3589 </span>            :                                 duration *= tkw-&gt;tk_timescale;
<span class="lineNum">    3590 </span><span class="lineNoCov">          0 :                                 duration /= tkw-&gt;raw_samplerate;</span>
<span class="lineNum">    3591 </span>            :                         }
<span class="lineNum">    3592 </span>            :                 }
<span class="lineNum">    3593 </span>            :         }
<span class="lineNum">    3594 </span>            : 
<span class="lineNum">    3595 </span><span class="lineCov">     562238 :         if (tkw-&gt;cenc_state &amp;&amp; tkw-&gt;clear_stsd_idx &amp;&amp; !gf_filter_pck_get_crypt_flags(pck)) {</span>
<span class="lineNum">    3596 </span><span class="lineCov">        546 :                 sample_desc_index = tkw-&gt;clear_stsd_idx;</span>
<span class="lineNum">    3597 </span>            :         }
<span class="lineNum">    3598 </span>            : 
<span class="lineNum">    3599 </span><span class="lineCov">     562238 :         if (tkw-&gt;use_dref) {</span>
<span class="lineNum">    3600 </span><span class="lineNoCov">          0 :                 u64 data_offset = gf_filter_pck_get_byte_offset(pck);</span>
<span class="lineNum">    3601 </span><span class="lineNoCov">          0 :                 if (data_offset != GF_FILTER_NO_BO) {</span>
<span class="lineNum">    3602 </span><span class="lineNoCov">          0 :                         e = gf_isom_add_sample_reference(ctx-&gt;file, tkw-&gt;track_num, sample_desc_index, &amp;tkw-&gt;sample, data_offset);</span>
<span class="lineNum">    3603 </span><span class="lineNoCov">          0 :                         if (e) {</span>
<span class="lineNum">    3604 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to add sample DTS &quot;LLU&quot; as reference: %s\n&quot;, tkw-&gt;sample.DTS, gf_error_to_string(e) ));</span>
<span class="lineNum">    3605 </span>            :                         }
<span class="lineNum">    3606 </span>            :                 } else {
<span class="lineNum">    3607 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Cannot add sample reference at DTS &quot;LLU&quot; , input sample data is not continous in source\n&quot;, tkw-&gt;sample.DTS ));</span>
<span class="lineNum">    3608 </span>            :                 }
<span class="lineNum">    3609 </span><span class="lineCov">     562238 :         } else if (tkw-&gt;nb_frames_per_sample &amp;&amp; (tkw-&gt;nb_samples % tkw-&gt;nb_frames_per_sample)) {</span>
<span class="lineNum">    3610 </span><span class="lineNoCov">          0 :                 if (for_fragment) {</span>
<span class="lineNum">    3611 </span><span class="lineNoCov">          0 :                         e = gf_isom_fragment_append_data(ctx-&gt;file, tkw-&gt;track_id, tkw-&gt;sample.data, tkw-&gt;sample.dataLength, 0);</span>
<span class="lineNum">    3612 </span>            :                 } else {
<span class="lineNum">    3613 </span><span class="lineNoCov">          0 :                         e = gf_isom_append_sample_data(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;sample.data, tkw-&gt;sample.dataLength);</span>
<span class="lineNum">    3614 </span>            :                 }
<span class="lineNum">    3615 </span><span class="lineNoCov">          0 :                 tkw-&gt;has_append = GF_TRUE;</span>
<span class="lineNum">    3616 </span><span class="lineNoCov">          0 :                 if (e) {</span>
<span class="lineNum">    3617 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to append sample DTS &quot;LLU&quot; data: %s\n&quot;, tkw-&gt;sample.DTS, gf_error_to_string(e) ));</span>
<span class="lineNum">    3618 </span>            :                 }
<span class="lineNum">    3619 </span>            :         } else {
<span class="lineNum">    3620 </span><span class="lineCov">     562238 :                 if ((tkw-&gt;sample.IsRAP || tkw-&gt;force_inband_inject || ctx-&gt;pps_inband) &amp;&amp; ctx-&gt;xps_inband) {</span>
<span class="lineNum">    3621 </span>            :                         u8 *inband_xps;
<span class="lineNum">    3622 </span>            :                         u32 inband_xps_size;
<span class="lineNum">    3623 </span>            :                         char *au_delim=NULL;
<span class="lineNum">    3624 </span>            :                         u32 au_delim_size=0;
<span class="lineNum">    3625 </span><span class="lineCov">        202 :                         char *pck_data = tkw-&gt;sample.data;</span>
<span class="lineNum">    3626 </span><span class="lineCov">        202 :                         u32 pck_data_len = tkw-&gt;sample.dataLength;</span>
<span class="lineNum">    3627 </span><span class="lineCov">        202 :                         if (tkw-&gt;sample.IsRAP || tkw-&gt;force_inband_inject) {</span>
<span class="lineNum">    3628 </span><span class="lineCov">        202 :                                 inband_xps = tkw-&gt;inband_hdr;</span>
<span class="lineNum">    3629 </span><span class="lineCov">        202 :                                 inband_xps_size = tkw-&gt;inband_hdr_size;</span>
<span class="lineNum">    3630 </span><span class="lineCov">        202 :                                 tkw-&gt;force_inband_inject = GF_FALSE;</span>
<span class="lineNum">    3631 </span>            :                         } else {
<span class="lineNum">    3632 </span><span class="lineNoCov">          0 :                                 inband_xps = tkw-&gt;inband_hdr_non_rap;</span>
<span class="lineNum">    3633 </span><span class="lineNoCov">          0 :                                 inband_xps_size = tkw-&gt;inband_hdr_non_rap_size;</span>
<span class="lineNum">    3634 </span>            :                         }
<span class="lineNum">    3635 </span><span class="lineCov">        202 :                         tkw-&gt;sample.data = inband_xps;</span>
<span class="lineNum">    3636 </span><span class="lineCov">        202 :                         tkw-&gt;sample.dataLength = inband_xps_size;</span>
<span class="lineNum">    3637 </span>            : 
<span class="lineNum">    3638 </span><span class="lineCov">        202 :                         if (tkw-&gt;is_nalu==NALU_AVC) {</span>
<span class="lineNum">    3639 </span><span class="lineCov">         30 :                                 char *nal = pck_data + tkw-&gt;nal_unit_size;</span>
<span class="lineNum">    3640 </span><span class="lineCov">         30 :                                 if ((nal[0] &amp; 0x1F) == GF_AVC_NALU_ACCESS_UNIT) {</span>
<span class="lineNum">    3641 </span><span class="lineCov">          2 :                                         first_nal_is_audelim = au_delim_size = 2 + tkw-&gt;nal_unit_size;</span>
<span class="lineNum">    3642 </span>            :                                         au_delim = pck_data;
<span class="lineNum">    3643 </span>            :                                 }
<span class="lineNum">    3644 </span>            :                         } else {
<span class="lineNum">    3645 </span><span class="lineCov">        172 :                                 char *nal = pck_data + tkw-&gt;nal_unit_size;</span>
<span class="lineNum">    3646 </span><span class="lineCov">        172 :                                 if (((nal[0] &amp; 0x7E)&gt;&gt;1) == GF_HEVC_NALU_ACCESS_UNIT) {</span>
<span class="lineNum">    3647 </span><span class="lineCov">         11 :                                         first_nal_is_audelim = au_delim_size = 3 + tkw-&gt;nal_unit_size;</span>
<span class="lineNum">    3648 </span>            :                                         au_delim = pck_data;
<span class="lineNum">    3649 </span>            :                                 }
<span class="lineNum">    3650 </span>            :                         }
<span class="lineNum">    3651 </span>            : 
<span class="lineNum">    3652 </span><span class="lineCov">        202 :                         if (au_delim) {</span>
<span class="lineNum">    3653 </span><span class="lineCov">         13 :                                 tkw-&gt;sample.data = au_delim;</span>
<span class="lineNum">    3654 </span><span class="lineCov">         13 :                                 tkw-&gt;sample.dataLength = au_delim_size;</span>
<span class="lineNum">    3655 </span><span class="lineCov">         13 :                                 pck_data += au_delim_size;</span>
<span class="lineNum">    3656 </span><span class="lineCov">         13 :                                 pck_data_len -= au_delim_size;</span>
<span class="lineNum">    3657 </span>            :                         }
<span class="lineNum">    3658 </span>            : 
<span class="lineNum">    3659 </span><span class="lineCov">        202 :                         if (for_fragment) {</span>
<span class="lineNum">    3660 </span><span class="lineCov">         16 :                                 e = gf_isom_fragment_add_sample(ctx-&gt;file, tkw-&gt;track_id, &amp;tkw-&gt;sample, sample_desc_index, duration, 0, 0, 0);</span>
<span class="lineNum">    3661 </span><span class="lineCov">         16 :                                 if (!e &amp;&amp; au_delim) {</span>
<span class="lineNum">    3662 </span><span class="lineNoCov">          0 :                                         e = gf_isom_fragment_append_data(ctx-&gt;file, tkw-&gt;track_id, inband_xps, inband_xps_size, 0);</span>
<span class="lineNum">    3663 </span>            :                                 }
<span class="lineNum">    3664 </span><span class="lineCov">         16 :                                 if (!e) e = gf_isom_fragment_append_data(ctx-&gt;file, tkw-&gt;track_id, pck_data, pck_data_len, 0);</span>
<span class="lineNum">    3665 </span>            :                         } else {
<span class="lineNum">    3666 </span><span class="lineCov">        186 :                                 e = gf_isom_add_sample(ctx-&gt;file, tkw-&gt;track_num, sample_desc_index, &amp;tkw-&gt;sample);</span>
<span class="lineNum">    3667 </span><span class="lineCov">        186 :                                 if (au_delim &amp;&amp; !e) {</span>
<span class="lineNum">    3668 </span><span class="lineCov">         13 :                                         e = gf_isom_append_sample_data(ctx-&gt;file, tkw-&gt;track_num, inband_xps, inband_xps_size);</span>
<span class="lineNum">    3669 </span>            :                                 }
<span class="lineNum">    3670 </span><span class="lineCov">        186 :                                 if (!e) e = gf_isom_append_sample_data(ctx-&gt;file, tkw-&gt;track_num, pck_data, pck_data_len);</span>
<span class="lineNum">    3671 </span>            :                         }
<span class="lineNum">    3672 </span>            :                         insert_subsample_dsi_size = inband_xps_size;
<span class="lineNum">    3673 </span><span class="lineCov">     562036 :                 } else if (for_fragment) {</span>
<span class="lineNum">    3674 </span><span class="lineCov">     111898 :                         e = gf_isom_fragment_add_sample(ctx-&gt;file, tkw-&gt;track_id, &amp;tkw-&gt;sample, sample_desc_index, duration, 0, 0, 0);</span>
<span class="lineNum">    3675 </span>            :                 } else {
<span class="lineNum">    3676 </span><span class="lineCov">     450138 :                         e = gf_isom_add_sample(ctx-&gt;file, tkw-&gt;track_num, sample_desc_index, &amp;tkw-&gt;sample);</span>
<span class="lineNum">    3677 </span><span class="lineCov">     450138 :                         if (!e &amp;&amp; !duration) {</span>
<span class="lineNum">    3678 </span><span class="lineCov">        190 :                                 gf_isom_set_last_sample_duration(ctx-&gt;file, tkw-&gt;track_num, 0);</span>
<span class="lineNum">    3679 </span>            :                         }
<span class="lineNum">    3680 </span>            :                 }
<span class="lineNum">    3681 </span>            : 
<span class="lineNum">    3682 </span><span class="lineCov">     562238 :                 if (e) {</span>
<span class="lineNum">    3683 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to add sample DTS &quot;LLU&quot; - prev DTS &quot;LLU&quot;: %s\n&quot;, tkw-&gt;sample.DTS, prev_dts, gf_error_to_string(e) ));</span>
<span class="lineNum">    3684 </span>            :                 } else {
<span class="lineNum">    3685 </span><span class="lineCov">     562238 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_CONTAINER, (&quot;[MP4Mux] added sample DTS &quot;LLU&quot; - prev DTS &quot;LLU&quot; - prev size %d\n&quot;, tkw-&gt;sample.DTS, prev_dts, prev_size));</span>
<span class="lineNum">    3686 </span>            :                 }
<span class="lineNum">    3687 </span>            : 
<span class="lineNum">    3688 </span><span class="lineCov">     562238 :                 if (!e &amp;&amp; tkw-&gt;cenc_state) {</span>
<span class="lineNum">    3689 </span><span class="lineCov">      41647 :                         e = mp4_mux_cenc_update(ctx, tkw, pck, for_fragment ? CENC_ADD_FRAG : CENC_ADD_NORMAL, tkw-&gt;sample.dataLength);</span>
<span class="lineNum">    3690 </span><span class="lineCov">      41647 :                         if (e) {</span>
<span class="lineNum">    3691 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to set sample CENC information: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    3692 </span>            :                                 return e;
<span class="lineNum">    3693 </span>            :                         }
<span class="lineNum">    3694 </span>            :                 }
<span class="lineNum">    3695 </span>            :         }
<span class="lineNum">    3696 </span>            : 
<span class="lineNum">    3697 </span><span class="lineCov">     562238 :         tkw-&gt;nb_samples++;</span>
<span class="lineNum">    3698 </span><span class="lineCov">     562238 :         tkw-&gt;samples_in_stsd++;</span>
<span class="lineNum">    3699 </span><span class="lineCov">     562238 :         tkw-&gt;samples_in_frag++;</span>
<span class="lineNum">    3700 </span>            : 
<span class="lineNum">    3701 </span><span class="lineCov">     562238 :         if (e) return e;</span>
<span class="lineNum">    3702 </span>            : 
<span class="lineNum">    3703 </span><span class="lineCov">     562238 :         if (!for_fragment) {</span>
<span class="lineNum">    3704 </span>            :                 u64 samp_cts;
<span class="lineNum">    3705 </span><span class="lineCov">     450324 :                 if (!tkw-&gt;clamp_ts_plus_one) {</span>
<span class="lineNum">    3706 </span><span class="lineCov">     450324 :                         const GF_PropertyValue *skp = gf_filter_pck_get_property(pck, GF_PROP_PCK_SKIP_PRES);</span>
<span class="lineNum">    3707 </span><span class="lineCov">     450324 :                         if (skp &amp;&amp; skp-&gt;value.boolean) {</span>
<span class="lineNum">    3708 </span><span class="lineCov">          1 :                                 tkw-&gt;clamp_ts_plus_one = 1 + tkw-&gt;sample.DTS + tkw-&gt;sample.CTS_Offset;</span>
<span class="lineNum">    3709 </span>            :                         }
<span class="lineNum">    3710 </span>            :                 }
<span class="lineNum">    3711 </span>            :                 //store min max cts for edit list updates
<span class="lineNum">    3712 </span><span class="lineCov">     450324 :                 samp_cts = tkw-&gt;sample.DTS + tkw-&gt;sample.CTS_Offset;</span>
<span class="lineNum">    3713 </span><span class="lineCov">     450324 :                 if (!tkw-&gt;clamp_ts_plus_one || (samp_cts + 1 &lt; tkw-&gt;clamp_ts_plus_one)) {</span>
<span class="lineNum">    3714 </span><span class="lineCov">     450323 :                         if (samp_cts &gt; tkw-&gt;max_cts) {</span>
<span class="lineNum">    3715 </span><span class="lineCov">     355637 :                                 tkw-&gt;max_cts = samp_cts;</span>
<span class="lineNum">    3716 </span><span class="lineCov">     355637 :                                 tkw-&gt;max_cts_samp_dur = duration;</span>
<span class="lineNum">    3717 </span>            :                         }
<span class="lineNum">    3718 </span>            : 
<span class="lineNum">    3719 </span><span class="lineCov">     450323 :                         if (tkw-&gt;min_cts &gt; samp_cts)</span>
<span class="lineNum">    3720 </span><span class="lineCov">       1056 :                                 tkw-&gt;min_cts = samp_cts;</span>
<span class="lineNum">    3721 </span>            :                 }
<span class="lineNum">    3722 </span>            :         }
<span class="lineNum">    3723 </span>            : 
<span class="lineNum">    3724 </span>            :         //compat with old arch: write sample to group info for all samples
<span class="lineNum">    3725 </span><span class="lineCov">     562238 :         if ((sap_type==3) || tkw-&gt;has_open_gop)  {</span>
<span class="lineNum">    3726 </span><span class="lineCov">      22565 :                 if (for_fragment) {</span>
<span class="lineNum">    3727 </span><span class="lineCov">       8111 :                         e = gf_isom_fragment_set_sample_rap_group(ctx-&gt;file, tkw-&gt;track_id, tkw-&gt;samples_in_frag, (sap_type==3) ? GF_TRUE : GF_FALSE, 0);</span>
<span class="lineNum">    3728 </span><span class="lineCov">      14454 :                 } else if (sap_type==3) {</span>
<span class="lineNum">    3729 </span><span class="lineCov">        479 :                         e = gf_isom_set_sample_rap_group(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;nb_samples, GF_TRUE /*(sap_type==3) ? GF_TRUE : GF_FALSE*/, 0);</span>
<span class="lineNum">    3730 </span>            :                 }
<span class="lineNum">    3731 </span><span class="lineCov">      22565 :                 if (e) {</span>
<span class="lineNum">    3732 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to set sample DTS &quot;LLU&quot; SAP 3 in RAP group: %s\n&quot;, tkw-&gt;sample.DTS, gf_error_to_string(e) ));</span>
<span class="lineNum">    3733 </span>            :                 }
<span class="lineNum">    3734 </span><span class="lineCov">      22565 :                 tkw-&gt;has_open_gop = GF_TRUE;</span>
<span class="lineNum">    3735 </span>            :         }
<span class="lineNum">    3736 </span><span class="lineCov">     562238 :         if (!ctx-&gt;noroll) {</span>
<span class="lineNum">    3737 </span><span class="lineCov">     562238 :                 if ((sap_type==GF_FILTER_SAP_4) || (sap_type==GF_FILTER_SAP_4_PROL) || tkw-&gt;gdr_type) {</span>
<span class="lineNum">    3738 </span>            :                         GF_ISOSampleRollType roll_type = 0;
<span class="lineNum">    3739 </span><span class="lineCov">       1484 :                         s16 roll = gf_filter_pck_get_roll_info(pck);</span>
<span class="lineNum">    3740 </span><span class="lineCov">       1484 :                         if (sap_type==GF_FILTER_SAP_4) roll_type = GF_ISOM_SAMPLE_ROLL;</span>
<span class="lineNum">    3741 </span><span class="lineCov">       1298 :                         else if (sap_type==GF_FILTER_SAP_4_PROL) roll_type = GF_ISOM_SAMPLE_PREROLL;</span>
<span class="lineNum">    3742 </span><span class="lineCov">       1298 :                         else if (tkw-&gt;gdr_type==GF_FILTER_SAP_4_PROL) {</span>
<span class="lineNum">    3743 </span>            :                                 roll_type = GF_ISOM_SAMPLE_PREROLL_NONE;
<span class="lineNum">    3744 </span>            :                         }
<span class="lineNum">    3745 </span>            : 
<span class="lineNum">    3746 </span><span class="lineCov">       1484 :                         if (for_fragment) {</span>
<span class="lineNum">    3747 </span><span class="lineCov">        742 :                                 e = gf_isom_fragment_set_sample_roll_group(ctx-&gt;file, tkw-&gt;track_id, tkw-&gt;samples_in_frag, roll_type, roll);</span>
<span class="lineNum">    3748 </span>            :                         } else {
<span class="lineNum">    3749 </span><span class="lineCov">        742 :                                 e = gf_isom_set_sample_roll_group(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;nb_samples, roll_type, roll);</span>
<span class="lineNum">    3750 </span>            :                         }
<span class="lineNum">    3751 </span><span class="lineCov">       1484 :                         if (e) {</span>
<span class="lineNum">    3752 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Failed to set sample DTS &quot;LLU&quot; SAP 4 roll %s in roll group: %s\n&quot;, tkw-&gt;sample.DTS, roll, gf_error_to_string(e) ));</span>
<span class="lineNum">    3753 </span>            :                         }
<span class="lineNum">    3754 </span><span class="lineCov">       1484 :                         if (sap_type &amp;&amp; !tkw-&gt;gdr_type)</span>
<span class="lineNum">    3755 </span><span class="lineCov">          2 :                                 tkw-&gt;gdr_type = sap_type;</span>
<span class="lineNum">    3756 </span>            :                 }
<span class="lineNum">    3757 </span>            :         }
<span class="lineNum">    3758 </span>            :         
<span class="lineNum">    3759 </span><span class="lineCov">     562238 :         subs = gf_filter_pck_get_property(pck, GF_PROP_PCK_SUBS);</span>
<span class="lineNum">    3760 </span><span class="lineCov">     562238 :         if (subs) {</span>
<span class="lineNum">    3761 </span>            :                 //if no AUDelim nal and inband header injection, push new subsample
<span class="lineNum">    3762 </span><span class="lineCov">       1532 :                 if (!first_nal_is_audelim &amp;&amp; insert_subsample_dsi_size) {</span>
<span class="lineNum">    3763 </span><span class="lineNoCov">          0 :                         if (for_fragment) {</span>
<span class="lineNum">    3764 </span><span class="lineNoCov">          0 :                                 gf_isom_fragment_add_subsample(ctx-&gt;file, tkw-&gt;track_id, 0, insert_subsample_dsi_size, 0, 0, 0);</span>
<span class="lineNum">    3765 </span>            :                         } else {
<span class="lineNum">    3766 </span><span class="lineNoCov">          0 :                                 gf_isom_add_subsample(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;nb_samples, 0, insert_subsample_dsi_size, 0, 0, 0);</span>
<span class="lineNum">    3767 </span>            :                         }
<span class="lineNum">    3768 </span>            :                         insert_subsample_dsi_size = 0;
<span class="lineNum">    3769 </span>            :                 }
<span class="lineNum">    3770 </span><span class="lineCov">       1532 :                 tkw-&gt;has_subs = GF_TRUE;</span>
<span class="lineNum">    3771 </span>            : 
<span class="lineNum">    3772 </span><span class="lineCov">       1532 :                 if (!ctx-&gt;bs_r) ctx-&gt;bs_r = gf_bs_new(subs-&gt;value.data.ptr, subs-&gt;value.data.size, GF_BITSTREAM_READ);</span>
<span class="lineNum">    3773 </span><span class="lineCov">       1527 :                 else gf_bs_reassign_buffer(ctx-&gt;bs_r, subs-&gt;value.data.ptr, subs-&gt;value.data.size);</span>
<span class="lineNum">    3774 </span>            : 
<span class="lineNum">    3775 </span><span class="lineCov">       4598 :                 while (gf_bs_available(ctx-&gt;bs_r)) {</span>
<span class="lineNum">    3776 </span><span class="lineCov">       3066 :                         u32 flags = gf_bs_read_u32(ctx-&gt;bs_r);</span>
<span class="lineNum">    3777 </span><span class="lineCov">       3066 :                         u32 subs_size = gf_bs_read_u32(ctx-&gt;bs_r);</span>
<span class="lineNum">    3778 </span><span class="lineCov">       3066 :                         u32 reserved = gf_bs_read_u32(ctx-&gt;bs_r);</span>
<span class="lineNum">    3779 </span><span class="lineCov">       3066 :                         u8 priority = gf_bs_read_u8(ctx-&gt;bs_r);</span>
<span class="lineNum">    3780 </span><span class="lineCov">       3066 :                         u8 discardable = gf_bs_read_u8(ctx-&gt;bs_r);</span>
<span class="lineNum">    3781 </span>            : 
<span class="lineNum">    3782 </span><span class="lineCov">       3066 :                         if (for_fragment) {</span>
<span class="lineNum">    3783 </span><span class="lineCov">       1523 :                                 gf_isom_fragment_add_subsample(ctx-&gt;file, tkw-&gt;track_id, flags, subs_size, priority, reserved, discardable);</span>
<span class="lineNum">    3784 </span>            :                         } else {
<span class="lineNum">    3785 </span><span class="lineCov">       1543 :                                 gf_isom_add_subsample(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;nb_samples, flags, subs_size, priority, reserved, discardable);</span>
<span class="lineNum">    3786 </span>            :                         }
<span class="lineNum">    3787 </span>            : 
<span class="lineNum">    3788 </span>            :                         //we have AUDelim nal and inband header injection, push new subsample for inband header once we have pushed the first subsample (au delim)
<span class="lineNum">    3789 </span><span class="lineCov">       3066 :                         if (insert_subsample_dsi_size) {</span>
<span class="lineNum">    3790 </span><span class="lineNoCov">          0 :                                 if (first_nal_is_audelim != subs_size) {</span>
<span class="lineNum">    3791 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] inserting inband param after AU delimiter NALU, but sample has subsample information not aligned on NALU (got %d subsample size but expecting %d) - file might be broken!\n&quot;, subs_size, first_nal_is_audelim));</span>
<span class="lineNum">    3792 </span>            :                                 }
<span class="lineNum">    3793 </span><span class="lineNoCov">          0 :                                 if (for_fragment) {</span>
<span class="lineNum">    3794 </span><span class="lineNoCov">          0 :                                         gf_isom_fragment_add_subsample(ctx-&gt;file, tkw-&gt;track_id, 0, insert_subsample_dsi_size, 0, 0, 0);</span>
<span class="lineNum">    3795 </span>            :                                 } else {
<span class="lineNum">    3796 </span><span class="lineNoCov">          0 :                                         gf_isom_add_subsample(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;nb_samples, 0, insert_subsample_dsi_size, 0, 0, 0);</span>
<span class="lineNum">    3797 </span>            :                                 }
<span class="lineNum">    3798 </span>            :                                 insert_subsample_dsi_size = GF_FALSE;
<span class="lineNum">    3799 </span>            :                         }
<span class="lineNum">    3800 </span>            :                 }
<span class="lineNum">    3801 </span><span class="lineCov">     560706 :         } else if (for_fragment &amp;&amp; tkw-&gt;has_subs &amp;&amp; ctx-&gt;cmaf &amp;&amp; (tkw-&gt;codecid==GF_CODECID_SUBS_XML)) {</span>
<span class="lineNum">    3802 </span>            :                 //tentative implemntation of CMAF 7.5.20 which is just nonsense text !!:
<span class="lineNum">    3803 </span>            :                 //&quot;the value of subsample_count shall equal 1 for the first image sub-sample, and the subsample_count of the TTML document shall equal 0.&quot;
<span class="lineNum">    3804 </span>            :                 //
<span class="lineNum">    3805 </span>            :                 //we simply signal a single subsample
<span class="lineNum">    3806 </span><span class="lineNoCov">          0 :                 gf_isom_fragment_add_subsample(ctx-&gt;file, tkw-&gt;track_id, 0, tkw-&gt;sample.dataLength, 0, 0, 0);</span>
<span class="lineNum">    3807 </span>            :         }
<span class="lineNum">    3808 </span>            : 
<span class="lineNum">    3809 </span><span class="lineCov">     562238 :         if (ctx-&gt;deps) {</span>
<span class="lineNum">    3810 </span><span class="lineCov">     562238 :                 u8 dep_flags = gf_filter_pck_get_dependency_flags(pck);</span>
<span class="lineNum">    3811 </span><span class="lineCov">     562238 :                 if (dep_flags) {</span>
<span class="lineNum">    3812 </span><span class="lineCov">       4921 :                         u32 is_leading = (dep_flags&gt;&gt;6) &amp; 0x3;</span>
<span class="lineNum">    3813 </span><span class="lineCov">       4921 :                         u32 depends_on = (dep_flags&gt;&gt;4) &amp; 0x3;</span>
<span class="lineNum">    3814 </span><span class="lineCov">       4921 :                         u32 depended_on = (dep_flags&gt;&gt;2) &amp; 0x3;</span>
<span class="lineNum">    3815 </span><span class="lineCov">       4921 :                         u32 redundant = (dep_flags) &amp; 0x3;</span>
<span class="lineNum">    3816 </span><span class="lineCov">       4921 :                         if (for_fragment) {</span>
<span class="lineNum">    3817 </span><span class="lineCov">       1575 :                                 gf_isom_fragment_set_sample_flags(ctx-&gt;file, tkw-&gt;track_id, is_leading, depends_on, depended_on, redundant);</span>
<span class="lineNum">    3818 </span>            :                         } else {
<span class="lineNum">    3819 </span><span class="lineCov">       3346 :                                 gf_isom_set_sample_flags(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;nb_samples, is_leading, depends_on, depended_on, redundant);</span>
<span class="lineNum">    3820 </span>            :                         }
<span class="lineNum">    3821 </span>            :                 }
<span class="lineNum">    3822 </span>            :         }
<span class="lineNum">    3823 </span>            : 
<span class="lineNum">    3824 </span>            : 
<span class="lineNum">    3825 </span><span class="lineCov">     562238 :         tkw-&gt;next_is_first_sample = GF_FALSE;</span>
<span class="lineNum">    3826 </span>            : 
<span class="lineNum">    3827 </span><span class="lineCov">     562238 :         if (duration &amp;&amp; !for_fragment &amp;&amp; !tkw-&gt;raw_audio_bytes_per_sample)</span>
<span class="lineNum">    3828 </span><span class="lineCov">     450044 :                 gf_isom_set_last_sample_duration(ctx-&gt;file, tkw-&gt;track_num, duration);</span>
<span class="lineNum">    3829 </span>            : 
<span class="lineNum">    3830 </span><span class="lineCov">     562238 :         if (ctx-&gt;idur.num) {</span>
<span class="lineNum">    3831 </span>            :                 Bool abort = GF_FALSE;
<span class="lineNum">    3832 </span><span class="lineCov">       8983 :                 if (ctx-&gt;idur.num&gt;0) {</span>
<span class="lineNum">    3833 </span><span class="lineCov">       8982 :                         u64 mdur = gf_isom_get_media_duration(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    3834 </span>            : 
<span class="lineNum">    3835 </span>            :                         /*patch to align to old arch */
<span class="lineNum">    3836 </span><span class="lineCov">       8982 :                         if (gf_sys_old_arch_compat() &amp;&amp; (tkw-&gt;stream_type==GF_STREAM_VISUAL)) {</span>
<span class="lineNum">    3837 </span><span class="lineCov">       3862 :                                 mdur = tkw-&gt;sample.DTS;</span>
<span class="lineNum">    3838 </span>            :                         }
<span class="lineNum">    3839 </span>            : 
<span class="lineNum">    3840 </span><span class="lineCov">       8982 :                         if (ctx-&gt;importer) {</span>
<span class="lineNum">    3841 </span><span class="lineCov">       8982 :                                 tkw-&gt;prog_done = mdur * ctx-&gt;idur.den;</span>
<span class="lineNum">    3842 </span><span class="lineCov">       8982 :                                 tkw-&gt;prog_total =  ((u64)tkw-&gt;tk_timescale) * ctx-&gt;idur.num;</span>
<span class="lineNum">    3843 </span>            :                         }
<span class="lineNum">    3844 </span>            : 
<span class="lineNum">    3845 </span>            :                         /*patch to align to old arch */
<span class="lineNum">    3846 </span><span class="lineCov">       8982 :                         if (gf_sys_old_arch_compat()) {</span>
<span class="lineNum">    3847 </span><span class="lineCov">       8982 :                                 if (mdur * (u64) ctx-&gt;idur.den &gt; tkw-&gt;tk_timescale * (u64) ctx-&gt;idur.num)</span>
<span class="lineNum">    3848 </span>            :                                         abort = GF_TRUE;
<span class="lineNum">    3849 </span>            :                         } else {
<span class="lineNum">    3850 </span><span class="lineNoCov">          0 :                                 if (mdur * (u64) ctx-&gt;idur.den &gt;= tkw-&gt;tk_timescale * (u64) ctx-&gt;idur.num)</span>
<span class="lineNum">    3851 </span>            :                                         abort = GF_TRUE;
<span class="lineNum">    3852 </span>            :                         }
<span class="lineNum">    3853 </span>            :                 } else {
<span class="lineNum">    3854 </span><span class="lineCov">          1 :                         if ((s32) tkw-&gt;nb_samples &gt;= -ctx-&gt;idur.num)</span>
<span class="lineNum">    3855 </span>            :                                 abort = GF_TRUE;
<span class="lineNum">    3856 </span>            :                 }
<span class="lineNum">    3857 </span>            : 
<span class="lineNum">    3858 </span>            :                 if (abort) {
<span class="lineNum">    3859 </span>            :                         GF_FilterEvent evt;
<span class="lineNum">    3860 </span><span class="lineCov">         82 :                         GF_FEVT_INIT(evt, GF_FEVT_STOP, tkw-&gt;ipid);</span>
<span class="lineNum">    3861 </span><span class="lineCov">         82 :                         gf_filter_pid_send_event(tkw-&gt;ipid, &amp;evt);</span>
<span class="lineNum">    3862 </span>            : 
<span class="lineNum">    3863 </span><span class="lineCov">         82 :                         tkw-&gt;aborted = GF_TRUE;</span>
<span class="lineNum">    3864 </span>            :                 }
<span class="lineNum">    3865 </span><span class="lineCov">     553255 :         } else if (ctx-&gt;importer) {</span>
<span class="lineNum">    3866 </span><span class="lineCov">     346937 :                 if (tkw-&gt;nb_frames) {</span>
<span class="lineNum">    3867 </span><span class="lineCov">         47 :                         tkw-&gt;prog_done = tkw-&gt;nb_samples;</span>
<span class="lineNum">    3868 </span><span class="lineCov">         47 :                         tkw-&gt;prog_total = tkw-&gt;nb_frames;</span>
<span class="lineNum">    3869 </span>            :                 } else {
<span class="lineNum">    3870 </span><span class="lineCov">     346890 :                         u64 data_offset = gf_filter_pck_get_byte_offset(pck);</span>
<span class="lineNum">    3871 </span><span class="lineCov">     346890 :                         if (data_offset == GF_FILTER_NO_BO) {</span>
<span class="lineNum">    3872 </span><span class="lineCov">     239435 :                                 data_offset = tkw-&gt;down_bytes;</span>
<span class="lineNum">    3873 </span>            :                         }
<span class="lineNum">    3874 </span><span class="lineCov">     346890 :                         if ((data_offset != GF_FILTER_NO_BO) &amp;&amp; tkw-&gt;down_size) {</span>
<span class="lineNum">    3875 </span><span class="lineCov">     338684 :                                 tkw-&gt;prog_done = data_offset;</span>
<span class="lineNum">    3876 </span><span class="lineCov">     338684 :                                 tkw-&gt;prog_total = tkw-&gt;down_size;</span>
<span class="lineNum">    3877 </span>            :                         } else {
<span class="lineNum">    3878 </span><span class="lineCov">       8206 :                                 if (tkw-&gt;pid_dur.den &amp;&amp; tkw-&gt;pid_dur.num) {</span>
<span class="lineNum">    3879 </span><span class="lineNoCov">          0 :                                         tkw-&gt;prog_done = tkw-&gt;sample.DTS * tkw-&gt;pid_dur.den;</span>
<span class="lineNum">    3880 </span><span class="lineNoCov">          0 :                                         tkw-&gt;prog_total = tkw-&gt;pid_dur.num * tkw-&gt;tk_timescale;</span>
<span class="lineNum">    3881 </span>            :                                 } else {
<span class="lineNum">    3882 </span><span class="lineCov">       8206 :                                         tkw-&gt;prog_done = 0;</span>
<span class="lineNum">    3883 </span><span class="lineCov">       8206 :                                         tkw-&gt;prog_total = 1;</span>
<span class="lineNum">    3884 </span>            :                                 }
<span class="lineNum">    3885 </span>            : 
<span class="lineNum">    3886 </span>            :                         }
<span class="lineNum">    3887 </span>            :                 }
<span class="lineNum">    3888 </span>            :         }
<span class="lineNum">    3889 </span>            :         return GF_OK;
<a name="3890"><span class="lineNum">    3890 </span>            : }</a>
<span class="lineNum">    3891 </span>            : 
<span class="lineNum">    3892 </span><span class="lineCov">         64 : static GF_Err mp4_mux_process_item(GF_MP4MuxCtx *ctx, TrackWriter *tkw, GF_FilterPacket *pck)</span>
<span class="lineNum">    3893 </span>            : {
<span class="lineNum">    3894 </span>            :         GF_Err e;
<span class="lineNum">    3895 </span>            :         u32 meta_type, item_id, size, item_type, nb_items, media_brand;
<span class="lineNum">    3896 </span>            :         GF_ImageItemProperties image_props;
<span class="lineNum">    3897 </span>            :         GF_ImageItemProtection cenc_info;
<span class="lineNum">    3898 </span>            :         const char *data, *item_name=NULL;
<span class="lineNum">    3899 </span>            :         const GF_PropertyValue *p, *dsi, *dsi_enh;
<span class="lineNum">    3900 </span>            :         GF_Box *config_box = NULL;
<span class="lineNum">    3901 </span>            : 
<span class="lineNum">    3902 </span>            : 
<span class="lineNum">    3903 </span><span class="lineCov">         64 :         if (ctx-&gt;init_movie_done) {</span>
<span class="lineNum">    3904 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Cannot add item to a finalized movie, not supported\n&quot;));</span>
<span class="lineNum">    3905 </span>            :                 return GF_NOT_SUPPORTED;
<span class="lineNum">    3906 </span>            :         }
<span class="lineNum">    3907 </span>            : 
<span class="lineNum">    3908 </span><span class="lineCov">         64 :         if (tkw-&gt;stream_type != GF_STREAM_VISUAL) {</span>
<span class="lineNum">    3909 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Cannot add item other than visual, not supported - use MP4Box for this\n&quot;));</span>
<span class="lineNum">    3910 </span>            :                 return GF_NOT_SUPPORTED;
<span class="lineNum">    3911 </span>            :         }
<span class="lineNum">    3912 </span><span class="lineCov">         64 :         ctx-&gt;update_report = GF_TRUE;</span>
<span class="lineNum">    3913 </span>            : 
<span class="lineNum">    3914 </span><span class="lineCov">         64 :         meta_type = gf_isom_get_meta_type(ctx-&gt;file, GF_TRUE, 0);</span>
<span class="lineNum">    3915 </span><span class="lineCov">         64 :         if (!meta_type) {</span>
<span class="lineNum">    3916 </span><span class="lineCov">         29 :                 e = gf_isom_set_meta_type(ctx-&gt;file, GF_TRUE, 0, GF_META_ITEM_TYPE_PICT);</span>
<span class="lineNum">    3917 </span><span class="lineCov">         35 :         } else if (meta_type != GF_META_ITEM_TYPE_PICT) {</span>
<span class="lineNum">    3918 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] File already has a root 'meta' box of type %s\n&quot;, gf_4cc_to_str(meta_type)));</span>
<span class="lineNum">    3919 </span>            :                 e= GF_BAD_PARAM;
<span class="lineNum">    3920 </span>            :         } else {
<span class="lineNum">    3921 </span>            :                 e = GF_OK;
<span class="lineNum">    3922 </span>            :         }
<span class="lineNum">    3923 </span><span class="lineCov">         29 :         if (e) return e;</span>
<span class="lineNum">    3924 </span>            : 
<span class="lineNum">    3925 </span><span class="lineCov">         64 :         data = (char *)gf_filter_pck_get_data(pck, &amp;size);</span>
<span class="lineNum">    3926 </span><span class="lineCov">         64 :         if (!data) {</span>
<span class="lineNum">    3927 </span><span class="lineNoCov">          0 :                 if (gf_filter_pck_get_frame_interface(pck)) {</span>
<span class="lineNum">    3928 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Cannot add items from raw decoder outputs, not supported\n&quot;));</span>
<span class="lineNum">    3929 </span>            :                         return GF_NOT_SUPPORTED;
<span class="lineNum">    3930 </span>            :                 }
<span class="lineNum">    3931 </span>            :                 return GF_OK;
<span class="lineNum">    3932 </span>            :         }
<span class="lineNum">    3933 </span><span class="lineCov">         64 :         ctx-&gt;total_bytes_in += size;</span>
<span class="lineNum">    3934 </span><span class="lineCov">         64 :         ctx-&gt;total_samples++;</span>
<span class="lineNum">    3935 </span>            : 
<span class="lineNum">    3936 </span>            : 
<span class="lineNum">    3937 </span><span class="lineCov">         64 :         item_id = 0;</span>
<span class="lineNum">    3938 </span><span class="lineCov">         64 :         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_ITEM_ID);</span>
<span class="lineNum">    3939 </span><span class="lineCov">         64 :         if (p) item_id = p-&gt;value.uint;</span>
<span class="lineNum">    3940 </span>            : 
<span class="lineNum">    3941 </span>            :         item_name = &quot;Image&quot;;
<span class="lineNum">    3942 </span><span class="lineCov">         64 :         p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;meta:name&quot;);</span>
<span class="lineNum">    3943 </span><span class="lineCov">         64 :         if (p &amp;&amp; p-&gt;value.string) item_name = p-&gt;value.string;</span>
<span class="lineNum">    3944 </span>            : 
<span class="lineNum">    3945 </span>            :         memset(&amp;image_props, 0, sizeof(GF_ImageItemProperties));
<span class="lineNum">    3946 </span>            : 
<span class="lineNum">    3947 </span><span class="lineCov">         64 :         dsi = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_DECODER_CONFIG);</span>
<span class="lineNum">    3948 </span><span class="lineCov">         64 :         dsi_enh = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_DECODER_CONFIG_ENHANCEMENT);</span>
<span class="lineNum">    3949 </span>            : 
<span class="lineNum">    3950 </span><span class="lineCov">         64 :         switch (tkw-&gt;codecid) {</span>
<span class="lineNum">    3951 </span><span class="lineCov">         20 :         case GF_CODECID_AVC:</span>
<span class="lineNum">    3952 </span>            :         case GF_ISOM_SUBTYPE_SVC_H264:
<span class="lineNum">    3953 </span>            :         case GF_ISOM_SUBTYPE_MVC_H264:
<span class="lineNum">    3954 </span><span class="lineCov">         20 :                 if (!dsi) return GF_OK;</span>
<span class="lineNum">    3955 </span>            : 
<span class="lineNum">    3956 </span><span class="lineCov">         20 :                 if (tkw-&gt;codecid==GF_CODECID_AVC) {</span>
<span class="lineNum">    3957 </span><span class="lineCov">         20 :                         config_box = gf_isom_box_new(GF_ISOM_BOX_TYPE_AVCC);</span>
<span class="lineNum">    3958 </span>            :                         item_type = GF_ISOM_SUBTYPE_AVC_H264;
<span class="lineNum">    3959 </span><span class="lineNoCov">          0 :                 } else if (tkw-&gt;codecid==GF_CODECID_MVC) {</span>
<span class="lineNum">    3960 </span><span class="lineNoCov">          0 :                         config_box = gf_isom_box_new(GF_ISOM_BOX_TYPE_MVCC);</span>
<span class="lineNum">    3961 </span>            :                         item_type = GF_ISOM_SUBTYPE_MVC_H264;
<span class="lineNum">    3962 </span><span class="lineNoCov">          0 :                         if (dsi_enh) dsi = dsi_enh;</span>
<span class="lineNum">    3963 </span>            :                 } else {
<span class="lineNum">    3964 </span><span class="lineNoCov">          0 :                         config_box = gf_isom_box_new(GF_ISOM_BOX_TYPE_SVCC);</span>
<span class="lineNum">    3965 </span>            :                         item_type = GF_ISOM_SUBTYPE_SVC_H264;
<span class="lineNum">    3966 </span><span class="lineNoCov">          0 :                         if (dsi_enh) dsi = dsi_enh;</span>
<span class="lineNum">    3967 </span>            :                 }
<span class="lineNum">    3968 </span>            : 
<span class="lineNum">    3969 </span><span class="lineCov">         20 :                 ((GF_AVCConfigurationBox *)config_box)-&gt;config = gf_odf_avc_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">    3970 </span><span class="lineCov">         20 :                 if (! ((GF_AVCConfigurationBox *)config_box)-&gt;config) return GF_NON_COMPLIANT_BITSTREAM;</span>
<span class="lineNum">    3971 </span>            : 
<span class="lineNum">    3972 </span><span class="lineCov">         20 :                 image_props.num_channels = 3;</span>
<span class="lineNum">    3973 </span><span class="lineCov">         20 :                 image_props.bits_per_channel[0] = ((GF_AVCConfigurationBox *)config_box)-&gt;config-&gt;luma_bit_depth;</span>
<span class="lineNum">    3974 </span><span class="lineCov">         20 :                 image_props.bits_per_channel[1] = ((GF_AVCConfigurationBox *)config_box)-&gt;config-&gt;chroma_bit_depth;</span>
<span class="lineNum">    3975 </span><span class="lineCov">         20 :                 image_props.bits_per_channel[2] = ((GF_AVCConfigurationBox *)config_box)-&gt;config-&gt;chroma_bit_depth;</span>
<span class="lineNum">    3976 </span>            :                 media_brand = GF_ISOM_BRAND_AVCI;
<span class="lineNum">    3977 </span><span class="lineCov">         20 :                 break;</span>
<span class="lineNum">    3978 </span>            : 
<span class="lineNum">    3979 </span><span class="lineCov">         41 :         case GF_CODECID_HEVC:</span>
<span class="lineNum">    3980 </span>            :         case GF_CODECID_HEVC_TILES:
<span class="lineNum">    3981 </span>            :         case GF_CODECID_LHVC:
<span class="lineNum">    3982 </span><span class="lineCov">         41 :                 if (tkw-&gt;codecid == GF_CODECID_LHVC) {</span>
<span class="lineNum">    3983 </span><span class="lineNoCov">          0 :                         if (dsi_enh) dsi = dsi_enh;</span>
<span class="lineNum">    3984 </span><span class="lineNoCov">          0 :                         if (!dsi) return GF_OK;</span>
<span class="lineNum">    3985 </span>            :                 }
<span class="lineNum">    3986 </span><span class="lineCov">         41 :                 config_box = gf_isom_box_new(GF_ISOM_BOX_TYPE_HVCC);</span>
<span class="lineNum">    3987 </span>            : 
<span class="lineNum">    3988 </span><span class="lineCov">         41 :                 if (dsi_enh) {</span>
<span class="lineNum">    3989 </span><span class="lineNoCov">          0 :                         ((GF_HEVCConfigurationBox *)config_box)-&gt;config = gf_odf_hevc_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size, GF_TRUE);</span>
<span class="lineNum">    3990 </span>            :                         item_type = GF_ISOM_SUBTYPE_LHV1;
<span class="lineNum">    3991 </span>            :                 } else {
<span class="lineNum">    3992 </span><span class="lineCov">         41 :                         if ((tkw-&gt;codecid == GF_CODECID_HEVC) &amp;&amp; !dsi) return GF_OK;</span>
<span class="lineNum">    3993 </span>            : 
<span class="lineNum">    3994 </span><span class="lineCov">         41 :                         ((GF_HEVCConfigurationBox *)config_box)-&gt;config = gf_odf_hevc_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size, GF_FALSE);</span>
<span class="lineNum">    3995 </span><span class="lineCov">         41 :                         item_type = (tkw-&gt;codecid == GF_CODECID_HEVC_TILES) ? GF_ISOM_SUBTYPE_HVT1 : GF_ISOM_SUBTYPE_HVC1;</span>
<span class="lineNum">    3996 </span>            :                 }
<span class="lineNum">    3997 </span><span class="lineCov">         41 :                 if (! ((GF_HEVCConfigurationBox *)config_box)-&gt;config) {</span>
<span class="lineNum">    3998 </span><span class="lineNoCov">          0 :                         if ((tkw-&gt;codecid != GF_CODECID_HEVC_TILES) &amp;&amp; !dsi) return GF_NON_COMPLIANT_BITSTREAM;</span>
<span class="lineNum">    3999 </span>            :                 } else {
<span class="lineNum">    4000 </span><span class="lineCov">         41 :                         image_props.num_channels = 3;</span>
<span class="lineNum">    4001 </span><span class="lineCov">         41 :                         image_props.bits_per_channel[0] = ((GF_HEVCConfigurationBox *)config_box)-&gt;config-&gt;luma_bit_depth;</span>
<span class="lineNum">    4002 </span><span class="lineCov">         41 :                         image_props.bits_per_channel[1] = ((GF_HEVCConfigurationBox *)config_box)-&gt;config-&gt;chroma_bit_depth;</span>
<span class="lineNum">    4003 </span><span class="lineCov">         41 :                         image_props.bits_per_channel[2] = ((GF_HEVCConfigurationBox *)config_box)-&gt;config-&gt;chroma_bit_depth;</span>
<span class="lineNum">    4004 </span>            :                 }
<span class="lineNum">    4005 </span>            :                 media_brand = GF_ISOM_BRAND_HEIC;
<span class="lineNum">    4006 </span><span class="lineCov">         41 :                 if (tkw-&gt;codecid==GF_CODECID_LHVC) {</span>
<span class="lineNum">    4007 </span>            :                         media_brand = GF_ISOM_BRAND_HEIM;
<span class="lineNum">    4008 </span>            :                 }
<span class="lineNum">    4009 </span>            :                 break;
<span class="lineNum">    4010 </span><span class="lineNoCov">          0 :         case GF_CODECID_AV1:</span>
<span class="lineNum">    4011 </span><span class="lineNoCov">          0 :                 if (!dsi) return GF_OK;</span>
<span class="lineNum">    4012 </span>            : 
<span class="lineNum">    4013 </span><span class="lineNoCov">          0 :                 config_box = gf_isom_box_new(GF_ISOM_BOX_TYPE_AV1C);</span>
<span class="lineNum">    4014 </span><span class="lineNoCov">          0 :                 ((GF_AV1ConfigurationBox *)config_box)-&gt;config = gf_odf_av1_cfg_read(dsi-&gt;value.data.ptr, dsi-&gt;value.data.size);</span>
<span class="lineNum">    4015 </span>            : 
<span class="lineNum">    4016 </span><span class="lineNoCov">          0 :                 if (! ((GF_AV1ConfigurationBox *)config_box)-&gt;config) return GF_NON_COMPLIANT_BITSTREAM;</span>
<span class="lineNum">    4017 </span>            : 
<span class="lineNum">    4018 </span>            :                 item_type = GF_ISOM_SUBTYPE_AV01;
<span class="lineNum">    4019 </span><span class="lineNoCov">          0 :                 u8 depth = ((GF_AV1ConfigurationBox *)config_box)-&gt;config-&gt;high_bitdepth ? (((GF_AV1ConfigurationBox *)config_box)-&gt;config-&gt;twelve_bit ? 12 : 10 ) : 8;</span>
<span class="lineNum">    4020 </span><span class="lineNoCov">          0 :                 if (((GF_AV1ConfigurationBox *)config_box)-&gt;config-&gt;monochrome) {</span>
<span class="lineNum">    4021 </span><span class="lineNoCov">          0 :                         image_props.num_channels = 1;</span>
<span class="lineNum">    4022 </span><span class="lineNoCov">          0 :                         image_props.bits_per_channel[0] = depth;</span>
<span class="lineNum">    4023 </span><span class="lineNoCov">          0 :                         image_props.bits_per_channel[1] = 0;</span>
<span class="lineNum">    4024 </span><span class="lineNoCov">          0 :                         image_props.bits_per_channel[2] = 0;</span>
<span class="lineNum">    4025 </span>            :                 } else {
<span class="lineNum">    4026 </span><span class="lineNoCov">          0 :                         image_props.num_channels = 3;</span>
<span class="lineNum">    4027 </span><span class="lineNoCov">          0 :                         image_props.bits_per_channel[0] = depth;</span>
<span class="lineNum">    4028 </span><span class="lineNoCov">          0 :                         image_props.bits_per_channel[1] = depth;</span>
<span class="lineNum">    4029 </span><span class="lineNoCov">          0 :                         image_props.bits_per_channel[2] = depth;</span>
<span class="lineNum">    4030 </span>            :                 }
<span class="lineNum">    4031 </span>            :                 media_brand = GF_ISOM_BRAND_AVIF;
<span class="lineNum">    4032 </span>            :                 break;
<span class="lineNum">    4033 </span>            :         case GF_CODECID_JPEG:
<span class="lineNum">    4034 </span>            :                 item_type = GF_ISOM_SUBTYPE_JPEG;
<span class="lineNum">    4035 </span>            :                 media_brand = GF_ISOM_SUBTYPE_JPEG /* == GF_4CC('j', 'p', 'e', 'g') */;
<span class="lineNum">    4036 </span>            :                 break;
<span class="lineNum">    4037 </span><span class="lineNoCov">          0 :         case GF_CODECID_J2K:</span>
<span class="lineNum">    4038 </span>            :                 item_type = GF_ISOM_SUBTYPE_JP2K;
<span class="lineNum">    4039 </span>            :                 media_brand = GF_4CC('j', '2', 'k', 'i');
<span class="lineNum">    4040 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    4041 </span><span class="lineNoCov">          0 :         case GF_CODECID_PNG:</span>
<span class="lineNum">    4042 </span>            :                 item_type = GF_ISOM_SUBTYPE_PNG;
<span class="lineNum">    4043 </span>            :                 //not defined !
<span class="lineNum">    4044 </span>            :                 media_brand = GF_ISOM_SUBTYPE_PNG /* == GF_4CC('j', 'p', 'e', 'g') */;
<span class="lineNum">    4045 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    4046 </span><span class="lineNoCov">          0 :         default:</span>
<span class="lineNum">    4047 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;Error: Codec %s not supported to create HEIF image items\n&quot;, gf_codecid_name(tkw-&gt;codecid) ));</span>
<span class="lineNum">    4048 </span>            :                 return GF_NOT_SUPPORTED;
<span class="lineNum">    4049 </span>            :         }
<span class="lineNum">    4050 </span>            : 
<span class="lineNum">    4051 </span><span class="lineCov">         64 :         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_WIDTH);</span>
<span class="lineNum">    4052 </span><span class="lineCov">         64 :         if (p) image_props.width = p-&gt;value.uint;</span>
<span class="lineNum">    4053 </span><span class="lineCov">         64 :         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_HEIGHT);</span>
<span class="lineNum">    4054 </span><span class="lineCov">         64 :         if (p) image_props.height = p-&gt;value.uint;</span>
<span class="lineNum">    4055 </span><span class="lineCov">         64 :         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_ALPHA);</span>
<span class="lineNum">    4056 </span><span class="lineCov">         64 :         if (p) image_props.alpha = p-&gt;value.boolean;</span>
<span class="lineNum">    4057 </span><span class="lineCov">         64 :         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_SAR);</span>
<span class="lineNum">    4058 </span><span class="lineCov">         64 :         if (p) {</span>
<span class="lineNum">    4059 </span><span class="lineNoCov">          0 :                 image_props.hSpacing = p-&gt;value.frac.num;</span>
<span class="lineNum">    4060 </span><span class="lineNoCov">          0 :                 image_props.vSpacing = p-&gt;value.frac.den;</span>
<span class="lineNum">    4061 </span>            :         } else {
<span class="lineNum">    4062 </span><span class="lineCov">         64 :                 image_props.hSpacing = image_props.vSpacing = 1;</span>
<span class="lineNum">    4063 </span>            :         }
<span class="lineNum">    4064 </span><span class="lineCov">         64 :         image_props.config = config_box;</span>
<span class="lineNum">    4065 </span><span class="lineCov">         64 :         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_HIDDEN);</span>
<span class="lineNum">    4066 </span><span class="lineCov">         64 :         if (p) image_props.hidden = p-&gt;value.boolean;</span>
<span class="lineNum">    4067 </span>            : 
<span class="lineNum">    4068 </span>            :         //setup crypto
<span class="lineNum">    4069 </span><span class="lineCov">         64 :         if (tkw-&gt;is_encrypted &amp;&amp; gf_filter_pck_get_crypt_flags(pck)) {</span>
<span class="lineNum">    4070 </span>            :                 memset(&amp;cenc_info, 0, sizeof(GF_ImageItemProtection));
<span class="lineNum">    4071 </span><span class="lineCov">         10 :                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_CENC_SAI);</span>
<span class="lineNum">    4072 </span><span class="lineCov">         10 :                 if (!p) {</span>
<span class="lineNum">    4073 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;Error: Missing CENC SAI on protected packet\n&quot;));</span>
<span class="lineNum">    4074 </span>            :                         return GF_SERVICE_ERROR;
<span class="lineNum">    4075 </span>            :                 }
<span class="lineNum">    4076 </span><span class="lineCov">         10 :                 cenc_info.sai_data = p-&gt;value.data.ptr;</span>
<span class="lineNum">    4077 </span><span class="lineCov">         10 :                 cenc_info.sai_data_size = p-&gt;value.data.size;</span>
<span class="lineNum">    4078 </span>            : 
<span class="lineNum">    4079 </span><span class="lineCov">         10 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_PROTECTION_SCHEME_TYPE);</span>
<span class="lineNum">    4080 </span><span class="lineCov">         10 :                 if (!p) {</span>
<span class="lineNum">    4081 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;Error: Missing CENC scheme type on protected item\n&quot;));</span>
<span class="lineNum">    4082 </span>            :                         return GF_SERVICE_ERROR;
<span class="lineNum">    4083 </span>            :                 }
<span class="lineNum">    4084 </span><span class="lineCov">         10 :                 cenc_info.scheme_type = p-&gt;value.uint;</span>
<span class="lineNum">    4085 </span>            : 
<span class="lineNum">    4086 </span><span class="lineCov">         10 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_PROTECTION_SCHEME_VERSION);</span>
<span class="lineNum">    4087 </span><span class="lineCov">         10 :                 if (!p) {</span>
<span class="lineNum">    4088 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;Error: Missing CENC scheme version on protected item\n&quot;));</span>
<span class="lineNum">    4089 </span>            :                         return GF_SERVICE_ERROR;
<span class="lineNum">    4090 </span>            :                 }
<span class="lineNum">    4091 </span><span class="lineCov">         10 :                 cenc_info.scheme_version = p-&gt;value.uint;</span>
<span class="lineNum">    4092 </span>            : 
<span class="lineNum">    4093 </span><span class="lineCov">         10 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_CENC_KEY_INFO);</span>
<span class="lineNum">    4094 </span><span class="lineCov">         10 :                 if (!p || (p-&gt;type != GF_PROP_DATA) || !gf_cenc_validate_key_info(p-&gt;value.data.ptr, p-&gt;value.data.size)) {</span>
<span class="lineNum">    4095 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;Error: %s CENC Key info on protected item\n&quot;, p ? &quot;Corrupted&quot; : &quot;Missing&quot;));</span>
<span class="lineNum">    4096 </span>            :                         return GF_NON_COMPLIANT_BITSTREAM;
<span class="lineNum">    4097 </span>            :                 }
<span class="lineNum">    4098 </span><span class="lineCov">         10 :                 cenc_info.key_info = p-&gt;value.data.ptr;</span>
<span class="lineNum">    4099 </span><span class="lineCov">         10 :                 cenc_info.key_info_size = p-&gt;value.data.size;</span>
<span class="lineNum">    4100 </span>            : 
<span class="lineNum">    4101 </span><span class="lineCov">         10 :                 image_props.cenc_info = &amp;cenc_info;</span>
<span class="lineNum">    4102 </span>            : 
<span class="lineNum">    4103 </span><span class="lineCov">         10 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_CENC_PATTERN);</span>
<span class="lineNum">    4104 </span><span class="lineCov">         10 :                 if (p) {</span>
<span class="lineNum">    4105 </span><span class="lineCov">          4 :                         cenc_info.skip_byte_block = p-&gt;value.frac.num;</span>
<span class="lineNum">    4106 </span><span class="lineCov">          4 :                         cenc_info.crypt_byte_block = p-&gt;value.frac.den;</span>
<span class="lineNum">    4107 </span>            :                 }
<span class="lineNum">    4108 </span>            : 
<span class="lineNum">    4109 </span>            : 
<span class="lineNum">    4110 </span><span class="lineCov">         10 :                 if (tkw-&gt;insert_pssh) {</span>
<span class="lineNum">    4111 </span><span class="lineCov">         10 :                         mp4_mux_cenc_insert_pssh(ctx, tkw);</span>
<span class="lineNum">    4112 </span><span class="lineCov">         10 :                         tkw-&gt;insert_pssh = GF_FALSE;</span>
<span class="lineNum">    4113 </span>            :                 }
<span class="lineNum">    4114 </span>            :         }
<span class="lineNum">    4115 </span>            : 
<span class="lineNum">    4116 </span><span class="lineCov">         64 :         nb_items = gf_isom_get_meta_item_count(ctx-&gt;file, GF_TRUE, 0);</span>
<span class="lineNum">    4117 </span>            : 
<span class="lineNum">    4118 </span><span class="lineCov">         64 :         e = gf_isom_add_meta_item_memory(ctx-&gt;file, GF_TRUE, 0, item_name, &amp;item_id, item_type, NULL, NULL, &amp;image_props, (u8 *)data, size, NULL);</span>
<span class="lineNum">    4119 </span>            : 
<span class="lineNum">    4120 </span><span class="lineCov">         64 :         if (config_box) gf_isom_box_del(config_box);</span>
<span class="lineNum">    4121 </span>            : 
<span class="lineNum">    4122 </span><span class="lineCov">         64 :         if (e) return e;</span>
<span class="lineNum">    4123 </span>            : 
<span class="lineNum">    4124 </span>            : 
<span class="lineNum">    4125 </span>            :         //retrieve the final itemID
<span class="lineNum">    4126 </span><span class="lineCov">         64 :         gf_isom_get_meta_item_info(ctx-&gt;file, GF_TRUE, 0, nb_items+1, &amp;item_id, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL);</span>
<span class="lineNum">    4127 </span><span class="lineCov">         64 :         tkw-&gt;item_id = item_id;</span>
<span class="lineNum">    4128 </span>            : 
<span class="lineNum">    4129 </span><span class="lineCov">         64 :         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_PRIMARY_ITEM);</span>
<span class="lineNum">    4130 </span><span class="lineCov">         64 :         if (p &amp;&amp; p-&gt;value.boolean) {</span>
<span class="lineNum">    4131 </span><span class="lineCov">         10 :                 e = gf_isom_set_meta_primary_item(ctx-&gt;file, GF_TRUE, 0, item_id);</span>
<span class="lineNum">    4132 </span><span class="lineCov">         10 :                 if (e) return e;</span>
<span class="lineNum">    4133 </span>            :         }
<span class="lineNum">    4134 </span>            :         //if primary item is not set, assign one
<span class="lineNum">    4135 </span><span class="lineCov">         54 :         else if (! gf_isom_get_meta_primary_item_id(ctx-&gt;file, GF_TRUE, 0)) {</span>
<span class="lineNum">    4136 </span><span class="lineCov">         19 :                 e = gf_isom_set_meta_primary_item(ctx-&gt;file, GF_TRUE, 0, item_id);</span>
<span class="lineNum">    4137 </span><span class="lineCov">         19 :                 if (e) return e;</span>
<span class="lineNum">    4138 </span>            :         }
<span class="lineNum">    4139 </span>            : 
<span class="lineNum">    4140 </span><span class="lineCov">         64 :         if (!ctx-&gt;major_brand_set) {</span>
<span class="lineNum">    4141 </span><span class="lineCov">         29 :                 gf_isom_set_brand_info(ctx-&gt;file, GF_ISOM_BRAND_MIF1, 0);</span>
<span class="lineNum">    4142 </span><span class="lineCov">         29 :                 gf_isom_reset_alt_brands(ctx-&gt;file);</span>
<span class="lineNum">    4143 </span><span class="lineCov">         29 :                 ctx-&gt;major_brand_set = 2;</span>
<span class="lineNum">    4144 </span>            :         }
<span class="lineNum">    4145 </span><span class="lineCov">         64 :         if (media_brand &amp;&amp; (ctx-&gt;major_brand_set==2)) {</span>
<span class="lineNum">    4146 </span><span class="lineCov">         64 :                 gf_isom_modify_alternate_brand(ctx-&gt;file, media_brand, 1);</span>
<span class="lineNum">    4147 </span>            :         }
<span class="lineNum">    4148 </span>            : #if 0
<span class="lineNum">    4149 </span>            :         if (e == GF_OK &amp;&amp; meta-&gt;ref_type) {
<span class="lineNum">    4150 </span>            :                 e = gf_isom_meta_add_item_ref(file, meta-&gt;root_meta, tk, meta-&gt;item_id, meta-&gt;ref_item_id, meta-&gt;ref_type, NULL);
<span class="lineNum">    4151 </span>            :         }
<span class="lineNum">    4152 </span>            : #endif
<span class="lineNum">    4153 </span>            :         return GF_OK;
<a name="4154"><span class="lineNum">    4154 </span>            : }</a>
<span class="lineNum">    4155 </span>            : 
<span class="lineNum">    4156 </span><span class="lineCov">      40961 : static void mp4mux_send_output(GF_MP4MuxCtx *ctx)</span>
<span class="lineNum">    4157 </span>            : {
<span class="lineNum">    4158 </span><span class="lineCov">      40961 :         if (ctx-&gt;dst_pck) {</span>
<span class="lineNum">    4159 </span><span class="lineCov">      20901 :                 if (ctx-&gt;notify_filename) {</span>
<span class="lineNum">    4160 </span><span class="lineCov">         83 :                         gf_filter_pck_set_framing(ctx-&gt;dst_pck, GF_TRUE, GF_FALSE);</span>
<span class="lineNum">    4161 </span><span class="lineCov">         83 :                         gf_filter_pck_set_property(ctx-&gt;dst_pck, GF_PROP_PCK_FILENUM, &amp;PROP_UINT(ctx-&gt;cur_file_idx_plus_one-1) );</span>
<span class="lineNum">    4162 </span><span class="lineCov">         83 :                         if (ctx-&gt;cur_file_suffix) {</span>
<span class="lineNum">    4163 </span><span class="lineCov">         83 :                                 gf_filter_pck_set_property(ctx-&gt;dst_pck, GF_PROP_PCK_FILESUF, &amp;PROP_STRING_NO_COPY(ctx-&gt;cur_file_suffix) );</span>
<span class="lineNum">    4164 </span><span class="lineCov">         83 :                                 ctx-&gt;cur_file_suffix = NULL;</span>
<span class="lineNum">    4165 </span>            :                         }
<span class="lineNum">    4166 </span><span class="lineCov">         83 :                         ctx-&gt;notify_filename = 0;</span>
<span class="lineNum">    4167 </span>            :                 }
<span class="lineNum">    4168 </span><span class="lineCov">      20901 :                 gf_filter_pck_send(ctx-&gt;dst_pck);</span>
<span class="lineNum">    4169 </span><span class="lineCov">      20901 :                 ctx-&gt;dst_pck = NULL;</span>
<span class="lineNum">    4170 </span>            :         }
<a name="4171"><span class="lineNum">    4171 </span><span class="lineCov">      40961 : }</span></a>
<span class="lineNum">    4172 </span>            : 
<span class="lineNum">    4173 </span><span class="lineCov">        330 : static void mp4_mux_flush_frag_hls(GF_MP4MuxCtx *ctx)</span>
<span class="lineNum">    4174 </span>            : {
<span class="lineNum">    4175 </span>            :         GF_FilterEvent evt;
<span class="lineNum">    4176 </span>            :         TrackWriter *tkw = NULL;
<span class="lineNum">    4177 </span>            :         //send event on first track only
<span class="lineNum">    4178 </span><span class="lineCov">        330 :         tkw = gf_list_get(ctx-&gt;tracks, 0);</span>
<span class="lineNum">    4179 </span><span class="lineCov">        330 :         GF_FEVT_INIT(evt, GF_FEVT_FRAGMENT_SIZE, tkw-&gt;ipid);</span>
<span class="lineNum">    4180 </span><span class="lineCov">        330 :         evt.frag_size.is_last = ctx-&gt;flush_seg ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    4181 </span><span class="lineCov">        330 :         evt.frag_size.offset = ctx-&gt;frag_offset;</span>
<span class="lineNum">    4182 </span><span class="lineCov">        330 :         evt.frag_size.size = ctx-&gt;frag_size;</span>
<span class="lineNum">    4183 </span><span class="lineCov">        330 :         evt.frag_size.duration.num = (s64) ctx-&gt;frag_duration;</span>
<span class="lineNum">    4184 </span><span class="lineCov">        330 :         evt.frag_size.duration.den = ctx-&gt;frag_timescale;</span>
<span class="lineNum">    4185 </span><span class="lineCov">        330 :         evt.frag_size.independent = ctx-&gt;frag_has_intra;</span>
<span class="lineNum">    4186 </span>            : 
<span class="lineNum">    4187 </span><span class="lineCov">        330 :         gf_filter_pid_send_event(tkw-&gt;ipid, &amp;evt);</span>
<span class="lineNum">    4188 </span>            : 
<span class="lineNum">    4189 </span><span class="lineCov">        330 :         ctx-&gt;frag_offset += ctx-&gt;frag_size;</span>
<span class="lineNum">    4190 </span><span class="lineCov">        330 :         ctx-&gt;frag_size = 0;</span>
<span class="lineNum">    4191 </span><span class="lineCov">        330 :         ctx-&gt;frag_duration = 0;</span>
<span class="lineNum">    4192 </span><span class="lineCov">        330 :         ctx-&gt;frag_has_intra = GF_FALSE;</span>
<a name="4193"><span class="lineNum">    4193 </span><span class="lineCov">        330 : }</span></a>
<span class="lineNum">    4194 </span>            : 
<span class="lineNum">    4195 </span><span class="lineCov">       3417 : static void mp4_mux_flush_seg(GF_MP4MuxCtx *ctx, Bool is_init, u64 idx_start_range, u64 idx_end_range)</span>
<span class="lineNum">    4196 </span>            : {
<span class="lineNum">    4197 </span>            :         GF_FilterEvent evt;
<span class="lineNum">    4198 </span>            :         TrackWriter *tkw = NULL;
<span class="lineNum">    4199 </span>            : 
<span class="lineNum">    4200 </span><span class="lineCov">       3417 :         if (ctx-&gt;dst_pck) {</span>
<span class="lineNum">    4201 </span><span class="lineCov">       3124 :                 if (!ctx-&gt;single_file) {</span>
<span class="lineNum">    4202 </span>            :                         Bool s, e;
<span class="lineNum">    4203 </span><span class="lineCov">       2725 :                         gf_filter_pck_get_framing(ctx-&gt;dst_pck, &amp;s, &amp;e);</span>
<span class="lineNum">    4204 </span><span class="lineCov">       2725 :                         gf_filter_pck_set_framing(ctx-&gt;dst_pck, s, GF_TRUE);</span>
<span class="lineNum">    4205 </span><span class="lineCov">       2725 :                         if (!is_init) {</span>
<span class="lineNum">    4206 </span><span class="lineCov">       2487 :                                 u64 dur = ctx-&gt;next_seg_start - (ctx-&gt;min_cts_plus_one-1);</span>
<span class="lineNum">    4207 </span><span class="lineCov">       2487 :                                 gf_filter_pck_set_duration(ctx-&gt;dst_pck, (u32) dur);</span>
<span class="lineNum">    4208 </span>            :                         }
<span class="lineNum">    4209 </span><span class="lineCov">       2725 :                         ctx-&gt;first_pck_sent = GF_FALSE;</span>
<span class="lineNum">    4210 </span><span class="lineCov">       2725 :                         ctx-&gt;current_offset = 0;</span>
<span class="lineNum">    4211 </span><span class="lineCov">       2725 :                         if (is_init &amp;&amp; s)</span>
<span class="lineNum">    4212 </span><span class="lineCov">        238 :                                 gf_filter_pck_set_property(ctx-&gt;dst_pck, GF_PROP_PCK_INIT, &amp;PROP_BOOL(GF_TRUE) );</span>
<span class="lineNum">    4213 </span>            :                 }
<span class="lineNum">    4214 </span><span class="lineCov">       3124 :                 if (is_init) {</span>
<span class="lineNum">    4215 </span><span class="lineCov">        294 :                         gf_filter_pck_set_dependency_flags(ctx-&gt;dst_pck, 0xFF);</span>
<span class="lineNum">    4216 </span><span class="lineCov">        294 :                         gf_filter_pck_set_carousel_version(ctx-&gt;dst_pck, 1);</span>
<span class="lineNum">    4217 </span>            :                 }
<span class="lineNum">    4218 </span><span class="lineCov">       3124 :                 mp4mux_send_output(ctx);</span>
<span class="lineNum">    4219 </span>            :         }
<span class="lineNum">    4220 </span><span class="lineCov">       3417 :         if (!is_init &amp;&amp; ctx-&gt;llhls_mode &amp;&amp; ctx-&gt;frag_size) {</span>
<span class="lineNum">    4221 </span><span class="lineCov">         51 :                 mp4_mux_flush_frag_hls(ctx);</span>
<span class="lineNum">    4222 </span>            :         }
<span class="lineNum">    4223 </span><span class="lineCov">       3417 :         if (ctx-&gt;dash_mode) {</span>
<span class="lineNum">    4224 </span>            :                 //send event on first track only
<span class="lineNum">    4225 </span><span class="lineCov">       3324 :                 tkw = gf_list_get(ctx-&gt;tracks, 0);</span>
<span class="lineNum">    4226 </span><span class="lineCov">       3324 :                 GF_FEVT_INIT(evt, GF_FEVT_SEGMENT_SIZE, tkw-&gt;ipid);</span>
<span class="lineNum">    4227 </span>            :                 evt.seg_size.seg_url = NULL;
<span class="lineNum">    4228 </span><span class="lineCov">       3324 :                 evt.seg_size.is_init = is_init ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    4229 </span><span class="lineCov">       3324 :                 if (!is_init || !idx_end_range) {</span>
<span class="lineNum">    4230 </span><span class="lineCov">       3307 :                         evt.seg_size.media_range_start = ctx-&gt;current_offset;</span>
<span class="lineNum">    4231 </span><span class="lineCov">       3307 :                         evt.seg_size.media_range_end = ctx-&gt;current_offset + ctx-&gt;current_size - 1;</span>
<span class="lineNum">    4232 </span>            :                 }
<span class="lineNum">    4233 </span><span class="lineCov">       3324 :                 evt.seg_size.idx_range_start = idx_start_range;</span>
<span class="lineNum">    4234 </span><span class="lineCov">       3324 :                 evt.seg_size.idx_range_end = idx_end_range;</span>
<span class="lineNum">    4235 </span><span class="lineCov">       3324 :                 gf_filter_pid_send_event(tkw-&gt;ipid, &amp;evt);</span>
<span class="lineNum">    4236 </span>            : 
<span class="lineNum">    4237 </span><span class="lineCov">       3324 :                 ctx-&gt;current_offset += ctx-&gt;current_size;</span>
<span class="lineNum">    4238 </span><span class="lineCov">       3324 :                 ctx-&gt;current_size = 0;</span>
<span class="lineNum">    4239 </span><span class="lineCov">       3324 :                 ctx-&gt;frag_offset = 0;</span>
<span class="lineNum">    4240 </span><span class="lineCov">       3324 :                 ctx-&gt;frag_size = 0;</span>
<span class="lineNum">    4241 </span><span class="lineCov">       3324 :                 ctx-&gt;frag_num = 0;</span>
<span class="lineNum">    4242 </span><span class="lineCov">       3324 :                 ctx-&gt;frag_has_intra = GF_FALSE;</span>
<span class="lineNum">    4243 </span>            :                 //changing file
<span class="lineNum">    4244 </span><span class="lineCov">       3324 :                 if (ctx-&gt;seg_name) {</span>
<span class="lineNum">    4245 </span><span class="lineCov">       2484 :                         ctx-&gt;first_pck_sent = GF_FALSE;</span>
<span class="lineNum">    4246 </span>            :                 }
<span class="lineNum">    4247 </span>            :         }
<span class="lineNum">    4248 </span><span class="lineCov">       3417 : }</span>
<a name="4249"><span class="lineNum">    4249 </span>            : </a>
<span class="lineNum">    4250 </span>            : 
<span class="lineNum">    4251 </span><span class="lineCov">        339 : static GF_Err mp4_mux_initialize_movie(GF_MP4MuxCtx *ctx)</span>
<span class="lineNum">    4252 </span>            : {
<span class="lineNum">    4253 </span>            :         GF_Err e;
<span class="lineNum">    4254 </span><span class="lineCov">        339 :         u32 i, count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    4255 </span>            :         TrackWriter *ref_tkw = NULL;
<span class="lineNum">    4256 </span>            :         u64 min_dts = 0;
<span class="lineNum">    4257 </span>            :         u32 min_dts_scale=0;
<span class="lineNum">    4258 </span>            :         u32 def_fake_dur=0;
<span class="lineNum">    4259 </span>            :         u32 def_fake_scale=0;
<span class="lineNum">    4260 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">    4261 </span>            :         u32 traf_inherit_base_id=0;
<span class="lineNum">    4262 </span>            : #endif
<span class="lineNum">    4263 </span>            :         u32 nb_segments=0;
<span class="lineNum">    4264 </span>            :         GF_Fraction64 max_dur;
<span class="lineNum">    4265 </span><span class="lineCov">        339 :         ctx-&gt;single_file = GF_TRUE;</span>
<span class="lineNum">    4266 </span><span class="lineCov">        339 :         ctx-&gt;current_offset = ctx-&gt;current_size = 0;</span>
<span class="lineNum">    4267 </span>            :         max_dur.den = 1;
<span class="lineNum">    4268 </span>            :         max_dur.num = 0;
<span class="lineNum">    4269 </span>            : 
<span class="lineNum">    4270 </span><span class="lineCov">        339 :         if (ctx-&gt;sseg &amp;&amp; ctx-&gt;noinit)</span>
<span class="lineNum">    4271 </span><span class="lineCov">          3 :                 ctx-&gt;single_file = GF_FALSE;</span>
<span class="lineNum">    4272 </span>            : 
<span class="lineNum">    4273 </span><span class="lineCov">        339 :         if (ctx-&gt;idur.num &amp;&amp; ctx-&gt;idur.den) {</span>
<span class="lineNum">    4274 </span><span class="lineNoCov">          0 :                 max_dur.num = ctx-&gt;idur.num;</span>
<span class="lineNum">    4275 </span><span class="lineNoCov">          0 :                 max_dur.den = ctx-&gt;idur.den;</span>
<span class="lineNum">    4276 </span>            :         }
<span class="lineNum">    4277 </span>            : 
<span class="lineNum">    4278 </span>            :         //make sure we have one sample from each PID. This will trigger potential pending reconfigure
<span class="lineNum">    4279 </span>            :         //for filters updating the PID caps before the first packet dispatch
<span class="lineNum">    4280 </span><span class="lineCov">        389 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    4281 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">    4282 </span><span class="lineCov">        389 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    4283 </span>            :                 GF_FilterPacket *pck;
<span class="lineNum">    4284 </span><span class="lineCov">        389 :                 if (tkw-&gt;fake_track) continue;</span>
<span class="lineNum">    4285 </span>            : 
<span class="lineNum">    4286 </span><span class="lineCov">        362 :                 pck = gf_filter_pid_get_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    4287 </span><span class="lineCov">        362 :                 if (!pck) {</span>
<span class="lineNum">    4288 </span><span class="lineNoCov">          0 :                         if (gf_filter_pid_is_eos(tkw-&gt;ipid)) continue;</span>
<span class="lineNum">    4289 </span>            :                         return GF_OK;
<span class="lineNum">    4290 </span>            :                 }
<span class="lineNum">    4291 </span>            : 
<span class="lineNum">    4292 </span><span class="lineCov">        362 :                 if (!ctx-&gt;dash_mode &amp;&amp; !ctx-&gt;cur_file_idx_plus_one) {</span>
<span class="lineNum">    4293 </span><span class="lineCov">         14 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENUM);</span>
<span class="lineNum">    4294 </span><span class="lineCov">         14 :                         if (p) {</span>
<span class="lineNum">    4295 </span><span class="lineCov">          4 :                                 ctx-&gt;cur_file_idx_plus_one = p-&gt;value.uint + 1;</span>
<span class="lineNum">    4296 </span><span class="lineCov">          4 :                                 if (!ctx-&gt;cur_file_suffix) {</span>
<span class="lineNum">    4297 </span><span class="lineCov">          4 :                                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILESUF);</span>
<span class="lineNum">    4298 </span><span class="lineCov">          4 :                                         if (p &amp;&amp; p-&gt;value.string) ctx-&gt;cur_file_suffix = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">    4299 </span>            :                                 }
<span class="lineNum">    4300 </span><span class="lineCov">          4 :                                 ctx-&gt;notify_filename = GF_TRUE;</span>
<span class="lineNum">    4301 </span>            :                         }
<span class="lineNum">    4302 </span>            :                 }
<span class="lineNum">    4303 </span>            : 
<span class="lineNum">    4304 </span><span class="lineCov">        362 :                 if (tkw-&gt;cenc_state==CENC_NEED_SETUP) {</span>
<span class="lineNum">    4305 </span><span class="lineCov">        112 :                         mp4_mux_cenc_update(ctx, tkw, pck, CENC_CONFIG, 0);</span>
<span class="lineNum">    4306 </span>            :                 }
<span class="lineNum">    4307 </span>            : 
<span class="lineNum">    4308 </span><span class="lineCov">        362 :                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENAME);</span>
<span class="lineNum">    4309 </span><span class="lineCov">        362 :                 if (p &amp;&amp; strlen(p-&gt;value.string)) ctx-&gt;single_file = GF_FALSE;</span>
<span class="lineNum">    4310 </span>            : 
<span class="lineNum">    4311 </span><span class="lineCov">        362 :                 def_fake_dur = gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">    4312 </span><span class="lineCov">        362 :                 def_fake_scale = tkw-&gt;src_timescale;</span>
<span class="lineNum">    4313 </span>            : 
<span class="lineNum">    4314 </span><span class="lineCov">        362 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_DURATION);</span>
<span class="lineNum">    4315 </span><span class="lineCov">        362 :                 if (p &amp;&amp; p-&gt;value.lfrac.num&gt;0 &amp;&amp; p-&gt;value.lfrac.den) {</span>
<span class="lineNum">    4316 </span><span class="lineCov">        350 :                         tkw-&gt;pid_dur = p-&gt;value.lfrac;</span>
<span class="lineNum">    4317 </span><span class="lineCov">        350 :                         if (max_dur.num * (s64) p-&gt;value.lfrac.den &lt; (s64) max_dur.den * p-&gt;value.lfrac.num) {</span>
<span class="lineNum">    4318 </span>            :                                 max_dur.num = p-&gt;value.lfrac.num;
<span class="lineNum">    4319 </span>            :                                 max_dur.den = p-&gt;value.lfrac.den;
<span class="lineNum">    4320 </span>            :                         }
<span class="lineNum">    4321 </span>            :                 }
<span class="lineNum">    4322 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">    4323 </span>            :                 if (tkw-&gt;codecid==GF_CODECID_HEVC)
<span class="lineNum">    4324 </span>            :                         traf_inherit_base_id = tkw-&gt;track_id;
<span class="lineNum">    4325 </span>            : #endif
<span class="lineNum">    4326 </span>            :         }
<span class="lineNum">    4327 </span>            :         //good to go, finalize for fragments
<span class="lineNum">    4328 </span><span class="lineCov">        389 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    4329 </span>            :                 u32 def_pck_dur;
<span class="lineNum">    4330 </span>            :                 u32 def_samp_size=0;
<span class="lineNum">    4331 </span>            :                 u32 def_is_rap;
<span class="lineNum">    4332 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">    4333 </span>            :                 u32 inherit_traf_from_track = 0;
<span class="lineNum">    4334 </span>            : #endif
<span class="lineNum">    4335 </span>            :                 u64 dts;
<span class="lineNum">    4336 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">    4337 </span>            : 
<span class="lineNum">    4338 </span><span class="lineCov">        389 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    4339 </span>            : 
<span class="lineNum">    4340 </span><span class="lineCov">        389 :                 if (tkw-&gt;fake_track) {</span>
<span class="lineNum">    4341 </span><span class="lineCov">         27 :                         if (def_fake_scale) {</span>
<span class="lineNum">    4342 </span>            :                                 def_pck_dur = def_fake_dur;
<span class="lineNum">    4343 </span><span class="lineCov">         27 :                                 def_pck_dur *= tkw-&gt;src_timescale;</span>
<span class="lineNum">    4344 </span><span class="lineCov">         27 :                                 def_pck_dur /= def_fake_scale;</span>
<span class="lineNum">    4345 </span>            :                         } else {
<span class="lineNum">    4346 </span>            :                                 def_pck_dur = 0;
<span class="lineNum">    4347 </span>            :                         }
<span class="lineNum">    4348 </span>            :                 } else {
<span class="lineNum">    4349 </span><span class="lineCov">        362 :                         GF_FilterPacket *pck = gf_filter_pid_get_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    4350 </span>            :                         //can be null if eos
<span class="lineNum">    4351 </span><span class="lineCov">        362 :                         if (pck) {</span>
<span class="lineNum">    4352 </span>            :                                 u32 tscale;
<span class="lineNum">    4353 </span>            :                                 //otherwise setup fragmentation, using first sample desc as default idx
<span class="lineNum">    4354 </span>            :                                 //first pck dur as default
<span class="lineNum">    4355 </span><span class="lineCov">        362 :                                 def_pck_dur = gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">    4356 </span>            : 
<span class="lineNum">    4357 </span><span class="lineCov">        362 :                                 dts = gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">    4358 </span><span class="lineCov">        362 :                                 if (dts == GF_FILTER_NO_TS)</span>
<span class="lineNum">    4359 </span><span class="lineNoCov">          0 :                                         dts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    4360 </span><span class="lineCov">        362 :                                 tscale = gf_filter_pck_get_timescale(pck);</span>
<span class="lineNum">    4361 </span>            : 
<span class="lineNum">    4362 </span><span class="lineCov">        362 :                                 if (!min_dts || min_dts * tscale &gt; dts * min_dts_scale) {</span>
<span class="lineNum">    4363 </span>            :                                         min_dts = dts;
<span class="lineNum">    4364 </span>            :                                         min_dts_scale = tscale;
<span class="lineNum">    4365 </span>            :                                 }
<span class="lineNum">    4366 </span><span class="lineCov">        362 :                                 if (tkw-&gt;raw_audio_bytes_per_sample) {</span>
<span class="lineNum">    4367 </span>            :                                         u32 pck_size;
<span class="lineNum">    4368 </span><span class="lineNoCov">          0 :                                         gf_filter_pck_get_data(pck, &amp;pck_size);</span>
<span class="lineNum">    4369 </span><span class="lineNoCov">          0 :                                         pck_size /= tkw-&gt;raw_audio_bytes_per_sample;</span>
<span class="lineNum">    4370 </span><span class="lineNoCov">          0 :                                         if (pck_size)</span>
<span class="lineNum">    4371 </span><span class="lineNoCov">          0 :                                                 def_pck_dur /= pck_size;</span>
<span class="lineNum">    4372 </span>            :                                 }
<span class="lineNum">    4373 </span>            :                         } else {
<span class="lineNum">    4374 </span>            :                                 def_pck_dur = 0;
<span class="lineNum">    4375 </span>            :                         }
<span class="lineNum">    4376 </span><span class="lineCov">        362 :                         if (tkw-&gt;raw_audio_bytes_per_sample)</span>
<span class="lineNum">    4377 </span>            :                                 def_samp_size = tkw-&gt;raw_audio_bytes_per_sample;
<span class="lineNum">    4378 </span>            :                 }
<span class="lineNum">    4379 </span><span class="lineCov">        389 :                 if (tkw-&gt;src_timescale != tkw-&gt;tk_timescale) {</span>
<span class="lineNum">    4380 </span><span class="lineNoCov">          0 :                         def_pck_dur *= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    4381 </span><span class="lineNoCov">          0 :                         def_pck_dur /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    4382 </span>            :                 }
<span class="lineNum">    4383 </span>            : 
<span class="lineNum">    4384 </span>            :                 //and consider audio &amp; text all RAPs, the rest not rap - this will need refinement later on
<span class="lineNum">    4385 </span>            :                 //but won't break the generated files
<span class="lineNum">    4386 </span><span class="lineCov">        389 :                 switch (tkw-&gt;stream_type) {</span>
<span class="lineNum">    4387 </span><span class="lineCov">         89 :                 case GF_STREAM_AUDIO:</span>
<span class="lineNum">    4388 </span>            :                 case GF_STREAM_TEXT:
<span class="lineNum">    4389 </span>            :                         def_is_rap = GF_TRUE;
<span class="lineNum">    4390 </span><span class="lineCov">         89 :                         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_HAS_SYNC);</span>
<span class="lineNum">    4391 </span><span class="lineCov">         89 :                         if (p &amp;&amp; p-&gt;value.boolean)</span>
<span class="lineNum">    4392 </span>            :                                 def_is_rap = GF_FALSE;
<span class="lineNum">    4393 </span>            :                         break;
<span class="lineNum">    4394 </span><span class="lineCov">        296 :                 case GF_STREAM_VISUAL:</span>
<span class="lineNum">    4395 </span><span class="lineCov">        296 :                         switch (tkw-&gt;codecid) {</span>
<span class="lineNum">    4396 </span>            :                         case GF_CODECID_PNG:
<span class="lineNum">    4397 </span>            :                         case GF_CODECID_JPEG:
<span class="lineNum">    4398 </span>            :                         case GF_CODECID_J2K:
<span class="lineNum">    4399 </span>            :                                 break;
<span class="lineNum">    4400 </span>            :                         case GF_CODECID_HEVC_TILES:
<span class="lineNum">    4401 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">    4402 </span>            :                                 if (ctx-&gt;ctrn &amp;&amp; ctx-&gt;ctrni)
<span class="lineNum">    4403 </span>            :                                         inherit_traf_from_track = traf_inherit_base_id;
<span class="lineNum">    4404 </span>            : #endif
<span class="lineNum">    4405 </span>            :                                 break;
<span class="lineNum">    4406 </span><span class="lineCov">        233 :                         default:</span>
<span class="lineNum">    4407 </span><span class="lineCov">        233 :                                 if (!ref_tkw) ref_tkw = tkw;</span>
<span class="lineNum">    4408 </span>            :                                 break;
<span class="lineNum">    4409 </span>            :                         }
<span class="lineNum">    4410 </span>            :                         def_is_rap = GF_FALSE;
<span class="lineNum">    4411 </span>            :                         break;
<span class="lineNum">    4412 </span>            : 
<span class="lineNum">    4413 </span>            :                 default:
<span class="lineNum">    4414 </span>            :                         def_is_rap = GF_FALSE;
<span class="lineNum">    4415 </span>            :                         break;
<span class="lineNum">    4416 </span>            :                 }
<span class="lineNum">    4417 </span>            : 
<span class="lineNum">    4418 </span><span class="lineCov">        389 :                 mp4_mux_set_hevc_groups(ctx, tkw);</span>
<span class="lineNum">    4419 </span>            : 
<span class="lineNum">    4420 </span>            :                 //use 1 for the default sample description index. If no multi stsd, this is always the case
<span class="lineNum">    4421 </span>            :                 //otherwise we need to update the stsd idx in the traf headers
<span class="lineNum">    4422 </span><span class="lineCov">        389 :                 e = gf_isom_setup_track_fragment(ctx-&gt;file, tkw-&gt;track_id, tkw-&gt;stsd_idx, def_pck_dur, def_samp_size, (u8) def_is_rap, 0, 0, ctx-&gt;nofragdef ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    4423 </span><span class="lineCov">        389 :                 if (e) {</span>
<span class="lineNum">    4424 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to setup fragmentation for track ID %d: %s\n&quot;, tkw-&gt;track_id, gf_error_to_string(e) ));</span>
<span class="lineNum">    4425 </span>            :                         return e;
<span class="lineNum">    4426 </span>            :                 }
<span class="lineNum">    4427 </span>            : 
<span class="lineNum">    4428 </span><span class="lineCov">        389 :                 if (ctx-&gt;refrag) {</span>
<span class="lineNum">    4429 </span><span class="lineCov">          3 :                         p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_ISOM_TREX_TEMPLATE);</span>
<span class="lineNum">    4430 </span><span class="lineCov">          3 :                         if (p) {</span>
<span class="lineNum">    4431 </span><span class="lineCov">          3 :                                 gf_isom_setup_track_fragment_template(ctx-&gt;file, tkw-&gt;track_id, p-&gt;value.data.ptr, p-&gt;value.data.size, ctx-&gt;nofragdef);</span>
<span class="lineNum">    4432 </span><span class="lineNoCov">          0 :                         } else if (!ctx-&gt;nofragdef) {</span>
<span class="lineNum">    4433 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Refragmentation with default track fragment flags signaling but no TREX found in source track %d, using defaults computed from PID, result might be broken\n&quot;, tkw-&gt;track_id));</span>
<span class="lineNum">    4434 </span>            :                         }
<span class="lineNum">    4435 </span>            :                 }
<span class="lineNum">    4436 </span>            : 
<span class="lineNum">    4437 </span>            : 
<span class="lineNum">    4438 </span><span class="lineCov">        389 :                 if (ctx-&gt;tfdt.den &amp;&amp; ctx-&gt;tfdt.num) {</span>
<span class="lineNum">    4439 </span><span class="lineNoCov">          0 :                         tkw-&gt;offset_dts = ctx-&gt;tfdt.num * tkw-&gt;tk_timescale;</span>
<span class="lineNum">    4440 </span><span class="lineNoCov">          0 :                         tkw-&gt;offset_dts /= ctx-&gt;tfdt.den;</span>
<span class="lineNum">    4441 </span>            :                 }
<span class="lineNum">    4442 </span>            : 
<span class="lineNum">    4443 </span><span class="lineCov">        389 :                 if (tkw-&gt;fake_track) {</span>
<span class="lineNum">    4444 </span><span class="lineCov">         27 :                         gf_list_del_item(ctx-&gt;tracks, tkw);</span>
<span class="lineNum">    4445 </span><span class="lineCov">         27 :                         if (ref_tkw==tkw) ref_tkw=NULL;</span>
<span class="lineNum">    4446 </span><span class="lineCov">         27 :                         mp4_mux_track_writer_del(tkw);</span>
<span class="lineNum">    4447 </span><span class="lineCov">         27 :                         i--;</span>
<span class="lineNum">    4448 </span><span class="lineCov">         27 :                         count--;</span>
<span class="lineNum">    4449 </span><span class="lineCov">         27 :                         continue;</span>
<span class="lineNum">    4450 </span>            :                 }
<span class="lineNum">    4451 </span>            : 
<span class="lineNum">    4452 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">    4453 </span>            :                 if (inherit_traf_from_track)
<span class="lineNum">    4454 </span>            :                         gf_isom_enable_traf_inherit(ctx-&gt;file, tkw-&gt;track_id, inherit_traf_from_track);
<span class="lineNum">    4455 </span>            : #endif
<span class="lineNum">    4456 </span>            : 
<span class="lineNum">    4457 </span><span class="lineCov">        362 :                 if (!tkw-&gt;box_patched) {</span>
<span class="lineNum">    4458 </span><span class="lineCov">        353 :                         p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;boxpatch&quot;);</span>
<span class="lineNum">    4459 </span><span class="lineCov">        353 :                         if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    4460 </span><span class="lineNoCov">          0 :                                 e = gf_isom_apply_box_patch(ctx-&gt;file, tkw-&gt;track_id, p-&gt;value.string, GF_FALSE);</span>
<span class="lineNum">    4461 </span><span class="lineNoCov">          0 :                                 if (e) {</span>
<span class="lineNum">    4462 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to apply box patch %s to track %d: %s\n&quot;,</span>
<span class="lineNum">    4463 </span>            :                                                 p-&gt;value.string, tkw-&gt;track_id, gf_error_to_string(e) ));
<span class="lineNum">    4464 </span>            :                                 }
<span class="lineNum">    4465 </span>            :                         }
<span class="lineNum">    4466 </span><span class="lineCov">        353 :                         tkw-&gt;box_patched = GF_TRUE;</span>
<span class="lineNum">    4467 </span>            :                 }
<span class="lineNum">    4468 </span>            : 
<span class="lineNum">    4469 </span><span class="lineCov">        362 :                 p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_DASH_SEGMENTS);</span>
<span class="lineNum">    4470 </span><span class="lineCov">        362 :                 if (p &amp;&amp; (p-&gt;value.uint&gt;nb_segments))</span>
<span class="lineNum">    4471 </span>            :                         nb_segments = p-&gt;value.uint;
<span class="lineNum">    4472 </span>            : 
<span class="lineNum">    4473 </span><span class="lineCov">        362 :                 if (!ctx-&gt;dash_mode)</span>
<span class="lineNum">    4474 </span><span class="lineCov">         28 :                         gf_isom_purge_track_reference(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    4475 </span>            :         }
<span class="lineNum">    4476 </span>            : 
<span class="lineNum">    4477 </span><span class="lineCov">        666 :         if (max_dur.num &amp;&amp; max_dur.den) {</span>
<span class="lineNum">    4478 </span><span class="lineCov">        327 :                 u64 mdur = max_dur.num;</span>
<span class="lineNum">    4479 </span><span class="lineCov">        327 :                 if (ctx-&gt;moovts != max_dur.den) {</span>
<span class="lineNum">    4480 </span><span class="lineCov">        290 :                         mdur *= (u32) ctx-&gt;moovts;</span>
<span class="lineNum">    4481 </span><span class="lineCov">        290 :                         mdur /= max_dur.den;</span>
<span class="lineNum">    4482 </span>            :                 }
<span class="lineNum">    4483 </span><span class="lineCov">        327 :                 gf_isom_set_movie_duration(ctx-&gt;file, mdur, GF_FALSE);</span>
<span class="lineNum">    4484 </span>            :         }
<span class="lineNum">    4485 </span><span class="lineCov">         12 :         else if (ctx-&gt;cmaf) {</span>
<span class="lineNum">    4486 </span>            :                 //CMAF 7.3.2.1.c.6) &quot;The MovieExtendsBox may contain a MovieExtendsHeaderBox,
<span class="lineNum">    4487 </span>            :                 //as defined in ISO/IEC 14496-12, and if so, shall provide the overall duration
<span class="lineNum">    4488 </span>            :                 //of the CMAF track. If the duration is unknown, this box shall be omitted.&quot;
<span class="lineNum">    4489 </span><span class="lineNoCov">          0 :                 gf_isom_set_movie_duration(ctx-&gt;file, 0, GF_TRUE);</span>
<span class="lineNum">    4490 </span>            :         }
<span class="lineNum">    4491 </span>            : 
<span class="lineNum">    4492 </span>            :         //if we have an explicit track reference for fragmenting, move it first in our list
<span class="lineNum">    4493 </span><span class="lineCov">        339 :         if (ref_tkw) {</span>
<span class="lineNum">    4494 </span><span class="lineCov">        230 :                 gf_list_del_item(ctx-&gt;tracks, ref_tkw);</span>
<span class="lineNum">    4495 </span><span class="lineCov">        230 :                 gf_list_insert(ctx-&gt;tracks, ref_tkw, 0);</span>
<span class="lineNum">    4496 </span>            :         }
<span class="lineNum">    4497 </span><span class="lineCov">        339 :         ctx-&gt;ref_tkw = gf_list_get(ctx-&gt;tracks, 0);</span>
<span class="lineNum">    4498 </span>            : 
<span class="lineNum">    4499 </span><span class="lineCov">        339 :         if (!ctx-&gt;abs_offset) {</span>
<span class="lineNum">    4500 </span><span class="lineCov">        335 :                 u32 mval = ctx-&gt;dash_mode ? '6' : '5';</span>
<span class="lineNum">    4501 </span>            :                 u32 mbrand, mcount, found=0;
<span class="lineNum">    4502 </span>            :                 u8 szB[GF_4CC_MSIZE];
<span class="lineNum">    4503 </span><span class="lineCov">        335 :                 gf_isom_set_fragment_option(ctx-&gt;file, 0, GF_ISOM_TFHD_FORCE_MOOF_BASE_OFFSET, 1);</span>
<span class="lineNum">    4504 </span>            : 
<span class="lineNum">    4505 </span><span class="lineCov">        335 :                 gf_isom_get_brand_info(ctx-&gt;file, &amp;mbrand, NULL, &amp;mcount);</span>
<span class="lineNum">    4506 </span><span class="lineCov">        335 :                 strcpy(szB, gf_4cc_to_str(mbrand));</span>
<span class="lineNum">    4507 </span><span class="lineCov">        335 :                 if (!strncmp(szB, &quot;iso&quot;, 3) &amp;&amp; (szB[3] &gt;= mval) &amp;&amp; (szB[3] &lt;= 'F') ) found = 1;</span>
<span class="lineNum">    4508 </span>            :                 i=0;
<span class="lineNum">    4509 </span><span class="lineCov">       1143 :                 while (!found &amp;&amp; (i&lt;mcount)) {</span>
<span class="lineNum">    4510 </span><span class="lineCov">        485 :                         i++;</span>
<span class="lineNum">    4511 </span><span class="lineCov">        485 :                         gf_isom_get_alternate_brand(ctx-&gt;file, i, &amp;mbrand);</span>
<span class="lineNum">    4512 </span><span class="lineCov">        485 :                         strcpy(szB, gf_4cc_to_str(mbrand));</span>
<span class="lineNum">    4513 </span><span class="lineCov">        485 :                         if (!strncmp(szB, &quot;iso&quot;, 3) &amp;&amp; (szB[3] &gt;= mval) &amp;&amp; (szB[3] &lt;= 'F') ) found = 1;</span>
<span class="lineNum">    4514 </span>            :                 }
<span class="lineNum">    4515 </span>            : 
<span class="lineNum">    4516 </span>            :                 /*because of movie fragments MOOF based offset, ISOM &lt;4 is forbidden*/
<span class="lineNum">    4517 </span><span class="lineCov">        335 :                 if (!found) {</span>
<span class="lineNum">    4518 </span><span class="lineCov">        273 :                         gf_isom_set_brand_info(ctx-&gt;file, ctx-&gt;dash_mode ? GF_ISOM_BRAND_ISO6 : GF_ISOM_BRAND_ISO5, 1);</span>
<span class="lineNum">    4519 </span>            :                 }
<span class="lineNum">    4520 </span>            : 
<span class="lineNum">    4521 </span><span class="lineCov">        335 :                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISOM, GF_FALSE);</span>
<span class="lineNum">    4522 </span><span class="lineCov">        335 :                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO1, GF_FALSE);</span>
<span class="lineNum">    4523 </span><span class="lineCov">        335 :                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO2, GF_FALSE);</span>
<span class="lineNum">    4524 </span><span class="lineCov">        335 :                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO3, GF_FALSE);</span>
<span class="lineNum">    4525 </span><span class="lineCov">        335 :                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO4, GF_FALSE);</span>
<span class="lineNum">    4526 </span><span class="lineCov">        335 :                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_AVC1, GF_FALSE);</span>
<span class="lineNum">    4527 </span><span class="lineCov">        335 :                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_MP41, GF_FALSE);</span>
<span class="lineNum">    4528 </span><span class="lineCov">        335 :                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_MP42, GF_FALSE);</span>
<span class="lineNum">    4529 </span>            :         }
<span class="lineNum">    4530 </span>            : 
<span class="lineNum">    4531 </span><span class="lineCov">        339 :         if (ctx-&gt;dash_mode) {</span>
<span class="lineNum">    4532 </span>            :                 /*DASH self-init media segment*/
<span class="lineNum">    4533 </span><span class="lineCov">        326 :                 if (ctx-&gt;dash_mode==MP4MX_DASH_VOD) {</span>
<span class="lineNum">    4534 </span><span class="lineCov">         17 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_DSMS, GF_TRUE);</span>
<span class="lineNum">    4535 </span>            :                 } else {
<span class="lineNum">    4536 </span><span class="lineCov">        309 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_DASH, GF_TRUE);</span>
<span class="lineNum">    4537 </span>            :                 }
<span class="lineNum">    4538 </span><span class="lineCov">        326 :                 gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_MSIX, ((ctx-&gt;dash_mode==MP4MX_DASH_VOD) &amp;&amp; (ctx-&gt;subs_sidx&gt;=0)) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    4539 </span>            :         }
<span class="lineNum">    4540 </span>            : 
<span class="lineNum">    4541 </span><span class="lineCov">        339 :         if (ctx-&gt;boxpatch &amp;&amp; !ctx-&gt;box_patched) {</span>
<span class="lineNum">    4542 </span><span class="lineCov">          1 :                 e = gf_isom_apply_box_patch(ctx-&gt;file, 0, ctx-&gt;boxpatch, GF_FALSE);</span>
<span class="lineNum">    4543 </span><span class="lineCov">          1 :                 if (e) {</span>
<span class="lineNum">    4544 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to apply box patch %s: %s\n&quot;, ctx-&gt;boxpatch, gf_error_to_string(e) ));</span>
<span class="lineNum">    4545 </span>            :                 }
<span class="lineNum">    4546 </span><span class="lineCov">          1 :                 ctx-&gt;box_patched = GF_TRUE;</span>
<span class="lineNum">    4547 </span>            :         }
<span class="lineNum">    4548 </span>            : 
<span class="lineNum">    4549 </span><span class="lineCov">        339 :         e = gf_isom_finalize_for_fragment(ctx-&gt;file, ctx-&gt;dash_mode ? 1 : 0, ctx-&gt;mvex);</span>
<span class="lineNum">    4550 </span><span class="lineCov">        339 :         if (e) {</span>
<span class="lineNum">    4551 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to finalize moov for fragmentation: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    4552 </span>            :                 return e;
<span class="lineNum">    4553 </span>            :         }
<span class="lineNum">    4554 </span><span class="lineCov">        339 :         ctx-&gt;init_movie_done = GF_TRUE;</span>
<span class="lineNum">    4555 </span>            : 
<span class="lineNum">    4556 </span><span class="lineCov">        339 :         if (min_dts_scale) {</span>
<span class="lineNum">    4557 </span>            :                 u64 rs_dts = min_dts;
<span class="lineNum">    4558 </span><span class="lineCov">        339 :                 rs_dts *= ctx-&gt;cdur.den;</span>
<span class="lineNum">    4559 </span><span class="lineCov">        339 :                 rs_dts /= min_dts_scale;</span>
<span class="lineNum">    4560 </span><span class="lineCov">        339 :                 ctx-&gt;next_frag_start = rs_dts;</span>
<span class="lineNum">    4561 </span>            :         }
<span class="lineNum">    4562 </span><span class="lineCov">        339 :         ctx-&gt;next_frag_start += ctx-&gt;cdur.num;</span>
<span class="lineNum">    4563 </span><span class="lineCov">        339 :         ctx-&gt;adjusted_next_frag_start = ctx-&gt;next_frag_start;</span>
<span class="lineNum">    4564 </span><span class="lineCov">        339 :         ctx-&gt;fragment_started = GF_FALSE;</span>
<span class="lineNum">    4565 </span>            : 
<span class="lineNum">    4566 </span><span class="lineCov">        339 :         if (ctx-&gt;noinit) {</span>
<span class="lineNum">    4567 </span><span class="lineCov">         45 :                 if (ctx-&gt;dst_pck) gf_filter_pck_discard(ctx-&gt;dst_pck);</span>
<span class="lineNum">    4568 </span><span class="lineCov">         45 :                 ctx-&gt;dst_pck = NULL;</span>
<span class="lineNum">    4569 </span><span class="lineCov">         45 :                 ctx-&gt;current_size = ctx-&gt;current_offset = 0;</span>
<span class="lineNum">    4570 </span><span class="lineCov">         45 :                 ctx-&gt;first_pck_sent = GF_FALSE;</span>
<span class="lineNum">    4571 </span>            :         } else {
<span class="lineNum">    4572 </span><span class="lineCov">        294 :                 mp4_mux_flush_seg(ctx, GF_TRUE, 0, 0);</span>
<span class="lineNum">    4573 </span>            :         }
<span class="lineNum">    4574 </span>            :         assert(!ctx-&gt;dst_pck);
<span class="lineNum">    4575 </span>            : 
<span class="lineNum">    4576 </span>            :         //change major brand for segments
<span class="lineNum">    4577 </span><span class="lineCov">        339 :         if (ctx-&gt;styp &amp;&amp; (strlen(ctx-&gt;styp)&gt;=4)) {</span>
<span class="lineNum">    4578 </span><span class="lineNoCov">          0 :                 u32 styp_brand = GF_4CC(ctx-&gt;styp[0], ctx-&gt;styp[1], ctx-&gt;styp[2], ctx-&gt;styp[3]);</span>
<span class="lineNum">    4579 </span>            :                 u32 version = 0;
<span class="lineNum">    4580 </span><span class="lineNoCov">          0 :                 char *sep = strchr(ctx-&gt;styp, '.');</span>
<span class="lineNum">    4581 </span><span class="lineNoCov">          0 :                 if (sep) version = atoi(sep+1);</span>
<span class="lineNum">    4582 </span><span class="lineNoCov">          0 :                 gf_isom_set_brand_info(ctx-&gt;file, styp_brand, version);</span>
<span class="lineNum">    4583 </span>            :         }
<span class="lineNum">    4584 </span>            : 
<span class="lineNum">    4585 </span><span class="lineCov">        339 :         if (ctx-&gt;dash_mode==MP4MX_DASH_VOD) {</span>
<span class="lineNum">    4586 </span><span class="lineCov">         17 :                 if ((ctx-&gt;vodcache==MP4MX_VODCACHE_REPLACE) &amp;&amp; !nb_segments &amp;&amp; (!ctx-&gt;media_dur || !ctx-&gt;dash_dur.num) ) {</span>
<span class="lineNum">    4587 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Media duration unknown, cannot use replace mode of vodcache, using temp file for VoD storage\n&quot;));</span>
<span class="lineNum">    4588 </span><span class="lineNoCov">          0 :                         ctx-&gt;vodcache = MP4MX_VODCACHE_ON;</span>
<span class="lineNum">    4589 </span><span class="lineNoCov">          0 :                         e = mp4mx_setup_dash_vod(ctx, NULL);</span>
<span class="lineNum">    4590 </span><span class="lineNoCov">          0 :                         if (e) return e;</span>
<span class="lineNum">    4591 </span>            :                 }
<span class="lineNum">    4592 </span>            : 
<span class="lineNum">    4593 </span><span class="lineCov">         17 :                 if (ctx-&gt;vodcache==MP4MX_VODCACHE_REPLACE) {</span>
<span class="lineNum">    4594 </span>            :                         GF_BitStream *bs;
<span class="lineNum">    4595 </span>            :                         u8 *output;
<span class="lineNum">    4596 </span>            :                         char *msg;
<span class="lineNum">    4597 </span>            :                         GF_FilterPacket *pck;
<span class="lineNum">    4598 </span>            :                         u32 len;
<span class="lineNum">    4599 </span>            :                         Bool exact_sidx = GF_TRUE;
<span class="lineNum">    4600 </span>            : 
<span class="lineNum">    4601 </span><span class="lineNoCov">          0 :                         if (!nb_segments) {</span>
<span class="lineNum">    4602 </span>            :                                 exact_sidx = GF_FALSE;
<span class="lineNum">    4603 </span><span class="lineNoCov">          0 :                                 nb_segments = (u32) ( ctx-&gt;media_dur * ctx-&gt;dash_dur.den / ctx-&gt;dash_dur.num);</span>
<span class="lineNum">    4604 </span>            :                                 //always add an extra segment
<span class="lineNum">    4605 </span><span class="lineNoCov">          0 :                                 nb_segments ++;</span>
<span class="lineNum">    4606 </span>            :                                 //and safety alloc of 10%
<span class="lineNum">    4607 </span><span class="lineNoCov">          0 :                                 if (nb_segments&gt;10)</span>
<span class="lineNum">    4608 </span><span class="lineNoCov">          0 :                                         nb_segments += 10*nb_segments/100;</span>
<span class="lineNum">    4609 </span>            :                                 else
<span class="lineNum">    4610 </span><span class="lineNoCov">          0 :                                         nb_segments ++;</span>
<span class="lineNum">    4611 </span>            :                         }
<span class="lineNum">    4612 </span>            : 
<span class="lineNum">    4613 </span>            :                         //max sidx size: full box + sidx fields + timing 64 bit + nb segs (each 12 bytes)
<span class="lineNum">    4614 </span><span class="lineNoCov">          0 :                         ctx-&gt;sidx_max_size = 12 + (12 + 16) + 12 * nb_segments;</span>
<span class="lineNum">    4615 </span>            : 
<span class="lineNum">    4616 </span>            :                         //we produce an ssix, add full box + nb subsegs + nb_segments * (range_count=2 + 2*(range+size))
<span class="lineNum">    4617 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;ssix) {</span>
<span class="lineNum">    4618 </span><span class="lineNoCov">          0 :                                 ctx-&gt;sidx_max_size += 12 + 4 + nb_segments * 12;</span>
<span class="lineNum">    4619 </span>            :                         }
<span class="lineNum">    4620 </span>            : 
<span class="lineNum">    4621 </span><span class="lineNoCov">          0 :                         if (!exact_sidx) {</span>
<span class="lineNum">    4622 </span>            :                                 //and a free box
<span class="lineNum">    4623 </span><span class="lineNoCov">          0 :                                 ctx-&gt;sidx_max_size += 8;</span>
<span class="lineNum">    4624 </span><span class="lineNoCov">          0 :                                 ctx-&gt;sidx_size_exact = GF_FALSE;</span>
<span class="lineNum">    4625 </span>            :                         } else {
<span class="lineNum">    4626 </span><span class="lineNoCov">          0 :                                 ctx-&gt;sidx_size_exact = GF_TRUE;</span>
<span class="lineNum">    4627 </span>            :                         }
<span class="lineNum">    4628 </span><span class="lineNoCov">          0 :                         ctx-&gt;sidx_chunk_offset = (u32) (ctx-&gt;current_offset + ctx-&gt;current_size);</span>
<span class="lineNum">    4629 </span>            :                         //send a dummy packet
<span class="lineNum">    4630 </span><span class="lineNoCov">          0 :                         pck = gf_filter_pck_new_alloc(ctx-&gt;opid, ctx-&gt;sidx_max_size, &amp;output);</span>
<span class="lineNum">    4631 </span><span class="lineNoCov">          0 :                         if (!pck) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    4632 </span>            : 
<span class="lineNum">    4633 </span><span class="lineNoCov">          0 :                         gf_filter_pck_set_framing(pck, GF_FALSE, GF_FALSE);</span>
<span class="lineNum">    4634 </span>            :                         //format as free box for now
<span class="lineNum">    4635 </span><span class="lineNoCov">          0 :                         bs = gf_bs_new(output, ctx-&gt;sidx_max_size, GF_BITSTREAM_WRITE);</span>
<span class="lineNum">    4636 </span><span class="lineNoCov">          0 :                         gf_bs_write_u32(bs, ctx-&gt;sidx_max_size);</span>
<span class="lineNum">    4637 </span><span class="lineNoCov">          0 :                         gf_bs_write_u32(bs, GF_ISOM_BOX_TYPE_FREE);</span>
<span class="lineNum">    4638 </span>            :                         msg = &quot;GPAC &quot; GPAC_VERSION&quot; SIDX placeholder&quot;;
<span class="lineNum">    4639 </span>            :                         len = (u32) strlen(msg);
<span class="lineNum">    4640 </span><span class="lineNoCov">          0 :                         if (len+8&gt;ctx-&gt;sidx_max_size) len = ctx-&gt;sidx_max_size - 8;</span>
<span class="lineNum">    4641 </span><span class="lineNoCov">          0 :                         gf_bs_write_data(bs, msg, len );</span>
<span class="lineNum">    4642 </span><span class="lineNoCov">          0 :                         gf_bs_del(bs);</span>
<span class="lineNum">    4643 </span><span class="lineNoCov">          0 :                         gf_filter_pck_send(pck);</span>
<span class="lineNum">    4644 </span><span class="lineCov">         17 :                 } else if (ctx-&gt;vodcache==MP4MX_VODCACHE_ON) {</span>
<span class="lineNum">    4645 </span><span class="lineCov">         17 :                         ctx-&gt;store_output = GF_TRUE;</span>
<span class="lineNum">    4646 </span>            :                 } else {
<span class="lineNum">    4647 </span><span class="lineNoCov">          0 :                         ctx-&gt;store_output = GF_FALSE;</span>
<span class="lineNum">    4648 </span><span class="lineNoCov">          0 :                         ctx-&gt;sidx_chunk_offset = (u32) (ctx-&gt;current_offset + ctx-&gt;current_size);</span>
<span class="lineNum">    4649 </span>            :                 }
<span class="lineNum">    4650 </span><span class="lineCov">         17 :                 gf_isom_allocate_sidx(ctx-&gt;file, ctx-&gt;subs_sidx, ctx-&gt;chain_sidx, 0, NULL, NULL, NULL, ctx-&gt;ssix);</span>
<span class="lineNum">    4651 </span>            :         }
<span class="lineNum">    4652 </span>            :         return GF_OK;
<a name="4653"><span class="lineNum">    4653 </span>            : }</a>
<span class="lineNum">    4654 </span>            : 
<span class="lineNum">    4655 </span><span class="lineCov">       3571 : static GF_Err mp4_mux_start_fragment(GF_MP4MuxCtx *ctx, GF_FilterPacket *pck)</span>
<span class="lineNum">    4656 </span>            : {
<span class="lineNum">    4657 </span>            :         GF_Err e;
<span class="lineNum">    4658 </span><span class="lineCov">       3571 :         u32 i, count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    4659 </span><span class="lineCov">       3571 :         Bool has_tfdt=GF_FALSE;</span>
<span class="lineNum">    4660 </span>            :         GF_ISOStartFragmentFlags flags=0;
<span class="lineNum">    4661 </span>            : 
<span class="lineNum">    4662 </span>            :         //setup some default
<span class="lineNum">    4663 </span><span class="lineCov">       3571 :         gf_isom_set_next_moof_number(ctx-&gt;file, ctx-&gt;msn);</span>
<span class="lineNum">    4664 </span><span class="lineCov">       3571 :         ctx-&gt;msn += ctx-&gt;msninc;</span>
<span class="lineNum">    4665 </span><span class="lineCov">       3571 :         ctx-&gt;min_cts_plus_one = 0;</span>
<span class="lineNum">    4666 </span>            : 
<span class="lineNum">    4667 </span><span class="lineCov">       3571 :         if (ctx-&gt;moof_first) flags |= GF_ISOM_FRAG_MOOF_FIRST;</span>
<span class="lineNum">    4668 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">    4669 </span>            :         if (ctx-&gt;ctrn) flags |= GF_ISOM_FRAG_USE_COMPACT;
<span class="lineNum">    4670 </span>            : #endif
<span class="lineNum">    4671 </span>            : 
<span class="lineNum">    4672 </span><span class="lineCov">       3571 :         e = gf_isom_start_fragment(ctx-&gt;file, flags);</span>
<span class="lineNum">    4673 </span><span class="lineCov">       3571 :         if (e) {</span>
<span class="lineNum">    4674 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to start new fragment: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    4675 </span>            :                 return e;
<span class="lineNum">    4676 </span>            :         }
<span class="lineNum">    4677 </span><span class="lineCov">       3571 :         if (pck) {</span>
<span class="lineNum">    4678 </span><span class="lineCov">        123 :                 const GF_PropertyValue *p = gf_filter_pck_get_property(pck, GF_PROP_PCK_MOOF_TEMPLATE);</span>
<span class="lineNum">    4679 </span><span class="lineCov">        123 :                 if (p &amp;&amp; p-&gt;value.data.ptr) {</span>
<span class="lineNum">    4680 </span><span class="lineCov">         57 :                         GF_SegmentIndexBox *out_sidx = NULL;</span>
<span class="lineNum">    4681 </span><span class="lineCov">         57 :                         gf_isom_set_fragment_template(ctx-&gt;file, p-&gt;value.data.ptr, p-&gt;value.data.size, &amp;has_tfdt, &amp;out_sidx);</span>
<span class="lineNum">    4682 </span><span class="lineCov">         57 :                         if (out_sidx) {</span>
<span class="lineNum">    4683 </span><span class="lineCov">         57 :                                 if (ctx-&gt;cloned_sidx) gf_isom_box_del((GF_Box *)ctx-&gt;cloned_sidx);</span>
<span class="lineNum">    4684 </span><span class="lineCov">         57 :                                 ctx-&gt;cloned_sidx = out_sidx;</span>
<span class="lineNum">    4685 </span><span class="lineCov">         57 :                                 ctx-&gt;cloned_sidx_index = 0;</span>
<span class="lineNum">    4686 </span>            :                         }
<span class="lineNum">    4687 </span>            :                 }
<span class="lineNum">    4688 </span>            :         }
<span class="lineNum">    4689 </span>            : 
<span class="lineNum">    4690 </span>            :         //setup some default
<span class="lineNum">    4691 </span><span class="lineCov">       3772 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    4692 </span><span class="lineCov">       3772 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    4693 </span>            :                 e = GF_OK;
<span class="lineNum">    4694 </span><span class="lineCov">       3772 :                 if (ctx-&gt;strun) {</span>
<span class="lineNum">    4695 </span><span class="lineCov">         57 :                         e = gf_isom_set_fragment_option(ctx-&gt;file, tkw-&gt;track_id, GF_ISOM_TRAF_RANDOM_ACCESS, 0);</span>
<span class="lineNum">    4696 </span>            :                 }
<span class="lineNum">    4697 </span>            :                 //fragment at sap boundaries for video, but not in dash mode (compatibility with old arch)
<span class="lineNum">    4698 </span><span class="lineCov">       3715 :                 else if (ctx-&gt;fsap &amp;&amp; (tkw-&gt;stream_type == GF_STREAM_VISUAL) &amp;&amp; !ctx-&gt;dash_mode) {</span>
<span class="lineNum">    4699 </span><span class="lineCov">         80 :                         e = gf_isom_set_fragment_option(ctx-&gt;file, tkw-&gt;track_id, GF_ISOM_TRAF_RANDOM_ACCESS, 1);</span>
<span class="lineNum">    4700 </span>            :                 }
<span class="lineNum">    4701 </span><span class="lineCov">        137 :                 if (e) {</span>
<span class="lineNum">    4702 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable set fragment options: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    4703 </span>            :                 }
<span class="lineNum">    4704 </span><span class="lineCov">       3772 :                 tkw-&gt;fragment_done = GF_FALSE;</span>
<span class="lineNum">    4705 </span><span class="lineCov">       3772 :                 tkw-&gt;insert_tfdt = (has_tfdt || ctx-&gt;tfdt_traf) ? GF_TRUE : ctx-&gt;insert_tfdt;</span>
<span class="lineNum">    4706 </span><span class="lineCov">       3772 :                 tkw-&gt;dur_in_frag = 0;</span>
<span class="lineNum">    4707 </span>            : 
<span class="lineNum">    4708 </span><span class="lineCov">       3772 :                 if (ctx-&gt;trun_inter) {</span>
<span class="lineNum">    4709 </span><span class="lineNoCov">          0 :                         gf_isom_set_fragment_option(ctx-&gt;file, tkw-&gt;track_id, GF_ISOM_TRUN_SET_INTERLEAVE_ID, 0);</span>
<span class="lineNum">    4710 </span>            :                 }
<span class="lineNum">    4711 </span><span class="lineCov">       3772 :                 if (ctx-&gt;truns_first) {</span>
<span class="lineNum">    4712 </span><span class="lineNoCov">          0 :                         gf_isom_set_fragment_option(ctx-&gt;file, tkw-&gt;track_id, GF_ISOM_TRAF_TRUNS_FIRST, 1);</span>
<span class="lineNum">    4713 </span>            :                 }
<span class="lineNum">    4714 </span>            :                 //7.7 cmf2 For video CMAF Tracks not contained in Track Files, Version 1 shall be used.
<span class="lineNum">    4715 </span><span class="lineCov">       3772 :                 if ((ctx-&gt;cmaf==MP4MX_CMAF_CMF2) &amp;&amp; (tkw-&gt;stream_type==GF_STREAM_VISUAL))</span>
<span class="lineNum">    4716 </span><span class="lineNoCov">          0 :                         gf_isom_set_fragment_option(ctx-&gt;file, tkw-&gt;track_id, GF_ISOM_TRAF_TRUN_V1, 1);</span>
<span class="lineNum">    4717 </span>            : 
<span class="lineNum">    4718 </span><span class="lineCov">       3772 :                 if (ctx-&gt;sdtp_traf)</span>
<span class="lineNum">    4719 </span><span class="lineNoCov">          0 :                         gf_isom_set_fragment_option(ctx-&gt;file, tkw-&gt;track_id, GF_ISOM_TRAF_USE_SAMPLE_DEPS_BOX, ctx-&gt;sdtp_traf);</span>
<span class="lineNum">    4720 </span>            : 
<span class="lineNum">    4721 </span><span class="lineCov">       3772 :                 if (ctx-&gt;tfdt64)</span>
<span class="lineNum">    4722 </span><span class="lineNoCov">          0 :                         gf_isom_set_fragment_option(ctx-&gt;file, tkw-&gt;track_id, GF_ISOM_TRAF_USE_LARGE_TFDT, ctx-&gt;tfdt64);</span>
<span class="lineNum">    4723 </span>            : 
<span class="lineNum">    4724 </span><span class="lineCov">       3772 :                 if (ctx-&gt;insert_pssh)</span>
<span class="lineNum">    4725 </span><span class="lineNoCov">          0 :                         mp4_mux_cenc_insert_pssh(ctx, tkw);</span>
<span class="lineNum">    4726 </span>            :         }
<span class="lineNum">    4727 </span><span class="lineCov">       3571 :         ctx-&gt;fragment_started = GF_TRUE;</span>
<span class="lineNum">    4728 </span><span class="lineCov">       3571 :         ctx-&gt;insert_tfdt = GF_FALSE;</span>
<span class="lineNum">    4729 </span><span class="lineCov">       3571 :         ctx-&gt;insert_pssh = GF_FALSE;</span>
<span class="lineNum">    4730 </span><span class="lineCov">       3571 :         return GF_OK;</span>
<a name="4731"><span class="lineNum">    4731 </span>            : }</a>
<span class="lineNum">    4732 </span>            : 
<span class="lineNum">    4733 </span><span class="lineCov">       2618 : static GF_Err mp4_mux_flush_fragmented(GF_Filter *filter, GF_MP4MuxCtx *ctx)</span>
<span class="lineNum">    4734 </span>            : {
<span class="lineNum">    4735 </span>            :         GF_FilterPacket *pck;
<span class="lineNum">    4736 </span>            :         u8 *output;
<span class="lineNum">    4737 </span><span class="lineCov">       2618 :         u32 nb_read, blocksize = ctx-&gt;block_size;</span>
<span class="lineNum">    4738 </span><span class="lineCov">       2618 :         if (ctx-&gt;flush_done + blocksize&gt;ctx-&gt;flush_size) {</span>
<span class="lineNum">    4739 </span><span class="lineCov">         17 :                 blocksize = (u32) (ctx-&gt;flush_size - ctx-&gt;flush_done);</span>
<span class="lineNum">    4740 </span>            :         }
<span class="lineNum">    4741 </span><span class="lineCov">       2618 :         if (!blocksize) return GF_EOS;</span>
<span class="lineNum">    4742 </span><span class="lineCov">       2618 :         pck = gf_filter_pck_new_alloc(ctx-&gt;opid, blocksize, &amp;output);</span>
<span class="lineNum">    4743 </span><span class="lineCov">       2618 :         if (!pck) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    4744 </span>            : 
<span class="lineNum">    4745 </span><span class="lineCov">       2618 :         nb_read = (u32) gf_fread(output, blocksize, ctx-&gt;tmp_store);</span>
<span class="lineNum">    4746 </span><span class="lineCov">       2618 :         if (nb_read != blocksize) {</span>
<span class="lineNum">    4747 </span>            :                 char tmp[1];
<span class="lineNum">    4748 </span>            :                 //weird behavior on some file systems, dump debug info
<span class="lineNum">    4749 </span><span class="lineNoCov">          0 :                 gf_fread(tmp, 1, ctx-&gt;tmp_store);</span>
<span class="lineNum">    4750 </span><span class="lineNoCov">          0 :                 Bool is_eof = gf_feof(ctx-&gt;tmp_store);</span>
<span class="lineNum">    4751 </span><span class="lineNoCov">          0 :                 GF_LOG(is_eof ? GF_LOG_WARNING : GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error reading from VOD temp cache, read %d bytes but asked %d bytes\n\tCache EOF %d - cache size &quot;LLU&quot; - read pos &quot;LLU&quot; - file pos &quot;LLU&quot;\n&quot;, nb_read, blocksize, is_eof, ctx-&gt;flush_size, ctx-&gt;flush_done, gf_ftell(ctx-&gt;tmp_store)));</span>
<span class="lineNum">    4752 </span>            :         }
<span class="lineNum">    4753 </span><span class="lineCov">       2618 :         ctx-&gt;flush_done += nb_read;</span>
<span class="lineNum">    4754 </span><span class="lineCov">       2618 :         if (ctx-&gt;flush_done==ctx-&gt;flush_size) {</span>
<span class="lineNum">    4755 </span><span class="lineCov">         17 :                 gf_filter_pck_set_framing(pck, GF_FALSE, GF_TRUE);</span>
<span class="lineNum">    4756 </span><span class="lineCov">         17 :                 gf_filter_pck_send(pck);</span>
<span class="lineNum">    4757 </span><span class="lineCov">         17 :                 gf_filter_pid_set_eos(ctx-&gt;opid);</span>
<span class="lineNum">    4758 </span><span class="lineCov">         17 :                 return GF_EOS;</span>
<span class="lineNum">    4759 </span>            :         }
<span class="lineNum">    4760 </span><span class="lineCov">       2601 :         gf_filter_pck_set_framing(pck, GF_FALSE, GF_FALSE);</span>
<span class="lineNum">    4761 </span><span class="lineCov">       2601 :         gf_filter_pck_send(pck);</span>
<span class="lineNum">    4762 </span>            :         //we are not done flushing but we have no more input packets, signal we still need processing
<span class="lineNum">    4763 </span><span class="lineCov">       2601 :         gf_filter_ask_rt_reschedule(filter, 1);</span>
<span class="lineNum">    4764 </span><span class="lineCov">       2601 :         return GF_OK;</span>
<a name="4765"><span class="lineNum">    4765 </span>            : }</a>
<span class="lineNum">    4766 </span>            : 
<span class="lineNum">    4767 </span><span class="lineCov">       3571 : static void mp4mx_frag_box_patch(GF_MP4MuxCtx *ctx)</span>
<span class="lineNum">    4768 </span>            : {
<span class="lineNum">    4769 </span>            :         GF_Err e;
<span class="lineNum">    4770 </span><span class="lineCov">       3571 :         u32 i, count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    4771 </span><span class="lineCov">       7343 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    4772 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">    4773 </span><span class="lineCov">       3772 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    4774 </span><span class="lineCov">       3772 :                 if (!tkw-&gt;track_id) continue;</span>
<span class="lineNum">    4775 </span>            :                 //no box patched set (todo, do we want to allow changing boxpatch props ?)
<span class="lineNum">    4776 </span><span class="lineCov">       3772 :                 if (!tkw-&gt;box_patched) continue;</span>
<span class="lineNum">    4777 </span>            : 
<span class="lineNum">    4778 </span><span class="lineCov">       3772 :                 p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;boxpatch&quot;);</span>
<span class="lineNum">    4779 </span><span class="lineCov">       3772 :                 if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    4780 </span><span class="lineNoCov">          0 :                         e = gf_isom_apply_box_patch(ctx-&gt;file, tkw-&gt;track_id ? tkw-&gt;track_id : tkw-&gt;item_id, p-&gt;value.string, GF_TRUE);</span>
<span class="lineNum">    4781 </span><span class="lineNoCov">          0 :                         if (e) {</span>
<span class="lineNum">    4782 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to apply box patch %s to track fragment %d: %s\n&quot;,</span>
<span class="lineNum">    4783 </span>            :                                         p-&gt;value.string, tkw-&gt;track_id, gf_error_to_string(e) ));
<span class="lineNum">    4784 </span>            :                         }
<span class="lineNum">    4785 </span>            :                 }
<span class="lineNum">    4786 </span>            :         }
<span class="lineNum">    4787 </span>            : 
<span class="lineNum">    4788 </span><span class="lineCov">       3571 :         if (ctx-&gt;boxpatch) {</span>
<span class="lineNum">    4789 </span><span class="lineCov">          2 :                 e = gf_isom_apply_box_patch(ctx-&gt;file, 0, ctx-&gt;boxpatch, GF_TRUE);</span>
<span class="lineNum">    4790 </span><span class="lineCov">          2 :                 if (e) {</span>
<span class="lineNum">    4791 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to apply box patch %s to fragment: %s\n&quot;, ctx-&gt;boxpatch, gf_error_to_string(e) ));</span>
<span class="lineNum">    4792 </span>            :                 }
<span class="lineNum">    4793 </span><span class="lineCov">          2 :                 ctx-&gt;box_patched = GF_TRUE;</span>
<span class="lineNum">    4794 </span>            :         }
<span class="lineNum">    4795 </span><span class="lineCov">       3571 : }</span>
<span class="lineNum">    4796 </span>            : 
<span class="lineNum">    4797 </span>            : 
<a name="4798"><span class="lineNum">    4798 </span>            : static GF_Err mp4_mux_initialize(GF_Filter *filter);</a>
<span class="lineNum">    4799 </span>            : 
<span class="lineNum">    4800 </span><span class="lineCov">         60 : GF_Err mp4mx_reload_output(GF_Filter *filter, GF_MP4MuxCtx *ctx)</span>
<span class="lineNum">    4801 </span>            : {
<span class="lineNum">    4802 </span>            :         GF_Err e;
<span class="lineNum">    4803 </span><span class="lineCov">         60 :         u32 i, count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    4804 </span>            : 
<span class="lineNum">    4805 </span>            :         //done with the file
<span class="lineNum">    4806 </span><span class="lineCov">         60 :         if (ctx-&gt;file) {</span>
<span class="lineNum">    4807 </span><span class="lineCov">         60 :                 e = mp4_mux_done(filter, ctx, GF_FALSE);</span>
<span class="lineNum">    4808 </span><span class="lineCov">         60 :                 if (e) return e;</span>
<span class="lineNum">    4809 </span><span class="lineCov">         60 :                 ctx-&gt;file = NULL;</span>
<span class="lineNum">    4810 </span>            :         }
<span class="lineNum">    4811 </span><span class="lineCov">         60 :         ctx-&gt;init_movie_done = GF_FALSE;</span>
<span class="lineNum">    4812 </span><span class="lineCov">         60 :         e = mp4_mux_initialize(filter);</span>
<span class="lineNum">    4813 </span><span class="lineCov">         60 :         if (e) return e;</span>
<span class="lineNum">    4814 </span><span class="lineCov">         60 :         ctx-&gt;config_timing = GF_TRUE;</span>
<span class="lineNum">    4815 </span>            : 
<span class="lineNum">    4816 </span><span class="lineCov">        158 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    4817 </span><span class="lineCov">         98 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    4818 </span><span class="lineCov">         98 :                 tkw-&gt;suspended = GF_FALSE;</span>
<span class="lineNum">    4819 </span><span class="lineCov">         98 :                 tkw-&gt;track_num = 0;</span>
<span class="lineNum">    4820 </span><span class="lineCov">         98 :                 tkw-&gt;nb_samples = 0;</span>
<span class="lineNum">    4821 </span><span class="lineCov">         98 :                 tkw-&gt;max_cts = 0;</span>
<span class="lineNum">    4822 </span><span class="lineCov">         98 :                 tkw-&gt;min_cts = (u64) -1;</span>
<span class="lineNum">    4823 </span><span class="lineCov">         98 :                 e = mp4_mux_configure_pid(filter, tkw-&gt;ipid, GF_FALSE);</span>
<span class="lineNum">    4824 </span><span class="lineCov">         98 :                 if (e) return e;</span>
<span class="lineNum">    4825 </span><span class="lineCov">         98 :                 tkw-&gt;nb_samples = 0;</span>
<span class="lineNum">    4826 </span><span class="lineCov">         98 :                 tkw-&gt;sample.DTS = 0;</span>
<span class="lineNum">    4827 </span><span class="lineCov">         98 :                 tkw-&gt;sample.CTS_Offset = 0;</span>
<span class="lineNum">    4828 </span><span class="lineCov">         98 :                 tkw-&gt;samples_in_stsd = 0;</span>
<span class="lineNum">    4829 </span><span class="lineCov">         98 :                 tkw-&gt;samples_in_frag = 0;</span>
<span class="lineNum">    4830 </span>            :         }
<span class="lineNum">    4831 </span>            :         assert(ctx-&gt;next_file_idx);
<span class="lineNum">    4832 </span><span class="lineCov">         60 :         ctx-&gt;cur_file_idx_plus_one = ctx-&gt;next_file_idx;</span>
<span class="lineNum">    4833 </span><span class="lineCov">         60 :         ctx-&gt;next_file_idx = 0;</span>
<span class="lineNum">    4834 </span><span class="lineCov">         60 :         ctx-&gt;notify_filename = GF_TRUE;</span>
<span class="lineNum">    4835 </span>            :         assert(!ctx-&gt;cur_file_suffix);
<span class="lineNum">    4836 </span><span class="lineCov">         60 :         if (ctx-&gt;next_file_suffix) {</span>
<span class="lineNum">    4837 </span><span class="lineCov">         60 :                 ctx-&gt;cur_file_suffix = gf_strdup(ctx-&gt;next_file_suffix);</span>
<span class="lineNum">    4838 </span><span class="lineCov">         60 :                 ctx-&gt;next_file_suffix = NULL;</span>
<span class="lineNum">    4839 </span>            :         }
<span class="lineNum">    4840 </span>            :         return GF_OK;
<span class="lineNum">    4841 </span>            : }
<a name="4842"><span class="lineNum">    4842 </span>            : </a>
<span class="lineNum">    4843 </span>            : 
<span class="lineNum">    4844 </span><span class="lineCov">     120838 : static GF_Err mp4_mux_process_fragmented(GF_Filter *filter, GF_MP4MuxCtx *ctx)</span>
<span class="lineNum">    4845 </span>            : {
<span class="lineNum">    4846 </span>            :         GF_Err e = GF_OK;
<span class="lineNum">    4847 </span>            :         u32 nb_eos, nb_done, nb_suspended, i, count;
<span class="lineNum">    4848 </span>            : 
<span class="lineNum">    4849 </span><span class="lineCov">     120838 :         if (ctx-&gt;flush_size) {</span>
<span class="lineNum">    4850 </span><span class="lineCov">       2618 :                 return mp4_mux_flush_fragmented(filter, ctx);</span>
<span class="lineNum">    4851 </span>            :         }
<span class="lineNum">    4852 </span>            : 
<span class="lineNum">    4853 </span><span class="lineCov">     118220 :         if (!ctx-&gt;file)</span>
<span class="lineNum">    4854 </span>            :                 return GF_EOS;
<span class="lineNum">    4855 </span>            : 
<span class="lineNum">    4856 </span>            :         //init movie not yet produced
<span class="lineNum">    4857 </span><span class="lineCov">     118220 :         if (!ctx-&gt;init_movie_done) {</span>
<span class="lineNum">    4858 </span><span class="lineCov">        339 :                 e = mp4_mux_initialize_movie(ctx);</span>
<span class="lineNum">    4859 </span><span class="lineCov">        339 :                 if (e) return e;</span>
<span class="lineNum">    4860 </span><span class="lineCov">        339 :                 if (!ctx-&gt;init_movie_done)</span>
<span class="lineNum">    4861 </span>            :                         return GF_OK;
<span class="lineNum">    4862 </span>            :         }
<span class="lineNum">    4863 </span>            :         /*get count after init, some tracks may have been remove*/
<span class="lineNum">    4864 </span><span class="lineCov">     118220 :         count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    4865 </span><span class="lineCov">     118220 :         if (ctx-&gt;dash_mode &amp;&amp; !ctx-&gt;segment_started) {</span>
<span class="lineNum">    4866 </span>            :                 //don't start a new segment if all pids are in eos
<span class="lineNum">    4867 </span>            :                 nb_eos=0;
<span class="lineNum">    4868 </span><span class="lineCov">       3207 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    4869 </span><span class="lineCov">       3207 :                         TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    4870 </span><span class="lineCov">       3207 :                         if (gf_filter_pid_is_eos(tkw-&gt;ipid)) {</span>
<span class="lineNum">    4871 </span><span class="lineCov">         28 :                                 nb_eos ++;</span>
<span class="lineNum">    4872 </span>            :                         }
<span class="lineNum">    4873 </span>            :                 }
<span class="lineNum">    4874 </span><span class="lineCov">       3069 :                 if (nb_eos==count)</span>
<span class="lineNum">    4875 </span>            :                         goto check_eos;
<span class="lineNum">    4876 </span>            : 
<span class="lineNum">    4877 </span><span class="lineCov">       3044 :                 ctx-&gt;segment_started = GF_TRUE;</span>
<span class="lineNum">    4878 </span><span class="lineCov">       3044 :                 ctx-&gt;insert_tfdt = GF_TRUE;</span>
<span class="lineNum">    4879 </span><span class="lineCov">       3044 :                 ctx-&gt;insert_pssh = (ctx-&gt;psshs == MP4MX_PSSH_MOOF) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    4880 </span>            : 
<span class="lineNum">    4881 </span><span class="lineCov">       3044 :                 gf_isom_start_segment(ctx-&gt;file, ctx-&gt;single_file ? NULL : &quot;_gpac_isobmff_redirect&quot;, GF_FALSE);</span>
<span class="lineNum">    4882 </span>            :         }
<span class="lineNum">    4883 </span>            : 
<span class="lineNum">    4884 </span>            :         //process pid by pid
<span class="lineNum">    4885 </span>            :         nb_eos=0;
<span class="lineNum">    4886 </span>            :         nb_done = 0;
<span class="lineNum">    4887 </span>            :         nb_suspended = 0;
<span class="lineNum">    4888 </span><span class="lineCov">       5329 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    4889 </span>            :                 u64 cts, dts, ncts;
<span class="lineNum">    4890 </span><span class="lineCov">     119925 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    4891 </span>            : 
<span class="lineNum">    4892 </span><span class="lineCov">     119925 :                 if (ctx-&gt;fragment_started &amp;&amp; tkw-&gt;fragment_done) {</span>
<span class="lineNum">    4893 </span><span class="lineCov">       1554 :                         nb_done ++;</span>
<span class="lineNum">    4894 </span><span class="lineCov">       1554 :                         continue;</span>
<span class="lineNum">    4895 </span>            :                 }
<span class="lineNum">    4896 </span><span class="lineCov">     118371 :                 if (tkw-&gt;suspended) {</span>
<span class="lineNum">    4897 </span><span class="lineCov">          2 :                         if (ctx-&gt;fragment_started) nb_done++;</span>
<span class="lineNum">    4898 </span><span class="lineCov">          2 :                         nb_suspended++;</span>
<span class="lineNum">    4899 </span><span class="lineCov">          2 :                         continue;</span>
<span class="lineNum">    4900 </span>            :                 }
<span class="lineNum">    4901 </span>            : 
<span class="lineNum">    4902 </span>            :                 while (1) {
<span class="lineNum">    4903 </span>            :                         const GF_PropertyValue *p;
<span class="lineNum">    4904 </span>            :                         u32 orig_frag_bounds=0;
<span class="lineNum">    4905 </span><span class="lineCov">     230283 :                         GF_FilterPacket *pck = gf_filter_pid_get_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    4906 </span>            : 
<span class="lineNum">    4907 </span><span class="lineCov">     230283 :                         if (!pck) {</span>
<span class="lineNum">    4908 </span><span class="lineCov">     114942 :                                 if (gf_filter_pid_is_eos(tkw-&gt;ipid)) {</span>
<span class="lineNum">    4909 </span><span class="lineCov">        346 :                                         tkw-&gt;fragment_done = GF_TRUE;</span>
<span class="lineNum">    4910 </span><span class="lineCov">        346 :                                         if (ctx-&gt;dash_mode) ctx-&gt;flush_seg = GF_TRUE;</span>
<span class="lineNum">    4911 </span><span class="lineCov">        346 :                                         if (ctx-&gt;next_file_idx)</span>
<span class="lineNum">    4912 </span><span class="lineNoCov">          0 :                                                 nb_suspended++;</span>
<span class="lineNum">    4913 </span><span class="lineCov">        346 :                                         nb_done ++;</span>
<span class="lineNum">    4914 </span><span class="lineCov">        346 :                                         nb_eos++;</span>
<span class="lineNum">    4915 </span><span class="lineCov">        346 :                                         break;</span>
<span class="lineNum">    4916 </span>            :                                 }
<span class="lineNum">    4917 </span>            :                                 return GF_OK;
<span class="lineNum">    4918 </span>            :                         }
<span class="lineNum">    4919 </span><span class="lineCov">     115341 :                         if (tkw-&gt;aborted) {</span>
<span class="lineNum">    4920 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_drop_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    4921 </span><span class="lineNoCov">          0 :                                 nb_eos++;</span>
<span class="lineNum">    4922 </span><span class="lineNoCov">          0 :                                 nb_done ++;</span>
<span class="lineNum">    4923 </span><span class="lineNoCov">          0 :                                 tkw-&gt;fragment_done = GF_TRUE;</span>
<span class="lineNum">    4924 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;dash_mode) ctx-&gt;flush_seg = GF_TRUE;</span>
<span class="lineNum">    4925 </span>            :                                 break;
<span class="lineNum">    4926 </span>            :                         }
<span class="lineNum">    4927 </span>            : 
<span class="lineNum">    4928 </span><span class="lineCov">     115341 :                         cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    4929 </span>            : 
<span class="lineNum">    4930 </span><span class="lineCov">     115341 :                         if (cts == GF_FILTER_NO_TS) {</span>
<span class="lineNum">    4931 </span><span class="lineCov">        104 :                                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_EODS);</span>
<span class="lineNum">    4932 </span><span class="lineCov">        104 :                                 if (p &amp;&amp; p-&gt;value.boolean) {</span>
<span class="lineNum">    4933 </span><span class="lineCov">        104 :                                         nb_done ++;</span>
<span class="lineNum">    4934 </span><span class="lineCov">        104 :                                         tkw-&gt;fragment_done = GF_TRUE;</span>
<span class="lineNum">    4935 </span><span class="lineCov">        104 :                                         tkw-&gt;samples_in_frag = 0;</span>
<span class="lineNum">    4936 </span><span class="lineCov">        104 :                                         gf_filter_pid_drop_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    4937 </span><span class="lineCov">        104 :                                         ctx-&gt;flush_seg = GF_TRUE;</span>
<span class="lineNum">    4938 </span><span class="lineCov">        104 :                                         tkw-&gt;next_seg_cts = tkw-&gt;cts_next;</span>
<span class="lineNum">    4939 </span><span class="lineCov">        104 :                                         break;</span>
<span class="lineNum">    4940 </span>            :                                 }
<span class="lineNum">    4941 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MuxIsom] Packet with no CTS assigned, cannot store to track, ignoring\n&quot;));</span>
<span class="lineNum">    4942 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_drop_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    4943 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">    4944 </span>            :                         }
<span class="lineNum">    4945 </span>            : 
<span class="lineNum">    4946 </span><span class="lineCov">     115237 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FRAG_START);</span>
<span class="lineNum">    4947 </span><span class="lineCov">     115237 :                         if (p) {</span>
<span class="lineNum">    4948 </span><span class="lineCov">        216 :                                 orig_frag_bounds = p-&gt;value.uint;</span>
<span class="lineNum">    4949 </span>            : 
<span class="lineNum">    4950 </span><span class="lineCov">        216 :                                 if (orig_frag_bounds==2) {</span>
<span class="lineNum">    4951 </span><span class="lineCov">         84 :                                         if (!ctx-&gt;segment_started) {</span>
<span class="lineNum">    4952 </span><span class="lineNoCov">          0 :                                                 ctx-&gt;dash_mode = 1;</span>
<span class="lineNum">    4953 </span><span class="lineNoCov">          0 :                                                 ctx-&gt;insert_tfdt = GF_TRUE;</span>
<span class="lineNum">    4954 </span><span class="lineNoCov">          0 :                                                 gf_isom_start_segment(ctx-&gt;file, ctx-&gt;single_file ? NULL : &quot;_gpac_isobmff_redirect&quot;, GF_FALSE);</span>
<span class="lineNum">    4955 </span><span class="lineCov">         84 :                                         } else if (tkw-&gt;samples_in_frag) {</span>
<span class="lineNum">    4956 </span><span class="lineCov">         27 :                                                 tkw-&gt;fragment_done = GF_TRUE;</span>
<span class="lineNum">    4957 </span><span class="lineCov">         27 :                                                 tkw-&gt;samples_in_frag = 0;</span>
<span class="lineNum">    4958 </span><span class="lineCov">         27 :                                                 nb_done ++;</span>
<span class="lineNum">    4959 </span>            :                                                 //make sure we flush until the end of the segment
<span class="lineNum">    4960 </span><span class="lineCov">         27 :                                                 ctx-&gt;flush_seg = GF_TRUE;</span>
<span class="lineNum">    4961 </span>            :                                                 //store CTS of next packet (first in next segment) for sidx compute
<span class="lineNum">    4962 </span><span class="lineCov">         27 :                                                 tkw-&gt;next_seg_cts = cts;</span>
<span class="lineNum">    4963 </span>            :                                         }
<span class="lineNum">    4964 </span>            :                                 }
<span class="lineNum">    4965 </span>            :                         }
<span class="lineNum">    4966 </span>            : 
<span class="lineNum">    4967 </span>            :                         //get dash/file segment number
<span class="lineNum">    4968 </span><span class="lineCov">     115237 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENUM);</span>
<span class="lineNum">    4969 </span>            : 
<span class="lineNum">    4970 </span>            :                         //not dash and file end, we need to wait for all streams and resetup
<span class="lineNum">    4971 </span><span class="lineCov">     115237 :                         if (!ctx-&gt;dash_mode &amp;&amp; p) {</span>
<span class="lineNum">    4972 </span><span class="lineCov">         27 :                                 if (!ctx-&gt;cur_file_idx_plus_one) {</span>
<span class="lineNum">    4973 </span><span class="lineNoCov">          0 :                                         ctx-&gt;cur_file_idx_plus_one = p-&gt;value.uint + 1;</span>
<span class="lineNum">    4974 </span><span class="lineNoCov">          0 :                                         if (!ctx-&gt;cur_file_suffix) {</span>
<span class="lineNum">    4975 </span><span class="lineNoCov">          0 :                                                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILESUF);</span>
<span class="lineNum">    4976 </span><span class="lineNoCov">          0 :                                                 if (p &amp;&amp; p-&gt;value.string) ctx-&gt;cur_file_suffix = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">    4977 </span>            :                                         }
<span class="lineNum">    4978 </span><span class="lineNoCov">          0 :                                         ctx-&gt;notify_filename = GF_TRUE;</span>
<span class="lineNum">    4979 </span><span class="lineCov">         27 :                                 } else if (ctx-&gt;cur_file_idx_plus_one == p-&gt;value.uint+1) {</span>
<span class="lineNum">    4980 </span><span class="lineCov">          9 :                                 } else if (!tkw-&gt;suspended) {</span>
<span class="lineNum">    4981 </span><span class="lineCov">          9 :                                         tkw-&gt;suspended = GF_TRUE;</span>
<span class="lineNum">    4982 </span><span class="lineCov">          9 :                                         nb_suspended++;</span>
<span class="lineNum">    4983 </span><span class="lineCov">          9 :                                         ctx-&gt;next_file_idx =  p-&gt;value.uint + 1;</span>
<span class="lineNum">    4984 </span><span class="lineCov">          9 :                                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILESUF);</span>
<span class="lineNum">    4985 </span><span class="lineCov">          9 :                                         if (p &amp;&amp; p-&gt;value.string)</span>
<span class="lineNum">    4986 </span><span class="lineCov">          9 :                                                 ctx-&gt;next_file_suffix = p-&gt;value.string;</span>
<span class="lineNum">    4987 </span>            :                                         break;
<span class="lineNum">    4988 </span>            :                                 }
<span class="lineNum">    4989 </span>            :                         }
<span class="lineNum">    4990 </span>            : 
<span class="lineNum">    4991 </span>            : 
<span class="lineNum">    4992 </span><span class="lineCov">     115228 :                         if (!ctx-&gt;fragment_started) {</span>
<span class="lineNum">    4993 </span><span class="lineCov">       3571 :                                 e = mp4_mux_start_fragment(ctx, orig_frag_bounds ? pck : NULL);</span>
<span class="lineNum">    4994 </span><span class="lineCov">       3571 :                                 if (e) return e;</span>
<span class="lineNum">    4995 </span>            : 
<span class="lineNum">    4996 </span><span class="lineCov">       3571 :                                 ctx-&gt;nb_frags++;</span>
<span class="lineNum">    4997 </span><span class="lineCov">       3571 :                                 if (ctx-&gt;dash_mode)</span>
<span class="lineNum">    4998 </span><span class="lineCov">       3491 :                                         ctx-&gt;nb_frags_in_seg++;</span>
<span class="lineNum">    4999 </span>            : 
<span class="lineNum">    5000 </span>            :                         }
<span class="lineNum">    5001 </span>            : 
<span class="lineNum">    5002 </span>            : 
<span class="lineNum">    5003 </span><span class="lineCov">     115228 :                         if (ctx-&gt;dash_mode) {</span>
<span class="lineNum">    5004 </span><span class="lineCov">     111897 :                                 if (p) {</span>
<span class="lineNum">    5005 </span>            :                                         //start of next segment, abort fragmentation for this track and flush all other writers
<span class="lineNum">    5006 </span><span class="lineCov">       5895 :                                         if (ctx-&gt;dash_seg_num_plus_one &amp;&amp; (ctx-&gt;dash_seg_num_plus_one != 1 + p-&gt;value.uint) ) {</span>
<span class="lineNum">    5007 </span><span class="lineCov">       2739 :                                                 tkw-&gt;fragment_done = GF_TRUE;</span>
<span class="lineNum">    5008 </span><span class="lineCov">       2739 :                                                 tkw-&gt;samples_in_frag = 0;</span>
<span class="lineNum">    5009 </span><span class="lineCov">       2739 :                                                 nb_done ++;</span>
<span class="lineNum">    5010 </span>            :                                                 //make sure we flush until the end of the segment
<span class="lineNum">    5011 </span><span class="lineCov">       2739 :                                                 ctx-&gt;flush_seg = GF_TRUE;</span>
<span class="lineNum">    5012 </span>            :                                                 //store CTS of next packet (first in next segment) for sidx compute
<span class="lineNum">    5013 </span><span class="lineCov">       2739 :                                                 tkw-&gt;next_seg_cts = cts;</span>
<span class="lineNum">    5014 </span>            : 
<span class="lineNum">    5015 </span><span class="lineCov">       2739 :                                                 break;</span>
<span class="lineNum">    5016 </span>            :                                         }
<span class="lineNum">    5017 </span>            :                                         //start of current segment, remember segment number and name
<span class="lineNum">    5018 </span><span class="lineCov">       3156 :                                         ctx-&gt;dash_seg_num_plus_one = 1 + p-&gt;value.uint;</span>
<span class="lineNum">    5019 </span>            :                                         //get file name prop if any - only send on one pid for muxed content
<span class="lineNum">    5020 </span><span class="lineCov">       3156 :                                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENAME);</span>
<span class="lineNum">    5021 </span><span class="lineCov">       3156 :                                         if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    5022 </span><span class="lineCov">       2484 :                                                 if (ctx-&gt;seg_name) gf_free(ctx-&gt;seg_name);</span>
<span class="lineNum">    5023 </span><span class="lineCov">       2484 :                                                 ctx-&gt;seg_name = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">    5024 </span>            :                                         }
<span class="lineNum">    5025 </span>            :                                         //store PRFT only for reference track at segment start
<span class="lineNum">    5026 </span><span class="lineCov">       3156 :                                         if (tkw==ctx-&gt;ref_tkw) {</span>
<span class="lineNum">    5027 </span><span class="lineCov">       3023 :                                                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_SENDER_NTP);</span>
<span class="lineNum">    5028 </span><span class="lineCov">       3023 :                                                 if (p) {</span>
<span class="lineNum">    5029 </span><span class="lineNoCov">          0 :                                                         gf_isom_set_fragment_reference_time(ctx-&gt;file, tkw-&gt;track_id, p-&gt;value.longuint, cts);</span>
<span class="lineNum">    5030 </span><span class="lineNoCov">          0 :                                                         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MuxIsom] Segment %s, storing NTP TS &quot;LLU&quot; for CTS &quot;LLU&quot; at &quot;LLU&quot; us, at UTC &quot;LLU&quot;\n&quot;, ctx-&gt;seg_name ? ctx-&gt;seg_name : &quot;singlefile&quot;, p-&gt;value.longuint, cts, gf_sys_clock_high_res(), gf_net_get_utc()));</span>
<span class="lineNum">    5031 </span>            :                                                 }
<span class="lineNum">    5032 </span>            :                                         }
<span class="lineNum">    5033 </span>            :                                 }
<span class="lineNum">    5034 </span>            : 
<span class="lineNum">    5035 </span><span class="lineCov">     109158 :                                 dts = gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">    5036 </span><span class="lineCov">     109158 :                                 if (dts==GF_FILTER_NO_TS) dts = cts;</span>
<span class="lineNum">    5037 </span><span class="lineCov">     109158 :                                 if (tkw-&gt;first_dts_in_seg &gt; dts)</span>
<span class="lineNum">    5038 </span><span class="lineNoCov">          0 :                                         tkw-&gt;first_dts_in_seg = dts;</span>
<span class="lineNum">    5039 </span>            :                         }
<span class="lineNum">    5040 </span><span class="lineCov">     112489 :                         ncts = cts + gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">    5041 </span><span class="lineCov">     112489 :                         if (tkw-&gt;cts_next &lt; ncts)</span>
<span class="lineNum">    5042 </span><span class="lineCov">     101799 :                                 tkw-&gt;cts_next = ncts;</span>
<span class="lineNum">    5043 </span>            : 
<span class="lineNum">    5044 </span>            : 
<span class="lineNum">    5045 </span><span class="lineCov">     112489 :                         if (tkw-&gt;samples_in_frag &amp;&amp; orig_frag_bounds) {</span>
<span class="lineNum">    5046 </span><span class="lineCov">         66 :                                 tkw-&gt;fragment_done = GF_TRUE;</span>
<span class="lineNum">    5047 </span><span class="lineCov">         66 :                                 nb_done ++;</span>
<span class="lineNum">    5048 </span><span class="lineCov">         66 :                                 tkw-&gt;samples_in_frag = 0;</span>
<span class="lineNum">    5049 </span><span class="lineCov">         66 :                                 tkw-&gt;dur_in_frag = 0;</span>
<span class="lineNum">    5050 </span><span class="lineCov">         66 :                                 break;</span>
<span class="lineNum">    5051 </span><span class="lineCov">     112423 :                         } else if (ctx-&gt;fragdur &amp;&amp; (!ctx-&gt;dash_mode || !tkw-&gt;fragment_done) ) {</span>
<span class="lineNum">    5052 </span>            :                                 Bool frag_done = GF_FALSE;
<span class="lineNum">    5053 </span><span class="lineCov">       6526 :                                 u32 dur = gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">    5054 </span><span class="lineCov">       6526 :                                 if (tkw-&gt;dur_in_frag &amp;&amp; (tkw-&gt;dur_in_frag * ctx-&gt;cdur.den &gt;= ((u64)ctx-&gt;cdur.num) * tkw-&gt;src_timescale)) {</span>
<span class="lineNum">    5055 </span>            :                                         frag_done = GF_TRUE;
<span class="lineNum">    5056 </span><span class="lineCov">       6039 :                                 } else if ((ctx-&gt;store==MP4MX_MODE_SFRAG)</span>
<span class="lineNum">    5057 </span><span class="lineCov">       1650 :                                         &amp;&amp; (cts &gt;= (u64) (ctx-&gt;adjusted_next_frag_start * tkw-&gt;src_timescale / ctx-&gt;cdur.den) + tkw-&gt;ts_delay)</span>
<span class="lineNum">    5058 </span>            :                                 ) {
<span class="lineNum">    5059 </span>            :                                         GF_FilterSAPType sap = mp4_mux_get_sap(ctx, pck);
<span class="lineNum">    5060 </span><span class="lineNoCov">          0 :                                         if ((sap &amp;&amp; sap&lt;GF_FILTER_SAP_3)) {</span>
<span class="lineNum">    5061 </span>            :                                                 frag_done = GF_TRUE;
<span class="lineNum">    5062 </span>            :                                         }
<span class="lineNum">    5063 </span>            :                                 }
<span class="lineNum">    5064 </span>            :                                 if (frag_done) {
<span class="lineNum">    5065 </span><span class="lineCov">        487 :                                         ctx-&gt;adjusted_next_frag_start = (cts - tkw-&gt;ts_delay);</span>
<span class="lineNum">    5066 </span><span class="lineCov">        487 :                                         ctx-&gt;adjusted_next_frag_start *= ctx-&gt;cdur.den;</span>
<span class="lineNum">    5067 </span><span class="lineCov">        487 :                                         ctx-&gt;adjusted_next_frag_start /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    5068 </span>            : //
<span class="lineNum">    5069 </span><span class="lineCov">        487 :                                         tkw-&gt;fragment_done = GF_TRUE;</span>
<span class="lineNum">    5070 </span><span class="lineCov">        487 :                                         nb_done ++;</span>
<span class="lineNum">    5071 </span><span class="lineCov">        487 :                                         tkw-&gt;dur_in_frag = 0;</span>
<span class="lineNum">    5072 </span><span class="lineCov">        487 :                                         tkw-&gt;samples_in_frag = 0;</span>
<span class="lineNum">    5073 </span><span class="lineCov">        487 :                                         break;</span>
<span class="lineNum">    5074 </span>            :                                 }
<span class="lineNum">    5075 </span><span class="lineCov">       6039 :                                 tkw-&gt;dur_in_frag += dur;</span>
<span class="lineNum">    5076 </span><span class="lineCov">       6039 :                                 if (ctx-&gt;llhls_mode &amp;&amp; (ctx-&gt;frag_duration * tkw-&gt;src_timescale &lt;= tkw-&gt;dur_in_frag * ctx-&gt;frag_timescale)) {</span>
<span class="lineNum">    5077 </span><span class="lineCov">       1650 :                                         ctx-&gt;frag_duration = tkw-&gt;dur_in_frag;</span>
<span class="lineNum">    5078 </span><span class="lineCov">       1650 :                                         ctx-&gt;frag_timescale = tkw-&gt;src_timescale;</span>
<span class="lineNum">    5079 </span>            :                                 }
<span class="lineNum">    5080 </span><span class="lineCov">     105897 :                         } else if (!ctx-&gt;flush_seg &amp;&amp; !ctx-&gt;dash_mode</span>
<span class="lineNum">    5081 </span><span class="lineCov">        782 :                                 &amp;&amp; (cts &gt;= (u64) (ctx-&gt;adjusted_next_frag_start * tkw-&gt;src_timescale  / ctx-&gt;cdur.den) + tkw-&gt;ts_delay)</span>
<span class="lineNum">    5082 </span>            :                          ) {
<span class="lineNum">    5083 </span>            :                                 GF_FilterSAPType sap = mp4_mux_get_sap(ctx, pck);
<span class="lineNum">    5084 </span><span class="lineCov">         22 :                                 if ((ctx-&gt;store==MP4MX_MODE_FRAG) || (sap &amp;&amp; sap&lt;GF_FILTER_SAP_3)) {</span>
<span class="lineNum">    5085 </span><span class="lineCov">         22 :                                         tkw-&gt;fragment_done = GF_TRUE;</span>
<span class="lineNum">    5086 </span><span class="lineCov">         22 :                                         tkw-&gt;samples_in_frag = 0;</span>
<span class="lineNum">    5087 </span><span class="lineCov">         22 :                                         nb_done ++;</span>
<span class="lineNum">    5088 </span><span class="lineCov">         22 :                                         if (ctx-&gt;store==MP4MX_MODE_SFRAG) {</span>
<span class="lineNum">    5089 </span><span class="lineNoCov">          0 :                                                 ctx-&gt;adjusted_next_frag_start = (cts - tkw-&gt;ts_delay);</span>
<span class="lineNum">    5090 </span><span class="lineNoCov">          0 :                                                 ctx-&gt;adjusted_next_frag_start *= ctx-&gt;cdur.den;</span>
<span class="lineNum">    5091 </span><span class="lineNoCov">          0 :                                                 ctx-&gt;adjusted_next_frag_start /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    5092 </span>            :                                         }
<span class="lineNum">    5093 </span>            :                                         break;
<span class="lineNum">    5094 </span>            :                                 }
<span class="lineNum">    5095 </span>            :                         }
<span class="lineNum">    5096 </span><span class="lineCov">     111914 :                         if (tkw-&gt;insert_tfdt) {</span>
<span class="lineNum">    5097 </span><span class="lineCov">       3438 :                                 u64 odts = gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">    5098 </span><span class="lineCov">       3438 :                                 if (odts==GF_FILTER_NO_TS)</span>
<span class="lineNum">    5099 </span><span class="lineNoCov">          0 :                                         odts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    5100 </span>            : 
<span class="lineNum">    5101 </span><span class="lineCov">       3438 :                                 if (tkw-&gt;offset_dts) odts += tkw-&gt;offset_dts;</span>
<span class="lineNum">    5102 </span>            : 
<span class="lineNum">    5103 </span><span class="lineCov">       3438 :                                 tkw-&gt;insert_tfdt = GF_FALSE;</span>
<span class="lineNum">    5104 </span><span class="lineCov">       3438 :                                 if (tkw-&gt;patch_tfdt)</span>
<span class="lineNum">    5105 </span><span class="lineNoCov">          0 :                                         gf_isom_set_traf_base_media_decode_time(ctx-&gt;file, tkw-&gt;track_id, odts + tkw-&gt;ts_delay);</span>
<span class="lineNum">    5106 </span>            :                                 else
<span class="lineNum">    5107 </span><span class="lineCov">       3438 :                                         gf_isom_set_traf_base_media_decode_time(ctx-&gt;file, tkw-&gt;track_id, odts);</span>
<span class="lineNum">    5108 </span><span class="lineCov">       3438 :                                 tkw-&gt;first_dts_in_seg = (u64) odts;</span>
<span class="lineNum">    5109 </span>            :                         }
<span class="lineNum">    5110 </span>            : 
<span class="lineNum">    5111 </span><span class="lineCov">     111914 :                         if (ctx-&gt;trun_inter) {</span>
<span class="lineNum">    5112 </span>            :                                 GF_FilterSAPType sap = mp4_mux_get_sap(ctx, pck);
<span class="lineNum">    5113 </span>            :                                 s32 tid_group = 0;
<span class="lineNum">    5114 </span><span class="lineNoCov">          0 :                                 if (sap) {</span>
<span class="lineNum">    5115 </span><span class="lineNoCov">          0 :                                         tkw-&gt;prev_tid_group = 0;</span>
<span class="lineNum">    5116 </span>            :                                 } else {
<span class="lineNum">    5117 </span>            :                                         s64 dts_diff;
<span class="lineNum">    5118 </span><span class="lineNoCov">          0 :                                         s64 p_dts = gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">    5119 </span><span class="lineNoCov">          0 :                                         s64 p_cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    5120 </span><span class="lineNoCov">          0 :                                         s64 cts_o = p_cts - p_dts;</span>
<span class="lineNum">    5121 </span><span class="lineNoCov">          0 :                                         dts_diff = p_dts - tkw-&gt;sample.DTS;</span>
<span class="lineNum">    5122 </span><span class="lineNoCov">          0 :                                         tid_group = (s32) (cts_o / dts_diff);</span>
<span class="lineNum">    5123 </span><span class="lineNoCov">          0 :                                         tid_group = 20 - tid_group;</span>
<span class="lineNum">    5124 </span><span class="lineNoCov">          0 :                                         if (tid_group != tkw-&gt;prev_tid_group) {</span>
<span class="lineNum">    5125 </span><span class="lineNoCov">          0 :                                                 tkw-&gt;prev_tid_group = tid_group;</span>
<span class="lineNum">    5126 </span><span class="lineNoCov">          0 :                                                 gf_isom_set_fragment_option(ctx-&gt;file, tkw-&gt;track_id, GF_ISOM_TRUN_SET_INTERLEAVE_ID, tid_group);</span>
<span class="lineNum">    5127 </span>            :                                         }
<span class="lineNum">    5128 </span>            :                                 }
<span class="lineNum">    5129 </span>            :                         }
<span class="lineNum">    5130 </span>            : 
<span class="lineNum">    5131 </span>            :                         //process packet
<span class="lineNum">    5132 </span><span class="lineCov">     111914 :                         e = mp4_mux_process_sample(ctx, tkw, pck, GF_TRUE);</span>
<span class="lineNum">    5133 </span>            : 
<span class="lineNum">    5134 </span>            :                         //discard
<span class="lineNum">    5135 </span><span class="lineCov">     111914 :                         gf_filter_pid_drop_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    5136 </span>            : 
<span class="lineNum">    5137 </span><span class="lineCov">     111914 :                         cts *= 1000;</span>
<span class="lineNum">    5138 </span><span class="lineCov">     111914 :                         cts /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    5139 </span><span class="lineCov">     111914 :                         if (!ctx-&gt;min_cts_plus_one) ctx-&gt;min_cts_plus_one = cts + 1;</span>
<span class="lineNum">    5140 </span><span class="lineCov">     108343 :                         else if (ctx-&gt;min_cts_plus_one-1 &gt; cts) ctx-&gt;min_cts_plus_one = cts + 1;</span>
<span class="lineNum">    5141 </span>            : 
<span class="lineNum">    5142 </span><span class="lineCov">     111914 :                         if (e) return e;</span>
<span class="lineNum">    5143 </span>            :                 }
<span class="lineNum">    5144 </span>            :                 //done with this track - if single track per moof, request new fragment but don't touch the
<span class="lineNum">    5145 </span>            :                 //fragmentation state of the track writers
<span class="lineNum">    5146 </span><span class="lineCov">       3773 :                 if (ctx-&gt;straf &amp;&amp; (i+1 &lt; count)) {</span>
<span class="lineNum">    5147 </span>            :                         GF_ISOStartFragmentFlags flags = 0;
<span class="lineNum">    5148 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;moof_first) flags |= GF_ISOM_FRAG_MOOF_FIRST;</span>
<span class="lineNum">    5149 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">    5150 </span>            :                         if (ctx-&gt;ctrn) flags |= GF_ISOM_FRAG_USE_COMPACT;
<span class="lineNum">    5151 </span>            : #endif
<span class="lineNum">    5152 </span><span class="lineNoCov">          0 :                         e = gf_isom_start_fragment(ctx-&gt;file, flags);</span>
<span class="lineNum">    5153 </span><span class="lineNoCov">          0 :                         if (e) {</span>
<span class="lineNum">    5154 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to start new fragment: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    5155 </span>            :                                 return e;
<span class="lineNum">    5156 </span>            :                         }
<span class="lineNum">    5157 </span><span class="lineNoCov">          0 :                         gf_isom_set_next_moof_number(ctx-&gt;file, ctx-&gt;msn);</span>
<span class="lineNum">    5158 </span><span class="lineNoCov">          0 :                         ctx-&gt;msn++;</span>
<span class="lineNum">    5159 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;sdtp_traf)</span>
<span class="lineNum">    5160 </span><span class="lineNoCov">          0 :                                 gf_isom_set_fragment_option(ctx-&gt;file, tkw-&gt;track_id, GF_ISOM_TRAF_USE_SAMPLE_DEPS_BOX, ctx-&gt;sdtp_traf);</span>
<span class="lineNum">    5161 </span>            :                 }
<span class="lineNum">    5162 </span>            :         }
<span class="lineNum">    5163 </span>            : 
<span class="lineNum">    5164 </span>            :         //all suspended tracks done, flush fragment
<span class="lineNum">    5165 </span><span class="lineCov">       3599 :         if (nb_suspended &amp;&amp; (nb_suspended==count)) {</span>
<span class="lineNum">    5166 </span>            :                 nb_done = count;
<span class="lineNum">    5167 </span>            :         }
<span class="lineNum">    5168 </span>            : 
<span class="lineNum">    5169 </span>            : 
<span class="lineNum">    5170 </span><span class="lineCov">       3599 :         if (nb_done==count) {</span>
<span class="lineNum">    5171 </span><span class="lineCov">       3571 :                 Bool is_eos = (count == nb_eos) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    5172 </span>            :                 u32 ref_timescale;
<span class="lineNum">    5173 </span><span class="lineCov">       3571 :                 u64 next_ref_ts = ctx-&gt;ref_tkw-&gt;next_seg_cts;</span>
<span class="lineNum">    5174 </span><span class="lineCov">       3571 :                 if (is_eos)</span>
<span class="lineNum">    5175 </span><span class="lineCov">        316 :                         next_ref_ts = ctx-&gt;ref_tkw-&gt;cts_next;</span>
<span class="lineNum">    5176 </span>            : 
<span class="lineNum">    5177 </span><span class="lineCov">       3571 :                 ref_timescale = ctx-&gt;ref_tkw-&gt;src_timescale;</span>
<span class="lineNum">    5178 </span>            :                 //both in ms
<span class="lineNum">    5179 </span><span class="lineCov">       3571 :                 ctx-&gt;next_seg_start = (u64) (next_ref_ts) * 1000 / ref_timescale;</span>
<span class="lineNum">    5180 </span><span class="lineCov">       3571 :                 ctx-&gt;min_cts_next_frag = (u64) (ctx-&gt;next_frag_start) * 1000 / ctx-&gt;cdur.den;</span>
<span class="lineNum">    5181 </span>            : 
<span class="lineNum">    5182 </span><span class="lineCov">       3571 :                 ctx-&gt;next_frag_start += ctx-&gt;cdur.num;</span>
<span class="lineNum">    5183 </span><span class="lineCov">       7148 :                 while (ctx-&gt;next_frag_start &lt;= ctx-&gt;adjusted_next_frag_start) {</span>
<span class="lineNum">    5184 </span><span class="lineCov">          6 :                         ctx-&gt;next_frag_start += ctx-&gt;cdur.num;</span>
<span class="lineNum">    5185 </span>            :                 }
<span class="lineNum">    5186 </span><span class="lineCov">       3571 :                 ctx-&gt;adjusted_next_frag_start = ctx-&gt;next_frag_start;</span>
<span class="lineNum">    5187 </span>            : 
<span class="lineNum">    5188 </span><span class="lineCov">       3571 :                 mp4mx_frag_box_patch(ctx);</span>
<span class="lineNum">    5189 </span>            : 
<span class="lineNum">    5190 </span>            :                 //end of DASH segment
<span class="lineNum">    5191 </span><span class="lineCov">       6597 :                 if (ctx-&gt;dash_mode &amp;&amp; (ctx-&gt;flush_seg || is_eos) ) {</span>
<span class="lineNum">    5192 </span><span class="lineCov">       3026 :                         u64 offset = ctx-&gt;single_file ? ctx-&gt;current_offset : 0;</span>
<span class="lineNum">    5193 </span>            :                         u64 idx_start_range, idx_end_range, segment_size_in_bytes;
<span class="lineNum">    5194 </span>            :                         s32 subs_sidx = -1;
<span class="lineNum">    5195 </span>            :                         u32 track_ref_id = 0;
<span class="lineNum">    5196 </span>            : 
<span class="lineNum">    5197 </span><span class="lineCov">       3026 :                         idx_start_range = idx_end_range = 0;</span>
<span class="lineNum">    5198 </span><span class="lineCov">       3026 :                         if (ctx-&gt;subs_sidx&gt;=0) {</span>
<span class="lineNum">    5199 </span>            :                                 subs_sidx = ctx-&gt;subs_sidx;
<span class="lineNum">    5200 </span><span class="lineCov">       2293 :                                 track_ref_id = ctx-&gt;ref_tkw-&gt;track_id;</span>
<span class="lineNum">    5201 </span>            :                         }
<span class="lineNum">    5202 </span><span class="lineCov">       3026 :                         if (ctx-&gt;cloned_sidx &amp;&amp; (ctx-&gt;subs_sidx!=-2) ) {</span>
<span class="lineNum">    5203 </span><span class="lineCov">         57 :                                 subs_sidx = (s32) ctx-&gt;cloned_sidx-&gt;nb_refs;</span>
<span class="lineNum">    5204 </span><span class="lineCov">         57 :                                 track_ref_id = ctx-&gt;cloned_sidx-&gt;reference_ID;</span>
<span class="lineNum">    5205 </span><span class="lineCov">         57 :                                 gf_isom_box_del((GF_Box *)ctx-&gt;cloned_sidx);</span>
<span class="lineNum">    5206 </span><span class="lineCov">         57 :                                 ctx-&gt;cloned_sidx = NULL;</span>
<span class="lineNum">    5207 </span>            :                         }
<span class="lineNum">    5208 </span>            : 
<span class="lineNum">    5209 </span><span class="lineCov">       3026 :                         e = gf_isom_close_segment(ctx-&gt;file, subs_sidx, track_ref_id, ctx-&gt;ref_tkw-&gt;first_dts_in_seg, ctx-&gt;ref_tkw-&gt;ts_delay, next_ref_ts, ctx-&gt;chain_sidx, ctx-&gt;ssix, ctx-&gt;sseg ? GF_FALSE : is_eos, GF_FALSE, ctx-&gt;eos_marker, &amp;idx_start_range, &amp;idx_end_range, &amp;segment_size_in_bytes);</span>
<span class="lineNum">    5210 </span><span class="lineCov">       3026 :                         if (e) return e;</span>
<span class="lineNum">    5211 </span>            : 
<span class="lineNum">    5212 </span><span class="lineCov">       3026 :                         GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[MP4Mux] Done writing segment %d - estimated next fragment times start %g end %g\n&quot;, ctx-&gt;dash_seg_num_plus_one - 1, ((Double)next_ref_ts)/ref_timescale, ((Double)ctx-&gt;next_frag_start)/ctx-&gt;cdur.den ));</span>
<span class="lineNum">    5213 </span>            : 
<span class="lineNum">    5214 </span><span class="lineCov">       3026 :                         if (ctx-&gt;dash_mode != MP4MX_DASH_VOD) {</span>
<span class="lineNum">    5215 </span><span class="lineCov">       2750 :                                 mp4_mux_flush_seg(ctx, GF_FALSE, offset + idx_start_range, idx_end_range ? offset + idx_end_range : 0);</span>
<span class="lineNum">    5216 </span><span class="lineCov">        276 :                         } else if (ctx-&gt;vodcache==MP4MX_VODCACHE_REPLACE) {</span>
<span class="lineNum">    5217 </span><span class="lineNoCov">          0 :                                 mp4_mux_flush_seg(ctx, GF_FALSE, 0, 0);</span>
<span class="lineNum">    5218 </span>            :                         } else {
<span class="lineNum">    5219 </span><span class="lineCov">        276 :                                 if (ctx-&gt;nb_seg_sizes == ctx-&gt;alloc_seg_sizes) {</span>
<span class="lineNum">    5220 </span><span class="lineCov">         33 :                                          ctx-&gt;alloc_seg_sizes *= 2;</span>
<span class="lineNum">    5221 </span><span class="lineCov">         33 :                                          if (!ctx-&gt;alloc_seg_sizes) ctx-&gt;alloc_seg_sizes = 10;</span>
<span class="lineNum">    5222 </span><span class="lineCov">         33 :                                          ctx-&gt;seg_sizes = gf_realloc(ctx-&gt;seg_sizes, sizeof(u32) * ctx-&gt;alloc_seg_sizes);</span>
<span class="lineNum">    5223 </span>            :                                 }
<span class="lineNum">    5224 </span>            :                                 assert(segment_size_in_bytes);
<span class="lineNum">    5225 </span><span class="lineCov">        276 :                                 ctx-&gt;seg_sizes[ctx-&gt;nb_seg_sizes] = (u32) segment_size_in_bytes;</span>
<span class="lineNum">    5226 </span><span class="lineCov">        276 :                                 ctx-&gt;nb_seg_sizes++;</span>
<span class="lineNum">    5227 </span>            :                         }
<span class="lineNum">    5228 </span>            :                 }
<span class="lineNum">    5229 </span>            :                 //cannot flush in DASH mode if using sidx (vod single sidx or live 1 sidx/seg)
<span class="lineNum">    5230 </span><span class="lineCov">        545 :                 else if (!ctx-&gt;dash_mode || ((ctx-&gt;subs_sidx&lt;0) &amp;&amp; (ctx-&gt;dash_mode&lt;MP4MX_DASH_VOD) &amp;&amp; !ctx-&gt;cloned_sidx) ) {</span>
<span class="lineNum">    5231 </span><span class="lineCov">        453 :                         gf_isom_flush_fragments(ctx-&gt;file, GF_FALSE);</span>
<span class="lineNum">    5232 </span>            : 
<span class="lineNum">    5233 </span><span class="lineCov">        453 :                         if (ctx-&gt;llhls_mode) {</span>
<span class="lineNum">    5234 </span><span class="lineCov">        279 :                                 mp4_mux_flush_frag_hls(ctx);</span>
<span class="lineNum">    5235 </span>            :                         }
<span class="lineNum">    5236 </span>            : 
<span class="lineNum">    5237 </span><span class="lineCov">        453 :                         if (!ctx-&gt;dash_mode || ctx-&gt;flush_seg) {</span>
<span class="lineNum">    5238 </span><span class="lineCov">         80 :                                 mp4_mux_flush_seg(ctx, GF_FALSE, 0, 0);</span>
<span class="lineNum">    5239 </span>            :                         }
<span class="lineNum">    5240 </span>            : 
<span class="lineNum">    5241 </span><span class="lineCov">        453 :                         GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[MP4Mux] Done writing fragment - next fragment start time %g\n&quot;, ((Double)ctx-&gt;next_frag_start)/ctx-&gt;cdur.den ));</span>
<span class="lineNum">    5242 </span>            :                 }
<span class="lineNum">    5243 </span><span class="lineCov">       3571 :                 ctx-&gt;fragment_started = GF_FALSE;</span>
<span class="lineNum">    5244 </span>            : 
<span class="lineNum">    5245 </span><span class="lineCov">       3571 :                 if (ctx-&gt;flush_seg) {</span>
<span class="lineNum">    5246 </span><span class="lineCov">       3026 :                         ctx-&gt;segment_started = GF_FALSE;</span>
<span class="lineNum">    5247 </span><span class="lineCov">       3026 :                         ctx-&gt;flush_seg = GF_FALSE;</span>
<span class="lineNum">    5248 </span><span class="lineCov">       3026 :                         ctx-&gt;dash_seg_num_plus_one = 0;</span>
<span class="lineNum">    5249 </span><span class="lineCov">       3026 :                         ctx-&gt;nb_segs++;</span>
<span class="lineNum">    5250 </span><span class="lineCov">       3026 :                         ctx-&gt;nb_frags_in_seg=0;</span>
<span class="lineNum">    5251 </span>            :                 }
<span class="lineNum">    5252 </span>            :         }
<span class="lineNum">    5253 </span>            : 
<span class="lineNum">    5254 </span><span class="lineCov">       3599 :         if (nb_suspended &amp;&amp; (nb_suspended==count)) {</span>
<span class="lineNum">    5255 </span><span class="lineCov">          4 :                 ctx-&gt;nb_segs=0;</span>
<span class="lineNum">    5256 </span><span class="lineCov">          4 :                 return mp4mx_reload_output(filter, ctx);</span>
<span class="lineNum">    5257 </span>            :         }
<span class="lineNum">    5258 </span>            : 
<span class="lineNum">    5259 </span><span class="lineCov">       3620 : check_eos:</span>
<span class="lineNum">    5260 </span><span class="lineCov">       3620 :         if (count == nb_eos) {</span>
<span class="lineNum">    5261 </span><span class="lineCov">        341 :                 if (ctx-&gt;dash_mode==MP4MX_DASH_VOD) {</span>
<span class="lineNum">    5262 </span><span class="lineCov">         17 :                         if (ctx-&gt;vodcache!=MP4MX_VODCACHE_ON) {</span>
<span class="lineNum">    5263 </span><span class="lineNoCov">          0 :                                 ctx-&gt;final_sidx_flush = GF_TRUE;</span>
<span class="lineNum">    5264 </span>            :                                 //flush SIDX in given space - this will reserve 8 bytes for free box if not fitting
<span class="lineNum">    5265 </span><span class="lineNoCov">          0 :                                 gf_isom_flush_sidx(ctx-&gt;file, ctx-&gt;sidx_max_size, (ctx-&gt;sidx_size_exact || ctx-&gt;tfdt64) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    5266 </span>            :                         } else {
<span class="lineNum">    5267 </span>            :                                 u64 start_offset;
<span class="lineNum">    5268 </span>            :                                 //reenable packet dispatch
<span class="lineNum">    5269 </span><span class="lineCov">         17 :                                 ctx-&gt;store_output = GF_FALSE;</span>
<span class="lineNum">    5270 </span><span class="lineCov">         17 :                                 gf_isom_flush_sidx(ctx-&gt;file, 0, ctx-&gt;tfdt64);</span>
<span class="lineNum">    5271 </span>            :                                 //flush sidx packet
<span class="lineNum">    5272 </span><span class="lineCov">         17 :                                 mp4mux_send_output(ctx);</span>
<span class="lineNum">    5273 </span>            : 
<span class="lineNum">    5274 </span><span class="lineCov">         17 :                                 mp4_mux_flush_seg(ctx, GF_TRUE, ctx-&gt;current_offset, ctx-&gt;current_offset + ctx-&gt;current_size - 1);</span>
<span class="lineNum">    5275 </span>            : 
<span class="lineNum">    5276 </span><span class="lineCov">         17 :                                 gf_fflush(ctx-&gt;tmp_store);</span>
<span class="lineNum">    5277 </span><span class="lineCov">         17 :                                 ctx-&gt;flush_size = gf_ftell(ctx-&gt;tmp_store);</span>
<span class="lineNum">    5278 </span><span class="lineCov">         17 :                                 ctx-&gt;flush_done = 0;</span>
<span class="lineNum">    5279 </span><span class="lineCov">         17 :                                 gf_fseek(ctx-&gt;tmp_store, 0, SEEK_SET);</span>
<span class="lineNum">    5280 </span>            : 
<span class="lineNum">    5281 </span><span class="lineCov">         17 :                                 if (ctx-&gt;seg_sizes) {</span>
<span class="lineNum">    5282 </span><span class="lineCov">         17 :                                         start_offset = ctx-&gt;current_offset;</span>
<span class="lineNum">    5283 </span><span class="lineCov">        293 :                                         for (i=0; i&lt;ctx-&gt;nb_seg_sizes; i++) {</span>
<span class="lineNum">    5284 </span><span class="lineCov">        276 :                                                 ctx-&gt;current_size = ctx-&gt;seg_sizes[i];</span>
<span class="lineNum">    5285 </span><span class="lineCov">        276 :                                                 mp4_mux_flush_seg(ctx, GF_FALSE, 0, 0);</span>
<span class="lineNum">    5286 </span>            :                                         }
<span class="lineNum">    5287 </span><span class="lineCov">         17 :                                         ctx-&gt;current_offset = start_offset;</span>
<span class="lineNum">    5288 </span><span class="lineCov">         17 :                                         ctx-&gt;current_size = 0;</span>
<span class="lineNum">    5289 </span>            : 
<span class="lineNum">    5290 </span><span class="lineCov">         17 :                                         gf_free(ctx-&gt;seg_sizes);</span>
<span class="lineNum">    5291 </span><span class="lineCov">         17 :                                         ctx-&gt;seg_sizes = NULL;</span>
<span class="lineNum">    5292 </span><span class="lineCov">         17 :                                         ctx-&gt;alloc_seg_sizes = ctx-&gt;nb_seg_sizes = 0;</span>
<span class="lineNum">    5293 </span>            :                                 }
<span class="lineNum">    5294 </span>            :                         }
<span class="lineNum">    5295 </span>            :                 }
<span class="lineNum">    5296 </span>            :                 //only destroy file if not dash or not onDemand, otherwise (regular dash) the file will be needed to append further segments
<span class="lineNum">    5297 </span><span class="lineCov">        341 :                 if (ctx-&gt;dash_mode!=MP4MX_DASH_ON) {</span>
<span class="lineNum">    5298 </span>            :                         //only delete file in vod mode
<span class="lineNum">    5299 </span><span class="lineCov">         26 :                         if (ctx-&gt;file) {</span>
<span class="lineNum">    5300 </span><span class="lineCov">         26 :                                 gf_isom_close(ctx-&gt;file);</span>
<span class="lineNum">    5301 </span><span class="lineCov">         26 :                                 ctx-&gt;file = NULL;</span>
<span class="lineNum">    5302 </span>            :                         }
<span class="lineNum">    5303 </span>            :                 }
<span class="lineNum">    5304 </span>            : 
<span class="lineNum">    5305 </span><span class="lineCov">        341 :                 mp4mux_send_output(ctx);</span>
<span class="lineNum">    5306 </span>            : 
<span class="lineNum">    5307 </span><span class="lineCov">        341 :                 if (!ctx-&gt;flush_size) gf_filter_pid_set_eos(ctx-&gt;opid);</span>
<span class="lineNum">    5308 </span>            : 
<span class="lineNum">    5309 </span><span class="lineCov">        341 :                 return ctx-&gt;flush_size ? GF_OK : GF_EOS;</span>
<span class="lineNum">    5310 </span>            :         }
<span class="lineNum">    5311 </span>            : 
<span class="lineNum">    5312 </span>            :         return GF_OK;
<a name="5313"><span class="lineNum">    5313 </span>            : }</a>
<span class="lineNum">    5314 </span>            : 
<span class="lineNum">    5315 </span><span class="lineCov">       2885 : static void mp4_mux_config_timing(GF_MP4MuxCtx *ctx)</span>
<span class="lineNum">    5316 </span>            : {
<span class="lineNum">    5317 </span><span class="lineCov">       2886 :         u32 i, count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    5318 </span>            :         //compute min dts of first packet on each track - this assume all tracks are synchronized, might need adjustment for MPEG4 Systems
<span class="lineNum">    5319 </span>            :         u64 first_ts_min = (u64) -1;
<span class="lineNum">    5320 </span><span class="lineCov">       5100 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    5321 </span>            :                 u64 ts, dts_min;
<span class="lineNum">    5322 </span>            :                 GF_FilterPacket *pck;
<span class="lineNum">    5323 </span><span class="lineCov">       3801 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    5324 </span><span class="lineCov">       3801 :                 if (tkw-&gt;fake_track) continue;</span>
<span class="lineNum">    5325 </span>            : 
<span class="lineNum">    5326 </span>            :                 //already setup (happens when new PIDs are declared after a packet has already been written on other PIDs)
<span class="lineNum">    5327 </span><span class="lineCov">       3774 :                 if (tkw-&gt;nb_samples) {</span>
<span class="lineNum">    5328 </span><span class="lineNoCov">          0 :                         dts_min = tkw-&gt;ts_shift * 1000000;</span>
<span class="lineNum">    5329 </span><span class="lineNoCov">          0 :                         dts_min /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    5330 </span>            : 
<span class="lineNum">    5331 </span><span class="lineNoCov">          0 :                         if (first_ts_min &gt; dts_min) {</span>
<span class="lineNum">    5332 </span>            :                                 first_ts_min = (u64) dts_min;
<span class="lineNum">    5333 </span>            :                         }
<span class="lineNum">    5334 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    5335 </span>            :                 }
<span class="lineNum">    5336 </span><span class="lineCov">       3774 : retry_pck:</span>
<span class="lineNum">    5337 </span><span class="lineCov">       3774 :                 pck = gf_filter_pid_get_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    5338 </span>            :                 //check this after fetching a packet since it may reconfigure the track
<span class="lineNum">    5339 </span><span class="lineCov">       3774 :                 if (!tkw-&gt;track_num) {</span>
<span class="lineNum">    5340 </span><span class="lineCov">        577 :                         if (gf_filter_pid_is_eos(tkw-&gt;ipid)) {</span>
<span class="lineNum">    5341 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] PID has no input packet and configuration not known after 10 retries, aborting initial timing sync\n&quot;));</span>
<span class="lineNum">    5342 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">    5343 </span>            :                         }
<span class="lineNum">    5344 </span>            :                         return;
<span class="lineNum">    5345 </span>            :                 }
<span class="lineNum">    5346 </span>            : 
<span class="lineNum">    5347 </span><span class="lineCov">       3197 :                 if (pck) {</span>
<span class="lineNum">    5348 </span><span class="lineCov">       2179 :                         if (tkw-&gt;wait_sap) {</span>
<span class="lineNum">    5349 </span><span class="lineNoCov">          0 :                                 GF_FilterSAPType sap = gf_filter_pck_get_sap(pck);</span>
<span class="lineNum">    5350 </span><span class="lineNoCov">          0 :                                 Bool seek = gf_filter_pck_get_seek_flag(pck);</span>
<span class="lineNum">    5351 </span><span class="lineNoCov">          0 :                                 if (seek || !sap) {</span>
<span class="lineNum">    5352 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_drop_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    5353 </span><span class="lineNoCov">          0 :                                         goto retry_pck;</span>
<span class="lineNum">    5354 </span>            :                                 } else {
<span class="lineNum">    5355 </span><span class="lineNoCov">          0 :                                         if (sap)</span>
<span class="lineNum">    5356 </span><span class="lineNoCov">          0 :                                                 tkw-&gt;wait_sap = GF_FALSE;</span>
<span class="lineNum">    5357 </span>            : 
<span class="lineNum">    5358 </span><span class="lineNoCov">          0 :                                         if (!ctx-&gt;wait_dts_plus_one) {</span>
<span class="lineNum">    5359 </span><span class="lineNoCov">          0 :                                                 ctx-&gt;wait_dts_plus_one = 1 + gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">    5360 </span><span class="lineNoCov">          0 :                                                 ctx-&gt;wait_dts_timescale = tkw-&gt;src_timescale;</span>
<span class="lineNum">    5361 </span>            :                                         }
<span class="lineNum">    5362 </span>            :                                 }
<span class="lineNum">    5363 </span>            :                         }
<span class="lineNum">    5364 </span>            : 
<span class="lineNum">    5365 </span><span class="lineCov">       2179 :                         if (ctx-&gt;wait_dts_plus_one) {</span>
<span class="lineNum">    5366 </span><span class="lineNoCov">          0 :                                 ts = gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">    5367 </span><span class="lineNoCov">          0 :                                 if (ts==GF_FILTER_NO_TS)</span>
<span class="lineNum">    5368 </span><span class="lineNoCov">          0 :                                         ts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    5369 </span><span class="lineNoCov">          0 :                                 if (ts==GF_FILTER_NO_TS)</span>
<span class="lineNum">    5370 </span>            :                                         ts=0;
<span class="lineNum">    5371 </span>            : 
<span class="lineNum">    5372 </span><span class="lineNoCov">          0 :                                 if (ts * ctx-&gt;wait_dts_timescale &lt; (ctx-&gt;wait_dts_plus_one-1) * tkw-&gt;src_timescale) {</span>
<span class="lineNum">    5373 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_drop_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    5374 </span><span class="lineNoCov">          0 :                                         goto retry_pck;</span>
<span class="lineNum">    5375 </span>            :                                 }
<span class="lineNum">    5376 </span>            :                         }
<span class="lineNum">    5377 </span>            :                 }
<span class="lineNum">    5378 </span>            : 
<span class="lineNum">    5379 </span><span class="lineCov">       3197 :                 if (!pck) {</span>
<span class="lineNum">    5380 </span><span class="lineCov">       1018 :                         if (gf_filter_pid_is_eos(tkw-&gt;ipid)) {</span>
<span class="lineNum">    5381 </span><span class="lineCov">          9 :                                 if (tkw-&gt;cenc_state==CENC_NEED_SETUP)</span>
<span class="lineNum">    5382 </span><span class="lineCov">          1 :                                         mp4_mux_cenc_update(ctx, tkw, NULL, CENC_CONFIG, 0);</span>
<span class="lineNum">    5383 </span>            : 
<span class="lineNum">    5384 </span><span class="lineCov">          9 :                                 if (!tkw-&gt;nb_samples) {</span>
<span class="lineNum">    5385 </span><span class="lineCov">          9 :                                         const GF_PropertyValue *p = gf_filter_pid_get_property(tkw-&gt;ipid, GF_PROP_PID_ISOM_TREX_TEMPLATE);</span>
<span class="lineNum">    5386 </span><span class="lineCov">          9 :                                         if (p) {</span>
<span class="lineNum">    5387 </span><span class="lineCov">          2 :                                                 gf_isom_setup_track_fragment_template(ctx-&gt;file, tkw-&gt;track_id, p-&gt;value.data.ptr, p-&gt;value.data.size, ctx-&gt;nofragdef);</span>
<span class="lineNum">    5388 </span>            :                                         }
<span class="lineNum">    5389 </span>            :                                 }
<span class="lineNum">    5390 </span><span class="lineCov">          9 :                                 continue;</span>
<span class="lineNum">    5391 </span>            :                         }
<span class="lineNum">    5392 </span>            :                         return;
<span class="lineNum">    5393 </span>            :                 }
<span class="lineNum">    5394 </span>            :                 //we may have reorder tracks after the get_packet, redo
<span class="lineNum">    5395 </span><span class="lineCov">       2179 :                 if (gf_list_find(ctx-&gt;tracks, tkw) != i) {</span>
<span class="lineNum">    5396 </span>            :                         mp4_mux_config_timing(ctx);
<span class="lineNum">    5397 </span>            :                         return;
<span class="lineNum">    5398 </span>            :                 }
<span class="lineNum">    5399 </span><span class="lineCov">       2178 :                 ts = gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">    5400 </span><span class="lineCov">       2178 :                 if (ts==GF_FILTER_NO_TS)</span>
<span class="lineNum">    5401 </span><span class="lineNoCov">          0 :                         ts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    5402 </span><span class="lineCov">       2178 :                 if (ts==GF_FILTER_NO_TS)</span>
<span class="lineNum">    5403 </span>            :                         ts=0;
<span class="lineNum">    5404 </span>            : 
<span class="lineNum">    5405 </span><span class="lineCov">       2178 :                 dts_min = ts * 1000000;</span>
<span class="lineNum">    5406 </span><span class="lineCov">       2178 :                 dts_min /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    5407 </span>            : 
<span class="lineNum">    5408 </span><span class="lineCov">       2178 :                 if (first_ts_min &gt; dts_min) {</span>
<span class="lineNum">    5409 </span>            :                         first_ts_min = (u64) dts_min;
<span class="lineNum">    5410 </span>            :                 }
<span class="lineNum">    5411 </span><span class="lineCov">       2178 :                 tkw-&gt;ts_shift = ts;</span>
<span class="lineNum">    5412 </span>            :         }
<span class="lineNum">    5413 </span><span class="lineCov">       1299 :         if (first_ts_min==(u64)-1)</span>
<span class="lineNum">    5414 </span>            :                 first_ts_min = 0;
<span class="lineNum">    5415 </span>            : 
<span class="lineNum">    5416 </span>            :         //for all packets with dts greater than min dts, we need to add a pause
<span class="lineNum">    5417 </span><span class="lineCov">       2747 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    5418 </span>            :                 s64 dts_diff, dur;
<span class="lineNum">    5419 </span><span class="lineCov">       1448 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    5420 </span>            : 
<span class="lineNum">    5421 </span>            :                 //compute offsets
<span class="lineNum">    5422 </span><span class="lineCov">       1448 :                 dts_diff = first_ts_min;</span>
<span class="lineNum">    5423 </span><span class="lineCov">       1448 :                 dts_diff *= tkw-&gt;src_timescale;</span>
<span class="lineNum">    5424 </span><span class="lineCov">       1448 :                 dts_diff /= 1000000;</span>
<span class="lineNum">    5425 </span><span class="lineCov">       1448 :                 dts_diff = (s64) tkw-&gt;ts_shift - dts_diff;</span>
<span class="lineNum">    5426 </span><span class="lineCov">       1448 :                 if (ctx-&gt;is_rewind) dts_diff = -dts_diff;</span>
<span class="lineNum">    5427 </span>            :                 //negative could happen due to rounding, ignore them
<span class="lineNum">    5428 </span><span class="lineCov">       1448 :                 if (dts_diff&lt;=0) continue;</span>
<span class="lineNum">    5429 </span>            : 
<span class="lineNum">    5430 </span>            :                 // dts_diff &gt; 0, we need to delay the track
<span class="lineNum">    5431 </span>            :                 dur = dts_diff;
<span class="lineNum">    5432 </span><span class="lineCov">         85 :                 dur *= (u32) ctx-&gt;moovts;</span>
<span class="lineNum">    5433 </span><span class="lineCov">         85 :                 dur /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    5434 </span><span class="lineCov">         85 :                 if (dur) {</span>
<span class="lineNum">    5435 </span><span class="lineCov">         52 :                         gf_isom_remove_edits(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    5436 </span>            : 
<span class="lineNum">    5437 </span><span class="lineCov">         52 :                         gf_isom_set_edit(ctx-&gt;file, tkw-&gt;track_num, 0, dur, dts_diff, GF_ISOM_EDIT_EMPTY);</span>
<span class="lineNum">    5438 </span><span class="lineCov">         52 :                         gf_isom_set_edit(ctx-&gt;file, tkw-&gt;track_num, dur, 0, 0, GF_ISOM_EDIT_NORMAL);</span>
<span class="lineNum">    5439 </span><span class="lineCov">         52 :                         tkw-&gt;empty_init_dur = (u64) dur;</span>
<span class="lineNum">    5440 </span>            :                 }
<span class="lineNum">    5441 </span>            :         }
<span class="lineNum">    5442 </span>            : 
<span class="lineNum">    5443 </span><span class="lineCov">       1299 :         ctx-&gt;config_timing = GF_FALSE;</span>
<a name="5444"><span class="lineNum">    5444 </span>            : }</a>
<span class="lineNum">    5445 </span>            : 
<span class="lineNum">    5446 </span><span class="lineCov">     684042 : void mp4_mux_format_report(GF_Filter *filter, GF_MP4MuxCtx *ctx, u64 done, u64 total)</span>
<span class="lineNum">    5447 </span>            : {
<span class="lineNum">    5448 </span>            :         Bool status_changed=GF_FALSE;
<span class="lineNum">    5449 </span>            :         u32 total_pc = 0;
<span class="lineNum">    5450 </span>            :         char szStatus[2048], szTK[20];
<span class="lineNum">    5451 </span><span class="lineCov">     684042 :         if (!gf_filter_reporting_enabled(filter))</span>
<span class="lineNum">    5452 </span><span class="lineCov">     684042 :                 return;</span>
<span class="lineNum">    5453 </span><span class="lineNoCov">          0 :         if (!ctx-&gt;update_report)</span>
<span class="lineNum">    5454 </span>            :                 return;
<span class="lineNum">    5455 </span>            : 
<span class="lineNum">    5456 </span><span class="lineNoCov">          0 :         ctx-&gt;update_report = GF_FALSE;</span>
<span class="lineNum">    5457 </span>            : 
<span class="lineNum">    5458 </span><span class="lineNoCov">          0 :         if (ctx-&gt;config_timing) {</span>
<span class="lineNum">    5459 </span>            :                 sprintf(szStatus, &quot;waiting for clock init&quot;);
<span class="lineNum">    5460 </span>            :                 status_changed = GF_TRUE;
<span class="lineNum">    5461 </span><span class="lineNoCov">          0 :         } else if (total) {</span>
<span class="lineNum">    5462 </span><span class="lineNoCov">          0 :                 if (done&gt;=total) {</span>
<span class="lineNum">    5463 </span>            :                         Double ohead = 0;
<span class="lineNum">    5464 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;total_bytes_in) ohead =  ((Double) (ctx-&gt;total_bytes_out - ctx-&gt;total_bytes_in)*100 / ctx-&gt;total_bytes_in);</span>
<span class="lineNum">    5465 </span>            : 
<span class="lineNum">    5466 </span><span class="lineNoCov">          0 :                         sprintf(szStatus, &quot;done %d samples - bytes &quot;LLU&quot; in &quot;LLU&quot; out - overhead %02.02f%% (%02.02g B/sample)&quot;, ctx-&gt;total_samples, ctx-&gt;total_bytes_in, ctx-&gt;total_bytes_out, ohead, ((Double)(ctx-&gt;total_bytes_out-ctx-&gt;total_bytes_in))/ctx-&gt;total_samples);</span>
<span class="lineNum">    5467 </span>            :                         status_changed = GF_TRUE;
<span class="lineNum">    5468 </span>            :                         total_pc = 10000;
<span class="lineNum">    5469 </span>            : 
<span class="lineNum">    5470 </span>            :                 } else {
<span class="lineNum">    5471 </span><span class="lineNoCov">          0 :                         u32 pc = (u32) ((done*10000)/total);</span>
<span class="lineNum">    5472 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;last_mux_pc == pc + 1) return;</span>
<span class="lineNum">    5473 </span><span class="lineNoCov">          0 :                         ctx-&gt;last_mux_pc = pc + 1;</span>
<span class="lineNum">    5474 </span>            :                         sprintf(szStatus, &quot;mux %d%%&quot;, pc);
<span class="lineNum">    5475 </span>            :                         status_changed = GF_TRUE;
<span class="lineNum">    5476 </span>            :                 }
<span class="lineNum">    5477 </span>            :         } else {
<span class="lineNum">    5478 </span><span class="lineNoCov">          0 :                 u32 i, count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    5479 </span>            :                 Bool is_frag = GF_FALSE;
<span class="lineNum">    5480 </span>            : 
<span class="lineNum">    5481 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;store&gt;=MP4MX_MODE_FRAG) {</span>
<span class="lineNum">    5482 </span><span class="lineNoCov">          0 :                         Double next = ((Double)ctx-&gt;next_frag_start)/ctx-&gt;cdur.den;</span>
<span class="lineNum">    5483 </span>            :                         is_frag = GF_TRUE;
<span class="lineNum">    5484 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;dash_mode) {</span>
<span class="lineNum">    5485 </span><span class="lineNoCov">          0 :                                 sprintf(szStatus, &quot;mux segments %d (frags %d) next %02.02g&quot;, ctx-&gt;nb_segs, ctx-&gt;nb_frags_in_seg, next);</span>
<span class="lineNum">    5486 </span>            :                         } else {
<span class="lineNum">    5487 </span><span class="lineNoCov">          0 :                                 sprintf(szStatus, &quot;mux frags %d next %02.02g&quot;, ctx-&gt;nb_frags, next);</span>
<span class="lineNum">    5488 </span>            :                         }
<span class="lineNum">    5489 </span>            :                 } else {
<span class="lineNum">    5490 </span><span class="lineNoCov">          0 :                         sprintf(szStatus, &quot;%s&quot;, ((ctx-&gt;store==MP4MX_MODE_FLAT) || (ctx-&gt;store==MP4MX_MODE_FASTSTART)) ? &quot;mux&quot; : &quot;import&quot;);</span>
<span class="lineNum">    5491 </span>            :                 }
<span class="lineNum">    5492 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    5493 </span>            :                         u32 pc=0;
<span class="lineNum">    5494 </span><span class="lineNoCov">          0 :                         TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    5495 </span><span class="lineNoCov">          0 :                         if (tkw-&gt;aborted) {</span>
<span class="lineNum">    5496 </span>            :                                 pc=10000;
<span class="lineNum">    5497 </span><span class="lineNoCov">          0 :                         } else if (ctx-&gt;idur.num) {</span>
<span class="lineNum">    5498 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;idur.num&gt;0) {</span>
<span class="lineNum">    5499 </span><span class="lineNoCov">          0 :                                         u64 mdur = gf_isom_get_media_duration(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    5500 </span><span class="lineNoCov">          0 :                                         u64 tk_done = mdur * ctx-&gt;idur.den;</span>
<span class="lineNum">    5501 </span><span class="lineNoCov">          0 :                                         u64 tk_total = ((u64)tkw-&gt;tk_timescale) * ctx-&gt;idur.num;</span>
<span class="lineNum">    5502 </span><span class="lineNoCov">          0 :                                         pc = (u32) ((tk_done*10000)/tk_total);</span>
<span class="lineNum">    5503 </span>            :                                 } else {
<span class="lineNum">    5504 </span><span class="lineNoCov">          0 :                                         pc = (u32) ( (10000 * (u64) tkw-&gt;nb_samples) / (-ctx-&gt;idur.num) );</span>
<span class="lineNum">    5505 </span>            :                                 }
<span class="lineNum">    5506 </span>            :                         } else {
<span class="lineNum">    5507 </span><span class="lineNoCov">          0 :                                 if (tkw-&gt;nb_frames) {</span>
<span class="lineNum">    5508 </span><span class="lineNoCov">          0 :                                         pc = (u32) ( (10000 * (u64) tkw-&gt;nb_samples) / tkw-&gt;nb_frames);</span>
<span class="lineNum">    5509 </span>            :                                 } else {
<span class="lineNum">    5510 </span><span class="lineNoCov">          0 :                                         if (tkw-&gt;pid_dur.num &amp;&amp; tkw-&gt;pid_dur.den) {</span>
<span class="lineNum">    5511 </span><span class="lineNoCov">          0 :                                                 pc = (u32) ((tkw-&gt;sample.DTS*10000 * tkw-&gt;pid_dur.den) / (tkw-&gt;pid_dur.num * tkw-&gt;tk_timescale));</span>
<span class="lineNum">    5512 </span><span class="lineNoCov">          0 :                                         } else if (tkw-&gt;down_bytes &amp;&amp; tkw-&gt;down_size) {</span>
<span class="lineNum">    5513 </span><span class="lineNoCov">          0 :                                                 pc = (u32) (((tkw-&gt;down_bytes*10000) / tkw-&gt;down_size));</span>
<span class="lineNum">    5514 </span>            :                                         }
<span class="lineNum">    5515 </span>            :                                 }
<span class="lineNum">    5516 </span>            :                         }
<span class="lineNum">    5517 </span><span class="lineNoCov">          0 :                         if (pc&gt;10000)</span>
<span class="lineNum">    5518 </span>            :                                 pc=0;
<span class="lineNum">    5519 </span><span class="lineNoCov">          0 :                         if (tkw-&gt;last_import_pc != pc + 1) {</span>
<span class="lineNum">    5520 </span>            :                                 status_changed = GF_TRUE;
<span class="lineNum">    5521 </span><span class="lineNoCov">          0 :                                 tkw-&gt;last_import_pc = pc + 1;</span>
<span class="lineNum">    5522 </span>            :                         }
<span class="lineNum">    5523 </span><span class="lineNoCov">          0 :                         if (!total_pc || (total_pc &gt; pc))</span>
<span class="lineNum">    5524 </span>            :                                 total_pc = pc;
<span class="lineNum">    5525 </span>            : 
<span class="lineNum">    5526 </span><span class="lineNoCov">          0 :                         if (is_frag) {</span>
<span class="lineNum">    5527 </span><span class="lineNoCov">          0 :                                 sprintf(szTK, &quot; TK%d(%c): %d&quot;, tkw-&gt;track_id, tkw-&gt;status_type, tkw-&gt;samples_in_frag);</span>
<span class="lineNum">    5528 </span>            :                                 strcat(szStatus, szTK);
<span class="lineNum">    5529 </span>            :                                 status_changed = GF_TRUE;
<span class="lineNum">    5530 </span><span class="lineNoCov">          0 :                                 if (pc) {</span>
<span class="lineNum">    5531 </span><span class="lineNoCov">          0 :                                         sprintf(szTK, &quot; %d %%&quot;, pc/100);</span>
<span class="lineNum">    5532 </span>            :                                         strcat(szStatus, szTK);
<span class="lineNum">    5533 </span>            :                                 }
<span class="lineNum">    5534 </span>            :                         } else {
<span class="lineNum">    5535 </span><span class="lineNoCov">          0 :                                 sprintf(szTK, &quot; %s%d(%c): %d %%&quot;, tkw-&gt;is_item ? &quot;IT&quot; : &quot;TK&quot;, tkw-&gt;track_id, tkw-&gt;status_type, pc/100);</span>
<span class="lineNum">    5536 </span>            :                                 strcat(szStatus, szTK);
<span class="lineNum">    5537 </span>            :                         }
<span class="lineNum">    5538 </span>            :                 }
<span class="lineNum">    5539 </span>            :         }
<span class="lineNum">    5540 </span><span class="lineNoCov">          0 :         if (status_changed) {</span>
<span class="lineNum">    5541 </span><span class="lineNoCov">          0 :                 gf_filter_update_status(filter, total_pc, szStatus);</span>
<span class="lineNum">    5542 </span>            :         }
<span class="lineNum">    5543 </span>            : }
<a name="5544"><span class="lineNum">    5544 </span>            : </a>
<span class="lineNum">    5545 </span>            : 
<span class="lineNum">    5546 </span><span class="lineCov">     571765 : GF_Err mp4_mux_process(GF_Filter *filter)</span>
<span class="lineNum">    5547 </span>            : {
<span class="lineNum">    5548 </span><span class="lineCov">     571765 :         GF_MP4MuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    5549 </span><span class="lineCov">     571765 :         u32 nb_skip, nb_eos, nb_suspended, i, count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    5550 </span>            :         nb_skip = 0;
<span class="lineNum">    5551 </span>            :         nb_eos = 0;
<span class="lineNum">    5552 </span>            : 
<span class="lineNum">    5553 </span><span class="lineCov">     571765 :         if (ctx-&gt;config_timing) {</span>
<span class="lineNum">    5554 </span><span class="lineCov">       2885 :                 mp4_mux_config_timing(ctx);</span>
<span class="lineNum">    5555 </span><span class="lineCov">       2885 :                 if (ctx-&gt;config_timing) {</span>
<span class="lineNum">    5556 </span><span class="lineCov">       1586 :                         mp4_mux_format_report(filter, ctx, 0, 0);</span>
<span class="lineNum">    5557 </span><span class="lineCov">       1586 :                         return GF_OK;</span>
<span class="lineNum">    5558 </span>            :                 }
<span class="lineNum">    5559 </span>            :         }
<span class="lineNum">    5560 </span>            : 
<span class="lineNum">    5561 </span>            :         //fragmented mode
<span class="lineNum">    5562 </span><span class="lineCov">     570179 :         if (ctx-&gt;store&gt;=MP4MX_MODE_FRAG) {</span>
<span class="lineNum">    5563 </span>            :                 u32 done=0;
<span class="lineNum">    5564 </span><span class="lineCov">     120838 :                 GF_Err e = mp4_mux_process_fragmented(filter, ctx);</span>
<span class="lineNum">    5565 </span><span class="lineCov">     120838 :                 if (e==GF_EOS) done=100;</span>
<span class="lineNum">    5566 </span><span class="lineCov">     120838 :                 mp4_mux_format_report(filter, ctx, done, done);</span>
<span class="lineNum">    5567 </span><span class="lineCov">     120838 :                 return e;</span>
<span class="lineNum">    5568 </span>            :         }
<span class="lineNum">    5569 </span>            : 
<span class="lineNum">    5570 </span>            :         //regular mode
<span class="lineNum">    5571 </span>            :         nb_suspended = 0;
<span class="lineNum">    5572 </span><span class="lineCov">     576735 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    5573 </span><span class="lineCov">     576735 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    5574 </span><span class="lineCov">     576735 :                 GF_FilterPacket *pck = gf_filter_pid_get_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    5575 </span>            : 
<span class="lineNum">    5576 </span><span class="lineCov">     576735 :                 if (tkw-&gt;suspended) {</span>
<span class="lineNum">    5577 </span><span class="lineCov">        319 :                         nb_suspended++;</span>
<span class="lineNum">    5578 </span><span class="lineCov">        319 :                         continue;</span>
<span class="lineNum">    5579 </span>            :                 }
<span class="lineNum">    5580 </span>            : 
<span class="lineNum">    5581 </span><span class="lineCov">     576416 :                 if (!pck) {</span>
<span class="lineNum">    5582 </span><span class="lineCov">     125633 :                         if (gf_filter_pid_is_eos(tkw-&gt;ipid)) {</span>
<span class="lineNum">    5583 </span><span class="lineCov">      14866 :                                 tkw-&gt;suspended = GF_FALSE;</span>
<span class="lineNum">    5584 </span><span class="lineCov">      14866 :                                 nb_eos++;</span>
<span class="lineNum">    5585 </span>            :                         }
<span class="lineNum">    5586 </span><span class="lineCov">     125633 :                         if (tkw-&gt;aborted) {</span>
<span class="lineNum">    5587 </span><span class="lineCov">        571 :                                 nb_eos++;</span>
<span class="lineNum">    5588 </span>            :                         }
<span class="lineNum">    5589 </span><span class="lineCov">     125633 :                         continue;</span>
<span class="lineNum">    5590 </span>            :                 }
<span class="lineNum">    5591 </span>            : 
<span class="lineNum">    5592 </span><span class="lineCov">     450783 :                 if (tkw-&gt;aborted) {</span>
<span class="lineNum">    5593 </span><span class="lineCov">          8 :                         gf_filter_pid_drop_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    5594 </span><span class="lineCov">          8 :                         nb_eos++;</span>
<span class="lineNum">    5595 </span><span class="lineCov">          8 :                         continue;</span>
<span class="lineNum">    5596 </span>            :                 }
<span class="lineNum">    5597 </span>            : 
<span class="lineNum">    5598 </span><span class="lineCov">     450775 :                 if (ctx-&gt;owns_mov) {</span>
<span class="lineNum">    5599 </span>            :                         const GF_PropertyValue *p;
<span class="lineNum">    5600 </span><span class="lineCov">      94695 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENUM);</span>
<span class="lineNum">    5601 </span><span class="lineCov">      94695 :                         if (p) {</span>
<span class="lineNum">    5602 </span><span class="lineCov">        213 :                                 if (!ctx-&gt;cur_file_idx_plus_one) {</span>
<span class="lineNum">    5603 </span><span class="lineCov">         20 :                                         ctx-&gt;cur_file_idx_plus_one = p-&gt;value.uint + 1;</span>
<span class="lineNum">    5604 </span><span class="lineCov">         20 :                                         if (!ctx-&gt;cur_file_suffix) {</span>
<span class="lineNum">    5605 </span><span class="lineCov">         20 :                                                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILESUF);</span>
<span class="lineNum">    5606 </span><span class="lineCov">         20 :                                                 if (p &amp;&amp; p-&gt;value.string) ctx-&gt;cur_file_suffix = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">    5607 </span>            :                                         }
<span class="lineNum">    5608 </span><span class="lineCov">         20 :                                         ctx-&gt;notify_filename = GF_TRUE;</span>
<span class="lineNum">    5609 </span><span class="lineCov">        193 :                                 } else if (ctx-&gt;cur_file_idx_plus_one == p-&gt;value.uint+1) {</span>
<span class="lineNum">    5610 </span><span class="lineCov">         89 :                                 } else if (!tkw-&gt;suspended) {</span>
<span class="lineNum">    5611 </span><span class="lineCov">         89 :                                         tkw-&gt;suspended = GF_TRUE;</span>
<span class="lineNum">    5612 </span><span class="lineCov">         89 :                                         nb_suspended++;</span>
<span class="lineNum">    5613 </span><span class="lineCov">         89 :                                         ctx-&gt;next_file_idx =  p-&gt;value.uint + 1;</span>
<span class="lineNum">    5614 </span><span class="lineCov">         89 :                                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILESUF);</span>
<span class="lineNum">    5615 </span><span class="lineCov">         89 :                                         if (p &amp;&amp; p-&gt;value.string)</span>
<span class="lineNum">    5616 </span><span class="lineCov">         89 :                                                 ctx-&gt;next_file_suffix = p-&gt;value.string;</span>
<span class="lineNum">    5617 </span><span class="lineCov">         89 :                                         continue;</span>
<span class="lineNum">    5618 </span>            :                                 }
<span class="lineNum">    5619 </span>            :                         }
<span class="lineNum">    5620 </span>            :                 }
<span class="lineNum">    5621 </span>            : 
<span class="lineNum">    5622 </span>            :                 //basic regulation in case we do on-the-fly interleaving
<span class="lineNum">    5623 </span>            :                 //we need to regulate because sources do not produce packets at the same rate
<span class="lineNum">    5624 </span><span class="lineCov">     450686 :                 if ((ctx-&gt;store==MP4MX_MODE_FASTSTART) &amp;&amp; ctx-&gt;cdur.num) {</span>
<span class="lineNum">    5625 </span><span class="lineCov">       1304 :                         u64 cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    5626 </span><span class="lineCov">       1304 :                         if (ctx-&gt;is_rewind)</span>
<span class="lineNum">    5627 </span><span class="lineNoCov">          0 :                                 cts = tkw-&gt;ts_shift - cts;</span>
<span class="lineNum">    5628 </span>            :                         else
<span class="lineNum">    5629 </span><span class="lineCov">       1304 :                                 cts -= tkw-&gt;ts_shift;</span>
<span class="lineNum">    5630 </span>            : 
<span class="lineNum">    5631 </span><span class="lineCov">       1304 :                         if (!ctx-&gt;faststart_ts_regulate.num) {</span>
<span class="lineNum">    5632 </span><span class="lineCov">          2 :                                 ctx-&gt;faststart_ts_regulate = ctx-&gt;cdur;</span>
<span class="lineNum">    5633 </span>            :                         }
<span class="lineNum">    5634 </span>            :                         //ahead of our interleaving window, don't write yet
<span class="lineNum">    5635 </span><span class="lineCov">       1302 :                         else if (cts * ctx-&gt;faststart_ts_regulate.den &gt; ((u64) ctx-&gt;faststart_ts_regulate.num) * tkw-&gt;src_timescale) {</span>
<span class="lineNum">    5636 </span><span class="lineCov">        298 :                                 nb_skip++;</span>
<span class="lineNum">    5637 </span><span class="lineCov">        298 :                                 continue;</span>
<span class="lineNum">    5638 </span>            :                         }
<span class="lineNum">    5639 </span>            :                 }
<span class="lineNum">    5640 </span>            : 
<span class="lineNum">    5641 </span><span class="lineCov">     450388 :                 if (tkw-&gt;cenc_state==CENC_NEED_SETUP)</span>
<span class="lineNum">    5642 </span><span class="lineCov">         95 :                         mp4_mux_cenc_update(ctx, tkw, pck, CENC_CONFIG, 0);</span>
<span class="lineNum">    5643 </span>            : 
<span class="lineNum">    5644 </span><span class="lineCov">     450388 :                 if (tkw-&gt;is_item) {</span>
<span class="lineNum">    5645 </span><span class="lineCov">         64 :                         mp4_mux_process_item(ctx, tkw, pck);</span>
<span class="lineNum">    5646 </span>            :                 } else {
<span class="lineNum">    5647 </span><span class="lineCov">     450324 :                         mp4_mux_process_sample(ctx, tkw, pck, GF_FALSE);</span>
<span class="lineNum">    5648 </span>            :                 }
<span class="lineNum">    5649 </span>            : 
<span class="lineNum">    5650 </span><span class="lineCov">     450388 :                 gf_filter_pid_drop_packet(tkw-&gt;ipid);</span>
<span class="lineNum">    5651 </span><span class="lineCov">     450388 :                 if (tkw-&gt;aborted) {</span>
<span class="lineNum">    5652 </span><span class="lineCov">         82 :                         nb_eos++;</span>
<span class="lineNum">    5653 </span>            :                 }
<span class="lineNum">    5654 </span>            :         }
<span class="lineNum">    5655 </span><span class="lineCov">     449341 :         mp4_mux_format_report(filter, ctx, 0, 0);</span>
<span class="lineNum">    5656 </span>            : 
<span class="lineNum">    5657 </span><span class="lineCov">     449341 :         if (nb_suspended &amp;&amp; (nb_suspended+nb_eos==count)) {</span>
<span class="lineNum">    5658 </span><span class="lineCov">         56 :                 return mp4mx_reload_output(filter, ctx);</span>
<span class="lineNum">    5659 </span>            :         }
<span class="lineNum">    5660 </span>            : 
<span class="lineNum">    5661 </span><span class="lineCov">     449285 :         if (count == nb_eos) {</span>
<span class="lineNum">    5662 </span><span class="lineCov">       4268 :                 if (ctx-&gt;file) {</span>
<span class="lineNum">    5663 </span><span class="lineCov">        932 :                         GF_Err e = mp4_mux_done(filter, ctx, GF_TRUE);</span>
<span class="lineNum">    5664 </span><span class="lineCov">        932 :                         if (e) return e;</span>
<span class="lineNum">    5665 </span>            :                 }
<span class="lineNum">    5666 </span>            :                 return GF_EOS;
<span class="lineNum">    5667 </span>            :         }
<span class="lineNum">    5668 </span>            :         //done with this interleaving window, start next one
<span class="lineNum">    5669 </span><span class="lineCov">     445017 :         else if (nb_skip + nb_eos == count) {</span>
<span class="lineNum">    5670 </span><span class="lineCov">         21 :                 ctx-&gt;faststart_ts_regulate.num += ctx-&gt;cdur.num;</span>
<span class="lineNum">    5671 </span><span class="lineCov">     444996 :         } else if (ctx-&gt;importer) {</span>
<span class="lineNum">    5672 </span>            :                 u64 prog_done=0, prog_total=0;
<span class="lineNum">    5673 </span><span class="lineCov">     362608 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    5674 </span><span class="lineCov">     362608 :                         TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    5675 </span><span class="lineCov">     362608 :                         if (prog_done * tkw-&gt;prog_total &lt;= tkw-&gt;prog_done * prog_total) {</span>
<span class="lineNum">    5676 </span>            :                                 prog_done = tkw-&gt;prog_done;
<span class="lineNum">    5677 </span>            :                                 prog_total = tkw-&gt;prog_total;
<span class="lineNum">    5678 </span>            :                         }
<span class="lineNum">    5679 </span>            :                 }
<span class="lineNum">    5680 </span><span class="lineCov">     353532 :                 gf_set_progress(&quot;Import&quot;, prog_done, prog_total);</span>
<span class="lineNum">    5681 </span>            :         }
<span class="lineNum">    5682 </span>            : 
<span class="lineNum">    5683 </span>            :         return GF_OK;
<a name="5684"><span class="lineNum">    5684 </span>            : }</a>
<span class="lineNum">    5685 </span>            : 
<span class="lineNum">    5686 </span><span class="lineCov">          2 : static GF_Err mp4_mux_on_data_patch(void *cbk, u8 *data, u32 block_size, u64 file_offset, Bool is_insert)</span>
<span class="lineNum">    5687 </span>            : {
<span class="lineNum">    5688 </span>            :         GF_Filter *filter = (GF_Filter *) cbk;
<span class="lineNum">    5689 </span>            :         u8 *output;
<span class="lineNum">    5690 </span><span class="lineCov">          2 :         GF_MP4MuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    5691 </span>            : 
<span class="lineNum">    5692 </span><span class="lineCov">          2 :         GF_FilterPacket *pck = gf_filter_pck_new_alloc(ctx-&gt;opid, block_size, &amp;output);</span>
<span class="lineNum">    5693 </span><span class="lineCov">          2 :         if (!pck) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    5694 </span>            : 
<span class="lineNum">    5695 </span><span class="lineCov">          2 :         memcpy(output, data, block_size);</span>
<span class="lineNum">    5696 </span><span class="lineCov">          2 :         gf_filter_pck_set_framing(pck, GF_FALSE, GF_FALSE);</span>
<span class="lineNum">    5697 </span><span class="lineCov">          2 :         gf_filter_pck_set_seek_flag(pck, GF_TRUE);</span>
<span class="lineNum">    5698 </span><span class="lineCov">          2 :         if (is_insert)</span>
<span class="lineNum">    5699 </span><span class="lineCov">          1 :                 gf_filter_pck_set_interlaced(pck, 1);</span>
<span class="lineNum">    5700 </span><span class="lineCov">          2 :         gf_filter_pck_set_byte_offset(pck, file_offset);</span>
<span class="lineNum">    5701 </span><span class="lineCov">          2 :         gf_filter_pck_send(pck);</span>
<span class="lineNum">    5702 </span><span class="lineCov">          2 :         return GF_OK;</span>
<a name="5703"><span class="lineNum">    5703 </span>            : }</a>
<span class="lineNum">    5704 </span>            : 
<span class="lineNum">    5705 </span><span class="lineCov">      21222 : static GF_Err mp4_mux_on_data(void *cbk, u8 *data, u32 block_size)</span>
<span class="lineNum">    5706 </span>            : {
<span class="lineNum">    5707 </span>            :         GF_Filter *filter = (GF_Filter *) cbk;
<span class="lineNum">    5708 </span>            :         u8 *output;
<span class="lineNum">    5709 </span><span class="lineCov">      21222 :         GF_MP4MuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    5710 </span>            : 
<span class="lineNum">    5711 </span><span class="lineCov">      21222 :         ctx-&gt;total_bytes_out += block_size;</span>
<span class="lineNum">    5712 </span>            : 
<span class="lineNum">    5713 </span>            :         //flush pending packet in frag mode
<span class="lineNum">    5714 </span><span class="lineCov">      21222 :         mp4mux_send_output(ctx);</span>
<span class="lineNum">    5715 </span>            : 
<span class="lineNum">    5716 </span><span class="lineCov">      21222 :         if (ctx-&gt;final_sidx_flush) {</span>
<span class="lineNum">    5717 </span>            :                 GF_FilterPacket *pck;
<span class="lineNum">    5718 </span>            :                 u32 free_size=0;
<span class="lineNum">    5719 </span>            : 
<span class="lineNum">    5720 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;vodcache==MP4MX_VODCACHE_INSERT) {</span>
<span class="lineNum">    5721 </span><span class="lineNoCov">          0 :                         pck = gf_filter_pck_new_alloc(ctx-&gt;opid, block_size, &amp;output);</span>
<span class="lineNum">    5722 </span><span class="lineNoCov">          0 :                         if (!pck) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    5723 </span>            : 
<span class="lineNum">    5724 </span><span class="lineNoCov">          0 :                         memcpy(output, data, block_size);</span>
<span class="lineNum">    5725 </span><span class="lineNoCov">          0 :                         gf_filter_pck_set_framing(pck, GF_FALSE, GF_FALSE);</span>
<span class="lineNum">    5726 </span><span class="lineNoCov">          0 :                         gf_filter_pck_set_byte_offset(pck, ctx-&gt;sidx_chunk_offset);</span>
<span class="lineNum">    5727 </span><span class="lineNoCov">          0 :                         gf_filter_pck_set_seek_flag(pck, GF_TRUE);</span>
<span class="lineNum">    5728 </span><span class="lineNoCov">          0 :                         gf_filter_pck_set_interlaced(pck, 1);</span>
<span class="lineNum">    5729 </span><span class="lineNoCov">          0 :                         gf_filter_pck_send(pck);</span>
<span class="lineNum">    5730 </span>            :                 } else {
<span class="lineNum">    5731 </span>            :                         GF_BitStream *bs;
<span class="lineNum">    5732 </span>            :                         assert(!ctx-&gt;dst_pck);
<span class="lineNum">    5733 </span>            : 
<span class="lineNum">    5734 </span><span class="lineNoCov">          0 :                         if (block_size &gt; ctx-&gt;sidx_max_size) {</span>
<span class="lineNum">    5735 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Final SIDX chunk larger than preallocated block, will not flush SIDX (output file still readable). Try disabling nocache mode\n&quot;));</span>
<span class="lineNum">    5736 </span>            :                                 return GF_OK;
<span class="lineNum">    5737 </span>            :                         }
<span class="lineNum">    5738 </span><span class="lineNoCov">          0 :                         free_size = ctx-&gt;sidx_max_size - block_size;</span>
<span class="lineNum">    5739 </span><span class="lineNoCov">          0 :                         pck = gf_filter_pck_new_alloc(ctx-&gt;opid, ctx-&gt;sidx_max_size, &amp;output);</span>
<span class="lineNum">    5740 </span><span class="lineNoCov">          0 :                         if (!pck) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    5741 </span>            : 
<span class="lineNum">    5742 </span><span class="lineNoCov">          0 :                         gf_filter_pck_set_framing(pck, GF_FALSE, GF_FALSE);</span>
<span class="lineNum">    5743 </span><span class="lineNoCov">          0 :                         gf_filter_pck_set_byte_offset(pck, ctx-&gt;sidx_chunk_offset);</span>
<span class="lineNum">    5744 </span><span class="lineNoCov">          0 :                         gf_filter_pck_set_seek_flag(pck, GF_TRUE);</span>
<span class="lineNum">    5745 </span><span class="lineNoCov">          0 :                         bs = gf_bs_new(output, ctx-&gt;sidx_max_size, GF_BITSTREAM_WRITE);</span>
<span class="lineNum">    5746 </span><span class="lineNoCov">          0 :                         if (free_size) {</span>
<span class="lineNum">    5747 </span><span class="lineNoCov">          0 :                                 gf_bs_write_u32(bs, free_size);</span>
<span class="lineNum">    5748 </span><span class="lineNoCov">          0 :                                 gf_bs_write_u32(bs, GF_ISOM_BOX_TYPE_FREE);</span>
<span class="lineNum">    5749 </span><span class="lineNoCov">          0 :                                 gf_bs_skip_bytes(bs, free_size-8);</span>
<span class="lineNum">    5750 </span>            :                         }
<span class="lineNum">    5751 </span><span class="lineNoCov">          0 :                         gf_bs_write_data(bs, data, block_size);</span>
<span class="lineNum">    5752 </span><span class="lineNoCov">          0 :                         gf_bs_del(bs);</span>
<span class="lineNum">    5753 </span><span class="lineNoCov">          0 :                         gf_filter_pck_send(pck);</span>
<span class="lineNum">    5754 </span>            :                 }
<span class="lineNum">    5755 </span><span class="lineNoCov">          0 :                 mp4_mux_flush_seg(ctx, GF_TRUE, ctx-&gt;sidx_chunk_offset+free_size, ctx-&gt;sidx_chunk_offset+free_size + block_size - 1);</span>
<span class="lineNum">    5756 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    5757 </span>            :         }
<span class="lineNum">    5758 </span>            : 
<span class="lineNum">    5759 </span><span class="lineCov">      21222 :         if (ctx-&gt;store_output) {</span>
<span class="lineNum">    5760 </span><span class="lineCov">        276 :                 u32 nb_write = (u32) gf_fwrite(data, block_size, ctx-&gt;tmp_store);</span>
<span class="lineNum">    5761 </span><span class="lineCov">        276 :                 if (nb_write != block_size) {</span>
<span class="lineNum">    5762 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Error writing to temp cache: %d bytes write instead of %d\n&quot;, nb_write, block_size));</span>
<span class="lineNum">    5763 </span>            :                         return GF_IO_ERR;
<span class="lineNum">    5764 </span>            :                 }
<span class="lineNum">    5765 </span>            :                 return GF_OK;
<span class="lineNum">    5766 </span>            :         }
<span class="lineNum">    5767 </span>            : 
<span class="lineNum">    5768 </span>            :         //allocate new one
<span class="lineNum">    5769 </span><span class="lineCov">      20946 :         ctx-&gt;dst_pck = gf_filter_pck_new_alloc(ctx-&gt;opid, block_size, &amp;output);</span>
<span class="lineNum">    5770 </span><span class="lineCov">      20946 :         if (!ctx-&gt;dst_pck) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    5771 </span>            : 
<span class="lineNum">    5772 </span><span class="lineCov">      20946 :         memcpy(output, data, block_size);</span>
<span class="lineNum">    5773 </span><span class="lineCov">      20946 :         gf_filter_pck_set_framing(ctx-&gt;dst_pck, !ctx-&gt;first_pck_sent, GF_FALSE);</span>
<span class="lineNum">    5774 </span>            : 
<span class="lineNum">    5775 </span>            :         //set packet prop as string since we may discard the seg_name  packet before this packet is processed
<span class="lineNum">    5776 </span><span class="lineCov">      20946 :         if (!ctx-&gt;first_pck_sent &amp;&amp; ctx-&gt;seg_name) {</span>
<span class="lineNum">    5777 </span><span class="lineCov">       2484 :                 ctx-&gt;current_offset = 0;</span>
<span class="lineNum">    5778 </span><span class="lineCov">       2484 :                 gf_filter_pck_set_property(ctx-&gt;dst_pck, GF_PROP_PCK_FILENAME, &amp;PROP_STRING(ctx-&gt;seg_name) );</span>
<span class="lineNum">    5779 </span><span class="lineCov">       2484 :                 gf_filter_pck_set_property(ctx-&gt;dst_pck, GF_PROP_PCK_FILENUM, &amp;PROP_UINT(ctx-&gt;dash_seg_num_plus_one-1) );</span>
<span class="lineNum">    5780 </span>            :         }
<span class="lineNum">    5781 </span><span class="lineCov">      20946 :         if (ctx-&gt;min_cts_plus_one) {</span>
<span class="lineNum">    5782 </span><span class="lineCov">       4354 :                 u64 orig = ctx-&gt;min_cts_plus_one-1;</span>
<span class="lineNum">    5783 </span><span class="lineCov">       4354 :                 gf_filter_pck_set_cts(ctx-&gt;dst_pck, orig);</span>
<span class="lineNum">    5784 </span><span class="lineCov">       4354 :                 gf_filter_pck_set_duration(ctx-&gt;dst_pck, (u32) (ctx-&gt;min_cts_next_frag - orig) );</span>
<span class="lineNum">    5785 </span>            :         }
<span class="lineNum">    5786 </span>            : 
<span class="lineNum">    5787 </span><span class="lineCov">      20946 :         if ((ctx-&gt;llhls_mode&gt;1) &amp;&amp; ctx-&gt;fragment_started &amp;&amp; !ctx-&gt;frag_size &amp;&amp; ctx-&gt;dst_pck) {</span>
<span class="lineNum">    5788 </span><span class="lineCov">        130 :                 ctx-&gt;frag_num++;</span>
<span class="lineNum">    5789 </span><span class="lineCov">        130 :                 gf_filter_pck_set_property(ctx-&gt;dst_pck, GF_PROP_PCK_HLS_FRAG_NUM, &amp;PROP_UINT(ctx-&gt;frag_num));</span>
<span class="lineNum">    5790 </span>            :         }
<span class="lineNum">    5791 </span><span class="lineCov">      20946 :         ctx-&gt;frag_size += block_size;</span>
<span class="lineNum">    5792 </span>            : 
<span class="lineNum">    5793 </span><span class="lineCov">      20946 :         ctx-&gt;first_pck_sent = GF_TRUE;</span>
<span class="lineNum">    5794 </span><span class="lineCov">      20946 :         ctx-&gt;current_size += block_size;</span>
<span class="lineNum">    5795 </span>            :         //non-frag mode, send right away
<span class="lineNum">    5796 </span><span class="lineCov">      20946 :         if (ctx-&gt;store&lt;MP4MX_MODE_FRAG) {</span>
<span class="lineNum">    5797 </span><span class="lineCov">      16257 :                 mp4mux_send_output(ctx);</span>
<span class="lineNum">    5798 </span>            :         }
<span class="lineNum">    5799 </span>            :         return GF_OK;
<a name="5800"><span class="lineNum">    5800 </span>            : }</a>
<span class="lineNum">    5801 </span>            : 
<span class="lineNum">    5802 </span><span class="lineCov">     112277 : void mp4_mux_progress_cbk(void *udta, u64 done, u64 total)</span>
<span class="lineNum">    5803 </span>            : {
<span class="lineNum">    5804 </span>            :         GF_Filter *filter = (GF_Filter *)udta;
<span class="lineNum">    5805 </span><span class="lineCov">     112277 :         GF_MP4MuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    5806 </span><span class="lineCov">     112277 :         ctx-&gt;update_report = GF_TRUE;</span>
<span class="lineNum">    5807 </span><span class="lineCov">     112277 :         mp4_mux_format_report(filter, ctx, done, total);</span>
<a name="5808"><span class="lineNum">    5808 </span><span class="lineCov">     112277 : }</span></a>
<span class="lineNum">    5809 </span>            : 
<span class="lineNum">    5810 </span><span class="lineCov">       1332 : static GF_Err mp4_mux_initialize(GF_Filter *filter)</span>
<span class="lineNum">    5811 </span>            : {
<span class="lineNum">    5812 </span><span class="lineCov">       1332 :         GF_MP4MuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    5813 </span><span class="lineCov">       1332 :         gf_filter_set_max_extra_input_pids(filter, -1);</span>
<span class="lineNum">    5814 </span>            : 
<span class="lineNum">    5815 </span><span class="lineCov">       1332 :         if (ctx-&gt;file) {</span>
<span class="lineNum">    5816 </span><span class="lineCov">        608 :                 if (gf_isom_get_mode(ctx-&gt;file) &lt; GF_ISOM_OPEN_WRITE) return GF_BAD_PARAM;</span>
<span class="lineNum">    5817 </span><span class="lineCov">        608 :                 if (ctx-&gt;store&gt;=MP4MX_MODE_FRAG) {</span>
<span class="lineNum">    5818 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Cannot use fragmented output on already opened ISOBMF file\n&quot;));</span>
<span class="lineNum">    5819 </span>            :                         return GF_BAD_PARAM;
<span class="lineNum">    5820 </span>            :                 }
<span class="lineNum">    5821 </span><span class="lineCov">        608 :                 ctx-&gt;owns_mov = GF_FALSE;</span>
<span class="lineNum">    5822 </span><span class="lineCov">        608 :                 gf_filter_act_as_sink(filter);</span>
<span class="lineNum">    5823 </span>            :         } else {
<span class="lineNum">    5824 </span>            :                 u32 open_mode = GF_ISOM_OPEN_WRITE;
<span class="lineNum">    5825 </span><span class="lineCov">        724 :                 ctx-&gt;owns_mov = GF_TRUE;</span>
<span class="lineNum">    5826 </span>            : 
<span class="lineNum">    5827 </span><span class="lineCov">        724 :                 switch (ctx-&gt;store) {</span>
<span class="lineNum">    5828 </span><span class="lineCov">        383 :                 case MP4MX_MODE_INTER:</span>
<span class="lineNum">    5829 </span>            :                 case MP4MX_MODE_TIGHT:
<span class="lineNum">    5830 </span>            :                         open_mode = GF_ISOM_WRITE_EDIT;
<span class="lineNum">    5831 </span><span class="lineCov">        383 :                         break;</span>
<span class="lineNum">    5832 </span>            :                 }
<span class="lineNum">    5833 </span><span class="lineCov">        724 :                 ctx-&gt;file = gf_isom_open(&quot;_gpac_isobmff_redirect&quot;, open_mode, NULL);</span>
<span class="lineNum">    5834 </span><span class="lineCov">        724 :                 if (!ctx-&gt;file) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    5835 </span>            : 
<span class="lineNum">    5836 </span><span class="lineCov">        724 :                 gf_isom_set_write_callback(ctx-&gt;file, mp4_mux_on_data, mp4_mux_on_data_patch, filter, ctx-&gt;block_size);</span>
<span class="lineNum">    5837 </span>            : 
<span class="lineNum">    5838 </span><span class="lineCov">        724 :                 gf_isom_set_progress_callback(ctx-&gt;file, mp4_mux_progress_cbk, filter);</span>
<span class="lineNum">    5839 </span>            : 
<span class="lineNum">    5840 </span><span class="lineCov">        724 :                 if (ctx-&gt;dref &amp;&amp; (ctx-&gt;store&gt;=MP4MX_MODE_FRAG)) {</span>
<span class="lineNum">    5841 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Cannot use data reference in movie fragments, not supported. Ignoring it\n&quot;));</span>
<span class="lineNum">    5842 </span><span class="lineNoCov">          0 :                         ctx-&gt;dref = GF_FALSE;</span>
<span class="lineNum">    5843 </span>            :                 }
<span class="lineNum">    5844 </span>            : 
<span class="lineNum">    5845 </span><span class="lineCov">        724 :                 if (ctx-&gt;store==MP4MX_MODE_FASTSTART) {</span>
<span class="lineNum">    5846 </span><span class="lineCov">          1 :                         gf_isom_set_storage_mode(ctx-&gt;file, GF_ISOM_STORE_FASTSTART);</span>
<span class="lineNum">    5847 </span>            :                 }
<span class="lineNum">    5848 </span>            : 
<span class="lineNum">    5849 </span>            :         }
<span class="lineNum">    5850 </span><span class="lineCov">       1332 :         if (!ctx-&gt;moovts)</span>
<span class="lineNum">    5851 </span><span class="lineNoCov">          0 :                 ctx-&gt;moovts=600;</span>
<span class="lineNum">    5852 </span><span class="lineCov">       1332 :         if (!ctx-&gt;cdur.den) {</span>
<span class="lineNum">    5853 </span><span class="lineNoCov">          0 :                 ctx-&gt;cdur.num = 0;</span>
<span class="lineNum">    5854 </span><span class="lineNoCov">          0 :                 ctx-&gt;cdur.den = 1000;</span>
<span class="lineNum">    5855 </span>            :         }
<span class="lineNum">    5856 </span>            :         //we need at least ms precision for sfrag mode
<span class="lineNum">    5857 </span><span class="lineCov">       1332 :         if (ctx-&gt;cdur.den &lt; 1000) {</span>
<span class="lineNum">    5858 </span><span class="lineCov">       1262 :                 ctx-&gt;cdur.num = (s32) ( ((s64)ctx-&gt;cdur.num) * 1000 / ctx-&gt;cdur.den);</span>
<span class="lineNum">    5859 </span><span class="lineCov">       1262 :                 ctx-&gt;cdur.den = 1000;</span>
<span class="lineNum">    5860 </span>            :         }
<span class="lineNum">    5861 </span>            : 
<span class="lineNum">    5862 </span><span class="lineCov">       1332 :         if (ctx-&gt;mfra &amp;&amp; (ctx-&gt;store&gt;=MP4MX_MODE_FRAG)) {</span>
<span class="lineNum">    5863 </span><span class="lineCov">          1 :                 GF_Err e = gf_isom_enable_mfra(ctx-&gt;file);</span>
<span class="lineNum">    5864 </span><span class="lineCov">          1 :                 if (e) return e;</span>
<span class="lineNum">    5865 </span>            :         }
<span class="lineNum">    5866 </span>            : 
<span class="lineNum">    5867 </span><span class="lineCov">       1332 :         if (!ctx-&gt;tracks)</span>
<span class="lineNum">    5868 </span><span class="lineCov">       1272 :                 ctx-&gt;tracks = gf_list_new();</span>
<span class="lineNum">    5869 </span>            : 
<span class="lineNum">    5870 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">    5871 </span>            :         if (ctx-&gt;ctrni)
<span class="lineNum">    5872 </span>            :                 ctx-&gt;ctrn = GF_TRUE;
<span class="lineNum">    5873 </span>            : #endif
<span class="lineNum">    5874 </span>            : 
<span class="lineNum">    5875 </span><span class="lineCov">       1332 :         if (ctx-&gt;m4cc) {</span>
<span class="lineNum">    5876 </span><span class="lineNoCov">          0 :                 if (strlen(ctx-&gt;m4cc)==4)</span>
<span class="lineNum">    5877 </span><span class="lineNoCov">          0 :                         ctx-&gt;eos_marker = GF_4CC(ctx-&gt;m4cc[0], ctx-&gt;m4cc[1], ctx-&gt;m4cc[2], ctx-&gt;m4cc[3]);</span>
<span class="lineNum">    5878 </span>            :                 else {
<span class="lineNum">    5879 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Invalid segment marker 4cc %s, ignoring\n&quot;, ctx-&gt;m4cc));</span>
<span class="lineNum">    5880 </span>            :                 }
<span class="lineNum">    5881 </span>            :         }
<span class="lineNum">    5882 </span><span class="lineCov">       1332 :         if (ctx-&gt;compress) {</span>
<span class="lineNum">    5883 </span>            :                 u32 flags = 0;
<span class="lineNum">    5884 </span><span class="lineCov">          2 :                 if (ctx-&gt;fcomp) flags |= GF_ISOM_COMP_FORCE_ALL;</span>
<span class="lineNum">    5885 </span><span class="lineCov">          2 :                 if (ctx-&gt;otyp) flags |= GF_ISOM_COMP_WRAP_FTYPE;</span>
<span class="lineNum">    5886 </span><span class="lineCov">          2 :                 gf_isom_enable_compression(ctx-&gt;file, ctx-&gt;compress, flags);</span>
<span class="lineNum">    5887 </span>            :         }
<span class="lineNum">    5888 </span>            : 
<span class="lineNum">    5889 </span><span class="lineCov">       1332 :         if (ctx-&gt;cmaf) {</span>
<span class="lineNum">    5890 </span>            :                 //cf table 3, 4, 5 of CMAF
<span class="lineNum">    5891 </span><span class="lineNoCov">          0 :                 ctx-&gt;mvex = GF_TRUE;</span>
<span class="lineNum">    5892 </span><span class="lineNoCov">          0 :                 ctx-&gt;truns_first = GF_TRUE;</span>
<span class="lineNum">    5893 </span>            :                 //single trun, single traf (table 5 of CMAF)
<span class="lineNum">    5894 </span><span class="lineNoCov">          0 :                 ctx-&gt;strun = GF_TRUE;</span>
<span class="lineNum">    5895 </span><span class="lineNoCov">          0 :                 ctx-&gt;straf = GF_TRUE;</span>
<span class="lineNum">    5896 </span>            :                 //7.5.16 Every TrackFragmentBox shall contain a TrackFragmentBaseMediaDecodeTimeBox
<span class="lineNum">    5897 </span><span class="lineNoCov">          0 :                 ctx-&gt;tfdt_traf = GF_TRUE;</span>
<span class="lineNum">    5898 </span>            :                 //7.3.3 : If SegmentIndexBoxes exist, each subsegment referenced in the SegmentIndexBox shall be a single CMAF fragment
<span class="lineNum">    5899 </span><span class="lineNoCov">          0 :                 ctx-&gt;chain_sidx = GF_FALSE;</span>
<span class="lineNum">    5900 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;subs_sidx&gt;0)</span>
<span class="lineNum">    5901 </span><span class="lineNoCov">          0 :                         ctx-&gt;subs_sidx = 0;</span>
<span class="lineNum">    5902 </span>            : 
<span class="lineNum">    5903 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;cmaf==MP4MX_CMAF_CMF2) {</span>
<span class="lineNum">    5904 </span>            :                         /*7.7 cmf2
<span class="lineNum">    5905 </span>            : - default_sample_flags, sample_flags and first_sample_flags shall be set in the TrackFragmentHeaderBox and/or TrackRunBox to provide sample dependency information within each CMAF chunk and CMAF fragment.
<span class="lineNum">    5906 </span>            : - Default values or per sample values of sample duration and sample size shall be stored in each CMAF chunk’s TrackRunBox and/or TrackFragmentHeaderBox
<span class="lineNum">    5907 </span>            :                         */
<span class="lineNum">    5908 </span><span class="lineNoCov">          0 :                         ctx-&gt;nofragdef = GF_TRUE;</span>
<span class="lineNum">    5909 </span>            :                 }
<span class="lineNum">    5910 </span>            :         }
<span class="lineNum">    5911 </span>            :         return GF_OK;
<span class="lineNum">    5912 </span>            : }
<span class="lineNum">    5913 </span>            : 
<span class="lineNum">    5914 </span>            : //old code, commented - we track min/max cts while adding to avoid the time-consuming rescan below
<span class="lineNum">    5915 </span>            : #if 0
<span class="lineNum">    5916 </span>            : static void mp4_mux_get_min_max_cts(GF_MP4MuxCtx *ctx, TrackWriter *tkw, u64 *omax_cts, u64 *omin_cts)
<span class="lineNum">    5917 </span>            : {
<span class="lineNum">    5918 </span>            :         u32 i, count, di;
<span class="lineNum">    5919 </span>            :         u64 max_cts, min_cts, doff;
<span class="lineNum">    5920 </span>            : 
<span class="lineNum">    5921 </span>            :         count = gf_isom_get_sample_count(ctx-&gt;file, tkw-&gt;track_num);
<span class="lineNum">    5922 </span>            :         max_cts = 0;
<span class="lineNum">    5923 </span>            :         min_cts = (u64) -1;
<span class="lineNum">    5924 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    5925 </span>            :                 GF_ISOSample *s = gf_isom_get_sample_info(ctx-&gt;file, tkw-&gt;track_num, i+1, &amp;di, &amp;doff);
<span class="lineNum">    5926 </span>            :                 if (!s)
<span class="lineNum">    5927 </span>            :                         break;
<span class="lineNum">    5928 </span>            :                 if (tkw-&gt;clamp_ts_plus_one) {
<span class="lineNum">    5929 </span>            :                         if (s-&gt;DTS + s-&gt;CTS_Offset + 1 &gt;= tkw-&gt;clamp_ts_plus_one ) {
<span class="lineNum">    5930 </span>            :                                 gf_isom_sample_del(&amp;s);
<span class="lineNum">    5931 </span>            :                                 continue;
<span class="lineNum">    5932 </span>            :                         }
<span class="lineNum">    5933 </span>            :                 }
<span class="lineNum">    5934 </span>            : 
<span class="lineNum">    5935 </span>            :                 if (s-&gt;DTS + s-&gt;CTS_Offset &gt; max_cts)
<span class="lineNum">    5936 </span>            :                         max_cts = s-&gt;DTS + s-&gt;CTS_Offset;
<span class="lineNum">    5937 </span>            : 
<span class="lineNum">    5938 </span>            :                 if (min_cts &gt; s-&gt;DTS + s-&gt;CTS_Offset)
<span class="lineNum">    5939 </span>            :                         min_cts = s-&gt;DTS + s-&gt;CTS_Offset;
<span class="lineNum">    5940 </span>            : 
<span class="lineNum">    5941 </span>            :                 gf_isom_sample_del(&amp;s);
<span class="lineNum">    5942 </span>            :         }
<span class="lineNum">    5943 </span>            :         *omax_cts = max_cts;
<span class="lineNum">    5944 </span>            :         *omin_cts = min_cts;
<span class="lineNum">    5945 </span>            : }
<a name="5946"><span class="lineNum">    5946 </span>            : #endif</a>
<span class="lineNum">    5947 </span>            : 
<span class="lineNum">    5948 </span><span class="lineCov">        276 : static void mp4_mux_update_edit_list_for_bframes(GF_MP4MuxCtx *ctx, TrackWriter *tkw)</span>
<span class="lineNum">    5949 </span>            : {
<span class="lineNum">    5950 </span>            :         u64 max_cts, min_cts;
<span class="lineNum">    5951 </span>            :         s64 moffset;
<span class="lineNum">    5952 </span>            : 
<span class="lineNum">    5953 </span><span class="lineCov">        276 :         if (ctx-&gt;ctmode &gt; MP4MX_CT_EDIT) return;</span>
<span class="lineNum">    5954 </span>            : 
<span class="lineNum">    5955 </span>            :         //if we have a complex edit list (due to track template), don't override
<span class="lineNum">    5956 </span><span class="lineCov">        276 :         if (gf_isom_get_edit_list_type(ctx-&gt;file, tkw-&gt;track_num, &amp;moffset)) return;</span>
<span class="lineNum">    5957 </span>            : 
<span class="lineNum">    5958 </span><span class="lineCov">        276 :         gf_isom_remove_edits(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    5959 </span>            : 
<span class="lineNum">    5960 </span>            : #if 0
<span class="lineNum">    5961 </span>            :         mp4_mux_get_min_max_cts(ctx, tkw, &amp;max_cts, &amp;min_cts);
<span class="lineNum">    5962 </span>            : #else
<span class="lineNum">    5963 </span><span class="lineCov">        276 :         max_cts = tkw-&gt;max_cts - tkw-&gt;min_neg_ctts;</span>
<span class="lineNum">    5964 </span><span class="lineCov">        276 :         min_cts = tkw-&gt;min_cts - tkw-&gt;min_neg_ctts;</span>
<span class="lineNum">    5965 </span>            : #endif
<span class="lineNum">    5966 </span>            : 
<span class="lineNum">    5967 </span><span class="lineCov">        276 :         if (min_cts || tkw-&gt;empty_init_dur) {</span>
<span class="lineNum">    5968 </span><span class="lineCov">        276 :                 max_cts -= min_cts;</span>
<span class="lineNum">    5969 </span><span class="lineCov">        276 :                 u32 count = gf_isom_get_sample_count(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    5970 </span><span class="lineCov">        276 :                 max_cts += gf_isom_get_sample_duration(ctx-&gt;file, tkw-&gt;track_num, count);</span>
<span class="lineNum">    5971 </span>            : 
<span class="lineNum">    5972 </span><span class="lineCov">        276 :                 max_cts *= ctx-&gt;moovts;</span>
<span class="lineNum">    5973 </span><span class="lineCov">        276 :                 max_cts /= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    5974 </span><span class="lineCov">        276 :                 if (tkw-&gt;empty_init_dur) {</span>
<span class="lineNum">    5975 </span>            : 
<span class="lineNum">    5976 </span><span class="lineCov">         27 :                         gf_isom_set_edit(ctx-&gt;file, tkw-&gt;track_num, 0, tkw-&gt;empty_init_dur, 0, GF_ISOM_EDIT_EMPTY);</span>
<span class="lineNum">    5977 </span><span class="lineCov">         27 :                         if (max_cts &gt;= tkw-&gt;empty_init_dur) max_cts -= tkw-&gt;empty_init_dur;</span>
<span class="lineNum">    5978 </span>            :                         else max_cts = 0;
<span class="lineNum">    5979 </span>            :                 }
<span class="lineNum">    5980 </span>            :                 //old arch compat: if we had a simple edit list in source try to keep the original segduration indicated
<span class="lineNum">    5981 </span>            :                 //we tolerate a diff of 100ms
<span class="lineNum">    5982 </span><span class="lineCov">        249 :                 else if (gf_sys_old_arch_compat() &amp;&amp; tkw-&gt;imported_edit_sdur &amp;&amp; (tkw-&gt;imported_edit_offset==min_cts)) {</span>
<span class="lineNum">    5983 </span>            :                         s32 diff;
<span class="lineNum">    5984 </span><span class="lineCov">         68 :                         u64 old_dur_ms = tkw-&gt;imported_edit_sdur * 1000 / tkw-&gt;src_timescale;</span>
<span class="lineNum">    5985 </span><span class="lineCov">         68 :                         u64 new_dur_ms = max_cts * 1000 / tkw-&gt;tk_timescale;</span>
<span class="lineNum">    5986 </span><span class="lineCov">         68 :                         diff = (s32) new_dur_ms - (s32) old_dur_ms;</span>
<span class="lineNum">    5987 </span><span class="lineCov">         68 :                         if (ABS(diff)&lt;100)</span>
<span class="lineNum">    5988 </span>            :                                 max_cts = tkw-&gt;imported_edit_sdur;
<span class="lineNum">    5989 </span>            :                 }
<span class="lineNum">    5990 </span>            : 
<span class="lineNum">    5991 </span><span class="lineCov">        276 :                 gf_isom_set_edit(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;empty_init_dur, max_cts, min_cts, GF_ISOM_EDIT_NORMAL);</span>
<span class="lineNum">    5992 </span>            :         }
<span class="lineNum">    5993 </span>            : }
<span class="lineNum">    5994 </span>            : 
<span class="lineNum">    5995 </span>            : //todo: move from media_import.c to here once done
<span class="lineNum">    5996 </span>            : void gf_media_update_bitrate(GF_ISOFile *file, u32 track);
<a name="5997"><span class="lineNum">    5997 </span>            : </a>
<span class="lineNum">    5998 </span>            : 
<span class="lineNum">    5999 </span><span class="lineCov">       1488 : static void mp4_mux_set_hevc_groups(GF_MP4MuxCtx *ctx, TrackWriter *tkw)</span>
<span class="lineNum">    6000 </span>            : {
<span class="lineNum">    6001 </span>            :         u32 avc_base_track, hevc_base_track, ref_track_id;
<span class="lineNum">    6002 </span>            :         avc_base_track = hevc_base_track = 0;
<span class="lineNum">    6003 </span>            :         u32 i;
<span class="lineNum">    6004 </span><span class="lineCov">       1488 :         GF_PropertyEntry *pe=NULL;</span>
<span class="lineNum">    6005 </span><span class="lineCov">       1488 :         const GF_PropertyValue *p = gf_filter_pid_get_info_str(tkw-&gt;ipid, &quot;hevc:oinf&quot;, &amp;pe);</span>
<span class="lineNum">    6006 </span><span class="lineCov">       1488 :         if (p) {</span>
<span class="lineNum">    6007 </span><span class="lineCov">          6 :                 u32 gi=0;</span>
<span class="lineNum">    6008 </span><span class="lineCov">          6 :                 gf_isom_add_sample_group_info(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_SAMPLE_GROUP_OINF, p-&gt;value.data.ptr, p-&gt;value.data.size, GF_TRUE, &amp;gi);</span>
<span class="lineNum">    6009 </span>            : 
<span class="lineNum">    6010 </span><span class="lineCov">          6 :                 p = gf_filter_pid_get_info_str(tkw-&gt;ipid, &quot;hevc:linf&quot;, &amp;pe);</span>
<span class="lineNum">    6011 </span><span class="lineCov">          6 :                 if (p) {</span>
<span class="lineNum">    6012 </span><span class="lineCov">          6 :                         gf_isom_add_sample_group_info(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_SAMPLE_GROUP_LINF, p-&gt;value.data.ptr, p-&gt;value.data.size, GF_TRUE, &amp;gi);</span>
<span class="lineNum">    6013 </span><span class="lineCov">          6 :                         gf_isom_set_track_group(ctx-&gt;file, tkw-&gt;track_num, 1000+gf_isom_get_track_id(ctx-&gt;file, tkw-&gt;track_num), GF_ISOM_BOX_TYPE_CSTG, GF_TRUE);</span>
<span class="lineNum">    6014 </span>            :                 }
<span class="lineNum">    6015 </span>            :         }
<span class="lineNum">    6016 </span>            : 
<span class="lineNum">    6017 </span><span class="lineCov">       1488 :         gf_filter_release_property(pe);</span>
<span class="lineNum">    6018 </span>            : 
<span class="lineNum">    6019 </span><span class="lineCov">       1488 :         p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;hevc:min_lid&quot;);</span>
<span class="lineNum">    6020 </span><span class="lineCov">       1488 :         if ((!p || !p-&gt;value.uint) &amp;&amp; (tkw-&gt;codecid!=GF_CODECID_LHVC)) {</span>
<span class="lineNum">    6021 </span><span class="lineCov">       1488 :                 return;</span>
<span class="lineNum">    6022 </span>            :         }
<span class="lineNum">    6023 </span>            :         //set linf
<span class="lineNum">    6024 </span><span class="lineNoCov">          0 :         for (i=0; i &lt; gf_isom_get_track_count(ctx-&gt;file); i++) {</span>
<span class="lineNum">    6025 </span><span class="lineNoCov">          0 :                 u32 subtype = gf_isom_get_media_subtype(ctx-&gt;file, i+1, 1);</span>
<span class="lineNum">    6026 </span><span class="lineNoCov">          0 :                 switch (subtype) {</span>
<span class="lineNum">    6027 </span><span class="lineNoCov">          0 :                 case GF_ISOM_SUBTYPE_AVC_H264:</span>
<span class="lineNum">    6028 </span>            :                 case GF_ISOM_SUBTYPE_AVC2_H264:
<span class="lineNum">    6029 </span>            :                 case GF_ISOM_SUBTYPE_AVC3_H264:
<span class="lineNum">    6030 </span>            :                 case GF_ISOM_SUBTYPE_AVC4_H264:
<span class="lineNum">    6031 </span><span class="lineNoCov">          0 :                         if (!avc_base_track) {</span>
<span class="lineNum">    6032 </span>            :                                 avc_base_track = i+1;
<span class="lineNum">    6033 </span>            :                         } else {
<span class="lineNum">    6034 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Warning: More than one AVC bitstream found, use track %d as base layer&quot;, avc_base_track));</span>
<span class="lineNum">    6035 </span>            :                         }
<span class="lineNum">    6036 </span>            :                         break;
<span class="lineNum">    6037 </span><span class="lineNoCov">          0 :                 case GF_ISOM_SUBTYPE_HVC1:</span>
<span class="lineNum">    6038 </span>            :                 case GF_ISOM_SUBTYPE_HEV1:
<span class="lineNum">    6039 </span>            :                 case GF_ISOM_SUBTYPE_HVC2:
<span class="lineNum">    6040 </span>            :                 case GF_ISOM_SUBTYPE_HEV2:
<span class="lineNum">    6041 </span><span class="lineNoCov">          0 :                         if (!hevc_base_track) {</span>
<span class="lineNum">    6042 </span>            :                                 hevc_base_track = i+1;
<span class="lineNum">    6043 </span><span class="lineNoCov">          0 :                                 if (avc_base_track) {</span>
<span class="lineNum">    6044 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Warning: Found both AVC and HEVC tracks, using HEVC track %d as base layer\n&quot;, hevc_base_track));</span>
<span class="lineNum">    6045 </span>            :                                 }
<span class="lineNum">    6046 </span>            :                         } else {
<span class="lineNum">    6047 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Warning: More than one HEVC bitstream found, use track %d as base layer\n&quot;, avc_base_track));</span>
<span class="lineNum">    6048 </span>            :                         }
<span class="lineNum">    6049 </span>            :                         break;
<span class="lineNum">    6050 </span>            :                 }
<span class="lineNum">    6051 </span>            :         }
<span class="lineNum">    6052 </span><span class="lineNoCov">          0 :         if (!hevc_base_track &amp;&amp; !avc_base_track) {</span>
<span class="lineNum">    6053 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Using LHVC external base layer, but no base layer not found - NOT SETTING SBAS TRACK REFERENCE!\n&quot;));</span>
<span class="lineNum">    6054 </span>            :         } else {
<span class="lineNum">    6055 </span><span class="lineNoCov">          0 :                 ref_track_id = gf_isom_get_track_id(ctx-&gt;file, hevc_base_track ? hevc_base_track : avc_base_track);</span>
<span class="lineNum">    6056 </span><span class="lineNoCov">          0 :                 gf_isom_set_track_reference(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_REF_BASE, ref_track_id);</span>
<span class="lineNum">    6057 </span>            : 
<span class="lineNum">    6058 </span><span class="lineNoCov">          0 :                 if (hevc_base_track) {</span>
<span class="lineNum">    6059 </span><span class="lineNoCov">          0 :                         ref_track_id = gf_isom_get_track_id(ctx-&gt;file, hevc_base_track);</span>
<span class="lineNum">    6060 </span><span class="lineNoCov">          0 :                         gf_isom_set_track_reference(ctx-&gt;file, tkw-&gt;track_num, GF_ISOM_REF_OREF, ref_track_id);</span>
<span class="lineNum">    6061 </span>            :                 }
<span class="lineNum">    6062 </span>            :         }
<a name="6063"><span class="lineNum">    6063 </span>            : }</a>
<span class="lineNum">    6064 </span>            : 
<span class="lineNum">    6065 </span><span class="lineCov">        992 : static GF_Err mp4_mux_done(GF_Filter *filter, GF_MP4MuxCtx *ctx, Bool is_final)</span>
<span class="lineNum">    6066 </span>            : {
<span class="lineNum">    6067 </span>            :         GF_Err e = GF_OK;
<span class="lineNum">    6068 </span>            :         u32 i, count;
<span class="lineNum">    6069 </span><span class="lineCov">        992 :         GF_PropertyEntry *pe=NULL;</span>
<span class="lineNum">    6070 </span>            : 
<span class="lineNum">    6071 </span><span class="lineCov">        992 :         count = gf_list_count(ctx-&gt;tracks);</span>
<span class="lineNum">    6072 </span><span class="lineCov">       1099 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    6073 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">    6074 </span>            :                 Bool has_bframes = GF_FALSE;
<span class="lineNum">    6075 </span><span class="lineCov">       1099 :                 TrackWriter *tkw = gf_list_get(ctx-&gt;tracks, i);</span>
<span class="lineNum">    6076 </span>            : 
<span class="lineNum">    6077 </span><span class="lineCov">       1099 :                 if (tkw-&gt;min_neg_ctts&lt;0) {</span>
<span class="lineNum">    6078 </span>            :                         //use ctts v1 negative offsets
<span class="lineNum">    6079 </span><span class="lineCov">        177 :                         if (ctx-&gt;ctmode==MP4MX_CT_NEGCTTS) {</span>
<span class="lineNum">    6080 </span><span class="lineNoCov">          0 :                                 gf_isom_set_ctts_v1(ctx-&gt;file, tkw-&gt;track_num, (u32) -tkw-&gt;min_neg_ctts);</span>
<span class="lineNum">    6081 </span>            :                         }
<span class="lineNum">    6082 </span>            :                         //ctts v0
<span class="lineNum">    6083 </span>            :                         else {
<span class="lineNum">    6084 </span><span class="lineCov">        177 :                                 gf_isom_set_cts_packing(ctx-&gt;file, tkw-&gt;track_num, GF_TRUE);</span>
<span class="lineNum">    6085 </span><span class="lineCov">        177 :                                 gf_isom_shift_cts_offset(ctx-&gt;file, tkw-&gt;track_num, (s32) tkw-&gt;min_neg_ctts);</span>
<span class="lineNum">    6086 </span><span class="lineCov">        177 :                                 gf_isom_set_cts_packing(ctx-&gt;file, tkw-&gt;track_num, GF_FALSE);</span>
<span class="lineNum">    6087 </span><span class="lineCov">        177 :                                 gf_isom_set_composition_offset_mode(ctx-&gt;file, tkw-&gt;track_num, GF_FALSE);</span>
<span class="lineNum">    6088 </span>            : 
<span class="lineNum">    6089 </span><span class="lineCov">        177 :                                 mp4_mux_update_edit_list_for_bframes(ctx, tkw);</span>
<span class="lineNum">    6090 </span>            :                         }
<span class="lineNum">    6091 </span>            :                         has_bframes = GF_TRUE;
<span class="lineNum">    6092 </span><span class="lineCov">        922 :                 } else if (tkw-&gt;has_ctts &amp;&amp; (tkw-&gt;stream_type==GF_STREAM_VISUAL)) {</span>
<span class="lineNum">    6093 </span><span class="lineCov">         99 :                         mp4_mux_update_edit_list_for_bframes(ctx, tkw);</span>
<span class="lineNum">    6094 </span>            : 
<span class="lineNum">    6095 </span>            :                         has_bframes = GF_TRUE;
<span class="lineNum">    6096 </span><span class="lineCov">        823 :                 } else if (tkw-&gt;ts_delay || tkw-&gt;empty_init_dur) {</span>
<span class="lineNum">    6097 </span><span class="lineCov">         20 :                         gf_isom_update_edit_list_duration(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    6098 </span>            :                 }
<span class="lineNum">    6099 </span>            : 
<span class="lineNum">    6100 </span><span class="lineCov">       1099 :                 if (tkw-&gt;min_ts_seek_plus_one) {</span>
<span class="lineNum">    6101 </span><span class="lineCov">          8 :                         u64 min_ts = tkw-&gt;min_ts_seek_plus_one - 1;</span>
<span class="lineNum">    6102 </span><span class="lineCov">          8 :                         u64 mdur = gf_isom_get_media_duration(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    6103 </span>            :                         u32 delay = 0;
<span class="lineNum">    6104 </span><span class="lineCov">          8 :                         if (tkw-&gt;clamp_ts_plus_one) {</span>
<span class="lineNum">    6105 </span>            : #if 0
<span class="lineNum">    6106 </span>            :                                 u64 maxcts, mincts;
<span class="lineNum">    6107 </span>            :                                 mp4_mux_get_min_max_cts(ctx, tkw, &amp;maxcts, &amp;mincts);
<span class="lineNum">    6108 </span>            :                                 mdur = maxcts - mincts;
<span class="lineNum">    6109 </span>            : #else
<span class="lineNum">    6110 </span><span class="lineNoCov">          0 :                                 mdur = tkw-&gt;max_cts - tkw-&gt;min_cts;</span>
<span class="lineNum">    6111 </span><span class="lineNoCov">          0 :                                 mdur += tkw-&gt;max_cts_samp_dur;</span>
<span class="lineNum">    6112 </span>            : #endif
<span class="lineNum">    6113 </span>            :                         }
<span class="lineNum">    6114 </span><span class="lineCov">          8 :                         if (mdur &gt; min_ts)</span>
<span class="lineNum">    6115 </span><span class="lineCov">          6 :                                 mdur -= min_ts;</span>
<span class="lineNum">    6116 </span>            :                         else
<span class="lineNum">    6117 </span>            :                                 mdur = 0;
<span class="lineNum">    6118 </span>            : 
<span class="lineNum">    6119 </span><span class="lineCov">          8 :                         if ((ctx-&gt;ctmode!=MP4MX_CT_NEGCTTS) &amp;&amp; (tkw-&gt;ts_delay&lt;0) &amp;&amp; (tkw-&gt;stream_type==GF_STREAM_VISUAL)) {</span>
<span class="lineNum">    6120 </span><span class="lineNoCov">          0 :                                 delay = (u32) -tkw-&gt;ts_delay;</span>
<span class="lineNum">    6121 </span>            :                         }
<span class="lineNum">    6122 </span>            : 
<span class="lineNum">    6123 </span><span class="lineCov">          8 :                         if (tkw-&gt;src_timescale != tkw-&gt;tk_timescale) {</span>
<span class="lineNum">    6124 </span><span class="lineNoCov">          0 :                                 min_ts *= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    6125 </span><span class="lineNoCov">          0 :                                 min_ts /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    6126 </span><span class="lineNoCov">          0 :                                 delay *= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    6127 </span><span class="lineNoCov">          0 :                                 delay /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    6128 </span>            :                         }
<span class="lineNum">    6129 </span><span class="lineCov">          8 :                         mdur += delay;</span>
<span class="lineNum">    6130 </span>            : 
<span class="lineNum">    6131 </span><span class="lineCov">          8 :                         if (ctx-&gt;moovts != tkw-&gt;tk_timescale) {</span>
<span class="lineNum">    6132 </span><span class="lineCov">          8 :                                 mdur *= ctx-&gt;moovts;</span>
<span class="lineNum">    6133 </span><span class="lineCov">          8 :                                 mdur /= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    6134 </span>            :                         }
<span class="lineNum">    6135 </span><span class="lineCov">          8 :                         gf_isom_remove_edits(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    6136 </span><span class="lineCov">          8 :                         if (tkw-&gt;empty_init_dur)</span>
<span class="lineNum">    6137 </span><span class="lineCov">          2 :                                 gf_isom_set_edit(ctx-&gt;file, tkw-&gt;track_num, 0, tkw-&gt;empty_init_dur, 0, GF_ISOM_EDIT_EMPTY);</span>
<span class="lineNum">    6138 </span><span class="lineCov">          8 :                         gf_isom_set_edit(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;empty_init_dur, mdur, min_ts, GF_ISOM_EDIT_NORMAL);</span>
<span class="lineNum">    6139 </span>            :                 }
<span class="lineNum">    6140 </span>            : 
<span class="lineNum">    6141 </span><span class="lineCov">       1099 :                 if (tkw-&gt;force_ctts) {</span>
<span class="lineNum">    6142 </span>            :                         GF_Err gf_isom_force_ctts(GF_ISOFile *file, u32 track);
<span class="lineNum">    6143 </span><span class="lineCov">         85 :                         gf_isom_force_ctts(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    6144 </span>            :                 }
<span class="lineNum">    6145 </span>            : 
<span class="lineNum">    6146 </span><span class="lineCov">       1099 :                 gf_isom_purge_track_reference(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    6147 </span>            :                 
<span class="lineNum">    6148 </span><span class="lineCov">       1099 :                 if (ctx-&gt;importer &amp;&amp; ctx-&gt;idur.num &amp;&amp; ctx-&gt;idur.den) {</span>
<span class="lineNum">    6149 </span><span class="lineCov">         93 :                         u64 mdur = gf_isom_get_media_duration(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    6150 </span><span class="lineCov">         93 :                         u64 pdur = gf_isom_get_track_duration(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    6151 </span><span class="lineCov">         93 :                         if (pdur==mdur) {</span>
<span class="lineNum">    6152 </span><span class="lineCov">          1 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[MP4Mux] Imported %d frames - duration %g\n&quot;, tkw-&gt;nb_samples, ((Double)mdur)/tkw-&gt;tk_timescale ));</span>
<span class="lineNum">    6153 </span>            :                         } else {
<span class="lineNum">    6154 </span><span class="lineCov">         92 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[MP4Mux] Imported %d frames - media duration %g - track duration %g\n&quot;, tkw-&gt;nb_samples, ((Double)mdur)/tkw-&gt;tk_timescale, ((Double)pdur)/ctx-&gt;moovts ));</span>
<span class="lineNum">    6155 </span>            :                         }
<span class="lineNum">    6156 </span>            :                 }
<span class="lineNum">    6157 </span>            : 
<span class="lineNum">    6158 </span>            :                 /*this is plain ugly but since some encoders (divx) don't use the video PL correctly
<span class="lineNum">    6159 </span>            :                  we force the system video_pl to ASP@L5 since we have I, P, B in base layer*/
<span class="lineNum">    6160 </span><span class="lineCov">       1099 :                 if (tkw-&gt;codecid == GF_CODECID_MPEG4_PART2) {</span>
<span class="lineNum">    6161 </span>            :                         Bool force_rewrite = GF_FALSE;
<span class="lineNum">    6162 </span><span class="lineCov">         78 :                         u32 PL = tkw-&gt;media_profile_level;</span>
<span class="lineNum">    6163 </span><span class="lineCov">         78 :                         if (!PL) PL = 0x01;</span>
<span class="lineNum">    6164 </span>            : 
<span class="lineNum">    6165 </span><span class="lineCov">         78 :                         if (ctx-&gt;importer) {</span>
<span class="lineNum">    6166 </span><span class="lineCov">         21 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;Indicated Profile: %s\n&quot;, gf_m4v_get_profile_name((u8) PL) ));</span>
<span class="lineNum">    6167 </span>            :                         }
<span class="lineNum">    6168 </span>            : 
<span class="lineNum">    6169 </span><span class="lineCov">         78 :                         if (has_bframes &amp;&amp; (tkw-&gt;media_profile_level &lt;= 3)) {</span>
<span class="lineNum">    6170 </span>            :                                 PL = 0xF5;
<span class="lineNum">    6171 </span><span class="lineCov">          1 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[MP4Mux] Indicated profile doesn't include B-VOPs - forcing %s\n&quot;, gf_m4v_get_profile_name((u8) PL) ));</span>
<span class="lineNum">    6172 </span>            :                                 force_rewrite = GF_TRUE;
<span class="lineNum">    6173 </span>            :                         }
<span class="lineNum">    6174 </span><span class="lineCov">         78 :                         if (PL != tkw-&gt;media_profile_level) {</span>
<span class="lineNum">    6175 </span><span class="lineCov">          1 :                                 if (force_rewrite) {</span>
<span class="lineNum">    6176 </span>            : #ifndef GPAC_DISABLE_AV_PARSERS
<span class="lineNum">    6177 </span><span class="lineCov">          1 :                                         GF_ESD *esd = gf_isom_get_esd(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx);</span>
<span class="lineNum">    6178 </span>            :                                         assert(esd);
<span class="lineNum">    6179 </span><span class="lineCov">          1 :                                         gf_m4v_rewrite_pl(&amp;esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data, &amp;esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;dataLength, (u8) PL);</span>
<span class="lineNum">    6180 </span><span class="lineCov">          1 :                                         gf_isom_change_mpeg4_description(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;stsd_idx, esd);</span>
<span class="lineNum">    6181 </span><span class="lineCov">          1 :                                         gf_odf_desc_del((GF_Descriptor*)esd);</span>
<span class="lineNum">    6182 </span>            : #endif
<span class="lineNum">    6183 </span>            : 
<span class="lineNum">    6184 </span>            :                                 }
<span class="lineNum">    6185 </span><span class="lineCov">          1 :                                 if (!ctx-&gt;make_qt)</span>
<span class="lineNum">    6186 </span><span class="lineCov">          1 :                                         gf_isom_set_pl_indication(ctx-&gt;file, GF_ISOM_PL_VISUAL, PL);</span>
<span class="lineNum">    6187 </span>            :                         }
<span class="lineNum">    6188 </span>            :                 }
<span class="lineNum">    6189 </span>            : 
<span class="lineNum">    6190 </span>            : 
<span class="lineNum">    6191 </span><span class="lineCov">       1099 :                 if (tkw-&gt;has_append)</span>
<span class="lineNum">    6192 </span><span class="lineNoCov">          0 :                         gf_isom_refresh_size_info(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    6193 </span>            : 
<span class="lineNum">    6194 </span><span class="lineCov">       1099 :                 if ((tkw-&gt;nb_samples == 1) &amp;&amp; (ctx-&gt;idur.num&gt;0) &amp;&amp; ctx-&gt;idur.den) {</span>
<span class="lineNum">    6195 </span><span class="lineCov">         11 :                         u32 dur = tkw-&gt;tk_timescale * ctx-&gt;idur.num;</span>
<span class="lineNum">    6196 </span><span class="lineCov">         11 :                         dur /= ctx-&gt;idur.den;</span>
<span class="lineNum">    6197 </span><span class="lineCov">         11 :                         gf_isom_set_last_sample_duration(ctx-&gt;file, tkw-&gt;track_num, dur);</span>
<span class="lineNum">    6198 </span>            :                 }
<span class="lineNum">    6199 </span>            : 
<span class="lineNum">    6200 </span><span class="lineCov">       1099 :                 if (tkw-&gt;has_open_gop) {</span>
<span class="lineNum">    6201 </span><span class="lineCov">         19 :                         if (ctx-&gt;importer) {</span>
<span class="lineNum">    6202 </span><span class="lineCov">         15 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;OpenGOP detected - adjusting file brand\n&quot;));</span>
<span class="lineNum">    6203 </span>            :                         }
<span class="lineNum">    6204 </span><span class="lineCov">         19 :                         gf_isom_modify_alternate_brand(ctx-&gt;file, GF_ISOM_BRAND_ISO6, GF_TRUE);</span>
<span class="lineNum">    6205 </span>            :                 }
<span class="lineNum">    6206 </span>            : 
<span class="lineNum">    6207 </span><span class="lineCov">       1099 :                 mp4_mux_set_hevc_groups(ctx, tkw);</span>
<span class="lineNum">    6208 </span>            : 
<span class="lineNum">    6209 </span><span class="lineCov">       1099 :                 p = gf_filter_pid_get_info_str(tkw-&gt;ipid, &quot;ttxt:rem_last&quot;, &amp;pe);</span>
<span class="lineNum">    6210 </span><span class="lineCov">       1099 :                 if (p &amp;&amp; p-&gt;value.boolean)</span>
<span class="lineNum">    6211 </span><span class="lineCov">          3 :                         gf_isom_remove_sample(ctx-&gt;file, tkw-&gt;track_num, tkw-&gt;nb_samples);</span>
<span class="lineNum">    6212 </span>            : 
<span class="lineNum">    6213 </span><span class="lineCov">       1099 :                 p = gf_filter_pid_get_info_str(tkw-&gt;ipid, &quot;ttxt:last_dur&quot;, &amp;pe);</span>
<span class="lineNum">    6214 </span><span class="lineCov">       1099 :                 if (p) {</span>
<span class="lineNum">    6215 </span><span class="lineCov">         22 :                         u64 val = p-&gt;value.uint;</span>
<span class="lineNum">    6216 </span><span class="lineCov">         22 :                         if (tkw-&gt;src_timescale != tkw-&gt;tk_timescale) {</span>
<span class="lineNum">    6217 </span><span class="lineNoCov">          0 :                                 val *= tkw-&gt;tk_timescale;</span>
<span class="lineNum">    6218 </span><span class="lineNoCov">          0 :                                 val /= tkw-&gt;src_timescale;</span>
<span class="lineNum">    6219 </span>            :                         }
<span class="lineNum">    6220 </span><span class="lineCov">         22 :                         gf_isom_set_last_sample_duration(ctx-&gt;file, tkw-&gt;track_num, (u32) val);</span>
<span class="lineNum">    6221 </span>            :                 }
<span class="lineNum">    6222 </span>            : 
<span class="lineNum">    6223 </span><span class="lineCov">       1099 :                 if (tkw-&gt;is_nalu &amp;&amp; ctx-&gt;pack_nal &amp;&amp; (gf_isom_get_mode(ctx-&gt;file)!=GF_ISOM_OPEN_WRITE)) {</span>
<span class="lineNum">    6224 </span>            :                         u32 msize = 0;
<span class="lineNum">    6225 </span>            :                         Bool do_rewrite = GF_FALSE;
<span class="lineNum">    6226 </span><span class="lineCov">          1 :                         u32 j, stsd_count = gf_isom_get_sample_description_count(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    6227 </span><span class="lineCov">          1 :                         p = gf_filter_pid_get_info(tkw-&gt;ipid, GF_PROP_PID_MAX_NALU_SIZE, &amp;pe);</span>
<span class="lineNum">    6228 </span><span class="lineCov">          1 :                         msize = gf_get_bit_size(p-&gt;value.uint);</span>
<span class="lineNum">    6229 </span><span class="lineCov">          1 :                         if (msize&lt;8) msize = 8;</span>
<span class="lineNum">    6230 </span><span class="lineCov">          1 :                         else if (msize&lt;16) msize = 16;</span>
<span class="lineNum">    6231 </span>            :                         else msize = 32;
<span class="lineNum">    6232 </span>            : 
<span class="lineNum">    6233 </span>            :                         if (msize&lt;=0xFFFF) {
<span class="lineNum">    6234 </span><span class="lineCov">          2 :                                 for (j=0; j&lt;stsd_count; j++) {</span>
<span class="lineNum">    6235 </span><span class="lineCov">          1 :                                         u32 k = 8 * gf_isom_get_nalu_length_field(ctx-&gt;file, tkw-&gt;track_num, j+1);</span>
<span class="lineNum">    6236 </span><span class="lineCov">          1 :                                         if (k &gt; msize) {</span>
<span class="lineNum">    6237 </span>            :                                                 do_rewrite = GF_TRUE;
<span class="lineNum">    6238 </span>            :                                         }
<span class="lineNum">    6239 </span>            :                                 }
<span class="lineNum">    6240 </span><span class="lineCov">          1 :                                 if (do_rewrite) {</span>
<span class="lineNum">    6241 </span><span class="lineCov">          1 :                                         GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[MP4Mux] Adjusting NALU SizeLength to %d bits\n&quot;, msize ));</span>
<span class="lineNum">    6242 </span><span class="lineCov">          1 :                                         gf_media_nal_rewrite_samples(ctx-&gt;file, tkw-&gt;track_num, msize);</span>
<span class="lineNum">    6243 </span><span class="lineCov">          1 :                                         msize /= 8;</span>
<span class="lineNum">    6244 </span><span class="lineCov">          2 :                                         for (j=0; j&lt;stsd_count; j++) {</span>
<span class="lineNum">    6245 </span><span class="lineCov">          1 :                                                 gf_isom_set_nalu_length_field(ctx-&gt;file, tkw-&gt;track_num, j+1, msize);</span>
<span class="lineNum">    6246 </span>            :                                         }
<span class="lineNum">    6247 </span>            :                                 }
<span class="lineNum">    6248 </span>            :                         }
<span class="lineNum">    6249 </span>            :                 }
<span class="lineNum">    6250 </span>            : 
<span class="lineNum">    6251 </span>            :                 //don't update bitrate info for single sample tracks, unless MPEG-4 Systems - compatibility with old arch
<span class="lineNum">    6252 </span><span class="lineCov">       1099 :                 if (ctx-&gt;btrt &amp;&amp; !tkw-&gt;skip_bitrate_update &amp;&amp; ((tkw-&gt;nb_samples&gt;1) || ctx-&gt;m4sys) )</span>
<span class="lineNum">    6253 </span><span class="lineCov">        863 :                         gf_media_update_bitrate(ctx-&gt;file, tkw-&gt;track_num);</span>
<span class="lineNum">    6254 </span>            : 
<span class="lineNum">    6255 </span><span class="lineCov">       1099 :                 if (!tkw-&gt;box_patched) {</span>
<span class="lineNum">    6256 </span><span class="lineCov">       1002 :                         p = gf_filter_pid_get_property_str(tkw-&gt;ipid, &quot;boxpatch&quot;);</span>
<span class="lineNum">    6257 </span><span class="lineCov">       1002 :                         if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    6258 </span><span class="lineCov">          4 :                                 e = gf_isom_apply_box_patch(ctx-&gt;file, tkw-&gt;track_id ? tkw-&gt;track_id : tkw-&gt;item_id, p-&gt;value.string, GF_FALSE);</span>
<span class="lineNum">    6259 </span><span class="lineCov">          4 :                                 if (e) {</span>
<span class="lineNum">    6260 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to apply box patch %s to track %d: %s\n&quot;,</span>
<span class="lineNum">    6261 </span>            :                                                 p-&gt;value.string, tkw-&gt;track_id, gf_error_to_string(e) ));
<span class="lineNum">    6262 </span>            :                                 }
<span class="lineNum">    6263 </span>            :                         }
<span class="lineNum">    6264 </span><span class="lineCov">       1002 :                         tkw-&gt;box_patched = GF_TRUE;</span>
<span class="lineNum">    6265 </span>            :                 }
<span class="lineNum">    6266 </span>            :         }
<span class="lineNum">    6267 </span>            : 
<span class="lineNum">    6268 </span><span class="lineCov">        992 :         gf_filter_release_property(pe);</span>
<span class="lineNum">    6269 </span>            : 
<span class="lineNum">    6270 </span><span class="lineCov">        992 :         if (ctx-&gt;boxpatch &amp;&amp; !ctx-&gt;box_patched) {</span>
<span class="lineNum">    6271 </span><span class="lineCov">          3 :                 e = gf_isom_apply_box_patch(ctx-&gt;file, 0, ctx-&gt;boxpatch, GF_FALSE);</span>
<span class="lineNum">    6272 </span><span class="lineCov">          3 :                 if (e) {</span>
<span class="lineNum">    6273 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[MP4Mux] Unable to apply box patch %s: %s\n&quot;, ctx-&gt;boxpatch, gf_error_to_string(e) ));</span>
<span class="lineNum">    6274 </span>            :                 }
<span class="lineNum">    6275 </span><span class="lineCov">          3 :                 ctx-&gt;box_patched = GF_TRUE;</span>
<span class="lineNum">    6276 </span>            :         }
<span class="lineNum">    6277 </span>            : 
<span class="lineNum">    6278 </span>            : 
<span class="lineNum">    6279 </span><span class="lineCov">        992 :         if (ctx-&gt;owns_mov) {</span>
<span class="lineNum">    6280 </span><span class="lineCov">        386 :                 if (ctx-&gt;moovpad)</span>
<span class="lineNum">    6281 </span><span class="lineNoCov">          0 :                         gf_isom_set_inplace_padding(ctx-&gt;file, ctx-&gt;moovpad);</span>
<span class="lineNum">    6282 </span>            : 
<span class="lineNum">    6283 </span><span class="lineCov">        386 :                 switch (ctx-&gt;store) {</span>
<span class="lineNum">    6284 </span><span class="lineCov">        381 :                 case MP4MX_MODE_INTER:</span>
<span class="lineNum">    6285 </span><span class="lineCov">        381 :                         if (ctx-&gt;cdur.num==0) {</span>
<span class="lineNum">    6286 </span><span class="lineNoCov">          0 :                                 e = gf_isom_set_storage_mode(ctx-&gt;file, GF_ISOM_STORE_STREAMABLE);</span>
<span class="lineNum">    6287 </span>            :                         } else {
<span class="lineNum">    6288 </span><span class="lineCov">        381 :                                 e = gf_isom_make_interleave_ex(ctx-&gt;file, &amp;ctx-&gt;cdur);</span>
<span class="lineNum">    6289 </span>            :                         }
<span class="lineNum">    6290 </span>            :                         break;
<span class="lineNum">    6291 </span><span class="lineNoCov">          0 :                 case MP4MX_MODE_FLAT:</span>
<span class="lineNum">    6292 </span><span class="lineNoCov">          0 :                         e = gf_isom_set_storage_mode(ctx-&gt;file, GF_ISOM_STORE_FLAT);</span>
<span class="lineNum">    6293 </span>            :                         break;
<span class="lineNum">    6294 </span><span class="lineCov">          1 :                 case MP4MX_MODE_FASTSTART:</span>
<span class="lineNum">    6295 </span><span class="lineCov">          1 :                         e = gf_isom_set_storage_mode(ctx-&gt;file, GF_ISOM_STORE_FASTSTART);</span>
<span class="lineNum">    6296 </span>            :                         break;
<span class="lineNum">    6297 </span><span class="lineNoCov">          0 :                 case MP4MX_MODE_TIGHT:</span>
<span class="lineNum">    6298 </span><span class="lineNoCov">          0 :                         e = gf_isom_set_storage_mode(ctx-&gt;file, GF_ISOM_STORE_TIGHT);</span>
<span class="lineNum">    6299 </span>            :                         break;
<span class="lineNum">    6300 </span>            :                 }
<span class="lineNum">    6301 </span><span class="lineCov">        386 :                 if (e) {</span>
<span class="lineNum">    6302 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[MP4Mux] Failed to set storage mode: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    6303 </span>            :                 } else {
<span class="lineNum">    6304 </span><span class="lineCov">        386 :                         e = gf_isom_close(ctx-&gt;file);</span>
<span class="lineNum">    6305 </span><span class="lineCov">        386 :                         if (e) {</span>
<span class="lineNum">    6306 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[MP4Mux] Failed to write file: %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    6307 </span>            :                         }
<span class="lineNum">    6308 </span>            :                 }
<span class="lineNum">    6309 </span><span class="lineCov">        386 :                 ctx-&gt;file = NULL;</span>
<span class="lineNum">    6310 </span><span class="lineCov">        386 :                 if (is_final)</span>
<span class="lineNum">    6311 </span><span class="lineCov">        326 :                         gf_filter_pid_set_eos(ctx-&gt;opid);</span>
<span class="lineNum">    6312 </span>            :         } else {
<span class="lineNum">    6313 </span><span class="lineCov">        606 :                 ctx-&gt;file = NULL;</span>
<span class="lineNum">    6314 </span>            :         }
<span class="lineNum">    6315 </span><span class="lineCov">        992 :         return e;</span>
<a name="6316"><span class="lineNum">    6316 </span>            : }</a>
<span class="lineNum">    6317 </span>            : 
<span class="lineNum">    6318 </span><span class="lineCov">       1272 : static void mp4_mux_finalize(GF_Filter *filter)</span>
<span class="lineNum">    6319 </span>            : {
<span class="lineNum">    6320 </span><span class="lineCov">       1272 :         GF_MP4MuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    6321 </span>            : 
<span class="lineNum">    6322 </span><span class="lineCov">       1272 :         if (ctx-&gt;owns_mov &amp;&amp; (ctx-&gt;file || (ctx-&gt;store&gt;=MP4MX_MODE_FRAG))) {</span>
<span class="lineNum">    6323 </span><span class="lineCov">        338 :                 gf_isom_delete(ctx-&gt;file);</span>
<span class="lineNum">    6324 </span>            :         }
<span class="lineNum">    6325 </span>            : 
<span class="lineNum">    6326 </span><span class="lineCov">       2621 :         while (gf_list_count(ctx-&gt;tracks)) {</span>
<span class="lineNum">    6327 </span><span class="lineCov">       1349 :                 TrackWriter *tkw = gf_list_pop_back(ctx-&gt;tracks);</span>
<span class="lineNum">    6328 </span><span class="lineCov">       1349 :                 mp4_mux_track_writer_del(tkw);</span>
<span class="lineNum">    6329 </span>            :         }
<span class="lineNum">    6330 </span><span class="lineCov">       1272 :         gf_list_del(ctx-&gt;tracks);</span>
<span class="lineNum">    6331 </span><span class="lineCov">       1272 :         if (ctx-&gt;bs_r) gf_bs_del(ctx-&gt;bs_r);</span>
<span class="lineNum">    6332 </span><span class="lineCov">       1272 :         if (ctx-&gt;seg_name) gf_free(ctx-&gt;seg_name);</span>
<span class="lineNum">    6333 </span><span class="lineCov">       1272 :         if (ctx-&gt;tmp_store) gf_fclose(ctx-&gt;tmp_store);</span>
<span class="lineNum">    6334 </span><span class="lineCov">       1272 :         if (ctx-&gt;seg_sizes) gf_free(ctx-&gt;seg_sizes);</span>
<span class="lineNum">    6335 </span>            : 
<span class="lineNum">    6336 </span><span class="lineCov">       1272 :         if (ctx-&gt;cur_file_suffix) gf_free(ctx-&gt;cur_file_suffix);</span>
<span class="lineNum">    6337 </span>            : 
<span class="lineNum">    6338 </span><span class="lineCov">       1272 : }</span>
<span class="lineNum">    6339 </span>            : 
<span class="lineNum">    6340 </span>            : static const GF_FilterCapability MP4MuxCaps[] =
<span class="lineNum">    6341 </span>            : {
<span class="lineNum">    6342 </span>            :         //for now don't accept files as input, although we could store them as items, to refine
<span class="lineNum">    6343 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    6344 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_SCENE),
<span class="lineNum">    6345 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_OD),
<span class="lineNum">    6346 </span>            :         //we want framed media only
<span class="lineNum">    6347 </span>            :         CAP_BOOL(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_UNFRAMED, GF_TRUE),
<span class="lineNum">    6348 </span>            :         //and any codecid
<span class="lineNum">    6349 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_CODECID, GF_CODECID_NONE),
<span class="lineNum">    6350 </span>            :         CAP_STRING(GF_CAPS_OUTPUT_STATIC,  GF_PROP_PID_FILE_EXT, ISOM_FILE_EXT),
<span class="lineNum">    6351 </span>            :         CAP_STRING(GF_CAPS_OUTPUT_STATIC,  GF_PROP_PID_MIME, ISOM_FILE_MIME),
<span class="lineNum">    6352 </span>            :         {0},
<span class="lineNum">    6353 </span>            :         //for scene / OD / text, we don't want raw codecid (filters modifying a scene graph we don't expose)
<span class="lineNum">    6354 </span>            :         CAP_UINT(GF_CAPS_INPUT,GF_PROP_PID_STREAM_TYPE, GF_STREAM_SCENE),
<span class="lineNum">    6355 </span>            :         CAP_UINT(GF_CAPS_INPUT,GF_PROP_PID_STREAM_TYPE, GF_STREAM_OD),
<span class="lineNum">    6356 </span>            :         CAP_UINT(GF_CAPS_INPUT,GF_PROP_PID_STREAM_TYPE, GF_STREAM_TEXT),
<span class="lineNum">    6357 </span>            :         CAP_BOOL(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_UNFRAMED, GF_TRUE),
<span class="lineNum">    6358 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_CODECID, GF_CODECID_RAW),
<span class="lineNum">    6359 </span>            : };
<span class="lineNum">    6360 </span>            : 
<span class="lineNum">    6361 </span>            : 
<span class="lineNum">    6362 </span>            : #define OFFS(_n)        #_n, offsetof(GF_MP4MuxCtx, _n)
<span class="lineNum">    6363 </span>            : static const GF_FilterArgs MP4MuxArgs[] =
<span class="lineNum">    6364 </span>            : {
<span class="lineNum">    6365 </span>            :         { OFFS(m4sys), &quot;force MPEG-4 Systems signaling of tracks&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6366 </span>            :         { OFFS(dref), &quot;only references data from source file - not compatible with all media sources&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6367 </span>            :         { OFFS(ctmode), &quot;set composition offset mode for video tracks\n&quot;
<span class="lineNum">    6368 </span>            :         &quot;- edit: uses edit lists to shift first frame to presentation time 0\n&quot;
<span class="lineNum">    6369 </span>            :         &quot;- noedit: ignore edit lists and does not shift timeline\n&quot;
<span class="lineNum">    6370 </span>            :         &quot;- negctts: uses ctts v1 with possibly negative offsets and no edit lists&quot;, GF_PROP_UINT, &quot;edit&quot;, &quot;edit|noedit|negctts&quot;, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6371 </span>            :         { OFFS(idur), &quot;only import the specified duration. If negative, specify the number of coded frames to import&quot;, GF_PROP_FRACTION, &quot;0&quot;, NULL, 0},
<span class="lineNum">    6372 </span>            :         { OFFS(pack3gp), &quot;pack a given number of 3GPP audio frames in one sample&quot;, GF_PROP_UINT, &quot;1&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6373 </span>            :         { OFFS(importer), &quot;compatibility with old importer, displays import progress&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6374 </span>            :         { OFFS(pack_nal), &quot;repack NALU size length to minimum possible size for NALU-based video (AVC/HEVC/...)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6375 </span>            :         { OFFS(xps_inband), &quot;use inband (in sample data) parameter set for NALU-based video (AVC/HEVC/...)\n&quot;
<span class="lineNum">    6376 </span>            :         &quot;- no: paramater sets are not inband, several sample descriptions might be created\n&quot;
<span class="lineNum">    6377 </span>            :         &quot;- all: paramater sets are inband, no parameter sets in sample description\n&quot;
<span class="lineNum">    6378 </span>            :         &quot;- both: paramater sets are inband, signaled as inband, and also first set is kept in sample description\n&quot;
<span class="lineNum">    6379 </span>            :         &quot;- mix: creates non-standard files using single sample entry with first PSs found, and moves other PS inband&quot;, GF_PROP_UINT, &quot;no&quot;, &quot;no|all|both|mix&quot;, 0},
<span class="lineNum">    6380 </span>            :         { OFFS(store), &quot;file storage mode\n&quot;
<span class="lineNum">    6381 </span>            :         &quot;- inter: perform precise interleave of the file using [-cdur]() (requires temporary storage of all media)\n&quot;
<span class="lineNum">    6382 </span>            :         &quot;- flat: write samples as they arrive and moov at end (fastest mode)\n&quot;
<span class="lineNum">    6383 </span>            :         &quot;- fstart: write samples as they arrive and moov before mdat\n&quot;
<span class="lineNum">    6384 </span>            :         &quot;- tight:  uses per-sample interleaving of all tracks (requires temporary storage of all media)\n&quot;
<span class="lineNum">    6385 </span>            :         &quot;- frag: fragments the file using cdur duration\n&quot;
<span class="lineNum">    6386 </span>            :         &quot;- sfrag: framents the file using cdur duration but adjusting to start with SAP1/3&quot;, GF_PROP_UINT, &quot;inter&quot;, &quot;inter|flat|fstart|tight|frag|sfrag&quot;, 0},
<span class="lineNum">    6387 </span>            :         { OFFS(cdur), &quot;chunk duration for flat and interleaving modes or fragment duration for fragmentation modes\n&quot;
<span class="lineNum">    6388 </span>            :         &quot;- 0: no specific interleaving but moov first\n&quot;
<span class="lineNum">    6389 </span>            :         &quot;- negative: defaults to 1.0 unless overridden by storage profile&quot;, GF_PROP_FRACTION, &quot;-1/1&quot;, NULL, 0},
<span class="lineNum">    6390 </span>            :         { OFFS(moovts), &quot;timescale to use for movie. A negative value picks the media timescale of the first track added&quot;, GF_PROP_SINT, &quot;600&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6391 </span>            :         { OFFS(moof_first), &quot;generate fragments starting with moof then mdat&quot;, GF_PROP_BOOL, &quot;true&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6392 </span>            :         { OFFS(abs_offset), &quot;use absolute file offset in fragments rather than offsets from moof&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6393 </span>            :         { OFFS(fsap), &quot;split truns in video fragments at SAPs to reduce file size&quot;, GF_PROP_BOOL, &quot;true&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6394 </span>            :         { OFFS(file), &quot;pointer to a write/edit ISOBMF file used internally by importers and exporters&quot;, GF_PROP_POINTER, NULL, NULL, GF_FS_ARG_HINT_HIDE},
<span class="lineNum">    6395 </span>            :         { OFFS(subs_sidx), &quot;number of subsegments per sidx. negative value disables sidx, -2 removes sidx if present in source pid&quot;, GF_PROP_SINT, &quot;-1&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6396 </span>            :         { OFFS(m4cc), &quot;4 character code of empty box to append at the end of a segment&quot;, GF_PROP_STRING, NULL, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6397 </span>            :         { OFFS(chain_sidx), &quot;use daisy-chaining of SIDX&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6398 </span>            :         { OFFS(msn), &quot;sequence number of first moof to N&quot;, GF_PROP_UINT, &quot;1&quot;, NULL, 0},
<span class="lineNum">    6399 </span>            :         { OFFS(msninc), &quot;sequence number increase between moofs&quot;, GF_PROP_UINT, &quot;1&quot;, NULL, 0},
<span class="lineNum">    6400 </span>            :         { OFFS(tfdt), &quot;set TFDT of first traf&quot;, GF_PROP_FRACTION64, &quot;0&quot;, NULL, 0},
<span class="lineNum">    6401 </span>            :         { OFFS(tfdt_traf), &quot;set TFDT in each traf&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, 0},
<span class="lineNum">    6402 </span>            :         { OFFS(nofragdef), &quot;disable default flags in fragments&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, 0},
<span class="lineNum">    6403 </span>            :         { OFFS(straf), &quot;use a single traf per moof (smooth streaming and co)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6404 </span>            :         { OFFS(strun), &quot;use a single trun per traf (smooth streaming and co)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6405 </span>            :         { OFFS(psshs), &quot;set PSSH boxes store mode\n&quot;
<span class="lineNum">    6406 </span>            :         &quot;- moof: in first moof of each segments\n&quot;
<span class="lineNum">    6407 </span>            :         &quot;- moov: in movie box\n&quot;
<span class="lineNum">    6408 </span>            :         &quot;- none: pssh is discarded&quot;, GF_PROP_UINT, &quot;moov&quot;, &quot;moov|moof|none&quot;, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6409 </span>            :         { OFFS(sgpd_traf), &quot;store sample group descriptions in traf (duplicated for each traf). If not used, sample group descriptions are stored in the movie box&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6410 </span>            :         { OFFS(vodcache), &quot;enable temp storage for VoD dash modes - see filter help\n&quot;
<span class="lineNum">    6411 </span>            :                 &quot;- on: use temp storage of complete file for sidx and ssix injection\n&quot;
<span class="lineNum">    6412 </span>            :                 &quot;- insert: insert sidx and ssix by shifting bytes in output file\n&quot;
<span class="lineNum">    6413 </span>            :                 &quot;- replace: precompute pace requirements for sidx and ssix and rewrite file range at end&quot;, GF_PROP_UINT, &quot;replace&quot;, &quot;on|insert|replace&quot;, 0},
<span class="lineNum">    6414 </span>            :         { OFFS(noinit), &quot;do not produce initial moov, used for DASH bitstream switching mode&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6415 </span>            :         { OFFS(tktpl), &quot;use track box from input if any as a template to create new track\n&quot;
<span class="lineNum">    6416 </span>            :         &quot;- no: disables template\n&quot;
<span class="lineNum">    6417 </span>            :         &quot;- yes: clones the track (except edits and decoder config)\n&quot;
<span class="lineNum">    6418 </span>            :         &quot;- udta: only loads udta&quot;, GF_PROP_UINT, &quot;yes&quot;, &quot;no|yes|udta&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6419 </span>            :         { OFFS(mudta), &quot;use udta and other moov extension boxes from input if any\n&quot;
<span class="lineNum">    6420 </span>            :         &quot;- no: disables import\n&quot;
<span class="lineNum">    6421 </span>            :         &quot;- yes: clones all extension boxes\n&quot;
<span class="lineNum">    6422 </span>            :         &quot;- udta: only loads udta&quot;, GF_PROP_UINT, &quot;yes&quot;, &quot;no|yes|udta&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6423 </span>            :         { OFFS(mvex), &quot;set mvex after tracks&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6424 </span>            :         { OFFS(sdtp_traf), &quot;use sdtp in traf rather than using flags in trun sample entries\n&quot;
<span class="lineNum">    6425 </span>            :                 &quot;- no: do not use sdtp\n&quot;
<span class="lineNum">    6426 </span>            :                 &quot;- sdtp: use sdtp box to indicate sample dependencies and do not write info in trun sample flags\n&quot;
<span class="lineNum">    6427 </span>            :                 &quot;- both: use sdtp box to indicate sample dependencies and also write info in trun sample flags&quot;, GF_PROP_UINT, &quot;no&quot;, &quot;no|sdtp|both&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6428 </span>            :         { OFFS(trackid), &quot;track ID of created track for single track. Default 0 uses next available trackID&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6429 </span>            :         { OFFS(fragdur), &quot;fragment based on fragment duration rather than CTS. Mostly used for MP4Box -frag option&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6430 </span>            :         { OFFS(btrt), &quot;set btrt box in sample description&quot;, GF_PROP_BOOL, &quot;true&quot;, NULL, 0},
<span class="lineNum">    6431 </span>            :         { OFFS(styp), &quot;set segment styp major brand to the given 4CC[.version]&quot;, GF_PROP_STRING, NULL, NULL, 0},
<span class="lineNum">    6432 </span>            :         { OFFS(mediats), &quot;set media timescale. A value of 0 means inherit from pid, a value of -1 means derive from samplerate or frame rate&quot;, GF_PROP_SINT, &quot;0&quot;, NULL, 0},
<span class="lineNum">    6433 </span>            :         { OFFS(ase), &quot;set audio sample entry mode for more than stereo layouts\n&quot;\
<span class="lineNum">    6434 </span>            :                         &quot;- v0: use v0 signaling but channel count from stream, recommended for backward compatibility\n&quot;\
<span class="lineNum">    6435 </span>            :                         &quot;- v0s: use v0 signaling and force channel count to 2 (stereo) if more than 2 channels\n&quot;\
<span class="lineNum">    6436 </span>            :                         &quot;- v1: use v1 signaling, ISOBMFF style (will mux raw PCM as ISOBMFF style)\n&quot;\
<span class="lineNum">    6437 </span>            :                         &quot;- v1qt: use v1 signaling, QTFF style&quot;\
<span class="lineNum">    6438 </span>            :                 , GF_PROP_UINT, &quot;v0&quot;, &quot;|v0|v0s|v1|v1qt&quot;, 0},
<span class="lineNum">    6439 </span>            :         { OFFS(ssix), &quot;create ssix when sidx is present, level 1 mapping I-frames byte ranges, level 0xFF mapping the rest&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6440 </span>            :         { OFFS(ccst), &quot;insert coding constraint box for video tracks&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6441 </span>            :         { OFFS(maxchunk), &quot;set max chunk size in bytes for runs (only used in non-fragmented mode). 0 means no constraints&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6442 </span>            :         { OFFS(noroll), &quot;disable roll sample grouping&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6443 </span>            :         { OFFS(saio32), &quot;use 32 bit offset for side data location instead of 64 bit offset&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6444 </span>            :         { OFFS(tfdt64), &quot;use 64 bit tfdt and sidx even for 32 bits timestamps&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6445 </span>            : #ifdef GF_ENABLE_CTRN
<span class="lineNum">    6446 </span>            :         { OFFS(ctrn), &quot;use compact track run (experimental)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6447 </span>            :         { OFFS(ctrni), &quot;use inheritance in compact track run for HEVC tile tracks (highly experimental)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6448 </span>            : #endif
<span class="lineNum">    6449 </span>            :         { OFFS(sseg), &quot;set single segment mode for dash&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_HIDE},
<span class="lineNum">    6450 </span>            : 
<span class="lineNum">    6451 </span>            :         { OFFS(compress), &quot;set top-level box compression mode\n&quot;
<span class="lineNum">    6452 </span>            :                                                 &quot;- no: disable box compression\n&quot;
<span class="lineNum">    6453 </span>            :                                                 &quot;- moov: compress only moov box\n&quot;
<span class="lineNum">    6454 </span>            :                                                 &quot;- moof: compress only moof boxes\n&quot;
<span class="lineNum">    6455 </span>            :                                                 &quot;- sidx: compress moof and sidx boxes\n&quot;
<span class="lineNum">    6456 </span>            :                                                 &quot;- ssix: compress moof, sidx and ssix boxes\n&quot;
<span class="lineNum">    6457 </span>            :                                                 &quot;- all: compress moov, moof, sidx and ssix boxes&quot;, GF_PROP_UINT, &quot;no&quot;, &quot;no|moov|moof|sidx|ssix|all&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6458 </span>            :         { OFFS(fcomp), &quot;force using compress box even when compressed size is larger than uncompressed&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6459 </span>            :         { OFFS(otyp), &quot;inject original file type when using compressed boxes&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6460 </span>            : 
<span class="lineNum">    6461 </span>            :         { OFFS(trun_inter), &quot;interleave samples in trun based on the temporal level, the lowest level are stored first - this will create as many trun as required&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6462 </span>            :         { OFFS(truns_first), &quot;store track runs before sample group description and sample encryption information&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6463 </span>            :         { OFFS(block_size), &quot;target output block size, 0 for default internal value (10k)&quot;, GF_PROP_UINT, &quot;10000&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6464 </span>            :         { OFFS(boxpatch), &quot;apply box patch before writing&quot;, GF_PROP_STRING, NULL, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6465 </span>            :         { OFFS(deps), &quot;add samples dependencies information&quot;, GF_PROP_BOOL, &quot;true&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6466 </span>            :         { OFFS(mfra), &quot;enable movie fragment random access when fragmenting (ignored when dashing)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6467 </span>            :         { OFFS(forcesync), &quot;force all SAP types to be considered sync samples (might produce non-conformant files)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6468 </span>            :         { OFFS(refrag), &quot;indicate to use track fragment defaults from initial file if any rather than computing them from PID properties (used when processing standalone segments/fragments)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6469 </span>            :         { OFFS(itags), &quot;tag injection mode\n&quot;
<span class="lineNum">    6470 </span>            :                         &quot;- none: do not inject tags\n&quot;
<span class="lineNum">    6471 </span>            :                         &quot;- strict: only inject recognized itunes tags\n&quot;
<span class="lineNum">    6472 </span>            :                         &quot;- all: inject all possible tags&quot;
<span class="lineNum">    6473 </span>            :                         , GF_PROP_UINT, &quot;strict&quot;, &quot;none|strict|all&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6474 </span>            : 
<span class="lineNum">    6475 </span>            :         { OFFS(keep_utc), &quot;force all new files and tracks to keep the source UTC creation and modification times&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6476 </span>            :         { OFFS(pps_inband), &quot;when xps_inband is set, inject PPS in each non SAP 1/2/3 sample&quot;, GF_PROP_BOOL, &quot;no&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    6477 </span>            :         { OFFS(moovpad), &quot;insert free box of given size after moov for future in-place editing&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6478 </span>            :         { OFFS(cmaf), &quot;use cmaf guidelines\n&quot;
<span class="lineNum">    6479 </span>            :                 &quot;- no: CMAF not enforced\n&quot;
<span class="lineNum">    6480 </span>            :                 &quot;- cmfc: use CMAF `cmfc` guidelines\n&quot;
<span class="lineNum">    6481 </span>            :                 &quot;- cmf2: use CMAF `cmf2` guidelines&quot;
<span class="lineNum">    6482 </span>            :                 , GF_PROP_UINT, &quot;no&quot;, &quot;no|cmfc|cmf2&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    6483 </span>            :         { OFFS(start), &quot;set playback start offset (MP4Box import only). Negative value means percent of media duration with -1 equal to duration&quot;, GF_PROP_DOUBLE, &quot;0.0&quot;, NULL, GF_FS_ARG_HINT_HIDE},
<span class="lineNum">    6484 </span>            :         {0}
<span class="lineNum">    6485 </span>            : };
<span class="lineNum">    6486 </span>            : 
<span class="lineNum">    6487 </span>            : 
<span class="lineNum">    6488 </span>            : GF_FilterRegister MP4MuxRegister = {
<span class="lineNum">    6489 </span>            :         .name = &quot;mp4mx&quot;,
<span class="lineNum">    6490 </span>            :         GF_FS_SET_DESCRIPTION(&quot;ISOBMFF/QT muxer&quot;)
<span class="lineNum">    6491 </span>            :         GF_FS_SET_HELP(&quot;Muxes file according to ISOBMFF (14496-12 and derived specifications) or QuickTime\n&quot;
<span class="lineNum">    6492 </span>            :         &quot;  \n&quot;
<span class="lineNum">    6493 </span>            :         &quot;# Tracks and Items\n&quot;
<span class="lineNum">    6494 </span>            :         &quot;By default all input PIDs with ItemID property set are muxed as items, otherwise they are muxed as tracks.\n&quot;
<span class="lineNum">    6495 </span>            :         &quot;To prevent source items to be muxed as items, use [-itemid](mp4dmx) option from ISOBMF demuxer.\n&quot;
<span class="lineNum">    6496 </span>            :         &quot;EX -i source.mp4:itemid=false -o file.mp4\n&quot;
<span class="lineNum">    6497 </span>            :         &quot;  \n&quot;
<span class="lineNum">    6498 </span>            :         &quot;To force non-item streams to be muxed as items, use __#ItemID__ option on that PID:\n&quot;
<span class="lineNum">    6499 </span>            :         &quot;EX -i source.jpg:#ItemID=1 -o file.mp4\n&quot;
<span class="lineNum">    6500 </span>            :         &quot;  \n&quot;
<span class="lineNum">    6501 </span>            :         &quot;# Storage\n&quot;
<span class="lineNum">    6502 </span>            :         &quot;The [-store]() option allows controlling if the file is fragmented ot not, and when not fragmented, how interleaving is done. For cases where disk requirements are tight and fragmentation cannot be used, it is recommended to use either `flat` or `fstart` modes.\n&quot;
<span class="lineNum">    6503 </span>            :         &quot;  \n&quot;
<span class="lineNum">    6504 </span>            :         &quot;The [-vodcache]() option allows controlling how DASH onDemand segments are generated:\n&quot;
<span class="lineNum">    6505 </span>            :         &quot;- If set to `on`, file data is stored to a temporary file on disk and flushed upon completion, no padding is present.\n&quot;
<span class="lineNum">    6506 </span>            :         &quot;- If set to `insert`, SIDX/SSIX will be injected upon completion of the file by shifting bytes in file. In this case, no padding is required but this might not be compatible with all output sinks and will take longer to write the file.\n&quot;
<span class="lineNum">    6507 </span>            :         &quot;- If set to `replace`, SIDX/SSIX size will be estimated based on duration and DASH segment length, and padding will be used in the file __before__ the final SIDX. If input pids have the properties `DSegs` set, this will be as the number of segments.\n&quot;
<span class="lineNum">    6508 </span>            :         &quot;The `on` and `insert` modes will produce exactly the same file, while the mode `replace` may inject a `free` box before the sidx.\n&quot;
<span class="lineNum">    6509 </span>            :         &quot;  \n&quot;
<span class="lineNum">    6510 </span>            :         &quot;# Custom boxes\n&quot;
<span class="lineNum">    6511 </span>            :         &quot;Custom boxes can be specified as box patches:\n&quot;
<span class="lineNum">    6512 </span>            :         &quot;For movie-level patch, the [-boxpatch]() option of the filter should be used.\n&quot;
<span class="lineNum">    6513 </span>            :         &quot;Per PID box patch can be specified through the PID property `boxpatch`.\n&quot;
<span class="lineNum">    6514 </span>            :         &quot;EX src=source:#boxpatch=myfile.xml dst=mux.mp4\n&quot;
<span class="lineNum">    6515 </span>            :         &quot;Per Item box patch can be specified through the PID property `boxpatch`.\n&quot;
<span class="lineNum">    6516 </span>            :         &quot;EX src=source:1ItemID=1:#boxpatch=myfile.xml dst=mux.mp4\n&quot;
<span class="lineNum">    6517 </span>            :         &quot;  \n&quot;
<span class="lineNum">    6518 </span>            :         &quot;The box patch is applied before writing the initial moov box in fragmented mode, or when writing the complete file otherwise.\n&quot;
<span class="lineNum">    6519 </span>            :         &quot;The box patch can either be a filename or the full XML string.\n&quot;
<span class="lineNum">    6520 </span>            :         &quot;  \n&quot;
<span class="lineNum">    6521 </span>            :         &quot;# Tagging\n&quot;
<span class="lineNum">    6522 </span>            :         &quot;When tagging is enabled, the filter will watch the property `CoverArt` and all custom properties on incoming pid.\n&quot;
<span class="lineNum">    6523 </span>            :         &quot;The built-in tag names are indicated by `MP4Box -h tags`.\n&quot;
<span class="lineNum">    6524 </span>            :         &quot;Other tag class may be specified using `tag_NAME` property names, and will be added if [-tags]() is set to `all` using:\n&quot;
<span class="lineNum">    6525 </span>            :         &quot;- `NAME` as a box 4CC if `NAME` is four characters long\n&quot;
<span class="lineNum">    6526 </span>            :         &quot;- `NAME` as a box 4CC if `NAME` is 3 characters long, and will be prefixed by 0xA9\n&quot;
<span class="lineNum">    6527 </span>            :         &quot;- the CRC32 of the `NAME` as a box 4CC if `NAME` is not four characters long\n&quot;
<span class="lineNum">    6528 </span>            :         &quot;  \n&quot;
<span class="lineNum">    6529 </span>            :         &quot;# Notes\n&quot;
<span class="lineNum">    6530 </span>            :         &quot;The filter watches the property `FileNumber` on incoming packets to create new files or new segments in DASH mode.\n&quot;
<span class="lineNum">    6531 </span>            :         )
<span class="lineNum">    6532 </span>            :         .private_size = sizeof(GF_MP4MuxCtx),
<span class="lineNum">    6533 </span>            :         .args = MP4MuxArgs,
<span class="lineNum">    6534 </span>            :         .initialize = mp4_mux_initialize,
<span class="lineNum">    6535 </span>            :         .finalize = mp4_mux_finalize,
<span class="lineNum">    6536 </span>            :         .flags = GF_FS_REG_DYNAMIC_REDIRECT,
<span class="lineNum">    6537 </span>            :         SETCAPS(MP4MuxCaps),
<span class="lineNum">    6538 </span>            :         .configure_pid = mp4_mux_configure_pid,
<span class="lineNum">    6539 </span>            :         .process = mp4_mux_process,
<span class="lineNum">    6540 </span>            :         .process_event = mp4_mux_process_event
<span class="lineNum">    6541 </span>            : };
<a name="6542"><span class="lineNum">    6542 </span>            : </a>
<span class="lineNum">    6543 </span>            : 
<span class="lineNum">    6544 </span><span class="lineCov">       2877 : const GF_FilterRegister *mp4_mux_register(GF_FilterSession *session)</span>
<span class="lineNum">    6545 </span>            : {
<span class="lineNum">    6546 </span><span class="lineCov">       2877 :         return &amp;MP4MuxRegister;</span>
<span class="lineNum">    6547 </span>            : }
<span class="lineNum">    6548 </span>            : 
<span class="lineNum">    6549 </span>            : #else
<span class="lineNum">    6550 </span>            : const GF_FilterRegister *mp4_mux_register(GF_FilterSession *session)
<span class="lineNum">    6551 </span>            : {
<span class="lineNum">    6552 </span>            :         return NULL;
<span class="lineNum">    6553 </span>            : }
<span class="lineNum">    6554 </span>            : #endif // GPAC_DISABLE_ISOM_WRITE
<span class="lineNum">    6555 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

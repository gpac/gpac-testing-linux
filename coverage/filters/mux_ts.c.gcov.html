<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - filters/mux_ts.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">filters</a> - mux_ts.c<span style="font-size: 80%;"> (source / <a href="mux_ts.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">759</td>
            <td class="headerCovTableEntry">850</td>
            <td class="headerCovTableEntryMed">89.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">19</td>
            <td class="headerCovTableEntry">19</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2018-2021
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / MPEG-2 TS mux filter
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/filters.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;gpac/mpegts.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;gpac/iso639.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;gpac/webvtt.h&gt;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : #define M2TS_FILE_EXTS &quot;ts|m2t|mts|dmb|trp&quot;
<span class="lineNum">      34 </span>            : #define M2TS_MIMES &quot;video/mpeg-2|video/mp2t|video/mpeg|audio/mp2t&quot;
<a name="35"><span class="lineNum">      35 </span>            : </a>
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span><span class="lineCov">       1489 : void mux_assign_mime_file_ext(GF_FilterPid *ipid, GF_FilterPid *opid, const char *file_exts, const char *mime_types, const char *def_ext)</span>
<span class="lineNum">      38 </span>            : {
<span class="lineNum">      39 </span>            :         Bool found=GF_FALSE;
<span class="lineNum">      40 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span><span class="lineCov">       1489 :         p = gf_filter_pid_get_property(ipid, GF_PROP_PID_FILE_EXT);</span>
<span class="lineNum">      43 </span><span class="lineCov">       1489 :         if (p) {</span>
<span class="lineNum">      44 </span><span class="lineCov">        880 :                 char *match = strstr(file_exts, p-&gt;value.string);</span>
<span class="lineNum">      45 </span><span class="lineCov">        880 :                 if (match) {</span>
<span class="lineNum">      46 </span><span class="lineCov">        295 :                         u32 slen = (u32) strlen(match);</span>
<span class="lineNum">      47 </span><span class="lineCov">        295 :                         if (!match[slen-1] || (match[slen-1]=='|'))</span>
<span class="lineNum">      48 </span>            :                                 found = GF_TRUE;
<span class="lineNum">      49 </span>            :                 }
<span class="lineNum">      50 </span>            :         }
<span class="lineNum">      51 </span>            :         if (!found)
<span class="lineNum">      52 </span><span class="lineCov">       1489 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_FILE_EXT, &amp;PROP_STRING(def_ext ? (char *)def_ext : &quot;*&quot;) );</span>
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span><span class="lineCov">       1489 :         p = gf_filter_pid_get_property(ipid, GF_PROP_PID_MIME);</span>
<span class="lineNum">      55 </span>            :         found = GF_FALSE;
<span class="lineNum">      56 </span><span class="lineCov">       1489 :         if (p) {</span>
<span class="lineNum">      57 </span><span class="lineCov">        869 :                 char *match = strstr(mime_types, p-&gt;value.string);</span>
<span class="lineNum">      58 </span><span class="lineCov">        869 :                 if (match) {</span>
<span class="lineNum">      59 </span><span class="lineCov">        623 :                         u32 slen = (u32) strlen(match);</span>
<span class="lineNum">      60 </span><span class="lineCov">        623 :                         if (!match[slen-1] || (match[slen-1]=='|'))</span>
<span class="lineNum">      61 </span>            :                                 found = GF_TRUE;
<span class="lineNum">      62 </span>            :                 }
<span class="lineNum">      63 </span>            :         }
<span class="lineNum">      64 </span>            :         if (!found)
<span class="lineNum">      65 </span><span class="lineCov">       1489 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_MIME, &amp;PROP_STRING(&quot;*&quot;) );</span>
<span class="lineNum">      66 </span><span class="lineCov">       1489 : }</span>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span>            : enum
<span class="lineNum">      71 </span>            : {
<span class="lineNum">      72 </span>            :         TEMI_TC64_AUTO=0,
<span class="lineNum">      73 </span>            :         TEMI_TC64_OFF,
<span class="lineNum">      74 </span>            :         TEMI_TC64_ALWAYS,
<span class="lineNum">      75 </span>            : };
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            : typedef struct
<span class="lineNum">      79 </span>            : {
<span class="lineNum">      80 </span>            :         u64 sap_time;
<span class="lineNum">      81 </span>            :         u64 offset;
<span class="lineNum">      82 </span>            :         u32 nb_pck;
<span class="lineNum">      83 </span>            :         u32 sap_type;
<span class="lineNum">      84 </span>            :         u64 min_pts_plus_one;
<span class="lineNum">      85 </span>            :         u64 max_pts;
<span class="lineNum">      86 </span>            : } TS_SIDX;
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            : typedef struct
<span class="lineNum">      89 </span>            : {
<span class="lineNum">      90 </span>            :         //filter args
<span class="lineNum">      91 </span>            :         u32 pmt_id, pmt_rate, pmt_version, sdt_rate, breq, mpeg4;
<span class="lineNum">      92 </span>            :         u64 pcr_offset, first_pts;
<span class="lineNum">      93 </span>            :         u32 rate, pat_rate, repeat_rate, repeat_img, max_pcr, nb_pack, sid, bifs_pes;
<span class="lineNum">      94 </span>            :         GF_M2TS_PackMode pes_pack;
<span class="lineNum">      95 </span>            :         Bool flush_rap, realtime, pcr_only, disc, latm;
<span class="lineNum">      96 </span>            :         s64 pcr_init;
<span class="lineNum">      97 </span>            :         char *name, *provider, *temi;
<span class="lineNum">      98 </span>            :         u32 log_freq;
<span class="lineNum">      99 </span>            :         s32 subs_sidx;
<span class="lineNum">     100 </span>            : 
<span class="lineNum">     101 </span>            :         //internal
<span class="lineNum">     102 </span>            :         GF_FilterPid *opid;
<span class="lineNum">     103 </span>            :         GF_FilterPid *idx_opid;
<span class="lineNum">     104 </span>            :         GF_Filter *idx_filter;
<span class="lineNum">     105 </span>            :         GF_M2TS_Mux *mux;
<span class="lineNum">     106 </span>            : 
<span class="lineNum">     107 </span>            :         GF_List *pids;
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span>            :         Bool check_pcr;
<span class="lineNum">     110 </span>            :         Bool update_mux;
<span class="lineNum">     111 </span>            :         char *pack_buffer;
<span class="lineNum">     112 </span>            :         u64 nb_pck;
<span class="lineNum">     113 </span>            :         Bool init_buffering;
<span class="lineNum">     114 </span>            :         u32 last_log_time;
<span class="lineNum">     115 </span>            :         Bool pmt_update_pending;
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span>            :         u32 dash_mode;
<span class="lineNum">     118 </span>            :         Bool init_dash;
<span class="lineNum">     119 </span>            :         u32 dash_seg_num;
<span class="lineNum">     120 </span>            :         Bool wait_dash_flush;
<span class="lineNum">     121 </span>            :         Bool dash_file_switch;
<span class="lineNum">     122 </span>            :         Bool next_is_start;
<span class="lineNum">     123 </span>            :         u32 nb_pck_in_seg;
<span class="lineNum">     124 </span>            :         u64 pck_start_idx;
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span>            :         char dash_file_name[GF_MAX_PATH];
<span class="lineNum">     127 </span>            :         char idx_file_name[GF_MAX_PATH];
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span>            :         //dash indexing
<span class="lineNum">     130 </span>            :         u32 nb_sidx_entries, nb_sidx_alloc;
<span class="lineNum">     131 </span>            :         TS_SIDX *sidx_entries;
<span class="lineNum">     132 </span>            :         GF_BitStream *idx_bs;
<span class="lineNum">     133 </span>            :         u32 nb_pck_in_file, nb_pck_first_sidx, ref_pid;
<span class="lineNum">     134 </span>            :         u64 total_bytes_in;
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span>            :         u32 nb_suspended, cur_file_idx_plus_one;
<span class="lineNum">     137 </span>            :         char *cur_file_suffix;
<span class="lineNum">     138 </span>            :         Bool notify_filename;
<span class="lineNum">     139 </span>            : } GF_TSMuxCtx;
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            : typedef struct
<span class="lineNum">     142 </span>            : {
<span class="lineNum">     143 </span>            :         u32 id, delay, timescale;
<span class="lineNum">     144 </span>            :         u64 offset, init_val;
<span class="lineNum">     145 </span>            :         char *url;
<span class="lineNum">     146 </span>            :         Bool ntp, use_init_val;
<span class="lineNum">     147 </span>            :         u32 mode_64bits;
<span class="lineNum">     148 </span>            :         u64 cts_at_init_val_plus_one;
<span class="lineNum">     149 </span>            : } TEMIDesc;
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span>            : typedef struct
<span class="lineNum">     152 </span>            : {
<span class="lineNum">     153 </span>            :         GF_ESInterface esi;
<span class="lineNum">     154 </span>            :         GF_FilterPid *ipid;
<span class="lineNum">     155 </span>            :         GF_M2TS_Mux_Stream *mstream;
<span class="lineNum">     156 </span>            :         GF_M2TS_Mux_Program *prog;
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span>            :         u32 sid;
<span class="lineNum">     159 </span>            :         u32 codec_id;
<span class="lineNum">     160 </span>            :         u32 pmt_pid;
<span class="lineNum">     161 </span>            :         u32 nb_pck;
<span class="lineNum">     162 </span>            :         Bool is_repeat;
<span class="lineNum">     163 </span>            :         u32 nb_repeat_last;
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span>            :         GF_TSMuxCtx *ctx;
<span class="lineNum">     166 </span>            :         u32 last_cv;
<span class="lineNum">     167 </span>            :         //ts media skip
<span class="lineNum">     168 </span>            :         s64 media_delay, max_media_skip;
<span class="lineNum">     169 </span>            :         Bool done;
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span>            :         GF_List *temi_descs;
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            :         u32 last_temi_url;
<span class="lineNum">     174 </span>            :         u8 *af_data;
<span class="lineNum">     175 </span>            :         u32 af_data_alloc;
<span class="lineNum">     176 </span>            :         GF_BitStream *temi_af_bs;
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span>            :         Bool rewrite_odf;
<span class="lineNum">     179 </span>            :         Bool has_seen_eods;
<span class="lineNum">     180 </span>            :         u32 pck_duration;
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span>            :         u64 loop_ts_offset;
<span class="lineNum">     183 </span>            :         u64 last_dts;
<span class="lineNum">     184 </span>            :         u32 last_dur;
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span>            :         u8 *pck_data_buf;
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span>            :         u32 suspended;
<a name="189"><span class="lineNum">     189 </span>            : } M2Pid;</a>
<span class="lineNum">     190 </span>            : 
<span class="lineNum">     191 </span><span class="lineCov">       1179 : static GF_Err tsmux_format_af_descriptor(GF_BitStream *bs, u32 timeline_id, u64 timecode, u32 timescale, u32 mode_64bits, u64 ntp, const char *temi_url, u32 temi_delay, u32 *last_url_time)</span>
<span class="lineNum">     192 </span>            : {
<span class="lineNum">     193 </span>            :         u32 len;
<span class="lineNum">     194 </span>            :         u32 last_time;
<span class="lineNum">     195 </span><span class="lineCov">       1179 :         if (ntp) {</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :                 last_time = 1000*(ntp&gt;&gt;32);</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :                 last_time += 1000*(ntp&amp;0xFFFFFFFF)/0xFFFFFFFF;</span>
<span class="lineNum">     198 </span>            :         } else {
<span class="lineNum">     199 </span><span class="lineCov">       1179 :                 last_time = (u32) (1000*timecode/timescale);</span>
<span class="lineNum">     200 </span>            :         }
<span class="lineNum">     201 </span><span class="lineCov">       1179 :         if (temi_url &amp;&amp; (!*last_url_time || (last_time - *last_url_time + 1 &gt;= temi_delay)) ) {</span>
<span class="lineNum">     202 </span><span class="lineCov">         21 :                 u64 start = gf_bs_get_position(bs);</span>
<span class="lineNum">     203 </span>            :                 u64 end;
<span class="lineNum">     204 </span><span class="lineCov">         21 :                 *last_url_time = last_time + 1;</span>
<span class="lineNum">     205 </span>            :                 len = 0;
<span class="lineNum">     206 </span><span class="lineCov">         21 :                 gf_bs_write_int(bs,     GF_M2TS_AFDESC_LOCATION_DESCRIPTOR, 8);</span>
<span class="lineNum">     207 </span><span class="lineCov">         21 :                 gf_bs_write_int(bs,     len, 8);</span>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span><span class="lineCov">         21 :                 gf_bs_write_int(bs,     0, 1); //force_reload</span>
<span class="lineNum">     210 </span><span class="lineCov">         21 :                 gf_bs_write_int(bs,     0, 1); //is_announcement</span>
<span class="lineNum">     211 </span><span class="lineCov">         21 :                 gf_bs_write_int(bs,     0, 1); //splicing_flag</span>
<span class="lineNum">     212 </span><span class="lineCov">         21 :                 gf_bs_write_int(bs,     0, 1); //use_base_temi_url</span>
<span class="lineNum">     213 </span><span class="lineCov">         21 :                 gf_bs_write_int(bs,     0xFF, 5); //reserved</span>
<span class="lineNum">     214 </span><span class="lineCov">         21 :                 gf_bs_write_int(bs,     timeline_id, 7); //timeline_id</span>
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span><span class="lineCov">         21 :                 if (strlen(temi_url)) {</span>
<span class="lineNum">     217 </span>            :                         char *url = (char *)temi_url;
<span class="lineNum">     218 </span><span class="lineCov">         21 :                         if (!strnicmp(temi_url, &quot;http://&quot;, 7)) {</span>
<span class="lineNum">     219 </span><span class="lineCov">         21 :                                 gf_bs_write_int(bs,     1, 8); //url_scheme</span>
<span class="lineNum">     220 </span><span class="lineCov">         21 :                                 url = (char *) temi_url + 7;</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :                         } else if (!strnicmp(temi_url, &quot;https://&quot;, 8)) {</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :                                 gf_bs_write_int(bs,     2, 8); //url_scheme</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :                                 url = (char *) temi_url + 8;</span>
<span class="lineNum">     224 </span>            :                         } else {
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :                                 gf_bs_write_int(bs,     0, 8); //url_scheme</span>
<span class="lineNum">     226 </span>            :                         }
<span class="lineNum">     227 </span><span class="lineCov">         21 :                         gf_bs_write_u8(bs, (u32) strlen(url)); //url_path_len</span>
<span class="lineNum">     228 </span><span class="lineCov">         21 :                         gf_bs_write_data(bs, url, (u32) strlen(url) ); //url</span>
<span class="lineNum">     229 </span><span class="lineCov">         21 :                         gf_bs_write_u8(bs, 0); //nb_addons</span>
<span class="lineNum">     230 </span>            :                 }
<span class="lineNum">     231 </span>            :                 //rewrite len
<span class="lineNum">     232 </span><span class="lineCov">         21 :                 end = gf_bs_get_position(bs);</span>
<span class="lineNum">     233 </span><span class="lineCov">         21 :                 len = (u32) (end - start - 2);</span>
<span class="lineNum">     234 </span><span class="lineCov">         21 :                 gf_bs_seek(bs, start+1);</span>
<span class="lineNum">     235 </span><span class="lineCov">         21 :                 gf_bs_write_int(bs,     len, 8);</span>
<span class="lineNum">     236 </span><span class="lineCov">         21 :                 gf_bs_seek(bs, end);</span>
<span class="lineNum">     237 </span>            :         }
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineCov">       1179 :         if (timescale || ntp) {</span>
<span class="lineNum">     240 </span>            :                 Bool use64;
<span class="lineNum">     241 </span><span class="lineCov">       1179 :                 if (mode_64bits==TEMI_TC64_AUTO) {</span>
<span class="lineNum">     242 </span><span class="lineCov">       1179 :                         use64 = (timecode &gt; 0xFFFFFFFFUL) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :                 } else if (mode_64bits==TEMI_TC64_ALWAYS) {</span>
<span class="lineNum">     244 </span>            :                         use64 = GF_TRUE;
<span class="lineNum">     245 </span>            :                 } else {
<span class="lineNum">     246 </span>            :                         use64 = GF_FALSE;
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :                         while (timecode &gt; 0xFFFFFFFFUL) {</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :                                 timecode -= 0xFFFFFFFFUL;</span>
<span class="lineNum">     249 </span>            :                         }
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span>            :                 }
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span>            :                 len = 3; //3 bytes flags
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span><span class="lineCov">       1179 :                 if (timescale) len += 4 + (use64 ? 8 : 4);</span>
<span class="lineNum">     256 </span><span class="lineCov">       1179 :                 if (ntp) len += 8;</span>
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span>            :                 //write timeline descriptor
<span class="lineNum">     259 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     GF_M2TS_AFDESC_TIMELINE_DESCRIPTOR, 8);</span>
<span class="lineNum">     260 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     len, 8);</span>
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     timescale ? (use64 ? 2 : 1) : 0, 2); //has_timestamp</span>
<span class="lineNum">     263 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     ntp ? 1 : 0, 1); //has_ntp</span>
<span class="lineNum">     264 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     0, 1); //has_ptp</span>
<span class="lineNum">     265 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     0, 2); //has_timecode</span>
<span class="lineNum">     266 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     0, 1); //force_reload</span>
<span class="lineNum">     267 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     0, 1); //paused</span>
<span class="lineNum">     268 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     0, 1); //discontinuity</span>
<span class="lineNum">     269 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     0xFF, 7); //reserved</span>
<span class="lineNum">     270 </span><span class="lineCov">       1179 :                 gf_bs_write_int(bs,     timeline_id, 8); //timeline_id</span>
<span class="lineNum">     271 </span><span class="lineCov">       1179 :                 if (timescale) {</span>
<span class="lineNum">     272 </span><span class="lineCov">       1179 :                         gf_bs_write_u32(bs,     timescale); //timescale</span>
<span class="lineNum">     273 </span><span class="lineCov">       1179 :                         if (use64)</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :                                 gf_bs_write_u64(bs,     timecode); //timestamp</span>
<span class="lineNum">     275 </span>            :                         else
<span class="lineNum">     276 </span><span class="lineCov">       1179 :                                 gf_bs_write_u32(bs,     (u32) timecode); //timestamp</span>
<span class="lineNum">     277 </span>            :                 }
<span class="lineNum">     278 </span><span class="lineCov">       1179 :                 if (ntp) {</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :                         gf_bs_write_u64(bs,     ntp); //ntp</span>
<span class="lineNum">     280 </span>            :                 }
<span class="lineNum">     281 </span>            :         }
<span class="lineNum">     282 </span><span class="lineCov">       1179 :         return GF_OK;</span>
<span class="lineNum">     283 </span>            : }
<a name="284"><span class="lineNum">     284 </span>            : </a>
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span><span class="lineCov">          7 : GF_SLConfig *tsmux_get_sl_config(GF_TSMuxCtx *ctx, u32 timescale, GF_SLConfig *slc)</span>
<span class="lineNum">     287 </span>            : {
<span class="lineNum">     288 </span><span class="lineCov">          7 :         if (!slc) slc = (GF_SLConfig *) gf_odf_desc_new(GF_ODF_SLC_TAG);</span>
<span class="lineNum">     289 </span><span class="lineCov">          7 :         slc-&gt;predefined = 0;</span>
<span class="lineNum">     290 </span><span class="lineCov">          7 :         slc-&gt;useAccessUnitStartFlag = 1;</span>
<span class="lineNum">     291 </span><span class="lineCov">          7 :         slc-&gt;useAccessUnitEndFlag = 1;</span>
<span class="lineNum">     292 </span><span class="lineCov">          7 :         slc-&gt;useRandomAccessPointFlag = 1;</span>
<span class="lineNum">     293 </span><span class="lineCov">          7 :         slc-&gt;useTimestampsFlag = 1;</span>
<span class="lineNum">     294 </span><span class="lineCov">          7 :         slc-&gt;timestampLength = 33;</span>
<span class="lineNum">     295 </span><span class="lineCov">          7 :         slc-&gt;timestampResolution = timescale;</span>
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span>            :         /*test mode in which time stamps are 90khz and not coded but copied over from PES header*/
<span class="lineNum">     298 </span><span class="lineCov">          7 :         if (ctx-&gt;bifs_pes==2) {</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :                 slc-&gt;timestampLength = 0;</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :                 slc-&gt;timestampResolution = 90000;</span>
<span class="lineNum">     301 </span>            :         }
<span class="lineNum">     302 </span><span class="lineCov">          7 :         return slc;</span>
<a name="303"><span class="lineNum">     303 </span>            : }</a>
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span><span class="lineCov">          1 : static void tsmux_rewrite_odf(GF_TSMuxCtx *ctx, GF_ESIPacket *es_pck)</span>
<span class="lineNum">     306 </span>            : {
<span class="lineNum">     307 </span>            :         u32 com_count, com_index, od_count, esd_index, od_index;
<span class="lineNum">     308 </span>            :         GF_ODUpdate *odU;
<span class="lineNum">     309 </span>            :         GF_ESDUpdate *esdU;
<span class="lineNum">     310 </span>            :         GF_ESD *esd;
<span class="lineNum">     311 </span><span class="lineCov">          1 :         GF_ODCodec *od_codec = gf_odf_codec_new();</span>
<span class="lineNum">     312 </span>            : 
<span class="lineNum">     313 </span><span class="lineCov">          1 :         gf_odf_codec_set_au(od_codec, es_pck-&gt;data, es_pck-&gt;data_len);</span>
<span class="lineNum">     314 </span><span class="lineCov">          1 :         gf_odf_codec_decode(od_codec);</span>
<span class="lineNum">     315 </span><span class="lineCov">          1 :         com_count = gf_list_count(od_codec-&gt;CommandList);</span>
<span class="lineNum">     316 </span><span class="lineCov">          2 :         for (com_index = 0; com_index &lt; com_count; com_index++) {</span>
<span class="lineNum">     317 </span><span class="lineCov">          1 :                 GF_ODCom *com = (GF_ODCom *)gf_list_get(od_codec-&gt;CommandList, com_index);</span>
<span class="lineNum">     318 </span><span class="lineCov">          1 :                 switch (com-&gt;tag) {</span>
<span class="lineNum">     319 </span><span class="lineCov">          1 :                 case GF_ODF_OD_UPDATE_TAG:</span>
<span class="lineNum">     320 </span>            :                         odU = (GF_ODUpdate*)com;
<span class="lineNum">     321 </span><span class="lineCov">          1 :                         od_count = gf_list_count(odU-&gt;objectDescriptors);</span>
<span class="lineNum">     322 </span><span class="lineCov">          2 :                         for (od_index=0; od_index&lt;od_count; od_index++) {</span>
<span class="lineNum">     323 </span><span class="lineCov">          1 :                                 GF_ObjectDescriptor *od = (GF_ObjectDescriptor *)gf_list_get(odU-&gt;objectDescriptors, od_index);</span>
<span class="lineNum">     324 </span><span class="lineCov">          1 :                                 esd_index = 0;</span>
<span class="lineNum">     325 </span><span class="lineCov">          3 :                                 while ( (esd = gf_list_enum(od-&gt;ESDescriptors, &amp;esd_index)) ) {</span>
<span class="lineNum">     326 </span>            :                                         assert(esd-&gt;slConfig);
<span class="lineNum">     327 </span><span class="lineCov">          1 :                                         esd-&gt;slConfig = tsmux_get_sl_config(ctx, esd-&gt;slConfig-&gt;timestampResolution, esd-&gt;slConfig);</span>
<span class="lineNum">     328 </span>            :                                 }
<span class="lineNum">     329 </span>            :                         }
<span class="lineNum">     330 </span>            :                         break;
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :                 case GF_ODF_ESD_UPDATE_TAG:</span>
<span class="lineNum">     332 </span>            :                         esdU = (GF_ESDUpdate*)com;
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :                         esd_index = 0;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :                         while ( (esd = gf_list_enum(esdU-&gt;ESDescriptors, &amp;esd_index)) ) {</span>
<span class="lineNum">     335 </span>            :                                         assert(esd-&gt;slConfig);
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :                                         esd-&gt;slConfig = tsmux_get_sl_config(ctx, esd-&gt;slConfig-&gt;timestampResolution, esd-&gt;slConfig);</span>
<span class="lineNum">     337 </span>            :                         }
<span class="lineNum">     338 </span>            :                         break;
<span class="lineNum">     339 </span>            :                 }
<span class="lineNum">     340 </span>            :         }
<span class="lineNum">     341 </span><span class="lineCov">          1 :         gf_odf_codec_encode(od_codec, 1);</span>
<span class="lineNum">     342 </span><span class="lineCov">          1 :         es_pck-&gt;data = NULL;</span>
<span class="lineNum">     343 </span><span class="lineCov">          1 :         es_pck-&gt;data_len = 0;</span>
<span class="lineNum">     344 </span><span class="lineCov">          1 :         gf_odf_codec_get_au(od_codec, &amp;es_pck-&gt;data, &amp;es_pck-&gt;data_len);</span>
<span class="lineNum">     345 </span><span class="lineCov">          1 :         gf_odf_codec_del(od_codec);</span>
<span class="lineNum">     346 </span>            : 
<a name="347"><span class="lineNum">     347 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span><span class="lineCov">      60277 : static GF_Err tsmux_esi_ctrl(GF_ESInterface *ifce, u32 act_type, void *param)</span>
<span class="lineNum">     350 </span>            : {
<span class="lineNum">     351 </span>            :         u32 cversion;
<span class="lineNum">     352 </span>            :         u64 cts, cts_diff;
<span class="lineNum">     353 </span><span class="lineCov">      60277 :         M2Pid *tspid = (M2Pid *)ifce-&gt;input_udta;</span>
<span class="lineNum">     354 </span><span class="lineCov">      60277 :         if (!tspid) return GF_BAD_PARAM;</span>
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineCov">      60277 :         switch (act_type) {</span>
<span class="lineNum">     357 </span><span class="lineCov">      60277 :         case GF_ESI_INPUT_DATA_FLUSH:</span>
<span class="lineNum">     358 </span>            :         {
<span class="lineNum">     359 </span>            :                 u64 dts;
<span class="lineNum">     360 </span>            :                 GF_ESIPacket es_pck;
<span class="lineNum">     361 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">     362 </span>            :                 GF_FilterPacket *pck;
<span class="lineNum">     363 </span><span class="lineCov">      60277 :                 pck = gf_filter_pid_get_packet(tspid-&gt;ipid);</span>
<span class="lineNum">     364 </span>            :                 //if PMT update is pending after this packet fetch (reconfigure), don't send the packet
<span class="lineNum">     365 </span><span class="lineCov">     100702 :                 if (tspid-&gt;ctx-&gt;pmt_update_pending) return GF_OK;</span>
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span><span class="lineCov">      60277 :                 if (!pck) {</span>
<span class="lineNum">     368 </span><span class="lineCov">      15165 :                         if (gf_filter_pid_is_eos(tspid-&gt;ipid)) {</span>
<span class="lineNum">     369 </span><span class="lineCov">         67 :                                 if (tspid-&gt;ctx-&gt;realtime</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :                                         &amp;&amp; tspid-&gt;ctx-&gt;repeat_img</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                                         &amp;&amp; (tspid-&gt;nb_pck==1)</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                                         &amp;&amp; (tspid-&gt;esi.stream_type==GF_STREAM_VISUAL)</span>
<span class="lineNum">     373 </span>            :                                 ) {
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :                                         tspid-&gt;nb_repeat_last++;</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :                                         tspid-&gt;is_repeat = GF_TRUE;</span>
<span class="lineNum">     376 </span>            :                                 } else {
<span class="lineNum">     377 </span><span class="lineCov">         67 :                                         tspid-&gt;done = GF_TRUE;</span>
<span class="lineNum">     378 </span><span class="lineCov">         67 :                                         ifce-&gt;caps |= GF_ESI_STREAM_IS_OVER;</span>
<span class="lineNum">     379 </span>            :                                 }
<span class="lineNum">     380 </span><span class="lineCov">         67 :                                 if (tspid-&gt;ctx-&gt;dash_mode)</span>
<span class="lineNum">     381 </span><span class="lineCov">         20 :                                         tspid-&gt;has_seen_eods = GF_TRUE;</span>
<span class="lineNum">     382 </span>            :                         }
<span class="lineNum">     383 </span>            :                         return GF_OK;
<span class="lineNum">     384 </span>            :                 }
<span class="lineNum">     385 </span><span class="lineCov">      45112 :                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENUM);</span>
<span class="lineNum">     386 </span><span class="lineCov">      45112 :                 if (tspid-&gt;ctx-&gt;dash_mode) {</span>
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span><span class="lineCov">      36761 :                         if (tspid-&gt;has_seen_eods)</span>
<span class="lineNum">     389 </span>            :                                 return GF_OK;
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span>            :                         //detect segment change
<span class="lineNum">     392 </span><span class="lineCov">      11647 :                         if (p &amp;&amp; tspid-&gt;ctx-&gt;dash_seg_num &amp;&amp; (tspid-&gt;ctx-&gt;dash_seg_num &lt; p-&gt;value.uint)) {</span>
<span class="lineNum">     393 </span><span class="lineCov">        124 :                                 tspid-&gt;ctx-&gt;wait_dash_flush = GF_TRUE;</span>
<span class="lineNum">     394 </span><span class="lineCov">        124 :                                 tspid-&gt;ctx-&gt;dash_seg_num = p-&gt;value.uint;</span>
<span class="lineNum">     395 </span><span class="lineCov">        124 :                                 tspid-&gt;ctx-&gt;dash_file_name[0] = 0;</span>
<span class="lineNum">     396 </span>            :                         }
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span>            :                         //segment change is pending, check for filename as well - we don't do that in the previous test
<span class="lineNum">     399 </span>            :                         //since the filename property is sent on a single pid, not each of them
<span class="lineNum">     400 </span><span class="lineCov">      11647 :                         if (tspid-&gt;ctx-&gt;wait_dash_flush &amp;&amp; p &amp;&amp; (tspid-&gt;ctx-&gt;dash_seg_num == p-&gt;value.uint)) {</span>
<span class="lineNum">     401 </span><span class="lineCov">        145 :                                 tspid-&gt;has_seen_eods = GF_TRUE;</span>
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span><span class="lineCov">        145 :                                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENAME);</span>
<span class="lineNum">     404 </span><span class="lineCov">        145 :                                 if (p) {</span>
<span class="lineNum">     405 </span><span class="lineCov">        117 :                                         strcpy(tspid-&gt;ctx-&gt;dash_file_name, p-&gt;value.string);</span>
<span class="lineNum">     406 </span><span class="lineCov">        117 :                                         tspid-&gt;ctx-&gt;dash_file_switch = GF_TRUE;</span>
<span class="lineNum">     407 </span>            :                                 }
<span class="lineNum">     408 </span>            :                                 return GF_OK;
<span class="lineNum">     409 </span>            :                         }
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span>            :                         //at this point the new segment is started
<span class="lineNum">     412 </span><span class="lineCov">      11502 :                         if (p)</span>
<span class="lineNum">     413 </span><span class="lineCov">        156 :                                 tspid-&gt;ctx-&gt;dash_seg_num = p-&gt;value.uint;</span>
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineCov">      11502 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_IDXFILENAME);</span>
<span class="lineNum">     416 </span><span class="lineCov">      11502 :                         if (p) {</span>
<span class="lineNum">     417 </span><span class="lineCov">          8 :                                 strcpy(tspid-&gt;ctx-&gt;idx_file_name, p-&gt;value.string);</span>
<span class="lineNum">     418 </span>            :                         }
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span><span class="lineCov">      11502 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_EODS);</span>
<span class="lineNum">     421 </span><span class="lineCov">      11502 :                         if (p &amp;&amp; p-&gt;value.boolean) {</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :                                 tspid-&gt;has_seen_eods = GF_TRUE;</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :                                 tspid-&gt;ctx-&gt;wait_dash_flush = GF_TRUE;</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_drop_packet(tspid-&gt;ipid);</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">     426 </span>            :                         }
<span class="lineNum">     427 </span><span class="lineCov">       8351 :                 } else if (p) {</span>
<span class="lineNum">     428 </span><span class="lineCov">          3 :                         if (!tspid-&gt;ctx-&gt;cur_file_idx_plus_one) {</span>
<span class="lineNum">     429 </span><span class="lineCov">          1 :                                 tspid-&gt;ctx-&gt;cur_file_idx_plus_one = p-&gt;value.uint + 1;</span>
<span class="lineNum">     430 </span><span class="lineCov">          1 :                                 if (!tspid-&gt;ctx-&gt;cur_file_suffix) {</span>
<span class="lineNum">     431 </span><span class="lineCov">          1 :                                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILESUF);</span>
<span class="lineNum">     432 </span><span class="lineCov">          1 :                                         if (p &amp;&amp; p-&gt;value.string) tspid-&gt;ctx-&gt;cur_file_suffix = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">     433 </span>            :                                 }
<span class="lineNum">     434 </span><span class="lineCov">          1 :                                 tspid-&gt;ctx-&gt;notify_filename = GF_TRUE;</span>
<span class="lineNum">     435 </span><span class="lineCov">          2 :                         } else if (tspid-&gt;ctx-&gt;cur_file_idx_plus_one == p-&gt;value.uint+1) {</span>
<span class="lineNum">     436 </span><span class="lineCov">          1 :                         } else if (tspid-&gt;suspended) {</span>
<span class="lineNum">     437 </span>            :                                 return GF_OK;
<span class="lineNum">     438 </span><span class="lineCov">          1 :                         } else if (!tspid-&gt;ctx-&gt;notify_filename) {</span>
<span class="lineNum">     439 </span><span class="lineCov">          1 :                                 tspid-&gt;suspended = GF_TRUE;</span>
<span class="lineNum">     440 </span><span class="lineCov">          1 :                                 tspid-&gt;ctx-&gt;nb_suspended++;</span>
<span class="lineNum">     441 </span><span class="lineCov">          1 :                                 if (tspid-&gt;ctx-&gt;nb_suspended==1) {</span>
<span class="lineNum">     442 </span><span class="lineCov">          1 :                                         tspid-&gt;ctx-&gt;cur_file_idx_plus_one = p-&gt;value.uint + 1;</span>
<span class="lineNum">     443 </span><span class="lineCov">          1 :                                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILESUF);</span>
<span class="lineNum">     444 </span><span class="lineCov">          1 :                                         if (p &amp;&amp; p-&gt;value.string &amp;&amp; !tspid-&gt;ctx-&gt;cur_file_suffix)</span>
<span class="lineNum">     445 </span><span class="lineCov">          1 :                                                 tspid-&gt;ctx-&gt;cur_file_suffix = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">     446 </span>            :                                 }
<span class="lineNum">     447 </span><span class="lineCov">          1 :                                 ifce-&gt;caps |= GF_ESI_STREAM_IS_OVER;</span>
<span class="lineNum">     448 </span><span class="lineCov">          1 :                                 return GF_OK;</span>
<span class="lineNum">     449 </span>            :                         } else {
<span class="lineNum">     450 </span>            :                                 //notify filename pending
<span class="lineNum">     451 </span>            :                                 return GF_OK;
<span class="lineNum">     452 </span>            :                         }
<span class="lineNum">     453 </span>            :                 }
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span>            :                 memset(&amp;es_pck, 0, sizeof(GF_ESIPacket));
<span class="lineNum">     456 </span><span class="lineCov">      19852 :                 es_pck.flags = GF_ESI_DATA_AU_START | GF_ESI_DATA_AU_END | GF_ESI_DATA_HAS_CTS;</span>
<span class="lineNum">     457 </span><span class="lineCov">      19852 :                 es_pck.sap_type = gf_filter_pck_get_sap(pck);</span>
<span class="lineNum">     458 </span><span class="lineCov">      19852 :                 tspid-&gt;pck_duration = gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">     459 </span><span class="lineCov">      19852 :                 cversion = gf_filter_pck_get_carousel_version(pck);</span>
<span class="lineNum">     460 </span><span class="lineCov">      19852 :                 if (cversion+1 == tspid-&gt;last_cv) {</span>
<span class="lineNum">     461 </span><span class="lineCov">      19803 :                         es_pck.flags |= GF_ESI_DATA_REPEAT;</span>
<span class="lineNum">     462 </span>            :                 }
<span class="lineNum">     463 </span><span class="lineCov">      19852 :                 tspid-&gt;last_cv = cversion+1;</span>
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span><span class="lineCov">      19852 :                 if (tspid-&gt;is_repeat)</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                         es_pck.flags |= GF_ESI_DATA_REPEAT;</span>
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span><span class="lineCov">      19852 :                 cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">     469 </span><span class="lineCov">      19852 :                 dts = gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">     470 </span><span class="lineCov">      19852 :                 if (dts != GF_FILTER_NO_TS) {</span>
<span class="lineNum">     471 </span><span class="lineCov">      19852 :                         dts += tspid-&gt;loop_ts_offset;</span>
<span class="lineNum">     472 </span>            :                         //loop detected
<span class="lineNum">     473 </span><span class="lineCov">      19852 :                         if (tspid-&gt;last_dts &amp;&amp; (dts&lt;tspid-&gt;last_dts)) {</span>
<span class="lineNum">     474 </span>            :                                 dts -= tspid-&gt;loop_ts_offset;
<span class="lineNum">     475 </span><span class="lineCov">          3 :                                 tspid-&gt;loop_ts_offset = tspid-&gt;last_dts - dts + tspid-&gt;last_dur;</span>
<span class="lineNum">     476 </span><span class="lineCov">          3 :                                 dts += tspid-&gt;loop_ts_offset;</span>
<span class="lineNum">     477 </span>            :                         }
<span class="lineNum">     478 </span>            :                 }
<span class="lineNum">     479 </span><span class="lineCov">      19852 :                 if (cts != GF_FILTER_NO_TS) {</span>
<span class="lineNum">     480 </span><span class="lineCov">      19852 :                         cts += tspid-&gt;loop_ts_offset;</span>
<span class="lineNum">     481 </span><span class="lineCov">      19852 :                         es_pck.cts = cts;</span>
<span class="lineNum">     482 </span>            :                 } else {
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :                         es_pck.cts = 0;</span>
<span class="lineNum">     484 </span>            :                 }
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span><span class="lineCov">      19852 :                 if (tspid-&gt;temi_descs) {</span>
<span class="lineNum">     487 </span><span class="lineCov">        676 :                         u32 i, count=gf_list_count(tspid-&gt;temi_descs);</span>
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span><span class="lineCov">        676 :                         if (!tspid-&gt;temi_af_bs) tspid-&gt;temi_af_bs = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);</span>
<span class="lineNum">     490 </span><span class="lineCov">        673 :                         else gf_bs_reassign_buffer(tspid-&gt;temi_af_bs, tspid-&gt;af_data, tspid-&gt;af_data_alloc);</span>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span><span class="lineCov">       1179 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     493 </span><span class="lineCov">       1179 :                                 TEMIDesc *temi = gf_list_get(tspid-&gt;temi_descs, i);</span>
<span class="lineNum">     494 </span>            :                                 u64 ntp=0;
<span class="lineNum">     495 </span><span class="lineCov">       1179 :                                 u32 timescale = ifce-&gt;timescale;</span>
<span class="lineNum">     496 </span>            :                                 u64 tc;
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span><span class="lineCov">       1179 :                                 if (temi-&gt;timescale &amp;&amp; (temi-&gt;timescale!=timescale)) {</span>
<span class="lineNum">     499 </span>            :                                         timescale = temi-&gt;timescale;
<span class="lineNum">     500 </span>            :                                 }
<span class="lineNum">     501 </span><span class="lineCov">       1179 :                                 if (temi-&gt;use_init_val) {</span>
<span class="lineNum">     502 </span><span class="lineCov">        173 :                                         if (!temi-&gt;cts_at_init_val_plus_one) temi-&gt;cts_at_init_val_plus_one = cts+1;</span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineCov">        173 :                                         tc = (cts - (temi-&gt;cts_at_init_val_plus_one-1));</span>
<span class="lineNum">     505 </span><span class="lineCov">        173 :                                         if (timescale != ifce-&gt;timescale) {</span>
<span class="lineNum">     506 </span><span class="lineCov">        173 :                                                 tc *= temi-&gt;timescale;</span>
<span class="lineNum">     507 </span><span class="lineCov">        173 :                                                 tc /= ifce-&gt;timescale;</span>
<span class="lineNum">     508 </span>            :                                         }
<span class="lineNum">     509 </span><span class="lineCov">        173 :                                         tc += temi-&gt;init_val;</span>
<span class="lineNum">     510 </span>            :                                 } else {
<span class="lineNum">     511 </span>            :                                         //TOCHECK: do we want media timeline or composition timeline ?
<span class="lineNum">     512 </span>            :                                         tc = cts;
<span class="lineNum">     513 </span><span class="lineCov">       1006 :                                         if (timescale != ifce-&gt;timescale) {</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :                                                 tc *= temi-&gt;timescale;</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :                                                 tc /= ifce-&gt;timescale;</span>
<span class="lineNum">     516 </span>            :                                         }
<span class="lineNum">     517 </span>            :                                 }
<span class="lineNum">     518 </span>            : 
<span class="lineNum">     519 </span><span class="lineCov">       1179 :                                 if (temi-&gt;offset) {</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                                         if (timescale != ifce-&gt;timescale)</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                                                 tc += ((u64) temi-&gt;offset) * ifce-&gt;timescale / 1000;</span>
<span class="lineNum">     522 </span>            :                                         else
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :                                                 tc += temi-&gt;offset;</span>
<span class="lineNum">     524 </span>            :                                 }
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span><span class="lineCov">       1179 :                                 if (temi-&gt;ntp) {</span>
<span class="lineNum">     527 </span>            :                                         u32 sec, frac;
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :                                         gf_net_get_ntp(&amp;sec, &amp;frac);</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :                                         ntp = sec;</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :                                         ntp &lt;&lt;= 32;</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :                                         ntp |= frac;</span>
<span class="lineNum">     532 </span>            :                                 }
<span class="lineNum">     533 </span><span class="lineCov">       1179 :                                 tsmux_format_af_descriptor(tspid-&gt;temi_af_bs, temi-&gt;id, tc, timescale, temi-&gt;mode_64bits, ntp, temi-&gt;url, temi-&gt;delay, &amp;tspid-&gt;last_temi_url);</span>
<span class="lineNum">     534 </span>            :                         }
<span class="lineNum">     535 </span><span class="lineCov">        676 :                         gf_bs_get_content_no_truncate(tspid-&gt;temi_af_bs, &amp;tspid-&gt;af_data, &amp;es_pck.mpeg2_af_descriptors_size, &amp;tspid-&gt;af_data_alloc);</span>
<span class="lineNum">     536 </span><span class="lineCov">        676 :                         es_pck.mpeg2_af_descriptors = tspid-&gt;af_data;</span>
<span class="lineNum">     537 </span>            :                 }
<span class="lineNum">     538 </span><span class="lineCov">      19852 :                 es_pck.cts += tspid-&gt;max_media_skip + tspid-&gt;media_delay;</span>
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span><span class="lineCov">      19852 :                 if (tspid-&gt;nb_repeat_last) {</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :                         es_pck.cts += tspid-&gt;nb_repeat_last * ifce-&gt;timescale * tspid-&gt;ctx-&gt;repeat_img / 1000;</span>
<span class="lineNum">     542 </span>            :                 }
<span class="lineNum">     543 </span>            : 
<span class="lineNum">     544 </span>            :                 cts_diff = 0;
<span class="lineNum">     545 </span><span class="lineCov">      19852 :                 if (tspid-&gt;prog-&gt;cts_offset) {</span>
<span class="lineNum">     546 </span><span class="lineCov">       1094 :                         cts_diff = tspid-&gt;prog-&gt;cts_offset;</span>
<span class="lineNum">     547 </span><span class="lineCov">       1094 :                         cts_diff *= tspid-&gt;esi.timescale;</span>
<span class="lineNum">     548 </span><span class="lineCov">       1094 :                         cts_diff /= 1000000;</span>
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span><span class="lineCov">       1094 :                         es_pck.cts += cts_diff;</span>
<span class="lineNum">     551 </span>            :                 }
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span><span class="lineCov">      19852 :                 es_pck.dts = es_pck.cts;</span>
<span class="lineNum">     554 </span><span class="lineCov">      19852 :                 if (dts != GF_FILTER_NO_TS) {</span>
<span class="lineNum">     555 </span><span class="lineCov">      19852 :                         tspid-&gt;last_dts = dts;</span>
<span class="lineNum">     556 </span>            :                         es_pck.dts = dts;
<span class="lineNum">     557 </span><span class="lineCov">      19852 :                         es_pck.dts += tspid-&gt;max_media_skip + tspid-&gt;media_delay;</span>
<span class="lineNum">     558 </span>            : 
<span class="lineNum">     559 </span><span class="lineCov">      19852 :                         if (es_pck.dts &gt; es_pck.cts) {</span>
<span class="lineNum">     560 </span>            :                                 u64 diff;
<span class="lineNum">     561 </span>            :                                 //we don't have reliable dts - double the diff should make sure we don't try to adjust too often
<span class="lineNum">     562 </span><span class="lineCov">          5 :                                 diff = cts_diff = 2*(es_pck.dts - es_pck.cts);</span>
<span class="lineNum">     563 </span><span class="lineCov">          5 :                                 diff *= 1000000;</span>
<span class="lineNum">     564 </span><span class="lineCov">          5 :                                 diff /= tspid-&gt;esi.timescale;</span>
<span class="lineNum">     565 </span>            :                                 assert(tspid-&gt;prog-&gt;cts_offset &lt;= diff);
<span class="lineNum">     566 </span><span class="lineCov">          5 :                                 tspid-&gt;prog-&gt;cts_offset += (u32) diff;</span>
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span><span class="lineCov">          5 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[M2TSMux] Packet CTS &quot;LLU&quot; is less than packet DTS &quot;LLU&quot;, adjusting all CTS by %d / %d!\n&quot;, es_pck.cts, es_pck.dts, cts_diff, tspid-&gt;esi.timescale));</span>
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span><span class="lineCov">          5 :                                 es_pck.cts += cts_diff;</span>
<span class="lineNum">     571 </span>            :                         }
<span class="lineNum">     572 </span><span class="lineCov">      19852 :                         if (tspid-&gt;esi.stream_type!=GF_STREAM_VISUAL) {</span>
<span class="lineNum">     573 </span><span class="lineCov">      12899 :                                 es_pck.dts += cts_diff;</span>
<span class="lineNum">     574 </span>            :                         }
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span><span class="lineCov">      19852 :                         if (es_pck.dts != es_pck.cts) {</span>
<span class="lineNum">     577 </span><span class="lineCov">       1712 :                                 es_pck.flags |= GF_ESI_DATA_HAS_DTS;</span>
<span class="lineNum">     578 </span>            :                         }
<span class="lineNum">     579 </span>            :                 }
<span class="lineNum">     580 </span><span class="lineCov">      19852 :                 es_pck.data = (char *) gf_filter_pck_get_data(pck, &amp;es_pck.data_len);</span>
<span class="lineNum">     581 </span><span class="lineCov">      19852 :                 es_pck.duration = gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">     582 </span><span class="lineCov">      19852 :                 tspid-&gt;last_dur = es_pck.duration;</span>
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span><span class="lineCov">      19852 :                 if (tspid-&gt;rewrite_odf) {</span>
<span class="lineNum">     585 </span><span class="lineCov">          1 :                         tsmux_rewrite_odf(tspid-&gt;ctx, &amp;es_pck);</span>
<span class="lineNum">     586 </span>            :                 }
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span><span class="lineCov">      19852 :                 tspid-&gt;ctx-&gt;total_bytes_in += es_pck.data_len;</span>
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span><span class="lineCov">      19852 :                 if (tspid-&gt;pck_data_buf) gf_free(tspid-&gt;pck_data_buf);</span>
<span class="lineNum">     591 </span><span class="lineCov">      19852 :                 tspid-&gt;pck_data_buf = NULL;</span>
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span>            :                 //drop formatting for TX3G
<span class="lineNum">     594 </span><span class="lineCov">      19852 :                 if (tspid-&gt;codec_id == GF_CODECID_TX3G) {</span>
<span class="lineNum">     595 </span><span class="lineCov">         11 :                         u16 len = es_pck.data[0];</span>
<span class="lineNum">     596 </span><span class="lineCov">         11 :                         len&lt;&lt;=8;</span>
<span class="lineNum">     597 </span><span class="lineCov">         11 :                         len |= es_pck.data[1];</span>
<span class="lineNum">     598 </span><span class="lineCov">         11 :                         es_pck.data += 2;</span>
<span class="lineNum">     599 </span><span class="lineCov">         11 :                         es_pck.data_len = len;</span>
<span class="lineNum">     600 </span>            :                 }
<span class="lineNum">     601 </span>            :                 //serialize webvtt cue formatting for TX3G
<span class="lineNum">     602 </span><span class="lineCov">      19841 :                 else if (tspid-&gt;codec_id == GF_CODECID_WEBVTT) {</span>
<span class="lineNum">     603 </span>            :                         u32 i;
<span class="lineNum">     604 </span>            :                         u64 start_ts, end_ts;
<span class="lineNum">     605 </span>            :                         void webvtt_write_cue(GF_BitStream *bs, GF_WebVTTCue *cue, Bool write_srt);
<span class="lineNum">     606 </span>            :                         GF_List *cues;
<span class="lineNum">     607 </span><span class="lineCov">         10 :                         GF_BitStream *bs = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);</span>
<span class="lineNum">     608 </span>            : 
<span class="lineNum">     609 </span><span class="lineCov">         10 :                         start_ts = es_pck.cts * 1000;</span>
<span class="lineNum">     610 </span><span class="lineCov">         10 :                         start_ts /= tspid-&gt;esi.timescale;</span>
<span class="lineNum">     611 </span><span class="lineCov">         10 :                         end_ts = (es_pck.cts + es_pck.duration) * 1000;</span>
<span class="lineNum">     612 </span><span class="lineCov">         10 :                         end_ts /= tspid-&gt;esi.timescale;</span>
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span><span class="lineCov">         10 :                         cues = gf_webvtt_parse_cues_from_data(es_pck.data, es_pck.data_len, start_ts, end_ts);</span>
<span class="lineNum">     615 </span><span class="lineCov">         15 :                         for (i = 0; i &lt; gf_list_count(cues); i++) {</span>
<span class="lineNum">     616 </span><span class="lineCov">          5 :                                 GF_WebVTTCue *cue = (GF_WebVTTCue *)gf_list_get(cues, i);</span>
<span class="lineNum">     617 </span><span class="lineCov">          5 :                                 webvtt_write_cue(bs, cue, GF_FALSE);</span>
<span class="lineNum">     618 </span><span class="lineCov">          5 :                                 gf_webvtt_cue_del(cue);</span>
<span class="lineNum">     619 </span>            :                         }
<span class="lineNum">     620 </span><span class="lineCov">         10 :                         gf_list_del(cues);</span>
<span class="lineNum">     621 </span><span class="lineCov">         10 :                         gf_bs_get_content(bs, &amp;es_pck.data, &amp;es_pck.data_len);</span>
<span class="lineNum">     622 </span><span class="lineCov">         10 :                         gf_bs_del(bs);</span>
<span class="lineNum">     623 </span><span class="lineCov">         10 :                         tspid-&gt;pck_data_buf = es_pck.data;</span>
<span class="lineNum">     624 </span>            :                 }
<span class="lineNum">     625 </span>            :                 //for TTML we keep the entire payload as a PES packet
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span><span class="lineCov">      19852 :                 tspid-&gt;nb_pck++;</span>
<span class="lineNum">     628 </span><span class="lineCov">      19852 :                 ifce-&gt;output_ctrl(ifce, GF_ESI_OUTPUT_DATA_DISPATCH, &amp;es_pck);</span>
<span class="lineNum">     629 </span><span class="lineCov">      19852 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_CONTAINER, (&quot;[M2TSMux] PID %d: packet %d CTS &quot;LLU&quot;\n&quot;, tspid-&gt;esi.stream_id, tspid-&gt;nb_pck, es_pck.cts));</span>
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span>            :                 //data is copied by muxer for now, should need rewrite to avoid un-needed allocations
<span class="lineNum">     632 </span><span class="lineCov">      19852 :                 gf_filter_pid_drop_packet(tspid-&gt;ipid);</span>
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span><span class="lineCov">      19852 :                 if (tspid-&gt;rewrite_odf) {</span>
<span class="lineNum">     635 </span><span class="lineCov">          1 :                         gf_free(es_pck.data);</span>
<span class="lineNum">     636 </span>            :                 }
<span class="lineNum">     637 </span>            : 
<span class="lineNum">     638 </span>            :         }
<span class="lineNum">     639 </span><span class="lineCov">      19852 :         return GF_OK;</span>
<span class="lineNum">     640 </span>            : 
<span class="lineNum">     641 </span>            :         case GF_ESI_INPUT_DESTROY:
<span class="lineNum">     642 </span>            :                 return GF_OK;
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :         default:</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :                 return GF_BAD_PARAM;</span>
<span class="lineNum">     645 </span>            :         }
<span class="lineNum">     646 </span>            : }
<a name="647"><span class="lineNum">     647 </span>            : </a>
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span><span class="lineCov">          2 : void update_m4sys_info(GF_TSMuxCtx *ctx, GF_M2TS_Mux_Program *prog)</span>
<span class="lineNum">     650 </span>            : {
<span class="lineNum">     651 </span><span class="lineCov">          2 :         GF_M2TS_Mux_Stream *stream = prog-&gt;streams;</span>
<span class="lineNum">     652 </span>            : 
<span class="lineNum">     653 </span><span class="lineCov">          2 :         if (prog-&gt;iod) gf_odf_desc_del(prog-&gt;iod);</span>
<span class="lineNum">     654 </span><span class="lineCov">          2 :         prog-&gt;iod = gf_odf_desc_new(GF_ODF_IOD_TAG);</span>
<span class="lineNum">     655 </span><span class="lineCov">          7 :         while (stream) {</span>
<span class="lineNum">     656 </span><span class="lineCov">          3 :                 M2Pid *tspid = (M2Pid *)stream-&gt;ifce-&gt;input_udta;</span>
<span class="lineNum">     657 </span><span class="lineCov">          3 :                 const GF_PropertyValue *p = gf_filter_pid_get_property(tspid-&gt;ipid, GF_PROP_PID_IN_IOD);</span>
<span class="lineNum">     658 </span><span class="lineCov">          3 :                 if (p &amp;&amp; p-&gt;value.boolean) {</span>
<span class="lineNum">     659 </span><span class="lineCov">          3 :                         GF_ESD *esd = gf_odf_desc_esd_new(0);</span>
<span class="lineNum">     660 </span><span class="lineCov">          3 :                         esd-&gt;decoderConfig-&gt;objectTypeIndication = stream-&gt;ifce-&gt;codecid;</span>
<span class="lineNum">     661 </span><span class="lineCov">          3 :                         esd-&gt;decoderConfig-&gt;streamType = stream-&gt;ifce-&gt;stream_type;</span>
<span class="lineNum">     662 </span><span class="lineCov">          3 :                         esd-&gt;ESID = stream-&gt;ifce-&gt;stream_id;</span>
<span class="lineNum">     663 </span><span class="lineCov">          3 :                         esd-&gt;dependsOnESID = stream-&gt;ifce-&gt;depends_on_stream;</span>
<span class="lineNum">     664 </span><span class="lineCov">          3 :                         if (stream-&gt;ifce-&gt;decoder_config_size) {</span>
<span class="lineNum">     665 </span><span class="lineCov">          2 :                                 esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data = gf_malloc(sizeof(char)*stream-&gt;ifce-&gt;decoder_config_size);</span>
<span class="lineNum">     666 </span><span class="lineCov">          2 :                                 memcpy(esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data, stream-&gt;ifce-&gt;decoder_config, stream-&gt;ifce-&gt;decoder_config_size);</span>
<span class="lineNum">     667 </span><span class="lineCov">          2 :                                 esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;dataLength = stream-&gt;ifce-&gt;decoder_config_size;</span>
<span class="lineNum">     668 </span>            :                         }
<span class="lineNum">     669 </span><span class="lineCov">          3 :                         tsmux_get_sl_config(ctx, stream-&gt;ifce-&gt;timescale, esd-&gt;slConfig);</span>
<span class="lineNum">     670 </span><span class="lineCov">          3 :                         gf_list_add( ((GF_ObjectDescriptor *)prog-&gt;iod)-&gt;ESDescriptors, esd);</span>
<span class="lineNum">     671 </span>            :                 }
<span class="lineNum">     672 </span><span class="lineCov">          3 :                 stream-&gt;ifce-&gt;sl_config = tsmux_get_sl_config(ctx, stream-&gt;ifce-&gt;timescale, stream-&gt;ifce-&gt;sl_config);</span>
<span class="lineNum">     673 </span><span class="lineCov">          3 :                 stream = stream-&gt;next;</span>
<span class="lineNum">     674 </span>            :         }
<a name="675"><span class="lineNum">     675 </span><span class="lineCov">          2 : }</span></a>
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span><span class="lineCov">         49 : static void tsmux_setup_esi(GF_TSMuxCtx *ctx, GF_M2TS_Mux_Program *prog, M2Pid *tspid, u32 stream_type)</span>
<span class="lineNum">     678 </span>            : {
<span class="lineNum">     679 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">     680 </span>            : 
<span class="lineNum">     681 </span><span class="lineCov">         49 :         memset(&amp;tspid-&gt;esi, 0, sizeof(GF_ESInterface));</span>
<span class="lineNum">     682 </span><span class="lineCov">         49 :         tspid-&gt;esi.stream_type = stream_type;</span>
<span class="lineNum">     683 </span>            :         
<span class="lineNum">     684 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property(tspid-&gt;ipid, GF_PROP_PID_TIMESCALE);</span>
<span class="lineNum">     685 </span><span class="lineCov">         49 :         tspid-&gt;esi.timescale = p-&gt;value.uint;</span>
<span class="lineNum">     686 </span>            : 
<span class="lineNum">     687 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property(tspid-&gt;ipid, GF_PROP_PID_DECODER_CONFIG);</span>
<span class="lineNum">     688 </span><span class="lineCov">         49 :         if (p) {</span>
<span class="lineNum">     689 </span><span class="lineCov">         22 :                 tspid-&gt;esi.decoder_config = p-&gt;value.data.ptr;</span>
<span class="lineNum">     690 </span><span class="lineCov">         22 :                 tspid-&gt;esi.decoder_config_size = p-&gt;value.data.size;</span>
<span class="lineNum">     691 </span>            :         }
<span class="lineNum">     692 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property(tspid-&gt;ipid, GF_PROP_PID_ID);</span>
<span class="lineNum">     693 </span><span class="lineCov">         49 :         if (p) tspid-&gt;esi.stream_id = p-&gt;value.uint;</span>
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property(tspid-&gt;ipid, GF_PROP_PID_DEPENDENCY_ID);</span>
<span class="lineNum">     696 </span><span class="lineCov">         49 :         if (p) tspid-&gt;esi.depends_on_stream = p-&gt;value.uint;</span>
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span><span class="lineCov">         49 :         tspid-&gt;esi.codecid = tspid-&gt;codec_id;</span>
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property(tspid-&gt;ipid, GF_PROP_PID_LANGUAGE);</span>
<span class="lineNum">     701 </span><span class="lineCov">         49 :         if (p) {</span>
<span class="lineNum">     702 </span><span class="lineCov">          2 :                 s32 idx = gf_lang_find(p-&gt;value.string);</span>
<span class="lineNum">     703 </span><span class="lineCov">          2 :                 if (idx&gt;=0) {</span>
<span class="lineNum">     704 </span><span class="lineCov">          2 :                         const char *code = gf_lang_get_3cc(idx);</span>
<span class="lineNum">     705 </span><span class="lineCov">          2 :                         if (code) tspid-&gt;esi.lang = GF_4CC(code[0], code[1], code[2], ' ');</span>
<span class="lineNum">     706 </span>            :                 }
<span class="lineNum">     707 </span>            :         }
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property(tspid-&gt;ipid, GF_PROP_PID_DURATION);</span>
<span class="lineNum">     710 </span><span class="lineCov">         49 :         if (p) {</span>
<span class="lineNum">     711 </span><span class="lineCov">         36 :                 tspid-&gt;esi.duration = (Double) p-&gt;value.lfrac.num;</span>
<span class="lineNum">     712 </span><span class="lineCov">         36 :                 tspid-&gt;esi.duration /= p-&gt;value.lfrac.den;</span>
<span class="lineNum">     713 </span>            :         }
<span class="lineNum">     714 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property(tspid-&gt;ipid, GF_PROP_PID_BITRATE);</span>
<span class="lineNum">     715 </span><span class="lineCov">         49 :         if (p) tspid-&gt;esi.bit_rate = p-&gt;value.uint;</span>
<span class="lineNum">     716 </span>            :         /*repeat rate in ms for carrouseling - 0 if no repeat*/
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span><span class="lineCov">         49 :         tspid-&gt;esi.repeat_rate = ctx-&gt;repeat_rate;</span>
<span class="lineNum">     719 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property(tspid-&gt;ipid, GF_PROP_PID_CAROUSEL_RATE);</span>
<span class="lineNum">     720 </span><span class="lineCov">         49 :         if (p) tspid-&gt;esi.repeat_rate = p-&gt;value.uint;</span>
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineCov">         49 :         tspid-&gt;rewrite_odf = GF_FALSE;</span>
<span class="lineNum">     723 </span><span class="lineCov">         49 :         if (tspid-&gt;esi.stream_type==GF_STREAM_OD) {</span>
<span class="lineNum">     724 </span><span class="lineCov">          1 :                 tspid-&gt;rewrite_odf = GF_TRUE;</span>
<span class="lineNum">     725 </span><span class="lineCov">          1 :                 update_m4sys_info(ctx, prog);</span>
<span class="lineNum">     726 </span><span class="lineCov">         48 :         } else if (prog-&gt;iod) {</span>
<span class="lineNum">     727 </span><span class="lineCov">          1 :                 update_m4sys_info(ctx, prog);</span>
<span class="lineNum">     728 </span>            :         }
<span class="lineNum">     729 </span>            : 
<span class="lineNum">     730 </span><span class="lineCov">         49 :         tspid-&gt;esi.caps = 0;</span>
<span class="lineNum">     731 </span><span class="lineCov">         49 :         switch (tspid-&gt;esi.stream_type) {</span>
<span class="lineNum">     732 </span><span class="lineCov">         22 :         case GF_STREAM_AUDIO:</span>
<span class="lineNum">     733 </span><span class="lineCov">         22 :                 if (ctx-&gt;latm) tspid-&gt;esi.caps |= GF_ESI_AAC_USE_LATM;</span>
<span class="lineNum">     734 </span>            :         case GF_STREAM_VISUAL:
<span class="lineNum">     735 </span><span class="lineCov">         45 :                 if (ctx-&gt;mpeg4==2) {</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :                         tspid-&gt;esi.caps |= GF_ESI_STREAM_WITHOUT_MPEG4_SYSTEMS;</span>
<span class="lineNum">     737 </span>            :                 }
<span class="lineNum">     738 </span>            :                 break;
<span class="lineNum">     739 </span>            :         }
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span><span class="lineCov">         49 :         tspid-&gt;esi.input_ctrl = tsmux_esi_ctrl;</span>
<span class="lineNum">     742 </span><span class="lineCov">         49 :         tspid-&gt;esi.input_udta = tspid;</span>
<span class="lineNum">     743 </span><span class="lineCov">         49 :         tspid-&gt;prog = prog;</span>
<a name="744"><span class="lineNum">     744 </span><span class="lineCov">         49 : }</span></a>
<span class="lineNum">     745 </span>            : 
<span class="lineNum">     746 </span><span class="lineCov">         49 : static void tsmux_setup_temi(GF_TSMuxCtx *ctx, M2Pid *tspid)</span>
<span class="lineNum">     747 </span>            : {
<span class="lineNum">     748 </span>            :         GF_M2TS_Mux_Stream *a_stream;
<span class="lineNum">     749 </span>            :         u32 st_idx=0;
<span class="lineNum">     750 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">     751 </span>            :         char *temi_cfg;
<span class="lineNum">     752 </span>            : 
<span class="lineNum">     753 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property_str(tspid-&gt;ipid, &quot;tsmux:temi&quot;);</span>
<span class="lineNum">     754 </span><span class="lineCov">         49 :         if (p &amp;&amp; (p-&gt;type==GF_PROP_STRING)) temi_cfg = p-&gt;value.string;</span>
<span class="lineNum">     755 </span><span class="lineCov">         49 :         else temi_cfg = ctx-&gt;temi;</span>
<span class="lineNum">     756 </span>            : 
<span class="lineNum">     757 </span><span class="lineCov">         49 :         if (!temi_cfg) return;</span>
<span class="lineNum">     758 </span>            :         u32 temi_id=0;
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span>            :         //find our stream index
<span class="lineNum">     761 </span><span class="lineCov">          4 :         a_stream = tspid-&gt;mstream-&gt;program-&gt;streams;</span>
<span class="lineNum">     762 </span><span class="lineCov">          4 :         while (a_stream) {</span>
<span class="lineNum">     763 </span><span class="lineCov">          4 :                 if (tspid-&gt;mstream == a_stream) break;</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :                 st_idx++;</span>
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :                 a_stream = a_stream-&gt;next;</span>
<span class="lineNum">     766 </span>            :         }
<span class="lineNum">     767 </span>            : 
<span class="lineNum">     768 </span><span class="lineCov">          6 :         while (temi_cfg) {</span>
<span class="lineNum">     769 </span>            :                 u32 service_id=0;
<span class="lineNum">     770 </span>            :                 u32 temi_delay=1000;
<span class="lineNum">     771 </span><span class="lineCov">          6 :                 u64 temi_offset=0;</span>
<span class="lineNum">     772 </span>            :                 u32 temi_timescale=0;
<span class="lineNum">     773 </span>            :                 Bool temi_ntp=GF_FALSE;
<span class="lineNum">     774 </span>            :                 u32 temi_64bits=TEMI_TC64_AUTO;
<span class="lineNum">     775 </span>            :                 Bool temi_use_init_val=GF_FALSE;
<span class="lineNum">     776 </span><span class="lineCov">          6 :                 u64 temi_init_val = 0;</span>
<span class="lineNum">     777 </span>            :                 u32 temi_streamtype=0;
<span class="lineNum">     778 </span>            :                 u32 temi_index=0;
<span class="lineNum">     779 </span>            :                 Bool done=GF_FALSE;
<span class="lineNum">     780 </span>            :                 char *sep;
<span class="lineNum">     781 </span>            : 
<span class="lineNum">     782 </span><span class="lineCov">          6 :                 if (!strlen(temi_cfg))</span>
<span class="lineNum">     783 </span>            :                         break;
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span><span class="lineCov">         14 :                 while (temi_cfg[0]=='#') {</span>
<span class="lineNum">     786 </span><span class="lineCov">         10 :                         sep = strchr(temi_cfg+1, '#');</span>
<span class="lineNum">     787 </span><span class="lineCov">         10 :                         if (!sep) {</span>
<span class="lineNum">     788 </span>            :                                 temi_cfg += 1;
<span class="lineNum">     789 </span>            :                                 break;
<span class="lineNum">     790 </span>            :                         }
<span class="lineNum">     791 </span><span class="lineCov">          8 :                         sep[0] = 0;</span>
<span class="lineNum">     792 </span><span class="lineCov">          8 :                         switch (temi_cfg[1]) {</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :                         case 'S':</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :                                 service_id = atoi(temi_cfg+2);</span>
<span class="lineNum">     795 </span>            :                                 break;
<span class="lineNum">     796 </span>            :                         case 'N':
<span class="lineNum">     797 </span>            :                                 temi_ntp = GF_TRUE;
<span class="lineNum">     798 </span>            :                                 break;
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :                         case 'D':</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :                                 temi_delay = atoi(temi_cfg+2);</span>
<span class="lineNum">     801 </span>            :                                 break;
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :                         case 'O':</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :                                 sscanf(temi_cfg+2, LLU, &amp;temi_offset);</span>
<span class="lineNum">     804 </span>            :                                 break;
<span class="lineNum">     805 </span><span class="lineCov">          2 :                         case 'I':</span>
<span class="lineNum">     806 </span><span class="lineCov">          2 :                                 sscanf(temi_cfg+2, LLU, &amp;temi_init_val);</span>
<span class="lineNum">     807 </span>            :                                 temi_use_init_val=GF_TRUE;
<span class="lineNum">     808 </span>            :                                 break;
<span class="lineNum">     809 </span><span class="lineCov">          2 :                         case 'T':</span>
<span class="lineNum">     810 </span><span class="lineCov">          4 :                                 temi_timescale = atoi(temi_cfg+2);</span>
<span class="lineNum">     811 </span>            :                                 break;
<span class="lineNum">     812 </span><span class="lineCov">          2 :                         case 'L':</span>
<span class="lineNum">     813 </span><span class="lineCov">          2 :                                 if (temi_cfg[2]=='Y') temi_64bits = TEMI_TC64_ALWAYS;</span>
<span class="lineNum">     814 </span><span class="lineCov">          2 :                                 else if (temi_cfg[2]=='N') temi_64bits = TEMI_TC64_OFF;</span>
<span class="lineNum">     815 </span>            :                                 break;
<span class="lineNum">     816 </span><span class="lineCov">          2 :                         case 'P':</span>
<span class="lineNum">     817 </span>            :                                 //all pids target
<span class="lineNum">     818 </span><span class="lineCov">          2 :                                 if (!temi_cfg[2] || (temi_cfg[2]=='*')) { }</span>
<span class="lineNum">     819 </span><span class="lineCov">          2 :                                 else if ((temi_cfg[2]=='v') || (temi_cfg[2]=='V')) { temi_streamtype = GF_STREAM_VISUAL; }</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :                                 else if ((temi_cfg[2]=='a') || (temi_cfg[2]=='A')) { temi_streamtype = GF_STREAM_AUDIO; }</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :                                 else if ((temi_cfg[2]=='t') || (temi_cfg[2]=='T')) { temi_streamtype = GF_STREAM_TEXT; }</span>
<span class="lineNum">     822 </span>            :                                 else {
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :                                         temi_index = atoi(temi_cfg+2);</span>
<span class="lineNum">     824 </span>            :                                 }
<span class="lineNum">     825 </span>            :                                 break;
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :                         default:</span>
<span class="lineNum">     827 </span>            :                                 done=GF_TRUE;
<span class="lineNum">     828 </span>            :                                 break;
<span class="lineNum">     829 </span>            :                         }
<span class="lineNum">     830 </span><span class="lineCov">          8 :                         sep[0] = '#';</span>
<span class="lineNum">     831 </span><span class="lineCov">          8 :                         if (done) {</span>
<span class="lineNum">     832 </span>            :                                 temi_cfg++;
<span class="lineNum">     833 </span>            :                                 break;
<span class="lineNum">     834 </span>            :                         }
<span class="lineNum">     835 </span>            :                         temi_cfg = sep;
<span class="lineNum">     836 </span>            :                 }
<span class="lineNum">     837 </span><span class="lineCov">          6 :                 if (!temi_cfg || !strlen(temi_cfg)) {</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[M2TSMux] Invalid temi syntax, no ID or URL specified\n&quot;));</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     840 </span>            :                 }
<span class="lineNum">     841 </span>            : 
<span class="lineNum">     842 </span><span class="lineCov">          6 :                 sep = strchr(temi_cfg, ',');</span>
<span class="lineNum">     843 </span><span class="lineCov">          6 :                 if (sep) sep[0] = 0;    </span>
<span class="lineNum">     844 </span>            : 
<span class="lineNum">     845 </span>            :                 done = GF_TRUE;
<span class="lineNum">     846 </span><span class="lineCov">          6 :                 if (temi_index &amp;&amp; (temi_index!=st_idx)) done = GF_FALSE;</span>
<span class="lineNum">     847 </span><span class="lineCov">          6 :                 else if (temi_streamtype &amp;&amp; (temi_streamtype!=tspid-&gt;esi.stream_type)) done = GF_FALSE;</span>
<span class="lineNum">     848 </span><span class="lineCov">          5 :                 else if (service_id &amp;&amp; (service_id != tspid-&gt;mstream-&gt;program-&gt;number)) done = GF_FALSE;</span>
<span class="lineNum">     849 </span>            : 
<span class="lineNum">     850 </span>            :                 //that's for this stream
<span class="lineNum">     851 </span>            :                 if (done)  {
<span class="lineNum">     852 </span>            :                         TEMIDesc *temi;
<span class="lineNum">     853 </span><span class="lineCov">          5 :                         if (!tspid-&gt;temi_descs) tspid-&gt;temi_descs = gf_list_new();</span>
<span class="lineNum">     854 </span><span class="lineCov">          5 :                         GF_SAFEALLOC(temi, TEMIDesc);</span>
<span class="lineNum">     855 </span><span class="lineCov">          5 :                         temi-&gt;id = atoi(temi_cfg);</span>
<span class="lineNum">     856 </span><span class="lineCov">          5 :                         if (!temi-&gt;id) {</span>
<span class="lineNum">     857 </span><span class="lineCov">          2 :                                 temi-&gt;url = gf_strdup(temi_cfg);</span>
<span class="lineNum">     858 </span><span class="lineCov">          2 :                                 temi-&gt;id = temi_id+1;</span>
<span class="lineNum">     859 </span>            :                         }
<span class="lineNum">     860 </span><span class="lineCov">          5 :                         temi-&gt;ntp = temi_ntp;</span>
<span class="lineNum">     861 </span><span class="lineCov">          5 :                         temi-&gt;offset = temi_offset;</span>
<span class="lineNum">     862 </span><span class="lineCov">          5 :                         temi-&gt;delay = temi_delay;</span>
<span class="lineNum">     863 </span><span class="lineCov">          5 :                         temi-&gt;timescale = temi_timescale;</span>
<span class="lineNum">     864 </span><span class="lineCov">          5 :                         temi-&gt;mode_64bits = temi_64bits;</span>
<span class="lineNum">     865 </span><span class="lineCov">          5 :                         temi-&gt;init_val = temi_init_val;</span>
<span class="lineNum">     866 </span><span class="lineCov">          5 :                         temi-&gt;use_init_val = temi_use_init_val;</span>
<span class="lineNum">     867 </span><span class="lineCov">          5 :                         gf_list_add(tspid-&gt;temi_descs, temi);</span>
<span class="lineNum">     868 </span>            :                 }
<span class="lineNum">     869 </span><span class="lineCov">          6 :                 if (!sep) break;</span>
<span class="lineNum">     870 </span><span class="lineCov">          2 :                 sep[0] = ',';</span>
<span class="lineNum">     871 </span><span class="lineCov">          2 :                 temi_cfg = sep+1;</span>
<span class="lineNum">     872 </span>            :         }
<a name="873"><span class="lineNum">     873 </span>            : }</a>
<span class="lineNum">     874 </span>            : 
<span class="lineNum">     875 </span><span class="lineCov">         49 : static void tsmux_del_stream(M2Pid *tspid)</span>
<span class="lineNum">     876 </span>            : {
<span class="lineNum">     877 </span><span class="lineCov">         49 :         if (tspid-&gt;temi_descs) {</span>
<span class="lineNum">     878 </span><span class="lineCov">          8 :                 while (gf_list_count(tspid-&gt;temi_descs)) {</span>
<span class="lineNum">     879 </span><span class="lineCov">          5 :                         TEMIDesc *temi = gf_list_pop_back(tspid-&gt;temi_descs);</span>
<span class="lineNum">     880 </span><span class="lineCov">          5 :                         if (temi-&gt;url) gf_free(temi-&gt;url);</span>
<span class="lineNum">     881 </span><span class="lineCov">          5 :                         gf_free(temi);</span>
<span class="lineNum">     882 </span>            :                 }
<span class="lineNum">     883 </span><span class="lineCov">          3 :                 gf_list_del(tspid-&gt;temi_descs);</span>
<span class="lineNum">     884 </span>            :         }
<span class="lineNum">     885 </span><span class="lineCov">         49 :         if (tspid-&gt;af_data) gf_free(tspid-&gt;af_data);</span>
<span class="lineNum">     886 </span><span class="lineCov">         49 :         if (tspid-&gt;temi_af_bs) gf_bs_del(tspid-&gt;temi_af_bs);</span>
<span class="lineNum">     887 </span>            : 
<span class="lineNum">     888 </span><span class="lineCov">         49 :         if (tspid-&gt;esi.sl_config) gf_free(tspid-&gt;esi.sl_config);</span>
<span class="lineNum">     889 </span><span class="lineCov">         49 :         if (tspid-&gt;pck_data_buf) gf_free(tspid-&gt;pck_data_buf);</span>
<span class="lineNum">     890 </span><span class="lineCov">         49 :         gf_free(tspid);</span>
<a name="891"><span class="lineNum">     891 </span><span class="lineCov">         49 : }</span></a>
<span class="lineNum">     892 </span>            : 
<span class="lineNum">     893 </span><span class="lineCov">         50 : static GF_Err tsmux_configure_pid(GF_Filter *filter, GF_FilterPid *pid, Bool is_remove)</span>
<span class="lineNum">     894 </span>            : {
<span class="lineNum">     895 </span>            :         u32 service_id, codec_id, streamtype;
<span class="lineNum">     896 </span>            :         GF_M2TS_Mux_Stream *ts_stream;
<span class="lineNum">     897 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">     898 </span><span class="lineCov">         50 :         GF_PropertyEntry *pe=NULL;</span>
<span class="lineNum">     899 </span>            :         M2Pid *tspid=NULL;
<span class="lineNum">     900 </span>            :         char *sname, *pname;
<span class="lineNum">     901 </span>            :         GF_M2TS_Mux_Program *prog;
<span class="lineNum">     902 </span><span class="lineCov">         50 :         GF_TSMuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">     903 </span>            : 
<span class="lineNum">     904 </span><span class="lineCov">         50 :         if (is_remove) {</span>
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :                 tspid = gf_filter_pid_get_udta(pid);</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :                 if (!tspid) return GF_OK;</span>
<span class="lineNum">     907 </span>            :                 //remove stream - this will update PMT as well
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :                 gf_m2ts_program_stream_remove(tspid-&gt;mstream);</span>
<span class="lineNum">     909 </span>            :                 //destroy or object
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :                 gf_list_del_item(ctx-&gt;pids, tspid);</span>
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :                 tsmux_del_stream(tspid);</span>
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     913 </span>            :         }
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span><span class="lineCov">         50 :         if (!gf_filter_pid_check_caps(pid))</span>
<span class="lineNum">     916 </span>            :                 return GF_NOT_SUPPORTED;
<span class="lineNum">     917 </span>            : 
<span class="lineNum">     918 </span><span class="lineCov">         50 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_CODECID);</span>
<span class="lineNum">     919 </span><span class="lineCov">         50 :         if (!p) return GF_NOT_SUPPORTED;</span>
<span class="lineNum">     920 </span><span class="lineCov">         50 :         codec_id = p-&gt;value.uint;</span>
<span class="lineNum">     921 </span><span class="lineCov">         50 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_STREAM_TYPE);</span>
<span class="lineNum">     922 </span><span class="lineCov">         50 :         if (!p) return GF_NOT_SUPPORTED;</span>
<span class="lineNum">     923 </span><span class="lineCov">         50 :         streamtype = p-&gt;value.uint;</span>
<span class="lineNum">     924 </span>            : 
<span class="lineNum">     925 </span><span class="lineCov">         50 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_SERVICE_ID);</span>
<span class="lineNum">     926 </span><span class="lineCov">         50 :         service_id = p ? p-&gt;value.uint : ctx-&gt;sid;</span>
<span class="lineNum">     927 </span>            : 
<span class="lineNum">     928 </span><span class="lineCov">         50 :         sname = ctx-&gt;name;</span>
<span class="lineNum">     929 </span><span class="lineCov">         50 :         pname = ctx-&gt;provider;</span>
<span class="lineNum">     930 </span><span class="lineCov">         50 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_SERVICE_NAME);</span>
<span class="lineNum">     931 </span><span class="lineCov">         50 :         if (p) sname = p-&gt;value.string;</span>
<span class="lineNum">     932 </span><span class="lineCov">         50 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_SERVICE_PROVIDER);</span>
<span class="lineNum">     933 </span><span class="lineCov">         50 :         if (p) pname = p-&gt;value.string;</span>
<span class="lineNum">     934 </span>            : 
<span class="lineNum">     935 </span><span class="lineCov">         50 :         if (!ctx-&gt;opid) {</span>
<span class="lineNum">     936 </span><span class="lineCov">         37 :                 ctx-&gt;opid = gf_filter_pid_new(filter);</span>
<span class="lineNum">     937 </span><span class="lineCov">         37 :                 gf_filter_pid_set_name(ctx-&gt;opid, &quot;ts_mux&quot;);</span>
<span class="lineNum">     938 </span>            :         }
<span class="lineNum">     939 </span>            :         //set output properties at init or reconfig
<span class="lineNum">     940 </span><span class="lineCov">         50 :         gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_DECODER_CONFIG, NULL);</span>
<span class="lineNum">     941 </span><span class="lineCov">         50 :         gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_DECODER_CONFIG_ENHANCEMENT, NULL);</span>
<span class="lineNum">     942 </span><span class="lineCov">         50 :         gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_UNFRAMED, NULL);</span>
<span class="lineNum">     943 </span><span class="lineCov">         50 :         gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_STREAM_TYPE, &amp;PROP_UINT(GF_STREAM_FILE) );</span>
<span class="lineNum">     944 </span><span class="lineCov">         50 :         gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_CODECID, &amp;PROP_UINT(GF_CODECID_FAKE_MP2T));</span>
<span class="lineNum">     945 </span><span class="lineCov">         50 :         gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_TIMESCALE, &amp;PROP_UINT(90000));</span>
<span class="lineNum">     946 </span><span class="lineCov">         50 :         gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_NO_TS_LOOP, &amp;PROP_BOOL(GF_TRUE));</span>
<span class="lineNum">     947 </span><span class="lineCov">         50 :         gf_filter_pid_set_property(ctx-&gt;opid, GF_PROP_PID_DASH_MODE, NULL);</span>
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span><span class="lineCov">         50 :         mux_assign_mime_file_ext(pid, ctx-&gt;opid, M2TS_FILE_EXTS, M2TS_MIMES, &quot;ts&quot;);</span>
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span><span class="lineCov">         50 :         p = gf_filter_pid_get_info(pid, GF_PROP_PID_DASH_MODE, &amp;pe);</span>
<span class="lineNum">     952 </span><span class="lineCov">         50 :         if (p) {</span>
<span class="lineNum">     953 </span><span class="lineCov">         11 :                 if (!ctx-&gt;dash_mode &amp;&amp; p-&gt;value.uint) ctx-&gt;init_dash = GF_TRUE;</span>
<span class="lineNum">     954 </span><span class="lineCov">         11 :                 ctx-&gt;dash_mode = p-&gt;value.uint;</span>
<span class="lineNum">     955 </span><span class="lineCov">         11 :                 if (ctx-&gt;dash_mode) {</span>
<span class="lineNum">     956 </span><span class="lineCov">         11 :                         ctx-&gt;mux-&gt;flush_pes_at_rap = GF_TRUE;</span>
<span class="lineNum">     957 </span><span class="lineCov">         11 :                         gf_m2ts_mux_set_initial_pcr(ctx-&gt;mux, 0);</span>
<span class="lineNum">     958 </span>            :                 }
<span class="lineNum">     959 </span>            :         }
<span class="lineNum">     960 </span><span class="lineCov">         50 :         gf_filter_release_property(pe);</span>
<span class="lineNum">     961 </span>            : 
<span class="lineNum">     962 </span><span class="lineCov">         50 :         tspid = gf_filter_pid_get_udta(pid);</span>
<span class="lineNum">     963 </span><span class="lineCov">         50 :         if (!tspid) {</span>
<span class="lineNum">     964 </span><span class="lineCov">         49 :                 GF_SAFEALLOC(tspid, M2Pid);</span>
<span class="lineNum">     965 </span><span class="lineCov">         49 :                 if (!tspid) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     966 </span><span class="lineCov">         49 :                 gf_filter_pid_set_udta(pid, tspid);</span>
<span class="lineNum">     967 </span><span class="lineCov">         49 :                 tspid-&gt;ipid = pid;</span>
<span class="lineNum">     968 </span><span class="lineCov">         49 :                 tspid-&gt;sid = service_id;</span>
<span class="lineNum">     969 </span><span class="lineCov">         49 :                 tspid-&gt;ctx = ctx;</span>
<span class="lineNum">     970 </span><span class="lineCov">         49 :                 gf_list_add(ctx-&gt;pids, tspid);</span>
<span class="lineNum">     971 </span><span class="lineCov">         49 :                 gf_filter_pid_set_framing_mode(pid, GF_TRUE);</span>
<span class="lineNum">     972 </span>            : 
<span class="lineNum">     973 </span><span class="lineCov">         49 :                 if (ctx-&gt;breq) {</span>
<span class="lineNum">     974 </span>            :                         GF_FilterEvent evt;
<span class="lineNum">     975 </span><span class="lineCov">         49 :                         GF_FEVT_INIT(evt, GF_FEVT_BUFFER_REQ, pid);</span>
<span class="lineNum">     976 </span><span class="lineCov">         49 :                         evt.buffer_req.max_buffer_us = 1000*ctx-&gt;breq;</span>
<span class="lineNum">     977 </span><span class="lineCov">         49 :                         evt.buffer_req.pid_only = GF_TRUE;</span>
<span class="lineNum">     978 </span><span class="lineCov">         49 :                         gf_filter_pid_send_event(pid, &amp;evt);</span>
<span class="lineNum">     979 </span>            :                 }
<span class="lineNum">     980 </span>            :         }
<span class="lineNum">     981 </span>            : 
<span class="lineNum">     982 </span>            :         //do we need a new program
<span class="lineNum">     983 </span><span class="lineCov">         50 :         prog = gf_m2ts_mux_program_find(ctx-&gt;mux, service_id);</span>
<span class="lineNum">     984 </span><span class="lineCov">         50 :         if (!prog) {</span>
<span class="lineNum">     985 </span>            :                 u32 nb_progs;
<span class="lineNum">     986 </span>            :                 u64 first_pts_val;
<span class="lineNum">     987 </span>            :                 u64 pcr_offset=0;
<span class="lineNum">     988 </span><span class="lineCov">         37 :                 u32 pmt_id = ctx-&gt;pmt_id;</span>
<span class="lineNum">     989 </span>            : 
<span class="lineNum">     990 </span><span class="lineCov">         37 :                 if (!pmt_id) pmt_id = 100;</span>
<span class="lineNum">     991 </span><span class="lineCov">         37 :                 nb_progs = gf_m2ts_mux_program_count(ctx-&gt;mux);</span>
<span class="lineNum">     992 </span><span class="lineCov">         37 :                 if (nb_progs&gt;1) {</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;dash_mode) {</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[M2TSMux] Muxing several programs (%d) in DASH mode is not allowed\n&quot;, nb_progs+1));</span>
<span class="lineNum">     995 </span>            :                                 return GF_BAD_PARAM;
<span class="lineNum">     996 </span>            :                         }
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :                         pmt_id += (nb_progs - 1) * 100;</span>
<span class="lineNum">     998 </span>            :                 }
<span class="lineNum">     999 </span>            : 
<span class="lineNum">    1000 </span><span class="lineCov">         37 :                 p = gf_filter_pid_get_property_str(tspid-&gt;ipid, &quot;tsmux:pcr_offset&quot;);</span>
<span class="lineNum">    1001 </span><span class="lineCov">         37 :                 if (p &amp;&amp; (p-&gt;type==GF_PROP_LUINT)) {</span>
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :                         pcr_offset = p-&gt;value.longuint;</span>
<span class="lineNum">    1003 </span><span class="lineCov">         37 :                 } else if (ctx-&gt;pcr_offset==(u64)-1) {</span>
<span class="lineNum">    1004 </span><span class="lineCov">         36 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_MAX_FRAME_SIZE);</span>
<span class="lineNum">    1005 </span><span class="lineCov">         36 :                         if (p &amp;&amp; p-&gt;value.uint &amp;&amp; ctx-&gt;rate) {</span>
<span class="lineNum">    1006 </span><span class="lineCov">          1 :                                 Double r = p-&gt;value.uint * 8;</span>
<span class="lineNum">    1007 </span><span class="lineCov">          1 :                                 r *= 90000;</span>
<span class="lineNum">    1008 </span><span class="lineCov">          1 :                                 r/= ctx-&gt;rate;</span>
<span class="lineNum">    1009 </span>            :                                 //add 10% of safety to cover TS signaling and other potential table update while sending the largest PES
<span class="lineNum">    1010 </span><span class="lineCov">          1 :                                 r *= 1.1;</span>
<span class="lineNum">    1011 </span><span class="lineCov">          1 :                                 pcr_offset = (u64) r;</span>
<span class="lineNum">    1012 </span>            :                         }
<span class="lineNum">    1013 </span>            :                 } else {
<span class="lineNum">    1014 </span>            :                         pcr_offset = ctx-&gt;pcr_offset;
<span class="lineNum">    1015 </span>            :                 }
<span class="lineNum">    1016 </span><span class="lineCov">         37 :                 p = gf_filter_pid_get_property_str(tspid-&gt;ipid, &quot;tsmux:force_pts&quot;);</span>
<span class="lineNum">    1017 </span><span class="lineCov">         37 :                 if (p &amp;&amp; (p-&gt;type==GF_PROP_LUINT)) first_pts_val = p-&gt;value.longuint;</span>
<span class="lineNum">    1018 </span><span class="lineCov">         37 :                 else first_pts_val = ctx-&gt;first_pts;</span>
<span class="lineNum">    1019 </span>            : 
<span class="lineNum">    1020 </span><span class="lineCov">         37 :                 prog = gf_m2ts_mux_program_add(ctx-&gt;mux, service_id, pmt_id, ctx-&gt;pmt_rate, pcr_offset, ctx-&gt;mpeg4, ctx-&gt;pmt_version, ctx-&gt;disc, first_pts_val);</span>
<span class="lineNum">    1021 </span>            : 
<span class="lineNum">    1022 </span><span class="lineCov">         37 :                 if (sname) gf_m2ts_mux_program_set_name(prog, sname, pname);</span>
<span class="lineNum">    1023 </span>            : 
<span class="lineNum">    1024 </span><span class="lineCov">         37 :                 GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[M2TSMux] Setting up program ID %d - send rates: PSI %d ms PCR every %d ms max - PCR offset %d\n&quot;, service_id, ctx-&gt;pmt_rate, ctx-&gt;max_pcr, ctx-&gt;pcr_offset));</span>
<span class="lineNum">    1025 </span>            :         }
<span class="lineNum">    1026 </span>            :         //no changes in codec ID or stream type
<span class="lineNum">    1027 </span><span class="lineCov">         50 :         if ((tspid-&gt;codec_id == codec_id) &amp;&amp; (tspid-&gt;esi.stream_type == streamtype))</span>
<span class="lineNum">    1028 </span>            :                 return GF_OK;
<span class="lineNum">    1029 </span>            : 
<span class="lineNum">    1030 </span><span class="lineCov">         49 :         if (!tspid-&gt;codec_id) {</span>
<span class="lineNum">    1031 </span>            :                 Bool is_pcr=GF_FALSE;
<span class="lineNum">    1032 </span>            :                 Bool force_pes=GF_FALSE;
<span class="lineNum">    1033 </span>            :                 u32 pes_pid;
<span class="lineNum">    1034 </span>            :                 assert(!tspid-&gt;esi.stream_type);
<span class="lineNum">    1035 </span><span class="lineCov">         49 :                 tspid-&gt;codec_id = codec_id;</span>
<span class="lineNum">    1036 </span><span class="lineCov">         49 :                 tspid-&gt;esi.stream_type = streamtype;</span>
<span class="lineNum">    1037 </span>            : 
<span class="lineNum">    1038 </span><span class="lineCov">         49 :                 if (ctx-&gt;bifs_pes &amp;&amp; (tspid-&gt;esi.stream_type==GF_STREAM_SCENE))</span>
<span class="lineNum">    1039 </span>            :                         force_pes = GF_TRUE;
<span class="lineNum">    1040 </span>            : 
<span class="lineNum">    1041 </span><span class="lineCov">         49 :                 pes_pid = gf_m2ts_mux_program_get_pmt_pid(prog);</span>
<span class="lineNum">    1042 </span><span class="lineCov">         49 :                 pes_pid += 1 + gf_m2ts_mux_program_get_stream_count(prog);</span>
<span class="lineNum">    1043 </span><span class="lineCov">         49 :                 if (gf_m2ts_mux_program_get_pcr_pid(prog)==0) {</span>
<span class="lineNum">    1044 </span><span class="lineCov">         49 :                         if (streamtype==GF_STREAM_VISUAL)</span>
<span class="lineNum">    1045 </span>            :                                 is_pcr = GF_TRUE;
<span class="lineNum">    1046 </span>            :                         else
<span class="lineNum">    1047 </span><span class="lineCov">         26 :                                 ctx-&gt;check_pcr = GF_TRUE;</span>
<span class="lineNum">    1048 </span>            :                         //if no video track we will update the PCR at the first packets
<span class="lineNum">    1049 </span>            :                 }
<span class="lineNum">    1050 </span>            : 
<span class="lineNum">    1051 </span><span class="lineCov">         49 :                 tsmux_setup_esi(ctx, prog, tspid, streamtype);</span>
<span class="lineNum">    1052 </span><span class="lineCov">         49 :                 tspid-&gt;mstream = gf_m2ts_program_stream_add(prog, &amp;tspid-&gt;esi, pes_pid, is_pcr, force_pes, GF_FALSE);</span>
<span class="lineNum">    1053 </span><span class="lineCov">         49 :                 tsmux_setup_temi(ctx, tspid);</span>
<span class="lineNum">    1054 </span>            :         } else {
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :                 tspid-&gt;codec_id = codec_id;</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :                 tsmux_setup_esi(ctx, prog, tspid, streamtype);</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :                 prog-&gt;pmt-&gt;table_needs_update = GF_TRUE;</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :                 ctx-&gt;pmt_update_pending = GF_TRUE;</span>
<span class="lineNum">    1059 </span>            :         }
<span class="lineNum">    1060 </span><span class="lineCov">         49 :         ctx-&gt;update_mux = GF_TRUE;</span>
<span class="lineNum">    1061 </span>            : 
<span class="lineNum">    1062 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_DELAY);</span>
<span class="lineNum">    1063 </span><span class="lineCov">         49 :         if (p) {</span>
<span class="lineNum">    1064 </span><span class="lineCov">          7 :                 tspid-&gt;media_delay = p-&gt;value.longsint;</span>
<span class="lineNum">    1065 </span>            : 
<span class="lineNum">    1066 </span>            :                 //compute max ts skip for this program
<span class="lineNum">    1067 </span>            :                 s64 max_media_skip = 0;
<span class="lineNum">    1068 </span>            :                 u32 max_skip_ts = 0;
<span class="lineNum">    1069 </span><span class="lineCov">          7 :                 ts_stream = prog-&gt;streams;</span>
<span class="lineNum">    1070 </span><span class="lineCov">         29 :                 while (ts_stream) {</span>
<span class="lineNum">    1071 </span><span class="lineCov">         15 :                         M2Pid *atspid = ts_stream-&gt;ifce-&gt;input_udta;</span>
<span class="lineNum">    1072 </span>            :                         s64 media_skip;
<span class="lineNum">    1073 </span><span class="lineCov">         15 :                         if (atspid-&gt;media_delay&gt;=0) {</span>
<span class="lineNum">    1074 </span><span class="lineCov">          8 :                                 ts_stream = ts_stream-&gt;next;</span>
<span class="lineNum">    1075 </span><span class="lineCov">          8 :                                 continue;</span>
<span class="lineNum">    1076 </span>            :                         }
<span class="lineNum">    1077 </span>            : 
<span class="lineNum">    1078 </span><span class="lineCov">          7 :                         media_skip = -atspid-&gt;media_delay;</span>
<span class="lineNum">    1079 </span><span class="lineCov">          7 :                         if (!max_media_skip || (media_skip * max_skip_ts &gt; max_media_skip * atspid-&gt;esi.timescale) ) {</span>
<span class="lineNum">    1080 </span>            :                                 max_media_skip = media_skip ;
<span class="lineNum">    1081 </span><span class="lineCov">          7 :                                 max_skip_ts = atspid-&gt;esi.timescale;</span>
<span class="lineNum">    1082 </span>            :                         }
<span class="lineNum">    1083 </span><span class="lineCov">          7 :                         ts_stream = ts_stream-&gt;next;</span>
<span class="lineNum">    1084 </span>            :                 }
<span class="lineNum">    1085 </span>            : 
<span class="lineNum">    1086 </span>            :                 ts_stream = prog-&gt;streams;
<span class="lineNum">    1087 </span><span class="lineCov">         22 :                 while (ts_stream) {</span>
<span class="lineNum">    1088 </span><span class="lineCov">         15 :                         M2Pid *atspid = ts_stream-&gt;ifce-&gt;input_udta;</span>
<span class="lineNum">    1089 </span><span class="lineCov">         15 :                         if (max_skip_ts) {</span>
<span class="lineNum">    1090 </span><span class="lineCov">         15 :                                 atspid-&gt;max_media_skip = (max_media_skip * atspid-&gt;esi.timescale / max_skip_ts);</span>
<span class="lineNum">    1091 </span>            :                         } else {
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :                                 atspid-&gt;max_media_skip = 0;</span>
<span class="lineNum">    1093 </span>            :                         }
<span class="lineNum">    1094 </span><span class="lineCov">         15 :                         ts_stream = ts_stream-&gt;next;</span>
<span class="lineNum">    1095 </span>            :                 }
<span class="lineNum">    1096 </span>            :         }
<span class="lineNum">    1097 </span><span class="lineCov">         49 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_CTS_SHIFT);</span>
<span class="lineNum">    1098 </span><span class="lineCov">         49 :         if (p) {</span>
<span class="lineNum">    1099 </span><span class="lineCov">          1 :                 u64 diff = p-&gt;value.uint;</span>
<span class="lineNum">    1100 </span><span class="lineCov">          1 :                 diff *= 1000000;</span>
<span class="lineNum">    1101 </span><span class="lineCov">          1 :                 diff /= tspid-&gt;esi.timescale;</span>
<span class="lineNum">    1102 </span><span class="lineCov">          1 :                 if (diff &gt; tspid-&gt;prog-&gt;cts_offset)</span>
<span class="lineNum">    1103 </span><span class="lineCov">          1 :                         tspid-&gt;prog-&gt;cts_offset = (u32) diff;</span>
<span class="lineNum">    1104 </span>            :         }
<span class="lineNum">    1105 </span>            :         return GF_OK;
<a name="1106"><span class="lineNum">    1106 </span>            : }</a>
<span class="lineNum">    1107 </span>            : 
<span class="lineNum">    1108 </span><span class="lineCov">         25 : static void tsmux_assign_pcr(GF_TSMuxCtx *ctx)</span>
<span class="lineNum">    1109 </span>            : {
<span class="lineNum">    1110 </span><span class="lineCov">         25 :         GF_M2TS_Mux_Program *prog = ctx-&gt;mux-&gt;programs;</span>
<span class="lineNum">    1111 </span><span class="lineCov">         50 :         while (prog) {</span>
<span class="lineNum">    1112 </span>            :                 GF_M2TS_Mux_Stream *stream;
<span class="lineNum">    1113 </span><span class="lineCov">         25 :                 if (prog-&gt;pcr) {</span>
<span class="lineNum">    1114 </span><span class="lineCov">         11 :                         prog = prog-&gt;next;</span>
<span class="lineNum">    1115 </span><span class="lineCov">         11 :                         continue;</span>
<span class="lineNum">    1116 </span>            :                 }
<span class="lineNum">    1117 </span><span class="lineCov">         14 :                 stream = prog-&gt;streams;</span>
<span class="lineNum">    1118 </span><span class="lineCov">         28 :                 while (stream) {</span>
<span class="lineNum">    1119 </span><span class="lineCov">         14 :                         if (stream-&gt;ifce-&gt;stream_type==GF_STREAM_VISUAL) {</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :                                 prog-&gt;pcr = stream;</span>
<span class="lineNum">    1121 </span>            :                                 break;
<span class="lineNum">    1122 </span>            :                         }
<span class="lineNum">    1123 </span><span class="lineCov">         14 :                         stream = stream-&gt;next;</span>
<span class="lineNum">    1124 </span>            :                 }
<span class="lineNum">    1125 </span><span class="lineCov">         14 :                 if (!prog-&gt;pcr) prog-&gt;pcr = prog-&gt;streams;</span>
<span class="lineNum">    1126 </span><span class="lineCov">         14 :                 ctx-&gt;update_mux = GF_TRUE;</span>
<span class="lineNum">    1127 </span><span class="lineCov">         14 :                 prog = prog-&gt;next;</span>
<span class="lineNum">    1128 </span>            :         }
<a name="1129"><span class="lineNum">    1129 </span><span class="lineCov">         25 : }</span></a>
<span class="lineNum">    1130 </span>            : 
<span class="lineNum">    1131 </span><span class="lineCov">         59 : static Bool tsmux_init_buffering(GF_Filter *filter, GF_TSMuxCtx *ctx)</span>
<span class="lineNum">    1132 </span>            : {
<span class="lineNum">    1133 </span><span class="lineCov">         59 :         u32 mbuf = ctx-&gt;breq*1000;</span>
<span class="lineNum">    1134 </span><span class="lineCov">         59 :         u32 i, count = gf_filter_get_ipid_count(filter);</span>
<span class="lineNum">    1135 </span><span class="lineCov">        111 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1136 </span>            :                 u32 buf;
<span class="lineNum">    1137 </span>            :                 Bool buf_ok;
<span class="lineNum">    1138 </span><span class="lineCov">         74 :                 GF_FilterPid *pid = gf_filter_get_ipid(filter, i);</span>
<span class="lineNum">    1139 </span><span class="lineCov">         74 :                 buf_ok = gf_filter_pid_get_buffer_occupancy(pid, NULL, NULL, NULL, &amp;buf);</span>
<span class="lineNum">    1140 </span><span class="lineCov">         74 :                 if (buf_ok &amp;&amp; (buf &lt; mbuf) &amp;&amp; !gf_filter_pid_has_seen_eos(pid))</span>
<span class="lineNum">    1141 </span><span class="lineCov">         22 :                         return GF_FALSE;</span>
<span class="lineNum">    1142 </span>            :         }
<span class="lineNum">    1143 </span><span class="lineCov">         37 :         ctx-&gt;init_buffering = GF_FALSE;</span>
<span class="lineNum">    1144 </span><span class="lineCov">         37 :         gf_m2ts_mux_update_config(ctx-&gt;mux, GF_TRUE);</span>
<span class="lineNum">    1145 </span><span class="lineCov">         37 :         return GF_TRUE;</span>
<a name="1146"><span class="lineNum">    1146 </span>            : }</a>
<span class="lineNum">    1147 </span>            : 
<span class="lineNum">    1148 </span><span class="lineCov">        161 : static void tsmux_send_seg_event(GF_Filter *filter, GF_TSMuxCtx *ctx)</span>
<span class="lineNum">    1149 </span>            : {
<span class="lineNum">    1150 </span>            :         GF_FilterEvent evt;
<span class="lineNum">    1151 </span>            :         u32 i;
<span class="lineNum">    1152 </span>            :         M2Pid *tspid = NULL;
<span class="lineNum">    1153 </span>            : 
<span class="lineNum">    1154 </span><span class="lineCov">        339 :         for (i=0; i&lt;gf_list_count(ctx-&gt;pids); i++) {</span>
<span class="lineNum">    1155 </span><span class="lineCov">        186 :                 tspid = gf_list_get(ctx-&gt;pids, i);</span>
<span class="lineNum">    1156 </span><span class="lineCov">        186 :                 if (ctx-&gt;nb_sidx_entries) break;</span>
<span class="lineNum">    1157 </span><span class="lineCov">        178 :                 if (ctx-&gt;ref_pid == tspid-&gt;mstream-&gt;pid) break;</span>
<span class="lineNum">    1158 </span>            :                 tspid = NULL;
<span class="lineNum">    1159 </span>            :         }
<span class="lineNum">    1160 </span><span class="lineCov">        161 :         if (!tspid) tspid = gf_list_get(ctx-&gt;pids, 0);</span>
<span class="lineNum">    1161 </span>            : 
<span class="lineNum">    1162 </span><span class="lineCov">        161 :         if (ctx-&gt;nb_sidx_entries) {</span>
<span class="lineNum">    1163 </span>            :                 GF_FilterPacket *idx_pck;
<span class="lineNum">    1164 </span>            :                 u8 *output;
<span class="lineNum">    1165 </span>            :                 Bool large_sidx = GF_FALSE;
<span class="lineNum">    1166 </span>            :                 u32 segidx_size=0;
<span class="lineNum">    1167 </span><span class="lineCov">          8 :                 u64 last_pck_dur = tspid-&gt;pck_duration;</span>
<span class="lineNum">    1168 </span><span class="lineCov">          8 :                 last_pck_dur *= 90000;</span>
<span class="lineNum">    1169 </span><span class="lineCov">          8 :                 last_pck_dur /= tspid-&gt;esi.timescale;</span>
<span class="lineNum">    1170 </span>            : 
<span class="lineNum">    1171 </span><span class="lineCov">          8 :                 if (ctx-&gt;sidx_entries[ctx-&gt;nb_sidx_entries-1].sap_time &gt; 0xFFFFFFFFUL)</span>
<span class="lineNum">    1172 </span>            :                         large_sidx = GF_TRUE;
<span class="lineNum">    1173 </span><span class="lineCov">          8 :                 if (ctx-&gt;sidx_entries[0].offset*188 &gt; 0xFFFFFFFFUL)</span>
<span class="lineNum">    1174 </span>            :                         large_sidx = GF_TRUE;
<span class="lineNum">    1175 </span>            : 
<span class="lineNum">    1176 </span>            :                 //styp box: 8(box) + 4(major) + 4(version) + 4(compat brand)
<span class="lineNum">    1177 </span>            :                 segidx_size = 20;
<span class="lineNum">    1178 </span>            :                 //sidx size: 12 (fullbox) + 8 + large ? 16 : 8 + 4 + nb_entries+12
<span class="lineNum">    1179 </span><span class="lineCov">          8 :                 segidx_size += 24 +( large_sidx ? 16 : 8) + ctx-&gt;nb_sidx_entries*12;</span>
<span class="lineNum">    1180 </span>            : 
<span class="lineNum">    1181 </span><span class="lineCov">          8 :                 if (!ctx-&gt;idx_opid) {</span>
<span class="lineNum">    1182 </span><span class="lineCov">          1 :                         const char *ext = gf_file_ext_start(ctx-&gt;idx_file_name);</span>
<span class="lineNum">    1183 </span><span class="lineCov">          1 :                         if (!ext) ext = &quot;idx&quot;;</span>
<span class="lineNum">    1184 </span><span class="lineCov">          1 :                         else ext++;</span>
<span class="lineNum">    1185 </span><span class="lineCov">          1 :                         ctx-&gt;idx_filter = gf_filter_connect_destination(filter, ctx-&gt;idx_file_name, NULL);</span>
<span class="lineNum">    1186 </span><span class="lineCov">          1 :                         ctx-&gt;idx_opid = gf_filter_pid_new(filter);</span>
<span class="lineNum">    1187 </span><span class="lineCov">          1 :                         gf_filter_pid_set_property(ctx-&gt;idx_opid, GF_PROP_PID_STREAM_TYPE, &amp;PROP_UINT(GF_STREAM_FILE) );</span>
<span class="lineNum">    1188 </span><span class="lineCov">          1 :                         gf_filter_pid_set_property(ctx-&gt;idx_opid, GF_PROP_PID_FILE_EXT, &amp;PROP_STRING(ext) );</span>
<span class="lineNum">    1189 </span><span class="lineCov">          1 :                         gf_filter_pid_set_property(ctx-&gt;idx_opid, GF_PROP_PID_MIME, &amp;PROP_STRING(&quot;*&quot;) );</span>
<span class="lineNum">    1190 </span><span class="lineCov">          1 :                         gf_filter_pid_set_name(ctx-&gt;idx_opid, &quot;ts_idx&quot;);</span>
<span class="lineNum">    1191 </span><span class="lineCov">          1 :                         if (ctx-&gt;idx_filter) gf_filter_set_source(ctx-&gt;idx_filter, filter, NULL);</span>
<span class="lineNum">    1192 </span>            :                 }
<span class="lineNum">    1193 </span><span class="lineCov">          8 :                 idx_pck = gf_filter_pck_new_alloc(ctx-&gt;idx_opid, segidx_size, &amp;output);</span>
<span class="lineNum">    1194 </span><span class="lineCov">          8 :                 if (!idx_pck) return;</span>
<span class="lineNum">    1195 </span>            : 
<span class="lineNum">    1196 </span><span class="lineCov">          8 :                 if (!ctx-&gt;idx_bs) ctx-&gt;idx_bs = gf_bs_new(output, segidx_size, GF_BITSTREAM_WRITE);</span>
<span class="lineNum">    1197 </span><span class="lineCov">          7 :                 else gf_bs_reassign_buffer(ctx-&gt;idx_bs, output, segidx_size);</span>
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span>            :                 //write styp box
<span class="lineNum">    1200 </span><span class="lineCov">          8 :                 gf_bs_write_u32(ctx-&gt;idx_bs, 20);</span>
<span class="lineNum">    1201 </span><span class="lineCov">          8 :                 gf_bs_write_u32(ctx-&gt;idx_bs, GF_4CC('s','t','y','p') );</span>
<span class="lineNum">    1202 </span><span class="lineCov">          8 :                 gf_bs_write_u32(ctx-&gt;idx_bs, GF_4CC('s','i','s','x') );</span>
<span class="lineNum">    1203 </span><span class="lineCov">          8 :                 gf_bs_write_u32(ctx-&gt;idx_bs, 0);</span>
<span class="lineNum">    1204 </span><span class="lineCov">          8 :                 gf_bs_write_u32(ctx-&gt;idx_bs, GF_4CC('s','i','s','x') );</span>
<span class="lineNum">    1205 </span>            : 
<span class="lineNum">    1206 </span>            :                 //write sidx box
<span class="lineNum">    1207 </span><span class="lineCov">          8 :                 gf_bs_write_u32(ctx-&gt;idx_bs, segidx_size - 20);</span>
<span class="lineNum">    1208 </span><span class="lineCov">          8 :                 gf_bs_write_u32(ctx-&gt;idx_bs, GF_4CC('s','i','d','x') );</span>
<span class="lineNum">    1209 </span><span class="lineCov">          8 :                 gf_bs_write_u8(ctx-&gt;idx_bs, large_sidx ? 1 : 0);</span>
<span class="lineNum">    1210 </span><span class="lineCov">          8 :                 gf_bs_write_int(ctx-&gt;idx_bs, 0, 24);</span>
<span class="lineNum">    1211 </span>            :                 //reference id
<span class="lineNum">    1212 </span><span class="lineCov">          8 :                 gf_bs_write_u32(ctx-&gt;idx_bs, ctx-&gt;ref_pid);</span>
<span class="lineNum">    1213 </span>            :                 //timescale
<span class="lineNum">    1214 </span><span class="lineCov">          8 :                 gf_bs_write_u32(ctx-&gt;idx_bs, 90000);</span>
<span class="lineNum">    1215 </span><span class="lineCov">          8 :                 if (large_sidx) {</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                         gf_bs_write_u64(ctx-&gt;idx_bs, ctx-&gt;sidx_entries[0].min_pts_plus_one-1);</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :                         gf_bs_write_u64(ctx-&gt;idx_bs, ctx-&gt;sidx_entries[0].offset*188);</span>
<span class="lineNum">    1218 </span>            :                 } else {
<span class="lineNum">    1219 </span><span class="lineCov">          8 :                         gf_bs_write_u32(ctx-&gt;idx_bs, (u32) ctx-&gt;sidx_entries[0].min_pts_plus_one-1);</span>
<span class="lineNum">    1220 </span><span class="lineCov">          8 :                         gf_bs_write_u32(ctx-&gt;idx_bs, (u32) ctx-&gt;sidx_entries[0].offset*188);</span>
<span class="lineNum">    1221 </span>            :                 }
<span class="lineNum">    1222 </span><span class="lineCov">          8 :                 gf_bs_write_u16(ctx-&gt;idx_bs, 0);</span>
<span class="lineNum">    1223 </span><span class="lineCov">          8 :                 gf_bs_write_u16(ctx-&gt;idx_bs, ctx-&gt;nb_sidx_entries);</span>
<span class="lineNum">    1224 </span><span class="lineCov">        848 :                 for (i=0; i&lt;ctx-&gt;nb_sidx_entries; i++) {</span>
<span class="lineNum">    1225 </span><span class="lineCov">        832 :                         u64 duration = ctx-&gt;sidx_entries[i].max_pts - (ctx-&gt;sidx_entries[i].min_pts_plus_one-1);</span>
<span class="lineNum">    1226 </span><span class="lineCov">        832 :                         if (i+1 == ctx-&gt;nb_sidx_entries) duration += last_pck_dur;</span>
<span class="lineNum">    1227 </span>            : 
<span class="lineNum">    1228 </span><span class="lineCov">        832 :                         gf_bs_write_int(ctx-&gt;idx_bs, 0, 1);</span>
<span class="lineNum">    1229 </span><span class="lineCov">        832 :                         gf_bs_write_int(ctx-&gt;idx_bs, ctx-&gt;sidx_entries[i].nb_pck * 188, 31);</span>
<span class="lineNum">    1230 </span><span class="lineCov">        832 :                         gf_bs_write_int(ctx-&gt;idx_bs, (u32) duration, 32);</span>
<span class="lineNum">    1231 </span><span class="lineCov">        832 :                         gf_bs_write_int(ctx-&gt;idx_bs, ctx-&gt;sidx_entries[i].sap_type ? 1 : 0, 1);</span>
<span class="lineNum">    1232 </span><span class="lineCov">        832 :                         gf_bs_write_int(ctx-&gt;idx_bs, ctx-&gt;sidx_entries[i].sap_type, 3);</span>
<span class="lineNum">    1233 </span><span class="lineCov">        832 :                         gf_bs_write_int(ctx-&gt;idx_bs, (u32) (ctx-&gt;sidx_entries[i].sap_time - (ctx-&gt;sidx_entries[i].min_pts_plus_one-1) ), 28);</span>
<span class="lineNum">    1234 </span>            :                 }
<span class="lineNum">    1235 </span><span class="lineCov">          8 :                 gf_filter_pck_set_property(idx_pck, GF_PROP_PCK_FILENAME, &amp;PROP_STRING(ctx-&gt;idx_file_name) );</span>
<span class="lineNum">    1236 </span>            : 
<span class="lineNum">    1237 </span><span class="lineCov">          8 :                 gf_filter_pck_send(idx_pck);</span>
<span class="lineNum">    1238 </span><span class="lineCov">          8 :                 ctx-&gt;nb_sidx_entries = 0;</span>
<span class="lineNum">    1239 </span>            :         }
<span class="lineNum">    1240 </span>            : 
<span class="lineNum">    1241 </span>            : 
<span class="lineNum">    1242 </span><span class="lineCov">        161 :         GF_FEVT_INIT(evt, GF_FEVT_SEGMENT_SIZE, tspid-&gt;ipid);</span>
<span class="lineNum">    1243 </span><span class="lineCov">        161 :         evt.seg_size.media_range_start = 188*ctx-&gt;pck_start_idx;</span>
<span class="lineNum">    1244 </span><span class="lineCov">        161 :         evt.seg_size.media_range_end = evt.seg_size.media_range_start + 188*ctx-&gt;nb_pck_in_seg - 1;</span>
<span class="lineNum">    1245 </span>            : 
<span class="lineNum">    1246 </span><span class="lineCov">        161 :         gf_filter_pid_send_event(tspid-&gt;ipid, &amp;evt);</span>
<span class="lineNum">    1247 </span><span class="lineCov">        161 :         ctx-&gt;nb_pck_in_seg = 0;</span>
<span class="lineNum">    1248 </span><span class="lineCov">        161 :         ctx-&gt;nb_sidx_entries = 0;</span>
<a name="1249"><span class="lineNum">    1249 </span>            : }</a>
<span class="lineNum">    1250 </span>            : 
<span class="lineNum">    1251 </span><span class="lineCov">     127004 : static void tsmux_insert_sidx(GF_TSMuxCtx *ctx, Bool final_flush)</span>
<span class="lineNum">    1252 </span>            : {
<span class="lineNum">    1253 </span><span class="lineCov">     127004 :         if (ctx-&gt;subs_sidx&lt;0) return;</span>
<span class="lineNum">    1254 </span>            : 
<span class="lineNum">    1255 </span><span class="lineCov">      13353 :         if (!ctx-&gt;ref_pid &amp;&amp; ctx-&gt;mux-&gt;sap_inserted)</span>
<span class="lineNum">    1256 </span><span class="lineCov">          1 :                 ctx-&gt;ref_pid = ctx-&gt;mux-&gt;last_pid;</span>
<span class="lineNum">    1257 </span><span class="lineCov">      13353 :         if (!ctx-&gt;ref_pid) return;</span>
<span class="lineNum">    1258 </span>            : 
<span class="lineNum">    1259 </span><span class="lineCov">      13351 :         if (ctx-&gt;nb_sidx_entries) {</span>
<span class="lineNum">    1260 </span><span class="lineCov">      13329 :                 TS_SIDX *tsidx = &amp;ctx-&gt;sidx_entries[ctx-&gt;nb_sidx_entries-1];</span>
<span class="lineNum">    1261 </span>            : 
<span class="lineNum">    1262 </span><span class="lineCov">      13329 :                 if (ctx-&gt;ref_pid == ctx-&gt;mux-&gt;last_pid) {</span>
<span class="lineNum">    1263 </span><span class="lineCov">       1565 :                         if (!tsidx-&gt;min_pts_plus_one) tsidx-&gt;min_pts_plus_one = ctx-&gt;mux-&gt;last_pts + 1;</span>
<span class="lineNum">    1264 </span><span class="lineCov">       1565 :                         else if (tsidx-&gt;min_pts_plus_one-1 &gt; ctx-&gt;mux-&gt;last_pts) tsidx-&gt;min_pts_plus_one = ctx-&gt;mux-&gt;last_pts + 1;</span>
<span class="lineNum">    1265 </span>            : 
<span class="lineNum">    1266 </span><span class="lineCov">       1565 :                         if (tsidx-&gt;max_pts &lt; ctx-&gt;mux-&gt;last_pts) tsidx-&gt;max_pts = ctx-&gt;mux-&gt;last_pts;</span>
<span class="lineNum">    1267 </span>            :                 }
<span class="lineNum">    1268 </span>            : 
<span class="lineNum">    1269 </span><span class="lineCov">      13329 :                 if (!final_flush &amp;&amp; !ctx-&gt;mux-&gt;sap_inserted) return;</span>
<span class="lineNum">    1270 </span>            : 
<span class="lineNum">    1271 </span><span class="lineCov">        832 :                 tsidx-&gt;nb_pck = ctx-&gt;nb_pck_in_seg - tsidx-&gt;nb_pck;</span>
<span class="lineNum">    1272 </span>            :         }
<span class="lineNum">    1273 </span>            : 
<span class="lineNum">    1274 </span><span class="lineCov">        854 :         if (final_flush) return;</span>
<span class="lineNum">    1275 </span><span class="lineCov">        846 :         if (!ctx-&gt;mux-&gt;sap_inserted) return;</span>
<span class="lineNum">    1276 </span>            : 
<span class="lineNum">    1277 </span><span class="lineCov">        832 :         if (ctx-&gt;nb_sidx_entries == ctx-&gt;nb_sidx_alloc) {</span>
<span class="lineNum">    1278 </span><span class="lineCov">         16 :                 ctx-&gt;nb_sidx_alloc += 10;</span>
<span class="lineNum">    1279 </span><span class="lineCov">         16 :                 ctx-&gt;sidx_entries = gf_realloc(ctx-&gt;sidx_entries, sizeof(TS_SIDX)*ctx-&gt;nb_sidx_alloc);</span>
<span class="lineNum">    1280 </span>            :         }
<span class="lineNum">    1281 </span><span class="lineCov">        832 :         ctx-&gt;sidx_entries[ctx-&gt;nb_sidx_entries].sap_time = ctx-&gt;mux-&gt;sap_time;</span>
<span class="lineNum">    1282 </span><span class="lineCov">        832 :         ctx-&gt;sidx_entries[ctx-&gt;nb_sidx_entries].sap_type = ctx-&gt;mux-&gt;sap_type;</span>
<span class="lineNum">    1283 </span><span class="lineCov">        832 :         ctx-&gt;sidx_entries[ctx-&gt;nb_sidx_entries].min_pts_plus_one  = ctx-&gt;mux-&gt;sap_time + 1;</span>
<span class="lineNum">    1284 </span><span class="lineCov">        832 :         ctx-&gt;sidx_entries[ctx-&gt;nb_sidx_entries].max_pts  = ctx-&gt;mux-&gt;sap_time;</span>
<span class="lineNum">    1285 </span><span class="lineCov">        832 :         ctx-&gt;sidx_entries[ctx-&gt;nb_sidx_entries].nb_pck = ctx-&gt;nb_sidx_entries ? ctx-&gt;nb_pck_in_seg : 0;</span>
<span class="lineNum">    1286 </span><span class="lineCov">        832 :         ctx-&gt;sidx_entries[ctx-&gt;nb_sidx_entries].offset = ctx-&gt;nb_sidx_entries ? 0 : ctx-&gt;nb_pck_first_sidx;</span>
<span class="lineNum">    1287 </span><span class="lineCov">        832 :         ctx-&gt;nb_sidx_entries ++;</span>
<a name="1288"><span class="lineNum">    1288 </span>            : }</a>
<span class="lineNum">    1289 </span>            : 
<span class="lineNum">    1290 </span><span class="lineCov">       6160 : static GF_Err tsmux_process(GF_Filter *filter)</span>
<span class="lineNum">    1291 </span>            : {
<span class="lineNum">    1292 </span>            :         u32 nb_pck_in_pack, nb_pck_in_call;
<span class="lineNum">    1293 </span>            :         GF_M2TSMuxState status;
<span class="lineNum">    1294 </span>            :         u32 usec_till_next;
<span class="lineNum">    1295 </span>            :         GF_FilterPacket *pck;
<span class="lineNum">    1296 </span><span class="lineCov">       6160 :         GF_TSMuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    1297 </span>            : 
<span class="lineNum">    1298 </span><span class="lineCov">       6160 :         if (ctx-&gt;check_pcr) {</span>
<span class="lineNum">    1299 </span><span class="lineCov">         25 :                 ctx-&gt;check_pcr = GF_FALSE;</span>
<span class="lineNum">    1300 </span><span class="lineCov">         25 :                 tsmux_assign_pcr(ctx);</span>
<span class="lineNum">    1301 </span>            :         }
<span class="lineNum">    1302 </span>            : 
<span class="lineNum">    1303 </span><span class="lineCov">       6160 :         if (ctx-&gt;init_buffering &amp;&amp; !tsmux_init_buffering(filter, ctx)) return GF_OK;</span>
<span class="lineNum">    1304 </span>            : 
<span class="lineNum">    1305 </span><span class="lineCov">       6138 :         if (ctx-&gt;init_dash) {</span>
<span class="lineNum">    1306 </span><span class="lineCov">          8 :                 u32 i, count = gf_list_count(ctx-&gt;pids);</span>
<span class="lineNum">    1307 </span><span class="lineCov">         19 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1308 </span>            :                         const GF_PropertyValue *p;
<span class="lineNum">    1309 </span><span class="lineCov">         11 :                         M2Pid *tspid = gf_list_get(ctx-&gt;pids, i);</span>
<span class="lineNum">    1310 </span><span class="lineCov">         11 :                         pck = gf_filter_pid_get_packet(tspid-&gt;ipid);</span>
<span class="lineNum">    1311 </span><span class="lineCov">         11 :                         if (!pck) return GF_OK;</span>
<span class="lineNum">    1312 </span><span class="lineCov">         11 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENUM);</span>
<span class="lineNum">    1313 </span><span class="lineCov">         11 :                         if (p)</span>
<span class="lineNum">    1314 </span><span class="lineCov">         11 :                                 tspid-&gt;ctx-&gt;dash_seg_num = p-&gt;value.uint;</span>
<span class="lineNum">    1315 </span><span class="lineCov">         11 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENAME);</span>
<span class="lineNum">    1316 </span><span class="lineCov">         11 :                         if (p)</span>
<span class="lineNum">    1317 </span><span class="lineCov">          7 :                                 strcpy(tspid-&gt;ctx-&gt;dash_file_name, p-&gt;value.string);</span>
<span class="lineNum">    1318 </span><span class="lineCov">         11 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_IDXFILENAME);</span>
<span class="lineNum">    1319 </span><span class="lineCov">         11 :                         if (p)</span>
<span class="lineNum">    1320 </span><span class="lineCov">          1 :                                 strcpy(tspid-&gt;ctx-&gt;idx_file_name, p-&gt;value.string);</span>
<span class="lineNum">    1321 </span>            :                 }
<span class="lineNum">    1322 </span><span class="lineCov">          8 :                 ctx-&gt;init_dash = GF_FALSE;</span>
<span class="lineNum">    1323 </span><span class="lineCov">          8 :                 ctx-&gt;next_is_start = GF_TRUE;</span>
<span class="lineNum">    1324 </span><span class="lineCov">          8 :                 ctx-&gt;wait_dash_flush = GF_FALSE;</span>
<span class="lineNum">    1325 </span>            :         }
<span class="lineNum">    1326 </span>            : 
<span class="lineNum">    1327 </span><span class="lineCov">       6138 :         if (ctx-&gt;update_mux) {</span>
<span class="lineNum">    1328 </span><span class="lineCov">       6138 :                 gf_m2ts_mux_update_config(ctx-&gt;mux, GF_FALSE);</span>
<span class="lineNum">    1329 </span>            :         }
<span class="lineNum">    1330 </span>            : 
<span class="lineNum">    1331 </span>            : 
<span class="lineNum">    1332 </span><span class="lineCov">       6138 :         if (ctx-&gt;wait_dash_flush) {</span>
<span class="lineNum">    1333 </span><span class="lineCov">        953 :                 u32 i, done=0, count = gf_list_count(ctx-&gt;pids);</span>
<span class="lineNum">    1334 </span><span class="lineCov">       2756 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1335 </span><span class="lineCov">       1803 :                         M2Pid *tspid = gf_list_get(ctx-&gt;pids, i);</span>
<span class="lineNum">    1336 </span><span class="lineCov">       1803 :                         if (tspid-&gt;has_seen_eods) done++;</span>
<span class="lineNum">    1337 </span>            :                 }
<span class="lineNum">    1338 </span>            : 
<span class="lineNum">    1339 </span><span class="lineCov">        953 :                 if (done==count) {</span>
<span class="lineNum">    1340 </span><span class="lineCov">        145 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1341 </span><span class="lineCov">        145 :                                 M2Pid *tspid = gf_list_get(ctx-&gt;pids, i);</span>
<span class="lineNum">    1342 </span><span class="lineCov">        145 :                                 tspid-&gt;has_seen_eods = 0;</span>
<span class="lineNum">    1343 </span>            :                         }
<span class="lineNum">    1344 </span><span class="lineCov">        124 :                         ctx-&gt;wait_dash_flush = GF_FALSE;</span>
<span class="lineNum">    1345 </span><span class="lineCov">        124 :                         ctx-&gt;next_is_start = ctx-&gt;dash_file_switch;</span>
<span class="lineNum">    1346 </span><span class="lineCov">        124 :                         ctx-&gt;mux-&gt;force_pat = GF_TRUE;</span>
<span class="lineNum">    1347 </span><span class="lineCov">        124 :                         ctx-&gt;dash_file_switch = GF_FALSE;</span>
<span class="lineNum">    1348 </span><span class="lineCov">        124 :                         if (ctx-&gt;nb_pck_in_seg) {</span>
<span class="lineNum">    1349 </span><span class="lineCov">        124 :                                 tsmux_insert_sidx(ctx, GF_TRUE);</span>
<span class="lineNum">    1350 </span><span class="lineCov">        124 :                                 tsmux_send_seg_event(filter, ctx);</span>
<span class="lineNum">    1351 </span>            :                         }
<span class="lineNum">    1352 </span><span class="lineCov">        124 :                         ctx-&gt;dash_seg_num = 0;</span>
<span class="lineNum">    1353 </span>            : 
<span class="lineNum">    1354 </span><span class="lineCov">        124 :                         ctx-&gt;nb_pck_in_seg = 0;</span>
<span class="lineNum">    1355 </span><span class="lineCov">        124 :                         ctx-&gt;pck_start_idx = ctx-&gt;nb_pck;</span>
<span class="lineNum">    1356 </span><span class="lineCov">        124 :                         if (ctx-&gt;next_is_start) ctx-&gt;nb_pck_in_file = 0;</span>
<span class="lineNum">    1357 </span><span class="lineCov">        124 :                         ctx-&gt;nb_pck_first_sidx = ctx-&gt;nb_pck_in_file;</span>
<span class="lineNum">    1358 </span>            :                 }
<span class="lineNum">    1359 </span>            :         }
<span class="lineNum">    1360 </span>            : 
<span class="lineNum">    1361 </span>            :         nb_pck_in_call = 0;
<span class="lineNum">    1362 </span>            :         nb_pck_in_pack=0;
<span class="lineNum">    1363 </span>            :         while (1) {
<span class="lineNum">    1364 </span>            :                 u64 pck_ts;
<span class="lineNum">    1365 </span>            :                 u8 *output;
<span class="lineNum">    1366 </span>            :                 u32 osize;
<span class="lineNum">    1367 </span>            :                 Bool is_pack_flush = GF_FALSE;
<span class="lineNum">    1368 </span>            :                 const char *ts_pck;
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span><span class="lineCov">     131630 :                 ts_pck = gf_m2ts_mux_process(ctx-&gt;mux, &amp;status, &amp;usec_till_next);</span>
<span class="lineNum">    1371 </span><span class="lineCov">     131630 :                 if (ts_pck == NULL) {</span>
<span class="lineNum">    1372 </span><span class="lineCov">       4787 :                         if (!nb_pck_in_pack)</span>
<span class="lineNum">    1373 </span>            :                                 break;
<span class="lineNum">    1374 </span><span class="lineCov">       2506 :                         ts_pck = (const char *) ctx-&gt;pack_buffer;</span>
<span class="lineNum">    1375 </span>            :                         is_pack_flush = GF_TRUE;
<span class="lineNum">    1376 </span>            :                 } else {
<span class="lineNum">    1377 </span>            : 
<span class="lineNum">    1378 </span><span class="lineCov">     126843 :                         tsmux_insert_sidx(ctx, GF_FALSE);</span>
<span class="lineNum">    1379 </span>            : 
<span class="lineNum">    1380 </span><span class="lineCov">     126843 :                         if (ctx-&gt;nb_pack&gt;1) {</span>
<span class="lineNum">    1381 </span><span class="lineCov">     126843 :                                 memcpy(ctx-&gt;pack_buffer + 188 * nb_pck_in_pack, ts_pck, 188);</span>
<span class="lineNum">    1382 </span><span class="lineCov">     126843 :                                 nb_pck_in_pack++;</span>
<span class="lineNum">    1383 </span>            : 
<span class="lineNum">    1384 </span><span class="lineCov">     126843 :                                 if (nb_pck_in_pack &lt; ctx-&gt;nb_pack)</span>
<span class="lineNum">    1385 </span><span class="lineCov">      96356 :                                         continue;</span>
<span class="lineNum">    1386 </span>            : 
<span class="lineNum">    1387 </span><span class="lineCov">      30487 :                                 ts_pck = (const char *) ctx-&gt;pack_buffer;</span>
<span class="lineNum">    1388 </span>            :                         } else {
<span class="lineNum">    1389 </span>            :                                 nb_pck_in_pack = 1;
<span class="lineNum">    1390 </span>            :                         }
<span class="lineNum">    1391 </span>            :                 }
<span class="lineNum">    1392 </span><span class="lineCov">      32993 :                 osize = nb_pck_in_pack * 188;</span>
<span class="lineNum">    1393 </span><span class="lineCov">      32993 :                 pck = gf_filter_pck_new_alloc(ctx-&gt;opid, osize, &amp;output);</span>
<span class="lineNum">    1394 </span><span class="lineCov">      32993 :                 if (!pck) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1395 </span>            :                 
<span class="lineNum">    1396 </span><span class="lineCov">      32993 :                 memcpy(output, ts_pck, osize);</span>
<span class="lineNum">    1397 </span><span class="lineCov">      32993 :                 gf_filter_pck_set_framing(pck, ctx-&gt;nb_pck ? ctx-&gt;next_is_start : GF_TRUE, (status==GF_M2TS_STATE_EOS) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    1398 </span>            : 
<span class="lineNum">    1399 </span><span class="lineCov">      32993 :                 if (ctx-&gt;next_is_start &amp;&amp; ctx-&gt;dash_mode) {</span>
<span class="lineNum">    1400 </span><span class="lineCov">        125 :                         GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[M2TSMux] starting TS segment %d\r&quot;, ctx-&gt;dash_seg_num));</span>
<span class="lineNum">    1401 </span><span class="lineCov">        125 :                         gf_filter_pck_set_property(pck, GF_PROP_PCK_FILENUM, &amp;PROP_UINT(ctx-&gt;dash_seg_num) );</span>
<span class="lineNum">    1402 </span><span class="lineCov">        125 :                         if (ctx-&gt;dash_file_name[0])</span>
<span class="lineNum">    1403 </span><span class="lineCov">        124 :                                 gf_filter_pck_set_property(pck, GF_PROP_PCK_FILENAME, &amp;PROP_STRING(ctx-&gt;dash_file_name) ) ;</span>
<span class="lineNum">    1404 </span>            : 
<span class="lineNum">    1405 </span><span class="lineCov">        125 :                         ctx-&gt;dash_file_name[0] = 0;</span>
<span class="lineNum">    1406 </span><span class="lineCov">        125 :                         ctx-&gt;next_is_start = GF_FALSE;</span>
<span class="lineNum">    1407 </span>            :                 }
<span class="lineNum">    1408 </span>            : 
<span class="lineNum">    1409 </span><span class="lineCov">      32993 :                 pck_ts = gf_m2ts_get_ts_clock_90k(ctx-&gt;mux);</span>
<span class="lineNum">    1410 </span><span class="lineCov">      32993 :                 gf_filter_pck_set_dts(pck, pck_ts);</span>
<span class="lineNum">    1411 </span><span class="lineCov">      32993 :                 gf_filter_pck_set_cts(pck, pck_ts);</span>
<span class="lineNum">    1412 </span>            : 
<span class="lineNum">    1413 </span><span class="lineCov">      32993 :                 if (ctx-&gt;notify_filename) {</span>
<span class="lineNum">    1414 </span><span class="lineCov">          2 :                         gf_filter_pck_set_framing(pck, GF_TRUE, (status==GF_M2TS_STATE_EOS) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    1415 </span><span class="lineCov">          2 :                         gf_filter_pck_set_property(pck, GF_PROP_PCK_FILENUM, &amp;PROP_UINT(ctx-&gt;cur_file_idx_plus_one-1));</span>
<span class="lineNum">    1416 </span><span class="lineCov">          2 :                         if (ctx-&gt;cur_file_suffix) {</span>
<span class="lineNum">    1417 </span><span class="lineCov">          2 :                                 gf_filter_pck_set_property(pck, GF_PROP_PCK_FILESUF, &amp;PROP_STRING_NO_COPY(ctx-&gt;cur_file_suffix));</span>
<span class="lineNum">    1418 </span><span class="lineCov">          2 :                                 ctx-&gt;cur_file_suffix = NULL;</span>
<span class="lineNum">    1419 </span>            :                         }
<span class="lineNum">    1420 </span><span class="lineCov">          2 :                         ctx-&gt;notify_filename = GF_FALSE;</span>
<span class="lineNum">    1421 </span>            :                 }
<span class="lineNum">    1422 </span><span class="lineCov">      32993 :                 gf_filter_pck_send(pck);</span>
<span class="lineNum">    1423 </span><span class="lineCov">      32993 :                 ctx-&gt;nb_pck += nb_pck_in_pack;</span>
<span class="lineNum">    1424 </span><span class="lineCov">      32993 :                 ctx-&gt;nb_pck_in_seg += nb_pck_in_pack;</span>
<span class="lineNum">    1425 </span><span class="lineCov">      32993 :                 ctx-&gt;nb_pck_in_file += nb_pck_in_pack;</span>
<span class="lineNum">    1426 </span><span class="lineCov">      32993 :                 nb_pck_in_call += nb_pck_in_pack;</span>
<span class="lineNum">    1427 </span>            :                 nb_pck_in_pack = 0;
<span class="lineNum">    1428 </span>            : 
<span class="lineNum">    1429 </span><span class="lineCov">      32993 :                 if (is_pack_flush)</span>
<span class="lineNum">    1430 </span>            :                         break;
<span class="lineNum">    1431 </span>            : 
<span class="lineNum">    1432 </span><span class="lineCov">      30487 :                 if (status&gt;=GF_M2TS_STATE_PADDING) {</span>
<span class="lineNum">    1433 </span>            :                         break;
<span class="lineNum">    1434 </span>            :                 }
<span class="lineNum">    1435 </span><span class="lineCov">      29591 :                 if (nb_pck_in_call&gt;100)</span>
<span class="lineNum">    1436 </span>            :                         break;
<span class="lineNum">    1437 </span>            :         }
<span class="lineNum">    1438 </span>            : 
<span class="lineNum">    1439 </span><span class="lineCov">       6138 :         if (gf_filter_reporting_enabled(filter)) {</span>
<span class="lineNum">    1440 </span>            :                 char szStatus[1024];
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :                 if (status==GF_M2TS_STATE_EOS) {</span>
<span class="lineNum">    1442 </span>            :                         Double ohead = 0;
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :                         u64 total_bytes_out = ctx-&gt;nb_pck;</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :                         total_bytes_out *= 188;</span>
<span class="lineNum">    1445 </span>            : 
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;total_bytes_in) ohead =  ((Double) (total_bytes_out - ctx-&gt;total_bytes_in)*100 / ctx-&gt;total_bytes_in);</span>
<span class="lineNum">    1447 </span>            : 
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :                         sprintf(szStatus, &quot;done - TS clock % 6d ms bitrate %d kbps - bytes &quot;LLD&quot; in &quot;LLD&quot; out overhead %02.02f%%&quot;, gf_m2ts_get_ts_clock(ctx-&gt;mux), ctx-&gt;mux-&gt;bit_rate/1000, ctx-&gt;total_bytes_in, total_bytes_out, ohead);</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :                         gf_filter_update_status(filter, 10000, szStatus);</span>
<span class="lineNum">    1450 </span>            :                 } else {
<span class="lineNum">    1451 </span>            : 
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :                         sprintf(szStatus, &quot;sysclock % 6d ms TS clock % 6d ms bitrate % 8d kbps&quot;, gf_m2ts_get_sys_clock(ctx-&gt;mux), gf_m2ts_get_ts_clock(ctx-&gt;mux), ctx-&gt;mux-&gt;bit_rate/1000);</span>
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :                         gf_filter_update_status(filter, -1, szStatus);</span>
<span class="lineNum">    1454 </span>            :                 }
<span class="lineNum">    1455 </span>            :         }
<span class="lineNum">    1456 </span>            : 
<span class="lineNum">    1457 </span><span class="lineCov">       6138 :         if (ctx-&gt;nb_suspended &amp;&amp; (ctx-&gt;nb_suspended==gf_list_count(ctx-&gt;pids)) ) {</span>
<span class="lineNum">    1458 </span><span class="lineCov">          1 :                 u32 i, count = gf_list_count(ctx-&gt;pids);</span>
<span class="lineNum">    1459 </span><span class="lineCov">          2 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1460 </span><span class="lineCov">          1 :                         M2Pid *tspid = gf_list_get(ctx-&gt;pids, i);</span>
<span class="lineNum">    1461 </span><span class="lineCov">          1 :                         tspid-&gt;esi.caps &amp;= ~GF_ESI_STREAM_IS_OVER;</span>
<span class="lineNum">    1462 </span><span class="lineCov">          1 :                         tspid-&gt;suspended = GF_FALSE;</span>
<span class="lineNum">    1463 </span>            :                 }
<span class="lineNum">    1464 </span><span class="lineCov">          1 :                 ctx-&gt;nb_suspended = 0;</span>
<span class="lineNum">    1465 </span><span class="lineCov">          1 :                 ctx-&gt;mux-&gt;force_pat = GF_TRUE;</span>
<span class="lineNum">    1466 </span><span class="lineCov">          1 :                 ctx-&gt;notify_filename = GF_TRUE;</span>
<span class="lineNum">    1467 </span><span class="lineCov">          1 :                 status = GF_M2TS_STATE_IDLE;</span>
<span class="lineNum">    1468 </span>            :         }
<span class="lineNum">    1469 </span>            : 
<span class="lineNum">    1470 </span><span class="lineCov">       6138 :         if (status==GF_M2TS_STATE_EOS) {</span>
<span class="lineNum">    1471 </span><span class="lineCov">       1209 :                 gf_filter_pid_set_eos(ctx-&gt;opid);</span>
<span class="lineNum">    1472 </span><span class="lineCov">       1209 :                 if (ctx-&gt;nb_pck_in_seg) {</span>
<span class="lineNum">    1473 </span><span class="lineCov">         37 :                         tsmux_insert_sidx(ctx, GF_TRUE);</span>
<span class="lineNum">    1474 </span><span class="lineCov">         37 :                         tsmux_send_seg_event(filter, ctx);</span>
<span class="lineNum">    1475 </span><span class="lineCov">         37 :                         ctx-&gt;nb_pck_in_seg = 0;</span>
<span class="lineNum">    1476 </span>            :                 }
<span class="lineNum">    1477 </span>            :                 return GF_EOS;
<span class="lineNum">    1478 </span>            :         }
<span class="lineNum">    1479 </span>            : 
<span class="lineNum">    1480 </span><span class="lineCov">       4929 :         if (ctx-&gt;realtime) {</span>
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :                 u32 now = gf_sys_clock();</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :                 if (!ctx-&gt;last_log_time)</span>
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 :                         ctx-&gt;last_log_time = now;</span>
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :                 else if (now &gt; ctx-&gt;last_log_time + ctx-&gt;log_freq) {</span>
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :                         ctx-&gt;last_log_time = now;</span>
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[M2TSMux] time % 6d TS time % 6d bitrate % 8d\r&quot;, gf_m2ts_get_sys_clock(ctx-&gt;mux), gf_m2ts_get_ts_clock(ctx-&gt;mux), ctx-&gt;mux-&gt;average_birate_kbps));</span>
<span class="lineNum">    1487 </span>            :                 }
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :                 if (status == GF_M2TS_STATE_IDLE) {</span>
<span class="lineNum">    1489 </span>            : #if 0
<span class="lineNum">    1490 </span>            :                         u64 sleep_for=0;
<span class="lineNum">    1491 </span>            :                         /*wait till next packet is ready to be sent*/
<span class="lineNum">    1492 </span>            :                         if (usec_till_next&gt;1000) {
<span class="lineNum">    1493 </span>            :                                 sleep_for = usec_till_next;
<span class="lineNum">    1494 </span>            :                         }
<span class="lineNum">    1495 </span>            :                         if (sleep_for)
<span class="lineNum">    1496 </span>            :                                 gf_filter_ask_rt_reschedule(filter, (u32) sleep_for);
<span class="lineNum">    1497 </span>            : #else
<span class="lineNum">    1498 </span>            :                         //we don't have enough precision on usec counting and we end up eating one core on most machines,
<span class="lineNum">    1499 </span>            :                         // so let's just sleep one ms whenever we are idle - it's maybe too much but the muxer will catchup afterwards
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :                         gf_filter_ask_rt_reschedule(filter, 1000);</span>
<span class="lineNum">    1501 </span>            : #endif
<span class="lineNum">    1502 </span>            :                 }
<span class="lineNum">    1503 </span>            :         }
<span class="lineNum">    1504 </span>            :         //PMT update management is still under progress...
<span class="lineNum">    1505 </span><span class="lineCov">       4929 :         ctx-&gt;pmt_update_pending = 0;</span>
<span class="lineNum">    1506 </span>            : 
<span class="lineNum">    1507 </span><span class="lineCov">       4929 :         return GF_OK;</span>
<a name="1508"><span class="lineNum">    1508 </span>            : }</a>
<span class="lineNum">    1509 </span>            : 
<span class="lineNum">    1510 </span><span class="lineCov">         37 : static GF_Err tsmux_initialize(GF_Filter *filter)</span>
<span class="lineNum">    1511 </span>            : {
<span class="lineNum">    1512 </span><span class="lineCov">         37 :         GF_TSMuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    1513 </span><span class="lineCov">         37 :         gf_filter_set_max_extra_input_pids(filter, -1);</span>
<span class="lineNum">    1514 </span>            : 
<span class="lineNum">    1515 </span><span class="lineCov">         37 :         ctx-&gt;mux = gf_m2ts_mux_new(ctx-&gt;rate, ctx-&gt;pat_rate, ctx-&gt;realtime);</span>
<span class="lineNum">    1516 </span><span class="lineCov">         37 :         ctx-&gt;mux-&gt;flush_pes_at_rap = ctx-&gt;flush_rap;</span>
<span class="lineNum">    1517 </span>            : 
<span class="lineNum">    1518 </span><span class="lineCov">         37 :         if (gf_sys_is_test_mode() &amp;&amp; ctx-&gt;pcr_init&lt;0)</span>
<span class="lineNum">    1519 </span><span class="lineCov">          8 :                 ctx-&gt;pcr_init = 1000000;</span>
<span class="lineNum">    1520 </span>            : 
<span class="lineNum">    1521 </span><span class="lineCov">         37 :         gf_m2ts_mux_use_single_au_pes_mode(ctx-&gt;mux, ctx-&gt;pes_pack);</span>
<span class="lineNum">    1522 </span><span class="lineCov">         37 :         if (ctx-&gt;pcr_init&gt;=0) gf_m2ts_mux_set_initial_pcr(ctx-&gt;mux, (u64) ctx-&gt;pcr_init);</span>
<span class="lineNum">    1523 </span><span class="lineCov">         37 :         gf_m2ts_mux_set_pcr_max_interval(ctx-&gt;mux, ctx-&gt;max_pcr);</span>
<span class="lineNum">    1524 </span><span class="lineCov">         37 :         gf_m2ts_mux_enable_pcr_only_packets(ctx-&gt;mux, ctx-&gt;pcr_only);</span>
<span class="lineNum">    1525 </span>            : 
<span class="lineNum">    1526 </span><span class="lineCov">         37 :         if (!ctx-&gt;sid) ctx-&gt;sid = 1;</span>
<span class="lineNum">    1527 </span><span class="lineCov">         37 :         if (ctx-&gt;sdt_rate) {</span>
<span class="lineNum">    1528 </span><span class="lineCov">          1 :                 gf_m2ts_mux_enable_sdt(ctx-&gt;mux, ctx-&gt;sdt_rate);</span>
<span class="lineNum">    1529 </span>            :         }
<span class="lineNum">    1530 </span>            : 
<span class="lineNum">    1531 </span><span class="lineCov">         37 :         if (!gf_filter_block_enabled(filter)) {</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :                 ctx-&gt;breq = 0;</span>
<span class="lineNum">    1533 </span>            :         } else {
<span class="lineNum">    1534 </span><span class="lineCov">         37 :                 ctx-&gt;init_buffering = GF_TRUE;</span>
<span class="lineNum">    1535 </span>            :         }
<span class="lineNum">    1536 </span><span class="lineCov">         37 :         ctx-&gt;pids = gf_list_new();</span>
<span class="lineNum">    1537 </span><span class="lineCov">         37 :         if (ctx-&gt;nb_pack&gt;1) ctx-&gt;pack_buffer = gf_malloc(sizeof(char)*188*ctx-&gt;nb_pack);</span>
<span class="lineNum">    1538 </span>            : 
<span class="lineNum">    1539 </span>            : #ifdef GPAC_ENABLE_COVERAGE
<span class="lineNum">    1540 </span><span class="lineCov">         37 :         if (gf_sys_is_cov_mode()) {</span>
<span class="lineNum">    1541 </span><span class="lineCov">         37 :                 gf_m2ts_get_sys_clock(ctx-&gt;mux);</span>
<span class="lineNum">    1542 </span>            :         }
<span class="lineNum">    1543 </span>            : #endif
<span class="lineNum">    1544 </span><span class="lineCov">         37 :         return GF_OK;</span>
<span class="lineNum">    1545 </span>            : }
<a name="1546"><span class="lineNum">    1546 </span>            : </a>
<span class="lineNum">    1547 </span>            : 
<span class="lineNum">    1548 </span><span class="lineCov">         37 : static void tsmux_finalize(GF_Filter *filter)</span>
<span class="lineNum">    1549 </span>            : {
<span class="lineNum">    1550 </span><span class="lineCov">         37 :         GF_TSMuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    1551 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">    1552 </span><span class="lineCov">         37 :         u64 bits = ctx-&gt;mux-&gt;tot_pck_sent*8*188;</span>
<span class="lineNum">    1553 </span>            : #endif
<span class="lineNum">    1554 </span><span class="lineCov">         37 :         u64 dur_ms = gf_m2ts_get_ts_clock(ctx-&gt;mux);</span>
<span class="lineNum">    1555 </span><span class="lineCov">         37 :         if (!dur_ms) dur_ms = 1;</span>
<span class="lineNum">    1556 </span><span class="lineCov">         37 :         GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[M2TSMux] Done muxing - %.02f sec - %sbitrate %d kbps &quot;LLD&quot; packets written\nPadding: &quot;LLD&quot; packets (%g kbps) - &quot;LLD&quot; PES padded bytes (%g kbps)\n&quot;,</span>
<span class="lineNum">    1557 </span>            :                 ((Double) dur_ms)/1000.0, ctx-&gt;rate ? &quot;&quot; : &quot;average &quot;, (u32) (bits/dur_ms), ctx-&gt;mux-&gt;tot_pck_sent,
<span class="lineNum">    1558 </span>            :                  ctx-&gt;mux-&gt;tot_pad_sent, (Double) (ctx-&gt;mux-&gt;tot_pad_sent*188*8.0/dur_ms) , ctx-&gt;mux-&gt;tot_pes_pad_bytes, (Double) (ctx-&gt;mux-&gt;tot_pes_pad_bytes*8.0/dur_ms)
<span class="lineNum">    1559 </span>            :         ));
<span class="lineNum">    1560 </span>            : 
<span class="lineNum">    1561 </span><span class="lineCov">         86 :         while (gf_list_count(ctx-&gt;pids)) {</span>
<span class="lineNum">    1562 </span><span class="lineCov">         49 :                 M2Pid *tspid = gf_list_pop_back(ctx-&gt;pids);</span>
<span class="lineNum">    1563 </span><span class="lineCov">         49 :                 tsmux_del_stream(tspid);</span>
<span class="lineNum">    1564 </span>            :         }
<span class="lineNum">    1565 </span><span class="lineCov">         37 :         gf_list_del(ctx-&gt;pids);</span>
<span class="lineNum">    1566 </span><span class="lineCov">         37 :         gf_m2ts_mux_del(ctx-&gt;mux);</span>
<span class="lineNum">    1567 </span><span class="lineCov">         37 :         if (ctx-&gt;pack_buffer) gf_free(ctx-&gt;pack_buffer);</span>
<span class="lineNum">    1568 </span><span class="lineCov">         37 :         if (ctx-&gt;sidx_entries) gf_free(ctx-&gt;sidx_entries);</span>
<span class="lineNum">    1569 </span><span class="lineCov">         37 :         if (ctx-&gt;idx_bs) gf_bs_del(ctx-&gt;idx_bs);</span>
<span class="lineNum">    1570 </span><span class="lineCov">         37 :         if (ctx-&gt;cur_file_suffix) gf_free(ctx-&gt;cur_file_suffix);</span>
<a name="1571"><span class="lineNum">    1571 </span><span class="lineCov">         37 : }</span></a>
<span class="lineNum">    1572 </span>            : 
<span class="lineNum">    1573 </span><span class="lineCov">      29204 : static Bool tsmux_process_event(GF_Filter *filter, const GF_FilterEvent *evt)</span>
<span class="lineNum">    1574 </span>            : {
<span class="lineNum">    1575 </span><span class="lineCov">      29204 :         if ((evt-&gt;base.type==GF_FEVT_STOP) || (evt-&gt;base.type==GF_FEVT_PLAY) ) {</span>
<span class="lineNum">    1576 </span>            :                 u32 i;
<span class="lineNum">    1577 </span><span class="lineCov">         38 :                 GF_TSMuxCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    1578 </span><span class="lineCov">         89 :                 for (i=0; i&lt;gf_list_count(ctx-&gt;pids); i++) {</span>
<span class="lineNum">    1579 </span><span class="lineCov">         51 :                         M2Pid *tspid = gf_list_get(ctx-&gt;pids, i);</span>
<span class="lineNum">    1580 </span><span class="lineCov">         51 :                         if (evt-&gt;base.type==GF_FEVT_STOP)</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :                                 tspid-&gt;esi.caps |= GF_ESI_STREAM_IS_OVER;</span>
<span class="lineNum">    1582 </span>            :                         else
<span class="lineNum">    1583 </span><span class="lineCov">         51 :                                 tspid-&gt;esi.caps &amp;= ~GF_ESI_STREAM_IS_OVER;</span>
<span class="lineNum">    1584 </span>            :                 }
<span class="lineNum">    1585 </span>            :         }
<span class="lineNum">    1586 </span><span class="lineCov">      29204 :         return GF_FALSE;</span>
<span class="lineNum">    1587 </span>            : }
<span class="lineNum">    1588 </span>            : 
<span class="lineNum">    1589 </span>            : static const GF_FilterCapability TSMuxCaps[] =
<span class="lineNum">    1590 </span>            : {
<span class="lineNum">    1591 </span>            :         //first set of caps describe streams that need reframing (NALU, mp4v, mpegh audio)
<span class="lineNum">    1592 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_STREAM_TYPE, GF_STREAM_VISUAL),
<span class="lineNum">    1593 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_STREAM_TYPE, GF_STREAM_AUDIO),
<span class="lineNum">    1594 </span>            :         //unframed streams only
<span class="lineNum">    1595 </span>            :         CAP_BOOL(GF_CAPS_INPUT, GF_PROP_PID_UNFRAMED, GF_TRUE),
<span class="lineNum">    1596 </span>            :         //for NAL-based, we want annexB format
<span class="lineNum">    1597 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_CODECID, GF_CODECID_AVC),
<span class="lineNum">    1598 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_CODECID, GF_CODECID_MVC),
<span class="lineNum">    1599 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_CODECID, GF_CODECID_SVC),
<span class="lineNum">    1600 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_CODECID, GF_CODECID_HEVC),
<span class="lineNum">    1601 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_CODECID, GF_CODECID_LHVC),
<span class="lineNum">    1602 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_CODECID, GF_CODECID_VVC),
<span class="lineNum">    1603 </span>            :         //for m4vp2 we want DSI reinsertion
<span class="lineNum">    1604 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_CODECID, GF_CODECID_MPEG4_PART2),
<span class="lineNum">    1605 </span>            :         //for AAC we use the AAC-&gt;ADTS or AAC-&gt;LATM of the mux, so don't insert here
<span class="lineNum">    1606 </span>            : 
<span class="lineNum">    1607 </span>            :         //for MPEG-H audio MHAS we need to insert sync packets
<span class="lineNum">    1608 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_CODECID, GF_CODECID_MHAS),
<span class="lineNum">    1609 </span>            : 
<span class="lineNum">    1610 </span>            :         //static output cap file extension
<span class="lineNum">    1611 </span>            :         CAP_UINT(GF_CAPS_OUTPUT_STATIC,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    1612 </span>            :         CAP_STRING(GF_CAPS_OUTPUT_STATIC, GF_PROP_PID_FILE_EXT, M2TS_FILE_EXTS),
<span class="lineNum">    1613 </span>            :         CAP_STRING(GF_CAPS_OUTPUT_STATIC, GF_PROP_PID_MIME, M2TS_MIMES),
<span class="lineNum">    1614 </span>            :         {0},
<span class="lineNum">    1615 </span>            : 
<span class="lineNum">    1616 </span>            :         //for now don't accept files as input, although we could store them as items, to refine
<span class="lineNum">    1617 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    1618 </span>            :         //these caps are framed
<span class="lineNum">    1619 </span>            :         CAP_BOOL(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_UNFRAMED, GF_TRUE),
<span class="lineNum">    1620 </span>            :         //exclude caps from above
<span class="lineNum">    1621 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_AVC),
<span class="lineNum">    1622 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_MVC),
<span class="lineNum">    1623 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_SVC),
<span class="lineNum">    1624 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_HEVC),
<span class="lineNum">    1625 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_LHVC),
<span class="lineNum">    1626 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_VVC),
<span class="lineNum">    1627 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_MPEG4_PART2),
<span class="lineNum">    1628 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_MHAS),
<span class="lineNum">    1629 </span>            :         //we don't accept MPEG-H audio without MHAS
<span class="lineNum">    1630 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_MPHA),
<span class="lineNum">    1631 </span>            :         //no RAW support for now$
<span class="lineNum">    1632 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_RAW),
<span class="lineNum">    1633 </span>            : };
<span class="lineNum">    1634 </span>            : 
<span class="lineNum">    1635 </span>            : 
<span class="lineNum">    1636 </span>            : #define OFFS(_n)        #_n, offsetof(GF_TSMuxCtx, _n)
<span class="lineNum">    1637 </span>            : static const GF_FilterArgs TSMuxArgs[] =
<span class="lineNum">    1638 </span>            : {
<span class="lineNum">    1639 </span>            :         { OFFS(breq), &quot;buffer requirements in ms for input pids&quot;, GF_PROP_UINT, &quot;100&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1640 </span>            :         { OFFS(pmt_id), &quot;define the ID of the first PMT to use in the mux&quot;, GF_PROP_UINT, &quot;100&quot;, NULL, 0},
<span class="lineNum">    1641 </span>            :         { OFFS(rate), &quot;target rate in bps of the multiplex. If not set, variable rate is used&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, 0},
<span class="lineNum">    1642 </span>            :         { OFFS(pmt_rate), &quot;interval between PMT in ms&quot;, GF_PROP_UINT, &quot;200&quot;, NULL, 0},
<span class="lineNum">    1643 </span>            :         { OFFS(pat_rate), &quot;interval between PAT in ms&quot;, GF_PROP_UINT, &quot;200&quot;, NULL, 0},
<span class="lineNum">    1644 </span>            :         { OFFS(first_pts), &quot;force PTS value of first packet, in 90kHz&quot;, GF_PROP_LUINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1645 </span>            :         { OFFS(pcr_offset), &quot;offset all timestamps from PCR by V, in 90kHz. Default value is computed based on input media&quot;, GF_PROP_LUINT, &quot;-1&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1646 </span>            :         { OFFS(mpeg4), &quot;force usage of MPEG-4 signaling (IOD and SL Config)\n&quot;\
<span class="lineNum">    1647 </span>            :                                 &quot;- none: disables 4on2\n&quot;\
<span class="lineNum">    1648 </span>            :                                 &quot;- full: sends AUs as SL packets over section for OD, section/pes for scene (cf bifs_pes)\n&quot;\
<span class="lineNum">    1649 </span>            :                                 &quot;- scene: sends only scene streams as 4on2 but uses regular PES without SL for audio and video&quot;\
<span class="lineNum">    1650 </span>            :                                 , GF_PROP_UINT, &quot;none&quot;, &quot;none|full|scene&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    1651 </span>            :         { OFFS(pmt_version), &quot;set version number of the PMT&quot;, GF_PROP_UINT, &quot;200&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1652 </span>            :         { OFFS(disc), &quot;set the discontinuity marker for the first packet of each stream&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1653 </span>            :         { OFFS(repeat_rate), &quot;interval in ms between two carousel send for MPEG-4 systems. Is overridden by carousel duration PID property if defined&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    1654 </span>            :         { OFFS(repeat_img), &quot;interval in ms between re-sending (as PES) of single-image streams. If 0, image data is sent once only&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1655 </span>            :         { OFFS(max_pcr), &quot;set max interval in ms between 2 PCR&quot;, GF_PROP_UINT, &quot;100&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1656 </span>            :         { OFFS(nb_pack), &quot;pack N TS packets in output packets&quot;, GF_PROP_UINT, &quot;4&quot;, NULL, 0},
<span class="lineNum">    1657 </span>            :         { OFFS(pes_pack), &quot;set AU to PES packing mode\n&quot;\
<span class="lineNum">    1658 </span>            :                 &quot;- audio: will pack only multiple audio AUs in a PES\n&quot;\
<span class="lineNum">    1659 </span>            :                 &quot;- none: make exactly one AU per PES\n&quot;\
<span class="lineNum">    1660 </span>            :                 &quot;- all: will pack multiple AUs per PES for all streams&quot;, GF_PROP_UINT, &quot;audio&quot;, &quot;audio|none|all&quot;, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1661 </span>            :         { OFFS(realtime), &quot;use real-time output&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, 0},
<span class="lineNum">    1662 </span>            :         { OFFS(bifs_pes), &quot;select BIFS streams packetization (PES vs sections)\n&quot;
<span class="lineNum">    1663 </span>            :         &quot;- on: uses BIFS PES\n&quot;
<span class="lineNum">    1664 </span>            :         &quot;- off: uses BIFS sections\n&quot;
<span class="lineNum">    1665 </span>            :         &quot;- copy: uses BIFS PES but removes timestamps in BIFS SL and only carries PES timestamps&quot;, GF_PROP_UINT, &quot;off&quot;, &quot;off|on|copy&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    1666 </span>            :         { OFFS(flush_rap), &quot;force flushing mux program when RAP is found on video, and injects PAT and PMT before the next video PES begin&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1667 </span>            :         { OFFS(pcr_only), &quot;enable PCR-only TS packets&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    1668 </span>            :         { OFFS(pcr_init), &quot;set initial PCR value for the programs. Negative value implies random value is picked&quot;, GF_PROP_LSINT, &quot;-1&quot;, NULL, 0},
<span class="lineNum">    1669 </span>            :         { OFFS(sid), &quot;set service ID for the program - see filter help&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, 0},
<span class="lineNum">    1670 </span>            :         { OFFS(name), &quot;set service name for the program - see filter help&quot;, GF_PROP_STRING, NULL, NULL, 0},
<span class="lineNum">    1671 </span>            :         { OFFS(provider), &quot;set service provider name for the program - see filter help&quot;, GF_PROP_STRING, NULL, NULL, 0},
<span class="lineNum">    1672 </span>            :         { OFFS(sdt_rate), &quot;interval in ms between two DVB SDT tables. If 0, SDT is disabled&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, 0},
<span class="lineNum">    1673 </span>            : 
<span class="lineNum">    1674 </span>            :         { OFFS(temi), &quot;insert TEMI time codes in adaptation field - see filter help&quot;, GF_PROP_STRING, NULL, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1675 </span>            :         { OFFS(log_freq), &quot;delay between logs for realtime mux&quot;, GF_PROP_UINT, &quot;500&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1676 </span>            :         { OFFS(latm), &quot;use LATM AAC encapsulation instead of regular ADTS&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1677 </span>            :         { OFFS(subs_sidx), &quot;number of subsegments per sidx. negative value disables sidx&quot;, GF_PROP_SINT, &quot;-1&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    1678 </span>            :         {0}
<span class="lineNum">    1679 </span>            : };
<span class="lineNum">    1680 </span>            : 
<span class="lineNum">    1681 </span>            : 
<span class="lineNum">    1682 </span>            : GF_FilterRegister TSMuxRegister = {
<span class="lineNum">    1683 </span>            :         .name = &quot;m2tsmx&quot;,
<span class="lineNum">    1684 </span>            :         GF_FS_SET_DESCRIPTION(&quot;MPEG-2 TS muxer&quot;)
<span class="lineNum">    1685 </span>            :         GF_FS_SET_HELP(&quot;GPAC TS multiplexer selects M2TS PID for media streams using the PID of the PMT plus the stream index.\n&quot;
<span class="lineNum">    1686 </span>            :                 &quot;For example, default config creates the first program with a PMT PID 100, the first stream will have a PID of 101.\n&quot;
<span class="lineNum">    1687 </span>            :                 &quot;Streams are grouped in programs based on input PID property ServiceID if present. If absent, stream will go in the program with service ID as indicated by [-sid]() option.\n&quot;
<span class="lineNum">    1688 </span>            :                 &quot;- [-name]() option is overridden by input PID property `ServiceName`.\n&quot;
<span class="lineNum">    1689 </span>            :                 &quot;- [-provider]() option is overridden by input PID property `ServiceProvider`.\n&quot;
<span class="lineNum">    1690 </span>            :                 &quot;- [-pcr_offset]() option is overridden by input PID property `\&quot;tsmux:pcr_offset\&quot;`\n&quot;
<span class="lineNum">    1691 </span>            :                 &quot;- [-first_pts]() option is overridden by input PID property `\&quot;tsmux:force_pts\&quot;`\n&quot;
<span class="lineNum">    1692 </span>            :                 &quot;- [-temi]() option is overridden by input PID property `\&quot;tsmux:temi\&quot;`\n&quot;
<span class="lineNum">    1693 </span>            : 
<span class="lineNum">    1694 </span>            :                 &quot;\n&quot;
<span class="lineNum">    1695 </span>            :                 &quot;# Time and External Media Information (TEMI)\n&quot;
<span class="lineNum">    1696 </span>            :                 &quot;The [-temi]() option allows specifying a list of URLs or timeline IDs to insert in streams of a program.\n&quot;
<span class="lineNum">    1697 </span>            :                 &quot;One or more TEMI timeline can be specified per PID.\n&quot;
<span class="lineNum">    1698 </span>            :                 &quot;The syntax is a comma-separated list of one or more TEMI description.\n&quot;
<span class="lineNum">    1699 </span>            :                 &quot;Each TEMI description is formatted as ID_OR_URL or #OPT1[#OPT2]#ID_OR_URL. Options are:\n&quot;
<span class="lineNum">    1700 </span>            :                 &quot;- S`N`: gives number N indicating the target serviceID\n&quot;
<span class="lineNum">    1701 </span>            :                 &quot;- T`N`: set timescale to use (default: PID timescale)\n&quot;
<span class="lineNum">    1702 </span>            :                 &quot;- D`N`: set delay in ms between two TEMI url descriptors (default 1000)\n&quot;
<span class="lineNum">    1703 </span>            :                 &quot;- O`N`: set offset (max 64 bits) to add to TEMI timecodes (default 0). If timescale is not specified, offset value is in ms, otherwise in timescale units.\n&quot;
<span class="lineNum">    1704 </span>            :                 &quot;- I`N`: set initial value (max 64 bits) of TEMI timecodes. If not set, initial value will match first packet CTS. If timescale is not specified, value is in PID timescale units, otherwise in specified timescale units.\n&quot;
<span class="lineNum">    1705 </span>            :                 &quot;- P`N`: indicate target PID in program. Possible values are\n&quot;
<span class="lineNum">    1706 </span>            :                 &quot;  - `V`: only insert for video streams.\n&quot;
<span class="lineNum">    1707 </span>            :                 &quot;  - `A`: only insert for audio streams.\n&quot;
<span class="lineNum">    1708 </span>            :                 &quot;  - `T`: only insert for text streams.\n&quot;
<span class="lineNum">    1709 </span>            :                 &quot;  - N: only insert for stream with index N (0-based) in the program.\n&quot;
<span class="lineNum">    1710 </span>            :                 &quot;- L`N`: set 64bit timecode signaling. Possible values are:\n&quot;
<span class="lineNum">    1711 </span>            :                 &quot;  - `A`: automatic switch between 32 and 64 bit depending on timecode value (default if not specified).\n&quot;
<span class="lineNum">    1712 </span>            :                 &quot;  - `Y`: use 64 bit signaling only.\n&quot;
<span class="lineNum">    1713 </span>            :                 &quot;  - `N`: use 32 bit signaling only and wrap around timecode value.\n&quot;
<span class="lineNum">    1714 </span>            :                 &quot;- N: insert NTP timestamp in TEMI timeline descriptor\n&quot;
<span class="lineNum">    1715 </span>            :                 &quot;- ID_OR_URL: If number, indicates the TEMI ID to use for external timeline. Otherwise, gives the URL to insert\n&quot;
<span class="lineNum">    1716 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    1717 </span>            :                 &quot;EX temi=\&quot;url\&quot;\n&quot;
<span class="lineNum">    1718 </span>            :                 &quot;Inserts a TEMI URL+timecode in the each stream of each program.\n&quot;
<span class="lineNum">    1719 </span>            :                 &quot;EX temi=\&quot;#P0#url,#P1#4\&quot;\n&quot;
<span class="lineNum">    1720 </span>            :                 &quot;Inserts a TEMI URL+timecode in the first stream of all programs and an external TEMI with ID 4 in the second stream of all programs.\n&quot;
<span class="lineNum">    1721 </span>            :                 &quot;EX temi=\&quot;#P0#2,#P0#url,#P1#4\&quot;\n&quot;
<span class="lineNum">    1722 </span>            :                 &quot;Inserts a TEMI with ID 2 and a TEMI URL+timecode in the first stream of all programs, and an external TEMI with ID 4 in the second stream of all programs.\n&quot;
<span class="lineNum">    1723 </span>            :                 &quot;EX temi=\&quot;#S20#4,#S10#URL\&quot;\n&quot;
<span class="lineNum">    1724 </span>            :                 &quot;Inserts an external TEMI with ID 4 in the each stream of program with ServiceID 20 and a TEMI URL in each stream of program with ServiceID 10.\n&quot;
<span class="lineNum">    1725 </span>            :                 &quot;EX temi=\&quot;#N#D500#PV#T30000#4\&quot;\n&quot;
<span class="lineNum">    1726 </span>            :                 &quot;Inserts an external TEMI with ID 4 and timescale 30000, NTP injection and carousel of 500 ms in the video stream of all programs.\n&quot;
<span class="lineNum">    1727 </span>            :                 &quot;\n&quot;
<span class="lineNum">    1728 </span>            :                 &quot;Warning: multipliers (k,m,g) are not supported in TEMI options.\n&quot;
<span class="lineNum">    1729 </span>            :                 &quot;# Notes\n&quot;
<span class="lineNum">    1730 </span>            :                 &quot;In DASH mode, the PCR is always initialized at 0, and [-flush_rap]() is automatically set.\n&quot;
<span class="lineNum">    1731 </span>            :                 &quot;The filter watches the property `FileNumber` on incoming packets to create new files or new segments in DASH mode.\n&quot;
<span class="lineNum">    1732 </span>            :         )
<span class="lineNum">    1733 </span>            :         .private_size = sizeof(GF_TSMuxCtx),
<span class="lineNum">    1734 </span>            :         .args = TSMuxArgs,
<span class="lineNum">    1735 </span>            :         .initialize = tsmux_initialize,
<span class="lineNum">    1736 </span>            :         .finalize = tsmux_finalize,
<span class="lineNum">    1737 </span>            :         .flags = GF_FS_REG_DYNAMIC_REDIRECT,
<span class="lineNum">    1738 </span>            :         SETCAPS(TSMuxCaps),
<span class="lineNum">    1739 </span>            :         .configure_pid = tsmux_configure_pid,
<span class="lineNum">    1740 </span>            :         .process = tsmux_process,
<span class="lineNum">    1741 </span>            :         .process_event = tsmux_process_event,
<span class="lineNum">    1742 </span>            : };
<a name="1743"><span class="lineNum">    1743 </span>            : </a>
<span class="lineNum">    1744 </span>            : 
<span class="lineNum">    1745 </span><span class="lineCov">       2877 : const GF_FilterRegister *tsmux_register(GF_FilterSession *session)</span>
<span class="lineNum">    1746 </span>            : {
<span class="lineNum">    1747 </span><span class="lineCov">       2877 :         return &amp;TSMuxRegister;</span>
<span class="lineNum">    1748 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

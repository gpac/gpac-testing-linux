<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - filters/dmx_dash.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">filters</a> - dmx_dash.c<span style="font-size: 80%;"> (source / <a href="dmx_dash.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1174</td>
            <td class="headerCovTableEntry">1445</td>
            <td class="headerCovTableEntryMed">81.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">42</td>
            <td class="headerCovTableEntry">45</td>
            <td class="headerCovTableEntryHi">93.3 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2017-2021
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / DASH/HLS demux filter
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/filters.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #ifndef GPAC_DISABLE_DASH_CLIENT
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : #include &lt;gpac/dash.h&gt;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : #ifdef GPAC_HAS_QJS
<span class="lineNum">      34 </span>            : #include &quot;../quickjs/quickjs.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;../scenegraph/qjs_common.h&quot;
<span class="lineNum">      36 </span>            : #endif
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : enum
<span class="lineNum">      39 </span>            : {
<span class="lineNum">      40 </span>            :         DFWD_OFF = 0,
<span class="lineNum">      41 </span>            :         DFWD_FILE,
<span class="lineNum">      42 </span>            :         //all modes below forward frames, not files
<span class="lineNum">      43 </span>            :         DFWD_SBOUND,
<span class="lineNum">      44 </span>            :         DFWD_SBOUND_MANIFEST,
<span class="lineNum">      45 </span>            : };
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            : typedef struct
<span class="lineNum">      48 </span>            : {
<span class="lineNum">      49 </span>            :         //opts
<span class="lineNum">      50 </span>            :         s32 shift_utc, route_shift;
<span class="lineNum">      51 </span>            :         u32 max_buffer, auto_switch, tiles_rate, segstore, delay40X, exp_threshold, switch_count, bwcheck;
<span class="lineNum">      52 </span>            :         s32 init_timeshift;
<span class="lineNum">      53 </span>            :         Bool server_utc, screen_res, aggressive, speedadapt, fmodefwd, skip_lqt, llhls_merge, filemode;
<span class="lineNum">      54 </span>            :         u32 forward;
<span class="lineNum">      55 </span>            :         GF_PropUIntList debug_as;
<span class="lineNum">      56 </span>            :         GF_DASHInitialSelectionMode start_with;
<span class="lineNum">      57 </span>            :         GF_DASHTileAdaptationMode tile_mode;
<span class="lineNum">      58 </span>            :         char *algo;
<span class="lineNum">      59 </span>            :         Bool max_res, immediate, abort, use_bmin;
<span class="lineNum">      60 </span>            :         char *query;
<span class="lineNum">      61 </span>            :         Bool noxlink, split_as, noseek, groupsel;
<span class="lineNum">      62 </span>            :         u32 lowlat;
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            :         GF_FilterPid *mpd_pid;
<span class="lineNum">      65 </span>            :         GF_Filter *filter;
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span>            :         GF_FilterPid *output_mpd_pid;
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span>            :         GF_DashClient *dash;
<span class="lineNum">      70 </span>            :         //http io for manifest
<span class="lineNum">      71 </span>            :         GF_DASHFileIO dash_io;
<span class="lineNum">      72 </span>            :         GF_DownloadManager *dm;
<span class="lineNum">      73 </span>            :         
<span class="lineNum">      74 </span>            :         Bool reuse_download_session;
<span class="lineNum">      75 </span>            : 
<span class="lineNum">      76 </span>            :         Bool initial_setup_done;
<span class="lineNum">      77 </span>            :         Bool in_error;
<span class="lineNum">      78 </span>            :         u32 nb_playing;
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span>            :         /*max width &amp; height in all active representations*/
<span class="lineNum">      81 </span>            :         u32 width, height;
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            :         Double seek_request;
<span class="lineNum">      84 </span>            :         Double media_start_range;
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span>            :         Bool mpd_open;
<span class="lineNum">      87 </span>            :         Bool initial_play;
<span class="lineNum">      88 </span>            :         Bool check_eos;
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            :         char *frag_url;
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span>            :         char *manifest_payload;
<span class="lineNum">      93 </span>            :         GF_List *hls_variants, *hls_variants_names;
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span>            :         Bool is_dash;
<span class="lineNum">      96 </span>            :         Bool manifest_stop_sent;
<span class="lineNum">      97 </span>            : #ifdef GPAC_HAS_QJS
<span class="lineNum">      98 </span>            :         JSContext *js_ctx;
<span class="lineNum">      99 </span>            :         Bool owns_context;
<span class="lineNum">     100 </span>            :         JSValue js_obj, rate_fun, download_fun, new_group_fun, period_reset_fun;
<span class="lineNum">     101 </span>            : #endif
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span>            :         void *rt_udta;
<span class="lineNum">     104 </span>            :         void (*on_period_reset)(void *udta, u32 reset_type);
<span class="lineNum">     105 </span>            :         void (*on_new_group)(void *udta, u32 group_idx, void *dash);
<span class="lineNum">     106 </span>            :         s32 (*on_rate_adaptation)(void *udta, u32 group_idx, u32 base_group_idx, Bool force_low_complex, void *stats);
<span class="lineNum">     107 </span>            :         s32 (*on_download_monitor)(void *udta, u32 group_idx, void *stats);
<span class="lineNum">     108 </span>            : } GF_DASHDmxCtx;
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span>            : typedef struct
<span class="lineNum">     111 </span>            : {
<span class="lineNum">     112 </span>            :         GF_DASHDmxCtx *ctx;
<span class="lineNum">     113 </span>            :         GF_Filter *seg_filter_src;
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span>            :         u32 idx;
<span class="lineNum">     116 </span>            :         Bool init_switch_seg_sent;
<span class="lineNum">     117 </span>            :         Bool segment_sent, in_is_cryptfile;
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span>            :         u32 nb_eos, nb_pids;
<span class="lineNum">     120 </span>            :         Bool stats_uploaded;
<span class="lineNum">     121 </span>            :         Bool wait_for_pck;
<span class="lineNum">     122 </span>            :         Bool eos_detected;
<span class="lineNum">     123 </span>            :         u32 next_dependent_rep_idx, current_dependent_rep_idx;
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span>            :         GF_DownloadSession *sess;
<span class="lineNum">     126 </span>            :         Bool is_timestamp_based, pto_setup;
<span class="lineNum">     127 </span>            :         Bool prev_is_init_segment;
<span class="lineNum">     128 </span>            :         u32 timescale;
<span class="lineNum">     129 </span>            :         s64 pto;
<span class="lineNum">     130 </span>            :         s64 max_cts_in_period;
<span class="lineNum">     131 </span>            :         bin128 key_IV;
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            :         Bool seg_was_not_ready;
<span class="lineNum">     134 </span>            :         Bool in_error;
<span class="lineNum">     135 </span>            :         Bool is_playing;
<span class="lineNum">     136 </span>            :         Bool force_seg_switch;
<span class="lineNum">     137 </span>            :         u32 nb_group_deps, current_group_dep;
<span class="lineNum">     138 </span>            :         u32 last_bw_check;
<span class="lineNum">     139 </span>            :         u64 us_at_seg_start;
<span class="lineNum">     140 </span>            :         Bool signal_seg_name;
<span class="lineNum">     141 </span>            :         Bool init_ok;
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span>            :         u32 seg_discard_state;
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span>            :         char *template;
<a name="146"><span class="lineNum">     146 </span>            : } GF_DASHGroup;</a>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineCov">        174 : static void dashdmx_set_string_list_prop(GF_FilterPacket *ref, u32 prop_name, GF_List **str_list)</span>
<span class="lineNum">     149 </span>            : {
<span class="lineNum">     150 </span>            :         u32 i, count;
<span class="lineNum">     151 </span>            :         GF_PropertyValue v;
<span class="lineNum">     152 </span><span class="lineCov">        174 :         GF_List *list = *str_list;</span>
<span class="lineNum">     153 </span><span class="lineCov">        346 :         if (!list) return;</span>
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span><span class="lineCov">          2 :         v.type = GF_PROP_STRING_LIST;</span>
<span class="lineNum">     156 </span><span class="lineCov">          2 :         v.value.string_list.nb_items = count = gf_list_count(list);</span>
<span class="lineNum">     157 </span><span class="lineCov">          2 :         v.value.string_list.vals = gf_malloc(sizeof(char *) * count);</span>
<span class="lineNum">     158 </span><span class="lineCov">          8 :         for (i=0; i&lt;count;i++) {</span>
<span class="lineNum">     159 </span><span class="lineCov">          6 :                 v.value.string_list.vals[i] = gf_list_pop_front(list);</span>
<span class="lineNum">     160 </span>            :         }
<span class="lineNum">     161 </span><span class="lineCov">          2 :         gf_list_del(list);</span>
<span class="lineNum">     162 </span><span class="lineCov">          2 :         *str_list = NULL;</span>
<span class="lineNum">     163 </span><span class="lineCov">          2 :         gf_filter_pck_set_property(ref, prop_name, &amp;v);</span>
<span class="lineNum">     164 </span>            : }
<a name="165"><span class="lineNum">     165 </span>            : </a>
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span><span class="lineCov">     121704 : static void dashdmx_forward_packet(GF_DASHDmxCtx *ctx, GF_FilterPacket *in_pck, GF_FilterPid *in_pid, GF_FilterPid *out_pid, GF_DASHGroup *group)</span>
<span class="lineNum">     168 </span>            : {
<span class="lineNum">     169 </span>            :         GF_FilterPacket *dst_pck;
<span class="lineNum">     170 </span>            :         Bool do_map_time = GF_FALSE;
<span class="lineNum">     171 </span>            :         Bool seek_flag = 0;
<span class="lineNum">     172 </span>            :         u64 cts, dts;
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span><span class="lineCov">     121704 :         if (ctx-&gt;forward) {</span>
<span class="lineNum">     175 </span>            :                 Bool is_filemode;
<span class="lineNum">     176 </span><span class="lineCov">       3516 :                 Bool is_start = group-&gt;signal_seg_name;</span>
<span class="lineNum">     177 </span>            :                 GF_FilterPacket *ref;
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineCov">       3516 :                 if (ctx-&gt;forward==DFWD_FILE) {</span>
<span class="lineNum">     180 </span><span class="lineCov">        168 :                         Bool is_end = GF_FALSE;</span>
<span class="lineNum">     181 </span><span class="lineCov">        168 :                         if (ctx-&gt;fmodefwd) {</span>
<span class="lineNum">     182 </span><span class="lineCov">        168 :                                 ref = gf_filter_pck_new_ref(out_pid, 0, 0, in_pck);</span>
<span class="lineNum">     183 </span>            :                         } else {
<span class="lineNum">     184 </span>            :                                 u8 *output;
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :                                 ref = gf_filter_pck_new_copy(out_pid, in_pck, &amp;output);</span>
<span class="lineNum">     186 </span>            :                         }
<span class="lineNum">     187 </span><span class="lineCov">        168 :                         if (!ref) return;</span>
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineCov">        168 :                         group-&gt;signal_seg_name = 0;</span>
<span class="lineNum">     190 </span><span class="lineCov">        168 :                         gf_filter_pck_get_framing(in_pck, NULL, &amp;is_end);</span>
<span class="lineNum">     191 </span><span class="lineCov">        168 :                         gf_filter_pid_drop_packet(in_pid);</span>
<span class="lineNum">     192 </span><span class="lineCov">        168 :                         if (gf_filter_pid_is_eos(in_pid))</span>
<span class="lineNum">     193 </span><span class="lineCov">          5 :                                 is_end = GF_TRUE;</span>
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span><span class="lineCov">        168 :                         gf_filter_pck_set_framing(ref, is_start, is_end);</span>
<span class="lineNum">     196 </span>            :                         is_filemode = GF_TRUE;
<span class="lineNum">     197 </span>            :                 } else {
<span class="lineNum">     198 </span>            :                         const GF_PropertyValue *p;
<span class="lineNum">     199 </span><span class="lineCov">       3348 :                         ref = gf_filter_pck_new_ref(out_pid, 0, 0, in_pck);</span>
<span class="lineNum">     200 </span><span class="lineCov">       3348 :                         if (!ref) return;</span>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span><span class="lineCov">       3348 :                         gf_filter_pck_merge_properties(in_pck, ref);</span>
<span class="lineNum">     203 </span><span class="lineCov">       3348 :                         p = gf_filter_pck_get_property(in_pck, GF_PROP_PCK_CUE_START);</span>
<span class="lineNum">     204 </span><span class="lineCov">       3348 :                         if (p &amp;&amp; p-&gt;value.boolean) {</span>
<span class="lineNum">     205 </span>            :                                 is_start = GF_TRUE;
<span class="lineNum">     206 </span>            :                         }
<span class="lineNum">     207 </span><span class="lineCov">       3348 :                         group-&gt;pto_setup = GF_TRUE;</span>
<span class="lineNum">     208 </span><span class="lineCov">       3348 :                         gf_filter_pid_drop_packet(in_pid);</span>
<span class="lineNum">     209 </span>            :                         is_filemode = GF_FALSE;
<span class="lineNum">     210 </span>            :                 }
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineCov">       3516 :                 if (is_start) {</span>
<span class="lineNum">     213 </span><span class="lineCov">         87 :                         if (group-&gt;prev_is_init_segment) {</span>
<span class="lineNum">     214 </span><span class="lineCov">          7 :                                 const char *init_segment = NULL;</span>
<span class="lineNum">     215 </span><span class="lineCov">          7 :                                 gf_dash_group_next_seg_info(ctx-&gt;dash, group-&gt;idx, 0, NULL, NULL, NULL, NULL, &amp;init_segment);</span>
<span class="lineNum">     216 </span><span class="lineCov">          7 :                                 if (init_segment) {</span>
<span class="lineNum">     217 </span><span class="lineCov">          7 :                                         gf_filter_pck_set_property(ref, GF_PROP_PCK_FILENAME, &amp;PROP_STRING(init_segment) );</span>
<span class="lineNum">     218 </span><span class="lineCov">          7 :                                         gf_filter_pck_set_property(ref, GF_PROP_PCK_INIT, &amp;PROP_BOOL(GF_TRUE) );</span>
<span class="lineNum">     219 </span>            :                                 }
<span class="lineNum">     220 </span>            :                         } else {
<span class="lineNum">     221 </span>            :                                 GF_Fraction64 seg_time;
<span class="lineNum">     222 </span><span class="lineCov">         80 :                                 const char *seg_name = NULL;</span>
<span class="lineNum">     223 </span>            :                                 u32 seg_number, seg_dur;
<span class="lineNum">     224 </span><span class="lineCov">         80 :                                 gf_dash_group_next_seg_info(ctx-&gt;dash, group-&gt;idx, group-&gt;current_dependent_rep_idx, &amp;seg_name, &amp;seg_number, &amp;seg_time, &amp;seg_dur, NULL);</span>
<span class="lineNum">     225 </span><span class="lineCov">         80 :                                 if (seg_name) {</span>
<span class="lineNum">     226 </span><span class="lineCov">         80 :                                         gf_filter_pck_set_property(ref, GF_PROP_PCK_FILENAME, &amp;PROP_STRING(seg_name) );</span>
<span class="lineNum">     227 </span><span class="lineCov">         80 :                                         gf_filter_pck_set_property(ref, GF_PROP_PCK_FILENUM, &amp;PROP_UINT(seg_number) );</span>
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span><span class="lineCov">         80 :                                         if (is_filemode) {</span>
<span class="lineNum">     230 </span>            :                                                 u64 ts;
<span class="lineNum">     231 </span><span class="lineCov">         26 :                                                 gf_filter_pck_set_duration(ref, seg_dur);</span>
<span class="lineNum">     232 </span>            :                                                 //hack to avoid using a property, we set the carousel version on the packet to signal the duration applies to the entire segment, not the packet
<span class="lineNum">     233 </span><span class="lineCov">         26 :                                                 gf_filter_pck_set_carousel_version(ref, 1);</span>
<span class="lineNum">     234 </span><span class="lineCov">         26 :                                                 if (seg_time.den) {</span>
<span class="lineNum">     235 </span><span class="lineCov">         26 :                                                         ts = seg_time.num;</span>
<span class="lineNum">     236 </span><span class="lineCov">         26 :                                                         if (seg_time.den != 1000) {</span>
<span class="lineNum">     237 </span><span class="lineCov">         26 :                                                                 ts *= 1000;</span>
<span class="lineNum">     238 </span><span class="lineCov">         26 :                                                                 ts /= seg_time.den;</span>
<span class="lineNum">     239 </span>            :                                                         }
<span class="lineNum">     240 </span>            :                                                 } else {
<span class="lineNum">     241 </span>            :                                                         ts = GF_FILTER_NO_TS;
<span class="lineNum">     242 </span>            :                                                 }
<span class="lineNum">     243 </span><span class="lineCov">         26 :                                                 gf_filter_pck_set_cts(ref, ts);</span>
<span class="lineNum">     244 </span>            :                                         }
<span class="lineNum">     245 </span>            :                                 }
<span class="lineNum">     246 </span>            :                         }
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span><span class="lineCov">         87 :                         if (ctx-&gt;manifest_payload) {</span>
<span class="lineNum">     249 </span><span class="lineCov">          3 :                                 gf_filter_pck_set_property(ref, GF_PROP_PCK_DASH_MANIFEST, &amp;PROP_STRING_NO_COPY(ctx-&gt;manifest_payload));</span>
<span class="lineNum">     250 </span><span class="lineCov">          3 :                                 ctx-&gt;manifest_payload = NULL;</span>
<span class="lineNum">     251 </span>            :                         }
<span class="lineNum">     252 </span><span class="lineCov">         87 :                         dashdmx_set_string_list_prop(ref, GF_PROP_PCK_HLS_VARIANT, &amp;ctx-&gt;hls_variants);</span>
<span class="lineNum">     253 </span><span class="lineCov">         87 :                         dashdmx_set_string_list_prop(ref, GF_PROP_PCK_HLS_VARIANT_NAME, &amp;ctx-&gt;hls_variants_names);</span>
<span class="lineNum">     254 </span>            :                 }
<span class="lineNum">     255 </span><span class="lineCov">       3516 :                 gf_filter_pck_send(ref);</span>
<span class="lineNum">     256 </span><span class="lineCov">       3516 :                 return;</span>
<span class="lineNum">     257 </span>            :         }
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span><span class="lineCov">     118188 :         if (!ctx-&gt;is_dash) {</span>
<span class="lineNum">     260 </span><span class="lineCov">       6483 :                 gf_filter_pck_forward(in_pck, out_pid);</span>
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span><span class="lineCov">       6483 :                 if (!group-&gt;pto_setup) {</span>
<span class="lineNum">     263 </span><span class="lineCov">         33 :                         cts = gf_filter_pck_get_cts(in_pck);</span>
<span class="lineNum">     264 </span><span class="lineCov">         33 :                         gf_filter_pid_set_property_str(out_pid, &quot;time:timestamp&quot;, &amp;PROP_LONGUINT(cts) );</span>
<span class="lineNum">     265 </span><span class="lineCov">         33 :                         gf_filter_pid_set_property_str(out_pid, &quot;time:media&quot;, &amp;PROP_DOUBLE(ctx-&gt;media_start_range) );</span>
<span class="lineNum">     266 </span><span class="lineCov">         33 :                         group-&gt;pto_setup = GF_TRUE;</span>
<span class="lineNum">     267 </span>            :                 }
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span><span class="lineCov">       6483 :                 gf_filter_pid_drop_packet(in_pid);</span>
<span class="lineNum">     270 </span><span class="lineCov">       6483 :                 return;</span>
<span class="lineNum">     271 </span>            :         }
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span>            :         //filter any packet outside the current period
<span class="lineNum">     274 </span><span class="lineCov">     111705 :         dts = gf_filter_pck_get_dts(in_pck);</span>
<span class="lineNum">     275 </span><span class="lineCov">     111705 :         cts = gf_filter_pck_get_cts(in_pck);</span>
<span class="lineNum">     276 </span><span class="lineCov">     111705 :         seek_flag = gf_filter_pck_get_seek_flag(in_pck);</span>
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span>            :         //if sync is based on timestamps do not adjust the timestamps back
<span class="lineNum">     279 </span><span class="lineCov">     111705 :         if (! group-&gt;is_timestamp_based) {</span>
<span class="lineNum">     280 </span><span class="lineCov">     111705 :                 if (!group-&gt;pto_setup) {</span>
<span class="lineNum">     281 </span>            :                         Double scale;
<span class="lineNum">     282 </span>            :                         s64 start, dur;
<span class="lineNum">     283 </span>            :                         u64 pto;
<span class="lineNum">     284 </span><span class="lineCov">        127 :                         u32 ts = gf_filter_pck_get_timescale(in_pck);</span>
<span class="lineNum">     285 </span><span class="lineCov">        127 :                         gf_dash_group_get_presentation_time_offset(ctx-&gt;dash, group-&gt;idx, &amp;pto, &amp;group-&gt;timescale);</span>
<span class="lineNum">     286 </span><span class="lineCov">        127 :                         group-&gt;pto = (s64) pto;</span>
<span class="lineNum">     287 </span><span class="lineCov">        127 :                         group-&gt;pto_setup = 1;</span>
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineCov">        127 :                         if (group-&gt;timescale &amp;&amp; (group-&gt;timescale != ts)) {</span>
<span class="lineNum">     290 </span><span class="lineCov">          4 :                                 group-&gt;pto *= ts;</span>
<span class="lineNum">     291 </span><span class="lineCov">          4 :                                 group-&gt;pto /= group-&gt;timescale;</span>
<span class="lineNum">     292 </span>            :                         }
<span class="lineNum">     293 </span><span class="lineCov">        127 :                         scale = ts;</span>
<span class="lineNum">     294 </span><span class="lineCov">        127 :                         scale /= 1000;</span>
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineCov">        127 :                         dur = (u64) (scale * gf_dash_get_period_duration(ctx-&gt;dash));</span>
<span class="lineNum">     297 </span><span class="lineCov">        127 :                         if (dur) {</span>
<span class="lineNum">     298 </span><span class="lineCov">        107 :                                 group-&gt;max_cts_in_period = group-&gt;pto + dur;</span>
<span class="lineNum">     299 </span>            :                         } else {
<span class="lineNum">     300 </span><span class="lineCov">         20 :                                 group-&gt;max_cts_in_period = 0;</span>
<span class="lineNum">     301 </span>            :                         }
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span><span class="lineCov">        127 :                         start = (u64) (scale * gf_dash_get_period_start(ctx-&gt;dash));</span>
<span class="lineNum">     304 </span><span class="lineCov">        127 :                         group-&gt;pto -= start;</span>
<span class="lineNum">     305 </span>            :                 }
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineCov">     111705 :                 if (group-&gt;max_cts_in_period &amp;&amp; (s64) cts &gt; group-&gt;max_cts_in_period) {</span>
<span class="lineNum">     308 </span>            :                         u64 adj_cts = cts;
<span class="lineNum">     309 </span><span class="lineCov">       2814 :                         const GF_PropertyValue *p = gf_filter_pid_get_property(in_pid, GF_PROP_PID_DELAY);</span>
<span class="lineNum">     310 </span><span class="lineCov">       2814 :                         if (p) adj_cts += p-&gt;value.longsint;</span>
<span class="lineNum">     311 </span><span class="lineCov">       2814 :                         if ( (s64) adj_cts &gt; group-&gt;max_cts_in_period) {</span>
<span class="lineNum">     312 </span><span class="lineCov">       2801 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[DASHDmx] Packet timestamp &quot;LLU&quot; larger than max CTS in period &quot;LLU&quot; - forcing seek flag\n&quot;, adj_cts, group-&gt;max_cts_in_period));</span>
<span class="lineNum">     313 </span>            :                                 seek_flag = 1;
<span class="lineNum">     314 </span>            :                         }
<span class="lineNum">     315 </span>            :                 }
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span>            :                 //remap timestamps to our timeline
<span class="lineNum">     318 </span><span class="lineCov">     111705 :                 if (dts != GF_FILTER_NO_TS) {</span>
<span class="lineNum">     319 </span><span class="lineCov">      88390 :                         if ((s64) dts &gt;= group-&gt;pto)</span>
<span class="lineNum">     320 </span><span class="lineCov">      88388 :                                 dts -= group-&gt;pto;</span>
<span class="lineNum">     321 </span>            :                         else {
<span class="lineNum">     322 </span><span class="lineCov">          2 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[DASHDmx] Packet DTS &quot;LLU&quot; less than PTO &quot;LLU&quot; - forcing DTS to 0\n&quot;, dts, group-&gt;pto));</span>
<span class="lineNum">     323 </span>            :                                 dts = 0;
<span class="lineNum">     324 </span>            :                                 seek_flag = 1;
<span class="lineNum">     325 </span>            :                         }
<span class="lineNum">     326 </span>            :                 }
<span class="lineNum">     327 </span><span class="lineCov">     111705 :                 if (cts!=GF_FILTER_NO_TS) {</span>
<span class="lineNum">     328 </span><span class="lineCov">      88390 :                         if ((s64) cts &gt;= group-&gt;pto)</span>
<span class="lineNum">     329 </span><span class="lineCov">      88390 :                                 cts -= group-&gt;pto;</span>
<span class="lineNum">     330 </span>            :                         else {
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[DASHDmx] Packet CTS &quot;LLU&quot; less than PTO &quot;LLU&quot; - forcing CTS to 0\n&quot;, cts, group-&gt;pto));</span>
<span class="lineNum">     332 </span>            :                                 cts = 0;
<span class="lineNum">     333 </span>            :                                 seek_flag = 1;
<span class="lineNum">     334 </span>            :                         }
<span class="lineNum">     335 </span>            :                 }
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :         } else if (!group-&gt;pto_setup) {</span>
<span class="lineNum">     337 </span>            :                 do_map_time = 1;
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                 group-&gt;pto_setup = 1;</span>
<span class="lineNum">     339 </span>            :         }
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span><span class="lineCov">     111705 :         dst_pck = gf_filter_pck_new_ref(out_pid, 0, 0, in_pck);</span>
<span class="lineNum">     342 </span><span class="lineCov">     111705 :         if (!dst_pck) return;</span>
<span class="lineNum">     343 </span>            :         
<span class="lineNum">     344 </span>            :         //this will copy over clock info for PCR in TS
<span class="lineNum">     345 </span><span class="lineCov">     111705 :         gf_filter_pck_merge_properties(in_pck, dst_pck);</span>
<span class="lineNum">     346 </span><span class="lineCov">     111705 :         gf_filter_pck_set_dts(dst_pck, dts);</span>
<span class="lineNum">     347 </span><span class="lineCov">     111705 :         gf_filter_pck_set_cts(dst_pck, cts);</span>
<span class="lineNum">     348 </span><span class="lineCov">     111705 :         gf_filter_pck_set_seek_flag(dst_pck, seek_flag);</span>
<span class="lineNum">     349 </span><span class="lineCov">     111705 :         gf_filter_pck_send(dst_pck);</span>
<span class="lineNum">     350 </span><span class="lineCov">     111705 :         gf_filter_pid_drop_packet(in_pid);</span>
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span><span class="lineCov">     111705 :         if (do_map_time) {</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_property_str(out_pid, &quot;time:timestamp&quot;, &amp;PROP_LONGUINT(cts) );</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_property_str(out_pid, &quot;time:media&quot;, &amp;PROP_DOUBLE(ctx-&gt;media_start_range) );</span>
<span class="lineNum">     355 </span>            :         }
<span class="lineNum">     356 </span>            : }
<a name="357"><span class="lineNum">     357 </span>            : </a>
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span><span class="lineCov">          9 : static void dashdmx_on_filter_setup_error(GF_Filter *failed_filter, void *udta, GF_Err err)</span>
<span class="lineNum">     360 </span>            : {
<span class="lineNum">     361 </span>            :         GF_DASHGroup *group = (GF_DASHGroup *)udta;
<span class="lineNum">     362 </span><span class="lineCov">          9 :         if (!udta) return;</span>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span><span class="lineCov">          9 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] group %d download setup error %s\n&quot;, group-&gt;idx, gf_error_to_string(err) ));</span>
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span><span class="lineCov">          9 :         gf_dash_set_group_download_state(group-&gt;ctx-&gt;dash, group-&gt;idx, group-&gt;current_dependent_rep_idx, err);</span>
<span class="lineNum">     367 </span><span class="lineCov">          9 :         if (err) {</span>
<span class="lineNum">     368 </span><span class="lineCov">          9 :                 Bool group_done = gf_dash_get_group_done(group-&gt;ctx-&gt;dash, group-&gt;idx);</span>
<span class="lineNum">     369 </span><span class="lineCov">          9 :                 group-&gt;stats_uploaded = GF_TRUE;</span>
<span class="lineNum">     370 </span><span class="lineCov">          9 :                 group-&gt;segment_sent = GF_FALSE;</span>
<span class="lineNum">     371 </span><span class="lineCov">          9 :                 gf_filter_post_process_task(group-&gt;ctx-&gt;filter);</span>
<span class="lineNum">     372 </span><span class="lineCov">          9 :                 if (group_done) {</span>
<span class="lineNum">     373 </span><span class="lineCov">          3 :                         group-&gt;eos_detected = GF_TRUE;</span>
<span class="lineNum">     374 </span>            :                 } else {
<span class="lineNum">     375 </span><span class="lineCov">          6 :                         group-&gt;in_error = GF_TRUE;</span>
<span class="lineNum">     376 </span>            :                         //failure at init, abort group
<span class="lineNum">     377 </span><span class="lineCov">          6 :                         if (!group-&gt;init_ok)</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :                                 group-&gt;seg_filter_src = NULL;</span>
<span class="lineNum">     379 </span>            :                 }
<span class="lineNum">     380 </span>            :         }
<span class="lineNum">     381 </span>            : }
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span>            : void gf_cryptfin_set_kms(GF_Filter *f, const char *key_url, bin128 key_IV);
<a name="384"><span class="lineNum">     384 </span>            : </a>
<span class="lineNum">     385 </span>            : /*locates input service (demuxer) based on mime type or segment name*/
<span class="lineNum">     386 </span><span class="lineCov">        197 : static GF_Err dashdmx_load_source(GF_DASHDmxCtx *ctx, u32 group_index, const char *mime, const char *init_segment_name, u64 start_range, u64 end_range)</span>
<span class="lineNum">     387 </span>            : {
<span class="lineNum">     388 </span>            :         GF_DASHGroup *group;
<span class="lineNum">     389 </span>            :         GF_Err e;
<span class="lineNum">     390 </span>            :         u32 url_type=0;
<span class="lineNum">     391 </span>            :         Bool has_sep = GF_FALSE;
<span class="lineNum">     392 </span>            :         u32 crypto_type;
<span class="lineNum">     393 </span>            :         bin128 key_IV;
<span class="lineNum">     394 </span>            :         char szSep[2];
<span class="lineNum">     395 </span>            :         const char *key_uri;
<span class="lineNum">     396 </span><span class="lineCov">        197 :         char *sURL = NULL;</span>
<span class="lineNum">     397 </span>            :         const char *base_url;
<span class="lineNum">     398 </span><span class="lineCov">        197 :         if (!init_segment_name) {</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[DASHDmx] group %d Error locating input filter: no segment URL, mime type %s\n&quot;, group_index, mime));</span>
<span class="lineNum">     400 </span>            :                 return GF_FILTER_NOT_FOUND;
<span class="lineNum">     401 </span>            :         }
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span><span class="lineCov">        197 :         GF_SAFEALLOC(group, GF_DASHGroup);</span>
<span class="lineNum">     404 </span><span class="lineCov">        197 :         if (!group) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     405 </span><span class="lineCov">        197 :         group-&gt;ctx = ctx;</span>
<span class="lineNum">     406 </span><span class="lineCov">        197 :         group-&gt;idx = group_index;</span>
<span class="lineNum">     407 </span><span class="lineCov">        197 :         gf_dash_set_group_udta(ctx-&gt;dash, group_index, group);</span>
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span><span class="lineCov">        197 :         base_url = gf_dash_get_url(ctx-&gt;dash);</span>
<span class="lineNum">     410 </span><span class="lineCov">        197 :         if (!strnicmp(base_url, &quot;http://&quot;, 7)) url_type=1;</span>
<span class="lineNum">     411 </span><span class="lineCov">        148 :         else if (!strnicmp(base_url, &quot;https://&quot;, 7)) url_type=2;</span>
<span class="lineNum">     412 </span>            :         else url_type=0;
<span class="lineNum">     413 </span>            : 
<span class="lineNum">     414 </span><span class="lineCov">        197 :         key_uri = gf_dash_group_get_segment_init_keys(ctx-&gt;dash, group_index, &amp;crypto_type, &amp;key_IV);</span>
<span class="lineNum">     415 </span><span class="lineCov">        197 :         if (crypto_type==1) {</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :                 gf_dynstrcat(&amp;sURL, &quot;gcryp://&quot;, NULL);</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :                 group-&gt;in_is_cryptfile = GF_TRUE;</span>
<span class="lineNum">     418 </span>            :         }
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span><span class="lineCov">        197 :         if (!strncmp(init_segment_name, &quot;isobmff://&quot;, 10)) {</span>
<span class="lineNum">     421 </span><span class="lineCov">          5 :                 if (url_type==1)</span>
<span class="lineNum">     422 </span><span class="lineCov">          3 :                         gf_dynstrcat(&amp;sURL, &quot;http://&quot;, NULL);</span>
<span class="lineNum">     423 </span><span class="lineCov">          2 :                 else if (url_type==2)</span>
<span class="lineNum">     424 </span><span class="lineCov">          2 :                         gf_dynstrcat(&amp;sURL, &quot;https://&quot;, NULL);</span>
<span class="lineNum">     425 </span>            :                 else
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;sURL, &quot;file://&quot;, NULL);</span>
<span class="lineNum">     427 </span>            :         }
<span class="lineNum">     428 </span><span class="lineCov">        197 :         gf_dynstrcat(&amp;sURL, init_segment_name, NULL);</span>
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span><span class="lineCov">        197 :         szSep[0] = gf_filter_get_sep(ctx-&gt;filter, GF_FS_SEP_ARGS);</span>
<span class="lineNum">     431 </span><span class="lineCov">        197 :         szSep[1] = 0;</span>
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span>            :         //not from file system, set cache option
<span class="lineNum">     434 </span><span class="lineCov">        197 :         if (url_type) {</span>
<span class="lineNum">     435 </span><span class="lineCov">         67 :                 if (!ctx-&gt;segstore) {</span>
<span class="lineNum">     436 </span><span class="lineCov">         67 :                         if (!has_sep) { gf_dynstrcat(&amp;sURL, &quot;gpac&quot;, szSep); has_sep = GF_TRUE; }</span>
<span class="lineNum">     437 </span>            :                         //if operating in mem mode and we load a file decryptor, only store in mem cache the first seg, and no cache for segments
<span class="lineNum">     438 </span><span class="lineCov">         67 :                         if (crypto_type==1)</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;sURL, &quot;cache=none_keep&quot;, szSep);</span>
<span class="lineNum">     440 </span>            :                         else
<span class="lineNum">     441 </span><span class="lineCov">         67 :                                 gf_dynstrcat(&amp;sURL, &quot;cache=mem_keep&quot;, szSep);</span>
<span class="lineNum">     442 </span>            :                 }
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :                 else if (ctx-&gt;segstore==2) {</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :                         if (!has_sep) { gf_dynstrcat(&amp;sURL, &quot;gpac&quot;, szSep); has_sep = GF_TRUE; }</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;sURL, &quot;cache=keep&quot;, szSep);</span>
<span class="lineNum">     446 </span>            :                 }
<span class="lineNum">     447 </span>            :         }
<span class="lineNum">     448 </span>            : 
<span class="lineNum">     449 </span><span class="lineCov">        197 :         if (start_range || end_range) {</span>
<span class="lineNum">     450 </span>            :                 char szRange[500];
<span class="lineNum">     451 </span><span class="lineCov">         24 :                 if (!has_sep) { gf_dynstrcat(&amp;sURL, &quot;gpac&quot;, szSep); has_sep = GF_TRUE; }</span>
<span class="lineNum">     452 </span>            :                 snprintf(szRange, 500, &quot;range=&quot;LLU&quot;-&quot;LLU, start_range, end_range);
<span class="lineNum">     453 </span><span class="lineCov">         24 :                 gf_dynstrcat(&amp;sURL, szRange, szSep);</span>
<span class="lineNum">     454 </span>            :         }
<span class="lineNum">     455 </span><span class="lineCov">        197 :         if (ctx-&gt;forward&gt;DFWD_FILE) {</span>
<span class="lineNum">     456 </span><span class="lineCov">         27 :                 if (!has_sep) { gf_dynstrcat(&amp;sURL, &quot;gpac&quot;, szSep); }</span>
<span class="lineNum">     457 </span><span class="lineCov">         27 :                 gf_dynstrcat(&amp;sURL, &quot;sigfrag&quot;, szSep);</span>
<span class="lineNum">     458 </span>            :         }
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineCov">        197 :         group-&gt;seg_filter_src = gf_filter_connect_source(ctx-&gt;filter, sURL, NULL, GF_FALSE, &amp;e);</span>
<span class="lineNum">     461 </span><span class="lineCov">        197 :         if (!group-&gt;seg_filter_src) {</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[DASHDmx] group %d error locating plugin for segment - mime type %s name %s: %s\n&quot;, group_index, mime, sURL, gf_error_to_string(e) ));</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                 gf_free(sURL);</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :                 gf_free(group);</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :                 gf_dash_set_group_udta(ctx-&gt;dash, group_index, NULL);</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                 return e;</span>
<span class="lineNum">     467 </span>            :         }
<span class="lineNum">     468 </span><span class="lineCov">        197 :         GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[DASHDmx] setting up group %d from %s\n&quot;, group-&gt;idx, init_segment_name));</span>
<span class="lineNum">     469 </span><span class="lineCov">        197 :         group-&gt;signal_seg_name = (ctx-&gt;forward==DFWD_FILE) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span><span class="lineCov">        197 :         gf_filter_set_setup_failure_callback(ctx-&gt;filter, group-&gt;seg_filter_src, dashdmx_on_filter_setup_error, group);</span>
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span>            :         //if HLS AES-CBC, set key BEFORE discarding segment URL (if TS, discarding the segment will discard the key uri)
<span class="lineNum">     474 </span><span class="lineCov">        197 :         if (key_uri &amp;&amp; (crypto_type==1)) {</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :                 gf_cryptfin_set_kms(group-&gt;seg_filter_src, key_uri, key_IV);</span>
<span class="lineNum">     476 </span>            :         }
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span><span class="lineCov">        197 :         gf_dash_group_discard_segment(ctx-&gt;dash, group-&gt;idx);</span>
<span class="lineNum">     479 </span><span class="lineCov">        197 :         group-&gt;prev_is_init_segment = GF_TRUE;</span>
<span class="lineNum">     480 </span><span class="lineCov">        197 :         group-&gt;nb_group_deps = gf_dash_group_get_num_groups_depending_on(ctx-&gt;dash, group_index);</span>
<span class="lineNum">     481 </span><span class="lineCov">        197 :         group-&gt;current_group_dep = 0;</span>
<span class="lineNum">     482 </span><span class="lineCov">        197 :         gf_free(sURL);</span>
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span><span class="lineCov">        197 :         return GF_OK;</span>
<a name="485"><span class="lineNum">     485 </span>            : }</a>
<span class="lineNum">     486 </span>            : 
<span class="lineNum">     487 </span><span class="lineCov">         18 : void dashdmx_io_delete_cache_file(GF_DASHFileIO *dashio, GF_DASHFileIOSession session, const char *cache_url)</span>
<span class="lineNum">     488 </span>            : {
<span class="lineNum">     489 </span><span class="lineCov">         18 :         if (!session) {</span>
<span class="lineNum">     490 </span>            :                 return;
<span class="lineNum">     491 </span>            :         }
<span class="lineNum">     492 </span><span class="lineCov">         10 :         gf_dm_delete_cached_file_entry_session((GF_DownloadSession *)session, cache_url);</span>
<a name="493"><span class="lineNum">     493 </span>            : }</a>
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span><span class="lineCov">         52 : GF_DASHFileIOSession dashdmx_io_create(GF_DASHFileIO *dashio, Bool persistent, const char *url, s32 group_idx)</span>
<span class="lineNum">     496 </span>            : {
<span class="lineNum">     497 </span>            :         GF_DownloadSession *sess;
<span class="lineNum">     498 </span>            :         GF_Err e;
<span class="lineNum">     499 </span>            :         u32 flags = GF_NETIO_SESSION_NOT_THREADED;
<span class="lineNum">     500 </span><span class="lineCov">         52 :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx *)dashio-&gt;udta;</span>
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span>            :         //we work in non-threaded mode, only MPD fetcher is allowed
<span class="lineNum">     503 </span><span class="lineCov">         52 :         if (group_idx&gt;=0)</span>
<span class="lineNum">     504 </span>            :                 return NULL;
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span>            :         //crude hack when using gpac downloader to initialize the MPD pid: get the pointer to the download session
<span class="lineNum">     507 </span>            :         //this should be safe unless the mpd_pid is destroyed, which should only happen upon destruction of the DASH session
<span class="lineNum">     508 </span><span class="lineCov">         52 :         if (group_idx==-1) {</span>
<span class="lineNum">     509 </span><span class="lineCov">         52 :                 const GF_PropertyValue *p = gf_filter_pid_get_property(ctx-&gt;mpd_pid, GF_PROP_PID_DOWNLOAD_SESSION);</span>
<span class="lineNum">     510 </span><span class="lineCov">         52 :                 if (p) {</span>
<span class="lineNum">     511 </span><span class="lineCov">         39 :                         sess = (GF_DownloadSession *) p-&gt;value.ptr;</span>
<span class="lineNum">     512 </span><span class="lineCov">         39 :                         if (!ctx-&gt;segstore) {</span>
<span class="lineNum">     513 </span><span class="lineCov">         39 :                                 gf_dm_sess_force_memory_mode(sess, 1);</span>
<span class="lineNum">     514 </span>            :                         }
<span class="lineNum">     515 </span><span class="lineCov">         39 :                         if (ctx-&gt;reuse_download_session)</span>
<span class="lineNum">     516 </span><span class="lineCov">          3 :                                 gf_dm_sess_setup_from_url(sess, url, GF_FALSE);</span>
<span class="lineNum">     517 </span><span class="lineCov">         39 :                         ctx-&gt;reuse_download_session = GF_TRUE;</span>
<span class="lineNum">     518 </span><span class="lineCov">         39 :                         return (GF_DASHFileIOSession) sess;</span>
<span class="lineNum">     519 </span>            :                 }
<span class="lineNum">     520 </span>            :         }
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span><span class="lineCov">         13 :         if (group_idx&lt;-1) {</span>
<span class="lineNum">     523 </span>            :                 flags |= GF_NETIO_SESSION_MEMORY_CACHE;
<span class="lineNum">     524 </span>            :         } else {
<span class="lineNum">     525 </span><span class="lineCov">         13 :                 if (!ctx-&gt;segstore) flags |= GF_NETIO_SESSION_MEMORY_CACHE;</span>
<span class="lineNum">     526 </span><span class="lineCov">         13 :                 if (persistent) flags |= GF_NETIO_SESSION_PERSISTENT;</span>
<span class="lineNum">     527 </span>            :         }
<span class="lineNum">     528 </span><span class="lineCov">         13 :         sess = gf_dm_sess_new(ctx-&gt;dm, url, flags, NULL, NULL, &amp;e);</span>
<a name="529"><span class="lineNum">     529 </span><span class="lineCov">         13 :         return (GF_DASHFileIOSession) sess;</span></a>
<span class="lineNum">     530 </span>            : }
<span class="lineNum">     531 </span><span class="lineCov">         52 : void dashdmx_io_del(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)</span>
<span class="lineNum">     532 </span>            : {
<span class="lineNum">     533 </span><span class="lineCov">         52 :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx *)dashio-&gt;udta;</span>
<span class="lineNum">     534 </span><span class="lineCov">         52 :         if (!ctx-&gt;reuse_download_session)</span>
<a name="535"><span class="lineNum">     535 </span><span class="lineCov">         13 :                 gf_dm_sess_del((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     536 </span><span class="lineCov">         52 : }</span>
<span class="lineNum">     537 </span><span class="lineCov">        209 : GF_Err dashdmx_io_init(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)</span>
<span class="lineNum">     538 </span>            : {
<a name="539"><span class="lineNum">     539 </span><span class="lineCov">        209 :         return gf_dm_sess_process_headers((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     540 </span>            : }
<span class="lineNum">     541 </span><span class="lineCov">        209 : GF_Err dashdmx_io_run(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)</span>
<span class="lineNum">     542 </span>            : {
<a name="543"><span class="lineNum">     543 </span><span class="lineCov">        209 :         return gf_dm_sess_process((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     544 </span>            : }
<span class="lineNum">     545 </span><span class="lineCov">         60 : const char *dashdmx_io_get_url(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)</span>
<span class="lineNum">     546 </span>            : {
<a name="547"><span class="lineNum">     547 </span><span class="lineCov">         60 :         return gf_dm_sess_get_resource_name((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     548 </span>            : }
<span class="lineNum">     549 </span><span class="lineCov">        271 : const char *dashdmx_io_get_cache_name(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)</span>
<span class="lineNum">     550 </span>            : {
<a name="551"><span class="lineNum">     551 </span><span class="lineCov">        271 :         return gf_dm_sess_get_cache_name((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     552 </span>            : }
<span class="lineNum">     553 </span><span class="lineCov">         99 : const char *dashdmx_io_get_mime(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)</span>
<span class="lineNum">     554 </span>            : {
<a name="555"><span class="lineNum">     555 </span><span class="lineCov">         99 :         return gf_dm_sess_mime_type((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     556 </span>            : }
<span class="lineNum">     557 </span><span class="lineCov">        184 : const char *dashdmx_io_get_header_value(GF_DASHFileIO *dashio, GF_DASHFileIOSession session, const char *header_name)</span>
<span class="lineNum">     558 </span>            : {
<a name="559"><span class="lineNum">     559 </span><span class="lineCov">        184 :         return gf_dm_sess_get_header((GF_DownloadSession *)session, header_name);</span></a>
<span class="lineNum">     560 </span>            : }
<span class="lineNum">     561 </span><span class="lineCov">        133 : u64 dashdmx_io_get_utc_start_time(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)</span>
<span class="lineNum">     562 </span>            : {
<a name="563"><span class="lineNum">     563 </span><span class="lineCov">        133 :         return gf_dm_sess_get_utc_start((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     564 </span>            : }
<span class="lineNum">     565 </span><span class="lineCov">        119 : GF_Err dashdmx_io_setup_from_url(GF_DASHFileIO *dashio, GF_DASHFileIOSession session, const char *url, s32 group_idx)</span>
<span class="lineNum">     566 </span>            : {
<a name="567"><span class="lineNum">     567 </span><span class="lineCov">        119 :         return gf_dm_sess_setup_from_url((GF_DownloadSession *)session, url, GF_FALSE);</span></a>
<span class="lineNum">     568 </span>            : }
<span class="lineNum">     569 </span><span class="lineCov">         50 : GF_Err dashdmx_io_set_range(GF_DASHFileIO *dashio, GF_DASHFileIOSession session, u64 start_range, u64 end_range, Bool discontinue_cache)</span>
<span class="lineNum">     570 </span>            : {
<span class="lineNum">     571 </span><span class="lineCov">         50 :         return gf_dm_sess_set_range((GF_DownloadSession *)session, start_range, end_range, discontinue_cache);</span>
<span class="lineNum">     572 </span>            : }
<span class="lineNum">     573 </span>            : 
<span class="lineNum">     574 </span>            : #if 0 //unused since we are in non threaded mode
<span class="lineNum">     575 </span>            : void dashdmx_io_abort(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     576 </span>            : {
<span class="lineNum">     577 </span>            :         gf_dm_sess_abort((GF_DownloadSession *)session);
<span class="lineNum">     578 </span>            : }
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span>            : u32 dashdmx_io_get_bytes_per_sec(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     581 </span>            : {
<span class="lineNum">     582 </span>            :         u32 bps=0;
<span class="lineNum">     583 </span>            :         if (session) {
<span class="lineNum">     584 </span>            :                 gf_dm_sess_get_stats((GF_DownloadSession *)session, NULL, NULL, NULL, NULL, &amp;bps, NULL);
<span class="lineNum">     585 </span>            :         } else {
<span class="lineNum">     586 </span>            :                 GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx *)dashio-&gt;udta;
<span class="lineNum">     587 </span>            :                 bps = gf_dm_get_data_rate(ctx-&gt;dm);
<span class="lineNum">     588 </span>            :                 bps/=8;
<span class="lineNum">     589 </span>            :         }
<span class="lineNum">     590 </span>            :         return bps;
<span class="lineNum">     591 </span>            : }
<span class="lineNum">     592 </span>            : u32 dashdmx_io_get_total_size(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     593 </span>            : {
<span class="lineNum">     594 </span>            :         u64 size=0;
<span class="lineNum">     595 </span>            :         gf_dm_sess_get_stats((GF_DownloadSession *)session, NULL, NULL, &amp;size, NULL, NULL, NULL);
<span class="lineNum">     596 </span>            :         return (u32) size;
<span class="lineNum">     597 </span>            : }
<span class="lineNum">     598 </span>            : u32 dashdmx_io_get_bytes_done(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     599 </span>            : {
<span class="lineNum">     600 </span>            :         u64 size=0;
<span class="lineNum">     601 </span>            :         gf_dm_sess_get_stats((GF_DownloadSession *)session, NULL, NULL, NULL, &amp;size, NULL, NULL);
<span class="lineNum">     602 </span>            :         return (u32) size;
<span class="lineNum">     603 </span>            : }
<span class="lineNum">     604 </span>            : #endif
<span class="lineNum">     605 </span>            : 
<a name="606"><span class="lineNum">     606 </span>            : #ifdef GPAC_HAS_QJS</a>
<span class="lineNum">     607 </span>            : #include &lt;gpac/mpd.h&gt;
<span class="lineNum">     608 </span><span class="lineCov">          2 : void dashdmx_js_declare_group(GF_DASHDmxCtx *ctx, u32 group_idx)</span>
<span class="lineNum">     609 </span>            : {
<span class="lineNum">     610 </span>            :         u32 i, count;
<span class="lineNum">     611 </span>            :         u32 srd_id, srd_x, srd_y, srd_w, srd_h, srd_fw, srd_fh;
<span class="lineNum">     612 </span>            :         JSValue res, reps;
<span class="lineNum">     613 </span><span class="lineCov">          2 :         JSValue obj = JS_NewObject(ctx-&gt;js_ctx);</span>
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineCov">          4 :         JS_SetPropertyStr(ctx-&gt;js_ctx, obj, &quot;idx&quot;, JS_NewInt32(ctx-&gt;js_ctx, group_idx));</span>
<span class="lineNum">     616 </span><span class="lineCov">          4 :         JS_SetPropertyStr(ctx-&gt;js_ctx, obj, &quot;duration&quot;, JS_NewInt64(ctx-&gt;js_ctx, gf_dash_get_period_duration(ctx-&gt;dash) ));</span>
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span><span class="lineCov">          2 :         srd_id = srd_x = srd_y = srd_w = srd_h = srd_fw = srd_fh = 0;</span>
<span class="lineNum">     619 </span><span class="lineCov">          2 :         gf_dash_group_get_srd_info(ctx-&gt;dash, group_idx, &amp;srd_id, &amp;srd_x, &amp;srd_y, &amp;srd_w, &amp;srd_h, &amp;srd_fw, &amp;srd_fh);</span>
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span><span class="lineCov">          2 :         if (srd_fw &amp;&amp; srd_fh) {</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :                 JSValue srd = JS_NewObject(ctx-&gt;js_ctx);</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, srd, &quot;ID&quot;, JS_NewInt32(ctx-&gt;js_ctx, srd_id));</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, srd, &quot;x&quot;, JS_NewInt32(ctx-&gt;js_ctx, srd_x));</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, srd, &quot;y&quot;, JS_NewInt32(ctx-&gt;js_ctx, srd_y));</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, srd, &quot;w&quot;, JS_NewInt32(ctx-&gt;js_ctx, srd_w));</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, srd, &quot;h&quot;, JS_NewInt32(ctx-&gt;js_ctx, srd_h));</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, srd, &quot;fw&quot;, JS_NewInt32(ctx-&gt;js_ctx, srd_fw));</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, srd, &quot;fh&quot;, JS_NewInt32(ctx-&gt;js_ctx, srd_fh));</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, obj, &quot;SRD&quot;, srd);</span>
<span class="lineNum">     631 </span>            :         } else {
<span class="lineNum">     632 </span><span class="lineCov">          2 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, obj, &quot;SRD&quot;, JS_NULL);</span>
<span class="lineNum">     633 </span>            :         }
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span><span class="lineCov">          2 :         reps = JS_NewArray(ctx-&gt;js_ctx);</span>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineCov">          2 :         count = gf_dash_group_get_num_qualities(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">     638 </span><span class="lineCov">          6 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     639 </span>            :                 GF_DASHQualityInfo qinfo;
<span class="lineNum">     640 </span>            :                 JSValue rep;
<span class="lineNum">     641 </span>            :                 GF_Err e;
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span><span class="lineCov">          6 :                 e = gf_dash_group_get_quality_info(ctx-&gt;dash, group_idx, i, &amp;qinfo);</span>
<span class="lineNum">     644 </span><span class="lineCov">          6 :                 if (e) break;</span>
<span class="lineNum">     645 </span><span class="lineCov">          6 :                 if (!qinfo.ID) qinfo.ID=&quot;&quot;;</span>
<span class="lineNum">     646 </span><span class="lineCov">          6 :                 if (!qinfo.mime) qinfo.mime=&quot;unknown&quot;;</span>
<span class="lineNum">     647 </span><span class="lineCov">          6 :                 if (!qinfo.codec) qinfo.codec=&quot;codec&quot;;</span>
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span><span class="lineCov">          6 :                 rep = JS_NewObject(ctx-&gt;js_ctx);</span>
<span class="lineNum">     650 </span><span class="lineCov">          6 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;ID&quot;, JS_NewString(ctx-&gt;js_ctx, qinfo.ID));</span>
<span class="lineNum">     651 </span><span class="lineCov">          6 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;mime&quot;, JS_NewString(ctx-&gt;js_ctx, qinfo.mime));</span>
<span class="lineNum">     652 </span><span class="lineCov">          6 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;codec&quot;, JS_NewString(ctx-&gt;js_ctx, qinfo.codec));</span>
<span class="lineNum">     653 </span><span class="lineCov">         12 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;bitrate&quot;, JS_NewInt32(ctx-&gt;js_ctx, qinfo.bandwidth));</span>
<span class="lineNum">     654 </span><span class="lineCov">         12 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;disabled&quot;, JS_NewBool(ctx-&gt;js_ctx, qinfo.disabled));</span>
<span class="lineNum">     655 </span><span class="lineCov">          6 :                 if (qinfo.width &amp;&amp; qinfo.height) {</span>
<span class="lineNum">     656 </span>            :                         JSValue frac;
<span class="lineNum">     657 </span><span class="lineCov">          8 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;width&quot;, JS_NewInt32(ctx-&gt;js_ctx, qinfo.width));</span>
<span class="lineNum">     658 </span><span class="lineCov">          8 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;height&quot;, JS_NewInt32(ctx-&gt;js_ctx, qinfo.height));</span>
<span class="lineNum">     659 </span><span class="lineCov">          8 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;interlaced&quot;, JS_NewBool(ctx-&gt;js_ctx, qinfo.interlaced));</span>
<span class="lineNum">     660 </span><span class="lineCov">          4 :                         frac = JS_NewObject(ctx-&gt;js_ctx);</span>
<span class="lineNum">     661 </span><span class="lineCov">          8 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, frac, &quot;n&quot;, JS_NewInt32(ctx-&gt;js_ctx, qinfo.fps_num));</span>
<span class="lineNum">     662 </span><span class="lineCov">          8 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, frac, &quot;d&quot;, JS_NewInt32(ctx-&gt;js_ctx, qinfo.fps_den ? qinfo.fps_den : 1));</span>
<span class="lineNum">     663 </span><span class="lineCov">          4 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;fps&quot;, frac);</span>
<span class="lineNum">     664 </span>            : 
<span class="lineNum">     665 </span><span class="lineCov">          4 :                         frac = JS_NewObject(ctx-&gt;js_ctx);</span>
<span class="lineNum">     666 </span><span class="lineCov">          8 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, frac, &quot;n&quot;, JS_NewInt32(ctx-&gt;js_ctx, qinfo.par_num));</span>
<span class="lineNum">     667 </span><span class="lineCov">          8 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, frac, &quot;d&quot;, JS_NewInt32(ctx-&gt;js_ctx, qinfo.par_den ? qinfo.par_den : qinfo.par_num));</span>
<span class="lineNum">     668 </span><span class="lineCov">          4 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;sar&quot;, frac);</span>
<span class="lineNum">     669 </span>            :                 }
<span class="lineNum">     670 </span><span class="lineCov">          6 :                 if (qinfo.sample_rate) {</span>
<span class="lineNum">     671 </span><span class="lineCov">          4 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;samplerate&quot;, JS_NewInt32(ctx-&gt;js_ctx, qinfo.sample_rate));</span>
<span class="lineNum">     672 </span><span class="lineCov">          4 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;channels&quot;, JS_NewInt32(ctx-&gt;js_ctx, qinfo.nb_channels));</span>
<span class="lineNum">     673 </span>            :                 }
<span class="lineNum">     674 </span><span class="lineCov">         12 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;ast_offset&quot;, JS_NewFloat64(ctx-&gt;js_ctx, qinfo.ast_offset));</span>
<span class="lineNum">     675 </span><span class="lineCov">         12 :                 JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;avg_duration&quot;, JS_NewFloat64(ctx-&gt;js_ctx, qinfo.average_duration));</span>
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span><span class="lineCov">          6 :                 if (qinfo.seg_urls) {</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :                         u32 k=0, nb_segs=gf_list_count(qinfo.seg_urls);</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :                         JSValue seg_sizes = JS_NewArray(ctx-&gt;js_ctx);</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :                         for (k=0; k&lt;nb_segs; k++) {</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :                                 GF_MPD_SegmentURL *surl = gf_list_get((GF_List *) qinfo.seg_urls, k);</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :                                 u64 size = (1 + surl-&gt;media_range-&gt;end_range - surl-&gt;media_range-&gt;start_range);</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                                 JS_SetPropertyUint32(ctx-&gt;js_ctx, seg_sizes, k, JS_NewInt64(ctx-&gt;js_ctx, size) );</span>
<span class="lineNum">     684 </span>            :                         }
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;sizes&quot;, seg_sizes);</span>
<span class="lineNum">     686 </span>            :                 } else {
<span class="lineNum">     687 </span><span class="lineCov">          6 :                         JS_SetPropertyStr(ctx-&gt;js_ctx, rep, &quot;sizes&quot;, JS_NULL);</span>
<span class="lineNum">     688 </span>            :                 }
<span class="lineNum">     689 </span><span class="lineCov">          6 :                 JS_SetPropertyUint32(ctx-&gt;js_ctx, reps, i, rep);</span>
<span class="lineNum">     690 </span>            :         }
<span class="lineNum">     691 </span>            : 
<span class="lineNum">     692 </span><span class="lineCov">          2 :         JS_SetPropertyStr(ctx-&gt;js_ctx, obj, &quot;qualities&quot;, reps);</span>
<span class="lineNum">     693 </span>            : 
<span class="lineNum">     694 </span><span class="lineCov">          2 :         res = JS_Call(ctx-&gt;js_ctx, ctx-&gt;new_group_fun, ctx-&gt;js_obj, 1, &amp;obj);</span>
<span class="lineNum">     695 </span><span class="lineCov">          2 :         JS_FreeValue(ctx-&gt;js_ctx, obj);</span>
<span class="lineNum">     696 </span><span class="lineCov">          2 :         JS_FreeValue(ctx-&gt;js_ctx, res);</span>
<span class="lineNum">     697 </span><span class="lineCov">          2 : }</span>
<a name="698"><span class="lineNum">     698 </span>            : #endif</a>
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span><span class="lineCov">        260 : static void dashdmx_declare_group(GF_DASHDmxCtx *ctx, u32 group_idx)</span>
<span class="lineNum">     701 </span>            : {
<span class="lineNum">     702 </span><span class="lineCov">        260 :         if (ctx-&gt;on_new_group)</span>
<span class="lineNum">     703 </span><span class="lineCov">          3 :                 ctx-&gt;on_new_group(ctx-&gt;rt_udta, group_idx, ctx-&gt;dash);</span>
<span class="lineNum">     704 </span>            : #ifdef GPAC_HAS_QJS
<span class="lineNum">     705 </span><span class="lineCov">        257 :         else if (ctx-&gt;js_ctx &amp;&amp; JS_IsFunction(ctx-&gt;js_ctx, ctx-&gt;new_group_fun)) {</span>
<span class="lineNum">     706 </span><span class="lineCov">          2 :                 dashdmx_js_declare_group(ctx, group_idx);</span>
<span class="lineNum">     707 </span>            :         }
<span class="lineNum">     708 </span>            : #endif
<span class="lineNum">     709 </span><span class="lineCov">        260 : }</span>
<a name="710"><span class="lineNum">     710 </span>            : </a>
<span class="lineNum">     711 </span>            : 
<span class="lineNum">     712 </span><span class="lineCov">         10 : void dashdmx_io_manifest_updated(GF_DASHFileIO *dashio, const char *manifest_name, const char *cache_url, s32 group_idx)</span>
<span class="lineNum">     713 </span>            : {
<span class="lineNum">     714 </span>            :         u8 *manifest_payload;
<span class="lineNum">     715 </span>            :         u32 manifest_payload_len;
<span class="lineNum">     716 </span><span class="lineCov">         10 :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx *)dashio-&gt;udta;</span>
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span><span class="lineCov">         10 :         if (gf_file_load_data(cache_url, &amp;manifest_payload, &amp;manifest_payload_len) == GF_OK) {</span>
<span class="lineNum">     719 </span>            :                 u8 *output;
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span>            :                 //strip baseURL since we are recording, links are already resolved
<span class="lineNum">     722 </span><span class="lineCov">         10 :                 char *man_pay_start = manifest_payload;</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :                 while (1) {</span>
<span class="lineNum">     724 </span>            :                         u32 end_len, offset;
<span class="lineNum">     725 </span><span class="lineCov">         10 :                         manifest_payload_len = (u32) strlen(manifest_payload);</span>
<span class="lineNum">     726 </span><span class="lineCov">         10 :                         char *base_url_start = strstr(man_pay_start, &quot;&lt;BaseURL&gt;&quot;);</span>
<span class="lineNum">     727 </span><span class="lineCov">         10 :                         if (!base_url_start) break;</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :                         char *base_url_end = strstr(base_url_start, &quot;&lt;/BaseURL&gt;&quot;);</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :                         if (!base_url_end) break;</span>
<span class="lineNum">     730 </span>            :                         offset = 10;
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :                         while (base_url_end[offset] == '\n')</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :                                 offset++;</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :                         end_len = (u32) strlen(base_url_end+offset);</span>
<span class="lineNum">     734 </span>            :                         memmove(base_url_start, base_url_end+offset, end_len);
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :                         base_url_start[end_len]=0;</span>
<span class="lineNum">     736 </span>            :                         man_pay_start = base_url_start;
<span class="lineNum">     737 </span>            :                 }
<span class="lineNum">     738 </span>            : 
<span class="lineNum">     739 </span><span class="lineCov">         10 :                 if ((ctx-&gt;forward==DFWD_FILE) &amp;&amp; ctx-&gt;output_mpd_pid) {</span>
<span class="lineNum">     740 </span><span class="lineCov">          4 :                         GF_FilterPacket *pck = gf_filter_pck_new_alloc(ctx-&gt;output_mpd_pid, manifest_payload_len, &amp;output);</span>
<span class="lineNum">     741 </span><span class="lineCov">          4 :                         if (pck) {</span>
<span class="lineNum">     742 </span><span class="lineCov">          4 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[DASHDmx] Manifest %s updated, forwarding\n&quot;, manifest_name));</span>
<span class="lineNum">     743 </span><span class="lineCov">          4 :                                 memcpy(output, manifest_payload, manifest_payload_len);</span>
<span class="lineNum">     744 </span><span class="lineCov">          4 :                                 gf_filter_pck_set_framing(pck, GF_TRUE, GF_TRUE);</span>
<span class="lineNum">     745 </span><span class="lineCov">          4 :                                 gf_filter_pck_set_property(pck, GF_PROP_PCK_FILENAME, &amp;PROP_STRING(manifest_name));</span>
<span class="lineNum">     746 </span><span class="lineCov">          4 :                                 if (group_idx&gt;=0)</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :                                         gf_filter_pck_set_property(pck, GF_PROP_PCK_HLS_REF, &amp;PROP_LONGUINT( (u64) 1+group_idx) );</span>
<span class="lineNum">     748 </span>            : 
<span class="lineNum">     749 </span><span class="lineCov">          4 :                                 gf_filter_pck_send(pck);</span>
<span class="lineNum">     750 </span>            :                         }
<span class="lineNum">     751 </span><span class="lineCov">          6 :                 } else if (ctx-&gt;forward==DFWD_SBOUND_MANIFEST) {</span>
<span class="lineNum">     752 </span><span class="lineCov">          6 :                         if (group_idx&gt;=0) {</span>
<span class="lineNum">     753 </span>            :                                 assert(manifest_name);
<span class="lineNum">     754 </span><span class="lineCov">          3 :                                 if (!ctx-&gt;hls_variants) ctx-&gt;hls_variants = gf_list_new();</span>
<span class="lineNum">     755 </span><span class="lineCov">          3 :                                 if (!ctx-&gt;hls_variants_names) ctx-&gt;hls_variants_names = gf_list_new();</span>
<span class="lineNum">     756 </span><span class="lineCov">          3 :                                 gf_list_add(ctx-&gt;hls_variants, manifest_payload);</span>
<span class="lineNum">     757 </span><span class="lineCov">          3 :                                 manifest_payload = NULL;</span>
<span class="lineNum">     758 </span><span class="lineCov">          3 :                                 gf_list_add(ctx-&gt;hls_variants_names, gf_strdup(manifest_name) );</span>
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span>            :                         } else {
<span class="lineNum">     761 </span><span class="lineCov">          3 :                                 if (ctx-&gt;manifest_payload) gf_free(ctx-&gt;manifest_payload);</span>
<span class="lineNum">     762 </span><span class="lineCov">          3 :                                 ctx-&gt;manifest_payload = manifest_payload;</span>
<span class="lineNum">     763 </span><span class="lineCov">          3 :                                 manifest_payload = NULL;</span>
<span class="lineNum">     764 </span>            :                         }
<span class="lineNum">     765 </span>            :                 }
<span class="lineNum">     766 </span><span class="lineCov">         10 :                 if (manifest_payload)</span>
<span class="lineNum">     767 </span><span class="lineCov">          4 :                         gf_free(manifest_payload);</span>
<span class="lineNum">     768 </span>            :         }
<a name="769"><span class="lineNum">     769 </span><span class="lineCov">         10 : }</span></a>
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span><span class="lineCov">      51510 : GF_Err dashdmx_io_on_dash_event(GF_DASHFileIO *dashio, GF_DASHEventType dash_evt, s32 group_idx, GF_Err error_code)</span>
<span class="lineNum">     772 </span>            : {
<span class="lineNum">     773 </span>            :         GF_Err e;
<span class="lineNum">     774 </span>            :         u32 i;
<span class="lineNum">     775 </span><span class="lineCov">      51510 :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx *)dashio-&gt;udta;</span>
<span class="lineNum">     776 </span>            : 
<span class="lineNum">     777 </span><span class="lineCov">      51510 :         if (dash_evt==GF_DASH_EVENT_PERIOD_SETUP_ERROR) {</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :                 if (!ctx-&gt;initial_setup_done) {</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :                         gf_filter_setup_failure(ctx-&gt;filter, error_code);</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :                         ctx-&gt;initial_setup_done = GF_TRUE;</span>
<span class="lineNum">     781 </span>            :                 }
<span class="lineNum">     782 </span>            :                 return GF_OK;
<span class="lineNum">     783 </span>            :         }
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span><span class="lineCov">      51510 :         if (dash_evt==GF_DASH_EVENT_SELECT_GROUPS) {</span>
<span class="lineNum">     786 </span>            : #ifdef GPAC_ENABLE_COVERAGE
<span class="lineNum">     787 </span><span class="lineCov">        123 :                 if (gf_sys_is_cov_mode()) {</span>
<span class="lineNum">     788 </span><span class="lineCov">        119 :                         gf_dash_groups_set_language(ctx-&gt;dash, gf_opts_get_key(&quot;core&quot;, &quot;lang&quot;));</span>
<span class="lineNum">     789 </span>            :                         //these are not used in the test suite (require JS)
<span class="lineNum">     790 </span><span class="lineCov">        119 :                         gf_dash_switch_quality(ctx-&gt;dash, GF_TRUE, GF_TRUE);</span>
<span class="lineNum">     791 </span>            :                 }
<span class="lineNum">     792 </span>            : #endif
<span class="lineNum">     793 </span><span class="lineCov">        123 :                 if (ctx-&gt;groupsel)</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :                         gf_dash_groups_set_language(ctx-&gt;dash, gf_opts_get_key(&quot;core&quot;, &quot;lang&quot;));</span>
<span class="lineNum">     795 </span>            : 
<span class="lineNum">     796 </span>            :                 //let the player decide which group to play: we declare everything
<span class="lineNum">     797 </span>            :                 return GF_OK;
<span class="lineNum">     798 </span>            :         }
<span class="lineNum">     799 </span>            : 
<span class="lineNum">     800 </span>            :         /*for all selected groups, create input service and connect to init/first segment*/
<span class="lineNum">     801 </span><span class="lineCov">      51387 :         if (dash_evt==GF_DASH_EVENT_CREATE_PLAYBACK) {</span>
<span class="lineNum">     802 </span>            :                 u32 nb_groups_selected = 0;
<span class="lineNum">     803 </span>            :                 //coverage of a few functions from old arch not deprecated (yet)
<span class="lineNum">     804 </span>            : #ifdef GPAC_ENABLE_COVERAGE
<span class="lineNum">     805 </span><span class="lineCov">        122 :                 if (gf_sys_is_cov_mode()) {</span>
<span class="lineNum">     806 </span><span class="lineCov">        118 :                         gf_dash_is_group_selected(ctx-&gt;dash, 0);</span>
<span class="lineNum">     807 </span><span class="lineCov">        118 :                         gf_dash_get_url(ctx-&gt;dash);</span>
<span class="lineNum">     808 </span><span class="lineCov">        118 :                         gf_dash_group_loop_detected(ctx-&gt;dash, 0);</span>
<span class="lineNum">     809 </span><span class="lineCov">        118 :                         gf_dash_is_dynamic_mpd(ctx-&gt;dash);</span>
<span class="lineNum">     810 </span><span class="lineCov">        118 :                         gf_dash_group_get_language(ctx-&gt;dash, 0);</span>
<span class="lineNum">     811 </span><span class="lineCov">        118 :                         gf_dash_group_get_num_components(ctx-&gt;dash, 0);</span>
<span class="lineNum">     812 </span><span class="lineCov">        118 :                         gf_dash_get_utc_drift_estimate(ctx-&gt;dash);</span>
<span class="lineNum">     813 </span>            : 
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span>            :                         //these are not used in the test suite (require decoding)
<span class="lineNum">     816 </span><span class="lineCov">        118 :                         gf_dash_group_set_codec_stat(ctx-&gt;dash, 0, 0, 0, 0, 0, GF_FALSE, GF_FALSE);</span>
<span class="lineNum">     817 </span><span class="lineCov">        118 :                         gf_dash_group_set_buffer_levels(ctx-&gt;dash, 0, 0, 0, 0);</span>
<span class="lineNum">     818 </span>            : 
<span class="lineNum">     819 </span>            :                         //these are not used in the test suite (require JS)
<span class="lineNum">     820 </span><span class="lineCov">        118 :                         if (!strcmp(ctx-&gt;algo, &quot;none&quot;))</span>
<span class="lineNum">     821 </span><span class="lineCov">          6 :                                 gf_dash_set_automatic_switching(ctx-&gt;dash, GF_FALSE);</span>
<span class="lineNum">     822 </span><span class="lineCov">        118 :                         gf_dash_group_select_quality(ctx-&gt;dash, (u32) -1, NULL, 0);</span>
<span class="lineNum">     823 </span>            : 
<span class="lineNum">     824 </span>            :                         //these are not used yet in the test suite (require TEMI)
<span class="lineNum">     825 </span><span class="lineCov">        118 :                         gf_dash_override_ntp(ctx-&gt;dash, 0);</span>
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span>            :                         //this is not used yet in the test suite (require user interaction)
<span class="lineNum">     828 </span><span class="lineCov">        118 :                         gf_dash_group_set_quality_degradation_hint(ctx-&gt;dash, 0, 0);</span>
<span class="lineNum">     829 </span>            :                 }
<span class="lineNum">     830 </span>            : #endif
<span class="lineNum">     831 </span>            : 
<span class="lineNum">     832 </span><span class="lineCov">        122 :                 if (ctx-&gt;on_period_reset)</span>
<span class="lineNum">     833 </span><span class="lineCov">          2 :                         ctx-&gt;on_period_reset(ctx-&gt;rt_udta, gf_dash_is_dynamic_mpd(ctx-&gt;dash) ? 2 : 1);</span>
<span class="lineNum">     834 </span>            : #ifdef GPAC_HAS_QJS
<span class="lineNum">     835 </span><span class="lineCov">        120 :                 else if (ctx-&gt;js_ctx &amp;&amp; JS_IsFunction(ctx-&gt;js_ctx, ctx-&gt;period_reset_fun)) {</span>
<span class="lineNum">     836 </span>            :                         JSValue arg;
<span class="lineNum">     837 </span><span class="lineCov">          2 :                         arg = JS_NewInt32(ctx-&gt;js_ctx, gf_dash_is_dynamic_mpd(ctx-&gt;dash) ? 2 : 1);</span>
<span class="lineNum">     838 </span><span class="lineCov">          1 :                         JSValue res = JS_Call(ctx-&gt;js_ctx, ctx-&gt;period_reset_fun, ctx-&gt;js_obj, 1, &amp;arg);</span>
<span class="lineNum">     839 </span><span class="lineCov">          1 :                         JS_FreeValue(ctx-&gt;js_ctx, res);</span>
<span class="lineNum">     840 </span>            :                 }
<span class="lineNum">     841 </span>            : #endif
<span class="lineNum">     842 </span>            : 
<span class="lineNum">     843 </span>            : 
<span class="lineNum">     844 </span>            :                 /*select input services if possible*/
<span class="lineNum">     845 </span><span class="lineCov">        260 :                 for (i=0; i&lt;gf_dash_get_group_count(ctx-&gt;dash); i++) {</span>
<span class="lineNum">     846 </span>            :                         const char *mime, *init_segment;
<span class="lineNum">     847 </span>            :                         u64 start_range, end_range;
<span class="lineNum">     848 </span>            :                         u32 j;
<span class="lineNum">     849 </span>            :                         Bool playable = GF_TRUE;
<span class="lineNum">     850 </span>            :                         //let the player decide which group to play
<span class="lineNum">     851 </span><span class="lineCov">        260 :                         if (!gf_dash_is_group_selectable(ctx-&gt;dash, i))</span>
<span class="lineNum">     852 </span><span class="lineCov">         63 :                                 continue;</span>
<span class="lineNum">     853 </span>            : 
<span class="lineNum">     854 </span><span class="lineCov">        260 :                         if (ctx-&gt;groupsel &amp;&amp; !gf_dash_is_group_selected(ctx-&gt;dash, i))</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     856 </span>            : 
<span class="lineNum">     857 </span>            :                         j=0;
<span class="lineNum">     858 </span><span class="lineCov">          7 :                         while (1) {</span>
<span class="lineNum">     859 </span>            :                                 const char *desc_id, *desc_scheme, *desc_value;
<span class="lineNum">     860 </span><span class="lineCov">        267 :                                 if (! gf_dash_group_enum_descriptor(ctx-&gt;dash, i, GF_MPD_DESC_ESSENTIAL_PROPERTIES, j, &amp;desc_id, &amp;desc_scheme, &amp;desc_value))</span>
<span class="lineNum">     861 </span>            :                                         break;
<span class="lineNum">     862 </span><span class="lineCov">          7 :                                 j++;</span>
<span class="lineNum">     863 </span><span class="lineCov">          7 :                                 if (!strcmp(desc_scheme, &quot;urn:mpeg:dash:srd:2014&quot;)) {</span>
<span class="lineNum">     864 </span>            :                                 } else {
<span class="lineNum">     865 </span>            :                                         playable = GF_FALSE;
<span class="lineNum">     866 </span>            :                                         break;
<span class="lineNum">     867 </span>            :                                 }
<span class="lineNum">     868 </span>            :                         }
<span class="lineNum">     869 </span><span class="lineCov">        260 :                         if (!playable) {</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :                                 gf_dash_group_select(ctx-&gt;dash, i, GF_FALSE);</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     872 </span>            :                         }
<span class="lineNum">     873 </span>            : 
<span class="lineNum">     874 </span><span class="lineCov">        260 :                         nb_groups_selected++;</span>
<span class="lineNum">     875 </span>            : 
<span class="lineNum">     876 </span><span class="lineCov">        260 :                         if (gf_dash_group_has_dependent_group(ctx-&gt;dash, i) &gt;=0 ) {</span>
<span class="lineNum">     877 </span><span class="lineCov">         63 :                                 gf_dash_group_select(ctx-&gt;dash, i, GF_TRUE);</span>
<span class="lineNum">     878 </span><span class="lineCov">         63 :                                 dashdmx_declare_group(ctx, i);</span>
<span class="lineNum">     879 </span><span class="lineCov">         63 :                                 continue;</span>
<span class="lineNum">     880 </span>            :                         }
<span class="lineNum">     881 </span>            : 
<span class="lineNum">     882 </span><span class="lineCov">        197 :                         mime = gf_dash_group_get_segment_mime(ctx-&gt;dash, i);</span>
<span class="lineNum">     883 </span><span class="lineCov">        197 :                         init_segment = gf_dash_group_get_segment_init_url(ctx-&gt;dash, i, &amp;start_range, &amp;end_range);</span>
<span class="lineNum">     884 </span>            : 
<span class="lineNum">     885 </span><span class="lineCov">        197 :                         e = dashdmx_load_source(ctx, i, mime, init_segment, start_range, end_range);</span>
<span class="lineNum">     886 </span><span class="lineCov">        197 :                         if (e != GF_OK) {</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :                                 gf_dash_group_select(ctx-&gt;dash, i, GF_FALSE);</span>
<span class="lineNum">     888 </span>            :                         } else {
<span class="lineNum">     889 </span>            :                                 u32 w, h;
<span class="lineNum">     890 </span>            :                                 /*connect our media service*/
<span class="lineNum">     891 </span><span class="lineCov">        197 :                                 gf_dash_group_get_video_info(ctx-&gt;dash, i, &amp;w, &amp;h);</span>
<span class="lineNum">     892 </span><span class="lineCov">        197 :                                 if (w &amp;&amp; h &amp;&amp; w&gt;ctx-&gt;width &amp;&amp; h&gt;ctx-&gt;height) {</span>
<span class="lineNum">     893 </span><span class="lineCov">        114 :                                         ctx-&gt;width = w;</span>
<span class="lineNum">     894 </span><span class="lineCov">        114 :                                         ctx-&gt;height = h;</span>
<span class="lineNum">     895 </span>            :                                 }
<span class="lineNum">     896 </span><span class="lineCov">        197 :                                 if (gf_dash_group_get_srd_max_size_info(ctx-&gt;dash, i, &amp;w, &amp;h)) {</span>
<span class="lineNum">     897 </span><span class="lineCov">          7 :                                         ctx-&gt;width = w;</span>
<span class="lineNum">     898 </span><span class="lineCov">          7 :                                         ctx-&gt;height = h;</span>
<span class="lineNum">     899 </span>            :                                 }
<span class="lineNum">     900 </span><span class="lineCov">        197 :                                 dashdmx_declare_group(ctx, i);</span>
<span class="lineNum">     901 </span>            :                         }
<span class="lineNum">     902 </span>            :                 }
<span class="lineNum">     903 </span>            : 
<span class="lineNum">     904 </span><span class="lineCov">        122 :                 if (!ctx-&gt;initial_setup_done) {</span>
<span class="lineNum">     905 </span><span class="lineCov">        118 :                         ctx-&gt;initial_setup_done = GF_TRUE;</span>
<span class="lineNum">     906 </span>            :                 }
<span class="lineNum">     907 </span>            : 
<span class="lineNum">     908 </span><span class="lineCov">        122 :                 if (!nb_groups_selected) {</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[DASHDmx] No groups selectable, not playing !\n&quot;));</span>
<span class="lineNum">     910 </span>            :                 }
<span class="lineNum">     911 </span>            : 
<span class="lineNum">     912 </span>            : 
<span class="lineNum">     913 </span>            :                 //we had a seek outside of the period we were setting up, during period setup !
<span class="lineNum">     914 </span>            :                 //request the seek again from the player
<span class="lineNum">     915 </span>            :                 if (ctx-&gt;seek_request&gt;=0) {
<span class="lineNum">     916 </span>            : #ifdef FILTER_FIXME
<span class="lineNum">     917 </span>            :                         GF_NetworkCommand com;
<span class="lineNum">     918 </span>            :                         memset(&amp;com, 0, sizeof(GF_NetworkCommand));
<span class="lineNum">     919 </span>            :                         com.command_type = GF_NET_SERVICE_SEEK;
<span class="lineNum">     920 </span>            :                         com.play.start_range = ctx-&gt;seek_request;
<span class="lineNum">     921 </span>            :                         ctx-&gt;seek_request = 0;
<span class="lineNum">     922 </span>            :                         gf_service_command(ctx-&gt;service, &amp;com, GF_OK);
<span class="lineNum">     923 </span>            : #endif
<span class="lineNum">     924 </span>            : 
<span class="lineNum">     925 </span>            :                 }
<span class="lineNum">     926 </span><span class="lineCov">        122 :                 return GF_OK;</span>
<span class="lineNum">     927 </span>            :         }
<span class="lineNum">     928 </span>            : 
<span class="lineNum">     929 </span>            :         /*for all running services, stop service*/
<span class="lineNum">     930 </span><span class="lineCov">      51265 :         if (dash_evt==GF_DASH_EVENT_DESTROY_PLAYBACK) {</span>
<span class="lineNum">     931 </span><span class="lineCov">        262 :                 for (i=0; i&lt;gf_dash_get_group_count(ctx-&gt;dash); i++) {</span>
<span class="lineNum">     932 </span><span class="lineCov">        262 :                         GF_DASHGroup *group = gf_dash_get_group_udta(ctx-&gt;dash, i);</span>
<span class="lineNum">     933 </span><span class="lineCov">        262 :                         if (!group) continue;</span>
<span class="lineNum">     934 </span><span class="lineCov">        197 :                         if (group-&gt;seg_filter_src) {</span>
<span class="lineNum">     935 </span><span class="lineCov">        197 :                                 gf_filter_remove_src(ctx-&gt;filter, group-&gt;seg_filter_src);</span>
<span class="lineNum">     936 </span><span class="lineCov">        197 :                                 group-&gt;seg_filter_src = NULL;</span>
<span class="lineNum">     937 </span>            :                         }
<span class="lineNum">     938 </span><span class="lineCov">        197 :                         if (group-&gt;template) gf_free(group-&gt;template);</span>
<span class="lineNum">     939 </span><span class="lineCov">        197 :                         gf_free(group);</span>
<span class="lineNum">     940 </span><span class="lineCov">        197 :                         gf_dash_set_group_udta(ctx-&gt;dash, i, NULL);</span>
<span class="lineNum">     941 </span>            :                 }
<span class="lineNum">     942 </span><span class="lineCov">        275 :                 for (i=0; i&lt;gf_filter_get_opid_count(ctx-&gt;filter); i++) {</span>
<span class="lineNum">     943 </span><span class="lineCov">        275 :                         GF_FilterPid *opid = gf_filter_get_opid(ctx-&gt;filter, i);</span>
<span class="lineNum">     944 </span><span class="lineCov">        275 :                         gf_filter_pid_set_udta(opid, NULL);</span>
<span class="lineNum">     945 </span>            :                 }
<span class="lineNum">     946 </span>            : 
<span class="lineNum">     947 </span><span class="lineCov">        244 :                 if (ctx-&gt;on_period_reset)</span>
<span class="lineNum">     948 </span><span class="lineCov">          4 :                         ctx-&gt;on_period_reset(ctx-&gt;rt_udta, 0);</span>
<span class="lineNum">     949 </span>            : #ifdef GPAC_HAS_QJS
<span class="lineNum">     950 </span><span class="lineCov">        240 :                 else if (ctx-&gt;js_ctx &amp;&amp; JS_IsFunction(ctx-&gt;js_ctx, ctx-&gt;period_reset_fun)) {</span>
<span class="lineNum">     951 </span><span class="lineCov">          4 :                         JSValue arg = JS_NewInt32(ctx-&gt;js_ctx, 0);</span>
<span class="lineNum">     952 </span><span class="lineCov">          2 :                         JSValue res = JS_Call(ctx-&gt;js_ctx, ctx-&gt;period_reset_fun, ctx-&gt;js_obj, 1, &amp;arg);</span>
<span class="lineNum">     953 </span><span class="lineCov">          2 :                         JS_FreeValue(ctx-&gt;js_ctx, res);</span>
<span class="lineNum">     954 </span>            :                 }
<span class="lineNum">     955 </span>            : #endif
<span class="lineNum">     956 </span>            : 
<span class="lineNum">     957 </span>            :                 return GF_OK;
<span class="lineNum">     958 </span>            :         }
<span class="lineNum">     959 </span><span class="lineCov">      51021 :         if (dash_evt==GF_DASH_EVENT_ABORT_DOWNLOAD) {</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :                 GF_DASHGroup *group = gf_dash_get_group_udta(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :                 if (group) {</span>
<span class="lineNum">     962 </span>            :                         GF_FilterEvent evt;
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :                         GF_FEVT_INIT(evt, GF_FEVT_SOURCE_SWITCH,  NULL);</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :                         evt.seek.start_offset = -1;</span>
<span class="lineNum">     965 </span>            :                         evt.seek.source_switch = NULL;
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :                         gf_filter_send_event(group-&gt;seg_filter_src, &amp;evt, GF_FALSE);</span>
<span class="lineNum">     967 </span>            :                 }
<span class="lineNum">     968 </span>            :                 return GF_OK;
<span class="lineNum">     969 </span>            :         }
<span class="lineNum">     970 </span>            : 
<span class="lineNum">     971 </span><span class="lineCov">      51021 :         if (dash_evt==GF_DASH_EVENT_QUALITY_SWITCH) {</span>
<span class="lineNum">     972 </span><span class="lineCov">        518 :                 if (group_idx&gt;=0) {</span>
<span class="lineNum">     973 </span><span class="lineCov">        518 :                         GF_DASHGroup *group = gf_dash_get_group_udta(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">     974 </span><span class="lineCov">        518 :                         if (!group) {</span>
<span class="lineNum">     975 </span><span class="lineCov">        268 :                                 group_idx = gf_dash_group_has_dependent_group(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">     976 </span><span class="lineCov">        268 :                                 group = gf_dash_get_group_udta(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">     977 </span>            :                         }
<span class="lineNum">     978 </span><span class="lineCov">        518 :                         if (group) {</span>
<span class="lineNum">     979 </span><span class="lineCov">        762 :                                 for (i=0; i&lt;gf_filter_get_opid_count(ctx-&gt;filter); i++) {</span>
<span class="lineNum">     980 </span>            :                                         s32 sel = -1;
<span class="lineNum">     981 </span><span class="lineCov">        762 :                                         GF_FilterPid *opid = gf_filter_get_opid(ctx-&gt;filter, i);</span>
<span class="lineNum">     982 </span><span class="lineCov">        762 :                                         if (gf_filter_pid_get_udta(opid) != group) continue;</span>
<span class="lineNum">     983 </span>            : 
<span class="lineNum">     984 </span><span class="lineCov">        561 :                                         sel = gf_dash_group_get_active_quality(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">     985 </span><span class="lineCov">        561 :                                         if (!gf_sys_is_test_mode() || (ctx-&gt;forward==DFWD_FILE)) {</span>
<span class="lineNum">     986 </span><span class="lineCov">        411 :                                                 if (sel&gt;=0) {</span>
<span class="lineNum">     987 </span><span class="lineCov">        411 :                                                         gf_filter_pid_set_property_str(opid, &quot;has:selected&quot;, &amp;PROP_UINT(sel) );</span>
<span class="lineNum">     988 </span>            :                                                 }
<span class="lineNum">     989 </span><span class="lineCov">        411 :                                                 gf_filter_pid_set_property_str(opid, &quot;has:auto&quot;, &amp;PROP_UINT(gf_dash_get_automatic_switching(ctx-&gt;dash) ) );</span>
<span class="lineNum">     990 </span><span class="lineCov">        411 :                                                 gf_filter_pid_set_property_str(opid, &quot;has:tilemode&quot;, &amp;PROP_UINT(gf_dash_get_tile_adaptation_mode(ctx-&gt;dash) ) );</span>
<span class="lineNum">     991 </span>            :                                         }
<span class="lineNum">     992 </span>            : 
<span class="lineNum">     993 </span>            :                                         //setup some info for consuming filters
<span class="lineNum">     994 </span><span class="lineCov">        561 :                                         if (ctx-&gt;forward) {</span>
<span class="lineNum">     995 </span>            :                                                 GF_DASHQualityInfo q;
<span class="lineNum">     996 </span>            : 
<span class="lineNum">     997 </span>            :                                                 //we dispatch timing in milliseconds
<span class="lineNum">     998 </span><span class="lineCov">         78 :                                                 if (ctx-&gt;forward==DFWD_FILE) {</span>
<span class="lineNum">     999 </span><span class="lineCov">         33 :                                                         gf_filter_pid_set_property(opid, GF_PROP_PID_TIMESCALE, &amp;PROP_UINT(1000));</span>
<span class="lineNum">    1000 </span>            :                                                 }
<span class="lineNum">    1001 </span>            : 
<span class="lineNum">    1002 </span><span class="lineCov">         78 :                                                 if (gf_dash_group_get_quality_info(ctx-&gt;dash, group_idx, sel, &amp;q)==GF_OK) {</span>
<span class="lineNum">    1003 </span><span class="lineCov">         78 :                                                         if (q.bandwidth)</span>
<span class="lineNum">    1004 </span><span class="lineCov">         75 :                                                                 gf_filter_pid_set_property(opid, GF_PROP_PID_BITRATE, &amp;PROP_UINT(q.bandwidth));</span>
<span class="lineNum">    1005 </span><span class="lineCov">         78 :                                                         if (q.codec)</span>
<span class="lineNum">    1006 </span><span class="lineCov">         75 :                                                                 gf_filter_pid_set_property(opid, GF_PROP_PID_CODEC, &amp;PROP_STRING(q.codec));</span>
<span class="lineNum">    1007 </span>            :                                                 }
<span class="lineNum">    1008 </span><span class="lineCov">         78 :                                                 if (group-&gt;template) gf_free(group-&gt;template);</span>
<span class="lineNum">    1009 </span><span class="lineCov">         78 :                                                 group-&gt;template = gf_dash_group_get_template(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">    1010 </span><span class="lineCov">         78 :                                                 if (!group-&gt;template) {</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :                                                         GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[DASHDmx] Cannot extract template string for %s\n&quot;, gf_dash_get_url(ctx-&gt;dash) ));</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :                                                         gf_filter_pid_set_property(opid, GF_PROP_PID_TEMPLATE, NULL);</span>
<span class="lineNum">    1013 </span>            :                                                 } else {
<span class="lineNum">    1014 </span><span class="lineCov">         78 :                                                         gf_filter_pid_set_property(opid, GF_PROP_PID_TEMPLATE, &amp;PROP_STRING(group-&gt;template) );</span>
<span class="lineNum">    1015 </span><span class="lineCov">         78 :                                                         char *sep = strchr(group-&gt;template, '$');</span>
<span class="lineNum">    1016 </span><span class="lineCov">         78 :                                                         if (sep) sep[0] = 0;</span>
<span class="lineNum">    1017 </span>            :                                                 }
<span class="lineNum">    1018 </span><span class="lineCov">         78 :                                                 if (ctx-&gt;forward==DFWD_FILE) {</span>
<span class="lineNum">    1019 </span>            :                                                         u32 dur, timescale;
<span class="lineNum">    1020 </span><span class="lineCov">         33 :                                                         gf_filter_pid_set_property(opid, GF_PROP_PID_REP_ID, &amp;PROP_STRING(q.ID) );</span>
<span class="lineNum">    1021 </span>            : 
<span class="lineNum">    1022 </span><span class="lineCov">         33 :                                                         gf_dash_group_get_segment_duration(ctx-&gt;dash, group-&gt;idx, &amp;dur, &amp;timescale);</span>
<span class="lineNum">    1023 </span><span class="lineCov">         33 :                                                         gf_filter_pid_set_property(opid, GF_PROP_PID_DASH_DUR, &amp;PROP_FRAC_INT(dur, timescale) );</span>
<span class="lineNum">    1024 </span>            : 
<span class="lineNum">    1025 </span>            :                                                 }
<span class="lineNum">    1026 </span>            :                                         }
<span class="lineNum">    1027 </span>            :                                 }
<span class="lineNum">    1028 </span>            :                         }
<span class="lineNum">    1029 </span>            :                 }
<span class="lineNum">    1030 </span>            :                 return GF_OK;
<span class="lineNum">    1031 </span>            :         }
<span class="lineNum">    1032 </span><span class="lineCov">      50503 :         if (dash_evt==GF_DASH_EVENT_TIMESHIFT_UPDATE) {</span>
<span class="lineNum">    1033 </span><span class="lineCov">        192 :                 Double timeshift = gf_dash_get_timeshift_buffer_pos(ctx-&gt;dash);</span>
<span class="lineNum">    1034 </span><span class="lineCov">        740 :                 for (i=0; i&lt;gf_filter_get_opid_count(ctx-&gt;filter); i++) {</span>
<span class="lineNum">    1035 </span><span class="lineCov">        548 :                         GF_FilterPid *opid = gf_filter_get_opid(ctx-&gt;filter, i);</span>
<span class="lineNum">    1036 </span><span class="lineCov">        548 :                         gf_filter_pid_set_info(opid, GF_PROP_PID_TIMESHIFT_TIME, &amp;PROP_DOUBLE(timeshift) );</span>
<span class="lineNum">    1037 </span>            :                 }
<span class="lineNum">    1038 </span>            :                 return GF_OK;
<span class="lineNum">    1039 </span>            :         }
<span class="lineNum">    1040 </span><span class="lineCov">      50311 :         if (dash_evt==GF_DASH_EVENT_TIMESHIFT_OVERFLOW) {</span>
<span class="lineNum">    1041 </span><span class="lineCov">        214 :                 u32 evttype = (group_idx&gt;=0) ? 2 : 1;</span>
<span class="lineNum">    1042 </span><span class="lineCov">        621 :                 for (i=0; i&lt;gf_filter_get_opid_count(ctx-&gt;filter); i++) {</span>
<span class="lineNum">    1043 </span><span class="lineCov">        407 :                         GF_FilterPid *opid = gf_filter_get_opid(ctx-&gt;filter, i);</span>
<span class="lineNum">    1044 </span><span class="lineCov">        407 :                         gf_filter_pid_set_info(opid, GF_PROP_PID_TIMESHIFT_STATE, &amp;PROP_UINT(evttype) );</span>
<span class="lineNum">    1045 </span>            :                 }
<span class="lineNum">    1046 </span>            :         }
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span><span class="lineCov">      50311 :         if (dash_evt==GF_DASH_EVENT_CODEC_STAT_QUERY) {</span>
<span class="lineNum">    1049 </span><span class="lineCov">       2467 :                 GF_DASHGroup *group = gf_dash_get_group_udta(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">    1050 </span><span class="lineCov">      17107 :                 for (i=0; i&lt;gf_filter_get_opid_count(ctx-&gt;filter); i++) {</span>
<span class="lineNum">    1051 </span><span class="lineCov">      15667 :                         GF_FilterPid *opid = gf_filter_get_opid(ctx-&gt;filter, i);</span>
<span class="lineNum">    1052 </span><span class="lineCov">      15667 :                         if (gf_filter_pid_get_udta(opid) == group) {</span>
<span class="lineNum">    1053 </span>            :                                 GF_FilterPidStatistics stats;
<span class="lineNum">    1054 </span>            :                                 Bool is_decoder = GF_TRUE;
<span class="lineNum">    1055 </span>            :                                 //collect decoder stats, or if not found direct output
<span class="lineNum">    1056 </span><span class="lineCov">       1027 :                                 if (gf_filter_pid_get_statistics(opid, &amp;stats, GF_STATS_DECODER_SINK) != GF_OK) {</span>
<span class="lineNum">    1057 </span>            :                                         is_decoder = GF_FALSE;
<span class="lineNum">    1058 </span><span class="lineCov">       1010 :                                         if (gf_filter_pid_get_statistics(opid, &amp;stats, GF_STATS_LOCAL_INPUTS) != GF_OK)</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :                                                 continue;</span>
<span class="lineNum">    1060 </span>            :                                 }
<span class="lineNum">    1061 </span>            : 
<span class="lineNum">    1062 </span><span class="lineCov">       1027 :                                 if (stats.disconnected)</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">    1064 </span>            : 
<span class="lineNum">    1065 </span><span class="lineCov">       1027 :                                 if (is_decoder) {</span>
<span class="lineNum">    1066 </span><span class="lineCov">         17 :                                         if (!stats.nb_processed) stats.nb_processed=1;</span>
<span class="lineNum">    1067 </span><span class="lineCov">         17 :                                         if (!stats.nb_saps) stats.nb_saps=1;</span>
<span class="lineNum">    1068 </span><span class="lineCov">         17 :                                         gf_dash_group_set_codec_stat(ctx-&gt;dash, group_idx, (u32) (stats.total_process_time/stats.nb_processed), stats.max_process_time, (u32) (stats.total_sap_process_time/stats.nb_saps), stats.max_sap_process_time, GF_FALSE, GF_FALSE);</span>
<span class="lineNum">    1069 </span>            :                                 }
<span class="lineNum">    1070 </span>            : 
<span class="lineNum">    1071 </span><span class="lineCov">       1027 :                                 gf_dash_group_set_buffer_levels(ctx-&gt;dash, group_idx, (u32) (stats.min_playout_time/1000), (u32) (stats.max_buffer_time/1000), (u32) (stats.buffer_time/1000) );</span>
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span><span class="lineCov">       1027 :                                 break;</span>
<span class="lineNum">    1074 </span>            :                         }
<span class="lineNum">    1075 </span>            :                 }
<span class="lineNum">    1076 </span>            :         }
<span class="lineNum">    1077 </span>            :         return GF_OK;
<a name="1078"><span class="lineNum">    1078 </span>            : }</a>
<span class="lineNum">    1079 </span>            : 
<span class="lineNum">    1080 </span><span class="lineCov">        259 : static void dashdmx_setup_buffer(GF_DASHDmxCtx *ctx, GF_DASHGroup *group)</span>
<span class="lineNum">    1081 </span>            : {
<span class="lineNum">    1082 </span>            :         u32 buffer_ms, play_buf_ms;
<span class="lineNum">    1083 </span><span class="lineCov">        259 :         gf_filter_get_output_buffer_max(ctx-&gt;filter, &amp;buffer_ms, &amp;play_buf_ms);</span>
<span class="lineNum">    1084 </span><span class="lineCov">        259 :         buffer_ms /= 1000;</span>
<span class="lineNum">    1085 </span><span class="lineCov">        259 :         play_buf_ms /= 1000;</span>
<span class="lineNum">    1086 </span>            : 
<span class="lineNum">    1087 </span>            :         //use min buffer from MPD
<span class="lineNum">    1088 </span><span class="lineCov">        259 :         if (ctx-&gt;use_bmin) {</span>
<span class="lineNum">    1089 </span><span class="lineCov">          2 :                 u64 mpd_buffer_ms = gf_dash_get_min_buffer_time(ctx-&gt;dash);</span>
<span class="lineNum">    1090 </span><span class="lineCov">          2 :                 if (mpd_buffer_ms &gt; buffer_ms)</span>
<span class="lineNum">    1091 </span><span class="lineCov">          2 :                         buffer_ms = (u32) mpd_buffer_ms;</span>
<span class="lineNum">    1092 </span>            :         }
<span class="lineNum">    1093 </span><span class="lineCov">        259 :         if (buffer_ms) {</span>
<span class="lineNum">    1094 </span><span class="lineCov">        259 :                 gf_dash_set_user_buffer(ctx-&gt;dash, buffer_ms);</span>
<span class="lineNum">    1095 </span>            :         }
<span class="lineNum">    1096 </span><span class="lineCov">        259 :         gf_dash_group_set_max_buffer_playout(ctx-&gt;dash, group-&gt;idx, play_buf_ms);</span>
<span class="lineNum">    1097 </span><span class="lineCov">        259 : }</span>
<a name="1098"><span class="lineNum">    1098 </span>            : </a>
<span class="lineNum">    1099 </span>            : /*check in all groups if the service can support reverse playback (speed&lt;0); return GF_OK only if service is supported in all groups*/
<span class="lineNum">    1100 </span><span class="lineCov">        553 : static u32 dashdmx_dash_playback_mode(GF_DASHDmxCtx *ctx)</span>
<span class="lineNum">    1101 </span>            : {
<span class="lineNum">    1102 </span><span class="lineCov">        553 :         u32 pmode, mode, i, count = gf_filter_get_ipid_count(ctx-&gt;filter);</span>
<span class="lineNum">    1103 </span>            :         mode = GF_PLAYBACK_MODE_REWIND;
<span class="lineNum">    1104 </span><span class="lineCov">       2304 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1105 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">    1106 </span><span class="lineCov">       2304 :                 GF_FilterPid *pid = gf_filter_get_ipid(ctx-&gt;filter, i);</span>
<span class="lineNum">    1107 </span><span class="lineCov">       2304 :                 if (ctx-&gt;mpd_pid == pid) continue;</span>
<span class="lineNum">    1108 </span>            : 
<span class="lineNum">    1109 </span><span class="lineCov">       1751 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_PLAYBACK_MODE);</span>
<span class="lineNum">    1110 </span><span class="lineCov">       1751 :                 pmode = p ? p-&gt;value.uint : GF_PLAYBACK_MODE_REWIND;</span>
<span class="lineNum">    1111 </span><span class="lineCov">       1751 :                 if (pmode &lt; mode) mode = pmode;</span>
<span class="lineNum">    1112 </span>            :         }
<span class="lineNum">    1113 </span><span class="lineCov">        553 :         return mode;</span>
<span class="lineNum">    1114 </span>            : }
<a name="1115"><span class="lineNum">    1115 </span>            : </a>
<span class="lineNum">    1116 </span>            : 
<span class="lineNum">    1117 </span><span class="lineCov">        553 : static s32 dashdmx_group_idx_from_pid(GF_DASHDmxCtx *ctx, GF_FilterPid *src_pid)</span>
<span class="lineNum">    1118 </span>            : {
<span class="lineNum">    1119 </span>            :         s32 i;
<span class="lineNum">    1120 </span>            : 
<span class="lineNum">    1121 </span><span class="lineCov">        134 :         for (i=0; (u32) i &lt; gf_dash_get_group_count(ctx-&gt;dash); i++) {</span>
<span class="lineNum">    1122 </span><span class="lineCov">        687 :                 GF_DASHGroup *group = gf_dash_get_group_udta(ctx-&gt;dash, i);</span>
<span class="lineNum">    1123 </span><span class="lineCov">        687 :                 if (!group) continue;</span>
<span class="lineNum">    1124 </span><span class="lineCov">        687 :                 if (gf_filter_pid_is_filter_in_parents(src_pid, group-&gt;seg_filter_src))</span>
<span class="lineNum">    1125 </span>            :                         return i;
<span class="lineNum">    1126 </span>            :         }
<span class="lineNum">    1127 </span>            :         return -1;
<a name="1128"><span class="lineNum">    1128 </span>            : }</a>
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span><span class="lineCov">        159 : static GF_FilterPid *dashdmx_opid_from_group(GF_DASHDmxCtx *ctx, GF_DASHGroup *group)</span>
<span class="lineNum">    1131 </span>            : {
<span class="lineNum">    1132 </span>            :         s32 i;
<span class="lineNum">    1133 </span>            : 
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :         for (i=0; (u32) i &lt; gf_filter_get_opid_count(ctx-&gt;filter); i++) {</span>
<span class="lineNum">    1135 </span><span class="lineCov">        159 :                 GF_FilterPid *opid = gf_filter_get_opid(ctx-&gt;filter, i );</span>
<span class="lineNum">    1136 </span><span class="lineCov">        159 :                 GF_DASHGroup *g = gf_filter_pid_get_udta( opid );</span>
<span class="lineNum">    1137 </span><span class="lineCov">        159 :                 if (g == group) return opid;</span>
<span class="lineNum">    1138 </span>            :         }
<span class="lineNum">    1139 </span>            :         return NULL;
<a name="1140"><span class="lineNum">    1140 </span>            : }</a>
<span class="lineNum">    1141 </span>            : 
<span class="lineNum">    1142 </span><span class="lineCov">        267 : static GF_FilterPid *dashdmx_create_output_pid(GF_DASHDmxCtx *ctx, GF_FilterPid *input, u32 *run_status)</span>
<span class="lineNum">    1143 </span>            : {
<span class="lineNum">    1144 </span>            :         u32 global_score=0;
<span class="lineNum">    1145 </span>            :         GF_FilterPid *output_pid = NULL;
<span class="lineNum">    1146 </span><span class="lineCov">        267 :         u32 i, count = gf_filter_get_opid_count(ctx-&gt;filter);</span>
<span class="lineNum">    1147 </span>            :         const GF_PropertyValue *codec, *streamtype, *role, *lang;
<span class="lineNum">    1148 </span>            : 
<span class="lineNum">    1149 </span><span class="lineCov">        267 :         *run_status = 0;</span>
<span class="lineNum">    1150 </span>            : 
<span class="lineNum">    1151 </span><span class="lineCov">        267 :         streamtype = gf_filter_pid_get_property(input, GF_PROP_PID_STREAM_TYPE);</span>
<span class="lineNum">    1152 </span><span class="lineCov">        267 :         if (streamtype &amp;&amp; streamtype-&gt;value.uint==GF_STREAM_ENCRYPTED)</span>
<span class="lineNum">    1153 </span><span class="lineCov">         19 :                 streamtype = gf_filter_pid_get_property(input, GF_PROP_PID_ORIG_STREAM_TYPE);</span>
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span><span class="lineCov">        267 :         codec = gf_filter_pid_get_property(input, GF_PROP_PID_CODECID);</span>
<span class="lineNum">    1156 </span><span class="lineCov">        267 :         role = gf_filter_pid_get_property(input, GF_PROP_PID_ROLE);</span>
<span class="lineNum">    1157 </span><span class="lineCov">        267 :         lang = gf_filter_pid_get_property(input, GF_PROP_PID_LANGUAGE);</span>
<span class="lineNum">    1158 </span>            : 
<span class="lineNum">    1159 </span><span class="lineCov">        429 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1160 </span>            :                 u32 score;
<span class="lineNum">    1161 </span>            :                 const GF_PropertyValue *o_codec, *o_streamtype, *o_role, *o_lang;
<span class="lineNum">    1162 </span><span class="lineCov">        429 :                 GF_FilterPid *opid = gf_filter_get_opid(ctx-&gt;filter, i);</span>
<span class="lineNum">    1163 </span>            :                 //in use by us
<span class="lineNum">    1164 </span><span class="lineCov">        429 :                 if (gf_filter_pid_get_udta(opid)) continue;</span>
<span class="lineNum">    1165 </span><span class="lineCov">         15 :                 if (opid == ctx-&gt;output_mpd_pid) continue;</span>
<span class="lineNum">    1166 </span>            : 
<span class="lineNum">    1167 </span><span class="lineCov">          8 :                 o_streamtype = gf_filter_pid_get_property(opid, GF_PROP_PID_STREAM_TYPE);</span>
<span class="lineNum">    1168 </span><span class="lineCov">          8 :                 if (o_streamtype &amp;&amp; o_streamtype-&gt;value.uint==GF_STREAM_ENCRYPTED)</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :                         o_streamtype = gf_filter_pid_get_property(opid, GF_PROP_PID_ORIG_STREAM_TYPE);</span>
<span class="lineNum">    1170 </span>            : 
<span class="lineNum">    1171 </span><span class="lineCov">          8 :                 o_codec = gf_filter_pid_get_property(opid, GF_PROP_PID_CODECID);</span>
<span class="lineNum">    1172 </span><span class="lineCov">          8 :                 o_role = gf_filter_pid_get_property(opid, GF_PROP_PID_ROLE);</span>
<span class="lineNum">    1173 </span><span class="lineCov">          8 :                 o_lang = gf_filter_pid_get_property(opid, GF_PROP_PID_LANGUAGE);</span>
<span class="lineNum">    1174 </span>            : 
<span class="lineNum">    1175 </span><span class="lineCov">          8 :                 if (!o_streamtype || !streamtype || !gf_props_equal(streamtype, o_streamtype))</span>
<span class="lineNum">    1176 </span><span class="lineCov">          2 :                         continue;</span>
<span class="lineNum">    1177 </span>            : 
<span class="lineNum">    1178 </span>            :                 score = 1;
<span class="lineNum">    1179 </span>            :                 //get highest priority for streams with same role
<span class="lineNum">    1180 </span><span class="lineCov">          6 :                 if (o_role &amp;&amp; role &amp;&amp; gf_props_equal(role, o_role)) score += 10;</span>
<span class="lineNum">    1181 </span>            :                 //then high priority for streams with same lang
<span class="lineNum">    1182 </span><span class="lineCov">          6 :                 if (o_lang &amp;&amp; lang &amp;&amp; gf_props_equal(lang, o_lang)) score += 5;</span>
<span class="lineNum">    1183 </span>            : 
<span class="lineNum">    1184 </span>            :                 //otherwise favour streams with same codec
<span class="lineNum">    1185 </span><span class="lineCov">          6 :                 if (!o_codec &amp;&amp; codec &amp;&amp; gf_props_equal(codec, o_codec)) score++;</span>
<span class="lineNum">    1186 </span>            : 
<span class="lineNum">    1187 </span><span class="lineCov">          6 :                 if (global_score&lt;score) {</span>
<span class="lineNum">    1188 </span>            :                         global_score = score;
<span class="lineNum">    1189 </span>            :                         output_pid = opid;
<span class="lineNum">    1190 </span>            :                 }
<span class="lineNum">    1191 </span>            :         }
<span class="lineNum">    1192 </span><span class="lineCov">        267 :         if (output_pid) {</span>
<span class="lineNum">    1193 </span><span class="lineCov">          6 :                 *run_status = gf_filter_pid_is_playing(output_pid) ? 1 : 2;</span>
<span class="lineNum">    1194 </span>            :                 return output_pid;
<span class="lineNum">    1195 </span>            :         }
<span class="lineNum">    1196 </span>            :         //none found create a new PID
<span class="lineNum">    1197 </span><span class="lineCov">        261 :         return gf_filter_pid_new(ctx-&gt;filter);</span>
<a name="1198"><span class="lineNum">    1198 </span>            : }</a>
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span><span class="lineCov">       3918 : Bool dashdmx_merge_prop(void *cbk, u32 prop_4cc, const char *prop_name, const GF_PropertyValue *src_prop)</span>
<span class="lineNum">    1201 </span>            : {
<span class="lineNum">    1202 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">    1203 </span>            :         GF_FilterPid *pid = (GF_FilterPid *) cbk;
<span class="lineNum">    1204 </span>            : 
<span class="lineNum">    1205 </span><span class="lineCov">       3918 :         if (prop_4cc) p = gf_filter_pid_get_property(pid, prop_4cc);</span>
<span class="lineNum">    1206 </span><span class="lineCov">         60 :         else p = gf_filter_pid_get_property_str(pid, prop_name);</span>
<span class="lineNum">    1207 </span><span class="lineCov">       3918 :         if (p) return GF_FALSE;</span>
<span class="lineNum">    1208 </span><span class="lineCov">         56 :         return GF_TRUE;</span>
<a name="1209"><span class="lineNum">    1209 </span>            : }</a>
<span class="lineNum">    1210 </span>            : 
<span class="lineNum">    1211 </span><span class="lineCov">        553 : static void dashdmx_declare_properties(GF_DASHDmxCtx *ctx, GF_DASHGroup *group, u32 group_idx, GF_FilterPid *opid, GF_FilterPid *ipid, Bool is_period_switch)</span>
<span class="lineNum">    1212 </span>            : {
<span class="lineNum">    1213 </span>            :         GF_DASHQualityInfo qinfo;
<span class="lineNum">    1214 </span>            :         GF_PropertyValue qualities, srd, srdref;
<span class="lineNum">    1215 </span>            :         GF_Err e;
<span class="lineNum">    1216 </span>            :         u32 stream_type = GF_STREAM_UNKNOWN;
<span class="lineNum">    1217 </span>            :         u32 count, i;
<span class="lineNum">    1218 </span>            :         u32 dur, mode;
<span class="lineNum">    1219 </span>            : 
<span class="lineNum">    1220 </span><span class="lineCov">        553 :         gf_filter_pid_copy_properties(opid, ipid);</span>
<span class="lineNum">    1221 </span>            : 
<span class="lineNum">    1222 </span><span class="lineCov">        553 :         if (!group-&gt;nb_group_deps) {</span>
<span class="lineNum">    1223 </span>            :                 s32 asid;
<span class="lineNum">    1224 </span>            :                 char as_name[100];
<span class="lineNum">    1225 </span><span class="lineCov">        413 :                 asid = gf_dash_group_get_as_id(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">    1226 </span>            :                 //TODO: remove and regenerate hashes
<span class="lineNum">    1227 </span><span class="lineCov">        413 :                 if (gf_sys_is_test_mode() &amp;&amp; (asid&lt;=0)) {</span>
<span class="lineNum">    1228 </span><span class="lineCov">        368 :                         sprintf(as_name, &quot;AS%d&quot;, group_idx+1);</span>
<span class="lineNum">    1229 </span><span class="lineCov">         45 :                 } else if (asid&lt;0) {</span>
<span class="lineNum">    1230 </span><span class="lineCov">          5 :                         sprintf(as_name, &quot;AS_%d&quot;, group_idx+1);</span>
<span class="lineNum">    1231 </span>            :                 } else {
<span class="lineNum">    1232 </span>            :                         sprintf(as_name, &quot;AS%d&quot;, asid);
<span class="lineNum">    1233 </span>            :                 }
<span class="lineNum">    1234 </span><span class="lineCov">        413 :                 gf_filter_pid_set_name(opid, as_name);</span>
<span class="lineNum">    1235 </span>            :         }
<span class="lineNum">    1236 </span>            : 
<span class="lineNum">    1237 </span><span class="lineCov">        553 :         mode = dashdmx_dash_playback_mode(ctx);</span>
<span class="lineNum">    1238 </span><span class="lineCov">        553 :         gf_filter_pid_set_property(opid, GF_PROP_PID_PLAYBACK_MODE, &amp;PROP_UINT(mode));</span>
<span class="lineNum">    1239 </span>            : 
<span class="lineNum">    1240 </span><span class="lineCov">        553 :         if (ctx-&gt;max_res &amp;&amp; gf_filter_pid_get_property(ipid, GF_PROP_PID_WIDTH)) {</span>
<span class="lineNum">    1241 </span><span class="lineCov">        445 :                 gf_filter_pid_set_property(opid, GF_PROP_SERVICE_WIDTH, &amp;PROP_UINT(ctx-&gt;width));</span>
<span class="lineNum">    1242 </span><span class="lineCov">        445 :                 gf_filter_pid_set_property(opid, GF_PROP_SERVICE_HEIGHT, &amp;PROP_UINT(ctx-&gt;height));</span>
<span class="lineNum">    1243 </span>            :         }
<span class="lineNum">    1244 </span>            : 
<span class="lineNum">    1245 </span><span class="lineCov">        553 :         dur = (u32) (1000*gf_dash_get_duration(ctx-&gt;dash) );</span>
<span class="lineNum">    1246 </span><span class="lineCov">        553 :         if (dur&gt;0)</span>
<span class="lineNum">    1247 </span><span class="lineCov">        463 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_DURATION, &amp;PROP_FRAC64_INT(dur, 1000) );</span>
<span class="lineNum">    1248 </span>            :         else
<span class="lineNum">    1249 </span><span class="lineCov">         90 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_DURATION, NULL);</span>
<span class="lineNum">    1250 </span>            : 
<span class="lineNum">    1251 </span><span class="lineCov">        553 :         dur = (1000*gf_dash_group_get_time_shift_buffer_depth(ctx-&gt;dash, group_idx) );</span>
<span class="lineNum">    1252 </span><span class="lineCov">        553 :         if (dur&gt;0)</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_TIMESHIFT_DEPTH, &amp;PROP_FRAC_INT(dur, 1000) );</span>
<span class="lineNum">    1254 </span>            : 
<span class="lineNum">    1255 </span>            : 
<span class="lineNum">    1256 </span><span class="lineCov">        553 :         if (ctx-&gt;use_bmin) {</span>
<span class="lineNum">    1257 </span><span class="lineCov">          3 :                 u32 max = gf_dash_get_min_buffer_time(ctx-&gt;dash);</span>
<span class="lineNum">    1258 </span><span class="lineCov">          3 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_PLAY_BUFFER, &amp;PROP_UINT(max));</span>
<span class="lineNum">    1259 </span>            :         }
<span class="lineNum">    1260 </span>            : 
<span class="lineNum">    1261 </span>            :         memset(&amp;qualities, 0, sizeof(GF_PropertyValue));
<span class="lineNum">    1262 </span><span class="lineCov">        553 :         qualities.type = GF_PROP_STRING_LIST;</span>
<span class="lineNum">    1263 </span>            : 
<span class="lineNum">    1264 </span><span class="lineCov">        553 :         count = gf_dash_group_get_num_qualities(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">    1265 </span><span class="lineCov">        821 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1266 </span>            :                 char szInfo[500];
<span class="lineNum">    1267 </span><span class="lineCov">        821 :                 char *qdesc = NULL;</span>
<span class="lineNum">    1268 </span>            : 
<span class="lineNum">    1269 </span><span class="lineCov">        821 :                 e = gf_dash_group_get_quality_info(ctx-&gt;dash, group_idx, i, &amp;qinfo);</span>
<span class="lineNum">    1270 </span><span class="lineCov">        821 :                 if (e) break;</span>
<span class="lineNum">    1271 </span><span class="lineCov">        821 :                 if (!qinfo.ID) qinfo.ID=&quot;&quot;;</span>
<span class="lineNum">    1272 </span><span class="lineCov">        821 :                 if (!qinfo.mime) qinfo.mime=&quot;unknown&quot;;</span>
<span class="lineNum">    1273 </span><span class="lineCov">        821 :                 if (!qinfo.codec) qinfo.codec=&quot;codec&quot;;</span>
<span class="lineNum">    1274 </span>            : 
<span class="lineNum">    1275 </span><span class="lineCov">        821 :                 if (qinfo.width &amp;&amp; qinfo.height) {</span>
<span class="lineNum">    1276 </span>            :                         stream_type = GF_STREAM_VISUAL;
<span class="lineNum">    1277 </span><span class="lineCov">        102 :                 } else if (qinfo.sample_rate || qinfo.nb_channels) {</span>
<span class="lineNum">    1278 </span>            :                         stream_type = GF_STREAM_AUDIO;
<span class="lineNum">    1279 </span><span class="lineCov">         25 :                 } else if (strstr(qinfo.mime, &quot;text&quot;)</span>
<span class="lineNum">    1280 </span><span class="lineCov">         25 :                         || strstr(qinfo.codec, &quot;vtt&quot;)</span>
<span class="lineNum">    1281 </span><span class="lineCov">         23 :                         || strstr(qinfo.codec, &quot;srt&quot;)</span>
<span class="lineNum">    1282 </span><span class="lineCov">         23 :                         || strstr(qinfo.codec, &quot;text&quot;)</span>
<span class="lineNum">    1283 </span><span class="lineCov">         23 :                         || strstr(qinfo.codec, &quot;tx3g&quot;)</span>
<span class="lineNum">    1284 </span><span class="lineCov">         22 :                         || strstr(qinfo.codec, &quot;stxt&quot;)</span>
<span class="lineNum">    1285 </span><span class="lineCov">         22 :                         || strstr(qinfo.codec, &quot;stpp&quot;)</span>
<span class="lineNum">    1286 </span>            :                 ) {
<span class="lineNum">    1287 </span>            :                         stream_type = GF_STREAM_TEXT;
<span class="lineNum">    1288 </span>            :                 }
<span class="lineNum">    1289 </span>            : 
<span class="lineNum">    1290 </span><span class="lineCov">        821 :                 snprintf(szInfo, 500, &quot;id=%s&quot;, qinfo.ID);</span>
<span class="lineNum">    1291 </span>            : 
<span class="lineNum">    1292 </span><span class="lineCov">        821 :                 e = gf_dynstrcat(&amp;qdesc, szInfo, &quot;::&quot;);</span>
<span class="lineNum">    1293 </span><span class="lineCov">        821 :                 if (e) break;</span>
<span class="lineNum">    1294 </span>            : 
<span class="lineNum">    1295 </span><span class="lineCov">        821 :                 snprintf(szInfo, 500, &quot;codec=%s&quot;, qinfo.codec);</span>
<span class="lineNum">    1296 </span><span class="lineCov">        821 :                 e = gf_dynstrcat(&amp;qdesc, szInfo, &quot;::&quot;);</span>
<span class="lineNum">    1297 </span><span class="lineCov">        821 :                 if (e) break;</span>
<span class="lineNum">    1298 </span>            : 
<span class="lineNum">    1299 </span><span class="lineCov">        821 :                 snprintf(szInfo, 500, &quot;mime=%s&quot;, qinfo.mime);</span>
<span class="lineNum">    1300 </span><span class="lineCov">        821 :                 e = gf_dynstrcat(&amp;qdesc, szInfo, &quot;::&quot;);</span>
<span class="lineNum">    1301 </span><span class="lineCov">        821 :                 if (e) break;</span>
<span class="lineNum">    1302 </span>            : 
<span class="lineNum">    1303 </span><span class="lineCov">        821 :                 snprintf(szInfo, 500, &quot;bw=%d&quot;, qinfo.bandwidth);</span>
<span class="lineNum">    1304 </span><span class="lineCov">        821 :                 e = gf_dynstrcat(&amp;qdesc, szInfo, &quot;::&quot;);</span>
<span class="lineNum">    1305 </span><span class="lineCov">        821 :                 if (e) break;</span>
<span class="lineNum">    1306 </span>            : 
<span class="lineNum">    1307 </span><span class="lineCov">        821 :                 if (qinfo.disabled) {</span>
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :                         e = gf_dynstrcat(&amp;qdesc, &quot;disabled&quot;, &quot;::&quot;);</span>
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :                         if (e) break;</span>
<span class="lineNum">    1310 </span>            :                 }
<span class="lineNum">    1311 </span>            : 
<span class="lineNum">    1312 </span><span class="lineCov">        821 :                 if (qinfo.width &amp;&amp; qinfo.height) {</span>
<span class="lineNum">    1313 </span>            :                         snprintf(szInfo, 500, &quot;w=%d&quot;, qinfo.width);
<span class="lineNum">    1314 </span><span class="lineCov">        719 :                         e = gf_dynstrcat(&amp;qdesc, szInfo, &quot;::&quot;);</span>
<span class="lineNum">    1315 </span><span class="lineCov">        719 :                         if (e) break;</span>
<span class="lineNum">    1316 </span>            : 
<span class="lineNum">    1317 </span><span class="lineCov">        719 :                         snprintf(szInfo, 500, &quot;h=%d&quot;, qinfo.height);</span>
<span class="lineNum">    1318 </span><span class="lineCov">        719 :                         e = gf_dynstrcat(&amp;qdesc, szInfo, &quot;::&quot;);</span>
<span class="lineNum">    1319 </span><span class="lineCov">        719 :                         if (e) break;</span>
<span class="lineNum">    1320 </span>            : 
<span class="lineNum">    1321 </span><span class="lineCov">        719 :                         if (qinfo.interlaced) {</span>
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :                                 e = gf_dynstrcat(&amp;qdesc, &quot;interlaced&quot;, &quot;::&quot;);</span>
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :                                 if (e) break;</span>
<span class="lineNum">    1324 </span>            :                         }
<span class="lineNum">    1325 </span><span class="lineCov">        719 :                         if (qinfo.fps_den) {</span>
<span class="lineNum">    1326 </span><span class="lineCov">        541 :                                 snprintf(szInfo, 500, &quot;fps=%d/%d&quot;, qinfo.fps_num, qinfo.fps_den);</span>
<span class="lineNum">    1327 </span>            :                         } else {
<span class="lineNum">    1328 </span><span class="lineCov">        178 :                                 snprintf(szInfo, 500, &quot;fps=%d&quot;, qinfo.fps_num);</span>
<span class="lineNum">    1329 </span>            :                         }
<span class="lineNum">    1330 </span><span class="lineCov">        719 :                         e = gf_dynstrcat(&amp;qdesc, szInfo, &quot;::&quot;);</span>
<span class="lineNum">    1331 </span><span class="lineCov">        719 :                         if (e) break;</span>
<span class="lineNum">    1332 </span>            : 
<span class="lineNum">    1333 </span><span class="lineCov">        719 :                         if (qinfo.par_den &amp;&amp; qinfo.par_num &amp;&amp; (qinfo.par_den != qinfo.par_num)) {</span>
<span class="lineNum">    1334 </span>            :                                 snprintf(szInfo, 500, &quot;sar=%d/%d&quot;, qinfo.par_num, qinfo.par_den);
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :                                 e = gf_dynstrcat(&amp;qdesc, szInfo, &quot;::&quot;);</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :                                 if (e) break;</span>
<span class="lineNum">    1337 </span>            :                         }
<span class="lineNum">    1338 </span>            :                 }
<span class="lineNum">    1339 </span><span class="lineCov">        821 :                 if (qinfo.sample_rate) {</span>
<span class="lineNum">    1340 </span>            :                         snprintf(szInfo, 500, &quot;sr=%d&quot;, qinfo.sample_rate);
<span class="lineNum">    1341 </span><span class="lineCov">         77 :                         e = gf_dynstrcat(&amp;qdesc, szInfo, &quot;::&quot;);</span>
<span class="lineNum">    1342 </span><span class="lineCov">         77 :                         if (e) break;</span>
<span class="lineNum">    1343 </span>            : 
<span class="lineNum">    1344 </span><span class="lineCov">         77 :                         snprintf(szInfo, 500, &quot;ch=%d&quot;, qinfo.nb_channels);</span>
<span class="lineNum">    1345 </span><span class="lineCov">         77 :                         e = gf_dynstrcat(&amp;qdesc, szInfo, &quot;::&quot;);</span>
<span class="lineNum">    1346 </span><span class="lineCov">         77 :                         if (e) break;</span>
<span class="lineNum">    1347 </span>            :                 }
<span class="lineNum">    1348 </span><span class="lineCov">        821 :                 qualities.value.string_list.vals = gf_realloc(qualities.value.string_list.vals, sizeof(char *) * (qualities.value.string_list.nb_items+1));</span>
<span class="lineNum">    1349 </span>            : 
<span class="lineNum">    1350 </span><span class="lineCov">        821 :                 qualities.value.string_list.vals[qualities.value.string_list.nb_items] = qdesc;</span>
<span class="lineNum">    1351 </span><span class="lineCov">        821 :                 qualities.value.string_list.nb_items++;</span>
<span class="lineNum">    1352 </span>            :                 qdesc = NULL;
<span class="lineNum">    1353 </span>            :         }
<span class="lineNum">    1354 </span><span class="lineCov">        553 :         gf_filter_pid_set_info_str(opid, &quot;has:qualities&quot;, &amp;qualities);</span>
<span class="lineNum">    1355 </span>            : 
<span class="lineNum">    1356 </span><span class="lineCov">        553 :         if ((ctx-&gt;forward==DFWD_FILE) &amp;&amp; (stream_type!=GF_STREAM_UNKNOWN)) {</span>
<span class="lineNum">    1357 </span><span class="lineCov">         33 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_ORIG_STREAM_TYPE, &amp;PROP_UINT(stream_type) );</span>
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span><span class="lineCov">         33 :                 gf_filter_pid_set_property(opid, GF_PROP_PCK_HLS_REF, &amp;PROP_LONGUINT( (u64) 1+group-&gt;idx) );</span>
<span class="lineNum">    1360 </span>            :         }
<span class="lineNum">    1361 </span>            : 
<span class="lineNum">    1362 </span>            :         const char *title, *source;
<span class="lineNum">    1363 </span><span class="lineCov">        553 :         gf_dash_get_info(ctx-&gt;dash, &amp;title, &amp;source);</span>
<span class="lineNum">    1364 </span><span class="lineCov">        553 :         gf_filter_pid_set_info(opid, GF_PROP_PID_SERVICE_NAME, &amp;PROP_STRING(title) );</span>
<span class="lineNum">    1365 </span><span class="lineCov">        553 :         gf_filter_pid_set_info(opid, GF_PROP_PID_SERVICE_PROVIDER, &amp;PROP_STRING(source) );</span>
<span class="lineNum">    1366 </span>            : 
<span class="lineNum">    1367 </span><span class="lineCov">        553 :         title = NULL;</span>
<span class="lineNum">    1368 </span><span class="lineCov">        553 :         gf_dash_group_enum_descriptor(ctx-&gt;dash, group_idx, GF_MPD_DESC_ROLE, 0, NULL, NULL, &amp;title);</span>
<span class="lineNum">    1369 </span><span class="lineCov">        553 :         if (title)</span>
<span class="lineNum">    1370 </span><span class="lineCov">          3 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_ROLE, &amp;PROP_STRING(title) );</span>
<span class="lineNum">    1371 </span>            : 
<span class="lineNum">    1372 </span><span class="lineCov">        553 :         title = NULL;</span>
<span class="lineNum">    1373 </span><span class="lineCov">        553 :         gf_dash_group_enum_descriptor(ctx-&gt;dash, group_idx, GF_MPD_DESC_ACCESSIBILITY, 0, NULL, NULL, &amp;title);</span>
<span class="lineNum">    1374 </span><span class="lineCov">        553 :         if (title)</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_property_str(opid, &quot;accessibility&quot;, &amp;PROP_STRING(title) );</span>
<span class="lineNum">    1376 </span>            : 
<span class="lineNum">    1377 </span><span class="lineCov">        553 :         title = NULL;</span>
<span class="lineNum">    1378 </span><span class="lineCov">        553 :         gf_dash_group_enum_descriptor(ctx-&gt;dash, group_idx, GF_MPD_DESC_RATING, 0, NULL, NULL, &amp;title);</span>
<span class="lineNum">    1379 </span><span class="lineCov">        553 :         if (title)</span>
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_property_str(opid, &quot;rating&quot;, &amp;PROP_STRING(title) );</span>
<span class="lineNum">    1381 </span>            : 
<span class="lineNum">    1382 </span><span class="lineCov">        553 :         if (!gf_sys_is_test_mode()) {</span>
<span class="lineNum">    1383 </span><span class="lineCov">         45 :                 gf_filter_pid_set_info_str(opid, &quot;ntpdiff&quot;, &amp;PROP_SINT(gf_dash_get_utc_drift_estimate(ctx-&gt;dash) ) );</span>
<span class="lineNum">    1384 </span>            :         }
<span class="lineNum">    1385 </span>            : 
<span class="lineNum">    1386 </span>            :         memset(&amp;srd, 0, sizeof(GF_PropertyValue));
<span class="lineNum">    1387 </span>            :         memset(&amp;srdref, 0, sizeof(GF_PropertyValue));
<span class="lineNum">    1388 </span><span class="lineCov">        553 :         srd.type = GF_PROP_VEC4I;</span>
<span class="lineNum">    1389 </span><span class="lineCov">        553 :         srdref.type = GF_PROP_VEC2I;</span>
<span class="lineNum">    1390 </span><span class="lineCov">        553 :         if (gf_dash_group_get_srd_info(ctx-&gt;dash, group_idx, NULL,</span>
<span class="lineNum">    1391 </span>            :                         &amp;srd.value.vec4i.x,
<span class="lineNum">    1392 </span>            :                         &amp;srd.value.vec4i.y,
<span class="lineNum">    1393 </span>            :                         &amp;srd.value.vec4i.z,
<span class="lineNum">    1394 </span>            :                         &amp;srd.value.vec4i.w,
<span class="lineNum">    1395 </span>            :                         &amp;srdref.value.vec2i.x,
<span class="lineNum">    1396 </span>            :                         &amp;srdref.value.vec2i.y)) {
<span class="lineNum">    1397 </span>            : 
<span class="lineNum">    1398 </span><span class="lineCov">        140 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_SRD, &amp;srd);</span>
<span class="lineNum">    1399 </span><span class="lineCov">        140 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_SRD_REF, &amp;srdref);</span>
<span class="lineNum">    1400 </span>            :         }
<span class="lineNum">    1401 </span>            : 
<span class="lineNum">    1402 </span>            :         //setup initial quality - this is disabled in test mode for the time being (invalidates all dash playback hashes)
<span class="lineNum">    1403 </span>            :         //in forward mode, always send the event to setup dash templates
<span class="lineNum">    1404 </span><span class="lineCov">        553 :         if (!gf_sys_is_test_mode() || ctx-&gt;forward)</span>
<span class="lineNum">    1405 </span><span class="lineCov">        123 :                 dashdmx_io_on_dash_event(&amp;ctx-&gt;dash_io, GF_DASH_EVENT_QUALITY_SWITCH, group-&gt;idx, GF_OK);</span>
<span class="lineNum">    1406 </span>            : 
<span class="lineNum">    1407 </span>            : 
<span class="lineNum">    1408 </span>            :         //if MPD file pid is defined, merge its properties. This will allow forwarding user-defined properties,
<span class="lineNum">    1409 </span>            :         // eg -i dash.mpd:#MyProp=toto to all PIDs coming from media sources
<span class="lineNum">    1410 </span><span class="lineCov">        553 :         if (ctx-&gt;mpd_pid) {</span>
<span class="lineNum">    1411 </span><span class="lineCov">        553 :                 gf_filter_pid_merge_properties(opid, ctx-&gt;mpd_pid, dashdmx_merge_prop, ipid);</span>
<span class="lineNum">    1412 </span>            :         }
<span class="lineNum">    1413 </span>            : 
<span class="lineNum">    1414 </span><span class="lineCov">        553 :         if (ctx-&gt;frag_url)</span>
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_ORIG_FRAG_URL, &amp;PROP_NAME(ctx-&gt;frag_url) );</span>
<span class="lineNum">    1416 </span>            : 
<span class="lineNum">    1417 </span><span class="lineCov">        553 :         if (stream_type == GF_STREAM_AUDIO) {</span>
<span class="lineNum">    1418 </span>            :                 Bool is_cont = GF_FALSE;
<span class="lineNum">    1419 </span><span class="lineCov">         65 :                 if (is_period_switch) {</span>
<span class="lineNum">    1420 </span>            :                         u32 j=0;
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :                         while (1) {</span>
<span class="lineNum">    1422 </span>            :                                 const char *desc_id, *desc_scheme, *desc_value;
<span class="lineNum">    1423 </span><span class="lineCov">          2 :                                 if (! gf_dash_group_enum_descriptor(ctx-&gt;dash, group_idx, GF_MPD_DESC_SUPPLEMENTAL_PROPERTIES, j, &amp;desc_id, &amp;desc_scheme, &amp;desc_value))</span>
<span class="lineNum">    1424 </span>            :                                         break;
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :                                 j++;</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :                                 if (!strcmp(desc_scheme, &quot;urn:mpeg:dash:period-continuity:2015&quot;) &amp;&amp; desc_value) {</span>
<span class="lineNum">    1427 </span>            :                                         is_cont = GF_TRUE;
<span class="lineNum">    1428 </span>            :                                         break;
<span class="lineNum">    1429 </span>            :                                 }
<span class="lineNum">    1430 </span>            :                         }
<span class="lineNum">    1431 </span>            :                 }
<span class="lineNum">    1432 </span><span class="lineCov">          2 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_NO_PRIMING, is_cont ? &amp;PROP_BOOL(GF_TRUE) : NULL);</span>
<span class="lineNum">    1433 </span>            :         }
<span class="lineNum">    1434 </span><span class="lineCov">        553 :         if (ctx-&gt;forward &gt; DFWD_FILE) {</span>
<span class="lineNum">    1435 </span>            :                 u64 pstart;
<span class="lineNum">    1436 </span>            :                 u32 timescale;
<span class="lineNum">    1437 </span><span class="lineCov">         45 :                 const char *str = NULL;</span>
<span class="lineNum">    1438 </span><span class="lineCov">         45 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_DASH_FWD, &amp;PROP_UINT( (ctx-&gt;forward - DFWD_FILE) ) );</span>
<span class="lineNum">    1439 </span><span class="lineCov">         45 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_DASH_CUE, &amp;PROP_STRING(&quot;inband&quot;) );</span>
<span class="lineNum">    1440 </span>            : 
<span class="lineNum">    1441 </span><span class="lineCov">         45 :                 gf_dash_group_get_segment_duration(ctx-&gt;dash, group-&gt;idx, &amp;dur, &amp;timescale);</span>
<span class="lineNum">    1442 </span><span class="lineCov">         45 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_DASH_DUR, &amp;PROP_FRAC_INT(dur, timescale) );</span>
<span class="lineNum">    1443 </span>            : 
<span class="lineNum">    1444 </span><span class="lineCov">         45 :                 gf_dash_group_next_seg_info(ctx-&gt;dash, group-&gt;idx, group-&gt;current_dependent_rep_idx, NULL, NULL, NULL, NULL, &amp;str);</span>
<span class="lineNum">    1445 </span><span class="lineCov">         45 :                 if (str) {</span>
<span class="lineNum">    1446 </span><span class="lineCov">         45 :                         gf_filter_pid_set_property(opid, GF_PROP_PCK_FILENAME, &amp;PROP_STRING(str) );</span>
<span class="lineNum">    1447 </span>            :                 }
<span class="lineNum">    1448 </span>            : 
<span class="lineNum">    1449 </span>            :                 //forward representation ID so that dasher will match muxed streams and identify streams in the MPD
<span class="lineNum">    1450 </span><span class="lineCov">         45 :                 str = gf_dash_group_get_representation_id(ctx-&gt;dash, group-&gt;idx);</span>
<span class="lineNum">    1451 </span><span class="lineCov">         45 :                 if (str) {</span>
<span class="lineNum">    1452 </span><span class="lineCov">         45 :                         gf_filter_pid_set_property(opid, GF_PROP_PID_REP_ID, &amp;PROP_STRING(str) );</span>
<span class="lineNum">    1453 </span>            :                 }
<span class="lineNum">    1454 </span><span class="lineCov">         45 :                 pstart = gf_dash_get_period_start(ctx-&gt;dash);</span>
<span class="lineNum">    1455 </span><span class="lineCov">         45 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_DASH_PERIOD_START, &amp;PROP_LONGUINT(pstart) );</span>
<span class="lineNum">    1456 </span>            :         }
<a name="1457"><span class="lineNum">    1457 </span><span class="lineCov">        553 : }</span></a>
<span class="lineNum">    1458 </span>            : 
<span class="lineNum">    1459 </span><span class="lineCov">        701 : static GF_Err dashdmx_configure_pid(GF_Filter *filter, GF_FilterPid *pid, Bool is_remove)</span>
<span class="lineNum">    1460 </span>            : {
<span class="lineNum">    1461 </span>            :         s32 group_idx;
<span class="lineNum">    1462 </span>            :         Bool is_period_switch = GF_FALSE;
<span class="lineNum">    1463 </span>            :         GF_FilterPid *opid;
<span class="lineNum">    1464 </span>            :         GF_Err e;
<span class="lineNum">    1465 </span><span class="lineCov">        701 :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx*) gf_filter_get_udta(filter);</span>
<span class="lineNum">    1466 </span>            :         GF_DASHGroup *group;
<span class="lineNum">    1467 </span>            : 
<span class="lineNum">    1468 </span><span class="lineCov">        701 :         if (is_remove) {</span>
<span class="lineNum">    1469 </span>            :                 //TODO
<span class="lineNum">    1470 </span><span class="lineCov">         30 :                 if (pid==ctx-&gt;mpd_pid) {</span>
<span class="lineNum">    1471 </span>            :                         u32 i;
<span class="lineNum">    1472 </span><span class="lineCov">         21 :                         for (i=0; i&lt;gf_filter_get_opid_count(filter); i++) {</span>
<span class="lineNum">    1473 </span><span class="lineCov">         21 :                                 opid = gf_filter_get_opid(filter, i);</span>
<span class="lineNum">    1474 </span><span class="lineCov">         21 :                                 group = gf_filter_pid_get_udta(opid);</span>
<span class="lineNum">    1475 </span><span class="lineCov">         21 :                                 if (group &amp;&amp; group-&gt;seg_filter_src) {</span>
<span class="lineNum">    1476 </span><span class="lineCov">         21 :                                         gf_filter_remove_src(filter, group-&gt;seg_filter_src);</span>
<span class="lineNum">    1477 </span>            :                                 }
<span class="lineNum">    1478 </span>            :                         }
<span class="lineNum">    1479 </span><span class="lineCov">          3 :                         gf_dash_close(ctx-&gt;dash);</span>
<span class="lineNum">    1480 </span><span class="lineCov">          3 :                         ctx-&gt;mpd_pid = NULL;</span>
<span class="lineNum">    1481 </span>            :                 } else {
<span class="lineNum">    1482 </span><span class="lineCov">         27 :                         opid = gf_filter_pid_get_udta(pid);</span>
<span class="lineNum">    1483 </span><span class="lineCov">         27 :                         if (opid) {</span>
<span class="lineNum">    1484 </span><span class="lineCov">         27 :                                 if (!ctx-&gt;mpd_pid) {</span>
<span class="lineNum">    1485 </span><span class="lineCov">         21 :                                         gf_filter_pid_remove(opid);</span>
<span class="lineNum">    1486 </span><span class="lineCov">          6 :                                 } else if (gf_dash_all_groups_done(ctx-&gt;dash) &amp;&amp; gf_dash_in_last_period(ctx-&gt;dash, GF_TRUE)) {</span>
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_remove(opid);</span>
<span class="lineNum">    1488 </span>            :                                 } else {
<span class="lineNum">    1489 </span><span class="lineCov">          6 :                                         gf_filter_pid_set_udta(opid, NULL);</span>
<span class="lineNum">    1490 </span><span class="lineCov">          6 :                                         gf_filter_pid_set_udta(pid, NULL);</span>
<span class="lineNum">    1491 </span>            :                                 }
<span class="lineNum">    1492 </span>            :                         }
<span class="lineNum">    1493 </span>            :                 }
<span class="lineNum">    1494 </span>            :                 return GF_OK;
<span class="lineNum">    1495 </span>            :         }
<span class="lineNum">    1496 </span><span class="lineCov">        671 :         if (! gf_filter_pid_check_caps(pid)) {</span>
<span class="lineNum">    1497 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[DASHDmx] Mismatch in input pid caps\n&quot;));</span>
<span class="lineNum">    1498 </span>            :                 return GF_NOT_SUPPORTED;
<span class="lineNum">    1499 </span>            :         }
<span class="lineNum">    1500 </span>            : 
<span class="lineNum">    1501 </span>            :         //configure MPD pid
<span class="lineNum">    1502 </span><span class="lineCov">        671 :         if (!ctx-&gt;mpd_pid) {</span>
<span class="lineNum">    1503 </span>            :                 char *frag;
<span class="lineNum">    1504 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">    1505 </span><span class="lineCov">        118 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_URL);</span>
<span class="lineNum">    1506 </span><span class="lineCov">        118 :                 if (!p || !p-&gt;value.string) {</span>
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[DASHDmx] no URL on MPD pid\n&quot;));</span>
<span class="lineNum">    1508 </span>            :                         return GF_NOT_SUPPORTED;
<span class="lineNum">    1509 </span>            :                 }
<span class="lineNum">    1510 </span>            : 
<span class="lineNum">    1511 </span><span class="lineCov">        118 :                 gf_filter_pid_set_framing_mode(pid, GF_TRUE);</span>
<span class="lineNum">    1512 </span><span class="lineCov">        118 :                 ctx-&gt;mpd_pid = pid;</span>
<span class="lineNum">    1513 </span><span class="lineCov">        118 :                 ctx-&gt;seek_request = -1;</span>
<span class="lineNum">    1514 </span><span class="lineCov">        118 :                 ctx-&gt;nb_playing = 0;</span>
<span class="lineNum">    1515 </span>            : 
<span class="lineNum">    1516 </span><span class="lineCov">        118 :                 if ((ctx-&gt;forward==DFWD_FILE) &amp;&amp; !ctx-&gt;output_mpd_pid) {</span>
<span class="lineNum">    1517 </span><span class="lineCov">          4 :                         ctx-&gt;output_mpd_pid = gf_filter_pid_new(filter);</span>
<span class="lineNum">    1518 </span><span class="lineCov">          4 :                         gf_filter_pid_copy_properties(ctx-&gt;output_mpd_pid, pid);</span>
<span class="lineNum">    1519 </span><span class="lineCov">          4 :                         gf_filter_pid_set_name(ctx-&gt;output_mpd_pid, &quot;manifest&quot;);</span>
<span class="lineNum">    1520 </span><span class="lineCov">          4 :                         GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[DASHDmx] Creating manifest output PID\n&quot;));</span>
<span class="lineNum">    1521 </span>            :                         //for route
<span class="lineNum">    1522 </span><span class="lineCov">          4 :                         gf_filter_pid_set_property(ctx-&gt;output_mpd_pid, GF_PROP_PID_ORIG_STREAM_TYPE, &amp;PROP_UINT(GF_STREAM_FILE));</span>
<span class="lineNum">    1523 </span>            :                 }
<span class="lineNum">    1524 </span>            : 
<span class="lineNum">    1525 </span><span class="lineCov">        118 :                 e = gf_dash_open(ctx-&gt;dash, p-&gt;value.string);</span>
<span class="lineNum">    1526 </span><span class="lineCov">        118 :                 if (e) {</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[DASHDmx] Error - cannot initialize DASH Client for %s: %s\n&quot;, p-&gt;value.string, gf_error_to_string(e)));</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :                         gf_filter_setup_failure(filter, e);</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :                         return e;</span>
<span class="lineNum">    1530 </span>            :                 }
<span class="lineNum">    1531 </span><span class="lineCov">        118 :                 frag = strchr(p-&gt;value.string, '#');</span>
<span class="lineNum">    1532 </span><span class="lineCov">        118 :                 if (frag) {</span>
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;frag_url) gf_free(ctx-&gt;frag_url);</span>
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :                         ctx-&gt;frag_url = gf_strdup(frag+1);</span>
<span class="lineNum">    1535 </span>            :                 }
<span class="lineNum">    1536 </span><span class="lineCov">        118 :                 if (gf_dash_is_m3u8(ctx-&gt;dash) || gf_dash_is_smooth_streaming(ctx-&gt;dash))</span>
<span class="lineNum">    1537 </span><span class="lineCov">         23 :                         ctx-&gt;is_dash = GF_FALSE;</span>
<span class="lineNum">    1538 </span>            :                 else
<span class="lineNum">    1539 </span><span class="lineCov">         95 :                         ctx-&gt;is_dash = GF_TRUE;</span>
<span class="lineNum">    1540 </span>            : 
<span class="lineNum">    1541 </span>            :                 //we have a redirect URL on mpd pid, this means this comes from a service feeding the cache so we won't get any data on the pid.
<span class="lineNum">    1542 </span>            :                 //request a process task
<span class="lineNum">    1543 </span><span class="lineCov">        118 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_REDIRECT_URL);</span>
<span class="lineNum">    1544 </span><span class="lineCov">        118 :                 if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    1545 </span>            :                         GF_FilterEvent evt;
<span class="lineNum">    1546 </span><span class="lineCov">          5 :                         GF_FEVT_INIT(evt, GF_FEVT_PLAY, ctx-&gt;mpd_pid);</span>
<span class="lineNum">    1547 </span><span class="lineCov">          5 :                         gf_filter_pid_send_event(ctx-&gt;mpd_pid, &amp;evt);</span>
<span class="lineNum">    1548 </span><span class="lineCov">          5 :                         gf_filter_post_process_task(filter);</span>
<span class="lineNum">    1549 </span>            :                 }
<span class="lineNum">    1550 </span>            :                 return GF_OK;
<span class="lineNum">    1551 </span><span class="lineCov">        553 :         } else if (ctx-&gt;mpd_pid == pid) {</span>
<span class="lineNum">    1552 </span>            :                 return GF_OK;
<span class="lineNum">    1553 </span>            :         }
<span class="lineNum">    1554 </span>            : 
<span class="lineNum">    1555 </span>            :         //figure out group for this pid
<span class="lineNum">    1556 </span><span class="lineCov">        553 :         group_idx = dashdmx_group_idx_from_pid(ctx, pid);</span>
<span class="lineNum">    1557 </span><span class="lineCov">        553 :         if (group_idx&lt;0) {</span>
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[DASHDmx] Failed to locate adaptation set for input pid\n&quot;));</span>
<span class="lineNum">    1559 </span>            :                 return GF_SERVICE_ERROR;
<span class="lineNum">    1560 </span>            :         }
<span class="lineNum">    1561 </span><span class="lineCov">        553 :         group = gf_dash_get_group_udta(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">    1562 </span>            : 
<span class="lineNum">    1563 </span>            :         //initial configure
<span class="lineNum">    1564 </span><span class="lineCov">        553 :         opid = gf_filter_pid_get_udta(pid);</span>
<span class="lineNum">    1565 </span><span class="lineCov">        553 :         if (opid == NULL) {</span>
<span class="lineNum">    1566 </span>            :                 u32 run_status;
<span class="lineNum">    1567 </span><span class="lineCov">        267 :                 group = gf_dash_get_group_udta(ctx-&gt;dash, group_idx);</span>
<span class="lineNum">    1568 </span>            :                 assert(group);
<span class="lineNum">    1569 </span>            :                 //for now we declare every component from the input source
<span class="lineNum">    1570 </span><span class="lineCov">        267 :                 opid = dashdmx_create_output_pid(ctx, pid, &amp;run_status);</span>
<span class="lineNum">    1571 </span><span class="lineCov">        267 :                 gf_filter_pid_set_udta(opid, group);</span>
<span class="lineNum">    1572 </span><span class="lineCov">        267 :                 gf_filter_pid_set_udta(pid, opid);</span>
<span class="lineNum">    1573 </span><span class="lineCov">        267 :                 group-&gt;nb_pids ++;</span>
<span class="lineNum">    1574 </span>            : 
<span class="lineNum">    1575 </span><span class="lineCov">        267 :                 if (run_status) {</span>
<span class="lineNum">    1576 </span>            :                         GF_FilterEvent evt;
<span class="lineNum">    1577 </span><span class="lineCov">          6 :                         GF_FEVT_INIT(evt, GF_FEVT_PLAY, pid);</span>
<span class="lineNum">    1578 </span><span class="lineCov">          6 :                         gf_filter_pid_send_event(pid, &amp;evt);</span>
<span class="lineNum">    1579 </span><span class="lineCov">          6 :                         group-&gt;is_playing = GF_TRUE;</span>
<span class="lineNum">    1580 </span><span class="lineCov">          6 :                         gf_dash_group_select(ctx-&gt;dash, group-&gt;idx, GF_TRUE);</span>
<span class="lineNum">    1581 </span>            : 
<span class="lineNum">    1582 </span><span class="lineCov">          6 :                         if (run_status==2) {</span>
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :                                 gf_dash_set_group_done(ctx-&gt;dash, group-&gt;idx, GF_TRUE);</span>
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :                                 gf_dash_group_select(ctx-&gt;dash, group-&gt;idx, GF_FALSE);</span>
<span class="lineNum">    1585 </span>            : 
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :                                 GF_FEVT_INIT(evt, GF_FEVT_STOP, pid);</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_send_event(pid, &amp;evt);</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :                                 group-&gt;is_playing = GF_FALSE;</span>
<span class="lineNum">    1589 </span>            :                         } else {
<span class="lineNum">    1590 </span>            :                                 is_period_switch = GF_TRUE;
<span class="lineNum">    1591 </span>            :                         }
<span class="lineNum">    1592 </span>            :                 }
<span class="lineNum">    1593 </span>            :         }
<span class="lineNum">    1594 </span><span class="lineCov">        553 :         dashdmx_declare_properties(ctx, group, group_idx, opid, pid, is_period_switch);</span>
<span class="lineNum">    1595 </span>            : 
<span class="lineNum">    1596 </span>            : 
<span class="lineNum">    1597 </span>            :         //reset the file cache property (init segment could be cached but not the rest)
<span class="lineNum">    1598 </span><span class="lineCov">        553 :         gf_filter_pid_set_property(opid, GF_PROP_PID_FILE_CACHED, NULL);</span>
<span class="lineNum">    1599 </span>            : 
<span class="lineNum">    1600 </span><span class="lineCov">        553 :         return GF_OK;</span>
<span class="lineNum">    1601 </span>            : }
<span class="lineNum">    1602 </span>            : 
<a name="1603"><span class="lineNum">    1603 </span>            : #ifdef GPAC_HAS_QJS</a>
<span class="lineNum">    1604 </span>            : 
<span class="lineNum">    1605 </span><span class="lineCov">         21 : static s32 dashdmx_algo_js(void *udta, u32 group, u32 base_group, Bool force_lower_complexity, GF_DASHCustomAlgoInfo *stats)</span>
<span class="lineNum">    1606 </span>            : {
<span class="lineNum">    1607 </span>            :         s32 res;
<span class="lineNum">    1608 </span>            :         JSValue ret, args[4];
<span class="lineNum">    1609 </span>            :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx *)udta;
<span class="lineNum">    1610 </span>            : 
<span class="lineNum">    1611 </span><span class="lineCov">         21 :         gf_js_lock(ctx-&gt;js_ctx, GF_TRUE);</span>
<span class="lineNum">    1612 </span><span class="lineCov">         42 :         args[0] = JS_NewInt32(ctx-&gt;js_ctx, group);</span>
<span class="lineNum">    1613 </span><span class="lineCov">         42 :         args[1] = JS_NewInt32(ctx-&gt;js_ctx, base_group);</span>
<span class="lineNum">    1614 </span><span class="lineCov">         21 :         args[2] = JS_NewBool(ctx-&gt;js_ctx, force_lower_complexity);</span>
<span class="lineNum">    1615 </span><span class="lineCov">         21 :         args[3] = JS_NewObject(ctx-&gt;js_ctx);</span>
<span class="lineNum">    1616 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;rate&quot;, JS_NewInt32(ctx-&gt;js_ctx, stats-&gt;download_rate) );</span>
<span class="lineNum">    1617 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;filesize&quot;, JS_NewInt32(ctx-&gt;js_ctx, stats-&gt;file_size) );</span>
<span class="lineNum">    1618 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;speed&quot;, JS_NewFloat64(ctx-&gt;js_ctx, stats-&gt;speed) );</span>
<span class="lineNum">    1619 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;max_speed&quot;, JS_NewFloat64(ctx-&gt;js_ctx, stats-&gt;max_available_speed) );</span>
<span class="lineNum">    1620 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;display_width&quot;, JS_NewInt32(ctx-&gt;js_ctx, stats-&gt;disp_width) );</span>
<span class="lineNum">    1621 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;display_height&quot;, JS_NewInt32(ctx-&gt;js_ctx, stats-&gt;disp_height) );</span>
<span class="lineNum">    1622 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;active_quality&quot;, JS_NewInt32(ctx-&gt;js_ctx, stats-&gt;active_quality_idx) );</span>
<span class="lineNum">    1623 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;buffer_min&quot;, JS_NewInt32(ctx-&gt;js_ctx, stats-&gt;buffer_min_ms) );</span>
<span class="lineNum">    1624 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;buffer_max&quot;, JS_NewInt32(ctx-&gt;js_ctx, stats-&gt;buffer_max_ms) );</span>
<span class="lineNum">    1625 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;buffer&quot;, JS_NewInt32(ctx-&gt;js_ctx, stats-&gt;buffer_occupancy_ms) );</span>
<span class="lineNum">    1626 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;degradation_hint&quot;, JS_NewInt32(ctx-&gt;js_ctx, stats-&gt;quality_degradation_hint) );</span>
<span class="lineNum">    1627 </span><span class="lineCov">         42 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[3], &quot;total_rate&quot;, JS_NewInt32(ctx-&gt;js_ctx, stats-&gt;total_rate) );</span>
<span class="lineNum">    1628 </span><span class="lineCov">         21 :         ret = JS_Call(ctx-&gt;js_ctx, ctx-&gt;rate_fun, ctx-&gt;js_obj, 4, args);</span>
<span class="lineNum">    1629 </span><span class="lineCov">         21 :         JS_FreeValue(ctx-&gt;js_ctx, args[3]);</span>
<span class="lineNum">    1630 </span>            : 
<span class="lineNum">    1631 </span><span class="lineCov">         21 :         if (JS_IsException(ret)) {</span>
<span class="lineNum">    1632 </span><span class="lineNoCov">          0 :                 js_dump_error(ctx-&gt;js_ctx);</span>
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :                 res = -3;</span>
<span class="lineNum">    1634 </span><span class="lineCov">         21 :         } else if (JS_ToInt32(ctx-&gt;js_ctx, &amp;res, ret))</span>
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">    1636 </span>            : 
<span class="lineNum">    1637 </span><span class="lineCov">         21 :         JS_FreeValue(ctx-&gt;js_ctx, ret);</span>
<span class="lineNum">    1638 </span><span class="lineCov">         21 :         gf_js_lock(ctx-&gt;js_ctx, GF_FALSE);</span>
<span class="lineNum">    1639 </span><span class="lineCov">         21 :         return res;</span>
<a name="1640"><span class="lineNum">    1640 </span>            : }</a>
<span class="lineNum">    1641 </span>            : 
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 : s32 dashdmx_download_monitor_js(void *udta, u32 group, u32 bits_per_sec, u64 total_bytes, u64 bytes_done, u64 us_since_start, u32 buffer_dur_ms, u32 current_seg_dur)</span>
<span class="lineNum">    1643 </span>            : {
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :         s32 res = -1;</span>
<span class="lineNum">    1645 </span>            :         JSValue ret, args[2];
<span class="lineNum">    1646 </span>            :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx *)udta;
<span class="lineNum">    1647 </span>            : 
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :         gf_js_lock(ctx-&gt;js_ctx, GF_TRUE);</span>
<span class="lineNum">    1649 </span>            : 
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :         args[0] = JS_NewInt32(ctx-&gt;js_ctx, group);</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :         args[1] = JS_NewObject(ctx-&gt;js_ctx);</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[1], &quot;bits_per_second&quot;, JS_NewInt32(ctx-&gt;js_ctx, bits_per_sec) );</span>
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[1], &quot;total_bytes&quot;, JS_NewInt64(ctx-&gt;js_ctx, total_bytes) );</span>
<span class="lineNum">    1654 </span><span class="lineNoCov">          0 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[1], &quot;bytes_done&quot;, JS_NewInt64(ctx-&gt;js_ctx, bytes_done) );</span>
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[1], &quot;us_since_start&quot;, JS_NewInt64(ctx-&gt;js_ctx, us_since_start) );</span>
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[1], &quot;buffer_duration&quot;, JS_NewInt32(ctx-&gt;js_ctx, buffer_dur_ms) );</span>
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :         JS_SetPropertyStr(ctx-&gt;js_ctx, args[1], &quot;current_segment_duration&quot;, JS_NewInt32(ctx-&gt;js_ctx, current_seg_dur) );</span>
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 :         ret = JS_Call(ctx-&gt;js_ctx, ctx-&gt;download_fun, ctx-&gt;js_obj, 2, args);</span>
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :         JS_FreeValue(ctx-&gt;js_ctx, args[1]);</span>
<span class="lineNum">    1660 </span><span class="lineNoCov">          0 :         if (JS_ToInt32(ctx-&gt;js_ctx, &amp;res, ret))</span>
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :         JS_FreeValue(ctx-&gt;js_ctx, ret);</span>
<span class="lineNum">    1663 </span>            : 
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 :         gf_js_lock(ctx-&gt;js_ctx, GF_FALSE);</span>
<a name="1665"><span class="lineNum">    1665 </span><span class="lineNoCov">          0 :         return res;</span></a>
<span class="lineNum">    1666 </span>            : }
<span class="lineNum">    1667 </span><span class="lineCov">        118 : void dashdmx_cleanup_js(GF_DASHDmxCtx *ctx)</span>
<span class="lineNum">    1668 </span>            : {
<span class="lineNum">    1669 </span><span class="lineCov">        118 :         if (ctx-&gt;js_ctx) {</span>
<span class="lineNum">    1670 </span><span class="lineCov">          1 :                 gf_js_lock(ctx-&gt;js_ctx, GF_TRUE);</span>
<span class="lineNum">    1671 </span><span class="lineCov">          1 :                 JS_FreeValue(ctx-&gt;js_ctx, ctx-&gt;rate_fun);</span>
<span class="lineNum">    1672 </span><span class="lineCov">          1 :                 JS_FreeValue(ctx-&gt;js_ctx, ctx-&gt;download_fun);</span>
<span class="lineNum">    1673 </span><span class="lineCov">          1 :                 JS_FreeValue(ctx-&gt;js_ctx, ctx-&gt;new_group_fun);</span>
<span class="lineNum">    1674 </span><span class="lineCov">          1 :                 JS_FreeValue(ctx-&gt;js_ctx, ctx-&gt;period_reset_fun);</span>
<span class="lineNum">    1675 </span>            : 
<span class="lineNum">    1676 </span><span class="lineCov">          1 :                 if (!ctx-&gt;owns_context)</span>
<span class="lineNum">    1677 </span><span class="lineCov">          1 :                         JS_FreeValue(ctx-&gt;js_ctx, ctx-&gt;js_obj);</span>
<span class="lineNum">    1678 </span>            : 
<span class="lineNum">    1679 </span><span class="lineCov">          1 :                 gf_js_lock(ctx-&gt;js_ctx, GF_FALSE);</span>
<span class="lineNum">    1680 </span><span class="lineCov">          1 :                 if (ctx-&gt;owns_context)</span>
<span class="lineNum">    1681 </span><span class="lineNoCov">          0 :                         gf_js_delete_context(ctx-&gt;js_ctx);</span>
<span class="lineNum">    1682 </span><span class="lineCov">          1 :                 ctx-&gt;js_ctx = NULL;</span>
<span class="lineNum">    1683 </span><span class="lineCov">          1 :                 ctx-&gt;owns_context = GF_FALSE;</span>
<span class="lineNum">    1684 </span><span class="lineCov">          1 :                 ctx-&gt;rate_fun = ctx-&gt;download_fun = ctx-&gt;new_group_fun= ctx-&gt;period_reset_fun = JS_UNDEFINED;</span>
<span class="lineNum">    1685 </span>            :         }
<span class="lineNum">    1686 </span><span class="lineCov">        118 : }</span>
<span class="lineNum">    1687 </span>            : 
<span class="lineNum">    1688 </span>            : #define GET_FUN(_field, _name) \
<span class="lineNum">    1689 </span>            :         dashctx-&gt;_field = JS_GetPropertyStr(ctx, dashctx-&gt;js_obj, _name); \
<span class="lineNum">    1690 </span>            :         if (! JS_IsFunction(ctx, dashctx-&gt;_field)) {\
<span class="lineNum">    1691 </span>            :                 JS_FreeValue(dashctx-&gt;js_ctx, dashctx-&gt;_field); \
<span class="lineNum">    1692 </span>            :                 dashctx-&gt;_field = JS_NULL;\
<span class="lineNum">    1693 </span>            :         }
<a name="1694"><span class="lineNum">    1694 </span>            : </a>
<span class="lineNum">    1695 </span>            : 
<span class="lineNum">    1696 </span><span class="lineCov">          1 : JSValue dashdmx_bind_js(GF_Filter *f, JSContext *ctx, JSValueConst obj)</span>
<span class="lineNum">    1697 </span>            : {
<span class="lineNum">    1698 </span><span class="lineCov">          1 :         GF_DASHDmxCtx *dashctx = (GF_DASHDmxCtx *) gf_filter_get_udta(f);</span>
<span class="lineNum">    1699 </span>            :         JSValue rate_fun;
<span class="lineNum">    1700 </span>            : 
<span class="lineNum">    1701 </span><span class="lineCov">          1 :         rate_fun = JS_GetPropertyStr(ctx, obj, &quot;rate_adaptation&quot;);</span>
<span class="lineNum">    1702 </span><span class="lineCov">          1 :         if (! JS_IsFunction(ctx, rate_fun)) {</span>
<span class="lineNum">    1703 </span>            :                 JS_FreeValue(ctx, rate_fun);
<span class="lineNum">    1704 </span><span class="lineNoCov">          0 :                 return js_throw_err_msg(ctx, GF_BAD_PARAM, &quot;Object does not define a rate_adaptation function\n&quot;);</span>
<span class="lineNum">    1705 </span>            :         }
<span class="lineNum">    1706 </span>            : 
<span class="lineNum">    1707 </span><span class="lineCov">          1 :         if (dashctx-&gt;js_ctx) {</span>
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :                 dashdmx_cleanup_js(dashctx);</span>
<span class="lineNum">    1709 </span>            :         }
<span class="lineNum">    1710 </span><span class="lineCov">          1 :         dashctx-&gt;js_ctx = ctx;</span>
<span class="lineNum">    1711 </span><span class="lineCov">          1 :         dashctx-&gt;js_obj = JS_DupValue(ctx, obj);</span>
<span class="lineNum">    1712 </span><span class="lineCov">          1 :         dashctx-&gt;rate_fun = rate_fun;</span>
<span class="lineNum">    1713 </span>            : 
<span class="lineNum">    1714 </span><span class="lineCov">          1 :         GET_FUN(download_fun, &quot;download_monitor&quot;)</span>
<span class="lineNum">    1715 </span><span class="lineCov">          1 :         GET_FUN(new_group_fun, &quot;new_group&quot;)</span>
<span class="lineNum">    1716 </span><span class="lineCov">          1 :         GET_FUN(period_reset_fun, &quot;period_reset&quot;)</span>
<span class="lineNum">    1717 </span>            : 
<span class="lineNum">    1718 </span><span class="lineCov">          1 :         if (JS_IsFunction(ctx, dashctx-&gt;download_fun)) {</span>
<span class="lineNum">    1719 </span><span class="lineCov">          1 :                 gf_dash_set_algo_custom(dashctx-&gt;dash, dashctx, dashdmx_algo_js, dashdmx_download_monitor_js);</span>
<span class="lineNum">    1720 </span><span class="lineCov">          1 :                 dashctx-&gt;abort = GF_TRUE;</span>
<span class="lineNum">    1721 </span>            :         } else {
<span class="lineNum">    1722 </span><span class="lineNoCov">          0 :                 gf_dash_set_algo_custom(dashctx-&gt;dash, dashctx, dashdmx_algo_js, NULL);</span>
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :                 dashctx-&gt;abort = GF_FALSE;</span>
<span class="lineNum">    1724 </span>            :         }
<span class="lineNum">    1725 </span><span class="lineCov">          1 :         return JS_UNDEFINED;</span>
<span class="lineNum">    1726 </span>            : }
<a name="1727"><span class="lineNum">    1727 </span>            : </a>
<span class="lineNum">    1728 </span>            : 
<span class="lineNum">    1729 </span><span class="lineNoCov">          0 : static GF_Err dashdmx_initialize_js(GF_DASHDmxCtx *dashctx, char *jsfile)</span>
<span class="lineNum">    1730 </span>            : {
<span class="lineNum">    1731 </span>            :     JSContext *ctx;
<span class="lineNum">    1732 </span>            :         JSValue global_obj, ret;
<span class="lineNum">    1733 </span>            :         u8 *buf;
<span class="lineNum">    1734 </span>            :         u32 buf_len;
<span class="lineNum">    1735 </span>            :         GF_Err e;
<span class="lineNum">    1736 </span>            :         u32 flags = JS_EVAL_TYPE_GLOBAL;
<span class="lineNum">    1737 </span>            : 
<span class="lineNum">    1738 </span><span class="lineNoCov">          0 :         e = gf_file_load_data(jsfile, &amp;buf, &amp;buf_len);</span>
<span class="lineNum">    1739 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">    1740 </span>            : 
<span class="lineNum">    1741 </span><span class="lineNoCov">          0 :         ctx = gf_js_create_context();</span>
<span class="lineNum">    1742 </span><span class="lineNoCov">          0 :         if (!ctx) {</span>
<span class="lineNum">    1743 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_SCRIPT, (&quot;[DASHDmx] Failed to load QuickJS context\n&quot;));</span>
<span class="lineNum">    1744 </span><span class="lineNoCov">          0 :                 if (buf) gf_free(buf);</span>
<span class="lineNum">    1745 </span>            :                 return GF_IO_ERR;
<span class="lineNum">    1746 </span>            :         }
<span class="lineNum">    1747 </span><span class="lineNoCov">          0 :         JS_SetContextOpaque(ctx, dashctx);</span>
<span class="lineNum">    1748 </span><span class="lineNoCov">          0 :         dashctx-&gt;owns_context = GF_TRUE;</span>
<span class="lineNum">    1749 </span>            : 
<span class="lineNum">    1750 </span><span class="lineNoCov">          0 :     global_obj = JS_GetGlobalObject(ctx);</span>
<span class="lineNum">    1751 </span><span class="lineNoCov">          0 :         js_load_constants(ctx, global_obj);</span>
<span class="lineNum">    1752 </span><span class="lineNoCov">          0 :         dashctx-&gt;js_ctx = ctx;</span>
<span class="lineNum">    1753 </span>            : 
<span class="lineNum">    1754 </span><span class="lineNoCov">          0 :         JS_SetPropertyStr(dashctx-&gt;js_ctx, global_obj, &quot;_gpac_log_name&quot;, JS_NewString(dashctx-&gt;js_ctx, gf_file_basename(jsfile) ) );</span>
<span class="lineNum">    1755 </span><span class="lineNoCov">          0 :         dashctx-&gt;js_obj = JS_NewObject(dashctx-&gt;js_ctx);</span>
<span class="lineNum">    1756 </span><span class="lineNoCov">          0 :         JS_SetPropertyStr(dashctx-&gt;js_ctx, global_obj, &quot;dashin&quot;, dashctx-&gt;js_obj);</span>
<span class="lineNum">    1757 </span>            : 
<span class="lineNum">    1758 </span><span class="lineNoCov">          0 :         if (!gf_opts_get_bool(&quot;core&quot;, &quot;no-js-mods&quot;) &amp;&amp; JS_DetectModule((char *)buf, buf_len)) {</span>
<span class="lineNum">    1759 </span>            :                 //init modules, except webgl
<span class="lineNum">    1760 </span><span class="lineNoCov">          0 :                 qjs_module_init_gpaccore(dashctx-&gt;js_ctx);</span>
<span class="lineNum">    1761 </span><span class="lineNoCov">          0 :                 qjs_module_init_xhr(dashctx-&gt;js_ctx);</span>
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :                 qjs_module_init_evg(dashctx-&gt;js_ctx);</span>
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 :                 qjs_module_init_storage(dashctx-&gt;js_ctx);</span>
<span class="lineNum">    1764 </span>            :                 flags = JS_EVAL_TYPE_MODULE;
<span class="lineNum">    1765 </span>            :         }
<span class="lineNum">    1766 </span>            : 
<span class="lineNum">    1767 </span><span class="lineNoCov">          0 :         ret = JS_Eval(dashctx-&gt;js_ctx, (char *)buf, buf_len, jsfile, flags);</span>
<span class="lineNum">    1768 </span><span class="lineNoCov">          0 :         gf_free(buf);</span>
<span class="lineNum">    1769 </span>            : 
<span class="lineNum">    1770 </span><span class="lineNoCov">          0 :         if (JS_IsException(ret)) {</span>
<span class="lineNum">    1771 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_SCRIPT, (&quot;[DASHDmx] Error loading script %s\n&quot;, jsfile));</span>
<span class="lineNum">    1772 </span><span class="lineNoCov">          0 :         js_dump_error(dashctx-&gt;js_ctx);</span>
<span class="lineNum">    1773 </span><span class="lineNoCov">          0 :                 JS_FreeValue(dashctx-&gt;js_ctx, ret);</span>
<span class="lineNum">    1774 </span><span class="lineNoCov">          0 :                 JS_FreeValue(dashctx-&gt;js_ctx, global_obj);</span>
<span class="lineNum">    1775 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    1776 </span>            :         }
<span class="lineNum">    1777 </span><span class="lineNoCov">          0 :         JS_FreeValue(dashctx-&gt;js_ctx, ret);</span>
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :     JS_FreeValue(dashctx-&gt;js_ctx, global_obj);</span>
<span class="lineNum">    1779 </span>            : 
<span class="lineNum">    1780 </span><span class="lineNoCov">          0 :         dashctx-&gt;rate_fun = JS_GetPropertyStr(ctx, dashctx-&gt;js_obj, &quot;rate_adaptation&quot;);</span>
<span class="lineNum">    1781 </span><span class="lineNoCov">          0 :         if (! JS_IsFunction(ctx, dashctx-&gt;rate_fun)) {</span>
<span class="lineNum">    1782 </span><span class="lineNoCov">          0 :                 JS_FreeValue(dashctx-&gt;js_ctx, dashctx-&gt;rate_fun);</span>
<span class="lineNum">    1783 </span><span class="lineNoCov">          0 :                 dashctx-&gt;rate_fun = JS_UNDEFINED;</span>
<span class="lineNum">    1784 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_SCRIPT, (&quot;[DASHDmx] JS file does not define a rate_adaptation function in dasher object\n&quot;));</span>
<span class="lineNum">    1785 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    1786 </span>            :         }
<span class="lineNum">    1787 </span>            : 
<span class="lineNum">    1788 </span>            : 
<span class="lineNum">    1789 </span><span class="lineNoCov">          0 :         GET_FUN(download_fun, &quot;download_monitor&quot;)</span>
<span class="lineNum">    1790 </span><span class="lineNoCov">          0 :         GET_FUN(new_group_fun, &quot;new_group&quot;)</span>
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :         GET_FUN(period_reset_fun, &quot;period_reset&quot;)</span>
<span class="lineNum">    1792 </span>            :         return GF_OK;
<span class="lineNum">    1793 </span>            : }
<span class="lineNum">    1794 </span>            : 
<span class="lineNum">    1795 </span>            : #endif
<span class="lineNum">    1796 </span>            : 
<span class="lineNum">    1797 </span>            : static const GF_FilterCapability DASHDmxFileModeCaps[] =
<span class="lineNum">    1798 </span>            : {
<span class="lineNum">    1799 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    1800 </span>            :         CAP_STRING(GF_CAPS_INPUT, GF_PROP_PID_FILE_EXT, &quot;mpd|m3u8|3gm|ism&quot;),
<span class="lineNum">    1801 </span>            :         CAP_STRING(GF_CAPS_INPUT, GF_PROP_PID_MIME, &quot;application/dash+xml|video/vnd.3gpp.mpd|audio/vnd.3gpp.mpd|video/vnd.mpeg.dash.mpd|audio/vnd.mpeg.dash.mpd|audio/mpegurl|video/mpegurl|application/vnd.ms-sstr+xml&quot;),
<span class="lineNum">    1802 </span>            :         CAP_UINT(GF_CAPS_OUTPUT, GF_PROP_PID_STREAM_TYPE, GF_STREAM_AUDIO),
<span class="lineNum">    1803 </span>            :         CAP_UINT(GF_CAPS_OUTPUT, GF_PROP_PID_STREAM_TYPE, GF_STREAM_VISUAL),
<span class="lineNum">    1804 </span>            :         CAP_UINT(GF_CAPS_OUTPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_RAW),
<span class="lineNum">    1805 </span>            :         {0},
<span class="lineNum">    1806 </span>            :         //accept only file streams and produce them
<span class="lineNum">    1807 </span>            :         { .code=GF_PROP_PID_STREAM_TYPE, .val.type=GF_PROP_UINT, .val.value.uint=GF_STREAM_FILE, .flags=(GF_CAPFLAG_IN_BUNDLE|GF_CAPFLAG_INPUT|GF_CAPFLAG_OUTPUT|GF_CAPFLAG_LOADED_FILTER) },
<a name="1808"><span class="lineNum">    1808 </span>            : };</a>
<span class="lineNum">    1809 </span>            : 
<span class="lineNum">    1810 </span><span class="lineCov">        118 : static GF_Err dashdmx_initialize(GF_Filter *filter)</span>
<span class="lineNum">    1811 </span>            : {
<span class="lineNum">    1812 </span>            :         u32 timeshift;
<span class="lineNum">    1813 </span><span class="lineCov">        118 :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx*) gf_filter_get_udta(filter);</span>
<span class="lineNum">    1814 </span>            :         GF_DASHAdaptationAlgorithm algo = GF_DASH_ALGO_NONE;
<span class="lineNum">    1815 </span>            :         const char *algo_str;
<span class="lineNum">    1816 </span><span class="lineCov">        118 :         ctx-&gt;filter = filter;</span>
<span class="lineNum">    1817 </span><span class="lineCov">        118 :         ctx-&gt;dm = gf_filter_get_download_manager(filter);</span>
<span class="lineNum">    1818 </span><span class="lineCov">        118 :         if (!ctx-&gt;dm) return GF_SERVICE_ERROR;</span>
<span class="lineNum">    1819 </span>            : 
<span class="lineNum">    1820 </span>            :         //old syntax
<span class="lineNum">    1821 </span><span class="lineCov">        118 :         if (ctx-&gt;filemode) {</span>
<span class="lineNum">    1822 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[DASHDmx] `filemode` option will soon be deprecated, update your script to use `:forward=file` option.\n&quot;));</span>
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 :                 ctx-&gt;forward = DFWD_FILE;</span>
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :                 ctx-&gt;filemode = GF_FALSE;</span>
<span class="lineNum">    1825 </span>            :         }
<span class="lineNum">    1826 </span>            : 
<span class="lineNum">    1827 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.udta = ctx;</span>
<span class="lineNum">    1828 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.delete_cache_file = dashdmx_io_delete_cache_file;</span>
<span class="lineNum">    1829 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.create = dashdmx_io_create;</span>
<span class="lineNum">    1830 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.del = dashdmx_io_del;</span>
<span class="lineNum">    1831 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.init = dashdmx_io_init;</span>
<span class="lineNum">    1832 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.run = dashdmx_io_run;</span>
<span class="lineNum">    1833 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.get_url = dashdmx_io_get_url;</span>
<span class="lineNum">    1834 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.get_cache_name = dashdmx_io_get_cache_name;</span>
<span class="lineNum">    1835 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.get_mime = dashdmx_io_get_mime;</span>
<span class="lineNum">    1836 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.get_header_value = dashdmx_io_get_header_value;</span>
<span class="lineNum">    1837 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.get_utc_start_time = dashdmx_io_get_utc_start_time;</span>
<span class="lineNum">    1838 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.setup_from_url = dashdmx_io_setup_from_url;</span>
<span class="lineNum">    1839 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.set_range = dashdmx_io_set_range;</span>
<span class="lineNum">    1840 </span><span class="lineCov">        118 :         if ((ctx-&gt;forward==DFWD_FILE) || (ctx-&gt;forward==DFWD_SBOUND_MANIFEST))</span>
<span class="lineNum">    1841 </span><span class="lineCov">          7 :                 ctx-&gt;dash_io.manifest_updated = dashdmx_io_manifest_updated;</span>
<span class="lineNum">    1842 </span>            : 
<span class="lineNum">    1843 </span>            : #if 0 //unused since we are in non threaded mode
<span class="lineNum">    1844 </span>            :         ctx-&gt;dash_io.abort = dashdmx_io_abort;
<span class="lineNum">    1845 </span>            :         ctx-&gt;dash_io.get_bytes_per_sec = dashdmx_io_get_bytes_per_sec;
<span class="lineNum">    1846 </span>            :         ctx-&gt;dash_io.get_total_size = dashdmx_io_get_total_size;
<span class="lineNum">    1847 </span>            :         ctx-&gt;dash_io.get_bytes_done = dashdmx_io_get_bytes_done;
<span class="lineNum">    1848 </span>            : #endif
<span class="lineNum">    1849 </span>            : 
<span class="lineNum">    1850 </span><span class="lineCov">        118 :         ctx-&gt;dash_io.on_dash_event = dashdmx_io_on_dash_event;</span>
<span class="lineNum">    1851 </span>            : 
<span class="lineNum">    1852 </span><span class="lineCov">        118 :         if (ctx-&gt;init_timeshift&lt;0) {</span>
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :                 timeshift = -ctx-&gt;init_timeshift;</span>
<span class="lineNum">    1854 </span><span class="lineNoCov">          0 :                 if (timeshift&gt;100) timeshift = 100;</span>
<span class="lineNum">    1855 </span>            :         } else {
<span class="lineNum">    1856 </span><span class="lineCov">        118 :                 timeshift = ctx-&gt;init_timeshift;</span>
<span class="lineNum">    1857 </span>            :         }
<span class="lineNum">    1858 </span>            : 
<span class="lineNum">    1859 </span><span class="lineCov">        118 :         algo_str = ctx-&gt;algo;</span>
<span class="lineNum">    1860 </span>            : 
<span class="lineNum">    1861 </span><span class="lineCov">        118 :         if (ctx-&gt;forward &gt; DFWD_FILE) {</span>
<span class="lineNum">    1862 </span><span class="lineCov">          9 :                 ctx-&gt;split_as = GF_TRUE;</span>
<span class="lineNum">    1863 </span><span class="lineCov">          9 :                 ctx-&gt;screen_res = GF_FALSE;</span>
<span class="lineNum">    1864 </span>            :                 algo_str = &quot;none&quot;;
<span class="lineNum">    1865 </span><span class="lineCov">          9 :                 ctx-&gt;auto_switch = 0;</span>
<span class="lineNum">    1866 </span><span class="lineCov">          9 :                 ctx-&gt;noseek = GF_TRUE;</span>
<span class="lineNum">    1867 </span>            :         }
<span class="lineNum">    1868 </span>            : 
<span class="lineNum">    1869 </span><span class="lineCov">        118 :         if (!strcmp(algo_str, &quot;none&quot;)) algo = GF_DASH_ALGO_NONE;</span>
<span class="lineNum">    1870 </span><span class="lineCov">        103 :         else if (!strcmp(algo_str, &quot;grate&quot;)) algo = GF_DASH_ALGO_GPAC_LEGACY_RATE;</span>
<span class="lineNum">    1871 </span><span class="lineCov">        102 :         else if (!strcmp(algo_str, &quot;gbuf&quot;)) algo = GF_DASH_ALGO_GPAC_LEGACY_BUFFER;</span>
<span class="lineNum">    1872 </span><span class="lineCov">          5 :         else if (!strcmp(algo_str, &quot;bba0&quot;)) algo = GF_DASH_ALGO_BBA0;</span>
<span class="lineNum">    1873 </span><span class="lineCov">          4 :         else if (!strcmp(algo_str, &quot;bolaf&quot;)) algo = GF_DASH_ALGO_BOLA_FINITE;</span>
<span class="lineNum">    1874 </span><span class="lineCov">          3 :         else if (!strcmp(algo_str, &quot;bolab&quot;)) algo = GF_DASH_ALGO_BOLA_BASIC;</span>
<span class="lineNum">    1875 </span><span class="lineCov">          2 :         else if (!strcmp(algo_str, &quot;bolau&quot;)) algo = GF_DASH_ALGO_BOLA_U;</span>
<span class="lineNum">    1876 </span><span class="lineCov">          1 :         else if (!strcmp(algo_str, &quot;bolao&quot;)) algo = GF_DASH_ALGO_BOLA_O;</span>
<span class="lineNum">    1877 </span>            :         else {
<span class="lineNum">    1878 </span>            : #ifndef GPAC_HAS_QJS
<span class="lineNum">    1879 </span>            :                 GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[DASHDmx] No JS support, cannot use custom algo %s\n&quot;, algo_str));
<span class="lineNum">    1880 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    1881 </span>            : #else
<span class="lineNum">    1882 </span>            :                 char szFile[GF_MAX_PATH];
<span class="lineNum">    1883 </span>            :                 Bool found = GF_FALSE;
<span class="lineNum">    1884 </span>            :                 GF_Err e;
<span class="lineNum">    1885 </span>            :                 //init to default, overwrite later
<span class="lineNum">    1886 </span>            :                 algo = GF_DASH_ALGO_GPAC_LEGACY_BUFFER;
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :                 if (gf_file_exists(algo_str)) {</span>
<span class="lineNum">    1888 </span>            :                         strcpy(szFile, algo_str);
<span class="lineNum">    1889 </span>            :                         found = GF_TRUE;
<span class="lineNum">    1890 </span><span class="lineNoCov">          0 :                 } else if (!strstr(algo_str, &quot;.js&quot;)) {</span>
<span class="lineNum">    1891 </span>            :                         strcpy(szFile, algo_str);
<span class="lineNum">    1892 </span>            :                         strcat(szFile, &quot;.js&quot;);
<span class="lineNum">    1893 </span><span class="lineNoCov">          0 :                         if (gf_file_exists(szFile)) {</span>
<span class="lineNum">    1894 </span>            :                                 found = GF_TRUE;
<span class="lineNum">    1895 </span>            :                         }
<span class="lineNum">    1896 </span>            :                 }
<span class="lineNum">    1897 </span>            :                 if (!found) {
<span class="lineNum">    1898 </span><span class="lineNoCov">          0 :                         gf_opts_default_shared_directory(szFile);</span>
<span class="lineNum">    1899 </span>            :                         strcat(szFile, &quot;/scripts/&quot;);
<span class="lineNum">    1900 </span>            :                         strcat(szFile, algo_str);
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 :                         if (gf_file_exists(szFile)) {</span>
<span class="lineNum">    1902 </span>            :                                 found = GF_TRUE;
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :                         } else if (!strstr(algo_str, &quot;.js&quot;)) {</span>
<span class="lineNum">    1904 </span>            :                                 strcat(szFile, &quot;.js&quot;);
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :                                 if (gf_file_exists(szFile))</span>
<span class="lineNum">    1906 </span>            :                                         found = GF_TRUE;
<span class="lineNum">    1907 </span>            :                         }
<span class="lineNum">    1908 </span>            :                 }
<span class="lineNum">    1909 </span><span class="lineNoCov">          0 :                 if (!found) {</span>
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[DASHDmx] Custom algo %s not found\n&quot;, algo_str));</span>
<span class="lineNum">    1911 </span><span class="lineNoCov">          0 :                         return GF_BAD_PARAM;</span>
<span class="lineNum">    1912 </span>            :                 }
<span class="lineNum">    1913 </span><span class="lineNoCov">          0 :                 e = dashdmx_initialize_js(ctx, szFile);</span>
<span class="lineNum">    1914 </span><span class="lineNoCov">          0 :                 if (e) {</span>
<span class="lineNum">    1915 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[DASHDmx] Failed to setup custom algo %s\n&quot;, algo_str));</span>
<span class="lineNum">    1916 </span>            :                         return e;
<span class="lineNum">    1917 </span>            :                 }
<span class="lineNum">    1918 </span>            : #endif
<span class="lineNum">    1919 </span>            :         }
<span class="lineNum">    1920 </span>            : 
<span class="lineNum">    1921 </span>            : 
<span class="lineNum">    1922 </span><span class="lineCov">        118 :         ctx-&gt;dash = gf_dash_new(&amp;ctx-&gt;dash_io, 0, ctx-&gt;auto_switch, (ctx-&gt;segstore==2) ? GF_TRUE : GF_FALSE, (algo==GF_DASH_ALGO_NONE) ? GF_TRUE : GF_FALSE, ctx-&gt;start_with, timeshift);</span>
<span class="lineNum">    1923 </span>            : 
<span class="lineNum">    1924 </span><span class="lineCov">        118 :         if (!ctx-&gt;dash) {</span>
<span class="lineNum">    1925 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[DASHDmx] Error - cannot create DASH Client\n&quot;));</span>
<span class="lineNum">    1926 </span>            :                 return GF_IO_ERR;
<span class="lineNum">    1927 </span>            :         }
<span class="lineNum">    1928 </span>            : 
<span class="lineNum">    1929 </span><span class="lineCov">        118 :         if (ctx-&gt;screen_res) {</span>
<span class="lineNum">    1930 </span>            :                 GF_FilterSessionCaps caps;
<span class="lineNum">    1931 </span><span class="lineCov">        109 :                 gf_filter_get_session_caps(ctx-&gt;filter, &amp;caps);</span>
<span class="lineNum">    1932 </span><span class="lineCov">        109 :                 gf_dash_set_max_resolution(ctx-&gt;dash, caps.max_screen_width, caps.max_screen_height, caps.max_screen_bpp);</span>
<span class="lineNum">    1933 </span>            :         }
<span class="lineNum">    1934 </span>            : 
<span class="lineNum">    1935 </span><span class="lineCov">        118 :         gf_dash_set_algo(ctx-&gt;dash, algo);</span>
<span class="lineNum">    1936 </span><span class="lineCov">        118 :         gf_dash_set_utc_shift(ctx-&gt;dash, ctx-&gt;shift_utc);</span>
<span class="lineNum">    1937 </span><span class="lineCov">        118 :         gf_dash_set_route_ast_shift(ctx-&gt;dash, ctx-&gt;route_shift);</span>
<span class="lineNum">    1938 </span><span class="lineCov">        118 :         gf_dash_enable_utc_drift_compensation(ctx-&gt;dash, ctx-&gt;server_utc);</span>
<span class="lineNum">    1939 </span><span class="lineCov">        118 :         gf_dash_set_tile_adaptation_mode(ctx-&gt;dash, ctx-&gt;tile_mode, ctx-&gt;tiles_rate);</span>
<span class="lineNum">    1940 </span>            : 
<span class="lineNum">    1941 </span><span class="lineCov">        118 :         gf_dash_set_min_timeout_between_404(ctx-&gt;dash, ctx-&gt;delay40X);</span>
<span class="lineNum">    1942 </span><span class="lineCov">        118 :         gf_dash_set_segment_expiration_threshold(ctx-&gt;dash, ctx-&gt;exp_threshold);</span>
<span class="lineNum">    1943 </span><span class="lineCov">        118 :         gf_dash_set_switching_probe_count(ctx-&gt;dash, ctx-&gt;switch_count);</span>
<span class="lineNum">    1944 </span><span class="lineCov">        118 :         gf_dash_set_agressive_adaptation(ctx-&gt;dash, ctx-&gt;aggressive);</span>
<span class="lineNum">    1945 </span><span class="lineCov">        118 :         gf_dash_enable_single_range_llhls(ctx-&gt;dash, ctx-&gt;llhls_merge);</span>
<span class="lineNum">    1946 </span><span class="lineCov">        118 :         gf_dash_debug_groups(ctx-&gt;dash, ctx-&gt;debug_as.vals, ctx-&gt;debug_as.nb_items);</span>
<span class="lineNum">    1947 </span><span class="lineCov">        118 :         gf_dash_disable_speed_adaptation(ctx-&gt;dash, !ctx-&gt;speedadapt);</span>
<span class="lineNum">    1948 </span><span class="lineCov">        118 :         gf_dash_ignore_xlink(ctx-&gt;dash, ctx-&gt;noxlink);</span>
<span class="lineNum">    1949 </span><span class="lineCov">        118 :         gf_dash_set_period_xlink_query_string(ctx-&gt;dash, ctx-&gt;query);</span>
<span class="lineNum">    1950 </span><span class="lineCov">        118 :         gf_dash_set_low_latency_mode(ctx-&gt;dash, ctx-&gt;lowlat);</span>
<span class="lineNum">    1951 </span><span class="lineCov">        118 :         if (ctx-&gt;split_as)</span>
<span class="lineNum">    1952 </span><span class="lineCov">         10 :                 gf_dash_split_adaptation_sets(ctx-&gt;dash);</span>
<span class="lineNum">    1953 </span><span class="lineCov">        118 :         gf_dash_disable_low_quality_tiles(ctx-&gt;dash, ctx-&gt;skip_lqt);</span>
<span class="lineNum">    1954 </span>            : 
<span class="lineNum">    1955 </span>            :         //in test mode, we disable seeking inside the segment: this initial seek range is dependent from tune-in time and would lead to different start range
<span class="lineNum">    1956 </span>            :         //at each run, possibly breaking all tests
<span class="lineNum">    1957 </span><span class="lineCov">        118 :         if (gf_sys_is_test_mode())</span>
<span class="lineNum">    1958 </span><span class="lineCov">        114 :                 ctx-&gt;noseek = GF_TRUE;</span>
<span class="lineNum">    1959 </span>            : 
<span class="lineNum">    1960 </span><span class="lineCov">        118 :         ctx-&gt;initial_play = GF_TRUE;</span>
<span class="lineNum">    1961 </span><span class="lineCov">        118 :         gf_filter_block_eos(filter, GF_TRUE);</span>
<span class="lineNum">    1962 </span>            : 
<span class="lineNum">    1963 </span>            : #ifdef GPAC_HAS_QJS
<span class="lineNum">    1964 </span><span class="lineCov">        118 :         if (ctx-&gt;js_ctx) {</span>
<span class="lineNum">    1965 </span><span class="lineNoCov">          0 :                 if (JS_IsFunction(ctx-&gt;js_ctx, ctx-&gt;download_fun)) {</span>
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :                         gf_dash_set_algo_custom(ctx-&gt;dash, ctx, dashdmx_algo_js, dashdmx_download_monitor_js);</span>
<span class="lineNum">    1967 </span><span class="lineNoCov">          0 :                         ctx-&gt;abort = GF_TRUE;</span>
<span class="lineNum">    1968 </span>            :                 } else {
<span class="lineNum">    1969 </span><span class="lineNoCov">          0 :                         gf_dash_set_algo_custom(ctx-&gt;dash, ctx, dashdmx_algo_js, NULL);</span>
<span class="lineNum">    1970 </span><span class="lineNoCov">          0 :                         ctx-&gt;abort = GF_FALSE;</span>
<span class="lineNum">    1971 </span>            :                 }
<span class="lineNum">    1972 </span>            :         }
<span class="lineNum">    1973 </span>            : #endif
<span class="lineNum">    1974 </span>            : 
<span class="lineNum">    1975 </span><span class="lineCov">        118 :         if (ctx-&gt;forward==DFWD_FILE) {</span>
<span class="lineNum">    1976 </span><span class="lineCov">          4 :                 ctx-&gt;segstore = 0;</span>
<span class="lineNum">    1977 </span><span class="lineCov">          4 :                 gf_filter_override_caps(filter, DASHDmxFileModeCaps, GF_ARRAY_LENGTH(DASHDmxFileModeCaps) );</span>
<span class="lineNum">    1978 </span>            :         }
<span class="lineNum">    1979 </span>            : 
<span class="lineNum">    1980 </span>            :         //for coverage
<span class="lineNum">    1981 </span>            : #ifdef GPAC_ENABLE_COVERAGE
<span class="lineNum">    1982 </span><span class="lineCov">        118 :         if (gf_sys_is_cov_mode()) {</span>
<span class="lineNum">    1983 </span>            :                 dashdmx_on_filter_setup_error(NULL, NULL, GF_OK);
<span class="lineNum">    1984 </span>            :         }
<span class="lineNum">    1985 </span>            : #endif
<span class="lineNum">    1986 </span><span class="lineCov">        118 :         return GF_OK;</span>
<a name="1987"><span class="lineNum">    1987 </span>            : }</a>
<span class="lineNum">    1988 </span>            : 
<span class="lineNum">    1989 </span><span class="lineCov">        118 : static void dashdmx_finalize(GF_Filter *filter)</span>
<span class="lineNum">    1990 </span>            : {
<span class="lineNum">    1991 </span><span class="lineCov">        118 :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx*) gf_filter_get_udta(filter);</span>
<span class="lineNum">    1992 </span>            :         assert(ctx);
<span class="lineNum">    1993 </span>            : 
<span class="lineNum">    1994 </span><span class="lineCov">        118 :         if (ctx-&gt;dash)</span>
<span class="lineNum">    1995 </span><span class="lineCov">        118 :                 gf_dash_del(ctx-&gt;dash);</span>
<span class="lineNum">    1996 </span>            : 
<span class="lineNum">    1997 </span><span class="lineCov">        118 :         if (ctx-&gt;frag_url)</span>
<span class="lineNum">    1998 </span><span class="lineNoCov">          0 :                 gf_free(ctx-&gt;frag_url);</span>
<span class="lineNum">    1999 </span>            : 
<span class="lineNum">    2000 </span><span class="lineCov">        118 :         if (ctx-&gt;manifest_payload)</span>
<span class="lineNum">    2001 </span><span class="lineNoCov">          0 :                 gf_free(ctx-&gt;manifest_payload);</span>
<span class="lineNum">    2002 </span>            : 
<span class="lineNum">    2003 </span><span class="lineCov">        118 :         if (ctx-&gt;hls_variants) {</span>
<span class="lineNum">    2004 </span><span class="lineNoCov">          0 :                 while (gf_list_count(ctx-&gt;hls_variants))</span>
<span class="lineNum">    2005 </span><span class="lineNoCov">          0 :                         gf_free(gf_list_pop_back(ctx-&gt;hls_variants));</span>
<span class="lineNum">    2006 </span><span class="lineNoCov">          0 :                 gf_list_del(ctx-&gt;hls_variants);</span>
<span class="lineNum">    2007 </span>            :         }
<span class="lineNum">    2008 </span><span class="lineCov">        118 :         if (ctx-&gt;hls_variants_names) {</span>
<span class="lineNum">    2009 </span><span class="lineNoCov">          0 :                 while (gf_list_count(ctx-&gt;hls_variants_names))</span>
<span class="lineNum">    2010 </span><span class="lineNoCov">          0 :                         gf_free(gf_list_pop_back(ctx-&gt;hls_variants_names));</span>
<span class="lineNum">    2011 </span><span class="lineNoCov">          0 :                 gf_list_del(ctx-&gt;hls_variants_names);</span>
<span class="lineNum">    2012 </span>            :         }
<span class="lineNum">    2013 </span>            : 
<span class="lineNum">    2014 </span>            : #ifdef GPAC_HAS_QJS
<span class="lineNum">    2015 </span><span class="lineCov">        118 :         dashdmx_cleanup_js(ctx);</span>
<span class="lineNum">    2016 </span>            : #endif
<a name="2017"><span class="lineNum">    2017 </span><span class="lineCov">        118 : }</span></a>
<span class="lineNum">    2018 </span>            : 
<span class="lineNum">    2019 </span><span class="lineCov">       6472 : static Bool dashdmx_process_event(GF_Filter *filter, const GF_FilterEvent *fevt)</span>
<span class="lineNum">    2020 </span>            : {
<span class="lineNum">    2021 </span>            :         u32 i, count;
<span class="lineNum">    2022 </span>            :         GF_FilterEvent src_evt;
<span class="lineNum">    2023 </span>            :         GF_FilterPid *ipid;
<span class="lineNum">    2024 </span>            :         Bool initial_play;
<span class="lineNum">    2025 </span>            :         Double offset;
<span class="lineNum">    2026 </span><span class="lineCov">       6472 :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx*) gf_filter_get_udta(filter);</span>
<span class="lineNum">    2027 </span>            :         GF_DASHGroup *group;
<span class="lineNum">    2028 </span>            : 
<span class="lineNum">    2029 </span>            : 
<span class="lineNum">    2030 </span><span class="lineCov">       6472 :         switch (fevt-&gt;base.type) {</span>
<span class="lineNum">    2031 </span><span class="lineCov">          3 :         case GF_FEVT_QUALITY_SWITCH:</span>
<span class="lineNum">    2032 </span><span class="lineCov">          3 :                 if (fevt-&gt;quality_switch.set_tile_mode_plus_one) {</span>
<span class="lineNum">    2033 </span><span class="lineNoCov">          0 :                         GF_DASHTileAdaptationMode tile_mode = fevt-&gt;quality_switch.set_tile_mode_plus_one - 1;</span>
<span class="lineNum">    2034 </span><span class="lineNoCov">          0 :                         gf_dash_set_tile_adaptation_mode(ctx-&gt;dash, tile_mode, 100);</span>
<span class="lineNum">    2035 </span><span class="lineCov">          3 :                 } else if (fevt-&gt;quality_switch.q_idx &lt; 0) {</span>
<span class="lineNum">    2036 </span><span class="lineCov">          1 :                         gf_dash_set_automatic_switching(ctx-&gt;dash, 1);</span>
<span class="lineNum">    2037 </span><span class="lineCov">          2 :                 } else if (fevt-&gt;base.on_pid) {</span>
<span class="lineNum">    2038 </span>            :                         s32 idx;
<span class="lineNum">    2039 </span><span class="lineCov">          1 :                         group = gf_filter_pid_get_udta(fevt-&gt;base.on_pid);</span>
<span class="lineNum">    2040 </span><span class="lineCov">          1 :                         if (!group) return GF_TRUE;</span>
<span class="lineNum">    2041 </span><span class="lineCov">          1 :                         idx = group-&gt;idx;</span>
<span class="lineNum">    2042 </span>            : 
<span class="lineNum">    2043 </span><span class="lineCov">          1 :                         gf_dash_group_set_quality_degradation_hint(ctx-&gt;dash, group-&gt;idx, fevt-&gt;quality_switch.quality_degradation);</span>
<span class="lineNum">    2044 </span>            : 
<span class="lineNum">    2045 </span><span class="lineCov">          1 :                         if (fevt-&gt;quality_switch.dependent_group_index) {</span>
<span class="lineNum">    2046 </span><span class="lineNoCov">          0 :                                 if (fevt-&gt;quality_switch.dependent_group_index &gt; gf_dash_group_get_num_groups_depending_on(ctx-&gt;dash, group-&gt;idx))</span>
<span class="lineNum">    2047 </span>            :                                         return GF_TRUE;
<span class="lineNum">    2048 </span>            : 
<span class="lineNum">    2049 </span><span class="lineNoCov">          0 :                                 idx = gf_dash_get_dependent_group_index(ctx-&gt;dash, group-&gt;idx, fevt-&gt;quality_switch.dependent_group_index-1);</span>
<span class="lineNum">    2050 </span><span class="lineNoCov">          0 :                                 if (idx==-1) return GF_TRUE;</span>
<span class="lineNum">    2051 </span>            :                         }
<span class="lineNum">    2052 </span>            : 
<span class="lineNum">    2053 </span><span class="lineCov">          1 :                         gf_dash_set_automatic_switching(ctx-&gt;dash, 0);</span>
<span class="lineNum">    2054 </span><span class="lineCov">          1 :                         gf_dash_group_select_quality(ctx-&gt;dash, idx, NULL, fevt-&gt;quality_switch.q_idx);</span>
<span class="lineNum">    2055 </span>            :                 } else {
<span class="lineNum">    2056 </span><span class="lineCov">          1 :                         gf_dash_switch_quality(ctx-&gt;dash, fevt-&gt;quality_switch.up, ctx-&gt;immediate);</span>
<span class="lineNum">    2057 </span>            :                 }
<span class="lineNum">    2058 </span>            :                 return GF_TRUE;
<span class="lineNum">    2059 </span>            : 
<span class="lineNum">    2060 </span>            : #ifdef FILTER_FIXME
<span class="lineNum">    2061 </span>            : 
<span class="lineNum">    2062 </span>            :         case GF_NET_ASSOCIATED_CONTENT_TIMING:
<span class="lineNum">    2063 </span>            :                 gf_dash_override_ntp(ctx-&gt;dash, com-&gt;addon_time.ntp);
<span class="lineNum">    2064 </span>            :                 return GF_TRUE;
<span class="lineNum">    2065 </span>            : #endif
<span class="lineNum">    2066 </span>            :             
<span class="lineNum">    2067 </span><span class="lineNoCov">          0 :         case GF_FEVT_FILE_DELETE:</span>
<span class="lineNum">    2068 </span>            :                 //check if we want that in other forward mode
<span class="lineNum">    2069 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;forward==DFWD_FILE) {</span>
<span class="lineNum">    2070 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;gf_dash_get_group_count(ctx-&gt;dash); i++) {</span>
<span class="lineNum">    2071 </span><span class="lineNoCov">          0 :                                 group = gf_dash_get_group_udta(ctx-&gt;dash, i);</span>
<span class="lineNum">    2072 </span><span class="lineNoCov">          0 :                                 if (!group || !group-&gt;template) continue;</span>
<span class="lineNum">    2073 </span>            :                                 
<span class="lineNum">    2074 </span><span class="lineNoCov">          0 :                                 if (!strncmp(group-&gt;template, fevt-&gt;file_del.url, strlen(group-&gt;template) )) {</span>
<span class="lineNum">    2075 </span><span class="lineNoCov">          0 :                                         GF_FilterPid *pid = dashdmx_opid_from_group(ctx, group);</span>
<span class="lineNum">    2076 </span><span class="lineNoCov">          0 :                                         if (pid) {</span>
<span class="lineNum">    2077 </span>            :                                                 GF_FilterEvent evt;
<span class="lineNum">    2078 </span><span class="lineNoCov">          0 :                                                 GF_FEVT_INIT(evt, GF_FEVT_FILE_DELETE, pid);</span>
<span class="lineNum">    2079 </span><span class="lineNoCov">          0 :                                                 evt.file_del.url = fevt-&gt;file_del.url;</span>
<span class="lineNum">    2080 </span><span class="lineNoCov">          0 :                                                 gf_filter_pid_send_event(pid, &amp;evt);</span>
<span class="lineNum">    2081 </span>            :                                         }
<span class="lineNum">    2082 </span>            :                                         return GF_TRUE;
<span class="lineNum">    2083 </span>            :                                 }
<span class="lineNum">    2084 </span>            :                         }
<span class="lineNum">    2085 </span>            :                 }
<span class="lineNum">    2086 </span>            :                 return GF_TRUE;
<span class="lineNum">    2087 </span>            :         default:
<span class="lineNum">    2088 </span>            :                 break;
<span class="lineNum">    2089 </span>            :         }
<span class="lineNum">    2090 </span>            : 
<span class="lineNum">    2091 </span>            :         /*not supported*/
<span class="lineNum">    2092 </span><span class="lineCov">       6469 :         if (!fevt-&gt;base.on_pid) return GF_TRUE;</span>
<span class="lineNum">    2093 </span>            : 
<span class="lineNum">    2094 </span><span class="lineCov">       6469 :         if (fevt-&gt;base.on_pid == ctx-&gt;output_mpd_pid) {</span>
<span class="lineNum">    2095 </span>            :                 return GF_TRUE;
<span class="lineNum">    2096 </span>            :         }
<span class="lineNum">    2097 </span><span class="lineCov">       6460 :         group = gf_filter_pid_get_udta(fevt-&gt;base.on_pid);</span>
<span class="lineNum">    2098 </span><span class="lineCov">       6460 :         if (!group) return GF_TRUE;</span>
<span class="lineNum">    2099 </span><span class="lineCov">       6337 :         count = gf_filter_get_ipid_count(filter);</span>
<span class="lineNum">    2100 </span>            :         ipid = NULL;
<span class="lineNum">    2101 </span><span class="lineCov">      32238 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2102 </span><span class="lineCov">      26409 :                 ipid = gf_filter_get_ipid(filter, i);</span>
<span class="lineNum">    2103 </span><span class="lineCov">      26409 :                 if (gf_filter_pid_get_udta(ipid) == fevt-&gt;base.on_pid) break;</span>
<span class="lineNum">    2104 </span>            :                 ipid = NULL;
<span class="lineNum">    2105 </span>            :         }
<span class="lineNum">    2106 </span>            : 
<span class="lineNum">    2107 </span><span class="lineCov">       6337 :         switch (fevt-&gt;base.type) {</span>
<span class="lineNum">    2108 </span><span class="lineCov">         40 :         case GF_FEVT_VISIBILITY_HINT:</span>
<span class="lineNum">    2109 </span><span class="lineCov">         40 :                 group = gf_filter_pid_get_udta(fevt-&gt;base.on_pid);</span>
<span class="lineNum">    2110 </span><span class="lineCov">         40 :                 if (!group) return GF_TRUE;</span>
<span class="lineNum">    2111 </span>            : 
<span class="lineNum">    2112 </span><span class="lineCov">         40 :                 gf_dash_group_set_visible_rect(ctx-&gt;dash, group-&gt;idx, fevt-&gt;visibility_hint.min_x, fevt-&gt;visibility_hint.max_x, fevt-&gt;visibility_hint.min_y, fevt-&gt;visibility_hint.max_y, fevt-&gt;visibility_hint.is_gaze);</span>
<span class="lineNum">    2113 </span><span class="lineCov">         40 :                 return GF_TRUE;</span>
<span class="lineNum">    2114 </span>            : 
<span class="lineNum">    2115 </span><span class="lineCov">        261 :         case GF_FEVT_PLAY:</span>
<span class="lineNum">    2116 </span><span class="lineCov">        261 :                 src_evt = *fevt;</span>
<span class="lineNum">    2117 </span><span class="lineCov">        261 :                 group-&gt;is_playing = GF_TRUE;</span>
<span class="lineNum">    2118 </span><span class="lineCov">        261 :                 ctx-&gt;check_eos = GF_FALSE;</span>
<span class="lineNum">    2119 </span>            : 
<span class="lineNum">    2120 </span>            :                 //adjust play range from media timestamps to MPD time
<span class="lineNum">    2121 </span><span class="lineCov">        261 :                 if (fevt-&gt;play.timestamp_based) {</span>
<span class="lineNum">    2122 </span>            : 
<span class="lineNum">    2123 </span><span class="lineNoCov">          0 :                         if (fevt-&gt;play.timestamp_based==1) {</span>
<span class="lineNum">    2124 </span>            :                                 u64 pto;
<span class="lineNum">    2125 </span>            :                                 u32 timescale;
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :                                 gf_dash_group_get_presentation_time_offset(ctx-&gt;dash, group-&gt;idx, &amp;pto, &amp;timescale);</span>
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :                                 offset = (Double) pto;</span>
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 :                                 offset /= timescale;</span>
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :                                 src_evt.play.start_range -= offset;</span>
<span class="lineNum">    2130 </span><span class="lineNoCov">          0 :                                 if (src_evt.play.start_range &lt; 0) src_evt.play.start_range = 0;</span>
<span class="lineNum">    2131 </span>            :                         }
<span class="lineNum">    2132 </span>            : 
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :                         group-&gt;is_timestamp_based = 1;</span>
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :                         group-&gt;pto_setup = 0;</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :                         ctx-&gt;media_start_range = fevt-&gt;play.start_range;</span>
<span class="lineNum">    2136 </span>            :                 } else {
<span class="lineNum">    2137 </span><span class="lineCov">        261 :                         group-&gt;is_timestamp_based = 0;</span>
<span class="lineNum">    2138 </span><span class="lineCov">        261 :                         group-&gt;pto_setup = 0;</span>
<span class="lineNum">    2139 </span><span class="lineCov">        261 :                         if (fevt-&gt;play.start_range&lt;0) src_evt.play.start_range = 0;</span>
<span class="lineNum">    2140 </span>            :                         //in m3u8, we need also media start time for mapping time
<span class="lineNum">    2141 </span><span class="lineCov">        261 :                         if (gf_dash_is_m3u8(ctx-&gt;dash))</span>
<span class="lineNum">    2142 </span><span class="lineCov">         37 :                                 ctx-&gt;media_start_range = fevt-&gt;play.start_range;</span>
<span class="lineNum">    2143 </span>            :                 }
<span class="lineNum">    2144 </span>            : 
<span class="lineNum">    2145 </span>            :                 //we cannot handle seek request outside of a period being setup, this messes up our internal service setup
<span class="lineNum">    2146 </span>            :                 //we postpone the seek and will request it later on ...
<span class="lineNum">    2147 </span><span class="lineCov">        261 :                 if (gf_dash_in_period_setup(ctx-&gt;dash)) {</span>
<span class="lineNum">    2148 </span><span class="lineNoCov">          0 :                         u64 p_end = gf_dash_get_period_duration(ctx-&gt;dash);</span>
<span class="lineNum">    2149 </span><span class="lineNoCov">          0 :                         if (p_end) {</span>
<span class="lineNum">    2150 </span><span class="lineNoCov">          0 :                                 p_end += gf_dash_get_period_start(ctx-&gt;dash);</span>
<span class="lineNum">    2151 </span><span class="lineNoCov">          0 :                                 if (p_end&lt;1000*fevt-&gt;play.start_range) {</span>
<span class="lineNum">    2152 </span><span class="lineNoCov">          0 :                                         ctx-&gt;seek_request = fevt-&gt;play.start_range;</span>
<span class="lineNum">    2153 </span><span class="lineNoCov">          0 :                                         return GF_TRUE;</span>
<span class="lineNum">    2154 </span>            :                                 }
<span class="lineNum">    2155 </span>            :                         }
<span class="lineNum">    2156 </span>            :                 }
<span class="lineNum">    2157 </span>            : 
<span class="lineNum">    2158 </span><span class="lineCov">        261 :                 if (fevt-&gt;play.speed)</span>
<span class="lineNum">    2159 </span><span class="lineCov">        261 :                         gf_dash_set_speed(ctx-&gt;dash, fevt-&gt;play.speed);</span>
<span class="lineNum">    2160 </span>            : 
<span class="lineNum">    2161 </span><span class="lineCov">        261 :                 initial_play = ctx-&gt;initial_play;</span>
<span class="lineNum">    2162 </span><span class="lineCov">        261 :                 if (fevt-&gt;play.initial_broadcast_play) initial_play = GF_TRUE;</span>
<span class="lineNum">    2163 </span>            : 
<span class="lineNum">    2164 </span>            :                 /*don't seek if this command is the first PLAY request of objects declared by the subservice, unless start range is not default one (0) */
<span class="lineNum">    2165 </span><span class="lineCov">        261 :                 if (!ctx-&gt;nb_playing) {</span>
<span class="lineNum">    2166 </span><span class="lineCov">        119 :                         if (!initial_play || (fevt-&gt;play.start_range&gt;1.0)) {</span>
<span class="lineNum">    2167 </span>            : 
<span class="lineNum">    2168 </span><span class="lineCov">          3 :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] Received Play command on group %d\n&quot;, group-&gt;idx));</span>
<span class="lineNum">    2169 </span>            : 
<span class="lineNum">    2170 </span><span class="lineCov">          3 :                                 if (fevt-&gt;play.end_range&lt;=0) {</span>
<span class="lineNum">    2171 </span><span class="lineCov">          3 :                                         u32 ms = (u32) ( 1000 * (-fevt-&gt;play.end_range) );</span>
<span class="lineNum">    2172 </span><span class="lineCov">          3 :                                         if (ms&lt;1000) ms = 0;</span>
<span class="lineNum">    2173 </span><span class="lineCov">          3 :                                         gf_dash_set_timeshift(ctx-&gt;dash, ms);</span>
<span class="lineNum">    2174 </span>            :                                 }
<span class="lineNum">    2175 </span><span class="lineCov">          3 :                                 gf_dash_seek(ctx-&gt;dash, fevt-&gt;play.start_range);</span>
<span class="lineNum">    2176 </span>            : 
<span class="lineNum">    2177 </span>            :                                 //to remove once we manage to keep the service alive
<span class="lineNum">    2178 </span>            :                                 /*don't forward commands if a switch of period is to be scheduled, we are killing the service anyway ...*/
<span class="lineNum">    2179 </span><span class="lineCov">          3 :                                 if (gf_dash_get_period_switch_status(ctx-&gt;dash)) return GF_TRUE;</span>
<span class="lineNum">    2180 </span>            :                         }
<span class="lineNum">    2181 </span>            :                 }
<span class="lineNum">    2182 </span>            :                 //otherwise in static mode, perform a group seek
<span class="lineNum">    2183 </span><span class="lineCov">        142 :                 else if (!initial_play &amp;&amp; !gf_dash_is_dynamic_mpd(ctx-&gt;dash) ) {</span>
<span class="lineNum">    2184 </span>            :                         /*don't forward commands if a switch of period is to be scheduled, we are killing the service anyway ...*/
<span class="lineNum">    2185 </span><span class="lineNoCov">          0 :                         if (gf_dash_get_period_switch_status(ctx-&gt;dash)) return GF_TRUE;</span>
<span class="lineNum">    2186 </span>            : 
<span class="lineNum">    2187 </span>            :                         //seek on a single group
<span class="lineNum">    2188 </span>            : 
<span class="lineNum">    2189 </span><span class="lineNoCov">          0 :                         gf_dash_group_seek(ctx-&gt;dash, group-&gt;idx, fevt-&gt;play.start_range);</span>
<span class="lineNum">    2190 </span>            :                 }
<span class="lineNum">    2191 </span>            : 
<span class="lineNum">    2192 </span>            :                 //check if current segment playback should be aborted
<span class="lineNum">    2193 </span><span class="lineCov">        259 :                 src_evt.play.forced_dash_segment_switch = gf_dash_group_segment_switch_forced(ctx-&gt;dash, group-&gt;idx);</span>
<span class="lineNum">    2194 </span>            : 
<span class="lineNum">    2195 </span><span class="lineCov">        259 :                 gf_dash_group_select(ctx-&gt;dash, group-&gt;idx, GF_TRUE);</span>
<span class="lineNum">    2196 </span><span class="lineCov">        259 :                 gf_dash_set_group_done(ctx-&gt;dash, (u32) group-&gt;idx, 0);</span>
<span class="lineNum">    2197 </span>            : 
<span class="lineNum">    2198 </span>            :                 //adjust start range from MPD time to media time
<span class="lineNum">    2199 </span><span class="lineCov">        259 :                 if (gf_dash_is_dynamic_mpd(ctx-&gt;dash) &amp;&amp; ctx-&gt;noseek) {</span>
<span class="lineNum">    2200 </span><span class="lineCov">         37 :                         src_evt.play.start_range=0;</span>
<span class="lineNum">    2201 </span>            :                 } else {
<span class="lineNum">    2202 </span>            :                         u64 pto;
<span class="lineNum">    2203 </span>            :                         u32 timescale;
<span class="lineNum">    2204 </span><span class="lineCov">        222 :                         src_evt.play.start_range = gf_dash_group_get_start_range(ctx-&gt;dash, group-&gt;idx);</span>
<span class="lineNum">    2205 </span><span class="lineCov">        222 :                         gf_dash_group_get_presentation_time_offset(ctx-&gt;dash, group-&gt;idx, &amp;pto, &amp;timescale);</span>
<span class="lineNum">    2206 </span><span class="lineCov">        222 :                         src_evt.play.start_range += ((Double)pto) / timescale;</span>
<span class="lineNum">    2207 </span>            :                 }
<span class="lineNum">    2208 </span><span class="lineCov">        259 :                 src_evt.play.no_byterange_forward = 1;</span>
<span class="lineNum">    2209 </span><span class="lineCov">        259 :                 dashdmx_setup_buffer(ctx, group);</span>
<span class="lineNum">    2210 </span>            : 
<span class="lineNum">    2211 </span><span class="lineCov">        259 :                 gf_filter_prevent_blocking(filter, GF_TRUE);</span>
<span class="lineNum">    2212 </span>            : 
<span class="lineNum">    2213 </span><span class="lineCov">        259 :                 ctx-&gt;nb_playing++;</span>
<span class="lineNum">    2214 </span>            :                 //forward new event to source pid
<span class="lineNum">    2215 </span><span class="lineCov">        259 :                 src_evt.base.on_pid = ipid;</span>
<span class="lineNum">    2216 </span>            : 
<span class="lineNum">    2217 </span><span class="lineCov">        259 :                 gf_filter_pid_send_event(ipid, &amp;src_evt);</span>
<span class="lineNum">    2218 </span><span class="lineCov">        259 :                 gf_filter_post_process_task(filter);</span>
<span class="lineNum">    2219 </span>            :                 //cancel the event
<span class="lineNum">    2220 </span><span class="lineCov">        259 :                 return GF_TRUE;</span>
<span class="lineNum">    2221 </span>            : 
<span class="lineNum">    2222 </span><span class="lineCov">        105 :         case GF_FEVT_STOP:</span>
<span class="lineNum">    2223 </span><span class="lineCov">        105 :                 gf_dash_set_group_done(ctx-&gt;dash, (u32) group-&gt;idx, 1);</span>
<span class="lineNum">    2224 </span><span class="lineCov">        105 :                 gf_dash_group_select(ctx-&gt;dash, (u32) group-&gt;idx, GF_FALSE);</span>
<span class="lineNum">    2225 </span><span class="lineCov">        105 :                 group-&gt;is_playing = GF_FALSE;</span>
<span class="lineNum">    2226 </span><span class="lineCov">        105 :                 group-&gt;prev_is_init_segment = GF_FALSE;</span>
<span class="lineNum">    2227 </span><span class="lineCov">        105 :                 if (ctx-&gt;nb_playing) {</span>
<span class="lineNum">    2228 </span><span class="lineCov">        101 :                         ctx-&gt;initial_play = GF_FALSE;</span>
<span class="lineNum">    2229 </span><span class="lineCov">        101 :                         group-&gt;force_seg_switch = GF_TRUE;</span>
<span class="lineNum">    2230 </span><span class="lineCov">        101 :                         ctx-&gt;nb_playing--;</span>
<span class="lineNum">    2231 </span><span class="lineCov">        101 :                         if (!ctx-&gt;nb_playing) ctx-&gt;check_eos = GF_TRUE;</span>
<span class="lineNum">    2232 </span>            :                 }
<span class="lineNum">    2233 </span>            :                 //forward new event to source pid
<span class="lineNum">    2234 </span><span class="lineCov">        105 :                 src_evt = *fevt;</span>
<span class="lineNum">    2235 </span><span class="lineCov">        105 :                 src_evt.base.on_pid = ipid;</span>
<span class="lineNum">    2236 </span><span class="lineCov">        105 :                 gf_filter_pid_send_event(ipid, &amp;src_evt);</span>
<span class="lineNum">    2237 </span>            : 
<span class="lineNum">    2238 </span>            :                 //cancel the event
<span class="lineNum">    2239 </span><span class="lineCov">        105 :                 return GF_TRUE;</span>
<span class="lineNum">    2240 </span><span class="lineCov">         21 :         case GF_FEVT_SET_SPEED:</span>
<span class="lineNum">    2241 </span><span class="lineCov">         21 :                 gf_dash_set_speed(ctx-&gt;dash, fevt-&gt;play.speed);</span>
<span class="lineNum">    2242 </span><span class="lineCov">         21 :                 return GF_FALSE;</span>
<span class="lineNum">    2243 </span>            : 
<span class="lineNum">    2244 </span><span class="lineNoCov">          0 :         case GF_FEVT_CAPS_CHANGE:</span>
<span class="lineNum">    2245 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;screen_res) {</span>
<span class="lineNum">    2246 </span>            :                         GF_FilterSessionCaps caps;
<span class="lineNum">    2247 </span><span class="lineNoCov">          0 :                         gf_filter_get_session_caps(ctx-&gt;filter, &amp;caps);</span>
<span class="lineNum">    2248 </span><span class="lineNoCov">          0 :                         gf_dash_set_max_resolution(ctx-&gt;dash, caps.max_screen_width, caps.max_screen_height, caps.max_screen_bpp);</span>
<span class="lineNum">    2249 </span>            :                 }
<span class="lineNum">    2250 </span>            :                 return GF_TRUE;
<span class="lineNum">    2251 </span>            :         case GF_FEVT_INFO_UPDATE:
<span class="lineNum">    2252 </span>            :                 //propagate
<span class="lineNum">    2253 </span>            :                 return GF_FALSE;
<span class="lineNum">    2254 </span>            :         default:
<span class="lineNum">    2255 </span>            :                 break;
<span class="lineNum">    2256 </span>            :         }
<span class="lineNum">    2257 </span>            : 
<span class="lineNum">    2258 </span>            :         //by default cancel all events
<span class="lineNum">    2259 </span><span class="lineCov">         81 :         return GF_TRUE;</span>
<span class="lineNum">    2260 </span>            : }
<span class="lineNum">    2261 </span>            : 
<span class="lineNum">    2262 </span>            : 
<a name="2263"><span class="lineNum">    2263 </span>            : GF_Err gf_dash_group_push_tfrf(GF_DashClient *dash, u32 idx, void *tfrf, u32 timescale);</a>
<span class="lineNum">    2264 </span>            : 
<span class="lineNum">    2265 </span><span class="lineCov">     125019 : static void dashdmx_update_group_stats(GF_DASHDmxCtx *ctx, GF_DASHGroup *group)</span>
<span class="lineNum">    2266 </span>            : {
<span class="lineNum">    2267 </span>            :         u32 bytes_per_sec = 0;
<span class="lineNum">    2268 </span>            :         u64 file_size = 0;
<span class="lineNum">    2269 </span>            :         u32 dep_rep_idx;
<span class="lineNum">    2270 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">    2271 </span><span class="lineCov">     125019 :         GF_PropertyEntry *pe=NULL;</span>
<span class="lineNum">    2272 </span>            :         Bool broadcast_flag = GF_FALSE;
<span class="lineNum">    2273 </span><span class="lineCov">     247057 :         if (group-&gt;stats_uploaded) return;</span>
<span class="lineNum">    2274 </span><span class="lineCov">      17134 :         if (group-&gt;prev_is_init_segment) return;</span>
<span class="lineNum">    2275 </span><span class="lineCov">       7735 :         if (!group-&gt;seg_filter_src) return;</span>
<span class="lineNum">    2276 </span>            : 
<span class="lineNum">    2277 </span><span class="lineCov">       7735 :         p = gf_filter_get_info(group-&gt;seg_filter_src, GF_PROP_PID_FILE_CACHED, &amp;pe);</span>
<span class="lineNum">    2278 </span><span class="lineCov">       7735 :         if (!p || !p-&gt;value.boolean) {</span>
<span class="lineNum">    2279 </span>            :                 u64 us_since_start = 0;
<span class="lineNum">    2280 </span>            :                 u64 down_bytes = 0;
<span class="lineNum">    2281 </span>            :                 u32 bits_per_sec = 0;
<span class="lineNum">    2282 </span><span class="lineCov">       4754 :                 u32 now = gf_sys_clock();</span>
<span class="lineNum">    2283 </span>            : 
<span class="lineNum">    2284 </span><span class="lineCov">       4754 :                 if (!ctx-&gt;abort || (now - group-&gt;last_bw_check &lt; ctx-&gt;bwcheck)) {</span>
<span class="lineNum">    2285 </span><span class="lineCov">       4636 :                         gf_filter_release_property(pe);</span>
<span class="lineNum">    2286 </span><span class="lineCov">       4636 :                         return;</span>
<span class="lineNum">    2287 </span>            :                 }
<span class="lineNum">    2288 </span><span class="lineCov">        118 :                 group-&gt;last_bw_check = now;</span>
<span class="lineNum">    2289 </span>            :                 //we allow file abort, check the download
<span class="lineNum">    2290 </span>            : 
<span class="lineNum">    2291 </span><span class="lineCov">        118 :                 p = gf_filter_get_info(group-&gt;seg_filter_src, GF_PROP_PID_DOWN_RATE, &amp;pe);</span>
<span class="lineNum">    2292 </span><span class="lineCov">        118 :                 if (p) bits_per_sec = p-&gt;value.uint;</span>
<span class="lineNum">    2293 </span>            : 
<span class="lineNum">    2294 </span><span class="lineCov">        118 :                 p = gf_filter_get_info(group-&gt;seg_filter_src, GF_PROP_PID_DOWN_SIZE, &amp;pe);</span>
<span class="lineNum">    2295 </span><span class="lineCov">        118 :                 if (p) file_size = p-&gt;value.longuint;</span>
<span class="lineNum">    2296 </span>            : 
<span class="lineNum">    2297 </span><span class="lineCov">        118 :                 p = gf_filter_get_info(group-&gt;seg_filter_src, GF_PROP_PID_DOWN_BYTES, &amp;pe);</span>
<span class="lineNum">    2298 </span><span class="lineCov">        118 :                 if (p) down_bytes = p-&gt;value.longuint;</span>
<span class="lineNum">    2299 </span>            : 
<span class="lineNum">    2300 </span><span class="lineCov">        118 :                 us_since_start = gf_sys_clock_high_res() - group-&gt;us_at_seg_start;</span>
<span class="lineNum">    2301 </span><span class="lineCov">        118 :                 gf_dash_group_check_bandwidth(ctx-&gt;dash, group-&gt;idx, bits_per_sec, file_size, down_bytes, us_since_start);</span>
<span class="lineNum">    2302 </span>            : 
<span class="lineNum">    2303 </span><span class="lineCov">        118 :                 gf_filter_release_property(pe);</span>
<span class="lineNum">    2304 </span><span class="lineCov">        118 :                 return;</span>
<span class="lineNum">    2305 </span>            :         }
<span class="lineNum">    2306 </span><span class="lineCov">       2981 :         group-&gt;stats_uploaded = GF_TRUE;</span>
<span class="lineNum">    2307 </span>            : 
<span class="lineNum">    2308 </span><span class="lineCov">       2981 :         p = gf_filter_get_info(group-&gt;seg_filter_src, GF_PROP_PID_DOWN_RATE, &amp;pe);</span>
<span class="lineNum">    2309 </span><span class="lineCov">       2981 :         if (p) bytes_per_sec = p-&gt;value.uint / 8;</span>
<span class="lineNum">    2310 </span>            : 
<span class="lineNum">    2311 </span><span class="lineCov">       2981 :         p = gf_filter_get_info(group-&gt;seg_filter_src, GF_PROP_PID_DOWN_SIZE, &amp;pe);</span>
<span class="lineNum">    2312 </span><span class="lineCov">       2981 :         if (p) file_size = p-&gt;value.longuint;</span>
<span class="lineNum">    2313 </span>            : 
<span class="lineNum">    2314 </span><span class="lineCov">       2981 :         p = gf_filter_get_info_str(group-&gt;seg_filter_src, &quot;x-route&quot;, &amp;pe);</span>
<span class="lineNum">    2315 </span><span class="lineCov">       2981 :         if (p &amp;&amp; p-&gt;value.string &amp;&amp; !strcmp(p-&gt;value.string, &quot;yes&quot;)) {</span>
<span class="lineNum">    2316 </span>            :                 broadcast_flag = GF_TRUE;
<span class="lineNum">    2317 </span>            :         }
<span class="lineNum">    2318 </span><span class="lineCov">       2981 :         if (group-&gt;nb_group_deps)</span>
<span class="lineNum">    2319 </span><span class="lineCov">       1607 :                 dep_rep_idx = group-&gt;current_group_dep ? (group-&gt;current_group_dep-1) : group-&gt;nb_group_deps;</span>
<span class="lineNum">    2320 </span>            :         else
<span class="lineNum">    2321 </span><span class="lineCov">       1374 :                 dep_rep_idx = group-&gt;current_dependent_rep_idx;</span>
<span class="lineNum">    2322 </span>            : 
<span class="lineNum">    2323 </span><span class="lineCov">       2981 :         gf_dash_group_store_stats(ctx-&gt;dash, group-&gt;idx, dep_rep_idx, bytes_per_sec, file_size, broadcast_flag, gf_sys_clock_high_res() - group-&gt;us_at_seg_start);</span>
<span class="lineNum">    2324 </span>            : 
<span class="lineNum">    2325 </span><span class="lineCov">       2981 :         p = gf_filter_get_info(group-&gt;seg_filter_src, GF_PROP_PID_FILE_CACHED, &amp;pe);</span>
<span class="lineNum">    2326 </span><span class="lineCov">       2981 :         if (p &amp;&amp; p-&gt;value.boolean)</span>
<span class="lineNum">    2327 </span><span class="lineCov">       2981 :                 group-&gt;stats_uploaded = GF_TRUE;</span>
<span class="lineNum">    2328 </span>            : 
<span class="lineNum">    2329 </span><span class="lineCov">       2981 :         gf_filter_release_property(pe);</span>
<a name="2330"><span class="lineNum">    2330 </span>            : }</a>
<span class="lineNum">    2331 </span>            : 
<span class="lineNum">    2332 </span><span class="lineCov">       4326 : static void dashdmx_switch_segment(GF_DASHDmxCtx *ctx, GF_DASHGroup *group)</span>
<span class="lineNum">    2333 </span>            : {
<span class="lineNum">    2334 </span>            :         u32 dependent_representation_index;
<span class="lineNum">    2335 </span>            :         GF_Err e;
<span class="lineNum">    2336 </span>            :         Bool has_scalable_next;
<span class="lineNum">    2337 </span>            :         Bool seg_disabled;
<span class="lineNum">    2338 </span>            :         GF_FilterEvent evt;
<span class="lineNum">    2339 </span>            :         const char *next_url, *next_url_init_or_switch_segment, *src_url, *key_url;
<span class="lineNum">    2340 </span>            :         u64 start_range, end_range, switch_start_range, switch_end_range;
<span class="lineNum">    2341 </span>            :         bin128 key_IV;
<span class="lineNum">    2342 </span>            :         u32 group_idx;
<span class="lineNum">    2343 </span>            : 
<span class="lineNum">    2344 </span><span class="lineCov">       4326 :         group-&gt;init_ok = GF_TRUE;</span>
<span class="lineNum">    2345 </span>            : 
<span class="lineNum">    2346 </span><span class="lineCov">       4326 : fetch_next:</span>
<span class="lineNum">    2347 </span>            :         assert(group-&gt;nb_eos || group-&gt;seg_was_not_ready || group-&gt;in_error);
<span class="lineNum">    2348 </span><span class="lineCov">       4326 :         group-&gt;wait_for_pck = GF_TRUE;</span>
<span class="lineNum">    2349 </span><span class="lineCov">       4326 :         group-&gt;in_error = GF_FALSE;</span>
<span class="lineNum">    2350 </span><span class="lineCov">       4326 :         if (group-&gt;segment_sent) {</span>
<span class="lineNum">    2351 </span><span class="lineCov">       2946 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] group %d drop current segment\n&quot;, group-&gt;idx));</span>
<span class="lineNum">    2352 </span><span class="lineCov">       2946 :                 if (!group-&gt;current_group_dep &amp;&amp; !group-&gt;next_dependent_rep_idx) {</span>
<span class="lineNum">    2353 </span><span class="lineCov">       1500 :                         gf_dash_group_discard_segment(ctx-&gt;dash, group-&gt;idx);</span>
<span class="lineNum">    2354 </span>            : 
<span class="lineNum">    2355 </span>            :                         //special case for group dependencies (tiling): signal segment switch
<span class="lineNum">    2356 </span>            :                         //so that tileagg may detect losses
<span class="lineNum">    2357 </span><span class="lineCov">       1500 :                         if (group-&gt;nb_group_deps) {</span>
<span class="lineNum">    2358 </span><span class="lineCov">        159 :                                 GF_FilterPid *opid = dashdmx_opid_from_group(ctx, group);</span>
<span class="lineNum">    2359 </span><span class="lineCov">        159 :                                 if (opid) {</span>
<span class="lineNum">    2360 </span><span class="lineCov">        159 :                                         GF_FEVT_INIT(evt, GF_FEVT_PLAY_HINT, opid);</span>
<span class="lineNum">    2361 </span><span class="lineCov">        159 :                                         evt.play.forced_dash_segment_switch = GF_TRUE;</span>
<span class="lineNum">    2362 </span><span class="lineCov">        159 :                                         gf_filter_pid_send_event(opid, &amp;evt);</span>
<span class="lineNum">    2363 </span>            :                                 }
<span class="lineNum">    2364 </span>            :                         }
<span class="lineNum">    2365 </span><span class="lineCov">       1500 :                         if (group-&gt;seg_discard_state==1)</span>
<span class="lineNum">    2366 </span><span class="lineNoCov">          0 :                                 group-&gt;seg_discard_state = 2;</span>
<span class="lineNum">    2367 </span>            :                 }
<span class="lineNum">    2368 </span>            : 
<span class="lineNum">    2369 </span><span class="lineCov">       2946 :                 group-&gt;segment_sent = GF_FALSE;</span>
<span class="lineNum">    2370 </span>            :                 //no thread mode, we work with at most one entry in cache, call process right away to get the group next URL ready
<span class="lineNum">    2371 </span><span class="lineCov">       2946 :                 gf_dash_process(ctx-&gt;dash);</span>
<span class="lineNum">    2372 </span>            :         }
<span class="lineNum">    2373 </span>            : 
<span class="lineNum">    2374 </span>            : #if 0
<span class="lineNum">    2375 </span>            :         if (group_done) {
<span class="lineNum">    2376 </span>            :                 if (!gf_dash_get_period_switch_status(ctx-&gt;dash) &amp;&amp; gf_dash_in_last_period(ctx-&gt;dash, GF_TRUE)) {
<span class="lineNum">    2377 </span>            :                         return;
<span class="lineNum">    2378 </span>            :                 }
<span class="lineNum">    2379 </span>            :         }
<span class="lineNum">    2380 </span>            : #endif
<span class="lineNum">    2381 </span>            : 
<span class="lineNum">    2382 </span>            :         //special case if we had a discard of a dependent seg: we wait for the output PIDs to be flushed
<span class="lineNum">    2383 </span>            :         //so that we don't send a GF_FEVT_PLAY_HINT event before the previous segment is completely produced
<span class="lineNum">    2384 </span>            :         //this is mostly for tileagg for the time being and could need further refinements
<span class="lineNum">    2385 </span><span class="lineCov">       4326 :         if (group-&gt;seg_discard_state == 2) {</span>
<span class="lineNum">    2386 </span>            :                 u32 i;
<span class="lineNum">    2387 </span><span class="lineNoCov">          0 :                 for (i=0; i &lt; gf_filter_get_opid_count(ctx-&gt;filter); i++) {</span>
<span class="lineNum">    2388 </span><span class="lineNoCov">          0 :                         GF_FilterPid *opid = gf_filter_get_opid(ctx-&gt;filter, i );</span>
<span class="lineNum">    2389 </span><span class="lineNoCov">          0 :                         GF_DASHGroup *g = gf_filter_pid_get_udta( opid );</span>
<span class="lineNum">    2390 </span><span class="lineNoCov">          0 :                         if (g != group) continue;</span>
<span class="lineNum">    2391 </span><span class="lineNoCov">          0 :                         if (gf_filter_pid_would_block(opid)) {</span>
<span class="lineNum">    2392 </span><span class="lineNoCov">          0 :                                 group-&gt;seg_was_not_ready = GF_TRUE;</span>
<span class="lineNum">    2393 </span><span class="lineNoCov">          0 :                                 group-&gt;stats_uploaded = GF_TRUE;</span>
<span class="lineNum">    2394 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] some pids blocked on group with discard, waiting before fetching next segment\n&quot;));</span>
<span class="lineNum">    2395 </span><span class="lineCov">       1297 :                                 return;</span>
<span class="lineNum">    2396 </span>            :                         }
<span class="lineNum">    2397 </span>            :                 }
<span class="lineNum">    2398 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] all pids unblocked on group with discard, fetching next segment\n&quot;));</span>
<span class="lineNum">    2399 </span><span class="lineNoCov">          0 :                 group-&gt;seg_discard_state = 0;</span>
<span class="lineNum">    2400 </span>            :         }
<span class="lineNum">    2401 </span>            : 
<span class="lineNum">    2402 </span>            : 
<span class="lineNum">    2403 </span>            :         dependent_representation_index = 0;
<span class="lineNum">    2404 </span><span class="lineCov">       4326 :         group_idx = group-&gt;idx;</span>
<span class="lineNum">    2405 </span><span class="lineCov">       4326 :         if (group-&gt;nb_group_deps) {</span>
<span class="lineNum">    2406 </span><span class="lineCov">       1612 :                 dependent_representation_index = group-&gt;current_group_dep;</span>
<span class="lineNum">    2407 </span><span class="lineCov">       2714 :         } else if (group-&gt;next_dependent_rep_idx) {</span>
<span class="lineNum">    2408 </span><span class="lineNoCov">          0 :                 dashdmx_update_group_stats(ctx, group);</span>
<span class="lineNum">    2409 </span><span class="lineNoCov">          0 :                 dependent_representation_index = group-&gt;current_dependent_rep_idx = group-&gt;next_dependent_rep_idx;</span>
<span class="lineNum">    2410 </span><span class="lineCov">       2714 :         } else if (group-&gt;current_dependent_rep_idx) {</span>
<span class="lineNum">    2411 </span><span class="lineNoCov">          0 :                 dashdmx_update_group_stats(ctx, group);</span>
<span class="lineNum">    2412 </span><span class="lineNoCov">          0 :                 group-&gt;current_dependent_rep_idx = 0;</span>
<span class="lineNum">    2413 </span>            :         }
<span class="lineNum">    2414 </span>            : 
<span class="lineNum">    2415 </span><span class="lineCov">       4326 :         group-&gt;stats_uploaded = GF_FALSE;</span>
<span class="lineNum">    2416 </span>            : 
<span class="lineNum">    2417 </span><span class="lineCov">       4326 :         e = gf_dash_group_get_next_segment_location(ctx-&gt;dash, group_idx, dependent_representation_index, &amp;next_url, &amp;start_range, &amp;end_range,</span>
<span class="lineNum">    2418 </span>            :                         NULL, &amp;next_url_init_or_switch_segment, &amp;switch_start_range , &amp;switch_end_range,
<span class="lineNum">    2419 </span>            :                         &amp;src_url, &amp;has_scalable_next, &amp;key_url, &amp;key_IV);
<span class="lineNum">    2420 </span>            : 
<span class="lineNum">    2421 </span><span class="lineCov">       4326 :         if (e == GF_EOS) {</span>
<span class="lineNum">    2422 </span><span class="lineCov">        201 :                 group-&gt;eos_detected = GF_TRUE;</span>
<span class="lineNum">    2423 </span><span class="lineCov">        201 :                 return;</span>
<span class="lineNum">    2424 </span>            :         }
<span class="lineNum">    2425 </span>            :         seg_disabled = GF_FALSE;
<span class="lineNum">    2426 </span><span class="lineCov">       4125 :         group-&gt;eos_detected = GF_FALSE;</span>
<span class="lineNum">    2427 </span><span class="lineCov">       4125 :         if (e == GF_URL_REMOVED) {</span>
<span class="lineNum">    2428 </span>            :                 seg_disabled = GF_TRUE;
<span class="lineNum">    2429 </span>            :                 e = GF_OK;
<span class="lineNum">    2430 </span>            :         }
<span class="lineNum">    2431 </span>            : 
<span class="lineNum">    2432 </span><span class="lineCov">       4125 :         if (e != GF_OK) {</span>
<span class="lineNum">    2433 </span><span class="lineCov">       1044 :                 if (e == GF_BUFFER_TOO_SMALL) {</span>
<span class="lineNum">    2434 </span><span class="lineCov">       1044 :                         group-&gt;seg_was_not_ready = GF_TRUE;</span>
<span class="lineNum">    2435 </span><span class="lineCov">       1044 :                         group-&gt;stats_uploaded = GF_TRUE;</span>
<span class="lineNum">    2436 </span><span class="lineCov">       1044 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] group %d next segment name not known yet!\n&quot;, group-&gt;idx));</span>
<span class="lineNum">    2437 </span><span class="lineCov">       1044 :                         gf_filter_ask_rt_reschedule(ctx-&gt;filter, 10000);</span>
<span class="lineNum">    2438 </span>            : //                      gf_filter_post_process_task(ctx-&gt;filter);
<span class="lineNum">    2439 </span>            :                 } else {
<span class="lineNum">    2440 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[DASHDmx] group %d error fetching next segment name: %s\n&quot;, group-&gt;idx, gf_error_to_string(e) ));</span>
<span class="lineNum">    2441 </span>            :                 }
<span class="lineNum">    2442 </span>            :                 return;
<span class="lineNum">    2443 </span>            :         }
<span class="lineNum">    2444 </span>            : 
<span class="lineNum">    2445 </span><span class="lineCov">       3081 :         if (!has_scalable_next) {</span>
<span class="lineNum">    2446 </span><span class="lineCov">       1634 :                 group-&gt;next_dependent_rep_idx = 0;</span>
<span class="lineNum">    2447 </span>            :         } else {
<span class="lineNum">    2448 </span><span class="lineCov">       1447 :                 group-&gt;next_dependent_rep_idx++;</span>
<span class="lineNum">    2449 </span>            :         }
<span class="lineNum">    2450 </span>            : 
<span class="lineNum">    2451 </span><span class="lineCov">       3081 :         if (group-&gt;nb_group_deps) {</span>
<span class="lineNum">    2452 </span><span class="lineCov">       1607 :                 group-&gt;current_group_dep++;</span>
<span class="lineNum">    2453 </span><span class="lineCov">       1607 :                 if (group-&gt;current_group_dep&gt;group-&gt;nb_group_deps)</span>
<span class="lineNum">    2454 </span><span class="lineCov">        160 :                         group-&gt;current_group_dep = 0;</span>
<span class="lineNum">    2455 </span>            :         }
<span class="lineNum">    2456 </span>            : 
<span class="lineNum">    2457 </span>            :         assert(next_url);
<span class="lineNum">    2458 </span><span class="lineCov">       3081 :         group-&gt;seg_was_not_ready = GF_FALSE;</span>
<span class="lineNum">    2459 </span>            : 
<span class="lineNum">    2460 </span><span class="lineCov">       3081 :         if (next_url_init_or_switch_segment &amp;&amp; !group-&gt;init_switch_seg_sent) {</span>
<span class="lineNum">    2461 </span><span class="lineCov">         52 :                 if (group-&gt;in_is_cryptfile) {</span>
<span class="lineNum">    2462 </span><span class="lineNoCov">          0 :                         gf_cryptfin_set_kms(group-&gt;seg_filter_src, key_url, key_IV);</span>
<span class="lineNum">    2463 </span>            :                 }
<span class="lineNum">    2464 </span><span class="lineCov">         52 :                 GF_FEVT_INIT(evt, GF_FEVT_SOURCE_SWITCH,  NULL);</span>
<span class="lineNum">    2465 </span><span class="lineCov">         52 :                 evt.seek.start_offset = switch_start_range;</span>
<span class="lineNum">    2466 </span><span class="lineCov">         52 :                 evt.seek.end_offset = switch_end_range;</span>
<span class="lineNum">    2467 </span><span class="lineCov">         52 :                 evt.seek.source_switch = next_url_init_or_switch_segment;</span>
<span class="lineNum">    2468 </span><span class="lineCov">         52 :                 evt.seek.is_init_segment = GF_TRUE;</span>
<span class="lineNum">    2469 </span><span class="lineCov">         52 :                 evt.seek.skip_cache_expiration = GF_TRUE;</span>
<span class="lineNum">    2470 </span>            : 
<span class="lineNum">    2471 </span><span class="lineCov">         52 :                 group-&gt;prev_is_init_segment = GF_TRUE;</span>
<span class="lineNum">    2472 </span>            : 
<span class="lineNum">    2473 </span><span class="lineCov">         52 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] group %d queuing next init/switching segment %s\n&quot;, group-&gt;idx, next_url_init_or_switch_segment));</span>
<span class="lineNum">    2474 </span>            : 
<span class="lineNum">    2475 </span><span class="lineCov">         52 :                 group-&gt;signal_seg_name = (ctx-&gt;forward==DFWD_FILE) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2476 </span><span class="lineCov">         52 :                 group-&gt;init_switch_seg_sent = GF_TRUE;</span>
<span class="lineNum">    2477 </span><span class="lineCov">         52 :                 gf_filter_send_event(group-&gt;seg_filter_src, &amp;evt, GF_FALSE);</span>
<span class="lineNum">    2478 </span><span class="lineCov">         52 :                 return;</span>
<span class="lineNum">    2479 </span>            :         }
<span class="lineNum">    2480 </span><span class="lineCov">       3029 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] group %d queuing next media segment %s\n&quot;, group-&gt;idx, next_url));</span>
<span class="lineNum">    2481 </span>            : 
<span class="lineNum">    2482 </span><span class="lineCov">       3029 :         group-&gt;segment_sent = GF_TRUE;</span>
<span class="lineNum">    2483 </span><span class="lineCov">       3029 :         group-&gt;prev_is_init_segment = GF_FALSE;</span>
<span class="lineNum">    2484 </span><span class="lineCov">       3029 :         group-&gt;init_switch_seg_sent = GF_FALSE;</span>
<span class="lineNum">    2485 </span><span class="lineCov">       3029 :         group-&gt;signal_seg_name = (ctx-&gt;forward==DFWD_FILE) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2486 </span><span class="lineCov">       3029 :         group-&gt;us_at_seg_start = gf_sys_clock_high_res();</span>
<span class="lineNum">    2487 </span>            : 
<span class="lineNum">    2488 </span><span class="lineCov">       3029 :         if (seg_disabled) {</span>
<span class="lineNum">    2489 </span>            :                 u32 dep_rep_idx;
<span class="lineNum">    2490 </span><span class="lineNoCov">          0 :                 if (group-&gt;nb_group_deps)</span>
<span class="lineNum">    2491 </span><span class="lineNoCov">          0 :                         dep_rep_idx = group-&gt;current_group_dep ? (group-&gt;current_group_dep-1) : group-&gt;nb_group_deps;</span>
<span class="lineNum">    2492 </span>            :                 else
<span class="lineNum">    2493 </span><span class="lineNoCov">          0 :                         dep_rep_idx = group-&gt;current_dependent_rep_idx;</span>
<span class="lineNum">    2494 </span>            : 
<span class="lineNum">    2495 </span><span class="lineNoCov">          0 :                 gf_dash_group_store_stats(ctx-&gt;dash, group-&gt;idx, dep_rep_idx, 0, 0, 0, 0);</span>
<span class="lineNum">    2496 </span><span class="lineNoCov">          0 :                 if (!group-&gt;seg_discard_state)</span>
<span class="lineNum">    2497 </span><span class="lineNoCov">          0 :                         group-&gt;seg_discard_state = 1;</span>
<span class="lineNum">    2498 </span>            :                 goto fetch_next;
<span class="lineNum">    2499 </span>            :         }
<span class="lineNum">    2500 </span>            : 
<span class="lineNum">    2501 </span><span class="lineCov">       3029 :         if (group-&gt;in_is_cryptfile) {</span>
<span class="lineNum">    2502 </span><span class="lineNoCov">          0 :                 gf_cryptfin_set_kms(group-&gt;seg_filter_src, key_url, key_IV);</span>
<span class="lineNum">    2503 </span>            :         }
<span class="lineNum">    2504 </span>            : 
<span class="lineNum">    2505 </span><span class="lineCov">       3029 :         GF_FEVT_INIT(evt, GF_FEVT_SOURCE_SWITCH, NULL);</span>
<span class="lineNum">    2506 </span><span class="lineCov">       3029 :         evt.seek.source_switch = next_url;</span>
<span class="lineNum">    2507 </span><span class="lineCov">       3029 :         evt.seek.start_offset = start_range;</span>
<span class="lineNum">    2508 </span><span class="lineCov">       3029 :         evt.seek.end_offset = end_range;</span>
<span class="lineNum">    2509 </span>            :         evt.seek.is_init_segment = GF_FALSE;
<span class="lineNum">    2510 </span><span class="lineCov">       3029 :         gf_filter_send_event(group-&gt;seg_filter_src, &amp;evt, GF_FALSE);</span>
<a name="2511"><span class="lineNum">    2511 </span>            : }</a>
<span class="lineNum">    2512 </span>            : 
<span class="lineNum">    2513 </span><span class="lineNoCov">          0 : GF_Err dashin_abort(GF_DASHDmxCtx *ctx)</span>
<span class="lineNum">    2514 </span>            : {
<span class="lineNum">    2515 </span>            :         u32 i;
<span class="lineNum">    2516 </span><span class="lineNoCov">          0 :         if (ctx-&gt;in_error) return GF_EOS;</span>
<span class="lineNum">    2517 </span>            :         
<span class="lineNum">    2518 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;gf_filter_get_ipid_count(ctx-&gt;filter); i++) {</span>
<span class="lineNum">    2519 </span>            :                 GF_FilterEvent evt;
<span class="lineNum">    2520 </span><span class="lineNoCov">          0 :                 GF_FilterPid *pid = gf_filter_get_ipid(ctx-&gt;filter, i);</span>
<span class="lineNum">    2521 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_discard(pid, GF_TRUE);</span>
<span class="lineNum">    2522 </span><span class="lineNoCov">          0 :                 GF_FEVT_INIT(evt, GF_FEVT_STOP, pid);</span>
<span class="lineNum">    2523 </span><span class="lineNoCov">          0 :                 gf_filter_pid_send_event(pid, &amp;evt);</span>
<span class="lineNum">    2524 </span>            :         }
<span class="lineNum">    2525 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;gf_filter_get_opid_count(ctx-&gt;filter); i++) {</span>
<span class="lineNum">    2526 </span><span class="lineNoCov">          0 :                 GF_FilterPid *pid = gf_filter_get_opid(ctx-&gt;filter, i);</span>
<span class="lineNum">    2527 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_eos(pid);</span>
<span class="lineNum">    2528 </span>            :         }
<span class="lineNum">    2529 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[DASHDmx] Fatal error, aborting\n&quot;));</span>
<span class="lineNum">    2530 </span><span class="lineNoCov">          0 :         ctx-&gt;in_error = GF_TRUE;</span>
<span class="lineNum">    2531 </span><span class="lineNoCov">          0 :         return GF_SERVICE_ERROR;</span>
<a name="2532"><span class="lineNum">    2532 </span>            : }</a>
<span class="lineNum">    2533 </span>            : 
<span class="lineNum">    2534 </span><span class="lineCov">      37674 : GF_Err dashdmx_process(GF_Filter *filter)</span>
<span class="lineNum">    2535 </span>            : {
<span class="lineNum">    2536 </span>            :         u32 i, count;
<span class="lineNum">    2537 </span>            :         GF_FilterPacket *pck;
<span class="lineNum">    2538 </span>            :         GF_Err e;
<span class="lineNum">    2539 </span>            :         u32 next_time_ms = 0;
<span class="lineNum">    2540 </span><span class="lineCov">      37674 :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx*) gf_filter_get_udta(filter);</span>
<span class="lineNum">    2541 </span><span class="lineCov">      37674 :         Bool check_eos = ctx-&gt;check_eos;</span>
<span class="lineNum">    2542 </span>            :         Bool has_pck = GF_FALSE;
<span class="lineNum">    2543 </span>            : 
<span class="lineNum">    2544 </span>            :         //reset group states and update stats
<span class="lineNum">    2545 </span><span class="lineCov">      37674 :         count = gf_dash_get_group_count(ctx-&gt;dash);</span>
<span class="lineNum">    2546 </span><span class="lineCov">     160142 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2547 </span><span class="lineCov">     122468 :                 GF_DASHGroup *group = gf_dash_get_group_udta(ctx-&gt;dash, i);</span>
<span class="lineNum">    2548 </span><span class="lineCov">     122468 :                 if (!group) continue;</span>
<span class="lineNum">    2549 </span><span class="lineCov">      69199 :                 group-&gt;nb_eos = 0;</span>
<span class="lineNum">    2550 </span><span class="lineCov">      69199 :                 if (group-&gt;eos_detected) check_eos = GF_TRUE;</span>
<span class="lineNum">    2551 </span>            :         }
<span class="lineNum">    2552 </span>            : 
<span class="lineNum">    2553 </span><span class="lineCov">      37674 :         if (!ctx-&gt;mpd_pid)</span>
<span class="lineNum">    2554 </span>            :                 return GF_EOS;
<span class="lineNum">    2555 </span>            : 
<span class="lineNum">    2556 </span>            :         //check MPD pid
<span class="lineNum">    2557 </span><span class="lineCov">      37673 :         pck = gf_filter_pid_get_packet(ctx-&gt;mpd_pid);</span>
<span class="lineNum">    2558 </span><span class="lineCov">      37673 :         if (pck) {</span>
<span class="lineNum">    2559 </span><span class="lineCov">        113 :                 gf_filter_pid_drop_packet(ctx-&gt;mpd_pid);</span>
<span class="lineNum">    2560 </span>            :         }
<span class="lineNum">    2561 </span><span class="lineCov">      37673 :         e = gf_dash_process(ctx-&gt;dash);</span>
<span class="lineNum">    2562 </span><span class="lineCov">      37673 :         if (e == GF_IP_NETWORK_EMPTY) {</span>
<span class="lineNum">    2563 </span><span class="lineCov">         37 :                 gf_filter_ask_rt_reschedule(filter, 100000);</span>
<span class="lineNum">    2564 </span><span class="lineCov">         37 :                 return GF_OK;</span>
<span class="lineNum">    2565 </span>            :         }
<span class="lineNum">    2566 </span><span class="lineCov">      37636 :         else if (e==GF_SERVICE_ERROR) {</span>
<span class="lineNum">    2567 </span><span class="lineNoCov">          0 :                 return dashin_abort(ctx);</span>
<span class="lineNum">    2568 </span>            :         }
<span class="lineNum">    2569 </span><span class="lineCov">      37636 :         if (e)</span>
<span class="lineNum">    2570 </span>            :                 return e;
<span class="lineNum">    2571 </span>            : 
<span class="lineNum">    2572 </span><span class="lineCov">      37636 :         next_time_ms = gf_dash_get_min_wait_ms(ctx-&gt;dash);</span>
<span class="lineNum">    2573 </span><span class="lineCov">      37636 :         if (next_time_ms&gt;1000)</span>
<span class="lineNum">    2574 </span>            :                 next_time_ms=1000;
<span class="lineNum">    2575 </span>            : 
<span class="lineNum">    2576 </span>            :         //flush all media input
<span class="lineNum">    2577 </span><span class="lineCov">      37636 :         count = gf_filter_get_ipid_count(filter);</span>
<span class="lineNum">    2578 </span><span class="lineCov">     200775 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2579 </span><span class="lineCov">     163139 :                 GF_FilterPid *ipid = gf_filter_get_ipid(filter, i);</span>
<span class="lineNum">    2580 </span>            :                 GF_FilterPid *opid;
<span class="lineNum">    2581 </span>            :                 GF_DASHGroup *group;
<span class="lineNum">    2582 </span><span class="lineCov">     163139 :                 if (ipid == ctx-&gt;mpd_pid) continue;</span>
<span class="lineNum">    2583 </span><span class="lineCov">     125503 :                 opid = gf_filter_pid_get_udta(ipid);</span>
<span class="lineNum">    2584 </span><span class="lineCov">     125503 :                 group = gf_filter_pid_get_udta(opid);</span>
<span class="lineNum">    2585 </span>            : 
<span class="lineNum">    2586 </span><span class="lineCov">     125503 :                 if (!group)</span>
<span class="lineNum">    2587 </span><span class="lineCov">          6 :                         continue;</span>
<span class="lineNum">    2588 </span>            : 
<span class="lineNum">    2589 </span>            :                 while (1) {
<span class="lineNum">    2590 </span><span class="lineCov">     247202 :                         pck = gf_filter_pid_get_packet(ipid);</span>
<span class="lineNum">    2591 </span><span class="lineCov">     247202 :                         if (!group-&gt;is_playing) {</span>
<span class="lineNum">    2592 </span><span class="lineCov">      21844 :                                 if (pck) {</span>
<span class="lineNum">    2593 </span>            :                                         //in file mode, keep first packet (init seg) until we play
<span class="lineNum">    2594 </span><span class="lineCov">          8 :                                         if ((ctx-&gt;forward!=DFWD_FILE) || !group-&gt;prev_is_init_segment) {</span>
<span class="lineNum">    2595 </span><span class="lineCov">          1 :                                                 gf_filter_pid_drop_packet(ipid);</span>
<span class="lineNum">    2596 </span><span class="lineCov">          1 :                                                 continue;</span>
<span class="lineNum">    2597 </span>            :                                         }
<span class="lineNum">    2598 </span>            :                                 }
<span class="lineNum">    2599 </span>            :                                 break;
<span class="lineNum">    2600 </span>            :                         }
<span class="lineNum">    2601 </span>            : 
<span class="lineNum">    2602 </span><span class="lineCov">     225358 :                         if (!pck) {</span>
<span class="lineNum">    2603 </span><span class="lineCov">     103654 :                                 if (gf_filter_pid_is_eos(ipid) || !gf_filter_pid_is_playing(opid) || group-&gt;force_seg_switch) {</span>
<span class="lineNum">    2604 </span><span class="lineCov">      22805 :                                         group-&gt;nb_eos++;</span>
<span class="lineNum">    2605 </span>            : 
<span class="lineNum">    2606 </span>            :                                         //wait until all our inputs are done
<span class="lineNum">    2607 </span><span class="lineCov">      22805 :                                         if (group-&gt;nb_eos == group-&gt;nb_pids) {</span>
<span class="lineNum">    2608 </span>            :                                                 u32 j, nb_block = 0;
<span class="lineNum">    2609 </span>            :                                                 //check all pids in this group, postpone segment switch if blocking
<span class="lineNum">    2610 </span><span class="lineCov">      33868 :                                                 for (j=0; j&lt;count; j++) {</span>
<span class="lineNum">    2611 </span><span class="lineCov">      33868 :                                                         GF_FilterPid *an_ipid = gf_filter_get_ipid(filter, j);</span>
<span class="lineNum">    2612 </span><span class="lineCov">      33868 :                                                         GF_FilterPid *an_opid = gf_filter_pid_get_udta(an_ipid);</span>
<span class="lineNum">    2613 </span>            :                                                         GF_DASHGroup *agroup;
<span class="lineNum">    2614 </span><span class="lineCov">      33868 :                                                         if (an_ipid == ctx-&gt;mpd_pid) continue;</span>
<span class="lineNum">    2615 </span><span class="lineCov">      27252 :                                                         agroup = gf_filter_pid_get_udta(an_opid);</span>
<span class="lineNum">    2616 </span><span class="lineCov">      27252 :                                                         if (!agroup || (agroup != group)) continue;</span>
<span class="lineNum">    2617 </span>            : 
<span class="lineNum">    2618 </span><span class="lineCov">      21267 :                                                         if (gf_filter_pid_would_block(an_opid)) {</span>
<span class="lineNum">    2619 </span><span class="lineCov">      12110 :                                                                 nb_block++;</span>
<span class="lineNum">    2620 </span>            :                                                         }
<span class="lineNum">    2621 </span>            :                                                 }
<span class="lineNum">    2622 </span><span class="lineCov">       6616 :                                                 if (nb_block == group-&gt;nb_pids) {</span>
<span class="lineNum">    2623 </span><span class="lineCov">       3423 :                                                         GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[DASHDmx] End of segment for group %d but %d output pid(s) would block, postponing\n&quot;, group-&gt;idx, nb_block));</span>
<span class="lineNum">    2624 </span>            :                                                         break;
<span class="lineNum">    2625 </span>            :                                                 }
<span class="lineNum">    2626 </span>            : 
<span class="lineNum">    2627 </span>            :                                                 //good to switch, cancel all end of stream signals on pids from this group and switch
<span class="lineNum">    2628 </span><span class="lineCov">       3193 :                                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] End of segment for group %d, updating stats and switching segment\n&quot;, group-&gt;idx));</span>
<span class="lineNum">    2629 </span><span class="lineCov">      22176 :                                                 for (j=0; j&lt;count; j++) {</span>
<span class="lineNum">    2630 </span>            :                                                         const GF_PropertyValue *p;
<span class="lineNum">    2631 </span><span class="lineCov">      22176 :                                                         GF_PropertyEntry *pe=NULL;</span>
<span class="lineNum">    2632 </span><span class="lineCov">      22176 :                                                         GF_FilterPid *an_ipid = gf_filter_get_ipid(filter, j);</span>
<span class="lineNum">    2633 </span><span class="lineCov">      22176 :                                                         GF_FilterPid *an_opid = gf_filter_pid_get_udta(an_ipid);</span>
<span class="lineNum">    2634 </span>            :                                                         GF_DASHGroup *agroup;
<span class="lineNum">    2635 </span><span class="lineCov">      26508 :                                                         if (an_ipid == ctx-&gt;mpd_pid) continue;</span>
<span class="lineNum">    2636 </span><span class="lineCov">      18983 :                                                         agroup = gf_filter_pid_get_udta(an_opid);</span>
<span class="lineNum">    2637 </span><span class="lineCov">      18983 :                                                         if (!agroup || (agroup != group)) continue;</span>
<span class="lineNum">    2638 </span>            : 
<span class="lineNum">    2639 </span><span class="lineCov">      17844 :                                                         if (gf_filter_pid_is_eos(an_ipid)) {</span>
<span class="lineNum">    2640 </span><span class="lineCov">       3199 :                                                                 gf_filter_pid_clear_eos(an_ipid, GF_TRUE);</span>
<span class="lineNum">    2641 </span><span class="lineCov">       3199 :                                                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] Clearing EOS on pids from group %d\n&quot;, group-&gt;idx));</span>
<span class="lineNum">    2642 </span>            :                                                         }
<span class="lineNum">    2643 </span>            : 
<span class="lineNum">    2644 </span><span class="lineCov">      17844 :                                                         p = gf_filter_pid_get_info_str(an_ipid, &quot;smooth_tfrf&quot;, &amp;pe);</span>
<span class="lineNum">    2645 </span><span class="lineCov">      17844 :                                                         if (p) {</span>
<span class="lineNum">    2646 </span><span class="lineNoCov">          0 :                                                                 gf_dash_group_push_tfrf(ctx-&gt;dash, group-&gt;idx, p-&gt;value.ptr, gf_filter_pid_get_timescale(an_ipid));</span>
<span class="lineNum">    2647 </span>            :                                                         }
<span class="lineNum">    2648 </span><span class="lineCov">      17844 :                                                         gf_filter_release_property(pe);</span>
<span class="lineNum">    2649 </span>            :                                                 }
<span class="lineNum">    2650 </span><span class="lineCov">       3193 :                                                 dashdmx_update_group_stats(ctx, group);</span>
<span class="lineNum">    2651 </span><span class="lineCov">       3193 :                                                 group-&gt;stats_uploaded = GF_TRUE;</span>
<span class="lineNum">    2652 </span><span class="lineCov">       3193 :                                                 group-&gt;force_seg_switch = GF_FALSE;</span>
<span class="lineNum">    2653 </span><span class="lineCov">       3193 :                                                 dashdmx_switch_segment(ctx, group);</span>
<span class="lineNum">    2654 </span>            : 
<span class="lineNum">    2655 </span><span class="lineCov">       3193 :                                                 gf_filter_prevent_blocking(filter, GF_FALSE);</span>
<span class="lineNum">    2656 </span><span class="lineCov">       3193 :                                                 if (group-&gt;eos_detected &amp;&amp; !has_pck) check_eos = GF_TRUE;</span>
<span class="lineNum">    2657 </span>            :                                         }
<span class="lineNum">    2658 </span>            :                                 }
<span class="lineNum">    2659 </span>            :                                 else {
<span class="lineNum">    2660 </span><span class="lineCov">      80849 :                                         if (ctx-&gt;abort)</span>
<span class="lineNum">    2661 </span><span class="lineCov">        122 :                                                 dashdmx_update_group_stats(ctx, group);</span>
<span class="lineNum">    2662 </span>            :                                         //GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[DASHDmx] No source packet group %d and not in end of stream\n&quot;, group-&gt;idx));
<span class="lineNum">    2663 </span>            :                                 }
<span class="lineNum">    2664 </span><span class="lineCov">     100231 :                                 if (group-&gt;in_error || group-&gt;seg_was_not_ready) {</span>
<span class="lineNum">    2665 </span><span class="lineCov">       1133 :                                         dashdmx_switch_segment(ctx, group);</span>
<span class="lineNum">    2666 </span><span class="lineCov">       1133 :                                         gf_filter_prevent_blocking(filter, GF_FALSE);</span>
<span class="lineNum">    2667 </span><span class="lineCov">       1133 :                                         if (group-&gt;eos_detected &amp;&amp; !has_pck) check_eos = GF_TRUE;</span>
<span class="lineNum">    2668 </span>            :                                 }
<span class="lineNum">    2669 </span>            :                                 break;
<span class="lineNum">    2670 </span>            :                         }
<span class="lineNum">    2671 </span>            :                         has_pck = GF_TRUE;
<span class="lineNum">    2672 </span>            :                         check_eos = GF_FALSE;
<span class="lineNum">    2673 </span><span class="lineCov">     121704 :                         dashdmx_forward_packet(ctx, pck, ipid, opid, group);</span>
<span class="lineNum">    2674 </span><span class="lineCov">     121704 :                         group-&gt;wait_for_pck = GF_FALSE;</span>
<span class="lineNum">    2675 </span><span class="lineCov">     121704 :                         dashdmx_update_group_stats(ctx, group);</span>
<span class="lineNum">    2676 </span>            :                 }
<span class="lineNum">    2677 </span>            :         }
<span class="lineNum">    2678 </span>            : 
<span class="lineNum">    2679 </span><span class="lineCov">      37636 :         if (check_eos) {</span>
<span class="lineNum">    2680 </span>            :                 Bool all_groups_done = GF_TRUE;
<span class="lineNum">    2681 </span>            :                 Bool groups_not_playing = GF_TRUE;
<span class="lineNum">    2682 </span><span class="lineCov">       6512 :                 Bool is_in_last_period = gf_dash_in_last_period(ctx-&gt;dash, GF_TRUE);</span>
<span class="lineNum">    2683 </span>            : 
<span class="lineNum">    2684 </span>            :                 //not last period, check if we are done playing all groups due to stop requests
<span class="lineNum">    2685 </span><span class="lineCov">       6512 :                 if (!is_in_last_period &amp;&amp; !ctx-&gt;nb_playing) {</span>
<span class="lineNum">    2686 </span>            :                         Bool groups_done=GF_TRUE;
<span class="lineNum">    2687 </span><span class="lineCov">        267 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2688 </span><span class="lineCov">        267 :                                 GF_FilterPid *ipid = gf_filter_get_ipid(filter, i);</span>
<span class="lineNum">    2689 </span>            :                                 GF_FilterPid *opid;
<span class="lineNum">    2690 </span>            :                                 GF_DASHGroup *group;
<span class="lineNum">    2691 </span><span class="lineCov">        267 :                                 if (ipid == ctx-&gt;mpd_pid) continue;</span>
<span class="lineNum">    2692 </span><span class="lineCov">        178 :                                 opid = gf_filter_pid_get_udta(ipid);</span>
<span class="lineNum">    2693 </span><span class="lineCov">        178 :                                 group = gf_filter_pid_get_udta(opid);</span>
<span class="lineNum">    2694 </span><span class="lineCov">        178 :                                 if (!group) continue;</span>
<span class="lineNum">    2695 </span><span class="lineCov">        178 :                                 if (!group-&gt;is_playing &amp;&amp; group-&gt;eos_detected) continue;</span>
<span class="lineNum">    2696 </span>            :                                 groups_done=GF_FALSE;
<span class="lineNum">    2697 </span>            :                         }
<span class="lineNum">    2698 </span><span class="lineCov">         89 :                         if (groups_done)</span>
<span class="lineNum">    2699 </span>            :                                 is_in_last_period = GF_TRUE;
<span class="lineNum">    2700 </span>            :                 }
<span class="lineNum">    2701 </span>            : 
<span class="lineNum">    2702 </span><span class="lineCov">      33765 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2703 </span><span class="lineCov">      27253 :                         GF_FilterPid *ipid = gf_filter_get_ipid(filter, i);</span>
<span class="lineNum">    2704 </span>            :                         GF_FilterPid *opid;
<span class="lineNum">    2705 </span>            :                         GF_DASHGroup *group;
<span class="lineNum">    2706 </span><span class="lineCov">      27253 :                         if (ipid == ctx-&gt;mpd_pid) continue;</span>
<span class="lineNum">    2707 </span><span class="lineCov">      20741 :                         opid = gf_filter_pid_get_udta(ipid);</span>
<span class="lineNum">    2708 </span><span class="lineCov">      20741 :                         group = gf_filter_pid_get_udta(opid);</span>
<span class="lineNum">    2709 </span>            :                         //reset in progress
<span class="lineNum">    2710 </span><span class="lineCov">      20741 :                         if (!group) {</span>
<span class="lineNum">    2711 </span>            :                                 all_groups_done = GF_FALSE;
<span class="lineNum">    2712 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">    2713 </span>            :                         }
<span class="lineNum">    2714 </span><span class="lineCov">      20741 :                         if (group-&gt;is_playing)</span>
<span class="lineNum">    2715 </span>            :                                 groups_not_playing = GF_FALSE;
<span class="lineNum">    2716 </span>            : 
<span class="lineNum">    2717 </span><span class="lineCov">      20741 :                         if (!group-&gt;eos_detected &amp;&amp; group-&gt;is_playing) {</span>
<span class="lineNum">    2718 </span>            :                                 all_groups_done = GF_FALSE;
<span class="lineNum">    2719 </span><span class="lineCov">      20218 :                         } else if (is_in_last_period) {</span>
<span class="lineNum">    2720 </span><span class="lineCov">      19988 :                                 if (gf_filter_pid_is_eos(ipid) || group-&gt;eos_detected || gf_dash_get_group_done(ctx-&gt;dash, group-&gt;idx))</span>
<span class="lineNum">    2721 </span><span class="lineCov">      19988 :                                         gf_filter_pid_set_eos(opid);</span>
<span class="lineNum">    2722 </span>            :                                 else
<span class="lineNum">    2723 </span>            :                                         all_groups_done = GF_FALSE;
<span class="lineNum">    2724 </span>            :                         }
<span class="lineNum">    2725 </span>            :                 }
<span class="lineNum">    2726 </span><span class="lineCov">       6512 :                 if (all_groups_done) {</span>
<span class="lineNum">    2727 </span><span class="lineCov">       5989 :                         if (is_in_last_period || groups_not_playing) {</span>
<span class="lineNum">    2728 </span><span class="lineCov">       5985 :                                 if (!ctx-&gt;manifest_stop_sent) {</span>
<span class="lineNum">    2729 </span>            :                                         GF_FilterEvent evt;
<span class="lineNum">    2730 </span><span class="lineCov">         97 :                                         ctx-&gt;manifest_stop_sent = GF_TRUE;</span>
<span class="lineNum">    2731 </span><span class="lineCov">         97 :                                         GF_FEVT_INIT(evt, GF_FEVT_STOP, ctx-&gt;mpd_pid)</span>
<span class="lineNum">    2732 </span><span class="lineCov">         97 :                                         gf_filter_pid_send_event(ctx-&gt;mpd_pid, &amp;evt);</span>
<span class="lineNum">    2733 </span>            :                                 }
<span class="lineNum">    2734 </span>            :                                 return GF_EOS;
<span class="lineNum">    2735 </span>            :                         }
<span class="lineNum">    2736 </span><span class="lineCov">          4 :                         if (!gf_dash_get_period_switch_status(ctx-&gt;dash)) {</span>
<span class="lineNum">    2737 </span><span class="lineCov">         10 :                                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2738 </span><span class="lineCov">         10 :                                         GF_DASHGroup *group = gf_dash_get_group_udta(ctx-&gt;dash, i);</span>
<span class="lineNum">    2739 </span><span class="lineCov">         10 :                                         if (!group) continue;</span>
<span class="lineNum">    2740 </span><span class="lineCov">          6 :                                         group-&gt;nb_eos = 0;</span>
<span class="lineNum">    2741 </span><span class="lineCov">          6 :                                         group-&gt;eos_detected = GF_FALSE;</span>
<span class="lineNum">    2742 </span>            :                                 }
<span class="lineNum">    2743 </span>            : 
<span class="lineNum">    2744 </span><span class="lineCov">          4 :                                 gf_dash_request_period_switch(ctx-&gt;dash);</span>
<span class="lineNum">    2745 </span>            :                         }
<span class="lineNum">    2746 </span>            :                 }
<span class="lineNum">    2747 </span>            :         }
<span class="lineNum">    2748 </span>            : 
<span class="lineNum">    2749 </span><span class="lineCov">      31651 :         if (gf_dash_is_in_setup(ctx-&gt;dash))</span>
<span class="lineNum">    2750 </span><span class="lineCov">          8 :                 gf_filter_post_process_task(filter);</span>
<span class="lineNum">    2751 </span><span class="lineCov">      31643 :         else if (ctx-&gt;abort)</span>
<span class="lineNum">    2752 </span><span class="lineCov">        129 :                 gf_filter_ask_rt_reschedule(filter, 50000);</span>
<span class="lineNum">    2753 </span><span class="lineCov">      31514 :         else if (next_time_ms)</span>
<span class="lineNum">    2754 </span><span class="lineCov">         69 :                 gf_filter_ask_rt_reschedule(filter, 1000 * next_time_ms);</span>
<span class="lineNum">    2755 </span>            : 
<span class="lineNum">    2756 </span>            :         return GF_OK;
<a name="2757"><span class="lineNum">    2757 </span>            : }</a>
<span class="lineNum">    2758 </span>            : 
<span class="lineNum">    2759 </span><span class="lineCov">       3072 : static const char *dashdmx_probe_data(const u8 *data, u32 size, GF_FilterProbeScore *score)</span>
<span class="lineNum">    2760 </span>            : {
<span class="lineNum">    2761 </span>            :         char *d = (char *)data;
<span class="lineNum">    2762 </span>            :         char *res_dash, *res_m3u, *res_smooth;
<span class="lineNum">    2763 </span><span class="lineCov">       3072 :         char last_c = d[size-1];</span>
<span class="lineNum">    2764 </span><span class="lineCov">       3072 :         d[size-1] = 0;</span>
<span class="lineNum">    2765 </span><span class="lineCov">       3072 :         res_dash = strstr(data, &quot;&lt;MPD &quot;);</span>
<span class="lineNum">    2766 </span><span class="lineCov">       3072 :         res_m3u = strstr(data, &quot;#EXTM3U&quot;);</span>
<span class="lineNum">    2767 </span><span class="lineCov">       3072 :         res_smooth = strstr(data, &quot;&lt;SmoothStreamingMedia&quot;);</span>
<span class="lineNum">    2768 </span><span class="lineCov">       3072 :         d[size-1] = last_c;</span>
<span class="lineNum">    2769 </span>            : 
<span class="lineNum">    2770 </span><span class="lineCov">       3072 :         if (res_dash) {</span>
<span class="lineNum">    2771 </span><span class="lineCov">         95 :                 *score = GF_FPROBE_SUPPORTED;</span>
<span class="lineNum">    2772 </span><span class="lineCov">         95 :                 return &quot;application/dash+xml&quot;;</span>
<span class="lineNum">    2773 </span>            :         }
<span class="lineNum">    2774 </span><span class="lineCov">       2977 :         if (res_m3u) {</span>
<span class="lineNum">    2775 </span><span class="lineCov">        122 :                 *score = GF_FPROBE_SUPPORTED;</span>
<span class="lineNum">    2776 </span><span class="lineCov">        122 :                 return &quot;video/mpegurl&quot;;</span>
<span class="lineNum">    2777 </span>            :         }
<span class="lineNum">    2778 </span><span class="lineCov">       2855 :         if (res_smooth) {</span>
<span class="lineNum">    2779 </span><span class="lineCov">          2 :                 *score = GF_FPROBE_SUPPORTED;</span>
<span class="lineNum">    2780 </span><span class="lineCov">          2 :                 return &quot;application/vnd.ms-sstr+xml&quot;;</span>
<span class="lineNum">    2781 </span>            :         }
<span class="lineNum">    2782 </span>            :         return NULL;
<span class="lineNum">    2783 </span>            : }
<span class="lineNum">    2784 </span>            : 
<span class="lineNum">    2785 </span>            : #define OFFS(_n)        #_n, offsetof(GF_DASHDmxCtx, _n)
<span class="lineNum">    2786 </span>            : static const GF_FilterArgs DASHDmxArgs[] =
<span class="lineNum">    2787 </span>            : {
<span class="lineNum">    2788 </span>            :         { OFFS(auto_switch), &quot;switch quality every N segments, disabled if 0&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2789 </span>            :         { OFFS(segstore), &quot;enable file caching\n&quot;
<span class="lineNum">    2790 </span>            :                 &quot;- mem: all files are stored in memory, no disk IO\n&quot;
<span class="lineNum">    2791 </span>            :                 &quot;- disk: files are stored to disk but discarded once played\n&quot;
<span class="lineNum">    2792 </span>            :                 &quot;- cache: all files are stored to disk and kept&quot;
<span class="lineNum">    2793 </span>            :                 &quot;&quot;, GF_PROP_UINT, &quot;mem&quot;, &quot;mem|disk|cache&quot;, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2794 </span>            :         { OFFS(algo), &quot;adaptation algorithm to use\n&quot;
<span class="lineNum">    2795 </span>            :                 &quot;- none: no adaptation logic\n&quot;
<span class="lineNum">    2796 </span>            :                 &quot;- grate: GPAC legacy algo based on available rate\n&quot;
<span class="lineNum">    2797 </span>            :                 &quot;- gbuf: GPAC legacy algo based on buffer occupancy\n&quot;
<span class="lineNum">    2798 </span>            :                 &quot;- bba0: BBA-0\n&quot;
<span class="lineNum">    2799 </span>            :                 &quot;- bolaf: BOLA Finite\n&quot;
<span class="lineNum">    2800 </span>            :                 &quot;- bolab: BOLA Basic\n&quot;
<span class="lineNum">    2801 </span>            :                 &quot;- bolau: BOLA-U\n&quot;
<span class="lineNum">    2802 </span>            :                 &quot;- bolao: BOLA-O\n&quot;
<span class="lineNum">    2803 </span>            :                 &quot;- JS: use file JS (either with specified path or in $GSHARE/scripts/) for algo (.js extension may be omitted)&quot;
<span class="lineNum">    2804 </span>            :                 , GF_PROP_STRING, &quot;gbuf&quot;, &quot;none|grate|gbuf|bba0|bolaf|bolab|bolau|bolao|JS&quot;, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2805 </span>            :         { OFFS(start_with), &quot;initial selection criteria\n&quot;
<span class="lineNum">    2806 </span>            :                 &quot;- min_q: start with lowest quality\n&quot;
<span class="lineNum">    2807 </span>            :                 &quot;- max_q: start with highest quality\n&quot;
<span class="lineNum">    2808 </span>            :                 &quot;- min_bw: start with lowest bitrate\n&quot;
<span class="lineNum">    2809 </span>            :                 &quot;- max_bw: start with highest bitrate; for tiles are used, all low priority tiles will have the lower (below max) bandwidth selected\n&quot;
<span class="lineNum">    2810 </span>            :                 &quot;- max_bw_tiles: start with highest bitrate; for tiles all low priority tiles will have their lowest bandwidth selected&quot;
<span class="lineNum">    2811 </span>            :                 , GF_PROP_UINT, &quot;max_bw&quot;, &quot;min_q|max_q|min_bw|max_bw|max_bw_tiles&quot;, 0},
<span class="lineNum">    2812 </span>            : 
<span class="lineNum">    2813 </span>            :         { OFFS(max_res), &quot;use max media resolution to configure display&quot;, GF_PROP_BOOL, &quot;true&quot;, NULL, 0},
<span class="lineNum">    2814 </span>            :         { OFFS(immediate), &quot;when interactive switching is requested and immediate is set, the buffer segments are trashed&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2815 </span>            :         { OFFS(abort), &quot;allow abort during a segment download&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2816 </span>            :         { OFFS(use_bmin), &quot;use the indicated min buffer time of the MPD if true, otherwise uses default player settings&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, 0},
<span class="lineNum">    2817 </span>            : 
<span class="lineNum">    2818 </span>            :         { OFFS(shift_utc), &quot;shift DASH UTC clock in ms&quot;, GF_PROP_SINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2819 </span>            :         { OFFS(route_shift), &quot;shift ROUTE requests time by given ms&quot;, GF_PROP_SINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2820 </span>            :         { OFFS(server_utc), &quot;use ServerUTC: or Date: http headers instead of local UTC&quot;, GF_PROP_BOOL, &quot;yes&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2821 </span>            :         { OFFS(screen_res), &quot;use screen resolution in selection phase&quot;, GF_PROP_BOOL, &quot;yes&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2822 </span>            :         { OFFS(init_timeshift), &quot;set initial timeshift in ms (if &gt;0) or in per-cent of timeshift buffer (if &lt;0)&quot;, GF_PROP_SINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2823 </span>            :         { OFFS(tile_mode), &quot;tile adaptation mode\n&quot;
<span class="lineNum">    2824 </span>            :                 &quot;- none: bitrate is shared equally across all tiles\n&quot;
<span class="lineNum">    2825 </span>            :                 &quot;- rows: bitrate decreases for each row of tiles starting from the top, same rate for each tile on the row\n&quot;
<span class="lineNum">    2826 </span>            :                 &quot;- rrows: bitrate decreases for each row of tiles starting from the bottom, same rate for each tile on the row\n&quot;
<span class="lineNum">    2827 </span>            :                 &quot;- mrows: bitrate decreased for top and bottom rows only, same rate for each tile on the row\n&quot;
<span class="lineNum">    2828 </span>            :                 &quot;- cols: bitrate decreases for each columns of tiles starting from the left, same rate for each tile on the columns\n&quot;
<span class="lineNum">    2829 </span>            :                 &quot;- rcols: bitrate decreases for each columns of tiles starting from the right, same rate for each tile on the columns\n&quot;
<span class="lineNum">    2830 </span>            :                 &quot;- mcols: bitrate decreased for left and right columns only, same rate for each tile on the columns\n&quot;
<span class="lineNum">    2831 </span>            :                 &quot;- center: bitrate decreased for all tiles on the edge of the picture\n&quot;
<span class="lineNum">    2832 </span>            :                 &quot;- edges: bitrate decreased for all tiles on the center of the picture&quot;
<span class="lineNum">    2833 </span>            :                 , GF_PROP_UINT, &quot;none&quot;, &quot;none|rows|rrows|mrows|cols|rcols|mcols|center|edges&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2834 </span>            :         { OFFS(tiles_rate), &quot;indicate the amount of bandwidth to use at each quality level. The rate is recursively applied at each level, e.g. if 50%, Level1 gets 50%, level2 gets 25%, ... If 100, automatic rate allocation will be done by maximizing the quality in order of priority. If 0, bitstream will not be smoothed across tiles/qualities, and concurrency may happen between different media&quot;, GF_PROP_UINT, &quot;100&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2835 </span>            :         { OFFS(delay40X), &quot;delay in milliseconds to wait between two 40X on the same segment&quot;, GF_PROP_UINT, &quot;500&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2836 </span>            :         { OFFS(exp_threshold), &quot;delay in milliseconds to wait after the segment AvailabilityEndDate before considering the segment lost&quot;, GF_PROP_UINT, &quot;100&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2837 </span>            :         { OFFS(switch_count), &quot;indicate how many segments the client shall wait before switching up bandwidth. If 0, switch will happen as soon as the bandwidth is enough, but this is more prone to network variations&quot;, GF_PROP_UINT, &quot;1&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2838 </span>            :         { OFFS(aggressive), &quot;if enabled, switching algo targets the closest bandwidth fitting the available download rate. If no, switching algo targets the lowest bitrate representation that is above the currently played (eg does not try to switch to max bandwidth)&quot;, GF_PROP_BOOL, &quot;no&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2839 </span>            :         { OFFS(debug_as), &quot;play only the adaptation sets indicated by their indices (0-based) in the MPD&quot;, GF_PROP_UINT_LIST, NULL, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2840 </span>            :         { OFFS(speedadapt), &quot;enable adaptation based on playback speed&quot;, GF_PROP_BOOL, &quot;no&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2841 </span>            :         { OFFS(noxlink), &quot;disable xlink if period has both xlink and adaptation sets&quot;, GF_PROP_BOOL, &quot;no&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2842 </span>            :         { OFFS(query), &quot;set query string (without initial '?') to append to xlink of periods&quot;, GF_PROP_STRING, NULL, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2843 </span>            :         { OFFS(split_as), &quot;separate all qualities into different adaptation sets and stream all qualities. Dependent representations (scalable) are treated as independent&quot;, GF_PROP_BOOL, &quot;no&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2844 </span>            :         { OFFS(noseek), &quot;disable seeking of initial segment(s) in dynamic mode (useful when UTC clocks do not match)&quot;, GF_PROP_BOOL, &quot;no&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2845 </span>            :         { OFFS(bwcheck), &quot;minimum time in milliseconds between two bandwidth checks when allowing segment download abort&quot;, GF_PROP_UINT, &quot;5&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2846 </span>            :         { OFFS(lowlat), &quot;segment scheduling policy in low latency mode\n&quot;
<span class="lineNum">    2847 </span>            :                 &quot;- no: disable low latency\n&quot;
<span class="lineNum">    2848 </span>            :                 &quot;- strict: strict respect of AST offset in low latency\n&quot;
<span class="lineNum">    2849 </span>            :                 &quot;- early: allow fetching segments earlier than their AST in low latency when input demux is empty&quot;, GF_PROP_UINT, &quot;early&quot;, &quot;no|strict|early&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2850 </span>            :         { OFFS(forward), &quot;segment forwarding mode  -see filter help\n&quot;
<span class="lineNum">    2851 </span>            :                 &quot;- none: regular DASH read\n&quot;
<span class="lineNum">    2852 </span>            :                 &quot;- file: do not demux files and forward them as file pids (imply `segstore=mem`)\n&quot;
<span class="lineNum">    2853 </span>            :                 &quot;- segb: turn on [-split_as](), segment and fragment bounds signaling and DASH cue insertion\n&quot;
<span class="lineNum">    2854 </span>            :                 &quot;- mani: same as `segb` and also forward manifests&quot;
<span class="lineNum">    2855 </span>            :         , GF_PROP_UINT, &quot;none&quot;, &quot;none|file|segb|mani&quot;, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2856 </span>            :         { OFFS(fmodefwd), &quot;forward packet rather than copy them in `file` forward mode. Packet copy might improve performances in low latency mode&quot;, GF_PROP_BOOL, &quot;yes&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2857 </span>            : 
<span class="lineNum">    2858 </span>            :         { OFFS(skip_lqt), &quot;disable decoding of tiles with highest degradation hints (not visible, not gazed at) for debug purposes&quot;, GF_PROP_BOOL, &quot;no&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2859 </span>            :         { OFFS(llhls_merge), &quot;merge LL-HLS byte range parts into a single open byte range request&quot;, GF_PROP_BOOL, &quot;yes&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    2860 </span>            :         { OFFS(filemode), &quot;alias for forward=file&quot;, GF_PROP_BOOL, &quot;no&quot;, NULL, GF_FS_ARG_HINT_HIDE},
<span class="lineNum">    2861 </span>            :         { OFFS(groupsel), &quot;select groups based on language (by default all playable groups are exposed)&quot;, GF_PROP_BOOL, &quot;no&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2862 </span>            :         {0}
<span class="lineNum">    2863 </span>            : };
<span class="lineNum">    2864 </span>            : 
<span class="lineNum">    2865 </span>            : 
<span class="lineNum">    2866 </span>            : 
<span class="lineNum">    2867 </span>            : static const GF_FilterCapability DASHDmxCaps[] =
<span class="lineNum">    2868 </span>            : {
<span class="lineNum">    2869 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    2870 </span>            :         CAP_STRING(GF_CAPS_INPUT, GF_PROP_PID_FILE_EXT, &quot;mpd|m3u8|3gm|ism&quot;),
<span class="lineNum">    2871 </span>            :         CAP_STRING(GF_CAPS_INPUT, GF_PROP_PID_MIME, &quot;application/dash+xml|video/vnd.3gpp.mpd|audio/vnd.3gpp.mpd|video/vnd.mpeg.dash.mpd|audio/vnd.mpeg.dash.mpd|audio/mpegurl|video/mpegurl|application/vnd.ms-sstr+xml&quot;),
<span class="lineNum">    2872 </span>            :         CAP_UINT(GF_CAPS_OUTPUT, GF_PROP_PID_STREAM_TYPE, GF_STREAM_AUDIO),
<span class="lineNum">    2873 </span>            :         CAP_UINT(GF_CAPS_OUTPUT, GF_PROP_PID_STREAM_TYPE, GF_STREAM_VISUAL),
<span class="lineNum">    2874 </span>            :         CAP_UINT(GF_CAPS_OUTPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_RAW),
<span class="lineNum">    2875 </span>            :         {0},
<span class="lineNum">    2876 </span>            :         //accept any stream but files, framed
<span class="lineNum">    2877 </span>            :         { .code=GF_PROP_PID_STREAM_TYPE, .val.type=GF_PROP_UINT, .val.value.uint=GF_STREAM_FILE, .flags=(GF_CAPFLAG_IN_BUNDLE|GF_CAPFLAG_INPUT|GF_CAPFLAG_EXCLUDED|GF_CAPFLAG_LOADED_FILTER) },
<span class="lineNum">    2878 </span>            :         { .code=GF_PROP_PID_UNFRAMED, .val.type=GF_PROP_BOOL, .val.value.boolean=GF_TRUE, .flags=(GF_CAPFLAG_IN_BUNDLE|GF_CAPFLAG_INPUT|GF_CAPFLAG_EXCLUDED|GF_CAPFLAG_LOADED_FILTER) },
<span class="lineNum">    2879 </span>            :         CAP_UINT(GF_CAPS_OUTPUT_EXCLUDED, GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    2880 </span>            : };
<span class="lineNum">    2881 </span>            : 
<span class="lineNum">    2882 </span>            : 
<span class="lineNum">    2883 </span>            : GF_FilterRegister DASHDmxRegister = {
<span class="lineNum">    2884 </span>            :         .name = &quot;dashin&quot;,
<span class="lineNum">    2885 </span>            :         GF_FS_SET_DESCRIPTION(&quot;MPEG-DASH and HLS client&quot;)
<span class="lineNum">    2886 </span>            :         GF_FS_SET_HELP(&quot;This filter reads MPEG-DASH, HLS and MS Smooth manifests and produce media output according to its mode.\n&quot;
<span class="lineNum">    2887 </span>            :         &quot;\n&quot;
<span class="lineNum">    2888 </span>            :         &quot;# Regular mode\n&quot;
<span class="lineNum">    2889 </span>            :         &quot;This is the default mode, in which the filter produces media PIDs and frames from sources indicated in the manifest.\n&quot;
<span class="lineNum">    2890 </span>            :         &quot;The default behavior is to perform adaptation according to [-algo](), but the filter can:\n&quot;
<span class="lineNum">    2891 </span>            :         &quot;- run with no adaptation, to grab maximum quality.\n&quot;
<span class="lineNum">    2892 </span>            :         &quot;EX gpac -i MANIFEST_URL:algo=none:start_with=max_bw -o dest.mp4\n&quot;
<span class="lineNum">    2893 </span>            :         &quot;- run with no adaptation, fetching all qualities.\n&quot;
<span class="lineNum">    2894 </span>            :         &quot;EX gpac -i MANIFEST_URL:split_as fout:dst=$File$.mp4:clone\n&quot;
<span class="lineNum">    2895 </span>            :         &quot;\n&quot;
<span class="lineNum">    2896 </span>            :         &quot;# File mode\n&quot;
<span class="lineNum">    2897 </span>            :         &quot;When [-forward]() is set to `file`, the client forwards media files without demultiplexing them.\n&quot;
<span class="lineNum">    2898 </span>            :         &quot;This is mostly used to expose the DASH session to a file server such as ROUTE or HTTP.\n&quot;
<span class="lineNum">    2899 </span>            :         &quot;In this mode, the manifest is forwarded as an output PID.\n&quot;
<span class="lineNum">    2900 </span>            :         &quot;Warning: This mode cannot be set through inheritance as it changes the link capabilities of the filter. The filter MUST be explicitly declared.\n&quot;
<span class="lineNum">    2901 </span>            :         &quot;\n&quot;
<span class="lineNum">    2902 </span>            :         &quot;To expose a live DASH session to route:\n&quot;
<span class="lineNum">    2903 </span>            :         &quot;EX gpac -i MANIFEST_URL dashin:forward=file @ -o route://225.0.0.1:8000/\n&quot;
<span class="lineNum">    2904 </span>            :         &quot;\n&quot;
<span class="lineNum">    2905 </span>            :         &quot;Note: This mode used to be trigger by [-filemode]() option, still recognized.\n&quot;
<span class="lineNum">    2906 </span>            :         &quot;\n&quot;
<span class="lineNum">    2907 </span>            :         &quot;If the source has dependent media streams (scalability) and all qualities and initialization segments need to be forwarded, add [-split_as]().\n&quot;
<span class="lineNum">    2908 </span>            :         &quot;\n&quot;
<span class="lineNum">    2909 </span>            :         &quot;# Segment bound modes\n&quot;
<span class="lineNum">    2910 </span>            :         &quot;When [-forward]() is set to `segs` or `mani`, the client forwards media frames (after demux) together with segment and fragment boundaries of source files.\n&quot;
<span class="lineNum">    2911 </span>            :         &quot;\n&quot;
<span class="lineNum">    2912 </span>            :         &quot;This mode can be used to process media data and regenerating the same manifest/segmentation.\n&quot;
<span class="lineNum">    2913 </span>            :         &quot;\n&quot;
<span class="lineNum">    2914 </span>            :         &quot;EX gpac -i MANIFEST_URL:forward=mani cecrypt:cfile=DRM.xml @ -o encrypted/live.mpd:pssh=mv\n&quot;
<span class="lineNum">    2915 </span>            :         &quot;This will encrypt an existing DASH session, inject PSSH in manifest and segments.\n&quot;
<span class="lineNum">    2916 </span>            :         &quot;\n&quot;
<span class="lineNum">    2917 </span>            :         &quot;EX gpac -i MANIFEST_URL:forward=segb cecrypt:cfile=DRM.xml @ -o encrypted/live.m3u8\n&quot;
<span class="lineNum">    2918 </span>            :         &quot;This will encrypt an existing DASH session and republish it as HLS, using same segment names and boundaries.\n&quot;
<span class="lineNum">    2919 </span>            :         &quot;\n&quot;
<span class="lineNum">    2920 </span>            :         &quot;This mode will force [-noseek]() to `true` to ensure the first segment fetched is complete, and [-split_as]() to `true` to fetch all qualities.\n&quot;
<span class="lineNum">    2921 </span>            :         &quot;\n&quot;
<span class="lineNum">    2922 </span>            :         &quot;Each first packet of a segment will have the following properties attached:\n&quot;
<span class="lineNum">    2923 </span>            :         &quot;- `CueStart`: to indicate this is a segment start (set by demuxer if it offers `sigfrag` option)\n&quot;
<span class="lineNum">    2924 </span>            :         &quot;- `FileNumber`: current segment number\n&quot;
<span class="lineNum">    2925 </span>            :         &quot;- `FileName`: current segment file name without manifest base url\n&quot;
<span class="lineNum">    2926 </span>            :         &quot;\n&quot;
<span class="lineNum">    2927 </span>            :         &quot;If [-forward]() is set to `mani`, the first packet of a segment dispatched after a manifest update will also carry the manifest payload as a property:\n&quot;
<span class="lineNum">    2928 </span>            :         &quot;- `DFManifest`: contains main manifest (MPD, M3U8 master)\n&quot;
<span class="lineNum">    2929 </span>            :         &quot;- `DFVariant`: contains list of HLS child playlists as strings for the given quality\n&quot;
<span class="lineNum">    2930 </span>            :         &quot;- `DFVariantName`: contains list of associated HLS child playlists name\n&quot;
<span class="lineNum">    2931 </span>            :         &quot;\n&quot;
<span class="lineNum">    2932 </span>            :         &quot;Each output PID will have the following properties assigned:\n&quot;
<span class="lineNum">    2933 </span>            :         &quot;- `DFMode`: set to 1 for `segb` or 2 for `mani`\n&quot;
<span class="lineNum">    2934 </span>            :         &quot;- `DCue`: set to `inband`\n&quot;
<span class="lineNum">    2935 </span>            :         &quot;- `DFPStart`: set to current period start value\n&quot;
<span class="lineNum">    2936 </span>            :         &quot;- `FileName`: set to associated init segment if any\n&quot;
<span class="lineNum">    2937 </span>            :         &quot;- `Representation`: set to the associated representation ID in the manifest\n&quot;
<span class="lineNum">    2938 </span>            :         &quot;- `DashDur`: set to the average segment duration as indicated in the manifest\n&quot;
<span class="lineNum">    2939 </span>            :         &quot;\n&quot;
<span class="lineNum">    2940 </span>            :         &quot;When the [dasher](dasher) is used together with this mode, this will force all generated segments to have the same name, duration and fragmentation properties as the input ones.\n&quot;
<span class="lineNum">    2941 </span>            :         &quot;It is therefore not recommended for sessions stored/generated on local storage to generate the output in the same directory.\n&quot;
<span class="lineNum">    2942 </span>            :         )
<span class="lineNum">    2943 </span>            :         .private_size = sizeof(GF_DASHDmxCtx),
<span class="lineNum">    2944 </span>            :         .initialize = dashdmx_initialize,
<span class="lineNum">    2945 </span>            :         .finalize = dashdmx_finalize,
<span class="lineNum">    2946 </span>            :         .args = DASHDmxArgs,
<span class="lineNum">    2947 </span>            :         SETCAPS(DASHDmxCaps),
<span class="lineNum">    2948 </span>            :         .flags = GF_FS_REG_REQUIRES_RESOLVER,
<span class="lineNum">    2949 </span>            :         .configure_pid = dashdmx_configure_pid,
<span class="lineNum">    2950 </span>            :         .process = dashdmx_process,
<span class="lineNum">    2951 </span>            :         .process_event = dashdmx_process_event,
<span class="lineNum">    2952 </span>            :         .probe_data = dashdmx_probe_data,
<span class="lineNum">    2953 </span>            :         //we accept as many input pids as loaded by the session
<span class="lineNum">    2954 </span>            :         .max_extra_pids = (u32) -1,
<span class="lineNum">    2955 </span>            : };
<span class="lineNum">    2956 </span>            : 
<span class="lineNum">    2957 </span>            : 
<a name="2958"><span class="lineNum">    2958 </span>            : #endif //GPAC_DISABLE_DASH_CLIENT</a>
<span class="lineNum">    2959 </span>            : 
<span class="lineNum">    2960 </span><span class="lineCov">       2877 : const GF_FilterRegister *dashdmx_register(GF_FilterSession *session)</span>
<span class="lineNum">    2961 </span>            : {
<span class="lineNum">    2962 </span>            : #ifndef GPAC_DISABLE_DASH_CLIENT
<span class="lineNum">    2963 </span><span class="lineCov">       2877 :         return &amp;DASHDmxRegister;</span>
<span class="lineNum">    2964 </span>            : #else
<span class="lineNum">    2965 </span>            :         return NULL;
<span class="lineNum">    2966 </span>            : #endif
<a name="2967"><span class="lineNum">    2967 </span>            : }</a>
<span class="lineNum">    2968 </span>            : 
<span class="lineNum">    2969 </span><span class="lineCov">         22 : static s32 dashdmx_rate_adaptation_ext(void *udta, u32 group_idx, u32 base_group_idx, Bool force_lower_complexity, GF_DASHCustomAlgoInfo *stats)</span>
<span class="lineNum">    2970 </span>            : {
<span class="lineNum">    2971 </span>            :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx*) udta;
<span class="lineNum">    2972 </span><span class="lineCov">         22 :         return ctx-&gt;on_rate_adaptation(ctx-&gt;rt_udta, group_idx, base_group_idx, force_lower_complexity, stats);</span>
<span class="lineNum">    2973 </span>            : }
<span class="lineNum">    2974 </span>            : 
<span class="lineNum">    2975 </span>            : 
<span class="lineNum">    2976 </span>            : typedef struct
<span class="lineNum">    2977 </span>            : {
<span class="lineNum">    2978 </span>            :         u32 bits_per_sec;
<span class="lineNum">    2979 </span>            :         u64 total_bytes;
<span class="lineNum">    2980 </span>            :         u64 bytes_done;
<span class="lineNum">    2981 </span>            :         u64 us_since_start;
<span class="lineNum">    2982 </span>            :         u32 buffer_dur;
<span class="lineNum">    2983 </span>            :         u32 current_seg_dur;
<a name="2984"><span class="lineNum">    2984 </span>            : } GF_DASHDownloadStats;</a>
<span class="lineNum">    2985 </span>            : 
<span class="lineNum">    2986 </span><span class="lineCov">         10 : s32 dashdmx_download_monitor_ext(void *udta, u32 group_idx, u32 bits_per_sec, u64 total_bytes, u64 bytes_done, u64 us_since_start, u32 buffer_dur_ms, u32 current_seg_dur)</span>
<span class="lineNum">    2987 </span>            : {
<span class="lineNum">    2988 </span>            :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx*) udta;
<span class="lineNum">    2989 </span>            :         GF_DASHDownloadStats stats;
<span class="lineNum">    2990 </span>            :         memset(&amp;stats, 0, sizeof(GF_DASHDownloadStats));
<span class="lineNum">    2991 </span><span class="lineCov">         10 :         stats.bits_per_sec = bits_per_sec;</span>
<span class="lineNum">    2992 </span><span class="lineCov">         10 :         stats.total_bytes = total_bytes;</span>
<span class="lineNum">    2993 </span><span class="lineCov">         10 :         stats.bytes_done = bytes_done;</span>
<span class="lineNum">    2994 </span><span class="lineCov">         10 :         stats.us_since_start = us_since_start;</span>
<span class="lineNum">    2995 </span><span class="lineCov">         10 :         stats.buffer_dur = buffer_dur_ms;</span>
<span class="lineNum">    2996 </span><span class="lineCov">         10 :         stats.current_seg_dur = current_seg_dur;</span>
<span class="lineNum">    2997 </span><span class="lineCov">         10 :         return ctx-&gt;on_download_monitor(ctx-&gt;rt_udta, group_idx, &amp;stats);</span>
<span class="lineNum">    2998 </span>            : }
<span class="lineNum">    2999 </span>            : 
<a name="3000"><span class="lineNum">    3000 </span>            : </a>
<span class="lineNum">    3001 </span>            : GF_EXPORT
<span class="lineNum">    3002 </span><span class="lineCov">          2 : GF_Err gf_filter_bind_dash_algo_callbacks(GF_Filter *filter, void *udta,</span>
<span class="lineNum">    3003 </span>            :                 void (*period_reset)(void *rate_adaptation, u32 type),
<span class="lineNum">    3004 </span>            :                 void (*new_group)(void *udta, u32 group_idx, void *dash),
<span class="lineNum">    3005 </span>            :                 s32 (*rate_adaptation)(void *udta, u32 group_idx, u32 base_group_idx, Bool force_low_complex, void *stats),
<span class="lineNum">    3006 </span>            :                 s32 (*download_monitor)(void *udta, u32 group_idx, void *stats)
<span class="lineNum">    3007 </span>            : )
<span class="lineNum">    3008 </span>            : {
<span class="lineNum">    3009 </span>            : #ifdef GPAC_DISABLE_DASH_CLIENT
<span class="lineNum">    3010 </span>            :         return GF_NOT_SUPPORTED;
<span class="lineNum">    3011 </span>            : #else
<span class="lineNum">    3012 </span><span class="lineCov">          2 :         if (!gf_filter_is_instance_of(filter, &amp;DASHDmxRegister))</span>
<span class="lineNum">    3013 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    3014 </span><span class="lineCov">          2 :         GF_DASHDmxCtx *ctx = (GF_DASHDmxCtx*) gf_filter_get_udta(filter);</span>
<span class="lineNum">    3015 </span>            : 
<span class="lineNum">    3016 </span><span class="lineCov">          2 :         if (rate_adaptation) {</span>
<span class="lineNum">    3017 </span><span class="lineCov">          2 :                 ctx-&gt;on_period_reset = period_reset;</span>
<span class="lineNum">    3018 </span><span class="lineCov">          2 :                 ctx-&gt;on_new_group = new_group;</span>
<span class="lineNum">    3019 </span><span class="lineCov">          2 :                 ctx-&gt;on_rate_adaptation = rate_adaptation;</span>
<span class="lineNum">    3020 </span><span class="lineCov">          2 :                 ctx-&gt;on_download_monitor = download_monitor;</span>
<span class="lineNum">    3021 </span><span class="lineCov">          2 :                 ctx-&gt;rt_udta = udta;</span>
<span class="lineNum">    3022 </span><span class="lineCov">          2 :                 ctx-&gt;abort = download_monitor ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    3023 </span><span class="lineCov">          2 :                 gf_dash_set_algo_custom(ctx-&gt;dash, ctx, dashdmx_rate_adaptation_ext, dashdmx_download_monitor_ext);</span>
<span class="lineNum">    3024 </span>            :         } else {
<span class="lineNum">    3025 </span><span class="lineNoCov">          0 :                 ctx-&gt;on_period_reset = NULL;</span>
<span class="lineNum">    3026 </span><span class="lineNoCov">          0 :                 ctx-&gt;on_new_group = NULL;</span>
<span class="lineNum">    3027 </span><span class="lineNoCov">          0 :                 ctx-&gt;on_rate_adaptation = NULL;</span>
<span class="lineNum">    3028 </span><span class="lineNoCov">          0 :                 ctx-&gt;on_download_monitor = NULL;</span>
<span class="lineNum">    3029 </span><span class="lineNoCov">          0 :                 ctx-&gt;rt_udta = NULL;</span>
<span class="lineNum">    3030 </span><span class="lineNoCov">          0 :                 ctx-&gt;abort = GF_FALSE;</span>
<span class="lineNum">    3031 </span><span class="lineNoCov">          0 :                 gf_dash_set_algo(ctx-&gt;dash, GF_DASH_ALGO_GPAC_LEGACY_BUFFER);</span>
<span class="lineNum">    3032 </span>            :         }
<span class="lineNum">    3033 </span>            :         return GF_OK;
<span class="lineNum">    3034 </span>            : 
<span class="lineNum">    3035 </span>            : #endif
<span class="lineNum">    3036 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

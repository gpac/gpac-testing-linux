<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - filters/out_http.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">filters</a> - out_http.c<span style="font-size: 80%;"> (source / <a href="out_http.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1157</td>
            <td class="headerCovTableEntry">1609</td>
            <td class="headerCovTableEntryLo">71.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">33</td>
            <td class="headerCovTableEntry">34</td>
            <td class="headerCovTableEntryHi">97.1 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2019-2021
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / http server and output filter
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/internal/media_dev.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;gpac/maths.h&gt;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &lt;gpac/filters.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;gpac/ietf.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;gpac/config_file.h&gt;
<span class="lineNum">      33 </span>            : #include &lt;gpac/base_coding.h&gt;
<span class="lineNum">      34 </span>            : #include &lt;gpac/network.h&gt;
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : //socket and SSL context ownership is transfered to the download session object
<span class="lineNum">      37 </span>            : GF_DownloadSession *gf_dm_sess_new_server(GF_Socket *server, void *ssl_ctx, gf_dm_user_io user_io, void *usr_cbk, GF_Err *e);
<span class="lineNum">      38 </span>            : GF_DownloadSession *gf_dm_sess_new_subsession(GF_DownloadSession *sess, u32 stream_id, void *usr_cbk, GF_Err *e);
<span class="lineNum">      39 </span>            : u32 gf_dm_sess_subsession_count(GF_DownloadSession *);
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            : GF_Err gf_dm_sess_send(GF_DownloadSession *sess, u8 *data, u32 size);
<span class="lineNum">      43 </span>            : void gf_dm_sess_clear_headers(GF_DownloadSession *sess);
<span class="lineNum">      44 </span>            : void  gf_dm_sess_set_header(GF_DownloadSession *sess, const char *name, const char *value);
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span>            : GF_Err gf_dm_sess_send_reply(GF_DownloadSession *sess, u32 reply_code, const char *response_body, Bool no_body);
<span class="lineNum">      47 </span>            : void gf_dm_sess_server_reset(GF_DownloadSession *sess);
<span class="lineNum">      48 </span>            : Bool gf_dm_sess_is_h2(GF_DownloadSession *sess);
<span class="lineNum">      49 </span>            : void gf_dm_sess_flush_h2(GF_DownloadSession *sess);
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : #ifdef GPAC_HAS_SSL
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : void *gf_ssl_new(void *ssl_server_ctx, GF_Socket *client_sock, GF_Err *e);
<span class="lineNum">      54 </span>            : void gf_ssl_del(void *ssl_ctx);
<span class="lineNum">      55 </span>            : void *gf_ssl_server_context_new(const char *cert, const char *key);
<span class="lineNum">      56 </span>            : void gf_ssl_server_context_del(void *ssl_server_ctx);
<span class="lineNum">      57 </span>            : Bool gf_ssl_init_lib();
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            : #endif
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : enum
<span class="lineNum">      62 </span>            : {
<span class="lineNum">      63 </span>            :         MODE_DEFAULT=0,
<span class="lineNum">      64 </span>            :         MODE_PUSH,
<span class="lineNum">      65 </span>            :         MODE_SOURCE,
<span class="lineNum">      66 </span>            : };
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            : enum
<span class="lineNum">      69 </span>            : {
<span class="lineNum">      70 </span>            :         CORS_AUTO=0,
<span class="lineNum">      71 </span>            :         CORS_OFF,
<span class="lineNum">      72 </span>            :         CORS_ON,
<span class="lineNum">      73 </span>            : };
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span>            : typedef struct
<span class="lineNum">      76 </span>            : {
<span class="lineNum">      77 </span>            :         //options
<span class="lineNum">      78 </span>            :         char *dst, *user_agent, *ifce, *cache_control, *ext, *mime, *wdir, *cert, *pkey, *reqlog;
<span class="lineNum">      79 </span>            :         GF_PropStringList rdirs;
<span class="lineNum">      80 </span>            :         Bool close, hold, quit, post, dlist, ice;
<span class="lineNum">      81 </span>            :         u32 port, block_size, maxc, maxp, timeout, hmode, sutc, cors, max_client_errors;
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            :         //internal
<span class="lineNum">      84 </span>            :         GF_Filter *filter;
<span class="lineNum">      85 </span>            :         GF_Socket *server_sock;
<span class="lineNum">      86 </span>            :         GF_List *sessions, *active_sessions;
<span class="lineNum">      87 </span>            :         GF_List *inputs;
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span>            :         u32 next_wake_us;
<span class="lineNum">      90 </span>            :         char *ip;
<span class="lineNum">      91 </span>            :         Bool done;
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span>            :         GF_SockGroup *sg;
<span class="lineNum">      94 </span>            :         Bool no_etag;
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            :         u32 nb_connections;
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            :         GF_FilterCapability in_caps[2];
<span class="lineNum">      99 </span>            :         char szExt[10];
<span class="lineNum">     100 </span>            : 
<span class="lineNum">     101 </span>            :         //set to true when no mounted dirs and not push mode
<span class="lineNum">     102 </span>            :         Bool single_mode;
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span>            :         void *ssl_ctx;
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            :         u64 req_id;
<span class="lineNum">     107 </span>            :         Bool log_record;
<span class="lineNum">     108 </span>            : } GF_HTTPOutCtx;
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span>            : typedef struct
<span class="lineNum">     111 </span>            : {
<span class="lineNum">     112 </span>            :         GF_HTTPOutCtx *ctx;
<span class="lineNum">     113 </span>            :         GF_FilterPid *ipid;
<span class="lineNum">     114 </span>            :         char *path;
<span class="lineNum">     115 </span>            :         Bool dash_mode;
<span class="lineNum">     116 </span>            :         char *mime;
<span class="lineNum">     117 </span>            :         u32 nb_dest;
<span class="lineNum">     118 </span>            :         Bool hold;
<span class="lineNum">     119 </span>            : 
<span class="lineNum">     120 </span>            :         Bool is_open, done, is_delete;
<span class="lineNum">     121 </span>            :         Bool patch_blocks;
<span class="lineNum">     122 </span>            :         GF_List *file_deletes;
<span class="lineNum">     123 </span>            : 
<span class="lineNum">     124 </span>            :         //for PUT mode, NULL in server mode
<span class="lineNum">     125 </span>            :         GF_DownloadSession *upload;
<span class="lineNum">     126 </span>            :         Bool is_h2;
<span class="lineNum">     127 </span>            :         u32 cur_header;
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span>            :         u64 offset_at_seg_start;
<span class="lineNum">     130 </span>            :         u64 nb_write, write_start_range, write_end_range;
<span class="lineNum">     131 </span>            :         char range_hdr[100];
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            :         //for server mode, recording
<span class="lineNum">     134 </span>            :         char *local_path;
<span class="lineNum">     135 </span>            :         FILE *resource;
<span class="lineNum">     136 </span>            : 
<span class="lineNum">     137 </span>            :         FILE *hls_chunk;
<span class="lineNum">     138 </span>            :         char *hls_chunk_path, *hls_chunk_local_path;
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span>            :         u8 *tunein_data;
<span class="lineNum">     141 </span>            :         u32 tunein_data_size;
<span class="lineNum">     142 </span>            :     
<span class="lineNum">     143 </span>            :     Bool force_dst_name;
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span>            : } GF_HTTPOutInput;
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            : typedef struct
<span class="lineNum">     149 </span>            : {
<span class="lineNum">     150 </span>            :         s64 start;
<span class="lineNum">     151 </span>            :         s64 end;
<span class="lineNum">     152 </span>            : } HTTByteRange;
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span>            : typedef struct __httpout_session
<span class="lineNum">     155 </span>            : {
<span class="lineNum">     156 </span>            :         GF_HTTPOutCtx *ctx;
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span>            :         GF_Socket *socket;
<span class="lineNum">     159 </span>            :         GF_DownloadSession *http_sess;
<span class="lineNum">     160 </span>            :         char peer_address[GF_MAX_IP_NAME_LEN];
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span>            :         Bool headers_done;
<span class="lineNum">     163 </span>            : 
<span class="lineNum">     164 </span>            :         u32 play_state;
<span class="lineNum">     165 </span>            :         Double start_range;
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span>            :         FILE *resource;
<span class="lineNum">     168 </span>            :         char *path, *mime;
<span class="lineNum">     169 </span>            :         u64 file_size, file_pos, nb_bytes, bytes_in_req;
<span class="lineNum">     170 </span>            :         u8 *buffer;
<span class="lineNum">     171 </span>            :         Bool done;
<span class="lineNum">     172 </span>            :         u64 last_file_modif;
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span>            :         u64 req_start_time;
<span class="lineNum">     175 </span>            :         u64 last_active_time;
<span class="lineNum">     176 </span>            :         Bool file_in_progress;
<span class="lineNum">     177 </span>            :         Bool use_chunk_transfer;
<span class="lineNum">     178 </span>            :         u32 put_in_progress;
<span class="lineNum">     179 </span>            :         //for upload only: 0 not an upload, 1 creation, 2: update
<span class="lineNum">     180 </span>            :         u32 upload_type;
<span class="lineNum">     181 </span>            :         u64 content_length;
<span class="lineNum">     182 </span>            :         GF_FilterPid *opid;
<span class="lineNum">     183 </span>            :         Bool reconfigure_output;
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span>            :         GF_HTTPOutInput *in_source;
<span class="lineNum">     186 </span>            :         Bool send_init_data;
<span class="lineNum">     187 </span>            :         Bool in_source_is_ll_hls_chunk;
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span>            :         u32 nb_ranges, alloc_ranges, range_idx;
<span class="lineNum">     190 </span>            :         HTTByteRange *ranges;
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span>            :         Bool do_log;
<span class="lineNum">     193 </span>            :         u64 req_id;
<span class="lineNum">     194 </span>            :         u32 method_type, reply_code, nb_consecutive_errors;
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span>            :         Bool is_h2;
<span class="lineNum">     197 </span>            :         Bool sub_sess_pending;
<span class="lineNum">     198 </span>            :         Bool canceled;
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            :         Bool force_destroy;
<a name="201"><span class="lineNum">     201 </span>            : } GF_HTTPOutSession;</a>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span><span class="lineCov">         47 : static void httpout_close_session(GF_HTTPOutSession *sess)</span>
<span class="lineNum">     204 </span>            : {
<span class="lineNum">     205 </span>            :         Bool last_connection = GF_TRUE;
<span class="lineNum">     206 </span><span class="lineCov">         47 :         if (!sess-&gt;http_sess) return;</span>
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span><span class="lineCov">         47 :         if (sess-&gt;is_h2) {</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :                 u32 nb_sub_sess = gf_dm_sess_subsession_count(sess-&gt;http_sess);</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :                 if (nb_sub_sess &gt; 1) {</span>
<span class="lineNum">     211 </span>            :                         last_connection = GF_FALSE;
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_HTTP, (&quot;[HTTPOut] %d sub-sessions still active in connection to %s, keeping alive\n&quot;, nb_sub_sess-1, sess-&gt;peer_address ));</span>
<span class="lineNum">     213 </span>            :                 }
<span class="lineNum">     214 </span>            :                 else {
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :                         gf_dm_sess_flush_h2(sess-&gt;http_sess);</span>
<span class="lineNum">     216 </span>            :                 }
<span class="lineNum">     217 </span>            :         }
<span class="lineNum">     218 </span>            :         if (last_connection) {
<span class="lineNum">     219 </span>            :                 assert(sess-&gt;ctx-&gt;nb_connections);
<span class="lineNum">     220 </span><span class="lineCov">         47 :                 sess-&gt;ctx-&gt;nb_connections--;</span>
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span><span class="lineCov">         47 :                 gf_sk_group_unregister(sess-&gt;ctx-&gt;sg, sess-&gt;socket);</span>
<span class="lineNum">     223 </span>            :         }
<span class="lineNum">     224 </span>            : 
<span class="lineNum">     225 </span><span class="lineCov">         47 :         gf_dm_sess_del(sess-&gt;http_sess);</span>
<span class="lineNum">     226 </span><span class="lineCov">         47 :         sess-&gt;http_sess = NULL;</span>
<span class="lineNum">     227 </span><span class="lineCov">         47 :         sess-&gt;socket = NULL;</span>
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span><span class="lineCov">         47 :         if (sess-&gt;in_source) sess-&gt;in_source-&gt;nb_dest--;</span>
<a name="230"><span class="lineNum">     230 </span>            : }</a>
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span><span class="lineCov">        220 : static void httpout_format_date(u64 time, char szDate[200], Bool for_listing)</span>
<span class="lineNum">     233 </span>            : {
<span class="lineNum">     234 </span>            :         time_t gtime;
<span class="lineNum">     235 </span>            :         struct tm *t;
<span class="lineNum">     236 </span>            :         const char *wday, *month;
<span class="lineNum">     237 </span>            :         u32 sec;
<span class="lineNum">     238 </span><span class="lineCov">        220 :         gtime = time / 1000;</span>
<span class="lineNum">     239 </span><span class="lineCov">        220 :         t = gf_gmtime(&amp;gtime);</span>
<span class="lineNum">     240 </span><span class="lineCov">        220 :         sec = t-&gt;tm_sec;</span>
<span class="lineNum">     241 </span>            :         //see issue #859, no clue how this happened...
<span class="lineNum">     242 </span><span class="lineCov">        220 :         if (sec &gt; 60)</span>
<span class="lineNum">     243 </span>            :                 sec = 60;
<span class="lineNum">     244 </span><span class="lineCov">        220 :         switch (t-&gt;tm_wday) {</span>
<span class="lineNum">     245 </span>            :         case 1: wday = &quot;Mon&quot;; break;
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :         case 2: wday = &quot;Tue&quot;; break;</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :         case 3: wday = &quot;Wed&quot;; break;</span>
<span class="lineNum">     248 </span><span class="lineCov">        220 :         case 4: wday = &quot;Thu&quot;; break;</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :         case 5: wday = &quot;Fri&quot;; break;</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :         case 6: wday = &quot;Sat&quot;; break;</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :         default: wday = &quot;Sun&quot;; break;</span>
<span class="lineNum">     252 </span>            :         }
<span class="lineNum">     253 </span><span class="lineCov">        220 :         switch (t-&gt;tm_mon) {</span>
<span class="lineNum">     254 </span>            :         case 1: month = &quot;Feb&quot;; break;
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :         case 2: month = &quot;Mar&quot;; break;</span>
<span class="lineNum">     256 </span><span class="lineCov">        220 :         case 3: month = &quot;Apr&quot;; break;</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :         case 4: month = &quot;May&quot;; break;</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :         case 5: month = &quot;Jun&quot;; break;</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :         case 6: month = &quot;Jul&quot;; break;</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :         case 7: month = &quot;Aug&quot;; break;</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :         case 8: month = &quot;Sep&quot;; break;</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :         case 9: month = &quot;Oct&quot;; break;</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :         case 10: month = &quot;Nov&quot;; break;</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :         case 11: month = &quot;Dec&quot;; break;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :         default: month = &quot;Jan&quot;; break;</span>
<span class="lineNum">     266 </span>            : 
<span class="lineNum">     267 </span>            :         }
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span><span class="lineCov">        220 :         if (for_listing) {</span>
<span class="lineNum">     270 </span><span class="lineCov">          7 :                 sprintf(szDate, &quot;%02d-%s-%d %02d:%02d:%02d&quot;, t-&gt;tm_mday, month, 1900 + t-&gt;tm_year, t-&gt;tm_hour, t-&gt;tm_min, sec);</span>
<span class="lineNum">     271 </span>            :         } else {
<span class="lineNum">     272 </span><span class="lineCov">        213 :                 sprintf(szDate, &quot;%s, %02d %s %d %02d:%02d:%02d GMT&quot;, wday, t-&gt;tm_mday, month, 1900 + t-&gt;tm_year, t-&gt;tm_hour, t-&gt;tm_min, sec);</span>
<span class="lineNum">     273 </span>            :         }
<a name="274"><span class="lineNum">     274 </span><span class="lineCov">        220 : }</span></a>
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span><span class="lineCov">          7 : static Bool httpout_dir_file_enum(void *cbck, char *item_name, char *item_path, GF_FileEnumInfo *file_info, Bool is_dir)</span>
<span class="lineNum">     277 </span>            : {
<span class="lineNum">     278 </span>            :         char szFmt[200];
<span class="lineNum">     279 </span>            :         u64 size;
<span class="lineNum">     280 </span>            :         u32 name_len;
<span class="lineNum">     281 </span>            :         char *unit=NULL;
<span class="lineNum">     282 </span>            :         char **listing = (char **) cbck;
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineCov">          7 :         if (file_info &amp;&amp; (file_info-&gt;hidden || file_info-&gt;system))</span>
<span class="lineNum">     285 </span>            :                 return GF_FALSE;
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span><span class="lineCov">          7 :         if (is_dir)</span>
<span class="lineNum">     288 </span><span class="lineCov">          1 :                 gf_dynstrcat(listing, &quot;+  &lt;a href=\&quot;&quot;, NULL);</span>
<span class="lineNum">     289 </span>            :         else
<span class="lineNum">     290 </span><span class="lineCov">          6 :                 gf_dynstrcat(listing, &quot;   &lt;a href=\&quot;&quot;, NULL);</span>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span><span class="lineCov">          7 :         name_len = (u32) strlen(item_name);</span>
<span class="lineNum">     293 </span><span class="lineCov">          7 :         if (is_dir) name_len++;</span>
<span class="lineNum">     294 </span><span class="lineCov">          7 :         gf_dynstrcat(listing, item_name, NULL);</span>
<span class="lineNum">     295 </span><span class="lineCov">          7 :         if (is_dir) gf_dynstrcat(listing, &quot;/&quot;, NULL);</span>
<span class="lineNum">     296 </span><span class="lineCov">          7 :         gf_dynstrcat(listing, &quot;\&quot;&gt;&quot;, NULL);</span>
<span class="lineNum">     297 </span><span class="lineCov">          7 :         gf_dynstrcat(listing, item_name, NULL);</span>
<span class="lineNum">     298 </span><span class="lineCov">          7 :         if (is_dir) gf_dynstrcat(listing, &quot;/&quot;, NULL);</span>
<span class="lineNum">     299 </span><span class="lineCov">          7 :         gf_dynstrcat(listing, &quot;&lt;/a&gt;&quot;, NULL);</span>
<span class="lineNum">     300 </span><span class="lineCov">        297 :         while (name_len&lt;60) {</span>
<span class="lineNum">     301 </span><span class="lineCov">        290 :                 name_len++;</span>
<span class="lineNum">     302 </span><span class="lineCov">        290 :                 gf_dynstrcat(listing, &quot; &quot;, NULL);</span>
<span class="lineNum">     303 </span>            :         }
<span class="lineNum">     304 </span><span class="lineCov">          7 :         if (file_info) {</span>
<span class="lineNum">     305 </span>            :                 char szDate[200];
<span class="lineNum">     306 </span><span class="lineCov">          7 :                 httpout_format_date(file_info-&gt;last_modified*1000, szDate, GF_TRUE);</span>
<span class="lineNum">     307 </span><span class="lineCov">          7 :                 gf_dynstrcat(listing, szDate, NULL);</span>
<span class="lineNum">     308 </span>            :         }
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span><span class="lineCov">          7 :         if (is_dir || !file_info) {</span>
<span class="lineNum">     311 </span><span class="lineCov">          1 :                 gf_dynstrcat(listing, &quot;    -\n&quot;, NULL);</span>
<span class="lineNum">     312 </span>            :                 return GF_FALSE;
<span class="lineNum">     313 </span>            :         }
<span class="lineNum">     314 </span><span class="lineCov">          6 :         size = file_info-&gt;size;</span>
<span class="lineNum">     315 </span><span class="lineCov">          6 :         if (size&lt;1000) unit=&quot;&quot;;</span>
<span class="lineNum">     316 </span><span class="lineCov">          1 :         else if (size&lt;1000000) { unit=&quot;K&quot;; size/=1000; }</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :         else if (size&lt;1000000000) { unit=&quot;M&quot;; size/=1000000; }</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :         else if (size&lt;1000000000000) { unit=&quot;G&quot;; size/=1000000000; }</span>
<span class="lineNum">     319 </span><span class="lineCov">          6 :         gf_dynstrcat(listing, &quot;    &quot;, NULL);</span>
<span class="lineNum">     320 </span>            :         sprintf(szFmt, LLU&quot;%s\n&quot;, size, unit);
<span class="lineNum">     321 </span><span class="lineCov">          6 :         gf_dynstrcat(listing, szFmt, NULL);</span>
<span class="lineNum">     322 </span>            : 
<a name="323"><span class="lineNum">     323 </span>            :         return GF_FALSE;</a>
<span class="lineNum">     324 </span>            : }
<span class="lineNum">     325 </span><span class="lineCov">          1 : static Bool httpout_dir_enum(void *cbck, char *item_name, char *item_path, GF_FileEnumInfo *file_info)</span>
<span class="lineNum">     326 </span>            : {
<a name="327"><span class="lineNum">     327 </span><span class="lineCov">          1 :         return httpout_dir_file_enum(cbck, item_name, item_path, file_info, GF_TRUE);</span></a>
<span class="lineNum">     328 </span>            : }
<span class="lineNum">     329 </span><span class="lineCov">          6 : static Bool httpout_file_enum(void *cbck, char *item_name, char *item_path, GF_FileEnumInfo *file_info)</span>
<span class="lineNum">     330 </span>            : {
<span class="lineNum">     331 </span><span class="lineCov">          6 :         return httpout_dir_file_enum(cbck, item_name, item_path, file_info, GF_FALSE);</span>
<a name="332"><span class="lineNum">     332 </span>            : }</a>
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span><span class="lineCov">          2 : static char *httpout_create_listing(GF_HTTPOutCtx *ctx, char *full_path)</span>
<span class="lineNum">     335 </span>            : {
<span class="lineNum">     336 </span>            :         char szHost[GF_MAX_IP_NAME_LEN];
<span class="lineNum">     337 </span>            :         char *has_par, *dir;
<span class="lineNum">     338 </span><span class="lineCov">          2 :         u32 i, count = ctx-&gt;rdirs.nb_items;</span>
<span class="lineNum">     339 </span><span class="lineCov">          2 :         char *listing = NULL;</span>
<span class="lineNum">     340 </span>            :         char *name = full_path;
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineCov">          2 :         if (full_path &amp;&amp; (full_path[0]=='.'))</span>
<span class="lineNum">     343 </span><span class="lineCov">          1 :                 name++;</span>
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, &quot;&lt;!DOCTYPE HTML PUBLIC \&quot;-//W3C//DTD HTML 3.2 Final//EN\&quot;&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Index of &quot;, NULL);</span>
<span class="lineNum">     346 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, name, NULL);</span>
<span class="lineNum">     347 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, &quot;&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;&lt;h1&gt;Index of &quot;, NULL);</span>
<span class="lineNum">     348 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, name, NULL);</span>
<span class="lineNum">     349 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, &quot;&lt;/h1&gt;\n&lt;pre&gt;Name                                                                Last modified      Size\n&lt;hr&gt;\n&quot;, NULL);</span>
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span><span class="lineCov">          2 :         if (!full_path) {</span>
<span class="lineNum">     352 </span>            :                 has_par=NULL;
<span class="lineNum">     353 </span>            :         } else {
<span class="lineNum">     354 </span><span class="lineCov">          2 :                 u32 len = (u32) strlen(full_path);</span>
<span class="lineNum">     355 </span><span class="lineCov">          2 :                 if (len &amp;&amp; strchr(&quot;/\\&quot;, full_path[len-1]))</span>
<span class="lineNum">     356 </span><span class="lineCov">          2 :                         full_path[len-1] = 0;</span>
<span class="lineNum">     357 </span><span class="lineCov">          2 :                 has_par = strrchr(full_path, '/');</span>
<span class="lineNum">     358 </span>            :         }
<span class="lineNum">     359 </span><span class="lineCov">          2 :         if (has_par) {</span>
<span class="lineNum">     360 </span><span class="lineCov">          1 :                 u8 c = has_par[1];</span>
<span class="lineNum">     361 </span><span class="lineCov">          1 :                 has_par[1] = 0;</span>
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span>            :                 //retranslate server root
<span class="lineNum">     364 </span><span class="lineCov">          1 :                 gf_dynstrcat(&amp;listing, &quot;.. &lt;a href=\&quot;&quot;, NULL);</span>
<span class="lineNum">     365 </span><span class="lineCov">          2 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     366 </span><span class="lineCov">          1 :                         dir = ctx-&gt;rdirs.vals[i];</span>
<span class="lineNum">     367 </span><span class="lineCov">          1 :                         u32 dlen = (u32) strlen(dir);</span>
<span class="lineNum">     368 </span><span class="lineCov">          1 :                         if (!strncmp(dir, name, dlen) &amp;&amp; ((name[dlen]=='/') || (name[dlen]==0))) {</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;listing, &quot;/&quot;, NULL);</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :                                 if (count==1) name = NULL;</span>
<span class="lineNum">     371 </span>            :                                 break;
<span class="lineNum">     372 </span>            :                         }
<span class="lineNum">     373 </span>            :                 }
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineCov">          1 :                 if (name)</span>
<span class="lineNum">     376 </span><span class="lineCov">          1 :                         gf_dynstrcat(&amp;listing, name, NULL);</span>
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span><span class="lineCov">          1 :                 gf_dynstrcat(&amp;listing, &quot;\&quot;&gt;Parent Directory&lt;/a&gt;\n&quot;, NULL);</span>
<span class="lineNum">     379 </span><span class="lineCov">          1 :                 has_par[1] = c;</span>
<span class="lineNum">     380 </span>            :         }
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineCov">          2 :         if (!full_path || !strlen(full_path)) {</span>
<span class="lineNum">     383 </span><span class="lineCov">          1 :                 count = ctx-&gt;rdirs.nb_items;</span>
<span class="lineNum">     384 </span><span class="lineCov">          1 :                 if (count==1) {</span>
<span class="lineNum">     385 </span><span class="lineCov">          1 :                         dir = ctx-&gt;rdirs.vals[0];</span>
<span class="lineNum">     386 </span><span class="lineCov">          1 :                         gf_enum_directory(dir, GF_TRUE, httpout_dir_enum, &amp;listing, NULL);</span>
<span class="lineNum">     387 </span><span class="lineCov">          1 :                         gf_enum_directory(dir, GF_FALSE, httpout_file_enum, &amp;listing, NULL);</span>
<span class="lineNum">     388 </span>            :                 } else {
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :                                 dir = ctx-&gt;rdirs.vals[i];</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                                 httpout_dir_file_enum(&amp;listing, dir, NULL, NULL, GF_TRUE);</span>
<span class="lineNum">     392 </span>            :                         }
<span class="lineNum">     393 </span>            :                 }
<span class="lineNum">     394 </span>            :         } else {
<span class="lineNum">     395 </span>            :                 Bool insert_root = GF_FALSE;
<span class="lineNum">     396 </span><span class="lineCov">          1 :                 if (count&gt;1) {</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :                                 dir = ctx-&gt;rdirs.vals[i];</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :                                 if (!strcmp(full_path, dir)) {</span>
<span class="lineNum">     400 </span>            :                                         insert_root=GF_TRUE;
<span class="lineNum">     401 </span>            :                                         break;
<span class="lineNum">     402 </span>            :                                 }
<span class="lineNum">     403 </span>            :                         }
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :                         if (insert_root) {</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;listing, &quot;.. &lt;a href=\&quot;/\&quot;&gt;Parent Directory&lt;/a&gt;                                 -\n&quot;, NULL);</span>
<span class="lineNum">     406 </span>            :                         }
<span class="lineNum">     407 </span>            :                 }
<span class="lineNum">     408 </span><span class="lineCov">          1 :                 gf_enum_directory(full_path, GF_TRUE, httpout_dir_enum, &amp;listing, NULL);</span>
<span class="lineNum">     409 </span><span class="lineCov">          1 :                 gf_enum_directory(full_path, GF_FALSE, httpout_file_enum, &amp;listing, NULL);</span>
<span class="lineNum">     410 </span>            :         }
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, &quot;\n&lt;hr&gt;&lt;/pre&gt;\n&lt;address&gt;&quot;, NULL);</span>
<span class="lineNum">     413 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, ctx-&gt;user_agent, NULL);</span>
<span class="lineNum">     414 </span><span class="lineCov">          2 :         gf_sk_get_host_name(szHost);</span>
<span class="lineNum">     415 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, &quot; at &quot;, NULL);</span>
<span class="lineNum">     416 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, szHost, NULL);</span>
<span class="lineNum">     417 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, &quot; Port &quot;, NULL);</span>
<span class="lineNum">     418 </span><span class="lineCov">          2 :         sprintf(szHost, &quot;%d&quot;, ctx-&gt;port);</span>
<span class="lineNum">     419 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, szHost, NULL);</span>
<span class="lineNum">     420 </span><span class="lineCov">          2 :         gf_dynstrcat(&amp;listing, &quot;&lt;/address&gt;\n&lt;/body&gt;&lt;/html&gt;&quot;, NULL);</span>
<span class="lineNum">     421 </span><span class="lineCov">          2 :         return listing;</span>
<span class="lineNum">     422 </span>            : }
<a name="423"><span class="lineNum">     423 </span>            : </a>
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span><span class="lineCov">        665 : static void httpout_set_local_path(GF_HTTPOutCtx *ctx, GF_HTTPOutInput *in)</span>
<span class="lineNum">     426 </span>            : {
<span class="lineNum">     427 </span>            :         char *dir;
<span class="lineNum">     428 </span>            :         u32 len;
<span class="lineNum">     429 </span>            :         assert(in-&gt;path);
<span class="lineNum">     430 </span>            :         //not recording
<span class="lineNum">     431 </span><span class="lineCov">        665 :         if (!ctx-&gt;rdirs.nb_items) return;</span>
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span><span class="lineCov">        664 :         dir = ctx-&gt;rdirs.vals[0];</span>
<span class="lineNum">     434 </span><span class="lineCov">        664 :         if (!dir) return;</span>
<span class="lineNum">     435 </span><span class="lineCov">        664 :         len = (u32) strlen(dir);</span>
<span class="lineNum">     436 </span><span class="lineCov">        664 :         if (in-&gt;local_path) gf_free(in-&gt;local_path);</span>
<span class="lineNum">     437 </span><span class="lineCov">        664 :         in-&gt;local_path = NULL;</span>
<span class="lineNum">     438 </span><span class="lineCov">        664 :         gf_dynstrcat(&amp;in-&gt;local_path, dir, NULL);</span>
<span class="lineNum">     439 </span><span class="lineCov">        664 :         if (!strchr(&quot;/\\&quot;, dir[len-1]))</span>
<span class="lineNum">     440 </span><span class="lineCov">        664 :                 gf_dynstrcat(&amp;in-&gt;local_path, &quot;/&quot;, NULL);</span>
<span class="lineNum">     441 </span><span class="lineCov">        664 :     if (in-&gt;path[0]=='/')</span>
<span class="lineNum">     442 </span><span class="lineCov">        664 :         gf_dynstrcat(&amp;in-&gt;local_path, in-&gt;path+1, NULL);</span>
<span class="lineNum">     443 </span>            :     else
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :         gf_dynstrcat(&amp;in-&gt;local_path, in-&gt;path, NULL);</span>
<a name="445"><span class="lineNum">     445 </span>            : }</a>
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineCov">        215 : static Bool httpout_sess_parse_range(GF_HTTPOutSession *sess, char *range)</span>
<span class="lineNum">     448 </span>            : {
<span class="lineNum">     449 </span>            :         Bool request_ok = GF_TRUE;;
<span class="lineNum">     450 </span>            :         u32 i;
<span class="lineNum">     451 </span>            :         Bool has_open_start=GF_FALSE;
<span class="lineNum">     452 </span>            :         Bool has_file_end=GF_FALSE;
<span class="lineNum">     453 </span>            :         u64 known_file_size;
<span class="lineNum">     454 </span><span class="lineCov">        215 :         sess-&gt;nb_ranges = 0;</span>
<span class="lineNum">     455 </span><span class="lineCov">        215 :         sess-&gt;nb_bytes = 0;</span>
<span class="lineNum">     456 </span><span class="lineCov">        215 :         sess-&gt;range_idx = 0;</span>
<span class="lineNum">     457 </span><span class="lineCov">        215 :         if (!range) return GF_TRUE;</span>
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span><span class="lineCov">         31 :         if (sess-&gt;in_source &amp;&amp; !sess-&gt;ctx-&gt;rdirs.nb_items)</span>
<span class="lineNum">     460 </span>            :                 return GF_FALSE;
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineCov">         31 :         while (range) {</span>
<span class="lineNum">     463 </span>            :                 char *sep;
<span class="lineNum">     464 </span>            :                 u32 len;
<span class="lineNum">     465 </span>            :                 s64 start, end;
<span class="lineNum">     466 </span><span class="lineCov">         31 :                 char *next = strchr(range, ',');</span>
<span class="lineNum">     467 </span><span class="lineCov">         31 :                 if (next) next[0] = 0;</span>
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :                 while (range[0] == ' ') range++;</span>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span>            :                 //unsupported unit
<span class="lineNum">     472 </span><span class="lineCov">         31 :                 if (strncmp(range, &quot;bytes=&quot;, 6)) {</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :                         return GF_FALSE;</span>
<span class="lineNum">     474 </span>            :                 }
<span class="lineNum">     475 </span><span class="lineCov">         31 :                 range += 6;</span>
<span class="lineNum">     476 </span><span class="lineCov">         31 :                 sep = strchr(range, '/');</span>
<span class="lineNum">     477 </span><span class="lineCov">         31 :                 if (sep) sep[0] = 0;</span>
<span class="lineNum">     478 </span><span class="lineCov">         31 :                 len = (u32) strlen(range);</span>
<span class="lineNum">     479 </span><span class="lineCov">         31 :                 start = end = -1;</span>
<span class="lineNum">     480 </span><span class="lineCov">         31 :                 if (!len) {</span>
<span class="lineNum">     481 </span>            :                         request_ok = GF_FALSE;
<span class="lineNum">     482 </span>            :                 }
<span class="lineNum">     483 </span>            :                 //end range only
<span class="lineNum">     484 </span><span class="lineCov">         31 :                 else if (range[0] == '-') {</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :                         if (has_file_end)</span>
<span class="lineNum">     486 </span>            :                                 request_ok = GF_FALSE;
<span class="lineNum">     487 </span>            :                         has_file_end = GF_TRUE;
<span class="lineNum">     488 </span>            :                         start = -1;
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :                         if (sscanf(range+1, LLD, &amp;end) != 1)</span>
<span class="lineNum">     490 </span>            :                                 request_ok = GF_FALSE;
<span class="lineNum">     491 </span>            :                 }
<span class="lineNum">     492 </span>            :                 //start -&gt; EOF
<span class="lineNum">     493 </span><span class="lineCov">         31 :                 else if (range[len-1] == '-') {</span>
<span class="lineNum">     494 </span><span class="lineCov">          1 :                         if (has_open_start)</span>
<span class="lineNum">     495 </span>            :                                 request_ok = GF_FALSE;
<span class="lineNum">     496 </span>            :                         has_open_start = GF_TRUE;
<span class="lineNum">     497 </span>            :                         end = -1;
<span class="lineNum">     498 </span><span class="lineCov">          1 :                         if (sscanf(range, LLD&quot;-&quot;, &amp;start) != 1)</span>
<span class="lineNum">     499 </span>            :                                 request_ok = GF_FALSE;
<span class="lineNum">     500 </span>            :                 } else {
<span class="lineNum">     501 </span><span class="lineCov">         30 :                         if (sscanf(range, LLD&quot;-&quot;LLD, &amp;start, &amp;end) != 2)</span>
<span class="lineNum">     502 </span>            :                                 request_ok = GF_FALSE;
<span class="lineNum">     503 </span>            :                 }
<span class="lineNum">     504 </span><span class="lineCov">         31 :                 if ((start==-1) &amp;&amp; (end==-1)) {</span>
<span class="lineNum">     505 </span>            :                         request_ok = GF_FALSE;
<span class="lineNum">     506 </span>            :                 }
<span class="lineNum">     507 </span>            : 
<span class="lineNum">     508 </span><span class="lineCov">         31 :                 if (request_ok) {</span>
<span class="lineNum">     509 </span><span class="lineCov">         31 :                         if (sess-&gt;nb_ranges &gt;= sess-&gt;alloc_ranges) {</span>
<span class="lineNum">     510 </span><span class="lineCov">          7 :                                 sess-&gt;alloc_ranges = sess-&gt;nb_ranges + 1;</span>
<span class="lineNum">     511 </span><span class="lineCov">          7 :                                 sess-&gt;ranges = gf_realloc(sess-&gt;ranges, sizeof(HTTByteRange)*sess-&gt;alloc_ranges);</span>
<span class="lineNum">     512 </span>            :                         }
<span class="lineNum">     513 </span><span class="lineCov">         31 :                         sess-&gt;ranges[sess-&gt;nb_ranges].start = start;</span>
<span class="lineNum">     514 </span><span class="lineCov">         31 :                         sess-&gt;ranges[sess-&gt;nb_ranges].end = end;</span>
<span class="lineNum">     515 </span><span class="lineCov">         31 :                         sess-&gt;nb_ranges++;</span>
<span class="lineNum">     516 </span>            :                 }
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span><span class="lineCov">         31 :                 if (sep) sep[0] = '/';</span>
<span class="lineNum">     519 </span><span class="lineCov">         31 :                 if (!next) break;</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                 next[0] = ',';</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                 range = next+1;</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :                 if (!request_ok) break;</span>
<span class="lineNum">     523 </span>            :         }
<span class="lineNum">     524 </span><span class="lineCov">         31 :         if (!request_ok) return GF_FALSE;</span>
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span><span class="lineCov">         31 :         if (sess-&gt;in_source &amp;&amp; !sess-&gt;resource) {</span>
<span class="lineNum">     527 </span>            :                 //cannot fetch end of file it is not yet known !
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :                 if (has_file_end) return GF_FALSE;</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :                 known_file_size = sess-&gt;in_source-&gt;nb_write;</span>
<span class="lineNum">     530 </span>            :         } else {
<span class="lineNum">     531 </span><span class="lineCov">         31 :                 known_file_size = sess-&gt;file_size;</span>
<span class="lineNum">     532 </span>            :         }
<span class="lineNum">     533 </span><span class="lineCov">         31 :         sess-&gt;bytes_in_req = 0;</span>
<span class="lineNum">     534 </span><span class="lineCov">         61 :         for (i=0; i&lt;sess-&gt;nb_ranges; i++) {</span>
<span class="lineNum">     535 </span><span class="lineCov">         31 :                 if (sess-&gt;ranges[i].start&gt;=0) {</span>
<span class="lineNum">     536 </span>            :                         //if start, end is a pos in bytes in size (0-based)
<span class="lineNum">     537 </span><span class="lineCov">         31 :                         if (sess-&gt;ranges[i].end==-1) {</span>
<span class="lineNum">     538 </span><span class="lineCov">          1 :                                 sess-&gt;ranges[i].end = known_file_size-1;</span>
<span class="lineNum">     539 </span>            :                         }
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span><span class="lineCov">         31 :                         if (sess-&gt;ranges[i].end &gt;= (s64) known_file_size) {</span>
<span class="lineNum">     542 </span>            :                                 request_ok = GF_FALSE;
<span class="lineNum">     543 </span>            :                                 break;
<span class="lineNum">     544 </span>            :                         }
<span class="lineNum">     545 </span><span class="lineCov">         30 :                         if (sess-&gt;ranges[i].start &gt;= (s64) known_file_size) {</span>
<span class="lineNum">     546 </span>            :                                 request_ok = GF_FALSE;
<span class="lineNum">     547 </span>            :                                 break;
<span class="lineNum">     548 </span>            :                         }
<span class="lineNum">     549 </span>            :                 } else {
<span class="lineNum">     550 </span>            :                         //no start, end is a file size
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :                         if (sess-&gt;ranges[i].end &gt;= (s64) known_file_size) {</span>
<span class="lineNum">     552 </span>            :                                 request_ok = GF_FALSE;
<span class="lineNum">     553 </span>            :                                 break;
<span class="lineNum">     554 </span>            :                         }
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :                         sess-&gt;ranges[i].start = known_file_size - sess-&gt;ranges[i].end;</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :                         sess-&gt;ranges[i].end = known_file_size - 1;</span>
<span class="lineNum">     557 </span>            :                 }
<span class="lineNum">     558 </span><span class="lineCov">         30 :                 sess-&gt;bytes_in_req += (sess-&gt;ranges[i].end + 1 - sess-&gt;ranges[i].start);</span>
<span class="lineNum">     559 </span>            :         }
<span class="lineNum">     560 </span>            :         //if we have a single byte range request covering the entire file, reply 200 OK and not 206 partial
<span class="lineNum">     561 </span><span class="lineCov">         31 :         if ((sess-&gt;nb_ranges == 1) &amp;&amp; known_file_size &amp;&amp; !sess-&gt;ranges[0].start &amp;&amp; (sess-&gt;ranges[0].end==known_file_size-1))</span>
<span class="lineNum">     562 </span><span class="lineCov">          1 :                 sess-&gt;nb_ranges = 0;</span>
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span><span class="lineCov">         31 :         if (!request_ok) {</span>
<span class="lineNum">     565 </span><span class="lineCov">          1 :                 if (!sess-&gt;in_source || (sess-&gt;nb_ranges&gt;1))</span>
<span class="lineNum">     566 </span>            :                         return GF_FALSE;
<span class="lineNum">     567 </span>            :                 //source in progress, we accept single range - note that this could be further refined by postponing the request until the source
<span class="lineNum">     568 </span>            :                 //is done or has written the requested byte range, however this will delay sending chunk in LL-HLS byterange ...
<span class="lineNum">     569 </span>            :                 //for now, since we use chunk transfer in this case, we will send less data than asked and close resource using last 0-size chunk
<span class="lineNum">     570 </span>            :         }
<span class="lineNum">     571 </span><span class="lineCov">         31 :         sess-&gt;file_pos = sess-&gt;ranges[0].start;</span>
<span class="lineNum">     572 </span><span class="lineCov">         31 :         if (sess-&gt;resource)</span>
<span class="lineNum">     573 </span><span class="lineCov">         31 :                 gf_fseek(sess-&gt;resource, sess-&gt;file_pos, SEEK_SET);</span>
<span class="lineNum">     574 </span>            :         return GF_TRUE;
<a name="575"><span class="lineNum">     575 </span>            : }</a>
<span class="lineNum">     576 </span>            : 
<span class="lineNum">     577 </span><span class="lineCov">        216 : static Bool httpout_do_log(GF_HTTPOutSession *sess, u32 method)</span>
<span class="lineNum">     578 </span>            : {
<span class="lineNum">     579 </span><span class="lineCov">        216 :         if (!sess-&gt;ctx-&gt;reqlog) return GF_FALSE;</span>
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span><span class="lineCov">        172 :         if (!strcmp(sess-&gt;ctx-&gt;reqlog, &quot;*&quot;)) return GF_TRUE;</span>
<span class="lineNum">     582 </span>            : 
<span class="lineNum">     583 </span><span class="lineCov">        172 :         switch (method) {</span>
<span class="lineNum">     584 </span><span class="lineCov">        153 :         case GF_HTTP_GET:</span>
<span class="lineNum">     585 </span><span class="lineCov">        153 :                 if (strstr(sess-&gt;ctx-&gt;reqlog, &quot;GET&quot;) || strstr(sess-&gt;ctx-&gt;reqlog, &quot;get&quot;)) return GF_TRUE;</span>
<span class="lineNum">     586 </span>            :                 break;
<span class="lineNum">     587 </span><span class="lineCov">         17 :         case GF_HTTP_PUT:</span>
<span class="lineNum">     588 </span><span class="lineCov">         17 :                 if (strstr(sess-&gt;ctx-&gt;reqlog, &quot;PUT&quot;) || strstr(sess-&gt;ctx-&gt;reqlog, &quot;put&quot;)) return GF_TRUE;</span>
<span class="lineNum">     589 </span>            :                 break;
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :         case GF_HTTP_POST:</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :                 if (strstr(sess-&gt;ctx-&gt;reqlog, &quot;POST&quot;) || strstr(sess-&gt;ctx-&gt;reqlog, &quot;post&quot;)) return GF_TRUE;</span>
<span class="lineNum">     592 </span>            :                 break;
<span class="lineNum">     593 </span><span class="lineCov">          2 :         case GF_HTTP_DELETE:</span>
<span class="lineNum">     594 </span><span class="lineCov">          2 :                 if (strstr(sess-&gt;ctx-&gt;reqlog, &quot;DEL&quot;) || strstr(sess-&gt;ctx-&gt;reqlog, &quot;del&quot;)) return GF_TRUE;</span>
<span class="lineNum">     595 </span>            :                 break;
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :         case GF_HTTP_HEAD:</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :                 if (strstr(sess-&gt;ctx-&gt;reqlog, &quot;HEAD&quot;) || strstr(sess-&gt;ctx-&gt;reqlog, &quot;head&quot;)) return GF_TRUE;</span>
<span class="lineNum">     598 </span>            :                 break;
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :         case GF_HTTP_OPTIONS:</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :                 if (strstr(sess-&gt;ctx-&gt;reqlog, &quot;OPT&quot;) || strstr(sess-&gt;ctx-&gt;reqlog, &quot;opt&quot;)) return GF_TRUE;</span>
<span class="lineNum">     601 </span>            :                 break;
<span class="lineNum">     602 </span>            :         default:
<span class="lineNum">     603 </span>            :                 return GF_TRUE;
<span class="lineNum">     604 </span>            :         }
<span class="lineNum">     605 </span>            :         return GF_FALSE;
<span class="lineNum">     606 </span>            : }
<a name="607"><span class="lineNum">     607 </span>            : </a>
<span class="lineNum">     608 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">     609 </span><span class="lineCov">        337 : static const char *get_method_name(u32 method)</span>
<span class="lineNum">     610 </span>            : {
<span class="lineNum">     611 </span><span class="lineCov">        337 :         switch (method) {</span>
<span class="lineNum">     612 </span>            :         case GF_HTTP_GET: return &quot;GET&quot;;
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :         case GF_HTTP_HEAD: return &quot;HEAD&quot;;</span>
<span class="lineNum">     614 </span><span class="lineCov">         31 :         case GF_HTTP_PUT: return &quot;PUT&quot;;</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :         case GF_HTTP_POST: return &quot;POST&quot;;</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :         case GF_HTTP_DELETE: return &quot;DELETE&quot;;</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :         case GF_HTTP_TRACE: return &quot;TRACE&quot;;</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :         case GF_HTTP_CONNECT: return &quot;CONNECT&quot;;</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :         case GF_HTTP_OPTIONS: return &quot;OPTIONS&quot;;</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :         default: return &quot;UNKNOWN&quot;;</span>
<span class="lineNum">     621 </span>            :         }
<span class="lineNum">     622 </span>            : }
<a name="623"><span class="lineNum">     623 </span>            : #endif //GPAC_DISABLE_LOG</a>
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineNoCov">          0 : GF_Err httpout_new_subsession(GF_HTTPOutSession *sess, u32 stream_id)</span>
<span class="lineNum">     626 </span>            : {
<span class="lineNum">     627 </span>            :         GF_HTTPOutSession *sub_sess;
<span class="lineNum">     628 </span>            :         GF_Err e;
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :         if (!sess || !sess-&gt;http_sess || !sess-&gt;is_h2)</span>
<span class="lineNum">     630 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">     631 </span>            : 
<span class="lineNum">     632 </span>            : 
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :         GF_SAFEALLOC(sub_sess, GF_HTTPOutSession);</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :         if (!sub_sess) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :         sub_sess-&gt;socket = sess-&gt;socket;</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :         sub_sess-&gt;ctx = sess-&gt;ctx;</span>
<span class="lineNum">     637 </span>            :         //mark the subsession as being h2 right away so that we can process it even if no pending data on socket (cf httpout_process_session)
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :         sub_sess-&gt;is_h2 = GF_TRUE;</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :         strcpy(sub_sess-&gt;peer_address, sess-&gt;peer_address);</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :         sub_sess-&gt;http_sess = gf_dm_sess_new_subsession(sess-&gt;http_sess, stream_id, sub_sess, &amp;e);</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :         if (!sub_sess-&gt;http_sess) {</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :                 gf_free(sub_sess);</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :                 return e;</span>
<span class="lineNum">     644 </span>            :         }
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :         gf_list_add(sess-&gt;ctx-&gt;sessions, sub_sess);</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :         gf_list_add(sess-&gt;ctx-&gt;active_sessions, sub_sess);</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :         sess-&gt;sub_sess_pending = GF_TRUE;</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">     649 </span>            : }
<a name="650"><span class="lineNum">     650 </span>            : </a>
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineCov">        385 : static void httpout_sess_io(void *usr_cbk, GF_NETIO_Parameter *parameter)</span>
<span class="lineNum">     653 </span>            : {
<span class="lineNum">     654 </span>            :         const char *durl=&quot;&quot;;
<span class="lineNum">     655 </span>            :         char *url=NULL;
<span class="lineNum">     656 </span><span class="lineCov">        385 :         char *full_path=NULL;</span>
<span class="lineNum">     657 </span>            :         char szFmt[100];
<span class="lineNum">     658 </span>            :         char szDate[200];
<span class="lineNum">     659 </span>            :         char szETag[100];
<span class="lineNum">     660 </span>            :         u64 modif_time=0;
<span class="lineNum">     661 </span>            :         u32 body_size=0;
<span class="lineNum">     662 </span>            :         const char *etag=NULL, *range=NULL;
<span class="lineNum">     663 </span>            :         const char *mime = NULL;
<span class="lineNum">     664 </span><span class="lineCov">        385 :         char *response_body = NULL;</span>
<span class="lineNum">     665 </span>            :         GF_Err e=GF_OK;
<span class="lineNum">     666 </span>            :         Bool not_modified = GF_FALSE;
<span class="lineNum">     667 </span>            :         Bool is_upload = GF_FALSE;
<span class="lineNum">     668 </span>            :         Bool is_head = GF_FALSE;
<span class="lineNum">     669 </span>            :         Bool no_body = GF_FALSE;
<span class="lineNum">     670 </span>            :         Bool send_cors;
<span class="lineNum">     671 </span>            :         u32 i, count;
<span class="lineNum">     672 </span>            :         GF_HTTPOutInput *source_pid = NULL;
<span class="lineNum">     673 </span>            :         Bool source_pid_is_ll_hls_chunk = GF_FALSE;
<span class="lineNum">     674 </span>            :         GF_HTTPOutSession *source_sess = NULL;
<span class="lineNum">     675 </span>            :         GF_HTTPOutSession *sess = usr_cbk;
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span><span class="lineCov">        385 :         if (parameter-&gt;msg_type == GF_NETIO_REQUEST_SESSION) {</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :                 parameter-&gt;error = httpout_new_subsession(sess, parameter-&gt;reply);</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     680 </span>            :         }
<span class="lineNum">     681 </span><span class="lineCov">        385 :         if (parameter-&gt;msg_type == GF_NETIO_CANCEL_STREAM) {</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :                 sess-&gt;canceled = GF_TRUE;</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     684 </span>            :         }
<span class="lineNum">     685 </span>            : 
<span class="lineNum">     686 </span><span class="lineCov">        385 :         if (parameter-&gt;msg_type != GF_NETIO_PARSE_REPLY) {</span>
<span class="lineNum">     687 </span><span class="lineCov">        169 :                 parameter-&gt;error = GF_BAD_PARAM;</span>
<span class="lineNum">     688 </span><span class="lineCov">        169 :                 return;</span>
<span class="lineNum">     689 </span>            :         }
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span>            :         send_cors = GF_FALSE;
<span class="lineNum">     692 </span><span class="lineCov">        216 :         sess-&gt;reply_code = 0;</span>
<span class="lineNum">     693 </span><span class="lineCov">        216 :         switch (parameter-&gt;reply) {</span>
<span class="lineNum">     694 </span>            :         case GF_HTTP_GET:
<span class="lineNum">     695 </span>            :         case GF_HTTP_HEAD:
<span class="lineNum">     696 </span>            :                 break;
<span class="lineNum">     697 </span><span class="lineCov">         30 :         case GF_HTTP_PUT:</span>
<span class="lineNum">     698 </span>            :         case GF_HTTP_POST:
<span class="lineNum">     699 </span>            :         case GF_HTTP_DELETE:
<span class="lineNum">     700 </span>            :                 is_upload = GF_TRUE;
<span class="lineNum">     701 </span><span class="lineCov">         30 :                 break;</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :         default:</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :                 sess-&gt;reply_code = 501;</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :                 gf_dynstrcat(&amp;response_body, &quot;Method is not supported by GPAC&quot;, NULL);</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :                 goto exit;</span>
<span class="lineNum">     706 </span>            :         }
<span class="lineNum">     707 </span><span class="lineCov">        216 :         durl = gf_dm_sess_get_resource_name(sess-&gt;http_sess);</span>
<span class="lineNum">     708 </span><span class="lineCov">        216 :         if (!durl || (durl[0] != '/')) {</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :                 sess-&gt;reply_code = 400;</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :                 goto exit;</span>
<span class="lineNum">     711 </span>            :         }
<span class="lineNum">     712 </span><span class="lineCov">        216 :         url = gf_url_percent_decode(durl);</span>
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span><span class="lineCov">        216 :         sess-&gt;file_pos = 0;</span>
<span class="lineNum">     715 </span><span class="lineCov">        216 :         sess-&gt;file_size = 0;</span>
<span class="lineNum">     716 </span><span class="lineCov">        216 :         sess-&gt;bytes_in_req = 0;</span>
<span class="lineNum">     717 </span><span class="lineCov">        216 :         sess-&gt;nb_ranges = 0;</span>
<span class="lineNum">     718 </span><span class="lineCov">        216 :         sess-&gt;do_log = httpout_do_log(sess, parameter-&gt;reply);</span>
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span>            :         //resolve name against upload dir
<span class="lineNum">     721 </span><span class="lineCov">        216 :         if (is_upload) {</span>
<span class="lineNum">     722 </span><span class="lineCov">         30 :                 if (!sess-&gt;ctx-&gt;wdir &amp;&amp; (sess-&gt;ctx-&gt;hmode!=MODE_SOURCE)) {</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :                         sess-&gt;reply_code = 405;</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;response_body, &quot;No write directory enabled on server&quot;, NULL);</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :                         goto exit;</span>
<span class="lineNum">     726 </span>            :                 }
<span class="lineNum">     727 </span><span class="lineCov">         30 :                 if (sess-&gt;ctx-&gt;wdir) {</span>
<span class="lineNum">     728 </span><span class="lineCov">         29 :                         u32 len = (u32) strlen(sess-&gt;ctx-&gt;wdir);</span>
<span class="lineNum">     729 </span><span class="lineCov">         29 :                         gf_dynstrcat(&amp;full_path, sess-&gt;ctx-&gt;wdir, NULL);</span>
<span class="lineNum">     730 </span><span class="lineCov">         29 :                         if (!strchr(&quot;/\\&quot;, sess-&gt;ctx-&gt;wdir[len-1]))</span>
<span class="lineNum">     731 </span><span class="lineCov">         29 :                                 gf_dynstrcat(&amp;full_path, &quot;/&quot;, NULL);</span>
<span class="lineNum">     732 </span><span class="lineCov">         29 :                         gf_dynstrcat(&amp;full_path, url+1, NULL);</span>
<span class="lineNum">     733 </span><span class="lineCov">          1 :                 } else if (sess-&gt;ctx-&gt;hmode==MODE_SOURCE) {</span>
<span class="lineNum">     734 </span><span class="lineCov">          1 :                         full_path = gf_strdup(url+1);</span>
<span class="lineNum">     735 </span>            :                 }
<span class="lineNum">     736 </span><span class="lineCov">         30 :                 if (parameter-&gt;reply==GF_HTTP_DELETE)</span>
<span class="lineNum">     737 </span>            :                         is_upload = GF_FALSE;
<span class="lineNum">     738 </span>            :         }
<span class="lineNum">     739 </span>            : 
<span class="lineNum">     740 </span><span class="lineCov">        214 :         if (is_upload) {</span>
<span class="lineNum">     741 </span>            :                 const char *hdr;
<span class="lineNum">     742 </span><span class="lineCov">         28 :                 range = gf_dm_sess_get_header(sess-&gt;http_sess, &quot;Range&quot;);</span>
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span><span class="lineCov">         28 :                 if (sess-&gt;in_source) {</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :                         sess-&gt;in_source-&gt;nb_dest--;</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :                         sess-&gt;in_source = NULL;</span>
<span class="lineNum">     747 </span>            :                 }
<span class="lineNum">     748 </span><span class="lineCov">         28 :                 sess-&gt;content_length = 0;</span>
<span class="lineNum">     749 </span><span class="lineCov">         28 :                 hdr = gf_dm_sess_get_header(sess-&gt;http_sess, &quot;Content-Length&quot;);</span>
<span class="lineNum">     750 </span><span class="lineCov">         28 :                 if (hdr) {</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :                         sscanf(hdr, LLU, &amp;sess-&gt;content_length);</span>
<span class="lineNum">     752 </span>            :                 }
<span class="lineNum">     753 </span><span class="lineCov">         28 :                 sess-&gt;use_chunk_transfer = GF_FALSE;</span>
<span class="lineNum">     754 </span><span class="lineCov">         28 :                 hdr = gf_dm_sess_get_header(sess-&gt;http_sess, &quot;Transfer-Encoding&quot;);</span>
<span class="lineNum">     755 </span><span class="lineCov">         28 :                 if (hdr &amp;&amp; !strcmp(hdr, &quot;chunked&quot;)) {</span>
<span class="lineNum">     756 </span><span class="lineCov">         28 :                         sess-&gt;use_chunk_transfer = GF_TRUE;</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :                 } else if (!sess-&gt;is_h2) {</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :                         sess-&gt;is_h2 = gf_dm_sess_is_h2(sess-&gt;http_sess);</span>
<span class="lineNum">     759 </span>            :                 }
<span class="lineNum">     760 </span><span class="lineCov">         28 :                 sess-&gt;file_in_progress = GF_FALSE;</span>
<span class="lineNum">     761 </span><span class="lineCov">         28 :                 sess-&gt;nb_bytes = 0;</span>
<span class="lineNum">     762 </span><span class="lineCov">         28 :                 sess-&gt;done = GF_FALSE;</span>
<span class="lineNum">     763 </span>            :                 assert(full_path);
<span class="lineNum">     764 </span><span class="lineCov">         28 :                 if (sess-&gt;path) gf_free(sess-&gt;path);</span>
<span class="lineNum">     765 </span><span class="lineCov">         28 :                 sess-&gt;path = full_path;</span>
<span class="lineNum">     766 </span><span class="lineCov">         28 :                 if (sess-&gt;resource) gf_fclose(sess-&gt;resource);</span>
<span class="lineNum">     767 </span><span class="lineCov">         28 :                 sess-&gt;resource = NULL;</span>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span><span class="lineCov">         28 :                 if (sess-&gt;ctx-&gt;hmode==MODE_SOURCE) {</span>
<span class="lineNum">     770 </span><span class="lineCov">          1 :                         if (range) {</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_HTTP, (&quot;[HTTPOut] Cannot handle PUT/POST request as PID output with byte ranges (%s)\n&quot;, range));</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :                                 sess-&gt;reply_code = 416;</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;response_body, &quot;Server running in source mode - cannot handle PUT/POST request with byte ranges &quot;, NULL);</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;response_body, range, NULL);</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :                                 goto exit;</span>
<span class="lineNum">     776 </span>            :                         }
<span class="lineNum">     777 </span><span class="lineCov">          1 :                         sess-&gt;upload_type = 1;</span>
<span class="lineNum">     778 </span><span class="lineCov">          1 :                         sess-&gt;reconfigure_output = GF_TRUE;</span>
<span class="lineNum">     779 </span>            :                 } else {
<span class="lineNum">     780 </span><span class="lineCov">         27 :                         if (gf_file_exists(sess-&gt;path))</span>
<span class="lineNum">     781 </span><span class="lineCov">         16 :                                 sess-&gt;upload_type = 2;</span>
<span class="lineNum">     782 </span>            :                         else
<span class="lineNum">     783 </span><span class="lineCov">         11 :                                 sess-&gt;upload_type = 1;</span>
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span><span class="lineCov">         27 :                         sess-&gt;resource = gf_fopen(sess-&gt;path, range ? &quot;rb+&quot; : &quot;wb&quot;);</span>
<span class="lineNum">     786 </span><span class="lineCov">         27 :                         if (!sess-&gt;resource) {</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :                                 sess-&gt;reply_code = 403;</span>
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;response_body, &quot;File exists but cannot be open&quot;, NULL);</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :                                 goto exit;</span>
<span class="lineNum">     790 </span>            :                         }
<span class="lineNum">     791 </span><span class="lineCov">         27 :                         if (!sess-&gt;content_length &amp;&amp; !sess-&gt;use_chunk_transfer &amp;&amp; !sess-&gt;is_h2) {</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :                                 sess-&gt;reply_code = 411;</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;response_body, &quot;No content length specified and chunked transfer not enabled&quot;, NULL);</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :                                 goto exit;</span>
<span class="lineNum">     795 </span>            :                         }
<span class="lineNum">     796 </span><span class="lineCov">         27 :                         sess-&gt;file_size = gf_fsize(sess-&gt;resource);</span>
<span class="lineNum">     797 </span>            :                 }
<span class="lineNum">     798 </span><span class="lineCov">         28 :                 sess-&gt;file_pos = 0;</span>
<span class="lineNum">     799 </span>            : 
<span class="lineNum">     800 </span><span class="lineCov">         28 :                 range = gf_dm_sess_get_header(sess-&gt;http_sess, &quot;Range&quot;);</span>
<span class="lineNum">     801 </span><span class="lineCov">         28 :                 if (! httpout_sess_parse_range(sess, (char *) range) ) {</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_HTTP, (&quot;[HTTPOut] Unsupported Range format: %s\n&quot;, range));</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :                         sess-&gt;reply_code = 416;</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;response_body, &quot;Range format is not supported, only \&quot;bytes\&quot; units allowed: &quot;, NULL);</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;response_body, range, NULL);</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :                         goto exit;</span>
<span class="lineNum">     807 </span>            :                 }
<span class="lineNum">     808 </span><span class="lineCov">         28 :                 if (!sess-&gt;buffer) {</span>
<span class="lineNum">     809 </span><span class="lineCov">         12 :                         sess-&gt;buffer = gf_malloc(sizeof(u8)*sess-&gt;ctx-&gt;block_size);</span>
<span class="lineNum">     810 </span>            :                 }
<span class="lineNum">     811 </span><span class="lineCov">         28 :                 if (gf_list_find(sess-&gt;ctx-&gt;active_sessions, sess)&lt;0) {</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :                         gf_list_add(sess-&gt;ctx-&gt;active_sessions, sess);</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :                         gf_sk_group_register(sess-&gt;ctx-&gt;sg, sess-&gt;socket);</span>
<span class="lineNum">     814 </span>            :                 }
<span class="lineNum">     815 </span><span class="lineCov">         28 :                 sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">     816 </span>            : 
<span class="lineNum">     817 </span><span class="lineCov">         28 :                 if (sess-&gt;do_log) {</span>
<span class="lineNum">     818 </span><span class="lineCov">         17 :                         sess-&gt;req_id = ++sess-&gt;ctx-&gt;req_id;</span>
<span class="lineNum">     819 </span><span class="lineCov">         17 :                         sess-&gt;method_type = parameter-&gt;reply;</span>
<span class="lineNum">     820 </span><span class="lineCov">         17 :                         if (range) {</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] REQ#&quot;LLU&quot; %s %s %s [range: %s] start%s\n&quot;, sess-&gt;req_id, sess-&gt;peer_address, get_method_name(sess-&gt;method_type), url+1, range, sess-&gt;use_chunk_transfer ? &quot; chunk-transfer&quot; : &quot;&quot;));</span>
<span class="lineNum">     822 </span>            :                         } else {
<span class="lineNum">     823 </span><span class="lineCov">         17 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] REQ#&quot;LLU&quot; %s %s %s start%s\n&quot;, sess-&gt;req_id, sess-&gt;peer_address, get_method_name(sess-&gt;method_type), url+1, sess-&gt;use_chunk_transfer ? &quot; chunk-transfer&quot; : &quot;&quot;));</span>
<span class="lineNum">     824 </span>            :                         }
<span class="lineNum">     825 </span>            :                 }
<span class="lineNum">     826 </span><span class="lineCov">         28 :                 sess-&gt;nb_consecutive_errors = 0;</span>
<span class="lineNum">     827 </span><span class="lineCov">         28 :                 sess-&gt;req_start_time = gf_sys_clock_high_res();</span>
<span class="lineNum">     828 </span><span class="lineCov">         28 :                 if (url) gf_free(url);</span>
<span class="lineNum">     829 </span><span class="lineCov">         28 :                 gf_dm_sess_clear_headers(sess-&gt;http_sess);</span>
<span class="lineNum">     830 </span>            :                 //send reply once we are done receiving
<span class="lineNum">     831 </span><span class="lineCov">         28 :                 return;</span>
<span class="lineNum">     832 </span>            :         }
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span>            :         /*first check active inputs*/
<span class="lineNum">     835 </span><span class="lineCov">        188 :         count = gf_list_count(sess-&gt;ctx-&gt;inputs);</span>
<span class="lineNum">     836 </span>            :         //delete only accepts local files
<span class="lineNum">     837 </span><span class="lineCov">        188 :         if (parameter-&gt;reply == GF_HTTP_DELETE)</span>
<span class="lineNum">     838 </span>            :                 count = 0;
<span class="lineNum">     839 </span>            : 
<span class="lineNum">     840 </span><span class="lineCov">        584 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     841 </span><span class="lineCov">        418 :                 GF_HTTPOutInput *in = gf_list_get(sess-&gt;ctx-&gt;inputs, i);</span>
<span class="lineNum">     842 </span>            :                 assert(in-&gt;path[0] == '/');
<span class="lineNum">     843 </span>            :                 //matching name and input pid not done: file has been created and is in progress
<span class="lineNum">     844 </span>            :                 //if input pid done, try from file
<span class="lineNum">     845 </span><span class="lineCov">        418 :                 if (!strcmp(in-&gt;path, url) &amp;&amp; !in-&gt;done) {</span>
<span class="lineNum">     846 </span>            :                         source_pid = in;
<span class="lineNum">     847 </span>            :                         break;
<span class="lineNum">     848 </span>            :                 }
<span class="lineNum">     849 </span><span class="lineCov">        397 :                 if (in-&gt;hls_chunk_path &amp;&amp; !strcmp(in-&gt;hls_chunk_path, url) &amp;&amp; !in-&gt;done) {</span>
<span class="lineNum">     850 </span>            :                         source_pid = in;
<span class="lineNum">     851 </span>            :                         source_pid_is_ll_hls_chunk = GF_TRUE;
<span class="lineNum">     852 </span>            :                         break;
<span class="lineNum">     853 </span>            :                 }
<span class="lineNum">     854 </span>            :         }
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span>            :         /*not resolved and no source matching, check file on disk*/
<span class="lineNum">     857 </span><span class="lineCov">        188 :         if (!source_pid &amp;&amp; !full_path) {</span>
<span class="lineNum">     858 </span><span class="lineCov">        164 :                 count = sess-&gt;ctx-&gt;rdirs.nb_items;</span>
<span class="lineNum">     859 </span><span class="lineCov">        164 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     860 </span><span class="lineCov">        164 :                         char *mdir = sess-&gt;ctx-&gt;rdirs.vals[i];</span>
<span class="lineNum">     861 </span><span class="lineCov">        164 :                         u32 len = (u32) strlen(mdir);</span>
<span class="lineNum">     862 </span><span class="lineCov">        164 :                         if (!len) continue;</span>
<span class="lineNum">     863 </span><span class="lineCov">        164 :                         if (count==1) {</span>
<span class="lineNum">     864 </span><span class="lineCov">        164 :                                 gf_dynstrcat(&amp;full_path, mdir, NULL);</span>
<span class="lineNum">     865 </span><span class="lineCov">        164 :                                 if (!strchr(&quot;/\\&quot;, mdir[len-1]))</span>
<span class="lineNum">     866 </span><span class="lineCov">        164 :                                         gf_dynstrcat(&amp;full_path, &quot;/&quot;, NULL);</span>
<span class="lineNum">     867 </span>            :                         }
<span class="lineNum">     868 </span><span class="lineCov">        164 :                         gf_dynstrcat(&amp;full_path, url+1, NULL);</span>
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span><span class="lineCov">        164 :                         if (gf_file_exists(full_path) || gf_dir_exists(full_path) )</span>
<span class="lineNum">     871 </span>            :                                 break;
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :                         gf_free(full_path);</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :                         full_path = NULL;</span>
<span class="lineNum">     874 </span>            :                 }
<span class="lineNum">     875 </span>            :         }
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span><span class="lineCov">        188 :         switch (sess-&gt;ctx-&gt;cors) {</span>
<span class="lineNum">     878 </span>            :         case CORS_ON:
<span class="lineNum">     879 </span>            :                 send_cors = GF_TRUE;
<span class="lineNum">     880 </span>            :                 break;
<span class="lineNum">     881 </span><span class="lineCov">        188 :         case CORS_AUTO:</span>
<span class="lineNum">     882 </span><span class="lineCov">        188 :                 if (gf_dm_sess_get_header(sess-&gt;http_sess, &quot;Origin&quot;) != NULL) {</span>
<span class="lineNum">     883 </span>            :                         send_cors = GF_TRUE;
<span class="lineNum">     884 </span>            :                         break;
<span class="lineNum">     885 </span>            :                 }
<span class="lineNum">     886 </span>            :         default:
<span class="lineNum">     887 </span>            :                 send_cors = GF_FALSE;
<span class="lineNum">     888 </span>            :                 break;
<span class="lineNum">     889 </span>            :         }
<span class="lineNum">     890 </span>            : 
<span class="lineNum">     891 </span><span class="lineCov">        188 :         if (!full_path &amp;&amp; !source_pid) {</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :                 if (!sess-&gt;ctx-&gt;dlist || strcmp(url, &quot;/&quot;)) {</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :                         sess-&gt;reply_code = 404;</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;response_body, &quot;Resource &quot;, NULL);</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;response_body, url, NULL);</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;response_body, &quot; cannot be resolved&quot;, NULL);</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :                         goto exit;</span>
<span class="lineNum">     898 </span>            :                 }
<span class="lineNum">     899 </span>            :         }
<span class="lineNum">     900 </span>            : 
<span class="lineNum">     901 </span>            :         //check if request is HEAD or GET on a file being uploaded
<span class="lineNum">     902 </span><span class="lineCov">        188 :         if (full_path &amp;&amp; ((parameter-&gt;reply == GF_HTTP_GET) || (parameter-&gt;reply == GF_HTTP_HEAD))) {</span>
<span class="lineNum">     903 </span><span class="lineCov">        164 :                 count = gf_list_count(sess-&gt;ctx-&gt;sessions);</span>
<span class="lineNum">     904 </span><span class="lineCov">        470 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     905 </span><span class="lineCov">        306 :                         source_sess = gf_list_get(sess-&gt;ctx-&gt;sessions, i);</span>
<span class="lineNum">     906 </span><span class="lineCov">        306 :                         if ((source_sess != sess) &amp;&amp; !source_sess-&gt;done &amp;&amp; source_sess-&gt;upload_type &amp;&amp; !strcmp(source_sess-&gt;path, full_path)) {</span>
<span class="lineNum">     907 </span>            :                                 break;
<span class="lineNum">     908 </span>            :                         }
<span class="lineNum">     909 </span>            :                         source_sess = NULL;
<span class="lineNum">     910 </span>            :                 }
<span class="lineNum">     911 </span>            :         }
<span class="lineNum">     912 </span>            : 
<span class="lineNum">     913 </span><span class="lineCov">        188 :         szETag[0] = 0;</span>
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span>            :         //session is on an active input being uploaded, always consider as modified
<span class="lineNum">     916 </span><span class="lineCov">        188 :         if (source_pid &amp;&amp; !sess-&gt;ctx-&gt;single_mode) {</span>
<span class="lineNum">     917 </span>            :                 etag = NULL;
<span class="lineNum">     918 </span>            :         }
<span class="lineNum">     919 </span>            :         //resource is being uploaded, always consider as modified
<span class="lineNum">     920 </span><span class="lineCov">        167 :         else if (source_sess) {</span>
<span class="lineNum">     921 </span>            :                 etag = NULL;
<span class="lineNum">     922 </span>            :         }
<span class="lineNum">     923 </span>            :         //check ETag
<span class="lineNum">     924 </span><span class="lineCov">        167 :         else if (full_path) {</span>
<span class="lineNum">     925 </span><span class="lineCov">        166 :                 modif_time = gf_file_modification_time(full_path);</span>
<span class="lineNum">     926 </span>            :                 sprintf(szETag, LLU, modif_time);
<span class="lineNum">     927 </span><span class="lineCov">        166 :                 etag = gf_dm_sess_get_header(sess-&gt;http_sess, &quot;If-None-Match&quot;);</span>
<span class="lineNum">     928 </span>            :         }
<span class="lineNum">     929 </span>            : 
<span class="lineNum">     930 </span><span class="lineCov">        188 :         range = gf_dm_sess_get_header(sess-&gt;http_sess, &quot;Range&quot;);</span>
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span><span class="lineCov">        188 :         if (sess-&gt;in_source) {</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :                 sess-&gt;in_source-&gt;nb_dest--;</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :                 sess-&gt;in_source = NULL;</span>
<span class="lineNum">     935 </span>            :         }
<span class="lineNum">     936 </span><span class="lineCov">        188 :         sess-&gt;file_in_progress = GF_FALSE;</span>
<span class="lineNum">     937 </span><span class="lineCov">        188 :         sess-&gt;use_chunk_transfer = GF_FALSE;</span>
<span class="lineNum">     938 </span><span class="lineCov">        188 :         sess-&gt;put_in_progress = 0;</span>
<span class="lineNum">     939 </span><span class="lineCov">        188 :         sess-&gt;nb_bytes = 0;</span>
<span class="lineNum">     940 </span><span class="lineCov">        188 :         sess-&gt;upload_type = 0;</span>
<span class="lineNum">     941 </span>            : 
<span class="lineNum">     942 </span><span class="lineCov">        188 :         if (parameter-&gt;reply==GF_HTTP_DELETE) {</span>
<span class="lineNum">     943 </span>            :                 no_body = GF_TRUE;
<span class="lineNum">     944 </span>            :                 sess-&gt;upload_type = 0;
<span class="lineNum">     945 </span><span class="lineCov">          2 :                 if (sess-&gt;path) gf_free(sess-&gt;path);</span>
<span class="lineNum">     946 </span><span class="lineCov">          2 :                 sess-&gt;path = full_path;</span>
<span class="lineNum">     947 </span><span class="lineCov">          2 :                 if (sess-&gt;resource) gf_fclose(sess-&gt;resource);</span>
<span class="lineNum">     948 </span><span class="lineCov">          2 :                 sess-&gt;resource = NULL;</span>
<span class="lineNum">     949 </span><span class="lineCov">          2 :                 sess-&gt;file_pos = sess-&gt;file_size = 0;</span>
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span><span class="lineCov">          2 :                 if (gf_file_exists(full_path)) {</span>
<span class="lineNum">     952 </span><span class="lineCov">          2 :                         e = gf_file_delete(full_path);</span>
<span class="lineNum">     953 </span>            : 
<span class="lineNum">     954 </span><span class="lineCov">          2 :                         if (e) {</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :                                 sess-&gt;reply_code = 500;</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_HTTP, (&quot;[HTTPOut] Error deleting file %s (full path %s)\n&quot;, url, full_path));</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :                                 sess-&gt;reply_code = 500;</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;response_body, &quot;Error while deleting &quot;, NULL);</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;response_body, url, NULL);</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;response_body, &quot;: &quot;, NULL);</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;response_body, gf_error_to_string(e), NULL);</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :                                 goto exit;</span>
<span class="lineNum">     963 </span>            :                         }
<span class="lineNum">     964 </span><span class="lineCov">          2 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_HTTP, (&quot;[HTTPOut] Deleting file %s (full path %s)\n&quot;, url, full_path));</span>
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span><span class="lineCov">          2 :                         if (sess-&gt;do_log) {</span>
<span class="lineNum">     967 </span><span class="lineCov">          2 :                                 sess-&gt;req_id = ++sess-&gt;ctx-&gt;req_id;</span>
<span class="lineNum">     968 </span><span class="lineCov">          2 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] REQ#&quot;LLU&quot; %s DELETE %s\n&quot;, sess-&gt;req_id, sess-&gt;peer_address, url+1));</span>
<span class="lineNum">     969 </span><span class="lineCov">          2 :                                 sess-&gt;do_log = GF_FALSE;</span>
<span class="lineNum">     970 </span>            :                         }
<span class="lineNum">     971 </span>            :                 } else {
<span class="lineNum">     972 </span>            :                         e = GF_URL_ERROR;
<span class="lineNum">     973 </span>            :                 }
<span class="lineNum">     974 </span>            :                 range = NULL;
<span class="lineNum">     975 </span>            :         }
<span class="lineNum">     976 </span>            :         /*we have a source and we are not in record mode */
<span class="lineNum">     977 </span><span class="lineCov">        186 :         else if (source_pid &amp;&amp; sess-&gt;ctx-&gt;single_mode) {</span>
<span class="lineNum">     978 </span><span class="lineCov">          1 :                 if (sess-&gt;path) gf_free(sess-&gt;path);</span>
<span class="lineNum">     979 </span><span class="lineCov">          1 :                 sess-&gt;path = NULL;</span>
<span class="lineNum">     980 </span><span class="lineCov">          1 :                 sess-&gt;in_source = source_pid;</span>
<span class="lineNum">     981 </span><span class="lineCov">          1 :                 source_pid-&gt;nb_dest++;</span>
<span class="lineNum">     982 </span><span class="lineCov">          1 :                 sess-&gt;send_init_data = GF_TRUE;</span>
<span class="lineNum">     983 </span><span class="lineCov">          1 :                 source_pid-&gt;hold = GF_FALSE;</span>
<span class="lineNum">     984 </span>            : 
<span class="lineNum">     985 </span><span class="lineCov">          1 :                 sess-&gt;file_pos = sess-&gt;file_size = 0;</span>
<span class="lineNum">     986 </span><span class="lineCov">          1 :                 sess-&gt;use_chunk_transfer = GF_TRUE;</span>
<span class="lineNum">     987 </span>            :         }
<span class="lineNum">     988 </span>            :         /*we have matching etag*/
<span class="lineNum">     989 </span><span class="lineCov">        185 :         else if (etag &amp;&amp; !strcmp(etag, szETag) &amp;&amp; !sess-&gt;ctx-&gt;no_etag) {</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :                 if (sess-&gt;path) gf_free(sess-&gt;path);</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :                 sess-&gt;path = full_path;</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :                 not_modified = GF_TRUE;</span>
<span class="lineNum">     993 </span>            :         }
<span class="lineNum">     994 </span>            :         /*we have the same URL, source file is setup and not modified, no need to resetup - byte-range is setup after */
<span class="lineNum">     995 </span><span class="lineCov">        185 :         else if (!sess-&gt;in_source &amp;&amp; sess-&gt;resource &amp;&amp; (sess-&gt;last_file_modif == modif_time) &amp;&amp; sess-&gt;path &amp;&amp; full_path &amp;&amp; !strcmp(sess-&gt;path, full_path) ) {</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :                 gf_free(full_path);</span>
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :                 sess-&gt;file_pos = 0;</span>
<span class="lineNum">     998 </span>            :         }
<span class="lineNum">     999 </span>            :         else {
<span class="lineNum">    1000 </span><span class="lineCov">        185 :                 if (sess-&gt;path) gf_free(sess-&gt;path);</span>
<span class="lineNum">    1001 </span><span class="lineCov">        185 :                 if (source_pid) {</span>
<span class="lineNum">    1002 </span>            :                         //source_pid-&gt;resource may be NULL at this point (PID created but no data written yet), typically happens on manifest PIDs or init segments
<span class="lineNum">    1003 </span><span class="lineCov">         21 :                         sess-&gt;in_source = source_pid;</span>
<span class="lineNum">    1004 </span><span class="lineCov">         21 :                         source_pid-&gt;nb_dest++;</span>
<span class="lineNum">    1005 </span><span class="lineCov">         21 :                         source_pid-&gt;hold = GF_FALSE;</span>
<span class="lineNum">    1006 </span><span class="lineCov">         21 :                         sess-&gt;send_init_data = GF_TRUE;</span>
<span class="lineNum">    1007 </span><span class="lineCov">         21 :                         sess-&gt;in_source_is_ll_hls_chunk = source_pid_is_ll_hls_chunk;</span>
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span><span class="lineCov">         21 :                         sess-&gt;file_in_progress = GF_TRUE;</span>
<span class="lineNum">    1010 </span>            :                         assert(!full_path);
<span class="lineNum">    1011 </span>            :                         assert(source_pid-&gt;local_path);
<span class="lineNum">    1012 </span><span class="lineCov">         21 :                         if (source_pid_is_ll_hls_chunk)</span>
<span class="lineNum">    1013 </span><span class="lineCov">          1 :                                 full_path = gf_strdup(source_pid-&gt;hls_chunk_local_path);</span>
<span class="lineNum">    1014 </span>            :                         else
<span class="lineNum">    1015 </span><span class="lineCov">         20 :                                 full_path = gf_strdup(source_pid-&gt;local_path);</span>
<span class="lineNum">    1016 </span><span class="lineCov">         21 :                         sess-&gt;use_chunk_transfer = GF_TRUE;</span>
<span class="lineNum">    1017 </span><span class="lineCov">         21 :                         sess-&gt;file_size = 0;</span>
<span class="lineNum">    1018 </span>            :                 }
<span class="lineNum">    1019 </span><span class="lineCov">        185 :                 sess-&gt;path = full_path;</span>
<span class="lineNum">    1020 </span><span class="lineCov">        185 :                 if (!full_path || gf_dir_exists(full_path)) {</span>
<span class="lineNum">    1021 </span><span class="lineCov">          4 :                         if (sess-&gt;ctx-&gt;dlist) {</span>
<span class="lineNum">    1022 </span>            :                                 range = NULL;
<span class="lineNum">    1023 </span><span class="lineCov">          2 :                                 if (!strcmp(url, &quot;/&quot;)) {</span>
<span class="lineNum">    1024 </span><span class="lineCov">          1 :                                         response_body = httpout_create_listing(sess-&gt;ctx, (char *) url);</span>
<span class="lineNum">    1025 </span>            :                                 } else {
<span class="lineNum">    1026 </span><span class="lineCov">          1 :                                         response_body = httpout_create_listing(sess-&gt;ctx, full_path);</span>
<span class="lineNum">    1027 </span>            :                                 }
<span class="lineNum">    1028 </span><span class="lineCov">          2 :                                 sess-&gt;file_size = sess-&gt;file_pos = 0;</span>
<span class="lineNum">    1029 </span>            :                         } else {
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :                                 sess-&gt;reply_code = 403;</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;response_body, &quot;Directory browsing is not allowed&quot;, NULL);</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :                                 goto exit;</span>
<span class="lineNum">    1033 </span>            :                         }
<span class="lineNum">    1034 </span>            :                 } else {
<span class="lineNum">    1035 </span><span class="lineCov">        183 :                         sess-&gt;resource = gf_fopen(full_path, &quot;rb&quot;);</span>
<span class="lineNum">    1036 </span>            :                         //we may not have the file if it is currently being created
<span class="lineNum">    1037 </span><span class="lineCov">        183 :                         if (!sess-&gt;resource &amp;&amp; !sess-&gt;in_source) {</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :                                 sess-&gt;reply_code = 500;</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :                                 gf_dynstrcat(&amp;response_body, &quot;File exists but no read access&quot;, NULL);</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :                                 goto exit;</span>
<span class="lineNum">    1041 </span>            :                         }
<span class="lineNum">    1042 </span>            :                         //warning, sess-&gt;resource may still be NULL here !
<span class="lineNum">    1043 </span>            : 
<span class="lineNum">    1044 </span><span class="lineCov">        183 :                         mime = source_pid ? source_pid-&gt;mime : NULL;</span>
<span class="lineNum">    1045 </span>            :                         //probe for mime
<span class="lineNum">    1046 </span><span class="lineCov">         21 :                         if (!mime &amp;&amp; sess-&gt;resource) {</span>
<span class="lineNum">    1047 </span>            :                                 u8 probe_buf[5001];
<span class="lineNum">    1048 </span><span class="lineCov">        162 :                                 u32 read = (u32) gf_fread(probe_buf, 5000, sess-&gt;resource);</span>
<span class="lineNum">    1049 </span><span class="lineCov">        162 :                                 if ((s32) read &lt; 0) {</span>
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :                                         if (source_sess) {</span>
<span class="lineNum">    1051 </span>            :                                                 read = 0;
<span class="lineNum">    1052 </span>            :                                         } else {
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :                                                 sess-&gt;reply_code = 500;</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :                                                 gf_dynstrcat(&amp;response_body, &quot;File opened but read operation failed&quot;, NULL);</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :                                                 goto exit;</span>
<span class="lineNum">    1056 </span>            :                                         }
<span class="lineNum">    1057 </span>            :                                 }
<span class="lineNum">    1058 </span><span class="lineCov">        162 :                                 if (read) {</span>
<span class="lineNum">    1059 </span><span class="lineCov">        162 :                                         probe_buf[read] = 0;</span>
<span class="lineNum">    1060 </span><span class="lineCov">        162 :                                         mime = gf_filter_probe_data(sess-&gt;ctx-&gt;filter, probe_buf, read);</span>
<span class="lineNum">    1061 </span>            :                                 }
<span class="lineNum">    1062 </span>            :                         }
<span class="lineNum">    1063 </span><span class="lineCov">        183 :                         if (source_sess) {</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :                                 sess-&gt;file_size = 0;</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :                                 sess-&gt;use_chunk_transfer = GF_TRUE;</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :                                 sess-&gt;put_in_progress = 1;</span>
<span class="lineNum">    1067 </span><span class="lineCov">        183 :                         } else if (sess-&gt;resource) {</span>
<span class="lineNum">    1068 </span>            :                                 //get file size, might be incomplete if file writing is in progress
<span class="lineNum">    1069 </span><span class="lineCov">        183 :                                 sess-&gt;file_size = gf_fsize(sess-&gt;resource);</span>
<span class="lineNum">    1070 </span>            :                         } else {
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :                                 sess-&gt;file_size = 0;</span>
<span class="lineNum">    1072 </span>            :                         }
<span class="lineNum">    1073 </span>            :                 }
<span class="lineNum">    1074 </span><span class="lineCov">        185 :                 sess-&gt;file_pos = 0;</span>
<span class="lineNum">    1075 </span><span class="lineCov">        185 :                 sess-&gt;bytes_in_req = sess-&gt;file_size;</span>
<span class="lineNum">    1076 </span>            : 
<span class="lineNum">    1077 </span><span class="lineCov">        185 :                 if (sess-&gt;mime) gf_free(sess-&gt;mime);</span>
<span class="lineNum">    1078 </span><span class="lineCov">        185 :                 sess-&gt;mime = ( mime &amp;&amp; strcmp(mime, &quot;*&quot;)) ? gf_strdup(mime) : NULL;</span>
<span class="lineNum">    1079 </span><span class="lineCov">        185 :                 sess-&gt;last_file_modif = gf_file_modification_time(full_path);</span>
<span class="lineNum">    1080 </span>            :         }
<span class="lineNum">    1081 </span>            : 
<span class="lineNum">    1082 </span>            :         //parse byte range except if associated input in single mode where byte ranges are ignored
<span class="lineNum">    1083 </span><span class="lineCov">        188 :         if ( (!sess-&gt;in_source || !sess-&gt;ctx-&gt;single_mode) &amp;&amp; ! httpout_sess_parse_range(sess, (char *) range) ) {</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_WARNING, GF_LOG_HTTP, (&quot;[HTTPOut] Unsupported Range format: %s\n&quot;, range));</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :                 sess-&gt;reply_code = 416;</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :                 gf_dynstrcat(&amp;response_body, &quot;Range format is not supported, only \&quot;bytes\&quot; units allowed: &quot;, NULL);</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :                 gf_dynstrcat(&amp;response_body, range, NULL);</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :                 goto exit;</span>
<span class="lineNum">    1089 </span>            :         }
<span class="lineNum">    1090 </span>            : 
<span class="lineNum">    1091 </span><span class="lineCov">        188 :         if (not_modified) {</span>
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :                 sess-&gt;reply_code = 304;</span>
<span class="lineNum">    1093 </span><span class="lineCov">        188 :         } else if (sess-&gt;nb_ranges) {</span>
<span class="lineNum">    1094 </span><span class="lineCov">         30 :                 sess-&gt;reply_code = 206;</span>
<span class="lineNum">    1095 </span><span class="lineCov">        158 :         } else if ((parameter-&gt;reply==GF_HTTP_DELETE) &amp;&amp; (e==GF_URL_ERROR)) {</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :                 sess-&gt;reply_code = 204;</span>
<span class="lineNum">    1097 </span>            :         } else {
<span class="lineNum">    1098 </span><span class="lineCov">        158 :                 sess-&gt;reply_code = 200;</span>
<span class="lineNum">    1099 </span>            :         }
<span class="lineNum">    1100 </span>            : 
<span class="lineNum">    1101 </span><span class="lineCov">        188 :         gf_dm_sess_clear_headers(sess-&gt;http_sess);</span>
<span class="lineNum">    1102 </span>            : 
<span class="lineNum">    1103 </span><span class="lineCov">        188 :         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Server&quot;, sess-&gt;ctx-&gt;user_agent);</span>
<span class="lineNum">    1104 </span>            : 
<span class="lineNum">    1105 </span><span class="lineCov">        188 :         httpout_format_date(gf_net_get_utc(), szDate, GF_FALSE);</span>
<span class="lineNum">    1106 </span><span class="lineCov">        188 :         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Date&quot;, szDate);</span>
<span class="lineNum">    1107 </span>            : 
<span class="lineNum">    1108 </span><span class="lineCov">        188 :         if (send_cors) {</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Access-Control-Expose-Headers&quot;, &quot;*&quot;);</span>
<span class="lineNum">    1111 </span>            :         }
<span class="lineNum">    1112 </span><span class="lineCov">        188 :         if (sess-&gt;ctx-&gt;sutc) {</span>
<span class="lineNum">    1113 </span><span class="lineCov">          5 :                 sprintf(szFmt, LLU, gf_net_get_utc() );</span>
<span class="lineNum">    1114 </span><span class="lineCov">          5 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Server-UTC&quot;, szFmt);</span>
<span class="lineNum">    1115 </span>            :         }
<span class="lineNum">    1116 </span>            : 
<span class="lineNum">    1117 </span><span class="lineCov">        188 :         if (parameter-&gt;reply == GF_HTTP_HEAD) {</span>
<span class="lineNum">    1118 </span>            :                 is_head = GF_TRUE;
<span class="lineNum">    1119 </span>            :                 no_body = GF_TRUE;
<span class="lineNum">    1120 </span>            :         }
<span class="lineNum">    1121 </span>            : 
<span class="lineNum">    1122 </span><span class="lineCov">        188 :         if (sess-&gt;ctx-&gt;close) {</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Connection&quot;, &quot;close&quot;);</span>
<span class="lineNum">    1124 </span>            :         } else {
<span class="lineNum">    1125 </span><span class="lineCov">        188 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Connection&quot;, &quot;keep-alive&quot;);</span>
<span class="lineNum">    1126 </span><span class="lineCov">        188 :                 if (sess-&gt;ctx-&gt;timeout) {</span>
<span class="lineNum">    1127 </span>            :                         sprintf(szFmt, &quot;timeout=%d&quot;, sess-&gt;ctx-&gt;timeout);
<span class="lineNum">    1128 </span><span class="lineCov">        188 :                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Keep-Alive&quot;, szFmt);</span>
<span class="lineNum">    1129 </span>            :                 }
<span class="lineNum">    1130 </span>            :         }
<span class="lineNum">    1131 </span>            : 
<span class="lineNum">    1132 </span><span class="lineCov">        188 :         if (response_body) {</span>
<span class="lineNum">    1133 </span><span class="lineCov">          2 :                 body_size = (u32) strlen(response_body);</span>
<span class="lineNum">    1134 </span><span class="lineCov">          2 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Content-Type&quot;, &quot;text/html&quot;);</span>
<span class="lineNum">    1135 </span>            :                 sprintf(szFmt, &quot;%d&quot;, body_size);
<span class="lineNum">    1136 </span><span class="lineCov">          2 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Content-Length&quot;, szFmt);</span>
<span class="lineNum">    1137 </span>            :         }
<span class="lineNum">    1138 </span>            :         //for HEAD/GET only
<span class="lineNum">    1139 </span><span class="lineCov">        186 :         else if (!not_modified &amp;&amp; (parameter-&gt;reply!=GF_HTTP_DELETE) ) {</span>
<span class="lineNum">    1140 </span><span class="lineCov">        184 :                 if (!sess-&gt;in_source &amp;&amp; !sess-&gt;ctx-&gt;no_etag &amp;&amp; szETag[0]) {</span>
<span class="lineNum">    1141 </span><span class="lineCov">        162 :                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;ETag&quot;, szETag);</span>
<span class="lineNum">    1142 </span><span class="lineCov">        162 :                         if (sess-&gt;ctx-&gt;cache_control) {</span>
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :                                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Cache-Control&quot;, sess-&gt;ctx-&gt;cache_control);</span>
<span class="lineNum">    1144 </span>            :                         }
<span class="lineNum">    1145 </span><span class="lineCov">         22 :                 } else if (sess-&gt;in_source &amp;&amp; !sess-&gt;ctx-&gt;rdirs.nb_items) {</span>
<span class="lineNum">    1146 </span><span class="lineCov">          1 :                         sess-&gt;nb_ranges = 0;</span>
<span class="lineNum">    1147 </span><span class="lineCov">          1 :                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Cache-Control&quot;, &quot;no-cache, no-store&quot;);</span>
<span class="lineNum">    1148 </span>            :                 }
<span class="lineNum">    1149 </span>            :                 //only put content length if not using chunk transfer - bytes_in_req may be &gt; 0 if we have a byte range on a chunk-transfer session
<span class="lineNum">    1150 </span><span class="lineCov">        184 :                 if (sess-&gt;bytes_in_req &amp;&amp; !sess-&gt;use_chunk_transfer) {</span>
<span class="lineNum">    1151 </span>            :                         sprintf(szFmt, LLU, sess-&gt;bytes_in_req);
<span class="lineNum">    1152 </span><span class="lineCov">        162 :                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Content-Length&quot;, szFmt);</span>
<span class="lineNum">    1153 </span>            :                 }
<span class="lineNum">    1154 </span><span class="lineCov">        184 :                 mime = sess-&gt;in_source ? sess-&gt;in_source-&gt;mime : mime;</span>
<span class="lineNum">    1155 </span><span class="lineCov">        184 :                 if (mime &amp;&amp; !strcmp(mime, &quot;*&quot;)) mime = NULL;</span>
<span class="lineNum">    1156 </span><span class="lineCov">        164 :                 if (mime) {</span>
<span class="lineNum">    1157 </span><span class="lineCov">          2 :                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Content-Type&quot;, mime);</span>
<span class="lineNum">    1158 </span>            :                 }
<span class="lineNum">    1159 </span>            :                 //data comes either directly from source pid, or from file written by source pid, we must use chunk transfer
<span class="lineNum">    1160 </span><span class="lineCov">        184 :                 if (!is_head &amp;&amp; sess-&gt;use_chunk_transfer) {</span>
<span class="lineNum">    1161 </span><span class="lineCov">         22 :                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Transfer-Encoding&quot;, &quot;chunked&quot;);</span>
<span class="lineNum">    1162 </span>            :                 }
<span class="lineNum">    1163 </span>            : 
<span class="lineNum">    1164 </span><span class="lineCov">        184 :                 if (!is_head &amp;&amp; sess-&gt;nb_ranges) {</span>
<span class="lineNum">    1165 </span><span class="lineCov">         30 :                         char *ranges = NULL;</span>
<span class="lineNum">    1166 </span><span class="lineCov">         30 :                         gf_dynstrcat(&amp;ranges, &quot;bytes=&quot;, NULL);</span>
<span class="lineNum">    1167 </span><span class="lineCov">         60 :                         for (i=0; i&lt;sess-&gt;nb_ranges; i++) {</span>
<span class="lineNum">    1168 </span><span class="lineCov">         30 :                                 if (sess-&gt;in_source || !sess-&gt;file_size) {</span>
<span class="lineNum">    1169 </span><span class="lineCov">          1 :                                         sprintf(szFmt, LLD&quot;-&quot;LLD&quot;/*&quot;, sess-&gt;ranges[i].start, sess-&gt;ranges[i].end);</span>
<span class="lineNum">    1170 </span>            :                                 } else {
<span class="lineNum">    1171 </span><span class="lineCov">         29 :                                         sprintf(szFmt, LLD&quot;-&quot;LLD&quot;/&quot;LLU, sess-&gt;ranges[i].start, sess-&gt;ranges[i].end, sess-&gt;file_size);</span>
<span class="lineNum">    1172 </span>            :                                 }
<span class="lineNum">    1173 </span><span class="lineCov">         30 :                                 gf_dynstrcat(&amp;ranges, szFmt, i ? &quot;, &quot; : NULL);</span>
<span class="lineNum">    1174 </span>            :                         }
<span class="lineNum">    1175 </span><span class="lineCov">         30 :                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Content-Range&quot;, ranges);</span>
<span class="lineNum">    1176 </span><span class="lineCov">         30 :                         gf_free(ranges);</span>
<span class="lineNum">    1177 </span>            :                 }
<span class="lineNum">    1178 </span>            : 
<span class="lineNum">    1179 </span><span class="lineCov">        184 :                 if (sess-&gt;in_source &amp;&amp; sess-&gt;ctx-&gt;ice) {</span>
<span class="lineNum">    1180 </span>            :                         const GF_PropertyValue *p;
<span class="lineNum">    1181 </span>            :                         u32 sr=0, br=0, nb_ch=0, p_idx;
<span class="lineNum">    1182 </span>            :                         u32 w=0, h=0;
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(sess-&gt;in_source-&gt;ipid, GF_PROP_PID_SAMPLE_RATE);</span>
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 :                         if (p) sr = p-&gt;value.uint;</span>
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(sess-&gt;in_source-&gt;ipid, GF_PROP_PID_NUM_CHANNELS);</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :                         if (p) nb_ch = p-&gt;value.uint;</span>
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(sess-&gt;in_source-&gt;ipid, GF_PROP_PID_BITRATE);</span>
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :                         if (p) br = p-&gt;value.uint;</span>
<span class="lineNum">    1189 </span>            : 
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(sess-&gt;in_source-&gt;ipid, GF_PROP_PID_WIDTH);</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :                         if (p) w = p-&gt;value.uint;</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(sess-&gt;in_source-&gt;ipid, GF_PROP_PID_HEIGHT);</span>
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :                         if (p) h = p-&gt;value.uint;</span>
<span class="lineNum">    1194 </span>            : 
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :                         if (sr || br || nb_ch) {</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :                                 if (sr &amp;&amp; br &amp;&amp; nb_ch)</span>
<span class="lineNum">    1197 </span>            :                                         sprintf(szFmt, &quot;samplerate=%d;channels=%d;bitrate=%d&quot;, sr, nb_ch, br);
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :                                 else if (sr &amp;&amp; nb_ch)</span>
<span class="lineNum">    1199 </span>            :                                         sprintf(szFmt, &quot;samplerate=%d;channels=%d&quot;, sr, nb_ch);
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :                                 else if (sr &amp;&amp; br)</span>
<span class="lineNum">    1201 </span>            :                                         sprintf(szFmt, &quot;samplerate=%d;bitrate=%d&quot;, sr, br);
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :                                 else if (nb_ch &amp;&amp; br)</span>
<span class="lineNum">    1203 </span>            :                                         sprintf(szFmt, &quot;channels=%d;bitrate=%d&quot;, nb_ch, br);
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :                                 else if (nb_ch)</span>
<span class="lineNum">    1205 </span>            :                                         sprintf(szFmt, &quot;channels=%d&quot;, nb_ch);
<span class="lineNum">    1206 </span>            :                                 else
<span class="lineNum">    1207 </span>            :                                         sprintf(szFmt, &quot;bitrate=%d&quot;, br);
<span class="lineNum">    1208 </span>            : 
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :                                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;ice-audio-info&quot;, szFmt);</span>
<span class="lineNum">    1210 </span>            :                         }
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :                         if (w &amp;&amp; h) {</span>
<span class="lineNum">    1212 </span>            :                                 sprintf(szFmt, &quot;width=%d;height=%d&quot;, w, h);
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :                                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;ice-video-info&quot;, szFmt);</span>
<span class="lineNum">    1214 </span>            :                         }
<span class="lineNum">    1215 </span>            : 
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                         if (br) {</span>
<span class="lineNum">    1217 </span>            :                                 sprintf(szFmt, &quot;%d&quot;, br);
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :                                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;icy-br&quot;, szFmt);</span>
<span class="lineNum">    1219 </span>            :                         }
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;icy-pub&quot;, &quot;1&quot;);</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(sess-&gt;in_source-&gt;ipid, GF_PROP_PID_SERVICE_NAME);</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :                         if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :                                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;icy-name&quot;, p-&gt;value.string);</span>
<span class="lineNum">    1224 </span>            :                         }
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :                         p_idx = 0;</span>
<span class="lineNum">    1226 </span>            :                         while (1) {
<span class="lineNum">    1227 </span>            :                                 const char *pname;
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :                                 p = gf_filter_pid_enum_properties(sess-&gt;in_source-&gt;ipid, &amp;p_idx, NULL, &amp;pname);</span>
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :                                 if (!p) break;</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :                                 if (!pname || strncmp(pname, &quot;ice-&quot;, 4)) continue;</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :                                 if (!p-&gt;value.string) continue;</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :                                 gf_dm_sess_set_header(sess-&gt;http_sess, pname, p-&gt;value.string);</span>
<span class="lineNum">    1233 </span>            :                         }
<span class="lineNum">    1234 </span>            :                 }
<span class="lineNum">    1235 </span>            :         }
<span class="lineNum">    1236 </span>            : 
<span class="lineNum">    1237 </span><span class="lineCov">        188 :         GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Sending response to %s\n&quot;, sess-&gt;peer_address));</span>
<span class="lineNum">    1238 </span>            : 
<span class="lineNum">    1239 </span><span class="lineCov">        188 :         if (sess-&gt;do_log) {</span>
<span class="lineNum">    1240 </span><span class="lineCov">        153 :                 sess-&gt;req_id = ++sess-&gt;ctx-&gt;req_id;</span>
<span class="lineNum">    1241 </span><span class="lineCov">        153 :                 sess-&gt;method_type = parameter-&gt;reply;</span>
<span class="lineNum">    1242 </span><span class="lineCov">        153 :                 sess-&gt;req_start_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    1243 </span><span class="lineCov">        153 :                 if (not_modified) {</span>
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] REQ#&quot;LLU&quot; %s %s %s: reply %d\n&quot;, sess-&gt;req_id, sess-&gt;peer_address, get_method_name(sess-&gt;method_type), url+1, sess-&gt;reply_code));</span>
<span class="lineNum">    1245 </span><span class="lineCov">        153 :                 } else if (range) {</span>
<span class="lineNum">    1246 </span><span class="lineCov">         11 :                         GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] REQ#&quot;LLU&quot; %s %s %s [range: %s] start%s\n&quot;, sess-&gt;req_id, sess-&gt;peer_address, get_method_name(sess-&gt;method_type), url+1, range, sess-&gt;use_chunk_transfer ? &quot; chunk-transfer&quot; : &quot;&quot;));</span>
<span class="lineNum">    1247 </span>            :                 } else {
<span class="lineNum">    1248 </span><span class="lineCov">        142 :                         GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] REQ#&quot;LLU&quot; %s %s %s start%s\n&quot;, sess-&gt;req_id, sess-&gt;peer_address, get_method_name(sess-&gt;method_type), url+1, sess-&gt;use_chunk_transfer ? &quot; chunk-transfer&quot; : &quot;&quot;));</span>
<span class="lineNum">    1249 </span>            :                 }
<span class="lineNum">    1250 </span>            :         }
<span class="lineNum">    1251 </span>            : 
<span class="lineNum">    1252 </span><span class="lineCov">        188 :         sess-&gt;nb_consecutive_errors = 0;</span>
<span class="lineNum">    1253 </span><span class="lineCov">        188 :         sess-&gt;canceled = GF_FALSE;</span>
<span class="lineNum">    1254 </span><span class="lineCov">        188 :         e = gf_dm_sess_send_reply(sess-&gt;http_sess, sess-&gt;reply_code, response_body, no_body);</span>
<span class="lineNum">    1255 </span><span class="lineCov">        188 :         sess-&gt;headers_done = GF_TRUE;</span>
<span class="lineNum">    1256 </span><span class="lineCov">        188 :         sess-&gt;is_h2 = gf_dm_sess_is_h2(sess-&gt;http_sess);</span>
<span class="lineNum">    1257 </span>            : 
<span class="lineNum">    1258 </span><span class="lineCov">        188 :         if (url) gf_free(url);</span>
<span class="lineNum">    1259 </span><span class="lineCov">        188 :         if (!sess-&gt;buffer) {</span>
<span class="lineNum">    1260 </span><span class="lineCov">         35 :                 sess-&gt;buffer = gf_malloc(sizeof(u8)*sess-&gt;ctx-&gt;block_size);</span>
<span class="lineNum">    1261 </span>            :         }
<span class="lineNum">    1262 </span><span class="lineCov">        188 :         if (response_body) {</span>
<span class="lineNum">    1263 </span><span class="lineCov">          2 :                 gf_free(response_body);</span>
<span class="lineNum">    1264 </span><span class="lineCov">          2 :                 sess-&gt;done = GF_TRUE;</span>
<span class="lineNum">    1265 </span><span class="lineCov">        186 :         } else if (parameter-&gt;reply == GF_HTTP_DELETE) {</span>
<span class="lineNum">    1266 </span><span class="lineCov">          2 :                 sess-&gt;done = GF_TRUE;</span>
<span class="lineNum">    1267 </span><span class="lineCov">        184 :         } else if (parameter-&gt;reply == GF_HTTP_HEAD) {</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :                 sess-&gt;done = GF_FALSE;</span>
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :                 sess-&gt;file_pos = sess-&gt;file_size;</span>
<span class="lineNum">    1270 </span>            :         } else {
<span class="lineNum">    1271 </span><span class="lineCov">        184 :                 sess-&gt;done = GF_FALSE;</span>
<span class="lineNum">    1272 </span><span class="lineCov">        184 :                 if (gf_list_find(sess-&gt;ctx-&gt;active_sessions, sess)&lt;0) {</span>
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :                         gf_list_add(sess-&gt;ctx-&gt;active_sessions, sess);</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :                         gf_sk_group_register(sess-&gt;ctx-&gt;sg, sess-&gt;socket);</span>
<span class="lineNum">    1275 </span>            :                 }
<span class="lineNum">    1276 </span><span class="lineCov">        184 :                 if (not_modified) {</span>
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :                         sess-&gt;done = GF_TRUE;</span>
<span class="lineNum">    1278 </span>            :                 }
<span class="lineNum">    1279 </span>            :         }
<span class="lineNum">    1280 </span>            : 
<span class="lineNum">    1281 </span><span class="lineCov">        188 :         if (e&lt;0) {</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Error sending reply: %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :                 sess-&gt;done = GF_TRUE;</span>
<span class="lineNum">    1284 </span>            :         }
<span class="lineNum">    1285 </span>            : 
<span class="lineNum">    1286 </span><span class="lineCov">        188 :         if (sess-&gt;done)</span>
<span class="lineNum">    1287 </span><span class="lineCov">          4 :                 sess-&gt;headers_done = GF_FALSE;</span>
<span class="lineNum">    1288 </span>            : 
<span class="lineNum">    1289 </span><span class="lineCov">        188 :         gf_dm_sess_clear_headers(sess-&gt;http_sess);</span>
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span><span class="lineCov">        188 :         sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    1292 </span><span class="lineCov">        188 :         return;</span>
<span class="lineNum">    1293 </span>            : 
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 : exit:</span>
<span class="lineNum">    1295 </span>            : 
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :         gf_dm_sess_clear_headers(sess-&gt;http_sess);</span>
<span class="lineNum">    1297 </span>            : 
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Server&quot;, sess-&gt;ctx-&gt;user_agent);</span>
<span class="lineNum">    1299 </span>            : 
<span class="lineNum">    1300 </span><span class="lineNoCov">          0 :         httpout_format_date(gf_net_get_utc(), szDate, GF_FALSE);</span>
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Date&quot;, szDate);</span>
<span class="lineNum">    1302 </span>            : 
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :         sess-&gt;nb_consecutive_errors++;</span>
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :         if (sess-&gt;nb_consecutive_errors == sess-&gt;ctx-&gt;max_client_errors) {</span>
<span class="lineNum">    1305 </span><span class="lineNoCov">          0 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Connection&quot;, &quot;close&quot;);</span>
<span class="lineNum">    1306 </span>            :         } else {
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :                 sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    1308 </span>            :         }
<span class="lineNum">    1309 </span>            : 
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :         if (send_cors) {</span>
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Access-Control-Expose-Headers&quot;, &quot;*&quot;);</span>
<span class="lineNum">    1313 </span>            :         }
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :         if (response_body) {</span>
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :                 body_size = (u32) strlen(response_body);</span>
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Content-Type&quot;, &quot;text/plain&quot;);</span>
<span class="lineNum">    1317 </span>            :                 sprintf(szFmt, &quot;%d&quot;, body_size);
<span class="lineNum">    1318 </span><span class="lineNoCov">          0 :                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Content-Length&quot;, szFmt);</span>
<span class="lineNum">    1319 </span>            :         }
<span class="lineNum">    1320 </span>            : 
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :         gf_dm_sess_send_reply(sess-&gt;http_sess, sess-&gt;reply_code, response_body, GF_FALSE);</span>
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :         sess-&gt;is_h2 = gf_dm_sess_is_h2(sess-&gt;http_sess);</span>
<span class="lineNum">    1323 </span>            : 
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :         if (response_body) gf_free(response_body);</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :         gf_dm_sess_clear_headers(sess-&gt;http_sess);</span>
<span class="lineNum">    1326 </span>            : 
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :         if (sess-&gt;do_log) {</span>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :                 sess-&gt;req_id = ++sess-&gt;ctx-&gt;req_id;</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_WARNING, GF_LOG_ALL, (&quot;[HTTPOut] REQ#&quot;LLU&quot; %s %s %s error %d\n&quot;, sess-&gt;req_id, sess-&gt;peer_address, get_method_name(parameter-&gt;reply), url+1, sess-&gt;reply_code));</span>
<span class="lineNum">    1330 </span>            :         }
<span class="lineNum">    1331 </span>            : 
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :         if (url) gf_free(url);</span>
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :         sess-&gt;upload_type = 0;</span>
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :         sess-&gt;done = GF_TRUE;</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :         sess-&gt;canceled = GF_FALSE;</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :         sess-&gt;headers_done = GF_FALSE;</span>
<span class="lineNum">    1337 </span>            : 
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :         if (!sess-&gt;is_h2 &amp;&amp; (sess-&gt;ctx-&gt;close || (sess-&gt;nb_consecutive_errors == sess-&gt;ctx-&gt;max_client_errors))) {</span>
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :                 sess-&gt;force_destroy = GF_TRUE;</span>
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :         } else if (sess-&gt;http_sess) {</span>
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :                 gf_dm_sess_server_reset(sess-&gt;http_sess);</span>
<span class="lineNum">    1342 </span>            :         }
<span class="lineNum">    1343 </span>            :         return;
<span class="lineNum">    1344 </span>            : }
<span class="lineNum">    1345 </span>            : 
<span class="lineNum">    1346 </span>            : enum
<span class="lineNum">    1347 </span>            : {
<span class="lineNum">    1348 </span>            :         HTTP_PUT_HEADER_ENCODING=0,
<span class="lineNum">    1349 </span>            :         HTTP_PUT_HEADER_MIME,
<span class="lineNum">    1350 </span>            :         HTTP_PUT_HEADER_RANGE,
<span class="lineNum">    1351 </span>            :         HTTP_PUT_HEADER_DONE
<a name="1352"><span class="lineNum">    1352 </span>            : };</a>
<span class="lineNum">    1353 </span>            : 
<span class="lineNum">    1354 </span><span class="lineCov">        362 : static void httpout_in_io(void *usr_cbk, GF_NETIO_Parameter *parameter)</span>
<span class="lineNum">    1355 </span>            : {
<span class="lineNum">    1356 </span>            :         GF_HTTPOutInput *in =usr_cbk;
<span class="lineNum">    1357 </span>            : 
<span class="lineNum">    1358 </span><span class="lineCov">        362 :         if (parameter-&gt;msg_type==GF_NETIO_GET_METHOD) {</span>
<span class="lineNum">    1359 </span><span class="lineCov">         30 :                 if (in-&gt;is_delete)</span>
<span class="lineNum">    1360 </span><span class="lineCov">          2 :                         parameter-&gt;name = &quot;DELETE&quot;;</span>
<span class="lineNum">    1361 </span>            :                 else
<span class="lineNum">    1362 </span><span class="lineCov">         28 :                         parameter-&gt;name = in-&gt;ctx-&gt;post ? &quot;POST&quot; : &quot;PUT&quot;;</span>
<span class="lineNum">    1363 </span><span class="lineCov">         30 :                 in-&gt;cur_header = HTTP_PUT_HEADER_ENCODING;</span>
<span class="lineNum">    1364 </span><span class="lineCov">         30 :                 return;</span>
<span class="lineNum">    1365 </span>            :         }
<span class="lineNum">    1366 </span><span class="lineCov">        332 :         if (parameter-&gt;msg_type==GF_NETIO_GET_HEADER) {</span>
<span class="lineNum">    1367 </span><span class="lineCov">         86 :                 parameter-&gt;name = parameter-&gt;value = NULL;</span>
<span class="lineNum">    1368 </span>            : 
<span class="lineNum">    1369 </span><span class="lineCov">         86 :                 if (in-&gt;is_delete) return;</span>
<span class="lineNum">    1370 </span>            : 
<span class="lineNum">    1371 </span><span class="lineCov">         84 :                 switch (in-&gt;cur_header) {</span>
<span class="lineNum">    1372 </span><span class="lineCov">         28 :                 case HTTP_PUT_HEADER_ENCODING:</span>
<span class="lineNum">    1373 </span><span class="lineCov">         28 :                         parameter-&gt;name = &quot;Transfer-Encoding&quot;;</span>
<span class="lineNum">    1374 </span><span class="lineCov">         28 :                         parameter-&gt;value = &quot;chunked&quot;;</span>
<span class="lineNum">    1375 </span><span class="lineCov">         28 :                         if (in-&gt;mime)</span>
<span class="lineNum">    1376 </span><span class="lineCov">         28 :                                 in-&gt;cur_header = HTTP_PUT_HEADER_MIME;</span>
<span class="lineNum">    1377 </span>            :                         else
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :                                 in-&gt;cur_header = in-&gt;write_start_range ? HTTP_PUT_HEADER_RANGE : HTTP_PUT_HEADER_DONE;</span>
<span class="lineNum">    1379 </span>            :                         break;
<span class="lineNum">    1380 </span><span class="lineCov">         28 :                 case HTTP_PUT_HEADER_MIME:</span>
<span class="lineNum">    1381 </span><span class="lineCov">         28 :                         parameter-&gt;name = &quot;Content-Type&quot;;</span>
<span class="lineNum">    1382 </span><span class="lineCov">         28 :                         parameter-&gt;value = in-&gt;mime;</span>
<span class="lineNum">    1383 </span><span class="lineCov">         28 :                         in-&gt;cur_header = HTTP_PUT_HEADER_DONE;</span>
<span class="lineNum">    1384 </span><span class="lineCov">         28 :                         if (in-&gt;write_start_range)</span>
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :                                 in-&gt;cur_header = HTTP_PUT_HEADER_RANGE;</span>
<span class="lineNum">    1386 </span>            :                         break;
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :                 case HTTP_PUT_HEADER_RANGE:</span>
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :                         parameter-&gt;name = &quot;Range&quot;;</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :                         if (in-&gt;write_end_range) {</span>
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :                                 sprintf(in-&gt;range_hdr, &quot;bytes=&quot;LLU&quot;-&quot;LLU, in-&gt;write_start_range, in-&gt;write_end_range);</span>
<span class="lineNum">    1391 </span>            :                         } else {
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :                                 sprintf(in-&gt;range_hdr, &quot;bytes=&quot;LLU&quot;-&quot;, in-&gt;write_start_range);</span>
<span class="lineNum">    1393 </span>            :                         }
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :                         parameter-&gt;value = in-&gt;range_hdr;</span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :                         in-&gt;cur_header = HTTP_PUT_HEADER_DONE;</span>
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1397 </span>            :                 default:
<span class="lineNum">    1398 </span>            :                         parameter-&gt;name = NULL;
<span class="lineNum">    1399 </span>            :                         parameter-&gt;value = NULL;
<span class="lineNum">    1400 </span>            :                         break;
<span class="lineNum">    1401 </span>            :                 }
<span class="lineNum">    1402 </span><span class="lineCov">        246 :         }</span>
<a name="1403"><span class="lineNum">    1403 </span>            : }</a>
<span class="lineNum">    1404 </span>            : 
<span class="lineNum">    1405 </span><span class="lineCov">         40 : static GF_Err httpout_configure_pid(GF_Filter *filter, GF_FilterPid *pid, Bool is_remove)</span>
<span class="lineNum">    1406 </span>            : {
<span class="lineNum">    1407 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">    1408 </span>            :         GF_HTTPOutInput *pctx;
<span class="lineNum">    1409 </span><span class="lineCov">         40 :         GF_HTTPOutCtx *ctx = (GF_HTTPOutCtx *) gf_filter_get_udta(filter);</span>
<span class="lineNum">    1410 </span>            : 
<span class="lineNum">    1411 </span><span class="lineCov">         40 :         if (!is_remove) {</span>
<span class="lineNum">    1412 </span><span class="lineCov">         40 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_STREAM_TYPE);</span>
<span class="lineNum">    1413 </span><span class="lineCov">         40 :                 if (!p || (p-&gt;value.uint!=GF_STREAM_FILE))</span>
<span class="lineNum">    1414 </span>            :                         return GF_NOT_SUPPORTED;
<span class="lineNum">    1415 </span>            :         }
<span class="lineNum">    1416 </span>            : 
<span class="lineNum">    1417 </span><span class="lineCov">         40 :         pctx = gf_filter_pid_get_udta(pid);</span>
<span class="lineNum">    1418 </span><span class="lineCov">         40 :         if (!pctx) {</span>
<span class="lineNum">    1419 </span>            :                 GF_HTTPOutCtx *ctx_orig;
<span class="lineNum">    1420 </span>            :                 Bool patch_blocks = GF_FALSE;
<span class="lineNum">    1421 </span>            :                 GF_FilterEvent evt;
<span class="lineNum">    1422 </span>            :         const char *res_path;
<span class="lineNum">    1423 </span>            : 
<span class="lineNum">    1424 </span><span class="lineCov">         36 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_DISABLE_PROGRESSIVE);</span>
<span class="lineNum">    1425 </span><span class="lineCov">         36 :                 if (p &amp;&amp; p-&gt;value.uint) {</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;hmode==MODE_PUSH) {</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :                                 if (p-&gt;value.uint==GF_PID_FILE_PATCH_INSERT) {</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Push cannot be used to insert blocks in remote files (not supported by HTTP)\n&quot;));</span>
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :                                         return GF_FILTER_NOT_SUPPORTED;</span>
<span class="lineNum">    1430 </span>            :                                 }
<span class="lineNum">    1431 </span>            :                                 patch_blocks = GF_TRUE;
<span class="lineNum">    1432 </span>            :                         } else {
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Server cannot deliver PIDs with progressive download disabled\n&quot;));</span>
<span class="lineNum">    1434 </span>            :                                 return GF_FILTER_NOT_SUPPORTED;
<span class="lineNum">    1435 </span>            :                         }
<span class="lineNum">    1436 </span>            :                 }
<span class="lineNum">    1437 </span>            : 
<span class="lineNum">    1438 </span>            :                 /*if PID was connected to an alias, get the alias context to get the destination
<span class="lineNum">    1439 </span>            :                 Otherwise PID was directly connected to the main filter, use main filter destination*/
<span class="lineNum">    1440 </span><span class="lineCov">         36 :                 ctx_orig = (GF_HTTPOutCtx *) gf_filter_pid_get_alias_udta(pid);</span>
<span class="lineNum">    1441 </span><span class="lineCov">         36 :         if (!ctx_orig) ctx_orig = ctx;</span>
<span class="lineNum">    1442 </span>            : 
<span class="lineNum">    1443 </span><span class="lineCov">         36 :                 if (!ctx_orig-&gt;dst &amp;&amp; (ctx-&gt;hmode==MODE_PUSH))  {</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Push output but no destination set !\n&quot;));</span>
<span class="lineNum">    1445 </span>            :                         return GF_BAD_PARAM;
<span class="lineNum">    1446 </span>            :                 }
<span class="lineNum">    1447 </span>            : 
<span class="lineNum">    1448 </span><span class="lineCov">         36 :                 GF_SAFEALLOC(pctx, GF_HTTPOutInput);</span>
<span class="lineNum">    1449 </span><span class="lineCov">         36 :                 if (!pctx) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1450 </span><span class="lineCov">         36 :                 pctx-&gt;ipid = pid;</span>
<span class="lineNum">    1451 </span><span class="lineCov">         36 :                 pctx-&gt;ctx = ctx;</span>
<span class="lineNum">    1452 </span><span class="lineCov">         36 :                 pctx-&gt;patch_blocks = patch_blocks;</span>
<span class="lineNum">    1453 </span><span class="lineCov">         36 :                 pctx-&gt;hold = ctx-&gt;hold;</span>
<span class="lineNum">    1454 </span>            : 
<span class="lineNum">    1455 </span>            :         res_path = NULL;
<span class="lineNum">    1456 </span><span class="lineCov">         36 :                 if (ctx_orig-&gt;dst) {</span>
<span class="lineNum">    1457 </span>            :             res_path = ctx_orig-&gt;dst;
<span class="lineNum">    1458 </span><span class="lineCov">         36 :             char *path = strstr(res_path, &quot;://&quot;);</span>
<span class="lineNum">    1459 </span><span class="lineCov">         36 :             if (path) path = strchr(path+3, '/');</span>
<span class="lineNum">    1460 </span><span class="lineCov">         36 :             if (path) pctx-&gt;path = gf_strdup(path);</span>
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 :         } else if (!ctx-&gt;dst) {</span>
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :             p = gf_filter_pid_get_property(pid, GF_PROP_PID_FILEPATH);</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :             if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">    1464 </span>            :                 res_path = p-&gt;value.string;
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :                 pctx-&gt;path = gf_strdup(res_path);</span>
<span class="lineNum">    1466 </span>            :             }
<span class="lineNum">    1467 </span>            :         }
<span class="lineNum">    1468 </span><span class="lineCov">         36 :         if (res_path) {</span>
<span class="lineNum">    1469 </span>            : 
<span class="lineNum">    1470 </span><span class="lineCov">         36 :                         if (ctx-&gt;hmode==MODE_PUSH) {</span>
<span class="lineNum">    1471 </span>            :                                 GF_Err e;
<span class="lineNum">    1472 </span>            :                                 //note that ctx_orig-&gt;dst might be wrong (eg indicating MPD url rather than segment), but this is fixed in httpout_open_input by resetting up the session
<span class="lineNum">    1473 </span>            :                                 //with the correct URL
<span class="lineNum">    1474 </span><span class="lineCov">         11 :                                 pctx-&gt;upload = gf_dm_sess_new(gf_filter_get_download_manager(filter), ctx_orig-&gt;dst, GF_NETIO_SESSION_NOT_THREADED|GF_NETIO_SESSION_NOT_CACHED|GF_NETIO_SESSION_PERSISTENT, httpout_in_io, pctx, &amp;e);</span>
<span class="lineNum">    1475 </span><span class="lineCov">         11 :                                 if (!pctx-&gt;upload) {</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :                                         gf_free(pctx);</span>
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :                                         return e;</span>
<span class="lineNum">    1478 </span>            :                                 }
<span class="lineNum">    1479 </span>            : //                              gf_sk_group_register(ctx-&gt;sg, pctx-&gt;socket);
<span class="lineNum">    1480 </span>            :                         } else {
<span class="lineNum">    1481 </span><span class="lineCov">         25 :                                 if (!pctx-&gt;path) {</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Output path not specified\n&quot;));</span>
<span class="lineNum">    1483 </span>            :                                         return GF_BAD_PARAM;
<span class="lineNum">    1484 </span>            :                                 }
<span class="lineNum">    1485 </span><span class="lineCov">         25 :                                 httpout_set_local_path(ctx, pctx);</span>
<span class="lineNum">    1486 </span>            :                         }
<span class="lineNum">    1487 </span><span class="lineCov">         36 :                         if (ctx-&gt;dst &amp;&amp; !gf_list_count(ctx-&gt;inputs))</span>
<span class="lineNum">    1488 </span><span class="lineCov">         17 :                                 pctx-&gt;force_dst_name = GF_TRUE;</span>
<span class="lineNum">    1489 </span>            : 
<span class="lineNum">    1490 </span>            :                         //reset caps to anything (mime or ext) in case a URL was given, since graph resolution is now done
<span class="lineNum">    1491 </span>            :                         //this allows working with input filters dispatching files without creating a new destination (dashin in file mode for example)
<span class="lineNum">    1492 </span>            :                         //we do not reset caps to default as the default caps list an output and we don't want gf_filter_connections_pending to think we will produce one
<span class="lineNum">    1493 </span><span class="lineCov">         36 :                         ctx-&gt;in_caps[1].val = PROP_NAME( &quot;*&quot; );</span>
<span class="lineNum">    1494 </span>            :                 }
<span class="lineNum">    1495 </span>            :                 //in any cast store dash state, mime, register input and fire play
<span class="lineNum">    1496 </span><span class="lineCov">         36 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_DASH_MODE);</span>
<span class="lineNum">    1497 </span><span class="lineCov">         36 :                 if (p &amp;&amp; p-&gt;value.uint) pctx-&gt;dash_mode = GF_TRUE;</span>
<span class="lineNum">    1498 </span>            : 
<span class="lineNum">    1499 </span><span class="lineCov">         36 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_MIME);</span>
<span class="lineNum">    1500 </span><span class="lineCov">         36 :                 if (p &amp;&amp; p-&gt;value.string) pctx-&gt;mime = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">    1501 </span>            : 
<span class="lineNum">    1502 </span><span class="lineCov">         36 :                 gf_filter_pid_set_udta(pid, pctx);</span>
<span class="lineNum">    1503 </span><span class="lineCov">         36 :                 gf_list_add(ctx-&gt;inputs, pctx);</span>
<span class="lineNum">    1504 </span>            : 
<span class="lineNum">    1505 </span><span class="lineCov">         36 :                 gf_filter_pid_init_play_event(pid, &amp;evt, 0.0, 1.0, &quot;HTTPOut&quot;);</span>
<span class="lineNum">    1506 </span><span class="lineCov">         36 :                 gf_filter_pid_send_event(pid, &amp;evt);</span>
<span class="lineNum">    1507 </span>            :             
<span class="lineNum">    1508 </span>            :         }
<span class="lineNum">    1509 </span>            :         if (is_remove) {
<span class="lineNum">    1510 </span>            :                 return GF_OK;
<span class="lineNum">    1511 </span>            :         }
<span class="lineNum">    1512 </span>            : 
<span class="lineNum">    1513 </span>            :         //we act as a server
<span class="lineNum">    1514 </span>            : 
<span class="lineNum">    1515 </span>            :         return GF_OK;
<span class="lineNum">    1516 </span>            : }
<a name="1517"><span class="lineNum">    1517 </span>            : </a>
<span class="lineNum">    1518 </span>            : 
<span class="lineNum">    1519 </span><span class="lineCov">         47 : static void httpout_check_new_session(GF_HTTPOutCtx *ctx)</span>
<span class="lineNum">    1520 </span>            : {
<span class="lineNum">    1521 </span>            :         char peer_address[GF_MAX_IP_NAME_LEN];
<span class="lineNum">    1522 </span>            :         GF_HTTPOutSession *sess;
<span class="lineNum">    1523 </span>            :         GF_Err e;
<span class="lineNum">    1524 </span>            :         void *ssl_c = NULL;
<span class="lineNum">    1525 </span><span class="lineCov">         47 :         GF_Socket *new_conn = NULL;</span>
<span class="lineNum">    1526 </span>            : 
<span class="lineNum">    1527 </span><span class="lineCov">         47 :         e = gf_sk_accept(ctx-&gt;server_sock, &amp;new_conn);</span>
<span class="lineNum">    1528 </span><span class="lineCov">         47 :         if (e==GF_IP_SOCK_WOULD_BLOCK) return;</span>
<span class="lineNum">    1529 </span><span class="lineCov">         47 :         else if (e) {</span>
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Accept failure %s\n&quot;, gf_error_to_string(e) ));</span>
<span class="lineNum">    1531 </span>            :                 return;
<span class="lineNum">    1532 </span>            :         }
<span class="lineNum">    1533 </span>            :         //check max connections
<span class="lineNum">    1534 </span><span class="lineCov">         47 :         if (ctx-&gt;maxc &amp;&amp; (ctx-&gt;nb_connections&gt;=ctx-&gt;maxc)) {</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_WARNING, GF_LOG_HTTP, (&quot;[HTTPOut] Connection rejected due to too many connections\n&quot;));</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :                 gf_sk_del(new_conn);</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1538 </span>            :         }
<span class="lineNum">    1539 </span><span class="lineCov">         47 :         gf_sk_get_remote_address(new_conn, peer_address);</span>
<span class="lineNum">    1540 </span><span class="lineCov">         47 :         if (ctx-&gt;maxp) {</span>
<span class="lineNum">    1541 </span><span class="lineCov">         47 :                 u32 i, nb_conn=0, count = gf_list_count(ctx-&gt;sessions);</span>
<span class="lineNum">    1542 </span><span class="lineCov">         85 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1543 </span><span class="lineCov">         38 :                         sess = gf_list_get(ctx-&gt;sessions, i);</span>
<span class="lineNum">    1544 </span><span class="lineCov">         38 :                         if (!strcmp(sess-&gt;peer_address, peer_address)) nb_conn++;</span>
<span class="lineNum">    1545 </span>            :                 }
<span class="lineNum">    1546 </span><span class="lineCov">         47 :                 if (nb_conn&gt;=ctx-&gt;maxp) {</span>
<span class="lineNum">    1547 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_HTTP, (&quot;[HTTPOut] Connection rejected due to too many connections from peer %s\n&quot;, peer_address));</span>
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :                         gf_sk_del(new_conn);</span>
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    1550 </span>            :                 }
<span class="lineNum">    1551 </span>            :         }
<span class="lineNum">    1552 </span><span class="lineCov">         47 :         GF_SAFEALLOC(sess, GF_HTTPOutSession);</span>
<span class="lineNum">    1553 </span><span class="lineCov">         47 :         if (!sess) {</span>
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :                 gf_sk_del(new_conn);</span>
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1556 </span>            :         }
<span class="lineNum">    1557 </span>            : 
<span class="lineNum">    1558 </span>            :         //we keep track of the socket for sock group (un)register
<span class="lineNum">    1559 </span><span class="lineCov">         47 :         sess-&gt;socket = new_conn;</span>
<span class="lineNum">    1560 </span><span class="lineCov">         47 :         sess-&gt;ctx = ctx;</span>
<span class="lineNum">    1561 </span>            : 
<span class="lineNum">    1562 </span>            : #ifdef GPAC_HAS_SSL
<span class="lineNum">    1563 </span><span class="lineCov">         47 :         if (ctx-&gt;ssl_ctx) {</span>
<span class="lineNum">    1564 </span><span class="lineCov">          1 :                 ssl_c = gf_ssl_new(ctx-&gt;ssl_ctx, new_conn, &amp;e);</span>
<span class="lineNum">    1565 </span><span class="lineCov">          1 :                 if (e) {</span>
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Failed to create TLS session from %s: %s\n&quot;, sess-&gt;peer_address, gf_error_to_string(e) ));</span>
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :                         gf_free(sess);</span>
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :                         gf_sk_del(new_conn);</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    1570 </span>            :                 }
<span class="lineNum">    1571 </span>            :         }
<span class="lineNum">    1572 </span>            : #endif
<span class="lineNum">    1573 </span>            : 
<span class="lineNum">    1574 </span><span class="lineCov">         47 :         sess-&gt;http_sess = gf_dm_sess_new_server(new_conn, ssl_c, httpout_sess_io, sess, &amp;e);</span>
<span class="lineNum">    1575 </span><span class="lineCov">         47 :         if (!sess-&gt;http_sess) {</span>
<span class="lineNum">    1576 </span><span class="lineNoCov">          0 :                 gf_sk_del(new_conn);</span>
<span class="lineNum">    1577 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Failed to create HTTP server session from %s: %s\n&quot;, sess-&gt;peer_address, gf_error_to_string(e) ));</span>
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :                 gf_free(sess);</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1580 </span>            :         }
<span class="lineNum">    1581 </span><span class="lineCov">         47 :         ctx-&gt;nb_connections++;</span>
<span class="lineNum">    1582 </span>            : 
<span class="lineNum">    1583 </span><span class="lineCov">         47 :         gf_list_add(ctx-&gt;sessions, sess);</span>
<span class="lineNum">    1584 </span><span class="lineCov">         47 :         gf_list_add(ctx-&gt;active_sessions, sess);</span>
<span class="lineNum">    1585 </span><span class="lineCov">         47 :         gf_sk_group_register(ctx-&gt;sg, sess-&gt;socket);</span>
<span class="lineNum">    1586 </span>            :         
<span class="lineNum">    1587 </span><span class="lineCov">         47 :         gf_sk_set_buffer_size(new_conn, GF_FALSE, ctx-&gt;block_size);</span>
<span class="lineNum">    1588 </span><span class="lineCov">         47 :         gf_sk_set_buffer_size(new_conn, GF_TRUE, ctx-&gt;block_size);</span>
<span class="lineNum">    1589 </span><span class="lineCov">         47 :         strcpy(sess-&gt;peer_address, peer_address);</span>
<span class="lineNum">    1590 </span>            : 
<span class="lineNum">    1591 </span><span class="lineCov">         47 :         GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Accepting new connection from %s\n&quot;, sess-&gt;peer_address));</span>
<span class="lineNum">    1592 </span>            :         //ask immediate reschedule
<span class="lineNum">    1593 </span><span class="lineCov">         47 :         ctx-&gt;next_wake_us = 1;</span>
<a name="1594"><span class="lineNum">    1594 </span>            : }</a>
<span class="lineNum">    1595 </span>            : 
<span class="lineNum">    1596 </span><span class="lineCov">         46 : static GF_Err httpout_initialize(GF_Filter *filter)</span>
<span class="lineNum">    1597 </span>            : {
<span class="lineNum">    1598 </span>            :         char szIP[1024];
<span class="lineNum">    1599 </span>            :         GF_Err e;
<span class="lineNum">    1600 </span>            :         u16 port;
<span class="lineNum">    1601 </span>            :         char *ip;
<span class="lineNum">    1602 </span>            :         const char *ext = NULL;
<span class="lineNum">    1603 </span>            :         char *sep, *url;
<span class="lineNum">    1604 </span><span class="lineCov">         46 :         GF_HTTPOutCtx *ctx = (GF_HTTPOutCtx *) gf_filter_get_udta(filter);</span>
<span class="lineNum">    1605 </span>            : 
<span class="lineNum">    1606 </span>            : 
<span class="lineNum">    1607 </span><span class="lineCov">         46 :         port = ctx-&gt;port;</span>
<span class="lineNum">    1608 </span><span class="lineCov">         46 :         ip = ctx-&gt;ifce;</span>
<span class="lineNum">    1609 </span>            : 
<span class="lineNum">    1610 </span><span class="lineCov">         46 :         url = ctx-&gt;dst;</span>
<span class="lineNum">    1611 </span>            :         sep = NULL;
<span class="lineNum">    1612 </span><span class="lineCov">         46 :         if (ctx-&gt;dst) {</span>
<span class="lineNum">    1613 </span><span class="lineCov">         34 :                 if (!strncmp(ctx-&gt;dst, &quot;http://&quot;, 7)) {</span>
<span class="lineNum">    1614 </span><span class="lineCov">         34 :                         sep = strchr(ctx-&gt;dst+7, '/');</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :                 } else if (!strncmp(ctx-&gt;dst, &quot;https://&quot;, 8)) {</span>
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 :                         sep = strchr(ctx-&gt;dst+8, '/');</span>
<span class="lineNum">    1617 </span>            :                 }
<span class="lineNum">    1618 </span>            :         }
<span class="lineNum">    1619 </span><span class="lineCov">         34 :         if (sep) {</span>
<span class="lineNum">    1620 </span>            :                 u32 cplen;
<span class="lineNum">    1621 </span><span class="lineCov">         34 :                 url = sep+1;</span>
<span class="lineNum">    1622 </span><span class="lineCov">         34 :                 cplen = (u32) (sep-ctx-&gt;dst-7);</span>
<span class="lineNum">    1623 </span><span class="lineCov">         34 :                 if (cplen&gt;1023) cplen=1023;</span>
<span class="lineNum">    1624 </span><span class="lineCov">         34 :                 strncpy(szIP, ctx-&gt;dst+7, cplen);</span>
<span class="lineNum">    1625 </span><span class="lineCov">         34 :                 szIP[1023] = 0;</span>
<span class="lineNum">    1626 </span><span class="lineCov">         34 :                 sep = strchr(szIP, ':');</span>
<span class="lineNum">    1627 </span><span class="lineCov">         34 :                 if (sep) {</span>
<span class="lineNum">    1628 </span><span class="lineCov">         68 :                         port = atoi(sep+1);</span>
<span class="lineNum">    1629 </span><span class="lineCov">         34 :                         if (!port) port = ctx-&gt;port;</span>
<span class="lineNum">    1630 </span><span class="lineCov">         34 :                         sep[0] = 0;</span>
<span class="lineNum">    1631 </span>            :                 }
<span class="lineNum">    1632 </span><span class="lineCov">         34 :                 if (strlen(szIP)) ip = szIP;</span>
<span class="lineNum">    1633 </span>            :         }
<span class="lineNum">    1634 </span><span class="lineCov">         46 :         if (url &amp;&amp; !strlen(url))</span>
<span class="lineNum">    1635 </span>            :                 url = NULL;
<span class="lineNum">    1636 </span>            : 
<span class="lineNum">    1637 </span><span class="lineCov">         46 :         if (url) {</span>
<span class="lineNum">    1638 </span><span class="lineCov">         34 :                 if (ctx-&gt;ext) ext = ctx-&gt;ext;</span>
<span class="lineNum">    1639 </span>            :                 else {
<span class="lineNum">    1640 </span><span class="lineCov">         34 :                         ext = gf_file_ext_start(url);</span>
<span class="lineNum">    1641 </span><span class="lineCov">         34 :                         if (!ext) ext = &quot;.*&quot;;</span>
<span class="lineNum">    1642 </span><span class="lineCov">         34 :                         ext += 1;</span>
<span class="lineNum">    1643 </span>            :                 }
<span class="lineNum">    1644 </span>            : 
<span class="lineNum">    1645 </span><span class="lineCov">         34 :                 if (!ext &amp;&amp; !ctx-&gt;mime) {</span>
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_HTTP, (&quot;[HTTPOut] No extension provided nor mime type for output file %s, cannot infer format\nThis may result in invalid filter chain resolution&quot;, ctx-&gt;dst));</span>
<span class="lineNum">    1647 </span>            :                 } else {
<span class="lineNum">    1648 </span>            :                         //static cap, streamtype = file
<span class="lineNum">    1649 </span><span class="lineCov">         34 :                         ctx-&gt;in_caps[0].code = GF_PROP_PID_STREAM_TYPE;</span>
<span class="lineNum">    1650 </span><span class="lineCov">         34 :                         ctx-&gt;in_caps[0].val = PROP_UINT(GF_STREAM_FILE);</span>
<span class="lineNum">    1651 </span><span class="lineCov">         34 :                         ctx-&gt;in_caps[0].flags = GF_CAPS_INPUT_STATIC;</span>
<span class="lineNum">    1652 </span>            : 
<span class="lineNum">    1653 </span><span class="lineCov">         34 :                         if (ctx-&gt;mime) {</span>
<span class="lineNum">    1654 </span><span class="lineCov">         17 :                                 ctx-&gt;in_caps[1].code = GF_PROP_PID_MIME;</span>
<span class="lineNum">    1655 </span><span class="lineCov">         17 :                                 ctx-&gt;in_caps[1].val = PROP_NAME( ctx-&gt;mime );</span>
<span class="lineNum">    1656 </span><span class="lineCov">         17 :                                 ctx-&gt;in_caps[1].flags = GF_CAPS_INPUT;</span>
<span class="lineNum">    1657 </span>            :                         } else {
<span class="lineNum">    1658 </span><span class="lineCov">         17 :                                 strncpy(ctx-&gt;szExt, ext, 9);</span>
<span class="lineNum">    1659 </span><span class="lineCov">         17 :                                 ctx-&gt;szExt[9] = 0;</span>
<span class="lineNum">    1660 </span><span class="lineCov">         17 :                                 strlwr(ctx-&gt;szExt);</span>
<span class="lineNum">    1661 </span><span class="lineCov">         17 :                                 ctx-&gt;in_caps[1].code = GF_PROP_PID_FILE_EXT;</span>
<span class="lineNum">    1662 </span><span class="lineCov">         17 :                                 ctx-&gt;in_caps[1].val = PROP_NAME( ctx-&gt;szExt );</span>
<span class="lineNum">    1663 </span><span class="lineCov">         17 :                                 ctx-&gt;in_caps[1].flags = GF_CAPS_INPUT;</span>
<span class="lineNum">    1664 </span>            :                         }
<span class="lineNum">    1665 </span><span class="lineCov">         34 :                         gf_filter_override_caps(filter, ctx-&gt;in_caps, 2);</span>
<span class="lineNum">    1666 </span>            :                 }
<span class="lineNum">    1667 </span>            :         }
<span class="lineNum">    1668 </span>            :         /*this is an alias for our main filter, nothing to initialize*/
<span class="lineNum">    1669 </span><span class="lineCov">         46 :         if (gf_filter_is_alias(filter)) {</span>
<span class="lineNum">    1670 </span>            :                 return GF_OK;
<span class="lineNum">    1671 </span>            :         }
<span class="lineNum">    1672 </span>            : 
<span class="lineNum">    1673 </span><span class="lineCov">         29 :         if (ctx-&gt;wdir)</span>
<span class="lineNum">    1674 </span><span class="lineCov">          5 :                 ctx-&gt;hmode = MODE_DEFAULT;</span>
<span class="lineNum">    1675 </span>            : 
<span class="lineNum">    1676 </span><span class="lineCov">         29 :         if (!url &amp;&amp; !ctx-&gt;rdirs.nb_items &amp;&amp; !ctx-&gt;wdir &amp;&amp; (ctx-&gt;hmode!=MODE_SOURCE)) {</span>
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] No root dir(s) for server, no URL set and not configured as source, cannot run!\n&quot; ));</span>
<span class="lineNum">    1678 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    1679 </span>            :         }
<span class="lineNum">    1680 </span>            : 
<span class="lineNum">    1681 </span><span class="lineCov">         29 :         if (ctx-&gt;rdirs.nb_items || ctx-&gt;wdir) {</span>
<span class="lineNum">    1682 </span><span class="lineCov">         21 :                 gf_filter_make_sticky(filter);</span>
<span class="lineNum">    1683 </span><span class="lineCov">          8 :         } else if (ctx-&gt;hmode!=MODE_PUSH) {</span>
<span class="lineNum">    1684 </span><span class="lineCov">          2 :                 ctx-&gt;single_mode = GF_TRUE;</span>
<span class="lineNum">    1685 </span>            :         }
<span class="lineNum">    1686 </span>            : 
<span class="lineNum">    1687 </span><span class="lineCov">         29 :         ctx-&gt;sessions = gf_list_new();</span>
<span class="lineNum">    1688 </span><span class="lineCov">         29 :         ctx-&gt;active_sessions = gf_list_new();</span>
<span class="lineNum">    1689 </span><span class="lineCov">         29 :         ctx-&gt;inputs = gf_list_new();</span>
<span class="lineNum">    1690 </span><span class="lineCov">         29 :         ctx-&gt;filter = filter;</span>
<span class="lineNum">    1691 </span>            :         //used in both server and push modes
<span class="lineNum">    1692 </span><span class="lineCov">         29 :         ctx-&gt;sg = gf_sk_group_new();</span>
<span class="lineNum">    1693 </span>            : 
<span class="lineNum">    1694 </span><span class="lineCov">         29 :         if (ip)</span>
<span class="lineNum">    1695 </span><span class="lineCov">         17 :                 ctx-&gt;ip = gf_strdup(ip);</span>
<span class="lineNum">    1696 </span>            : 
<span class="lineNum">    1697 </span><span class="lineCov">         29 :         if (ctx-&gt;cache_control) {</span>
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :                 if (!strcmp(ctx-&gt;cache_control, &quot;none&quot;)) ctx-&gt;no_etag = GF_TRUE;</span>
<span class="lineNum">    1699 </span>            :         }
<span class="lineNum">    1700 </span>            : 
<span class="lineNum">    1701 </span><span class="lineCov">         29 :         if (ctx-&gt;hmode==MODE_PUSH) {</span>
<span class="lineNum">    1702 </span><span class="lineCov">          6 :                 ctx-&gt;hold = GF_FALSE;</span>
<span class="lineNum">    1703 </span><span class="lineCov">          6 :                 return GF_OK;</span>
<span class="lineNum">    1704 </span>            :         }
<span class="lineNum">    1705 </span><span class="lineCov">         23 :         ctx-&gt;port = port;</span>
<span class="lineNum">    1706 </span><span class="lineCov">         23 :         if (ctx-&gt;cert &amp;&amp; !ctx-&gt;pkey) {</span>
<span class="lineNum">    1707 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] missing server private key file\n&quot;));</span>
<span class="lineNum">    1708 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    1709 </span>            :         }
<span class="lineNum">    1710 </span><span class="lineCov">         23 :         if (!ctx-&gt;cert &amp;&amp; ctx-&gt;pkey) {</span>
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] missing server certificate file\n&quot;));</span>
<span class="lineNum">    1712 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    1713 </span>            :         }
<span class="lineNum">    1714 </span><span class="lineCov">         23 :         if (ctx-&gt;cert &amp;&amp; ctx-&gt;pkey) {</span>
<span class="lineNum">    1715 </span>            : #ifdef GPAC_HAS_SSL
<span class="lineNum">    1716 </span><span class="lineCov">          1 :                 if (!gf_file_exists(ctx-&gt;cert)) {</span>
<span class="lineNum">    1717 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Certificate file %s not found\n&quot;, ctx-&gt;cert));</span>
<span class="lineNum">    1718 </span>            :                         return GF_IO_ERR;
<span class="lineNum">    1719 </span>            :                 }
<span class="lineNum">    1720 </span><span class="lineCov">          1 :                 if (!gf_file_exists(ctx-&gt;pkey)) {</span>
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Provate key file %s not found\n&quot;, ctx-&gt;pkey));</span>
<span class="lineNum">    1722 </span>            :                         return GF_IO_ERR;
<span class="lineNum">    1723 </span>            :                 }
<span class="lineNum">    1724 </span><span class="lineCov">          1 :                 if (gf_ssl_init_lib()) {</span>
<span class="lineNum">    1725 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Failed to initialize OpenSSL library\n&quot;));</span>
<span class="lineNum">    1726 </span>            :                         return GF_IO_ERR;
<span class="lineNum">    1727 </span>            :                 }
<span class="lineNum">    1728 </span><span class="lineCov">          1 :                 ctx-&gt;ssl_ctx = gf_ssl_server_context_new(ctx-&gt;cert, ctx-&gt;pkey);</span>
<span class="lineNum">    1729 </span><span class="lineCov">          1 :                 if (!ctx-&gt;ssl_ctx) return GF_IO_ERR;</span>
<span class="lineNum">    1730 </span>            : 
<span class="lineNum">    1731 </span><span class="lineCov">          1 :                 if (!ctx-&gt;port)</span>
<span class="lineNum">    1732 </span><span class="lineNoCov">          0 :                         ctx-&gt;port = 443;</span>
<span class="lineNum">    1733 </span>            : #else
<span class="lineNum">    1734 </span>            :                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] TLS key/certificate set but GPAC compiled without TLS support\n&quot;));
<span class="lineNum">    1735 </span>            :                 return GF_NOT_SUPPORTED;
<span class="lineNum">    1736 </span>            : 
<span class="lineNum">    1737 </span>            : #endif
<span class="lineNum">    1738 </span>            :         }
<span class="lineNum">    1739 </span>            : 
<span class="lineNum">    1740 </span><span class="lineCov">         23 :         if (!ctx-&gt;port)</span>
<span class="lineNum">    1741 </span><span class="lineNoCov">          0 :                 ctx-&gt;port = 80;</span>
<span class="lineNum">    1742 </span>            : 
<span class="lineNum">    1743 </span><span class="lineCov">         23 :         ctx-&gt;server_sock = gf_sk_new(GF_SOCK_TYPE_TCP);</span>
<span class="lineNum">    1744 </span><span class="lineCov">         23 :         e = gf_sk_bind(ctx-&gt;server_sock, NULL, ctx-&gt;port, ip, 0, GF_SOCK_REUSE_PORT);</span>
<span class="lineNum">    1745 </span><span class="lineCov">         23 :         if (!e) e = gf_sk_listen(ctx-&gt;server_sock, ctx-&gt;maxc);</span>
<span class="lineNum">    1746 </span><span class="lineCov">         23 :         if (e) {</span>
<span class="lineNum">    1747 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] failed to start server on port %d: %s\n&quot;, ctx-&gt;port, gf_error_to_string(e) ));</span>
<span class="lineNum">    1748 </span>            :                 return e;
<span class="lineNum">    1749 </span>            :         }
<span class="lineNum">    1750 </span><span class="lineCov">         23 :         gf_sk_group_register(ctx-&gt;sg, ctx-&gt;server_sock);</span>
<span class="lineNum">    1751 </span>            : 
<span class="lineNum">    1752 </span><span class="lineCov">         23 :         gf_sk_server_mode(ctx-&gt;server_sock, GF_TRUE);</span>
<span class="lineNum">    1753 </span><span class="lineCov">         23 :         GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Server running on port %d\n&quot;, ctx-&gt;port));</span>
<span class="lineNum">    1754 </span><span class="lineCov">         23 :         if (ctx-&gt;reqlog) {</span>
<span class="lineNum">    1755 </span><span class="lineCov">          9 :                 GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] Server running on port %d\n&quot;, ctx-&gt;port));</span>
<span class="lineNum">    1756 </span><span class="lineCov">          9 :                 if (strstr(ctx-&gt;reqlog, &quot;REC&quot;))</span>
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 :                         ctx-&gt;log_record = GF_TRUE;</span>
<span class="lineNum">    1758 </span>            :         }
<span class="lineNum">    1759 </span><span class="lineCov">         23 :         gf_filter_post_process_task(filter);</span>
<span class="lineNum">    1760 </span><span class="lineCov">         23 :         return GF_OK;</span>
<a name="1761"><span class="lineNum">    1761 </span>            : }</a>
<span class="lineNum">    1762 </span>            : 
<span class="lineNum">    1763 </span><span class="lineCov">         47 : static void httpout_del_session(GF_HTTPOutSession *s)</span>
<span class="lineNum">    1764 </span>            : {
<span class="lineNum">    1765 </span><span class="lineCov">         47 :         gf_list_del_item(s-&gt;ctx-&gt;active_sessions, s);</span>
<span class="lineNum">    1766 </span><span class="lineCov">         47 :         gf_list_del_item(s-&gt;ctx-&gt;sessions, s);</span>
<span class="lineNum">    1767 </span><span class="lineCov">         47 :         if (s-&gt;http_sess)</span>
<span class="lineNum">    1768 </span><span class="lineCov">          4 :                 httpout_close_session(s);</span>
<span class="lineNum">    1769 </span><span class="lineCov">         47 :         if (s-&gt;buffer) gf_free(s-&gt;buffer);</span>
<span class="lineNum">    1770 </span><span class="lineCov">         47 :         if (s-&gt;path) gf_free(s-&gt;path);</span>
<span class="lineNum">    1771 </span><span class="lineCov">         47 :         if (s-&gt;mime) gf_free(s-&gt;mime);</span>
<span class="lineNum">    1772 </span><span class="lineCov">         47 :         if (s-&gt;opid) gf_filter_pid_remove(s-&gt;opid);</span>
<span class="lineNum">    1773 </span><span class="lineCov">         47 :         if (s-&gt;resource) gf_fclose(s-&gt;resource);</span>
<span class="lineNum">    1774 </span><span class="lineCov">         47 :         if (s-&gt;ranges) gf_free(s-&gt;ranges);</span>
<span class="lineNum">    1775 </span><span class="lineCov">         47 :         gf_free(s);</span>
<a name="1776"><span class="lineNum">    1776 </span><span class="lineCov">         47 : }</span></a>
<span class="lineNum">    1777 </span>            : 
<span class="lineNum">    1778 </span><span class="lineCov">        766 : static void httpout_close_hls_chunk(GF_HTTPOutCtx *ctx, GF_HTTPOutInput *in, Bool final_flush)</span>
<span class="lineNum">    1779 </span>            : {
<span class="lineNum">    1780 </span><span class="lineCov">        766 :         if (!in-&gt;hls_chunk) return;</span>
<span class="lineNum">    1781 </span>            : 
<span class="lineNum">    1782 </span><span class="lineCov">         90 :         gf_fclose(in-&gt;hls_chunk);</span>
<span class="lineNum">    1783 </span><span class="lineCov">         90 :         in-&gt;hls_chunk = NULL;</span>
<span class="lineNum">    1784 </span>            : 
<span class="lineNum">    1785 </span><span class="lineCov">         90 :         if (!final_flush) {</span>
<span class="lineNum">    1786 </span>            :                 u32 i, count;
<span class="lineNum">    1787 </span>            :                 //detach all clients from this input and reassign to a regular output
<span class="lineNum">    1788 </span><span class="lineCov">         90 :                 count = gf_list_count(ctx-&gt;sessions);</span>
<span class="lineNum">    1789 </span><span class="lineCov">        120 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1790 </span><span class="lineCov">        120 :                         GF_HTTPOutSession *sess = gf_list_get(ctx-&gt;sessions, i);</span>
<span class="lineNum">    1791 </span><span class="lineCov">        120 :                         if (sess-&gt;in_source != in) continue;</span>
<span class="lineNum">    1792 </span><span class="lineCov">         36 :                         if (!sess-&gt;in_source_is_ll_hls_chunk) continue;</span>
<span class="lineNum">    1793 </span><span class="lineCov">         10 :                         if (strcmp(sess-&gt;path, in-&gt;local_path)) continue;</span>
<span class="lineNum">    1794 </span>            : 
<span class="lineNum">    1795 </span>            :                         assert(sess-&gt;file_in_progress);
<span class="lineNum">    1796 </span>            :                         if (sess-&gt;in_source) {
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :                                 sess-&gt;in_source-&gt;nb_dest--;</span>
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :                                 sess-&gt;in_source = NULL;</span>
<span class="lineNum">    1799 </span><span class="lineNoCov">          0 :                                 if (!sess-&gt;resource &amp;&amp; sess-&gt;path) {</span>
<span class="lineNum">    1800 </span><span class="lineNoCov">          0 :                                         sess-&gt;resource = gf_fopen(sess-&gt;path, &quot;rb&quot;);</span>
<span class="lineNum">    1801 </span>            :                                 }
<span class="lineNum">    1802 </span>            :                         }
<span class="lineNum">    1803 </span><span class="lineNoCov">          0 :                         sess-&gt;in_source_is_ll_hls_chunk = GF_FALSE;</span>
<span class="lineNum">    1804 </span><span class="lineNoCov">          0 :                         sess-&gt;file_size = gf_fsize(sess-&gt;resource);</span>
<span class="lineNum">    1805 </span><span class="lineNoCov">          0 :                         gf_fseek(sess-&gt;resource, sess-&gt;file_pos, SEEK_SET);</span>
<span class="lineNum">    1806 </span><span class="lineNoCov">          0 :                         sess-&gt;file_in_progress = GF_FALSE;</span>
<span class="lineNum">    1807 </span>            :                 }
<span class="lineNum">    1808 </span>            :         }
<span class="lineNum">    1809 </span>            : 
<span class="lineNum">    1810 </span><span class="lineCov">         90 :         if (in-&gt;hls_chunk_path) gf_free(in-&gt;hls_chunk_path);</span>
<span class="lineNum">    1811 </span><span class="lineCov">         90 :         in-&gt;hls_chunk_path = NULL;</span>
<span class="lineNum">    1812 </span><span class="lineCov">         90 :         if (in-&gt;hls_chunk_local_path) gf_free(in-&gt;hls_chunk_local_path);</span>
<span class="lineNum">    1813 </span><span class="lineCov">         90 :         in-&gt;hls_chunk_local_path = NULL;</span>
<span class="lineNum">    1814 </span>            : }
<a name="1815"><span class="lineNum">    1815 </span>            : </a>
<span class="lineNum">    1816 </span>            : 
<span class="lineNum">    1817 </span><span class="lineCov">         46 : static void httpout_finalize(GF_Filter *filter)</span>
<span class="lineNum">    1818 </span>            : {
<span class="lineNum">    1819 </span><span class="lineCov">         46 :         GF_HTTPOutCtx *ctx = (GF_HTTPOutCtx *) gf_filter_get_udta(filter);</span>
<span class="lineNum">    1820 </span>            : 
<span class="lineNum">    1821 </span>            :         /*this is an alias for our main filter, nothing to finalize*/
<span class="lineNum">    1822 </span><span class="lineCov">         46 :         if (gf_filter_is_alias(filter))</span>
<span class="lineNum">    1823 </span>            :                 return;
<span class="lineNum">    1824 </span>            : 
<span class="lineNum">    1825 </span><span class="lineCov">         33 :         while (gf_list_count(ctx-&gt;sessions)) {</span>
<span class="lineNum">    1826 </span><span class="lineCov">          4 :                 GF_HTTPOutSession *tmp = gf_list_get(ctx-&gt;sessions, 0);</span>
<span class="lineNum">    1827 </span><span class="lineCov">          4 :                 tmp-&gt;opid = NULL;</span>
<span class="lineNum">    1828 </span><span class="lineCov">          4 :                 httpout_del_session(tmp);</span>
<span class="lineNum">    1829 </span>            :         }
<span class="lineNum">    1830 </span><span class="lineCov">         29 :         gf_list_del(ctx-&gt;sessions);</span>
<span class="lineNum">    1831 </span><span class="lineCov">         29 :         gf_list_del(ctx-&gt;active_sessions);</span>
<span class="lineNum">    1832 </span>            : 
<span class="lineNum">    1833 </span><span class="lineCov">         94 :         while (gf_list_count(ctx-&gt;inputs)) {</span>
<span class="lineNum">    1834 </span><span class="lineCov">         36 :                 GF_HTTPOutInput *in = gf_list_pop_back(ctx-&gt;inputs);</span>
<span class="lineNum">    1835 </span><span class="lineCov">         36 :                 if (in-&gt;local_path) gf_free(in-&gt;local_path);</span>
<span class="lineNum">    1836 </span><span class="lineCov">         36 :                 if (in-&gt;path) gf_free(in-&gt;path);</span>
<span class="lineNum">    1837 </span><span class="lineCov">         36 :                 if (in-&gt;mime) gf_free(in-&gt;mime);</span>
<span class="lineNum">    1838 </span>            : 
<span class="lineNum">    1839 </span><span class="lineCov">         36 :                 httpout_close_hls_chunk(ctx, in, GF_TRUE);</span>
<span class="lineNum">    1840 </span>            : 
<span class="lineNum">    1841 </span><span class="lineCov">         36 :                 if (in-&gt;resource) gf_fclose(in-&gt;resource);</span>
<span class="lineNum">    1842 </span><span class="lineCov">         36 :                 if (in-&gt;upload) gf_dm_sess_del(in-&gt;upload);</span>
<span class="lineNum">    1843 </span><span class="lineCov">         36 :                 if (in-&gt;file_deletes) {</span>
<span class="lineNum">    1844 </span><span class="lineNoCov">          0 :                         while (gf_list_count(in-&gt;file_deletes)) {</span>
<span class="lineNum">    1845 </span><span class="lineNoCov">          0 :                                 char *url = gf_list_pop_back(in-&gt;file_deletes);</span>
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :                                 gf_free(url);</span>
<span class="lineNum">    1847 </span>            :                         }
<span class="lineNum">    1848 </span><span class="lineNoCov">          0 :                         gf_list_del(in-&gt;file_deletes);</span>
<span class="lineNum">    1849 </span>            :                 }
<span class="lineNum">    1850 </span><span class="lineCov">         36 :                 gf_free(in);</span>
<span class="lineNum">    1851 </span>            :         }
<span class="lineNum">    1852 </span><span class="lineCov">         29 :         gf_list_del(ctx-&gt;inputs);</span>
<span class="lineNum">    1853 </span><span class="lineCov">         29 :         if (ctx-&gt;server_sock) gf_sk_del(ctx-&gt;server_sock);</span>
<span class="lineNum">    1854 </span><span class="lineCov">         29 :         if (ctx-&gt;sg) gf_sk_group_del(ctx-&gt;sg);</span>
<span class="lineNum">    1855 </span><span class="lineCov">         29 :         if (ctx-&gt;ip) gf_free(ctx-&gt;ip);</span>
<span class="lineNum">    1856 </span>            : 
<span class="lineNum">    1857 </span>            : #ifdef GPAC_HAS_SSL
<span class="lineNum">    1858 </span><span class="lineCov">         29 :         if (ctx-&gt;ssl_ctx) {</span>
<span class="lineNum">    1859 </span><span class="lineCov">          1 :                 gf_ssl_server_context_del(ctx-&gt;ssl_ctx);</span>
<span class="lineNum">    1860 </span>            :         }
<span class="lineNum">    1861 </span>            : #endif
<a name="1862"><span class="lineNum">    1862 </span>            : }</a>
<span class="lineNum">    1863 </span>            : 
<span class="lineNum">    1864 </span><span class="lineCov">        115 : static GF_Err httpout_sess_data_upload(GF_HTTPOutSession *sess, const u8 *data, u32 size)</span>
<span class="lineNum">    1865 </span>            : {
<span class="lineNum">    1866 </span>            :         u32 remain, write, to_write;
<span class="lineNum">    1867 </span>            : 
<span class="lineNum">    1868 </span><span class="lineCov">        115 :         if (sess-&gt;opid || sess-&gt;reconfigure_output) {</span>
<span class="lineNum">    1869 </span>            :                 GF_FilterPacket *pck;
<span class="lineNum">    1870 </span>            :                 u8 *buffer;
<span class="lineNum">    1871 </span>            :                 Bool is_first = GF_FALSE;
<span class="lineNum">    1872 </span><span class="lineCov">          9 :                 if (sess-&gt;reconfigure_output) {</span>
<span class="lineNum">    1873 </span><span class="lineCov">          1 :                         sess-&gt;reconfigure_output = GF_FALSE;</span>
<span class="lineNum">    1874 </span><span class="lineCov">          1 :                         gf_filter_pid_raw_new(sess-&gt;ctx-&gt;filter, sess-&gt;path, NULL, sess-&gt;mime, NULL, (u8 *) data, size, GF_FALSE, &amp;sess-&gt;opid);</span>
<span class="lineNum">    1875 </span>            :                         is_first = GF_TRUE;
<span class="lineNum">    1876 </span>            :                 }
<span class="lineNum">    1877 </span><span class="lineCov">          9 :                 if (!sess-&gt;opid) return GF_SERVICE_ERROR;</span>
<span class="lineNum">    1878 </span><span class="lineCov">          9 :                 pck = gf_filter_pck_new_alloc(sess-&gt;opid, size, &amp;buffer);</span>
<span class="lineNum">    1879 </span><span class="lineCov">          9 :                 if (!pck) return GF_IO_ERR;</span>
<span class="lineNum">    1880 </span><span class="lineCov">          9 :                 memcpy(buffer, data, size);</span>
<span class="lineNum">    1881 </span><span class="lineCov">          9 :                 gf_filter_pck_set_framing(pck, is_first, GF_FALSE);</span>
<span class="lineNum">    1882 </span><span class="lineCov">          9 :                 gf_filter_pck_send(pck);</span>
<span class="lineNum">    1883 </span><span class="lineCov">          9 :                 return GF_OK;</span>
<span class="lineNum">    1884 </span>            :         }
<span class="lineNum">    1885 </span><span class="lineCov">        106 :         if (!sess-&gt;resource) {</span>
<span class="lineNum">    1886 </span>            :                 assert(0);
<span class="lineNum">    1887 </span>            :         }
<span class="lineNum">    1888 </span><span class="lineCov">        106 :         if (!sess-&gt;nb_ranges) {</span>
<span class="lineNum">    1889 </span><span class="lineCov">        106 :                 write = (u32) gf_fwrite(data, size, sess-&gt;resource);</span>
<span class="lineNum">    1890 </span><span class="lineCov">        106 :                 if (write != size) {</span>
<span class="lineNum">    1891 </span>            :                         return GF_IO_ERR;
<span class="lineNum">    1892 </span>            :                 }
<span class="lineNum">    1893 </span><span class="lineCov">        106 :                 gf_fflush(sess-&gt;resource);</span>
<span class="lineNum">    1894 </span><span class="lineCov">        106 :                 sess-&gt;nb_bytes += write;</span>
<span class="lineNum">    1895 </span><span class="lineCov">        106 :                 sess-&gt;file_pos += write;</span>
<span class="lineNum">    1896 </span><span class="lineCov">        106 :                 return GF_OK;</span>
<span class="lineNum">    1897 </span>            :         }
<span class="lineNum">    1898 </span>            :         remain = size;
<span class="lineNum">    1899 </span><span class="lineNoCov">          0 :         while (remain) {</span>
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :                 to_write = (u32) (sess-&gt;ranges[sess-&gt;range_idx].end + 1 - sess-&gt;file_pos);</span>
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 :                 if (to_write&gt;=remain) {</span>
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :                         write = (u32) gf_fwrite(data, remain, sess-&gt;resource);</span>
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :                         if (write != remain) {</span>
<span class="lineNum">    1904 </span>            :                                 return GF_IO_ERR;
<span class="lineNum">    1905 </span>            :                         }
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :                         gf_fflush(sess-&gt;resource);</span>
<span class="lineNum">    1907 </span><span class="lineNoCov">          0 :                         sess-&gt;nb_bytes += write;</span>
<span class="lineNum">    1908 </span><span class="lineNoCov">          0 :                         sess-&gt;file_pos += remain;</span>
<span class="lineNum">    1909 </span>            :                         remain = 0;
<span class="lineNum">    1910 </span>            :                         break;
<span class="lineNum">    1911 </span>            :                 }
<span class="lineNum">    1912 </span><span class="lineNoCov">          0 :                 write = (u32) gf_fwrite(data, to_write, sess-&gt;resource);</span>
<span class="lineNum">    1913 </span><span class="lineNoCov">          0 :                 sess-&gt;nb_bytes += write;</span>
<span class="lineNum">    1914 </span><span class="lineNoCov">          0 :                 remain -= to_write;</span>
<span class="lineNum">    1915 </span><span class="lineNoCov">          0 :                 sess-&gt;range_idx++;</span>
<span class="lineNum">    1916 </span><span class="lineNoCov">          0 :                 gf_fflush(sess-&gt;resource);</span>
<span class="lineNum">    1917 </span><span class="lineNoCov">          0 :                 if (sess-&gt;range_idx&gt;=sess-&gt;nb_ranges) break;</span>
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :                 sess-&gt;file_pos = sess-&gt;ranges[sess-&gt;range_idx].start;</span>
<span class="lineNum">    1919 </span><span class="lineNoCov">          0 :                 gf_fseek(sess-&gt;resource, sess-&gt;file_pos, SEEK_SET);</span>
<span class="lineNum">    1920 </span>            :         }
<span class="lineNum">    1921 </span><span class="lineNoCov">          0 :         if (remain) {</span>
<span class="lineNum">    1922 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Error in file upload, more bytes uploaded than described in byte range\n&quot;));</span>
<span class="lineNum">    1923 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    1924 </span>            :         }
<a name="1925"><span class="lineNum">    1925 </span>            :         return GF_OK;</a>
<span class="lineNum">    1926 </span>            : }
<span class="lineNum">    1927 </span><span class="lineCov">        153 : static void httpout_check_connection(GF_HTTPOutSession *sess)</span>
<span class="lineNum">    1928 </span>            : {
<span class="lineNum">    1929 </span><span class="lineCov">        153 :         GF_Err e = gf_sk_probe(sess-&gt;socket);</span>
<span class="lineNum">    1930 </span><span class="lineCov">        153 :         if (e==GF_IP_CONNECTION_CLOSED) {</span>
<span class="lineNum">    1931 </span><span class="lineCov">          1 :                 sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    1932 </span><span class="lineCov">          1 :                 sess-&gt;done = GF_TRUE;</span>
<span class="lineNum">    1933 </span><span class="lineCov">          1 :                 sess-&gt;canceled = GF_FALSE;</span>
<span class="lineNum">    1934 </span><span class="lineCov">          1 :                 sess-&gt;upload_type = 0;</span>
<span class="lineNum">    1935 </span><span class="lineCov">          1 :                 GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Client %s disconnected, destroying session\n&quot;, sess-&gt;peer_address));</span>
<span class="lineNum">    1936 </span><span class="lineCov">          1 :                 httpout_close_session(sess);</span>
<span class="lineNum">    1937 </span><span class="lineCov">          1 :                 return;</span>
<span class="lineNum">    1938 </span>            :         }
<a name="1939"><span class="lineNum">    1939 </span>            : }</a>
<span class="lineNum">    1940 </span>            : 
<span class="lineNum">    1941 </span><span class="lineCov">        209 : static void log_request_done(GF_HTTPOutSession *sess)</span>
<span class="lineNum">    1942 </span>            : {
<span class="lineNum">    1943 </span><span class="lineCov">        209 :         if (!sess-&gt;do_log) return;</span>
<span class="lineNum">    1944 </span><span class="lineCov">        167 :         const char *sprefix = sess-&gt;is_h2 ? &quot;H2 &quot; : &quot;&quot;;</span>
<span class="lineNum">    1945 </span>            : 
<span class="lineNum">    1946 </span><span class="lineCov">        167 :         if (!sess-&gt;socket) {</span>
<span class="lineNum">    1947 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_WARNING, GF_LOG_ALL, (&quot;[HTTPOut] %sREQ#&quot;LLU&quot; %s aborted!\n&quot;, sprefix, sess-&gt;req_id, get_method_name(sess-&gt;method_type)));</span>
<span class="lineNum">    1948 </span><span class="lineCov">        167 :         } else if (sess-&gt;canceled) {</span>
<span class="lineNum">    1949 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] %sREQ#&quot;LLU&quot; %s canceled\n&quot;, sprefix, sess-&gt;req_id, get_method_name(sess-&gt;method_type)));</span>
<span class="lineNum">    1950 </span>            :         } else {
<span class="lineNum">    1951 </span>            :                 char *unit = &quot;bps&quot;;
<span class="lineNum">    1952 </span><span class="lineCov">        167 :                 u64 diff_us = (gf_sys_clock_high_res() - sess-&gt;req_start_time);</span>
<span class="lineNum">    1953 </span><span class="lineCov">        167 :                 Double bps = (Double)sess-&gt;nb_bytes * 8000000;</span>
<span class="lineNum">    1954 </span><span class="lineCov">        167 :                 bps /= diff_us;</span>
<span class="lineNum">    1955 </span><span class="lineCov">        167 :                 if (bps&gt;1000000) {</span>
<span class="lineNum">    1956 </span>            :                         unit = &quot;mbps&quot;;
<span class="lineNum">    1957 </span><span class="lineCov">         54 :                         bps/=1000000;</span>
<span class="lineNum">    1958 </span><span class="lineCov">        113 :                 } else if (bps&gt;1000) {</span>
<span class="lineNum">    1959 </span>            :                         unit = &quot;kbps&quot;;
<span class="lineNum">    1960 </span><span class="lineCov">        113 :                         bps/=1000;</span>
<span class="lineNum">    1961 </span>            :                 }
<span class="lineNum">    1962 </span>            : #if 0
<span class="lineNum">    1963 </span>            :                 assert(sess-&gt;nb_bytes);
<span class="lineNum">    1964 </span>            :                 if (sess-&gt;nb_ranges) {
<span class="lineNum">    1965 </span>            :                         u32 i;
<span class="lineNum">    1966 </span>            :                         u64 tot_bytes = 0;
<span class="lineNum">    1967 </span>            :                         for (i=0; i&lt;sess-&gt;nb_ranges; i++) {
<span class="lineNum">    1968 </span>            :                                 tot_bytes += sess-&gt;ranges[i].end - sess-&gt;ranges[i].start + 1;
<span class="lineNum">    1969 </span>            :                         }
<span class="lineNum">    1970 </span>            :                         assert(tot_bytes==sess-&gt;nb_bytes);
<span class="lineNum">    1971 </span>            :                 }
<span class="lineNum">    1972 </span>            : #endif
<span class="lineNum">    1973 </span><span class="lineCov">        167 :                 GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] %sREQ#&quot;LLU&quot; %s done: reply %d - &quot;LLU&quot; bytes in %d ms at %g %s\n&quot;, sprefix, sess-&gt;req_id, get_method_name(sess-&gt;method_type), sess-&gt;reply_code, sess-&gt;nb_bytes, (u32) (diff_us/1000), bps, unit));</span>
<span class="lineNum">    1974 </span>            :         }
<a name="1975"><span class="lineNum">    1975 </span>            : }</a>
<span class="lineNum">    1976 </span>            : 
<span class="lineNum">    1977 </span><span class="lineCov">       1639 : static void httpout_process_session(GF_Filter *filter, GF_HTTPOutCtx *ctx, GF_HTTPOutSession *sess)</span>
<span class="lineNum">    1978 </span>            : {
<span class="lineNum">    1979 </span>            :         u32 read;
<span class="lineNum">    1980 </span>            :         u64 to_read=0;
<span class="lineNum">    1981 </span>            :         GF_Err e = GF_OK;
<span class="lineNum">    1982 </span><span class="lineCov">       1639 :         Bool close_session = ctx-&gt;close;</span>
<span class="lineNum">    1983 </span>            : 
<span class="lineNum">    1984 </span><span class="lineCov">       1639 :         if (sess-&gt;force_destroy) {</span>
<span class="lineNum">    1985 </span><span class="lineNoCov">          0 :                 httpout_close_session(sess);</span>
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1987 </span>            :         }
<span class="lineNum">    1988 </span>            : 
<span class="lineNum">    1989 </span>            : 
<span class="lineNum">    1990 </span>            :         //upload session (PUT, POST)
<span class="lineNum">    1991 </span><span class="lineCov">       1639 :         if (sess-&gt;upload_type) {</span>
<span class="lineNum">    1992 </span>            :                 u32 i, count;
<span class="lineNum">    1993 </span>            :                 GF_Err write_e=GF_OK;
<span class="lineNum">    1994 </span>            :                 assert(sess-&gt;path);
<span class="lineNum">    1995 </span><span class="lineCov">        277 :                 if (sess-&gt;done)</span>
<span class="lineNum">    1996 </span>            :                         return;
<span class="lineNum">    1997 </span>            : 
<span class="lineNum">    1998 </span><span class="lineCov">        277 :                 read = 0;</span>
<span class="lineNum">    1999 </span><span class="lineCov">        277 :                 if (sess-&gt;canceled) {</span>
<span class="lineNum">    2000 </span>            :                         e = GF_EOS;
<span class="lineNum">    2001 </span>            :                 } else {
<span class="lineNum">    2002 </span><span class="lineCov">        277 :                         e = gf_dm_sess_fetch_data(sess-&gt;http_sess, sess-&gt;buffer, ctx-&gt;block_size, &amp;read);</span>
<span class="lineNum">    2003 </span>            :                 }
<span class="lineNum">    2004 </span>            : 
<span class="lineNum">    2005 </span><span class="lineCov">        277 :                 if (e&gt;=GF_OK) {</span>
<span class="lineNum">    2006 </span><span class="lineCov">        124 :                         if (read)</span>
<span class="lineNum">    2007 </span><span class="lineCov">        115 :                                 write_e = httpout_sess_data_upload(sess, sess-&gt;buffer, read);</span>
<span class="lineNum">    2008 </span>            :                         else
<span class="lineNum">    2009 </span>            :                                 write_e = GF_OK;
<span class="lineNum">    2010 </span>            : 
<span class="lineNum">    2011 </span><span class="lineCov">        115 :                         if (!write_e) {</span>
<span class="lineNum">    2012 </span><span class="lineCov">        124 :                                 sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2013 </span>            :                                 //don't reschedule in upload, let server decide
<span class="lineNum">    2014 </span><span class="lineCov">        124 :                                 ctx-&gt;next_wake_us = 0;</span>
<span class="lineNum">    2015 </span>            :                                 //we way be in end of stream
<span class="lineNum">    2016 </span><span class="lineCov">        124 :                                 if (e==GF_OK)</span>
<span class="lineNum">    2017 </span>            :                                         return;
<span class="lineNum">    2018 </span>            :                         } else {
<span class="lineNum">    2019 </span>            :                                 e = write_e;
<span class="lineNum">    2020 </span>            :                         }
<span class="lineNum">    2021 </span><span class="lineCov">        153 :                 } else if (e==GF_IP_NETWORK_EMPTY) {</span>
<span class="lineNum">    2022 </span>            :                         //don't reschedule in upload, let server decide
<span class="lineNum">    2023 </span><span class="lineCov">        153 :                         ctx-&gt;next_wake_us = 0;</span>
<span class="lineNum">    2024 </span><span class="lineCov">        153 :                         sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2025 </span><span class="lineCov">        153 :                         httpout_check_connection(sess);</span>
<span class="lineNum">    2026 </span><span class="lineCov">        153 :                         return;</span>
<span class="lineNum">    2027 </span><span class="lineNoCov">          0 :                 } else if (e==GF_IP_CONNECTION_CLOSED) {</span>
<span class="lineNum">    2028 </span><span class="lineNoCov">          0 :                         sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2029 </span><span class="lineNoCov">          0 :                         sess-&gt;done = GF_TRUE;</span>
<span class="lineNum">    2030 </span><span class="lineNoCov">          0 :                         sess-&gt;canceled = GF_FALSE;</span>
<span class="lineNum">    2031 </span><span class="lineNoCov">          0 :                         sess-&gt;upload_type = 0;</span>
<span class="lineNum">    2032 </span><span class="lineNoCov">          0 :                         httpout_close_session(sess);</span>
<span class="lineNum">    2033 </span><span class="lineNoCov">          0 :                         log_request_done(sess);</span>
<span class="lineNum">    2034 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    2035 </span>            :                 }
<span class="lineNum">    2036 </span>            :                 //done (error or end of upload)
<span class="lineNum">    2037 </span><span class="lineCov">         25 :                 if (sess-&gt;opid) {</span>
<span class="lineNum">    2038 </span><span class="lineCov">          1 :                         GF_FilterPacket *pck = gf_filter_pck_new_alloc(sess-&gt;opid, 0, NULL);</span>
<span class="lineNum">    2039 </span><span class="lineCov">          1 :                         if (pck) {</span>
<span class="lineNum">    2040 </span><span class="lineCov">          1 :                                 gf_filter_pck_set_framing(pck, GF_FALSE, GF_TRUE);</span>
<span class="lineNum">    2041 </span><span class="lineCov">          1 :                                 if (sess-&gt;canceled)</span>
<span class="lineNum">    2042 </span><span class="lineNoCov">          0 :                                         gf_filter_pck_set_corrupted(pck, GF_TRUE);</span>
<span class="lineNum">    2043 </span>            : 
<span class="lineNum">    2044 </span><span class="lineCov">          1 :                                 gf_filter_pck_send(pck);</span>
<span class="lineNum">    2045 </span>            :                         }
<span class="lineNum">    2046 </span><span class="lineCov">          1 :                         gf_filter_pid_set_eos(sess-&gt;opid);</span>
<span class="lineNum">    2047 </span>            :                 } else {
<span class="lineNum">    2048 </span><span class="lineCov">         24 :                         if (sess-&gt;resource) gf_fclose(sess-&gt;resource);</span>
<span class="lineNum">    2049 </span><span class="lineCov">         24 :                         sess-&gt;resource = NULL;</span>
<span class="lineNum">    2050 </span>            :                         //for now we remove any canceled file
<span class="lineNum">    2051 </span><span class="lineCov">         24 :                         if (sess-&gt;canceled)</span>
<span class="lineNum">    2052 </span><span class="lineNoCov">          0 :                                 gf_file_delete(sess-&gt;path);</span>
<span class="lineNum">    2053 </span>            :                 }
<span class="lineNum">    2054 </span>            : 
<span class="lineNum">    2055 </span><span class="lineCov">         25 :                 if (sess-&gt;canceled) {</span>
<span class="lineNum">    2056 </span><span class="lineNoCov">          0 :                         log_request_done(sess);</span>
<span class="lineNum">    2057 </span>            :                 } else {
<span class="lineNum">    2058 </span>            :                         char szDate[200];
<span class="lineNum">    2059 </span>            : 
<span class="lineNum">    2060 </span><span class="lineCov">         25 :                         if (e==GF_EOS) {</span>
<span class="lineNum">    2061 </span><span class="lineCov">         25 :                                 if (sess-&gt;upload_type==2) {</span>
<span class="lineNum">    2062 </span><span class="lineCov">         16 :                                         sess-&gt;reply_code = 200;</span>
<span class="lineNum">    2063 </span>            :                                 } else {
<span class="lineNum">    2064 </span><span class="lineCov">          9 :                                         sess-&gt;reply_code = 201;</span>
<span class="lineNum">    2065 </span>            :                                 }
<span class="lineNum">    2066 </span><span class="lineNoCov">          0 :                         } else if (write_e==GF_BAD_PARAM) {</span>
<span class="lineNum">    2067 </span>            :                                 close_session = GF_TRUE;
<span class="lineNum">    2068 </span><span class="lineNoCov">          0 :                                 sess-&gt;reply_code = 416;</span>
<span class="lineNum">    2069 </span>            :                         } else {
<span class="lineNum">    2070 </span>            :                                 close_session = GF_TRUE;
<span class="lineNum">    2071 </span><span class="lineNoCov">          0 :                                 sess-&gt;reply_code = 500;</span>
<span class="lineNum">    2072 </span>            :                         }
<span class="lineNum">    2073 </span><span class="lineCov">         25 :                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Server&quot;, sess-&gt;ctx-&gt;user_agent);</span>
<span class="lineNum">    2074 </span>            : 
<span class="lineNum">    2075 </span><span class="lineCov">         25 :                         httpout_format_date(gf_net_get_utc(), szDate, GF_FALSE);</span>
<span class="lineNum">    2076 </span><span class="lineCov">         25 :                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Date&quot;, szDate);</span>
<span class="lineNum">    2077 </span>            : 
<span class="lineNum">    2078 </span><span class="lineCov">         25 :                         if (close_session)</span>
<span class="lineNum">    2079 </span><span class="lineNoCov">          0 :                                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Connection&quot;, &quot;close&quot;);</span>
<span class="lineNum">    2080 </span>            :                         else
<span class="lineNum">    2081 </span><span class="lineCov">         25 :                                 gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Connection&quot;, &quot;keep-alive&quot;);</span>
<span class="lineNum">    2082 </span>            : 
<span class="lineNum">    2083 </span><span class="lineCov">         25 :                         if (e==GF_EOS) {</span>
<span class="lineNum">    2084 </span><span class="lineCov">         25 :                                 if (ctx-&gt;hmode==MODE_SOURCE) {</span>
<span class="lineNum">    2085 </span><span class="lineCov">          1 :                                         char *loc = NULL;</span>
<span class="lineNum">    2086 </span><span class="lineCov">          1 :                                         gf_dynstrcat(&amp;loc, sess-&gt;path, &quot;/&quot;);</span>
<span class="lineNum">    2087 </span><span class="lineCov">          1 :                                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Content-Location&quot;, loc);</span>
<span class="lineNum">    2088 </span><span class="lineCov">          1 :                                         gf_free(loc);</span>
<span class="lineNum">    2089 </span>            :                                 } else {
<span class="lineNum">    2090 </span><span class="lineCov">         24 :                                         char *spath = strchr(sess-&gt;path, '/');</span>
<span class="lineNum">    2091 </span><span class="lineCov">         24 :                                         if (spath) spath = spath+1;</span>
<span class="lineNum">    2092 </span>            :                                         else spath = sess-&gt;path;
<span class="lineNum">    2093 </span>            : 
<span class="lineNum">    2094 </span><span class="lineCov">         24 :                                         if (ctx-&gt;wdir) {</span>
<span class="lineNum">    2095 </span><span class="lineCov">         24 :                                                 u32 plen = (u32) strlen(ctx-&gt;wdir);</span>
<span class="lineNum">    2096 </span><span class="lineCov">         24 :                                                 if ((ctx-&gt;wdir[plen-1] == '/') || (ctx-&gt;wdir[plen-1] == '\\'))</span>
<span class="lineNum">    2097 </span>            :                                                         plen--;
<span class="lineNum">    2098 </span><span class="lineCov">         24 :                                                 if (!strncmp(ctx-&gt;wdir, sess-&gt;path, plen))</span>
<span class="lineNum">    2099 </span><span class="lineCov">         24 :                                                         spath = sess-&gt;path + plen;</span>
<span class="lineNum">    2100 </span>            :                                         }
<span class="lineNum">    2101 </span>            : 
<span class="lineNum">    2102 </span><span class="lineCov">         24 :                                         gf_dm_sess_set_header(sess-&gt;http_sess, &quot;Content-Location&quot;, spath);</span>
<span class="lineNum">    2103 </span>            :                                 }
<span class="lineNum">    2104 </span>            :                         }
<span class="lineNum">    2105 </span>            : 
<span class="lineNum">    2106 </span><span class="lineCov">         25 :                         GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Sending PUT response to %s - reply %d\n&quot;, sess-&gt;peer_address, sess-&gt;reply_code));</span>
<span class="lineNum">    2107 </span>            : 
<span class="lineNum">    2108 </span><span class="lineCov">         25 :                         log_request_done(sess);</span>
<span class="lineNum">    2109 </span>            : 
<span class="lineNum">    2110 </span><span class="lineCov">         25 :                         gf_dm_sess_send_reply(sess-&gt;http_sess, sess-&gt;reply_code, NULL, GF_TRUE);</span>
<span class="lineNum">    2111 </span>            :                 }
<span class="lineNum">    2112 </span>            : 
<span class="lineNum">    2113 </span><span class="lineCov">         25 :                 sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2114 </span><span class="lineCov">         25 :                 sess-&gt;done = GF_TRUE;</span>
<span class="lineNum">    2115 </span><span class="lineCov">         25 :                 sess-&gt;canceled = GF_FALSE;</span>
<span class="lineNum">    2116 </span><span class="lineCov">         25 :                 sess-&gt;upload_type = 0;</span>
<span class="lineNum">    2117 </span><span class="lineCov">         25 :                 sess-&gt;nb_consecutive_errors = 0;</span>
<span class="lineNum">    2118 </span>            : 
<span class="lineNum">    2119 </span>            :                 //notify all download (GET, HEAD) sessions using the same resource that we are done
<span class="lineNum">    2120 </span><span class="lineCov">         25 :                 count = gf_list_count(sess-&gt;ctx-&gt;sessions);</span>
<span class="lineNum">    2121 </span><span class="lineCov">         72 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2122 </span><span class="lineCov">         47 :                         GF_HTTPOutSession *a_sess = gf_list_get(sess-&gt;ctx-&gt;sessions, i);</span>
<span class="lineNum">    2123 </span><span class="lineCov">         47 :                         if (a_sess == sess) continue;</span>
<span class="lineNum">    2124 </span><span class="lineCov">         22 :                         if (a_sess-&gt;done || !a_sess-&gt;put_in_progress) continue;</span>
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :                         if (a_sess-&gt;path &amp;&amp; sess-&gt;path &amp;&amp; !strcmp(a_sess-&gt;path, sess-&gt;path)) {</span>
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :                                 a_sess-&gt;put_in_progress = (sess-&gt;reply_code&gt;201) ? 2 : 0;</span>
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :                                 a_sess-&gt;file_size = gf_fsize(a_sess-&gt;resource);</span>
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 :                                 gf_fseek(a_sess-&gt;resource, a_sess-&gt;file_pos, SEEK_SET);</span>
<span class="lineNum">    2129 </span>            :                         }
<span class="lineNum">    2130 </span>            :                 }
<span class="lineNum">    2131 </span>            : 
<span class="lineNum">    2132 </span><span class="lineCov">         25 :                 if (close_session) {</span>
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :                         httpout_close_session(sess);</span>
<span class="lineNum">    2134 </span>            :                 } else {
<span class="lineNum">    2135 </span><span class="lineCov">         25 :                         gf_dm_sess_server_reset(sess-&gt;http_sess);</span>
<span class="lineNum">    2136 </span>            :                 }
<span class="lineNum">    2137 </span>            :                 return;
<span class="lineNum">    2138 </span>            :         }
<span class="lineNum">    2139 </span>            : 
<span class="lineNum">    2140 </span>            : 
<span class="lineNum">    2141 </span>            :         //other session: read incoming request and process headers
<span class="lineNum">    2142 </span><span class="lineCov">       1362 :         if (!sess-&gt;headers_done) {</span>
<span class="lineNum">    2143 </span>            :                 //check we have something to read if not http2
<span class="lineNum">    2144 </span>            :                 //if http2, data might have been received on this session while processing another session
<span class="lineNum">    2145 </span><span class="lineCov">       1185 :                 if (!sess-&gt;is_h2 &amp;&amp; !gf_sk_group_sock_is_set(ctx-&gt;sg, sess-&gt;socket, GF_SK_SELECT_READ)) {</span>
<span class="lineNum">    2146 </span>            :                         return;
<span class="lineNum">    2147 </span>            :                 }
<span class="lineNum">    2148 </span><span class="lineCov">        253 :                 e = gf_dm_sess_process(sess-&gt;http_sess);</span>
<span class="lineNum">    2149 </span>            : 
<span class="lineNum">    2150 </span><span class="lineCov">        253 :                 if (e==GF_IP_NETWORK_EMPTY) {</span>
<span class="lineNum">    2151 </span>            :                         return;
<span class="lineNum">    2152 </span>            :                 }
<span class="lineNum">    2153 </span>            : 
<span class="lineNum">    2154 </span><span class="lineCov">        253 :                 if (e&lt;0) {</span>
<span class="lineNum">    2155 </span><span class="lineCov">         37 :                         GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Connection to %s closed: %s\n&quot;, sess-&gt;peer_address, gf_error_to_string(e) ));</span>
<span class="lineNum">    2156 </span><span class="lineCov">         37 :                         httpout_close_session(sess);</span>
<span class="lineNum">    2157 </span><span class="lineCov">         37 :                         if (!sess-&gt;done)</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :                                 log_request_done(sess);</span>
<span class="lineNum">    2159 </span>            :                         return;
<span class="lineNum">    2160 </span>            :                 }
<span class="lineNum">    2161 </span>            : 
<span class="lineNum">    2162 </span><span class="lineCov">        216 :                 sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2163 </span>            :                 //reschedule asap
<span class="lineNum">    2164 </span><span class="lineCov">        216 :                 ctx-&gt;next_wake_us = 1;</span>
<span class="lineNum">    2165 </span>            : 
<span class="lineNum">    2166 </span>            :                 //request has been process, if not an upload we don't need the session anymore
<span class="lineNum">    2167 </span>            :                 //otherwise we use the session to parse transfered data
<span class="lineNum">    2168 </span><span class="lineCov">        216 :                 if (!sess-&gt;upload_type) {</span>
<span class="lineNum">    2169 </span><span class="lineCov">        188 :                         sess-&gt;headers_done = GF_TRUE;</span>
<span class="lineNum">    2170 </span>            : 
<span class="lineNum">    2171 </span><span class="lineCov">        188 :                         if (sess-&gt;done)</span>
<span class="lineNum">    2172 </span>            :                                 goto session_done;
<span class="lineNum">    2173 </span>            :                 } else {
<span class="lineNum">    2174 </span>            :                         //flush any data received
<span class="lineNum">    2175 </span><span class="lineCov">         28 :                         httpout_process_session(filter, ctx, sess);</span>
<span class="lineNum">    2176 </span><span class="lineCov">         28 :                         return;</span>
<span class="lineNum">    2177 </span>            :                 }
<span class="lineNum">    2178 </span>            :         }
<span class="lineNum">    2179 </span><span class="lineCov">        361 :         if (!sess-&gt;http_sess) return;</span>
<span class="lineNum">    2180 </span>            : 
<span class="lineNum">    2181 </span>            :         //H2 session, keep on processing inputs
<span class="lineNum">    2182 </span><span class="lineCov">        361 :         if (sess-&gt;is_h2 &amp;&amp; gf_sk_group_sock_is_set(ctx-&gt;sg, sess-&gt;socket, GF_SK_SELECT_READ)) {</span>
<span class="lineNum">    2183 </span><span class="lineNoCov">          0 :                 gf_dm_sess_process(sess-&gt;http_sess);</span>
<span class="lineNum">    2184 </span>            :         }
<span class="lineNum">    2185 </span>            : 
<span class="lineNum">    2186 </span><span class="lineCov">        361 :         if (sess-&gt;done) return;</span>
<span class="lineNum">    2187 </span>            :         //associated input directly writes to session
<span class="lineNum">    2188 </span><span class="lineCov">        361 :         if (sess-&gt;in_source &amp;&amp; !sess-&gt;in_source-&gt;resource) return;</span>
<span class="lineNum">    2189 </span>            : 
<span class="lineNum">    2190 </span><span class="lineCov">        359 :         if (sess-&gt;canceled) {</span>
<span class="lineNum">    2191 </span><span class="lineNoCov">          0 :                 log_request_done(sess);</span>
<span class="lineNum">    2192 </span><span class="lineNoCov">          0 :                 goto session_done;</span>
<span class="lineNum">    2193 </span>            :         }
<span class="lineNum">    2194 </span>            : 
<span class="lineNum">    2195 </span><span class="lineCov">        359 :         if (!gf_sk_group_sock_is_set(ctx-&gt;sg, sess-&gt;socket, GF_SK_SELECT_WRITE)) {</span>
<span class="lineNum">    2196 </span>            :                 return;
<span class="lineNum">    2197 </span>            :         }
<span class="lineNum">    2198 </span>            :         //resource is not set
<span class="lineNum">    2199 </span><span class="lineCov">        358 :         if (!sess-&gt;resource &amp;&amp; sess-&gt;path) {</span>
<span class="lineNum">    2200 </span><span class="lineNoCov">          0 :                 if (sess-&gt;in_source &amp;&amp; !sess-&gt;in_source-&gt;nb_write) {</span>
<span class="lineNum">    2201 </span><span class="lineNoCov">          0 :                         sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2202 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    2203 </span>            :                 }
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :                 sess-&gt;resource = gf_fopen(sess-&gt;path, &quot;rb&quot;);</span>
<span class="lineNum">    2205 </span><span class="lineNoCov">          0 :                 if (!sess-&gt;resource) return;</span>
<span class="lineNum">    2206 </span><span class="lineNoCov">          0 :                 sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2207 </span><span class="lineNoCov">          0 :                 gf_fseek(sess-&gt;resource, sess-&gt;file_pos, SEEK_SET);</span>
<span class="lineNum">    2208 </span>            :         }
<span class="lineNum">    2209 </span>            : 
<span class="lineNum">    2210 </span>            :         //refresh file size
<span class="lineNum">    2211 </span><span class="lineCov">        358 :         if (sess-&gt;put_in_progress==1) {</span>
<span class="lineNum">    2212 </span><span class="lineNoCov">          0 :                 sess-&gt;file_size = gf_fsize(sess-&gt;resource);</span>
<span class="lineNum">    2213 </span><span class="lineNoCov">          0 :                 gf_fseek(sess-&gt;resource, sess-&gt;file_pos, SEEK_SET);</span>
<span class="lineNum">    2214 </span>            :         }
<span class="lineNum">    2215 </span>            : 
<span class="lineNum">    2216 </span><span class="lineCov">        655 : resend:</span>
<span class="lineNum">    2217 </span>            : 
<span class="lineNum">    2218 </span>            :         //we have ranges
<span class="lineNum">    2219 </span><span class="lineCov">        655 :         if (sess-&gt;nb_ranges) {</span>
<span class="lineNum">    2220 </span>            :                 //current range is done
<span class="lineNum">    2221 </span><span class="lineCov">         72 :                 if ((s64) sess-&gt;file_pos &gt;= sess-&gt;ranges[sess-&gt;range_idx].end) {</span>
<span class="lineNum">    2222 </span>            :                         //load next range, seeking file
<span class="lineNum">    2223 </span><span class="lineCov">         30 :                         if (sess-&gt;range_idx+1&lt;sess-&gt;nb_ranges) {</span>
<span class="lineNum">    2224 </span><span class="lineNoCov">          0 :                                 sess-&gt;range_idx++;</span>
<span class="lineNum">    2225 </span><span class="lineNoCov">          0 :                                 sess-&gt;file_pos = (u64) sess-&gt;ranges[sess-&gt;range_idx].start;</span>
<span class="lineNum">    2226 </span><span class="lineNoCov">          0 :                                 gf_fseek(sess-&gt;resource, sess-&gt;file_pos, SEEK_SET);</span>
<span class="lineNum">    2227 </span>            :                         }
<span class="lineNum">    2228 </span>            :                 }
<span class="lineNum">    2229 </span><span class="lineCov">         72 :                 if (sess-&gt;range_idx&lt;sess-&gt;nb_ranges) {</span>
<span class="lineNum">    2230 </span><span class="lineCov">         72 :                         to_read = sess-&gt;ranges[sess-&gt;range_idx].end + 1 - sess-&gt;file_pos;</span>
<span class="lineNum">    2231 </span>            :                 }
<span class="lineNum">    2232 </span><span class="lineCov">        583 :         } else if (sess-&gt;file_pos &lt; sess-&gt;file_size) {</span>
<span class="lineNum">    2233 </span><span class="lineCov">        260 :                 to_read = sess-&gt;file_size - sess-&gt;file_pos;</span>
<span class="lineNum">    2234 </span>            :         }
<span class="lineNum">    2235 </span>            : 
<span class="lineNum">    2236 </span><span class="lineCov">        655 :         if (to_read) {</span>
<span class="lineNum">    2237 </span>            :                 //rescedule asap while we send
<span class="lineNum">    2238 </span><span class="lineCov">        473 :                 ctx-&gt;next_wake_us = 1;</span>
<span class="lineNum">    2239 </span>            : 
<span class="lineNum">    2240 </span><span class="lineCov">        473 :                 if (to_read &gt; (u64) sess-&gt;ctx-&gt;block_size)</span>
<span class="lineNum">    2241 </span>            :                         to_read = (u64) sess-&gt;ctx-&gt;block_size;
<span class="lineNum">    2242 </span>            : 
<span class="lineNum">    2243 </span><span class="lineCov">        473 :                 read = (u32) gf_fread(sess-&gt;buffer, (u32) to_read, sess-&gt;resource);</span>
<span class="lineNum">    2244 </span>            :                 //may happen when file writing is in progress
<span class="lineNum">    2245 </span><span class="lineCov">        473 :                 if (!read) {</span>
<span class="lineNum">    2246 </span><span class="lineCov">        172 :                         sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2247 </span><span class="lineCov">        172 :                         return;</span>
<span class="lineNum">    2248 </span>            :                 }
<span class="lineNum">    2249 </span>            :                 //transfer of file being uploaded, use chunk transfer
<span class="lineNum">    2250 </span><span class="lineCov">        400 :                 if (!sess-&gt;is_h2 &amp;&amp; sess-&gt;use_chunk_transfer) {</span>
<span class="lineNum">    2251 </span>            :                         char szHdr[100];
<span class="lineNum">    2252 </span>            :                         u32 len;
<span class="lineNum">    2253 </span>            :                         sprintf(szHdr, &quot;%X\r\n&quot;, read);
<span class="lineNum">    2254 </span><span class="lineCov">         99 :                         len = (u32) strlen(szHdr);</span>
<span class="lineNum">    2255 </span>            : 
<span class="lineNum">    2256 </span><span class="lineCov">         99 :                         e = gf_dm_sess_send(sess-&gt;http_sess, szHdr, len);</span>
<span class="lineNum">    2257 </span><span class="lineCov">         99 :                         e |= gf_dm_sess_send(sess-&gt;http_sess, sess-&gt;buffer, read);</span>
<span class="lineNum">    2258 </span><span class="lineCov">         99 :                         e |= gf_dm_sess_send(sess-&gt;http_sess, &quot;\r\n&quot;, 2);</span>
<span class="lineNum">    2259 </span>            :                 } else {
<span class="lineNum">    2260 </span><span class="lineCov">        202 :                         e = gf_dm_sess_send(sess-&gt;http_sess, sess-&gt;buffer, read);</span>
<span class="lineNum">    2261 </span>            :                 }
<span class="lineNum">    2262 </span><span class="lineCov">        301 :                 sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2263 </span>            : 
<span class="lineNum">    2264 </span><span class="lineCov">        301 :                 sess-&gt;file_pos += read;</span>
<span class="lineNum">    2265 </span><span class="lineCov">        301 :                 sess-&gt;nb_bytes += read;</span>
<span class="lineNum">    2266 </span>            : 
<span class="lineNum">    2267 </span><span class="lineCov">        301 :                 if (e) {</span>
<span class="lineNum">    2268 </span><span class="lineCov">          1 :                         if (e==GF_IP_CONNECTION_CLOSED) {</span>
<span class="lineNum">    2269 </span><span class="lineCov">          1 :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_HTTP, (&quot;[HTTPOut] Connection to %s for %s closed\n&quot;, sess-&gt;peer_address, sess-&gt;path));</span>
<span class="lineNum">    2270 </span><span class="lineCov">          1 :                                 sess-&gt;done = GF_TRUE;</span>
<span class="lineNum">    2271 </span><span class="lineCov">          1 :                                 sess-&gt;canceled = GF_FALSE;</span>
<span class="lineNum">    2272 </span><span class="lineCov">          1 :                                 httpout_close_session(sess);</span>
<span class="lineNum">    2273 </span><span class="lineCov">          1 :                                 log_request_done(sess);</span>
<span class="lineNum">    2274 </span><span class="lineCov">          1 :                                 return;</span>
<span class="lineNum">    2275 </span>            :                         }
<span class="lineNum">    2276 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Error sending data to %s for %s: %s\n&quot;, sess-&gt;peer_address, sess-&gt;path, gf_error_to_string(e) ));</span>
<span class="lineNum">    2277 </span>            :                 } else {
<span class="lineNum">    2278 </span><span class="lineCov">        300 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_HTTP, (&quot;[HTTPOut] sending data to %s for %s: &quot;LLU&quot;/&quot;LLU&quot; bytes\n&quot;, sess-&gt;peer_address, sess-&gt;path, sess-&gt;nb_bytes, sess-&gt;bytes_in_req));</span>
<span class="lineNum">    2279 </span>            : 
<span class="lineNum">    2280 </span><span class="lineCov">        300 :                         if (gf_sk_select(sess-&gt;socket, GF_SK_SELECT_WRITE)==GF_OK) {</span>
<span class="lineNum">    2281 </span>            :                                 goto resend;
<span class="lineNum">    2282 </span>            :                         }
<span class="lineNum">    2283 </span>            :                 }
<span class="lineNum">    2284 </span>            :                 return;
<span class="lineNum">    2285 </span>            :         }
<span class="lineNum">    2286 </span>            :         //file not done yet ...
<span class="lineNum">    2287 </span><span class="lineCov">        182 :         if (sess-&gt;file_in_progress || (sess-&gt;put_in_progress==1)) {</span>
<span class="lineNum">    2288 </span><span class="lineNoCov">          0 :                 sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2289 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    2290 </span>            :         }
<span class="lineNum">    2291 </span>            : 
<span class="lineNum">    2292 </span><span class="lineCov">        186 : session_done:</span>
<span class="lineNum">    2293 </span>            : 
<span class="lineNum">    2294 </span><span class="lineCov">        186 :         sess-&gt;file_pos = sess-&gt;file_size;</span>
<span class="lineNum">    2295 </span><span class="lineCov">        186 :         sess-&gt;last_active_time = gf_sys_clock_high_res();</span>
<span class="lineNum">    2296 </span>            : 
<span class="lineNum">    2297 </span>            :         //an error ocured uploading the resource, we cannot notify that error so we force a close...
<span class="lineNum">    2298 </span><span class="lineCov">        186 :         if (sess-&gt;put_in_progress==2)</span>
<span class="lineNum">    2299 </span>            :                 close_session = GF_TRUE;
<span class="lineNum">    2300 </span>            : 
<span class="lineNum">    2301 </span><span class="lineCov">        186 :         if (ctx-&gt;quit)</span>
<span class="lineNum">    2302 </span>            :                 close_session = GF_TRUE;
<span class="lineNum">    2303 </span>            : 
<span class="lineNum">    2304 </span><span class="lineCov">        186 :         if (!sess-&gt;done) {</span>
<span class="lineNum">    2305 </span><span class="lineCov">        182 :                 if (!sess-&gt;is_h2 &amp;&amp; sess-&gt;use_chunk_transfer) {</span>
<span class="lineNum">    2306 </span>            :                         assert(sess-&gt;nb_bytes);
<span class="lineNum">    2307 </span><span class="lineCov">         20 :                         gf_dm_sess_send(sess-&gt;http_sess, &quot;0\r\n\r\n&quot;, 5);</span>
<span class="lineNum">    2308 </span>            :                 } else {
<span class="lineNum">    2309 </span><span class="lineCov">        162 :                         gf_dm_sess_send(sess-&gt;http_sess, NULL, 0);</span>
<span class="lineNum">    2310 </span>            :                 }
<span class="lineNum">    2311 </span><span class="lineCov">        182 :                 if (sess-&gt;resource) gf_fclose(sess-&gt;resource);</span>
<span class="lineNum">    2312 </span><span class="lineCov">        182 :                 sess-&gt;resource = NULL;</span>
<span class="lineNum">    2313 </span>            : 
<span class="lineNum">    2314 </span><span class="lineCov">        182 :                 if (sess-&gt;nb_bytes) {</span>
<span class="lineNum">    2315 </span><span class="lineCov">        182 :                         GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Done sending %s to %s (&quot;LLU&quot;/&quot;LLU&quot; bytes)\n&quot;, sess-&gt;path, sess-&gt;peer_address, sess-&gt;nb_bytes, sess-&gt;bytes_in_req));</span>
<span class="lineNum">    2316 </span>            :                 }
<span class="lineNum">    2317 </span>            : 
<span class="lineNum">    2318 </span><span class="lineCov">        182 :                 log_request_done(sess);</span>
<span class="lineNum">    2319 </span>            : 
<span class="lineNum">    2320 </span>            :                 //keep resource active
<span class="lineNum">    2321 </span><span class="lineCov">        182 :                 sess-&gt;done = GF_TRUE;</span>
<span class="lineNum">    2322 </span><span class="lineCov">        182 :                 sess-&gt;canceled = GF_FALSE;</span>
<span class="lineNum">    2323 </span>            : 
<span class="lineNum">    2324 </span>            :         }
<span class="lineNum">    2325 </span><span class="lineCov">        186 :         if (close_session) {</span>
<span class="lineNum">    2326 </span><span class="lineCov">          4 :                 httpout_close_session(sess);</span>
<span class="lineNum">    2327 </span>            :         }
<span class="lineNum">    2328 </span>            :         //might be NULL if quit was set
<span class="lineNum">    2329 </span><span class="lineCov">        182 :         else if (sess-&gt;http_sess) {</span>
<span class="lineNum">    2330 </span><span class="lineCov">        182 :                 sess-&gt;headers_done = GF_FALSE;</span>
<span class="lineNum">    2331 </span><span class="lineCov">        182 :                 gf_dm_sess_server_reset(sess-&gt;http_sess);</span>
<span class="lineNum">    2332 </span>            :         }
<a name="2333"><span class="lineNum">    2333 </span>            : }</a>
<span class="lineNum">    2334 </span>            : 
<span class="lineNum">    2335 </span><span class="lineCov">        691 : static Bool httpout_open_input(GF_HTTPOutCtx *ctx, GF_HTTPOutInput *in, const char *name, Bool is_delete)</span>
<span class="lineNum">    2336 </span>            : {
<span class="lineNum">    2337 </span>            : //      Bool reassign_clients = GF_TRUE;
<span class="lineNum">    2338 </span>            :         u32 len = 0;
<span class="lineNum">    2339 </span><span class="lineCov">        691 :     char *o_url = NULL;</span>
<span class="lineNum">    2340 </span>            :     const char *dir = NULL;
<span class="lineNum">    2341 </span>            :     const char *sep;
<span class="lineNum">    2342 </span>            : 
<span class="lineNum">    2343 </span><span class="lineCov">        691 :     if (in-&gt;is_open &amp;&amp; !is_delete) return GF_FALSE;</span>
<span class="lineNum">    2344 </span><span class="lineCov">        691 :     if (!in-&gt;upload) {</span>
<span class="lineNum">    2345 </span>            :         //singe session mode, not recording, nothing to do
<span class="lineNum">    2346 </span><span class="lineCov">        661 :         if (ctx-&gt;single_mode) {</span>
<span class="lineNum">    2347 </span><span class="lineCov">          1 :                         in-&gt;done = GF_FALSE;</span>
<span class="lineNum">    2348 </span><span class="lineCov">          1 :                         in-&gt;is_open = GF_TRUE;</span>
<span class="lineNum">    2349 </span><span class="lineCov">          1 :                         return GF_FALSE;</span>
<span class="lineNum">    2350 </span>            :                 }
<span class="lineNum">    2351 </span>            :         //server mode not recording, nothing to do
<span class="lineNum">    2352 </span><span class="lineCov">        660 :                 if (!ctx-&gt;rdirs.nb_items) return GF_FALSE;</span>
<span class="lineNum">    2353 </span><span class="lineCov">        660 :                 dir = ctx-&gt;rdirs.vals[0];</span>
<span class="lineNum">    2354 </span><span class="lineCov">        660 :                 if (!dir) return GF_FALSE;</span>
<span class="lineNum">    2355 </span><span class="lineCov">        660 :                 len = (u32) strlen(dir);</span>
<span class="lineNum">    2356 </span><span class="lineCov">        660 :                 if (!len) return GF_FALSE;</span>
<span class="lineNum">    2357 </span>            : 
<span class="lineNum">    2358 </span><span class="lineCov">        660 :         if (in-&gt;resource) return GF_FALSE;</span>
<span class="lineNum">    2359 </span>            :     }
<span class="lineNum">    2360 </span>            : 
<span class="lineNum">    2361 </span><span class="lineCov">        690 :     sep = name ? strstr(name, &quot;://&quot;) : NULL;</span>
<span class="lineNum">    2362 </span><span class="lineCov">        690 :     if (sep) sep = strchr(sep+3, '/');</span>
<span class="lineNum">    2363 </span><span class="lineCov">        690 :         if (!sep) {</span>
<span class="lineNum">    2364 </span><span class="lineCov">          7 :         if (in-&gt;force_dst_name) {</span>
<span class="lineNum">    2365 </span><span class="lineCov">          1 :             sep = in-&gt;path;</span>
<span class="lineNum">    2366 </span><span class="lineCov">          6 :         } else if (ctx-&gt;dst) {</span>
<span class="lineNum">    2367 </span><span class="lineCov">          6 :             u32 i, count = gf_list_count(ctx-&gt;inputs);</span>
<span class="lineNum">    2368 </span><span class="lineCov">          6 :             for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2369 </span>            :                 char *path_sep;
<span class="lineNum">    2370 </span><span class="lineCov">          6 :                 GF_HTTPOutInput *an_in = gf_list_get(ctx-&gt;inputs, i);</span>
<span class="lineNum">    2371 </span><span class="lineCov">          6 :                 if (an_in==in) continue;</span>
<span class="lineNum">    2372 </span><span class="lineCov">          6 :                 if (!an_in-&gt;path) continue;</span>
<span class="lineNum">    2373 </span><span class="lineCov">          6 :                 if (ctx-&gt;dst &amp;&amp; !an_in-&gt;force_dst_name) continue;</span>
<span class="lineNum">    2374 </span><span class="lineCov">          6 :                 if (!gf_filter_pid_share_origin(in-&gt;ipid, an_in-&gt;ipid))</span>
<span class="lineNum">    2375 </span><span class="lineNoCov">          0 :                     continue;</span>
<span class="lineNum">    2376 </span>            :                 
<span class="lineNum">    2377 </span><span class="lineCov">          6 :                 o_url = gf_strdup(an_in-&gt;path);</span>
<span class="lineNum">    2378 </span><span class="lineCov">          6 :                 path_sep = strrchr(o_url, '/');</span>
<span class="lineNum">    2379 </span><span class="lineCov">          6 :                 if (path_sep) {</span>
<span class="lineNum">    2380 </span><span class="lineCov">          6 :                     path_sep[1] = 0;</span>
<span class="lineNum">    2381 </span><span class="lineCov">          6 :                     gf_dynstrcat(&amp;o_url, name, NULL);</span>
<span class="lineNum">    2382 </span><span class="lineCov">          6 :                     sep = o_url;</span>
<span class="lineNum">    2383 </span>            :                 } else {
<span class="lineNum">    2384 </span>            :                     sep = name;
<span class="lineNum">    2385 </span>            :                 }
<span class="lineNum">    2386 </span>            :                 break;
<span class="lineNum">    2387 </span>            :             }
<span class="lineNum">    2388 </span>            :                 } else {
<span class="lineNum">    2389 </span>            :                         sep = name;
<span class="lineNum">    2390 </span>            :                 }
<span class="lineNum">    2391 </span><span class="lineCov">          7 :                 if (sep &amp;&amp; (sep[0] != '/')) {</span>
<span class="lineNum">    2392 </span><span class="lineNoCov">          0 :                         char *new_url = NULL;</span>
<span class="lineNum">    2393 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;new_url, &quot;/&quot;, NULL);</span>
<span class="lineNum">    2394 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;new_url, sep, NULL);</span>
<span class="lineNum">    2395 </span><span class="lineNoCov">          0 :                         if (o_url) gf_free(o_url);</span>
<span class="lineNum">    2396 </span><span class="lineNoCov">          0 :                         sep = o_url = new_url;</span>
<span class="lineNum">    2397 </span>            :                 }
<span class="lineNum">    2398 </span>            :     }
<span class="lineNum">    2399 </span><span class="lineCov">        690 :     if (!sep) {</span>
<span class="lineNum">    2400 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] %s output file %s but cannot guess path !\n&quot;, is_delete ? &quot;Deleting&quot; : &quot;Opening&quot;,  name));</span>
<span class="lineNum">    2401 </span>            :                 return GF_FALSE;
<span class="lineNum">    2402 </span>            :         }
<span class="lineNum">    2403 </span>            : 
<span class="lineNum">    2404 </span><span class="lineCov">        690 :         GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] %s output file %s\n&quot;, is_delete ? &quot;Deleting&quot; : &quot;Opening&quot;,  name));</span>
<span class="lineNum">    2405 </span><span class="lineCov">        690 :         if (in-&gt;upload) {</span>
<span class="lineNum">    2406 </span>            :                 GF_Err e;
<span class="lineNum">    2407 </span><span class="lineCov">         30 :                 in-&gt;done = GF_FALSE;</span>
<span class="lineNum">    2408 </span><span class="lineCov">         30 :                 in-&gt;is_open = GF_TRUE;</span>
<span class="lineNum">    2409 </span>            : 
<span class="lineNum">    2410 </span><span class="lineCov">         30 :                 in-&gt;is_delete = is_delete;</span>
<span class="lineNum">    2411 </span><span class="lineCov">         30 :                 if (!in-&gt;force_dst_name) {</span>
<span class="lineNum">    2412 </span><span class="lineCov">         17 :                         char *old = in-&gt;path;</span>
<span class="lineNum">    2413 </span><span class="lineCov">         17 :                         in-&gt;path = gf_strdup(sep);</span>
<span class="lineNum">    2414 </span><span class="lineCov">         17 :                         if (old) gf_free(old);</span>
<span class="lineNum">    2415 </span>            :                 }
<span class="lineNum">    2416 </span><span class="lineCov">         30 :                 if (o_url) gf_free(o_url);</span>
<span class="lineNum">    2417 </span>            :                 
<span class="lineNum">    2418 </span><span class="lineCov">         30 :                 e = gf_dm_sess_setup_from_url(in-&gt;upload, in-&gt;path, GF_TRUE);</span>
<span class="lineNum">    2419 </span><span class="lineCov">         30 :                 if (!e) {</span>
<span class="lineNum">    2420 </span><span class="lineCov">         30 :                         in-&gt;cur_header = 0;</span>
<span class="lineNum">    2421 </span><span class="lineCov">         30 :                         e = gf_dm_sess_process(in-&gt;upload);</span>
<span class="lineNum">    2422 </span>            :                 }
<span class="lineNum">    2423 </span>            : 
<span class="lineNum">    2424 </span><span class="lineCov">         30 :                 if (e) {</span>
<span class="lineNum">    2425 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Failed to open output file %s: %s\n&quot;, in-&gt;path, gf_error_to_string(e) ));</span>
<span class="lineNum">    2426 </span><span class="lineNoCov">          0 :                         in-&gt;is_open = GF_FALSE;</span>
<span class="lineNum">    2427 </span><span class="lineNoCov">          0 :                         return GF_FALSE;</span>
<span class="lineNum">    2428 </span>            :                 }
<span class="lineNum">    2429 </span><span class="lineCov">         30 :                 in-&gt;is_h2 = gf_dm_sess_is_h2(in-&gt;upload);</span>
<span class="lineNum">    2430 </span>            : 
<span class="lineNum">    2431 </span><span class="lineCov">         30 :                 if (is_delete) {</span>
<span class="lineNum">    2432 </span>            :                         //get response
<span class="lineNum">    2433 </span><span class="lineCov">          2 :                         gf_dm_sess_process(in-&gt;upload);</span>
<span class="lineNum">    2434 </span><span class="lineCov">          2 :                         in-&gt;done = GF_TRUE;</span>
<span class="lineNum">    2435 </span><span class="lineCov">          2 :                         in-&gt;is_open = GF_FALSE;</span>
<span class="lineNum">    2436 </span><span class="lineCov">          2 :                         in-&gt;is_delete = GF_FALSE;</span>
<span class="lineNum">    2437 </span>            :                 }
<span class="lineNum">    2438 </span>            :                 return GF_TRUE;
<span class="lineNum">    2439 </span>            :         }
<span class="lineNum">    2440 </span>            : 
<span class="lineNum">    2441 </span><span class="lineCov">        660 :         if (ctx-&gt;log_record) {</span>
<span class="lineNum">    2442 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] %s output file %s\n&quot;, is_delete ? &quot;Deleting&quot; : &quot;Opening&quot;,  name));</span>
<span class="lineNum">    2443 </span>            :         }
<span class="lineNum">    2444 </span>            : 
<span class="lineNum">    2445 </span>            :         //file delete is async (the resource associated with the input can still be active)
<span class="lineNum">    2446 </span><span class="lineCov">        660 :         if (is_delete) {</span>
<span class="lineNum">    2447 </span><span class="lineCov">         20 :                 char *loc_path = NULL;</span>
<span class="lineNum">    2448 </span><span class="lineCov">         20 :                 gf_dynstrcat(&amp;loc_path, dir, NULL);</span>
<span class="lineNum">    2449 </span><span class="lineCov">         20 :                 if (!strchr(&quot;/\\&quot;, dir[len-1]))</span>
<span class="lineNum">    2450 </span><span class="lineCov">         20 :                         gf_dynstrcat(&amp;loc_path, &quot;/&quot;, NULL);</span>
<span class="lineNum">    2451 </span><span class="lineCov">         20 :                 if (sep[0]=='/')</span>
<span class="lineNum">    2452 </span><span class="lineCov">         20 :                         gf_dynstrcat(&amp;loc_path, sep+1, NULL);</span>
<span class="lineNum">    2453 </span>            :                 else
<span class="lineNum">    2454 </span><span class="lineNoCov">          0 :                         gf_dynstrcat(&amp;loc_path, sep, NULL);</span>
<span class="lineNum">    2455 </span>            : 
<span class="lineNum">    2456 </span><span class="lineCov">         20 :                 gf_file_delete(loc_path);</span>
<span class="lineNum">    2457 </span><span class="lineCov">         20 :                 if (o_url) gf_free(o_url);</span>
<span class="lineNum">    2458 </span><span class="lineCov">         20 :                 gf_free(loc_path);</span>
<span class="lineNum">    2459 </span>            :                 return GF_TRUE;
<span class="lineNum">    2460 </span>            :         }
<span class="lineNum">    2461 </span>            : 
<span class="lineNum">    2462 </span><span class="lineCov">        640 :         in-&gt;done = GF_FALSE;</span>
<span class="lineNum">    2463 </span><span class="lineCov">        640 :         in-&gt;is_open = GF_TRUE;</span>
<span class="lineNum">    2464 </span>            : 
<span class="lineNum">    2465 </span>            : 
<span class="lineNum">    2466 </span><span class="lineCov">        640 :         if (in-&gt;path &amp;&amp; !strcmp(in-&gt;path, sep)) {</span>
<span class="lineNum">    2467 </span>            : //              reassign_clients = GF_FALSE;
<span class="lineNum">    2468 </span>            :         } else {
<span class="lineNum">    2469 </span><span class="lineCov">        584 :                 if (in-&gt;path) gf_free(in-&gt;path);</span>
<span class="lineNum">    2470 </span><span class="lineCov">        584 :                 in-&gt;path = gf_strdup(sep);</span>
<span class="lineNum">    2471 </span>            :         }
<span class="lineNum">    2472 </span><span class="lineCov">        640 :     if (o_url) gf_free(o_url);</span>
<span class="lineNum">    2473 </span>            : 
<span class="lineNum">    2474 </span><span class="lineCov">        640 :         httpout_set_local_path(ctx, in);</span>
<span class="lineNum">    2475 </span>            : 
<span class="lineNum">    2476 </span><span class="lineCov">        640 :         in-&gt;resource = gf_fopen(in-&gt;local_path, &quot;wb&quot;);</span>
<span class="lineNum">    2477 </span><span class="lineCov">        640 :         if (!in-&gt;resource)</span>
<span class="lineNum">    2478 </span><span class="lineNoCov">          0 :                 in-&gt;is_open = GF_FALSE;</span>
<span class="lineNum">    2479 </span>            :         return GF_TRUE;
<a name="2480"><span class="lineNum">    2480 </span>            : }</a>
<span class="lineNum">    2481 </span>            : 
<span class="lineNum">    2482 </span><span class="lineCov">       1063 : static void httpout_close_input(GF_HTTPOutCtx *ctx, GF_HTTPOutInput *in)</span>
<span class="lineNum">    2483 </span>            : {
<span class="lineNum">    2484 </span><span class="lineCov">       1063 :         if (!in-&gt;is_open) return;</span>
<span class="lineNum">    2485 </span><span class="lineCov">        669 :         in-&gt;is_open = GF_FALSE;</span>
<span class="lineNum">    2486 </span><span class="lineCov">        669 :         in-&gt;done = GF_TRUE;</span>
<span class="lineNum">    2487 </span>            : 
<span class="lineNum">    2488 </span><span class="lineCov">        669 :         GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Closing output %s\n&quot;, in-&gt;local_path ? in-&gt;local_path : in-&gt;path));</span>
<span class="lineNum">    2489 </span>            : 
<span class="lineNum">    2490 </span><span class="lineCov">        669 :         if (in-&gt;upload) {</span>
<span class="lineNum">    2491 </span>            :                 GF_Err e;
<span class="lineNum">    2492 </span><span class="lineCov">         28 :                 if (!in-&gt;is_h2) {</span>
<span class="lineNum">    2493 </span><span class="lineCov">         28 :                         e = gf_dm_sess_send(in-&gt;upload, &quot;0\r\n\r\n&quot;, 5);</span>
<span class="lineNum">    2494 </span><span class="lineCov">         28 :                         if (e) {</span>
<span class="lineNum">    2495 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Error sending last chunk to %s: %s\n&quot;, in-&gt;local_path ? in-&gt;local_path : in-&gt;path, gf_error_to_string(e) ));</span>
<span class="lineNum">    2496 </span>            :                         }
<span class="lineNum">    2497 </span>            :                 }
<span class="lineNum">    2498 </span>            :                 //signal we're done sending the body
<span class="lineNum">    2499 </span><span class="lineCov">         28 :                 gf_dm_sess_send(in-&gt;upload, NULL, 0);</span>
<span class="lineNum">    2500 </span>            : 
<span class="lineNum">    2501 </span>            :                 //fetch reply (blocking)
<span class="lineNum">    2502 </span><span class="lineCov">         28 :                 e = gf_dm_sess_process(in-&gt;upload);</span>
<span class="lineNum">    2503 </span><span class="lineCov">         28 :                 if (e) {</span>
<span class="lineNum">    2504 </span><span class="lineCov">          3 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Error closing output %s: %s\n&quot;, in-&gt;local_path ? in-&gt;local_path : in-&gt;path, gf_error_to_string(e) ));</span>
<span class="lineNum">    2505 </span>            :                 }
<span class="lineNum">    2506 </span>            : 
<span class="lineNum">    2507 </span>            :         } else {
<span class="lineNum">    2508 </span>            :                 u32 i, count;
<span class="lineNum">    2509 </span>            : 
<span class="lineNum">    2510 </span><span class="lineCov">        641 :                 if (ctx-&gt;log_record) {</span>
<span class="lineNum">    2511 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_INFO, GF_LOG_ALL, (&quot;[HTTPOut] Closing output file %s\n&quot;, in-&gt;local_path ? in-&gt;local_path : in-&gt;path));</span>
<span class="lineNum">    2512 </span>            :                 }
<span class="lineNum">    2513 </span>            : 
<span class="lineNum">    2514 </span><span class="lineCov">        641 :                 if (in-&gt;resource) {</span>
<span class="lineNum">    2515 </span>            :                         assert(in-&gt;local_path);
<span class="lineNum">    2516 </span>            :                         //close all LL-HLS chunks before closing session
<span class="lineNum">    2517 </span><span class="lineCov">        640 :                         httpout_close_hls_chunk(ctx, in, GF_FALSE);</span>
<span class="lineNum">    2518 </span>            : 
<span class="lineNum">    2519 </span>            :                         //detach all clients from this input and reassign to a regular output
<span class="lineNum">    2520 </span><span class="lineCov">        640 :                         count = gf_list_count(ctx-&gt;sessions);</span>
<span class="lineNum">    2521 </span><span class="lineCov">       1395 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2522 </span><span class="lineCov">        755 :                                 GF_HTTPOutSession *sess = gf_list_get(ctx-&gt;sessions, i);</span>
<span class="lineNum">    2523 </span><span class="lineCov">        755 :                                 if (sess-&gt;in_source != in) continue;</span>
<span class="lineNum">    2524 </span>            :                                 assert(sess-&gt;file_in_progress);
<span class="lineNum">    2525 </span>            :                                 if (sess-&gt;in_source) {
<span class="lineNum">    2526 </span><span class="lineCov">         21 :                                         sess-&gt;in_source-&gt;nb_dest--;</span>
<span class="lineNum">    2527 </span><span class="lineCov">         21 :                                         sess-&gt;in_source = NULL;</span>
<span class="lineNum">    2528 </span><span class="lineCov">         21 :                                         if (!sess-&gt;resource &amp;&amp; sess-&gt;path) {</span>
<span class="lineNum">    2529 </span><span class="lineNoCov">          0 :                                                 sess-&gt;resource = gf_fopen(sess-&gt;path, &quot;rb&quot;);</span>
<span class="lineNum">    2530 </span>            :                                         }
<span class="lineNum">    2531 </span>            :                                 }
<span class="lineNum">    2532 </span>            :                                 //get final size by forcing a seek
<span class="lineNum">    2533 </span><span class="lineCov">         21 :                                 sess-&gt;file_size = gf_fsize(sess-&gt;resource);</span>
<span class="lineNum">    2534 </span><span class="lineCov">         21 :                                 gf_fseek(sess-&gt;resource, sess-&gt;file_pos, SEEK_SET);</span>
<span class="lineNum">    2535 </span><span class="lineCov">         21 :                                 sess-&gt;file_in_progress = GF_FALSE;</span>
<span class="lineNum">    2536 </span>            :                         }
<span class="lineNum">    2537 </span><span class="lineCov">        640 :                         gf_fclose(in-&gt;resource);</span>
<span class="lineNum">    2538 </span><span class="lineCov">        640 :                         in-&gt;resource = NULL;</span>
<span class="lineNum">    2539 </span>            :                 } else {
<span class="lineNum">    2540 </span><span class="lineCov">          1 :                         count = gf_list_count(ctx-&gt;active_sessions);</span>
<span class="lineNum">    2541 </span><span class="lineCov">          2 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2542 </span><span class="lineCov">          1 :                                 GF_HTTPOutSession *sess = gf_list_get(ctx-&gt;active_sessions, i);</span>
<span class="lineNum">    2543 </span><span class="lineCov">          1 :                                 if (sess-&gt;in_source != in) continue;</span>
<span class="lineNum">    2544 </span>            :                                 assert(sess-&gt;nb_bytes);
<span class="lineNum">    2545 </span><span class="lineCov">          1 :                                 if (!sess-&gt;is_h2)</span>
<span class="lineNum">    2546 </span><span class="lineCov">          1 :                                         gf_dm_sess_send(sess-&gt;http_sess, &quot;0\r\n\r\n&quot;, 5);</span>
<span class="lineNum">    2547 </span>            : 
<span class="lineNum">    2548 </span>            :                                 //signal we're done sending the body
<span class="lineNum">    2549 </span><span class="lineCov">          1 :                                 gf_dm_sess_send(sess-&gt;http_sess, NULL, 0);</span>
<span class="lineNum">    2550 </span>            : 
<span class="lineNum">    2551 </span><span class="lineCov">          1 :                                 log_request_done(sess);</span>
<span class="lineNum">    2552 </span>            :                         }
<span class="lineNum">    2553 </span>            :                 }
<span class="lineNum">    2554 </span>            :         }
<a name="2555"><span class="lineNum">    2555 </span><span class="lineCov">        669 :         in-&gt;nb_write = 0;</span></a>
<span class="lineNum">    2556 </span>            : }
<span class="lineNum">    2557 </span><span class="lineCov">       2056 : u32 httpout_write_input(GF_HTTPOutCtx *ctx, GF_HTTPOutInput *in, const u8 *pck_data, u32 pck_size, Bool file_start)</span>
<span class="lineNum">    2558 </span>            : {
<span class="lineNum">    2559 </span>            :         u32 out=0;
<span class="lineNum">    2560 </span>            : 
<span class="lineNum">    2561 </span><span class="lineCov">       2056 :         if (!in-&gt;is_open) return 0;</span>
<span class="lineNum">    2562 </span>            : 
<span class="lineNum">    2563 </span><span class="lineCov">       2056 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_HTTP, (&quot;[HTTPOut] Writing %d bytes to output file %s\n&quot;, pck_size, in-&gt;local_path ? in-&gt;local_path : in-&gt;path));</span>
<span class="lineNum">    2564 </span>            : 
<span class="lineNum">    2565 </span><span class="lineCov">       2056 :         if (in-&gt;upload) {</span>
<span class="lineNum">    2566 </span>            :                 char szChunkHdr[100];
<span class="lineNum">    2567 </span>            :                 u32 chunk_hdr_len=0;
<span class="lineNum">    2568 </span>            :                 GF_Err e;
<span class="lineNum">    2569 </span>            :                 u32 nb_retry = 0;
<span class="lineNum">    2570 </span>            :                 out = pck_size;
<span class="lineNum">    2571 </span>            : 
<span class="lineNum">    2572 </span><span class="lineCov">         80 :                 if (!in-&gt;is_h2) {</span>
<span class="lineNum">    2573 </span>            :                         sprintf(szChunkHdr, &quot;%X\r\n&quot;, pck_size);
<span class="lineNum">    2574 </span><span class="lineCov">         80 :                         chunk_hdr_len = (u32) strlen(szChunkHdr);</span>
<span class="lineNum">    2575 </span>            :                 }
<span class="lineNum">    2576 </span><span class="lineCov">         80 : retry:</span>
<span class="lineNum">    2577 </span><span class="lineCov">         80 :                 if (!in-&gt;is_h2) {</span>
<span class="lineNum">    2578 </span><span class="lineCov">         80 :                         e = gf_dm_sess_send(in-&gt;upload, szChunkHdr, chunk_hdr_len);</span>
<span class="lineNum">    2579 </span><span class="lineCov">         80 :                         if (!e) e = gf_dm_sess_send(in-&gt;upload, (u8 *) pck_data, pck_size);</span>
<span class="lineNum">    2580 </span><span class="lineCov">         80 :                         if (!e) e = gf_dm_sess_send(in-&gt;upload, &quot;\r\n&quot;, 2);</span>
<span class="lineNum">    2581 </span>            :                 } else {
<span class="lineNum">    2582 </span><span class="lineNoCov">          0 :                         e = gf_dm_sess_send(in-&gt;upload, (u8 *) pck_data, pck_size);</span>
<span class="lineNum">    2583 </span>            :                 }
<span class="lineNum">    2584 </span><span class="lineCov">         80 :                 if (e==GF_IP_CONNECTION_CLOSED) {</span>
<span class="lineNum">    2585 </span><span class="lineNoCov">          0 :                         if (file_start &amp;&amp; (nb_retry&lt;10) ) {</span>
<span class="lineNum">    2586 </span><span class="lineNoCov">          0 :                                 in-&gt;is_open = GF_FALSE;</span>
<span class="lineNum">    2587 </span><span class="lineNoCov">          0 :                                 nb_retry++;</span>
<span class="lineNum">    2588 </span><span class="lineNoCov">          0 :                                 if (httpout_open_input(ctx, in, in-&gt;path, GF_FALSE))</span>
<span class="lineNum">    2589 </span>            :                                         goto retry;
<span class="lineNum">    2590 </span>            :                         }
<span class="lineNum">    2591 </span>            :                 }
<span class="lineNum">    2592 </span><span class="lineCov">         80 :                 if (e) {</span>
<span class="lineNum">    2593 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Error writing to output file %s: %s\n&quot;, in-&gt;local_path ? in-&gt;local_path : in-&gt;path, gf_error_to_string(e) ));</span>
<span class="lineNum">    2594 </span>            :                         out = 0;
<span class="lineNum">    2595 </span>            :                 }
<span class="lineNum">    2596 </span>            : 
<span class="lineNum">    2597 </span>            :         } else {
<span class="lineNum">    2598 </span>            :                 char szChunkHdr[100];
<span class="lineNum">    2599 </span>            :                 u32 chunk_hdr_len=0;
<span class="lineNum">    2600 </span><span class="lineCov">       1976 :                 u32 i, count = gf_list_count(ctx-&gt;active_sessions);</span>
<span class="lineNum">    2601 </span>            : 
<span class="lineNum">    2602 </span><span class="lineCov">       1976 :                 if (in-&gt;resource) {</span>
<span class="lineNum">    2603 </span><span class="lineCov">       1958 :                         out = (u32) gf_fwrite(pck_data, pck_size, in-&gt;resource);</span>
<span class="lineNum">    2604 </span><span class="lineCov">       1958 :                         gf_fflush(in-&gt;resource);</span>
<span class="lineNum">    2605 </span>            : 
<span class="lineNum">    2606 </span><span class="lineCov">       1958 :                         if (in-&gt;hls_chunk) {</span>
<span class="lineNum">    2607 </span><span class="lineCov">        180 :                                 u32 wb = (u32) gf_fwrite(pck_data, pck_size, in-&gt;hls_chunk);</span>
<span class="lineNum">    2608 </span><span class="lineCov">        180 :                                 if (wb != pck_size) {</span>
<span class="lineNum">    2609 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Write error for HLS chunk, wrote %d bytes but had %d to write\n&quot;, wb, pck_size));</span>
<span class="lineNum">    2610 </span>            :                                 }
<span class="lineNum">    2611 </span><span class="lineCov">        180 :                                 gf_fflush(in-&gt;hls_chunk);</span>
<span class="lineNum">    2612 </span>            :                         }
<span class="lineNum">    2613 </span>            :                 }
<span class="lineNum">    2614 </span>            : 
<span class="lineNum">    2615 </span><span class="lineCov">       1599 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2616 </span><span class="lineCov">       1599 :                         GF_HTTPOutSession *sess = gf_list_get(ctx-&gt;active_sessions, i);</span>
<span class="lineNum">    2617 </span><span class="lineCov">       1599 :                         if (sess-&gt;in_source != in) continue;</span>
<span class="lineNum">    2618 </span>            : 
<span class="lineNum">    2619 </span><span class="lineCov">        243 :                         if (sess-&gt;send_init_data &amp;&amp; in-&gt;tunein_data_size &amp;&amp; !sess-&gt;file_in_progress) {</span>
<span class="lineNum">    2620 </span><span class="lineNoCov">          0 :                                 if (!sess-&gt;is_h2) {</span>
<span class="lineNum">    2621 </span>            :                                         char szHdrInit[100];
<span class="lineNum">    2622 </span>            :                                         sprintf(szHdrInit, &quot;%X\r\n&quot;, in-&gt;tunein_data_size);
<span class="lineNum">    2623 </span><span class="lineNoCov">          0 :                                         u32 len_hdr = (u32) strlen(szHdrInit);</span>
<span class="lineNum">    2624 </span><span class="lineNoCov">          0 :                                         gf_dm_sess_send(sess-&gt;http_sess, szHdrInit, len_hdr);</span>
<span class="lineNum">    2625 </span><span class="lineNoCov">          0 :                                         gf_dm_sess_send(sess-&gt;http_sess, in-&gt;tunein_data, in-&gt;tunein_data_size);</span>
<span class="lineNum">    2626 </span><span class="lineNoCov">          0 :                                         gf_dm_sess_send(sess-&gt;http_sess, &quot;\r\n&quot;, 2);</span>
<span class="lineNum">    2627 </span>            :                                 } else {
<span class="lineNum">    2628 </span><span class="lineNoCov">          0 :                                         gf_dm_sess_send(sess-&gt;http_sess, in-&gt;tunein_data, in-&gt;tunein_data_size);</span>
<span class="lineNum">    2629 </span>            :                                 }
<span class="lineNum">    2630 </span><span class="lineNoCov">          0 :                                 sess-&gt;nb_bytes += in-&gt;tunein_data_size;</span>
<span class="lineNum">    2631 </span>            :                         }
<span class="lineNum">    2632 </span><span class="lineCov">        243 :                         sess-&gt;send_init_data = GF_FALSE;</span>
<span class="lineNum">    2633 </span>            :                         out = pck_size;
<span class="lineNum">    2634 </span>            : 
<span class="lineNum">    2635 </span>            :                         /*source is read from disk but a different file handle is used, force refresh by using fseek (so use fsize and seek back to current pos)*/
<span class="lineNum">    2636 </span><span class="lineCov">        243 :                         if (sess-&gt;file_in_progress) {</span>
<span class="lineNum">    2637 </span><span class="lineCov">        225 :                                 sess-&gt;file_size = gf_fsize(sess-&gt;resource);</span>
<span class="lineNum">    2638 </span><span class="lineCov">        225 :                                 gf_fseek(sess-&gt;resource, sess-&gt;file_pos, SEEK_SET);</span>
<span class="lineNum">    2639 </span>            :                         }
<span class="lineNum">    2640 </span>            :                         /*source is not read from disk, write data*/
<span class="lineNum">    2641 </span>            :                         else {
<span class="lineNum">    2642 </span><span class="lineCov">         18 :                                 if (!sess-&gt;is_h2) {</span>
<span class="lineNum">    2643 </span><span class="lineCov">         18 :                                         if (!chunk_hdr_len) {</span>
<span class="lineNum">    2644 </span>            :                                                 sprintf(szChunkHdr, &quot;%X\r\n&quot;, pck_size);
<span class="lineNum">    2645 </span><span class="lineCov">         18 :                                                 chunk_hdr_len = (u32) strlen(szChunkHdr);</span>
<span class="lineNum">    2646 </span>            :                                         }
<span class="lineNum">    2647 </span><span class="lineCov">         18 :                                         gf_dm_sess_send(sess-&gt;http_sess, szChunkHdr, chunk_hdr_len);</span>
<span class="lineNum">    2648 </span><span class="lineCov">         18 :                                         gf_dm_sess_send(sess-&gt;http_sess, (u8*) pck_data, pck_size);</span>
<span class="lineNum">    2649 </span><span class="lineCov">         18 :                                         gf_dm_sess_send(sess-&gt;http_sess, &quot;\r\n&quot;, 2);</span>
<span class="lineNum">    2650 </span>            :                                 } else {
<span class="lineNum">    2651 </span><span class="lineNoCov">          0 :                                         gf_dm_sess_send(sess-&gt;http_sess, (u8*) pck_data, pck_size);</span>
<span class="lineNum">    2652 </span>            :                                 }
<span class="lineNum">    2653 </span><span class="lineCov">         18 :                                 sess-&gt;nb_bytes += pck_size;</span>
<span class="lineNum">    2654 </span>            :                         }
<span class="lineNum">    2655 </span>            :                 }
<span class="lineNum">    2656 </span>            :         }
<span class="lineNum">    2657 </span>            :         //don't reschedule, we will be notified when new packets are ready
<span class="lineNum">    2658 </span><span class="lineCov">       2056 :         ctx-&gt;next_wake_us = 0;</span>
<span class="lineNum">    2659 </span><span class="lineCov">       2056 :         return out;</span>
<a name="2660"><span class="lineNum">    2660 </span>            : }</a>
<span class="lineNum">    2661 </span>            : 
<span class="lineNum">    2662 </span><span class="lineCov">       2057 : static Bool httpout_input_write_ready(GF_HTTPOutCtx *ctx, GF_HTTPOutInput *in)</span>
<span class="lineNum">    2663 </span>            : {
<span class="lineNum">    2664 </span>            :         u32 i, count;
<span class="lineNum">    2665 </span><span class="lineCov">       2057 :         if (ctx-&gt;rdirs.nb_items)</span>
<span class="lineNum">    2666 </span>            :                 return GF_TRUE;
<span class="lineNum">    2667 </span>            : 
<span class="lineNum">    2668 </span><span class="lineCov">         99 :         if (in-&gt;upload) {</span>
<span class="lineNum">    2669 </span>            : /*              if (!gf_sk_group_sock_is_set(ctx-&gt;sg, in-&gt;socket, GF_SK_SELECT_WRITE))
<span class="lineNum">    2670 </span>            :                         return GF_FALSE;
<span class="lineNum">    2671 </span>            : */
<span class="lineNum">    2672 </span>            :                 return GF_TRUE;
<span class="lineNum">    2673 </span>            :         }
<span class="lineNum">    2674 </span>            : 
<span class="lineNum">    2675 </span><span class="lineCov">         18 :         count = gf_list_count(ctx-&gt;active_sessions);</span>
<span class="lineNum">    2676 </span><span class="lineCov">         36 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2677 </span><span class="lineCov">         18 :                 GF_HTTPOutSession *sess = gf_list_get(ctx-&gt;active_sessions, i);</span>
<span class="lineNum">    2678 </span><span class="lineCov">         18 :                 if (sess-&gt;in_source != in) continue;</span>
<span class="lineNum">    2679 </span>            : 
<span class="lineNum">    2680 </span><span class="lineCov">         18 :                 if (!sess-&gt;file_in_progress &amp;&amp; !gf_sk_group_sock_is_set(ctx-&gt;sg, sess-&gt;socket, GF_SK_SELECT_WRITE))</span>
<span class="lineNum">    2681 </span>            :                         return GF_FALSE;
<span class="lineNum">    2682 </span>            :         }
<span class="lineNum">    2683 </span><span class="lineCov">         18 :         return count ? GF_TRUE : GF_FALSE;</span>
<a name="2684"><span class="lineNum">    2684 </span>            : }</a>
<span class="lineNum">    2685 </span>            : 
<span class="lineNum">    2686 </span><span class="lineCov">         18 : static void httpin_send_seg_info(GF_HTTPOutInput *in)</span>
<span class="lineNum">    2687 </span>            : {
<span class="lineNum">    2688 </span>            :         GF_FilterEvent evt;
<span class="lineNum">    2689 </span><span class="lineCov">         18 :         GF_FEVT_INIT(evt, GF_FEVT_SEGMENT_SIZE, in-&gt;ipid);</span>
<span class="lineNum">    2690 </span>            :         evt.seg_size.seg_url = NULL;
<span class="lineNum">    2691 </span>            : 
<span class="lineNum">    2692 </span><span class="lineCov">         18 :         if (in-&gt;dash_mode==1) {</span>
<span class="lineNum">    2693 </span><span class="lineCov">          2 :                 evt.seg_size.is_init = GF_TRUE;</span>
<span class="lineNum">    2694 </span><span class="lineCov">          2 :                 in-&gt;dash_mode = 2;</span>
<span class="lineNum">    2695 </span>            :                 evt.seg_size.media_range_start = 0;
<span class="lineNum">    2696 </span>            :                 evt.seg_size.media_range_end = 0;
<span class="lineNum">    2697 </span><span class="lineCov">          2 :                 gf_filter_pid_send_event(in-&gt;ipid, &amp;evt);</span>
<span class="lineNum">    2698 </span>            :         } else {
<span class="lineNum">    2699 </span>            :                 evt.seg_size.is_init = GF_FALSE;
<span class="lineNum">    2700 </span><span class="lineCov">         16 :                 evt.seg_size.media_range_start = in-&gt;offset_at_seg_start;</span>
<span class="lineNum">    2701 </span><span class="lineCov">         16 :                 evt.seg_size.media_range_end = in-&gt;nb_write-1;</span>
<span class="lineNum">    2702 </span><span class="lineCov">         16 :                 in-&gt;offset_at_seg_start = 1+evt.seg_size.media_range_end;</span>
<span class="lineNum">    2703 </span><span class="lineCov">         16 :                 gf_filter_pid_send_event(in-&gt;ipid, &amp;evt);</span>
<span class="lineNum">    2704 </span>            :         }
<a name="2705"><span class="lineNum">    2705 </span><span class="lineCov">         18 : }</span></a>
<span class="lineNum">    2706 </span>            : 
<span class="lineNum">    2707 </span><span class="lineCov">       2934 : static void httpout_process_inputs(GF_HTTPOutCtx *ctx)</span>
<span class="lineNum">    2708 </span>            : {
<span class="lineNum">    2709 </span><span class="lineCov">       2934 :         u32 i, nb_eos=0, nb_nopck=0, count = gf_list_count(ctx-&gt;inputs);</span>
<span class="lineNum">    2710 </span><span class="lineCov">       7575 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2711 </span>            :                 Bool start, end;
<span class="lineNum">    2712 </span>            :                 const GF_PropertyValue *p;
<span class="lineNum">    2713 </span>            :                 const u8 *pck_data;
<span class="lineNum">    2714 </span>            :                 u32 pck_size, nb_write;
<span class="lineNum">    2715 </span>            :                 GF_FilterPacket *pck;
<span class="lineNum">    2716 </span><span class="lineCov">       4641 :                 GF_HTTPOutInput *in = gf_list_get(ctx-&gt;inputs, i);</span>
<span class="lineNum">    2717 </span>            : 
<span class="lineNum">    2718 </span>            :                 //not sending/writing anything, delete files
<span class="lineNum">    2719 </span><span class="lineCov">       4641 :                 if (!in-&gt;is_open &amp;&amp; in-&gt;file_deletes) {</span>
<span class="lineNum">    2720 </span><span class="lineCov">         28 :                         while (gf_list_count(in-&gt;file_deletes)) {</span>
<span class="lineNum">    2721 </span><span class="lineCov">         22 :                                 char *url = gf_list_pop_back(in-&gt;file_deletes);</span>
<span class="lineNum">    2722 </span><span class="lineCov">         22 :                                 httpout_open_input(ctx, in, url, GF_TRUE);</span>
<span class="lineNum">    2723 </span><span class="lineCov">         22 :                                 gf_free(url);</span>
<span class="lineNum">    2724 </span>            :                         }
<span class="lineNum">    2725 </span><span class="lineCov">          6 :                         gf_list_del(in-&gt;file_deletes);</span>
<span class="lineNum">    2726 </span><span class="lineCov">          6 :                         in-&gt;file_deletes = NULL;</span>
<span class="lineNum">    2727 </span>            :                 }
<span class="lineNum">    2728 </span>            : 
<span class="lineNum">    2729 </span>            :                 //no destination and holding for first connect, don't drop
<span class="lineNum">    2730 </span><span class="lineCov">       4641 :                 if (!ctx-&gt;hmode &amp;&amp; !ctx-&gt;rdirs.nb_items &amp;&amp; !in-&gt;nb_dest &amp;&amp; in-&gt;hold) {</span>
<span class="lineNum">    2731 </span><span class="lineCov">       2595 :                         continue;</span>
<span class="lineNum">    2732 </span>            :                 }
<span class="lineNum">    2733 </span>            : 
<span class="lineNum">    2734 </span><span class="lineCov">       4630 :                 pck = gf_filter_pid_get_packet(in-&gt;ipid);</span>
<span class="lineNum">    2735 </span><span class="lineCov">       4630 :                 if (!pck) {</span>
<span class="lineNum">    2736 </span><span class="lineCov">       2573 :                         nb_nopck++;</span>
<span class="lineNum">    2737 </span>            :                         //check end of PID state
<span class="lineNum">    2738 </span><span class="lineCov">       2573 :                         if (gf_filter_pid_is_eos(in-&gt;ipid)) {</span>
<span class="lineNum">    2739 </span><span class="lineCov">        397 :                                 nb_eos++;</span>
<span class="lineNum">    2740 </span><span class="lineCov">        397 :                                 if (in-&gt;dash_mode &amp;&amp; in-&gt;is_open) {</span>
<span class="lineNum">    2741 </span><span class="lineCov">          2 :                                         httpin_send_seg_info(in);</span>
<span class="lineNum">    2742 </span>            :                                 }
<span class="lineNum">    2743 </span><span class="lineCov">        397 :                                 httpout_close_input(ctx, in);</span>
<span class="lineNum">    2744 </span>            :                         }
<span class="lineNum">    2745 </span><span class="lineCov">       2573 :                         continue;</span>
<span class="lineNum">    2746 </span>            :                 }
<span class="lineNum">    2747 </span>            : 
<span class="lineNum">    2748 </span>            : 
<span class="lineNum">    2749 </span><span class="lineCov">       2057 :                 gf_filter_pck_get_framing(pck, &amp;start, &amp;end);</span>
<span class="lineNum">    2750 </span>            : 
<span class="lineNum">    2751 </span><span class="lineCov">       2057 :                 if (in-&gt;dash_mode) {</span>
<span class="lineNum">    2752 </span><span class="lineCov">        660 :                         p = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENUM);</span>
<span class="lineNum">    2753 </span><span class="lineCov">        660 :                         if (p) {</span>
<span class="lineNum">    2754 </span><span class="lineCov">         16 :                                 httpin_send_seg_info(in);</span>
<span class="lineNum">    2755 </span>            : 
<span class="lineNum">    2756 </span><span class="lineCov">         16 :                                 if ( gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENAME))</span>
<span class="lineNum">    2757 </span><span class="lineCov">          8 :                                         start = GF_TRUE;</span>
<span class="lineNum">    2758 </span>            :                         }
<span class="lineNum">    2759 </span>            :                 }
<span class="lineNum">    2760 </span>            : 
<span class="lineNum">    2761 </span><span class="lineCov">       2057 :                 if (start) {</span>
<span class="lineNum">    2762 </span>            :                         const GF_PropertyValue *fnum, *fname;
<span class="lineNum">    2763 </span>            :                         const char *name = NULL;
<span class="lineNum">    2764 </span>            :                         fname = NULL;
<span class="lineNum">    2765 </span>            : 
<span class="lineNum">    2766 </span><span class="lineCov">        669 :                         if (in-&gt;is_open)</span>
<span class="lineNum">    2767 </span><span class="lineCov">          7 :                                 httpout_close_input(ctx, in);</span>
<span class="lineNum">    2768 </span>            : 
<span class="lineNum">    2769 </span>            :                         //file num increased per packet, open new file
<span class="lineNum">    2770 </span><span class="lineCov">        669 :                         fnum = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENUM);</span>
<span class="lineNum">    2771 </span><span class="lineCov">        669 :                         if (fnum) {</span>
<span class="lineNum">    2772 </span><span class="lineCov">         80 :                                 fname = gf_filter_pid_get_property(in-&gt;ipid, GF_PROP_PID_OUTPATH);</span>
<span class="lineNum">    2773 </span>            :                                 //if (!fname) name = ctx-&gt;dst;
<span class="lineNum">    2774 </span>            :                         }
<span class="lineNum">    2775 </span>            :                         //filename change at packet start, open new file
<span class="lineNum">    2776 </span><span class="lineCov">         80 :                         if (!fname) fname = gf_filter_pck_get_property(pck, GF_PROP_PCK_FILENAME);</span>
<span class="lineNum">    2777 </span><span class="lineCov">        669 :                         if (!fname) fname = gf_filter_pck_get_property(pck, GF_PROP_PID_OUTPATH);</span>
<span class="lineNum">    2778 </span><span class="lineCov">        669 :                         if (fname) name = fname-&gt;value.string;</span>
<span class="lineNum">    2779 </span>            : 
<span class="lineNum">    2780 </span><span class="lineCov">        567 :                         if (!name) {</span>
<span class="lineNum">    2781 </span>            :                                 /*if PID was connected to an alias, get the alias context to get the destination
<span class="lineNum">    2782 </span>            :                                 Otherwise PID was directly connected to the main filter, use main filter destination*/
<span class="lineNum">    2783 </span><span class="lineCov">        102 :                                 GF_HTTPOutCtx *orig_ctx = gf_filter_pid_get_alias_udta(in-&gt;ipid);</span>
<span class="lineNum">    2784 </span><span class="lineCov">        102 :                                 if (!orig_ctx) orig_ctx = ctx;</span>
<span class="lineNum">    2785 </span><span class="lineCov">        102 :                                 name = orig_ctx-&gt;dst;</span>
<span class="lineNum">    2786 </span>            :                         }
<span class="lineNum">    2787 </span>            : 
<span class="lineNum">    2788 </span><span class="lineCov">        669 :                         httpout_open_input(ctx, in, name, GF_FALSE);</span>
<span class="lineNum">    2789 </span>            : 
<span class="lineNum">    2790 </span><span class="lineCov">        669 :                         if (!ctx-&gt;hmode &amp;&amp; !ctx-&gt;rdirs.nb_items &amp;&amp; !in-&gt;nb_dest) {</span>
<span class="lineNum">    2791 </span><span class="lineNoCov">          0 :                                 if ((gf_filter_pck_get_dependency_flags(pck)==0xFF) &amp;&amp; (gf_filter_pck_get_carousel_version(pck)==1)) {</span>
<span class="lineNum">    2792 </span><span class="lineNoCov">          0 :                                         pck_data = gf_filter_pck_get_data(pck, &amp;pck_size);</span>
<span class="lineNum">    2793 </span><span class="lineNoCov">          0 :                                         if (pck_data) {</span>
<span class="lineNum">    2794 </span><span class="lineNoCov">          0 :                                                 in-&gt;tunein_data_size = pck_size;</span>
<span class="lineNum">    2795 </span><span class="lineNoCov">          0 :                                                 in-&gt;tunein_data = gf_realloc(in-&gt;tunein_data, pck_size);</span>
<span class="lineNum">    2796 </span><span class="lineNoCov">          0 :                                                 memcpy(in-&gt;tunein_data, pck_data, pck_size);</span>
<span class="lineNum">    2797 </span>            :                                         }
<span class="lineNum">    2798 </span>            :                                 }
<span class="lineNum">    2799 </span>            :                         }
<span class="lineNum">    2800 </span>            :                 }
<span class="lineNum">    2801 </span>            : 
<span class="lineNum">    2802 </span><span class="lineCov">       2057 :                 p = gf_filter_pck_get_property(pck, GF_PROP_PCK_HLS_FRAG_NUM);</span>
<span class="lineNum">    2803 </span><span class="lineCov">       2057 :                 if (p &amp;&amp; in-&gt;resource) {</span>
<span class="lineNum">    2804 </span>            :                         char szHLSChunk[GF_MAX_PATH];
<span class="lineNum">    2805 </span><span class="lineCov">         90 :                         snprintf(szHLSChunk, GF_MAX_PATH-1, &quot;%s.%d&quot;, in-&gt;local_path, p-&gt;value.uint);</span>
<span class="lineNum">    2806 </span><span class="lineCov">         90 :                         httpout_close_hls_chunk(ctx, in, GF_FALSE);</span>
<span class="lineNum">    2807 </span><span class="lineCov">         90 :                         in-&gt;hls_chunk = gf_fopen(szHLSChunk, &quot;w+b&quot;);</span>
<span class="lineNum">    2808 </span><span class="lineCov">         90 :                         in-&gt;hls_chunk_local_path = gf_strdup(szHLSChunk);</span>
<span class="lineNum">    2809 </span><span class="lineCov">         90 :                         snprintf(szHLSChunk, GF_MAX_PATH-1, &quot;%s.%d&quot;, in-&gt;path, p-&gt;value.uint);</span>
<span class="lineNum">    2810 </span><span class="lineCov">         90 :                         in-&gt;hls_chunk_path = gf_strdup(szHLSChunk);</span>
<span class="lineNum">    2811 </span>            :                 }
<span class="lineNum">    2812 </span>            : 
<span class="lineNum">    2813 </span>            :                 //no destination and not holding packets (either first connection not here or disabled), trash packet
<span class="lineNum">    2814 </span><span class="lineCov">       2057 :                 if (!ctx-&gt;hmode &amp;&amp; !ctx-&gt;rdirs.nb_items &amp;&amp; !in-&gt;nb_dest &amp;&amp; !in-&gt;hold) {</span>
<span class="lineNum">    2815 </span><span class="lineNoCov">          0 :                         gf_filter_pid_drop_packet(in-&gt;ipid);</span>
<span class="lineNum">    2816 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2817 </span>            :                 }
<span class="lineNum">    2818 </span>            : 
<span class="lineNum">    2819 </span><span class="lineCov">       2057 :                 if (!httpout_input_write_ready(ctx, in)) {</span>
<span class="lineNum">    2820 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2821 </span>            :                 }
<span class="lineNum">    2822 </span>            : 
<span class="lineNum">    2823 </span><span class="lineCov">       2057 :                 pck_data = gf_filter_pck_get_data(pck, &amp;pck_size);</span>
<span class="lineNum">    2824 </span><span class="lineCov">       2057 :                 if (in-&gt;upload || ctx-&gt;single_mode || in-&gt;resource) {</span>
<span class="lineNum">    2825 </span><span class="lineCov">       2057 :                         GF_FilterFrameInterface *hwf = gf_filter_pck_get_frame_interface(pck);</span>
<span class="lineNum">    2826 </span><span class="lineCov">       2057 :                         if (pck_data &amp;&amp; pck_size) {</span>
<span class="lineNum">    2827 </span>            : 
<span class="lineNum">    2828 </span><span class="lineCov">       2056 :                                 if (in-&gt;patch_blocks &amp;&amp; gf_filter_pck_get_seek_flag(pck)) {</span>
<span class="lineNum">    2829 </span><span class="lineNoCov">          0 :                                         u64 bo = gf_filter_pck_get_byte_offset(pck);</span>
<span class="lineNum">    2830 </span><span class="lineNoCov">          0 :                                         if (bo==GF_FILTER_NO_BO) {</span>
<span class="lineNum">    2831 </span><span class="lineNoCov">          0 :                                                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Cannot patch file, wrong byte offset\n&quot;));</span>
<span class="lineNum">    2832 </span>            :                                         } else {
<span class="lineNum">    2833 </span><span class="lineNoCov">          0 :                                                 if (gf_filter_pck_get_interlaced(pck)) {</span>
<span class="lineNum">    2834 </span><span class="lineNoCov">          0 :                                                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Cannot patch file by byte insertion, not supported by HTTP\n&quot;));</span>
<span class="lineNum">    2835 </span>            :                                                 } else {
<span class="lineNum">    2836 </span><span class="lineNoCov">          0 :                                                         u64 pos = in-&gt;nb_write;</span>
<span class="lineNum">    2837 </span>            :                                                         //close file
<span class="lineNum">    2838 </span><span class="lineNoCov">          0 :                                                         httpout_close_input(ctx, in);</span>
<span class="lineNum">    2839 </span>            :                                                         //re-open file
<span class="lineNum">    2840 </span><span class="lineNoCov">          0 :                                                         in-&gt;write_start_range = bo;</span>
<span class="lineNum">    2841 </span><span class="lineNoCov">          0 :                                                         in-&gt;write_end_range = bo + pck_size - 1;</span>
<span class="lineNum">    2842 </span><span class="lineNoCov">          0 :                                                         httpout_open_input(ctx, in, in-&gt;path, GF_FALSE);</span>
<span class="lineNum">    2843 </span>            : 
<span class="lineNum">    2844 </span><span class="lineNoCov">          0 :                                                         nb_write = httpout_write_input(ctx, in, pck_data, pck_size, start);</span>
<span class="lineNum">    2845 </span><span class="lineNoCov">          0 :                                                         if (nb_write!=pck_size) {</span>
<span class="lineNum">    2846 </span><span class="lineNoCov">          0 :                                                                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Write error, wrote %d bytes but had %d to write\n&quot;, nb_write, pck_size));</span>
<span class="lineNum">    2847 </span>            :                                                         }
<span class="lineNum">    2848 </span><span class="lineNoCov">          0 :                                                         httpout_close_input(ctx, in);</span>
<span class="lineNum">    2849 </span>            : 
<span class="lineNum">    2850 </span><span class="lineNoCov">          0 :                                                         in-&gt;write_start_range = pos;</span>
<span class="lineNum">    2851 </span><span class="lineNoCov">          0 :                                                         in-&gt;write_end_range = 0;</span>
<span class="lineNum">    2852 </span>            :                                                 }
<span class="lineNum">    2853 </span>            :                                         }
<span class="lineNum">    2854 </span>            :                                 } else {
<span class="lineNum">    2855 </span><span class="lineCov">       2056 :                                         if (in-&gt;write_start_range) {</span>
<span class="lineNum">    2856 </span><span class="lineNoCov">          0 :                                                 httpout_open_input(ctx, in, in-&gt;path, GF_FALSE);</span>
<span class="lineNum">    2857 </span>            :                                         }
<span class="lineNum">    2858 </span>            : 
<span class="lineNum">    2859 </span><span class="lineCov">       2056 :                                         nb_write = httpout_write_input(ctx, in, pck_data, pck_size, start);</span>
<span class="lineNum">    2860 </span><span class="lineCov">       2056 :                                         if (nb_write!=pck_size) {</span>
<span class="lineNum">    2861 </span><span class="lineNoCov">          0 :                                                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Write error, wrote %d bytes but had %d to write\n&quot;, nb_write, pck_size));</span>
<span class="lineNum">    2862 </span>            :                                         }
<span class="lineNum">    2863 </span><span class="lineCov">       2056 :                                         in-&gt;nb_write += nb_write;</span>
<span class="lineNum">    2864 </span>            :                                 }
<span class="lineNum">    2865 </span><span class="lineCov">          1 :                         } else if (hwf) {</span>
<span class="lineNum">    2866 </span>            :                                 u32 w, h, stride, stride_uv, pf;
<span class="lineNum">    2867 </span>            :                                 u32 nb_planes, uv_height;
<span class="lineNum">    2868 </span><span class="lineNoCov">          0 :                                 p = gf_filter_pid_get_property(in-&gt;ipid, GF_PROP_PID_WIDTH);</span>
<span class="lineNum">    2869 </span><span class="lineNoCov">          0 :                                 w = p ? p-&gt;value.uint : 0;</span>
<span class="lineNum">    2870 </span><span class="lineNoCov">          0 :                                 p = gf_filter_pid_get_property(in-&gt;ipid, GF_PROP_PID_HEIGHT);</span>
<span class="lineNum">    2871 </span><span class="lineNoCov">          0 :                                 h = p ? p-&gt;value.uint : 0;</span>
<span class="lineNum">    2872 </span><span class="lineNoCov">          0 :                                 p = gf_filter_pid_get_property(in-&gt;ipid, GF_PROP_PID_PIXFMT);</span>
<span class="lineNum">    2873 </span><span class="lineNoCov">          0 :                                 pf = p ? p-&gt;value.uint : 0;</span>
<span class="lineNum">    2874 </span>            : 
<span class="lineNum">    2875 </span><span class="lineNoCov">          0 :                                 stride = stride_uv = 0;</span>
<span class="lineNum">    2876 </span>            : 
<span class="lineNum">    2877 </span><span class="lineNoCov">          0 :                                 if (gf_pixel_get_size_info(pf, w, h, NULL, &amp;stride, &amp;stride_uv, &amp;nb_planes, &amp;uv_height) == GF_TRUE) {</span>
<span class="lineNum">    2878 </span>            :                                         u32 k;
<span class="lineNum">    2879 </span><span class="lineNoCov">          0 :                                         for (k=0; k&lt;nb_planes; k++) {</span>
<span class="lineNum">    2880 </span>            :                                                 u32 j, write_h, lsize;
<span class="lineNum">    2881 </span>            :                                                 const u8 *out_ptr;
<span class="lineNum">    2882 </span><span class="lineNoCov">          0 :                                                 u32 out_stride = k ? stride_uv : stride;</span>
<span class="lineNum">    2883 </span><span class="lineNoCov">          0 :                                                 GF_Err e = hwf-&gt;get_plane(hwf, k, &amp;out_ptr, &amp;out_stride);</span>
<span class="lineNum">    2884 </span><span class="lineNoCov">          0 :                                                 if (e) {</span>
<span class="lineNum">    2885 </span><span class="lineNoCov">          0 :                                                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Failed to fetch plane #%d data from hardware frame, cannot write\n&quot;, k));</span>
<span class="lineNum">    2886 </span><span class="lineNoCov">          0 :                                                         break;</span>
<span class="lineNum">    2887 </span>            :                                                 }
<span class="lineNum">    2888 </span><span class="lineNoCov">          0 :                                                 if (k) {</span>
<span class="lineNum">    2889 </span><span class="lineNoCov">          0 :                                                         write_h = uv_height;</span>
<span class="lineNum">    2890 </span><span class="lineNoCov">          0 :                                                         lsize = stride_uv;</span>
<span class="lineNum">    2891 </span>            :                                                 } else {
<span class="lineNum">    2892 </span>            :                                                         write_h = h;
<span class="lineNum">    2893 </span><span class="lineNoCov">          0 :                                                         lsize = stride;</span>
<span class="lineNum">    2894 </span>            :                                                 }
<span class="lineNum">    2895 </span><span class="lineNoCov">          0 :                                                 for (j=0; j&lt;write_h; j++) {</span>
<span class="lineNum">    2896 </span><span class="lineNoCov">          0 :                                                         nb_write = (u32) httpout_write_input(ctx, in, out_ptr, lsize, start);</span>
<span class="lineNum">    2897 </span><span class="lineNoCov">          0 :                                                         if (nb_write!=lsize) {</span>
<span class="lineNum">    2898 </span><span class="lineNoCov">          0 :                                                                 GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] Write error, wrote %d bytes but had %d to write\n&quot;, nb_write, lsize));</span>
<span class="lineNum">    2899 </span>            :                                                         }
<span class="lineNum">    2900 </span><span class="lineNoCov">          0 :                                                         in-&gt;nb_write += nb_write;</span>
<span class="lineNum">    2901 </span><span class="lineNoCov">          0 :                                                         out_ptr += out_stride;</span>
<span class="lineNum">    2902 </span><span class="lineNoCov">          0 :                                                         start = GF_FALSE;</span>
<span class="lineNum">    2903 </span>            :                                                 }
<span class="lineNum">    2904 </span>            :                                         }
<span class="lineNum">    2905 </span>            :                                 }
<span class="lineNum">    2906 </span>            :                         } else {
<span class="lineNum">    2907 </span><span class="lineCov">          1 :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_HTTP, (&quot;[HTTPOut] No data associated with packet, cannot write\n&quot;));</span>
<span class="lineNum">    2908 </span>            :                         }
<span class="lineNum">    2909 </span>            :                 } else {
<span class="lineNum">    2910 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_HTTP, (&quot;[HTTPOut] output file handle is not opened, discarding %d bytes\n&quot;, pck_size));</span>
<span class="lineNum">    2911 </span>            :                 }
<span class="lineNum">    2912 </span><span class="lineCov">       2057 :                 gf_filter_pid_drop_packet(in-&gt;ipid);</span>
<span class="lineNum">    2913 </span><span class="lineCov">       2057 :                 if (end) {</span>
<span class="lineNum">    2914 </span><span class="lineCov">        659 :                         httpout_close_input(ctx, in);</span>
<span class="lineNum">    2915 </span>            :                 }
<span class="lineNum">    2916 </span>            :         }
<span class="lineNum">    2917 </span>            : 
<span class="lineNum">    2918 </span><span class="lineCov">       2934 :         if (count &amp;&amp; (nb_eos==count)) {</span>
<span class="lineNum">    2919 </span><span class="lineCov">         16 :                 if (ctx-&gt;rdirs.nb_items) {</span>
<span class="lineNum">    2920 </span><span class="lineCov">         10 :                         if (gf_list_count(ctx-&gt;active_sessions))</span>
<span class="lineNum">    2921 </span><span class="lineNoCov">          0 :                                 gf_filter_post_process_task(ctx-&gt;filter);</span>
<span class="lineNum">    2922 </span>            :                         else
<span class="lineNum">    2923 </span><span class="lineCov">         10 :                                 ctx-&gt;done = GF_TRUE;</span>
<span class="lineNum">    2924 </span>            :                 }
<span class="lineNum">    2925 </span>            :                 else
<span class="lineNum">    2926 </span><span class="lineCov">          6 :                         ctx-&gt;done = GF_TRUE;</span>
<span class="lineNum">    2927 </span>            :         }
<span class="lineNum">    2928 </span>            :         //push mode and no packets on inputs, do not ask for RT reschedule (we will get called if new packets are to be processed)
<span class="lineNum">    2929 </span><span class="lineCov">       2934 :         if ((nb_nopck==count) &amp;&amp; (ctx-&gt;hmode==MODE_PUSH))</span>
<span class="lineNum">    2930 </span><span class="lineCov">         18 :                 ctx-&gt;next_wake_us = 0;</span>
<a name="2931"><span class="lineNum">    2931 </span><span class="lineCov">       2934 : }</span></a>
<span class="lineNum">    2932 </span>            : 
<span class="lineNum">    2933 </span><span class="lineCov">       4015 : static GF_Err httpout_process(GF_Filter *filter)</span>
<span class="lineNum">    2934 </span>            : {
<span class="lineNum">    2935 </span>            :         GF_Err e=GF_OK;
<span class="lineNum">    2936 </span>            :         u32 i, count;
<span class="lineNum">    2937 </span><span class="lineCov">       4015 :         GF_HTTPOutCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    2938 </span>            : 
<span class="lineNum">    2939 </span><span class="lineCov">       4015 :         if (ctx-&gt;done)</span>
<span class="lineNum">    2940 </span>            :                 return GF_EOS;
<span class="lineNum">    2941 </span>            : 
<span class="lineNum">    2942 </span>            :         //wakeup every 50ms when inactive
<span class="lineNum">    2943 </span><span class="lineCov">       2934 :         ctx-&gt;next_wake_us = 50000;</span>
<span class="lineNum">    2944 </span>            : 
<span class="lineNum">    2945 </span><span class="lineCov">       2934 :         e = gf_sk_group_select(ctx-&gt;sg, 10, GF_SK_SELECT_BOTH);</span>
<span class="lineNum">    2946 </span><span class="lineCov">       2934 :         if ((e==GF_OK) &amp;&amp; ctx-&gt;server_sock) {</span>
<span class="lineNum">    2947 </span>            :                 //server mode, check pending connections
<span class="lineNum">    2948 </span><span class="lineCov">       1029 :                 if (gf_sk_group_sock_is_set(ctx-&gt;sg, ctx-&gt;server_sock, GF_SK_SELECT_READ)) {</span>
<span class="lineNum">    2949 </span><span class="lineCov">         47 :                         httpout_check_new_session(ctx);</span>
<span class="lineNum">    2950 </span>            :                 }
<span class="lineNum">    2951 </span>            : 
<span class="lineNum">    2952 </span><span class="lineCov">       1029 :                 count = gf_list_count(ctx-&gt;active_sessions);</span>
<span class="lineNum">    2953 </span><span class="lineCov">       3023 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2954 </span><span class="lineCov">       1994 :                         GF_HTTPOutSession *sess = gf_list_get(ctx-&gt;active_sessions, i);</span>
<span class="lineNum">    2955 </span>            :                         //push
<span class="lineNum">    2956 </span><span class="lineCov">       1994 :                         if (sess-&gt;in_source) continue;</span>
<span class="lineNum">    2957 </span>            : 
<span class="lineNum">    2958 </span>            :                         //regular download
<span class="lineNum">    2959 </span><span class="lineCov">       1611 :                         httpout_process_session(filter, ctx, sess);</span>
<span class="lineNum">    2960 </span>            :                         //closed, remove
<span class="lineNum">    2961 </span><span class="lineCov">       1611 :                         if (! sess-&gt;http_sess) {</span>
<span class="lineNum">    2962 </span><span class="lineCov">         43 :                                 httpout_del_session(sess);</span>
<span class="lineNum">    2963 </span><span class="lineCov">         43 :                                 i--;</span>
<span class="lineNum">    2964 </span><span class="lineCov">         43 :                                 count--;</span>
<span class="lineNum">    2965 </span><span class="lineCov">         43 :                                 if (!count &amp;&amp; ctx-&gt;quit)</span>
<span class="lineNum">    2966 </span><span class="lineCov">          5 :                                         ctx-&gt;done = GF_TRUE;</span>
<span class="lineNum">    2967 </span><span class="lineCov">         43 :                                 continue;</span>
<span class="lineNum">    2968 </span>            :                         }
<span class="lineNum">    2969 </span>            : 
<span class="lineNum">    2970 </span><span class="lineCov">       1568 :                         if (sess-&gt;sub_sess_pending) {</span>
<span class="lineNum">    2971 </span><span class="lineNoCov">          0 :                                 sess-&gt;sub_sess_pending = GF_FALSE;</span>
<span class="lineNum">    2972 </span><span class="lineNoCov">          0 :                                 count = gf_list_count(ctx-&gt;active_sessions);</span>
<span class="lineNum">    2973 </span>            :                                 i = -1;
<span class="lineNum">    2974 </span>            :                         }
<span class="lineNum">    2975 </span>            :                 }
<span class="lineNum">    2976 </span>            :         }
<span class="lineNum">    2977 </span>            : 
<span class="lineNum">    2978 </span><span class="lineCov">       2934 :         httpout_process_inputs(ctx);</span>
<span class="lineNum">    2979 </span>            : 
<span class="lineNum">    2980 </span><span class="lineCov">       2934 :         if (ctx-&gt;timeout &amp;&amp; ctx-&gt;server_sock) {</span>
<span class="lineNum">    2981 </span><span class="lineCov">       2847 :                 count = gf_list_count(ctx-&gt;active_sessions);</span>
<span class="lineNum">    2982 </span><span class="lineCov">       4798 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2983 </span>            :                         u32 diff_sec;
<span class="lineNum">    2984 </span><span class="lineCov">       1951 :                         GF_HTTPOutSession *sess = gf_list_get(ctx-&gt;active_sessions, i);</span>
<span class="lineNum">    2985 </span><span class="lineCov">       1951 :                         if (!sess-&gt;done) continue;</span>
<span class="lineNum">    2986 </span>            : 
<span class="lineNum">    2987 </span><span class="lineCov">       1089 :                         diff_sec = (u32) (gf_sys_clock_high_res() - sess-&gt;last_active_time)/1000000;</span>
<span class="lineNum">    2988 </span><span class="lineCov">       1089 :                         if (diff_sec&gt;ctx-&gt;timeout) {</span>
<span class="lineNum">    2989 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_HTTP, (&quot;[HTTPOut] Timeout for peer %s after %d sec, closing connection (last request %s)\n&quot;, sess-&gt;peer_address, diff_sec, sess-&gt;in_source ? sess-&gt;in_source-&gt;path : sess-&gt;path ));</span>
<span class="lineNum">    2990 </span>            : 
<span class="lineNum">    2991 </span><span class="lineNoCov">          0 :                                 httpout_close_session(sess);</span>
<span class="lineNum">    2992 </span>            : 
<span class="lineNum">    2993 </span><span class="lineNoCov">          0 :                                 httpout_del_session(sess);</span>
<span class="lineNum">    2994 </span><span class="lineNoCov">          0 :                                 i--;</span>
<span class="lineNum">    2995 </span><span class="lineNoCov">          0 :                                 count--;</span>
<span class="lineNum">    2996 </span>            :                         }
<span class="lineNum">    2997 </span>            :                 }
<span class="lineNum">    2998 </span>            :         }
<span class="lineNum">    2999 </span>            : 
<span class="lineNum">    3000 </span><span class="lineCov">       2934 :         if (e==GF_EOS) {</span>
<span class="lineNum">    3001 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;dst) return GF_EOS;</span>
<span class="lineNum">    3002 </span>            :                 e=GF_OK;
<span class="lineNum">    3003 </span>            :         }
<span class="lineNum">    3004 </span>            : 
<span class="lineNum">    3005 </span>            :         //reschedule was canceled but we still have active sessions, reschedule for our default timeout
<span class="lineNum">    3006 </span><span class="lineCov">       2934 :         if (!ctx-&gt;next_wake_us &amp;&amp; gf_list_count(ctx-&gt;active_sessions)) {</span>
<span class="lineNum">    3007 </span><span class="lineCov">        600 :                 ctx-&gt;next_wake_us = 50000;</span>
<span class="lineNum">    3008 </span>            :         }
<span class="lineNum">    3009 </span>            : 
<span class="lineNum">    3010 </span><span class="lineCov">       2934 :         if (ctx-&gt;next_wake_us) {</span>
<span class="lineNum">    3011 </span><span class="lineCov">       1904 :                 gf_filter_ask_rt_reschedule(filter, ctx-&gt;next_wake_us);</span>
<span class="lineNum">    3012 </span>            :         }
<span class="lineNum">    3013 </span>            : 
<span class="lineNum">    3014 </span>            :         return e;
<a name="3015"><span class="lineNum">    3015 </span>            : }</a>
<span class="lineNum">    3016 </span>            : 
<span class="lineNum">    3017 </span><span class="lineCov">        483 : static Bool httpout_process_event(GF_Filter *filter, const GF_FilterEvent *evt)</span>
<span class="lineNum">    3018 </span>            : {
<span class="lineNum">    3019 </span>            :         GF_HTTPOutInput *in;
<span class="lineNum">    3020 </span>            :         GF_HTTPOutCtx *ctx;
<span class="lineNum">    3021 </span><span class="lineCov">        483 :         if (evt-&gt;base.type!=GF_FEVT_FILE_DELETE)</span>
<span class="lineNum">    3022 </span>            :                 return GF_FALSE;
<span class="lineNum">    3023 </span>            : 
<span class="lineNum">    3024 </span><span class="lineCov">         22 :         if (!evt-&gt;base.on_pid) return GF_TRUE;</span>
<span class="lineNum">    3025 </span><span class="lineCov">         22 :         in = gf_filter_pid_get_udta(evt-&gt;base.on_pid);</span>
<span class="lineNum">    3026 </span><span class="lineCov">         22 :         if (!in) return GF_TRUE;</span>
<span class="lineNum">    3027 </span>            : 
<span class="lineNum">    3028 </span><span class="lineCov">         22 :         ctx = (GF_HTTPOutCtx *) gf_filter_get_udta(filter);</span>
<span class="lineNum">    3029 </span>            :                 //simple server mode (no record, no push), nothing to do
<span class="lineNum">    3030 </span><span class="lineCov">         22 :         if (!in-&gt;upload &amp;&amp; !ctx-&gt;rdirs.nb_items) return GF_TRUE;</span>
<span class="lineNum">    3031 </span>            : 
<span class="lineNum">    3032 </span><span class="lineCov">         22 :         if (!in-&gt;file_deletes)</span>
<span class="lineNum">    3033 </span><span class="lineCov">          6 :                 in-&gt;file_deletes = gf_list_new();</span>
<span class="lineNum">    3034 </span><span class="lineCov">         22 :         gf_list_add(in-&gt;file_deletes, gf_strdup(evt-&gt;file_del.url));</span>
<span class="lineNum">    3035 </span><span class="lineCov">         22 :         return GF_TRUE;</span>
<a name="3036"><span class="lineNum">    3036 </span>            : }</a>
<span class="lineNum">    3037 </span>            : 
<span class="lineNum">    3038 </span><span class="lineCov">       2198 : static GF_FilterProbeScore httpout_probe_url(const char *url, const char *mime)</span>
<span class="lineNum">    3039 </span>            : {
<span class="lineNum">    3040 </span><span class="lineCov">       2198 :         if (!strnicmp(url, &quot;http://&quot;, 7)) return GF_FPROBE_SUPPORTED;</span>
<span class="lineNum">    3041 </span><span class="lineCov">       2164 :         if (!strnicmp(url, &quot;https://&quot;, 8)) return GF_FPROBE_SUPPORTED;</span>
<span class="lineNum">    3042 </span><span class="lineCov">       2164 :         return GF_FPROBE_NOT_SUPPORTED;</span>
<a name="3043"><span class="lineNum">    3043 </span>            : }</a>
<span class="lineNum">    3044 </span>            : 
<span class="lineNum">    3045 </span><span class="lineCov">         17 : static Bool httpout_use_alias(GF_Filter *filter, const char *url, const char *mime)</span>
<span class="lineNum">    3046 </span>            : {
<span class="lineNum">    3047 </span>            :         u32 len;
<span class="lineNum">    3048 </span>            :         char *sep;
<span class="lineNum">    3049 </span><span class="lineCov">         17 :         GF_HTTPOutCtx *ctx = (GF_HTTPOutCtx *) gf_filter_get_udta(filter);</span>
<span class="lineNum">    3050 </span>            : 
<span class="lineNum">    3051 </span>            :         //check we have same hostname. If so, accept this destination as a source for our filter
<span class="lineNum">    3052 </span><span class="lineCov">         17 :         sep = strstr(url, &quot;://&quot;);</span>
<span class="lineNum">    3053 </span><span class="lineCov">         17 :         if (!sep) return GF_FALSE;</span>
<span class="lineNum">    3054 </span><span class="lineCov">         17 :         sep += 3;</span>
<span class="lineNum">    3055 </span><span class="lineCov">         17 :         sep = strchr(sep, '/');</span>
<span class="lineNum">    3056 </span><span class="lineCov">         17 :         if (!sep) {</span>
<span class="lineNum">    3057 </span><span class="lineNoCov">          0 :                 if (!strcmp(ctx-&gt;dst, url)) return GF_TRUE;</span>
<span class="lineNum">    3058 </span><span class="lineNoCov">          0 :                 return GF_FALSE;</span>
<span class="lineNum">    3059 </span>            :         }
<span class="lineNum">    3060 </span><span class="lineCov">         17 :         len = (u32) (sep - url);</span>
<span class="lineNum">    3061 </span><span class="lineCov">         17 :         if (!strncmp(ctx-&gt;dst, url, len)) return GF_TRUE;</span>
<span class="lineNum">    3062 </span><span class="lineNoCov">          0 :         return GF_FALSE;</span>
<span class="lineNum">    3063 </span>            : }
<span class="lineNum">    3064 </span>            : 
<span class="lineNum">    3065 </span>            : static const GF_FilterCapability HTTPOutCaps[] =
<span class="lineNum">    3066 </span>            : {
<span class="lineNum">    3067 </span>            :         CAP_UINT(GF_CAPS_INPUT,GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    3068 </span>            :         CAP_STRING(GF_CAPS_INPUT,GF_PROP_PID_FILE_EXT, &quot;*&quot;),
<span class="lineNum">    3069 </span>            :         CAP_STRING(GF_CAPS_INPUT,GF_PROP_PID_MIME, &quot;*&quot;),
<span class="lineNum">    3070 </span>            :         {0},
<span class="lineNum">    3071 </span>            :         CAP_UINT(GF_CAPS_OUTPUT,GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    3072 </span>            : };
<span class="lineNum">    3073 </span>            : 
<span class="lineNum">    3074 </span>            : 
<span class="lineNum">    3075 </span>            : #define OFFS(_n)        #_n, offsetof(GF_HTTPOutCtx, _n)
<span class="lineNum">    3076 </span>            : static const GF_FilterArgs HTTPOutArgs[] =
<span class="lineNum">    3077 </span>            : {
<span class="lineNum">    3078 </span>            :         { OFFS(dst), &quot;location of destination resource - see filter help&quot;, GF_PROP_NAME, NULL, NULL, 0},
<span class="lineNum">    3079 </span>            :         { OFFS(port), &quot;server port&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, 0},
<span class="lineNum">    3080 </span>            :         { OFFS(ifce), &quot;default network interface to use&quot;, GF_PROP_STRING, NULL, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    3081 </span>            :         { OFFS(rdirs), &quot;list of directories to expose for read - see filter help&quot;, GF_PROP_STRING_LIST, NULL, NULL, 0},
<span class="lineNum">    3082 </span>            :         { OFFS(wdir), &quot;directory to expose for write - see filter help&quot;, GF_PROP_STRING, NULL, NULL, 0},
<span class="lineNum">    3083 </span>            :         { OFFS(cert), &quot;certificate file in PEM format to use for TLS mode&quot;, GF_PROP_STRING, NULL, NULL, 0},
<span class="lineNum">    3084 </span>            :         { OFFS(pkey), &quot;private key file in PEM format to use for TLS mode&quot;, GF_PROP_STRING, NULL, NULL, 0},
<span class="lineNum">    3085 </span>            :         { OFFS(block_size), &quot;block size used to read and write TCP socket&quot;, GF_PROP_UINT, &quot;10000&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    3086 </span>            :         { OFFS(user_agent), &quot;user agent string, by default solved from GPAC preferences&quot;, GF_PROP_STRING, &quot;$GUA&quot;, NULL, 0},
<span class="lineNum">    3087 </span>            :         { OFFS(close), &quot;close HTTP connection after each request&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3088 </span>            :         { OFFS(maxc), &quot;maximum number of connections, 0 is unlimited&quot;, GF_PROP_UINT, &quot;100&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3089 </span>            :         { OFFS(maxp), &quot;maximum number of connections for one peer, 0 is unlimited&quot;, GF_PROP_UINT, &quot;6&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3090 </span>            :         { OFFS(cache_control), &quot;specify the `Cache-Control` string to add; `none` disable ETag&quot;, GF_PROP_STRING, NULL, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    3091 </span>            :         { OFFS(hold), &quot;hold packets until one client connects&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    3092 </span>            :         { OFFS(hmode), &quot;filter operation mode, ignored if [-wdir]() is set. See filter help for more details. Mode can be\n&quot;
<span class="lineNum">    3093 </span>            :         &quot;- default: run in server mode (see filter help)\n&quot;
<span class="lineNum">    3094 </span>            :         &quot;- push: run in client mode using PUT or POST (see filter help)\n&quot;
<span class="lineNum">    3095 </span>            :         &quot;- source: use server as source filter on incoming PUT/POST&quot;, GF_PROP_UINT, &quot;default&quot;, &quot;default|push|source&quot;, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    3096 </span>            :         { OFFS(timeout), &quot;timeout in seconds for persistent connections; 0 disable timeout&quot;, GF_PROP_UINT, &quot;30&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    3097 </span>            :         { OFFS(ext), &quot;set extension for graph resolution, regardless of file extension&quot;, GF_PROP_NAME, NULL, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    3098 </span>            :         { OFFS(mime), &quot;set mime type for graph resolution&quot;, GF_PROP_NAME, NULL, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3099 </span>            :         { OFFS(quit), &quot;exit server once all input PIDs are done and client disconnects (for test purposes)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3100 </span>            :         { OFFS(post), &quot;use POST instead of PUT for uploading files&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3101 </span>            :         { OFFS(dlist), &quot;enable HTML listing for GET requests on directories&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3102 </span>            :         { OFFS(sutc), &quot;insert server UTC in response headers as `Server-UTC: VAL_IN_MS`&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3103 </span>            :         { OFFS(cors), &quot;insert CORS header allowing all domains\n&quot;
<span class="lineNum">    3104 </span>            :                 &quot;- off: disable CORS\n&quot;
<span class="lineNum">    3105 </span>            :                 &quot;- on: enable CORS\n&quot;
<span class="lineNum">    3106 </span>            :                 &quot;- auto: enable CORS when `Origin` is found in request&quot;, GF_PROP_UINT, &quot;auto&quot;, &quot;auto|off|on&quot;, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3107 </span>            :         { OFFS(reqlog), &quot;provide short log of the requests indicated in this option (comma separated list, `*` for all) regardless of HTTP log settings. Value `REC` logs file writing start/end&quot;, GF_PROP_STRING, NULL, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3108 </span>            :         { OFFS(ice), &quot;insert ICE meta-data in response headers in sink mode - see filter help&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3109 </span>            :         { OFFS(max_client_errors), &quot;force disconnection after specified number of consecutive errors from HTTTP 1.1 client (ignored in H/2 or when `close` is set)&quot;, GF_PROP_UINT, &quot;20&quot;, NULL, GF_FS_ARG_HINT_EXPERT},
<span class="lineNum">    3110 </span>            :         {0}
<span class="lineNum">    3111 </span>            : };
<span class="lineNum">    3112 </span>            : 
<span class="lineNum">    3113 </span>            : 
<span class="lineNum">    3114 </span>            : GF_FilterRegister HTTPOutRegister = {
<span class="lineNum">    3115 </span>            :         .name = &quot;httpout&quot;,
<span class="lineNum">    3116 </span>            :         GF_FS_SET_DESCRIPTION(&quot;HTTP Server&quot;)
<span class="lineNum">    3117 </span>            : 
<span class="lineNum">    3118 </span>            :         GF_FS_SET_HELP(&quot;The HTTP output filter can act as:\n&quot;
<span class="lineNum">    3119 </span>            :                 &quot;- a simple HTTP server\n&quot;
<span class="lineNum">    3120 </span>            :                 &quot;- an HTTP server sink\n&quot;
<span class="lineNum">    3121 </span>            :                 &quot;- an HTTP server file sink\n&quot;
<span class="lineNum">    3122 </span>            :                 &quot;- an HTTP __client__ sink\n&quot;
<span class="lineNum">    3123 </span>            :                 &quot;- an HTTP server __source__\n&quot;
<span class="lineNum">    3124 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3125 </span>            :                 &quot;The server currently handles GET, HEAD, PUT, POST, DELETE methods.\n&quot;
<span class="lineNum">    3126 </span>            :                 &quot;Single or multiple byte ranges are supported for both GET and PUT/POST methods, in all server modes.\n&quot;
<span class="lineNum">    3127 </span>            :                 &quot;- for GET, the resulting body is a single-part body formed by the concatenated byte ranges as requested (no overlap checking).\n&quot;
<span class="lineNum">    3128 </span>            :                 &quot;- for PUT/POST, the received data is pushed to the target file according to the byte ranges specified in the client request.\n&quot;
<span class="lineNum">    3129 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3130 </span>            :                 &quot;Warning: the partial PUT request is RFC2616 compliant but not compliant with RFC7230. PATCH method is not yet implemented in GPAC.\n&quot;
<span class="lineNum">    3131 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3132 </span>            :                 &quot;When a single read directory is specified, the server root `/` is the content of this directory.\n&quot;
<span class="lineNum">    3133 </span>            :                 &quot;When multiple read directories are specified, the server root `/` contains the list of the mount points with their directory names.\n&quot;
<span class="lineNum">    3134 </span>            :                 &quot;When a write directory is specified, the upload resource name identifies a file in this directory (the write directory name is not present in the URL).\n&quot;
<span class="lineNum">    3135 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3136 </span>            :                 &quot;Listing can be enabled on server using [-dlist]().\n&quot;
<span class="lineNum">    3137 </span>            :                 &quot;When disabled, a GET on a directory will fail.\n&quot;
<span class="lineNum">    3138 </span>            :                 &quot;When enabled, a GET on a directory will return a simple HTML listing of the content inspired from Apache.\n&quot;
<span class="lineNum">    3139 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3140 </span>            :                 &quot;# Simple HTTP server\n&quot;
<span class="lineNum">    3141 </span>            :                 &quot;In this mode, the filter does not need any input connection and exposes all files in the directories given by [-rdirs]().\n&quot;
<span class="lineNum">    3142 </span>            :                 &quot;PUT and POST methods are only supported if a write directory is specified by [-wdir]() option.\n&quot;
<span class="lineNum">    3143 </span>            :                 &quot;EX gpac httpout:rdirs=outcoming\n&quot;
<span class="lineNum">    3144 </span>            :                 &quot;This sets up a read-only server.\n&quot;
<span class="lineNum">    3145 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3146 </span>            :                 &quot;EX gpac httpout:wdir=incoming\n&quot;
<span class="lineNum">    3147 </span>            :                 &quot;This sets up a write-only server.\n&quot;
<span class="lineNum">    3148 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3149 </span>            :                 &quot;EX gpac httpout:rdirs=outcoming:wdir=incoming:port=8080\n&quot;
<span class="lineNum">    3150 </span>            :                 &quot;This sets up a read-write server running on [-port]() 8080.\n&quot;
<span class="lineNum">    3151 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3152 </span>            :                 &quot;# HTTP server sink\n&quot;
<span class="lineNum">    3153 </span>            :                 &quot;In this mode, the filter will forward input PIDs to connected clients, trashing the data if no client is connected unless [-hold]() is specified.\n&quot;
<span class="lineNum">    3154 </span>            :                 &quot;The filter does not use any read directory in this mode.\n&quot;
<span class="lineNum">    3155 </span>            :                 &quot;This mode is mostly useful to setup live HTTP streaming of media sessions such as MP3, MPEG-2 TS or other muxed representations:\n&quot;
<span class="lineNum">    3156 </span>            :                 &quot;EX gpac -i MP3_SOURCE -o http://localhost/live.mp3 --hold\n&quot;
<span class="lineNum">    3157 </span>            :                 &quot;In this example, the server waits for client requests on `/live.mp3` and will then push each input packet to all connected clients.\n&quot;
<span class="lineNum">    3158 </span>            :                 &quot;If the source is not real-time, you can inject a reframer filter performing realtime regulation.\n&quot;
<span class="lineNum">    3159 </span>            :                 &quot;EX gpac -i MP3_SOURCE reframer:rt=on @ -o http://localhost/live.mp3\n&quot;
<span class="lineNum">    3160 </span>            :                 &quot;In this example, the server will push each input packet to all connected clients, or trash the packet if no connected clients.\n&quot;
<span class="lineNum">    3161 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3162 </span>            :                 &quot;In this mode, ICECast meta-data can be inserted using [-ice](). The default inserted values are `ice-audio-info`, `icy-br`, `icy-pub` (set to 1) and `icy-name` if input `ServiceName` property is set.\n&quot;
<span class="lineNum">    3163 </span>            :                 &quot;The server will also look for any property called `ice-*` on the input pid and inject them.\n&quot;
<span class="lineNum">    3164 </span>            :                 &quot;EX gpac -i source.mp3:#ice-Genre=CoolRock -o http://IP/live.mp3 --ice\n&quot;
<span class="lineNum">    3165 </span>            :                 &quot;This will inject the header `ice-Genre: CoolRock` in the response.&quot;
<span class="lineNum">    3166 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3167 </span>            :                 &quot;# HTTP server file sink\n&quot;
<span class="lineNum">    3168 </span>            :                 &quot;In this mode, the filter will write input PIDs to files in the first read directory specified, acting as a file output sink.\n&quot;
<span class="lineNum">    3169 </span>            :                 &quot;The filter uses a read directory in this mode, which must be writable.\n&quot;
<span class="lineNum">    3170 </span>            :                 &quot;Upon client GET request, the server will check if the requested URL matches the name of a file currently being written by the server.\n&quot;
<span class="lineNum">    3171 </span>            :                 &quot;- If so, the server will:\n&quot;
<span class="lineNum">    3172 </span>            :                 &quot;  - send the content using HTTP chunk transfer mode, starting with what is already written on disk\n&quot;
<span class="lineNum">    3173 </span>            :                 &quot;  - push remaining data to the client as soon as received while writing it to disk, until source file is done\n&quot;
<span class="lineNum">    3174 </span>            :                 &quot;- If not so, the server will simply send the file from the disk as a regular HTTP session, without chunk transfer.\n&quot;
<span class="lineNum">    3175 </span>            :                 &quot;  \nThis mode is typically used for origin server in HAS sessions where clients may request files while they are being produced (low latency DASH).\n&quot;
<span class="lineNum">    3176 </span>            :                 &quot;EX gpac -i SOURCE reframer:rt=on @ -o http://localhost:8080/live.mpd --rdirs=temp --dmode=dynamic --cdur=0.1\n&quot;
<span class="lineNum">    3177 </span>            :                 &quot;In this example, a real-time dynamic DASH session with chunks of 100ms is created, outputting files in `temp`. A client connecting to the live edge will receive segments as they are produced using HTTP chunk transfer.\n&quot;
<span class="lineNum">    3178 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3179 </span>            :                 &quot;# HTTP client sink\n&quot;
<span class="lineNum">    3180 </span>            :                 &quot;In this mode, the filter will upload input PIDs data to remote server using PUT (or POST if [-post]() is set).\n&quot;
<span class="lineNum">    3181 </span>            :                 &quot;This mode must be explicitly activated using [-hmode]().\n&quot;
<span class="lineNum">    3182 </span>            :                 &quot;The filter uses no read or write directories in this mode.\n&quot;
<span class="lineNum">    3183 </span>            :                 &quot;EX gpac -i SOURCE -o http://targethost:8080/live.mpd:gpac:hmode=push\n&quot;
<span class="lineNum">    3184 </span>            :                 &quot;In this example, the filter will send PUT methods to the server running on [-port]() 8080 at `targethost` location (IP address or name).\n&quot;
<span class="lineNum">    3185 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3186 </span>            :                 &quot;# HTTP server source\n&quot;
<span class="lineNum">    3187 </span>            :                 &quot;In this mode, the server acts as a source rather than a sink. It declares incoming PUT or POST methods as output PIDs\n&quot;
<span class="lineNum">    3188 </span>            :                 &quot;This mode must be explicitly activated using [-hmode]().\n&quot;
<span class="lineNum">    3189 </span>            :                 &quot;The filter uses no read or write directories in this mode, and uploaded data is NOT stored by the server.\n&quot;
<span class="lineNum">    3190 </span>            :                 &quot;EX gpac httpout:hmode=source vout aout\n&quot;
<span class="lineNum">    3191 </span>            :                 &quot;In this example, the filter will try to play uploaded files through video and audio output.\n&quot;
<span class="lineNum">    3192 </span>            :                 &quot;  \n&quot;
<span class="lineNum">    3193 </span>            :                 &quot;# HTTPS server\n&quot;
<span class="lineNum">    3194 </span>            :                 &quot;The server can run over TLS (https) for all the server modes. TLS is enabled by specifying [-cert]() and [-pkey]() options.\n&quot;
<span class="lineNum">    3195 </span>            :                 &quot;Both certificate and key must be in PEM format.\n&quot;
<span class="lineNum">    3196 </span>            :                 &quot;The server currently only operates in either HTTPS or HTTP mode and cannot run both modes at the same time. You will need to use two httpout filters for this, one operating in HTTPS and one operating in HTTP.\n&quot;
<span class="lineNum">    3197 </span>            :                 )
<span class="lineNum">    3198 </span>            :         .private_size = sizeof(GF_HTTPOutCtx),
<span class="lineNum">    3199 </span>            :         .max_extra_pids = -1,
<span class="lineNum">    3200 </span>            :         .args = HTTPOutArgs,
<span class="lineNum">    3201 </span>            :         .probe_url = httpout_probe_url,
<span class="lineNum">    3202 </span>            :         .initialize = httpout_initialize,
<span class="lineNum">    3203 </span>            :         .finalize = httpout_finalize,
<span class="lineNum">    3204 </span>            :         SETCAPS(HTTPOutCaps),
<span class="lineNum">    3205 </span>            :         .configure_pid = httpout_configure_pid,
<span class="lineNum">    3206 </span>            :         .process = httpout_process,
<span class="lineNum">    3207 </span>            :         .process_event = httpout_process_event,
<span class="lineNum">    3208 </span>            :         .use_alias = httpout_use_alias
<span class="lineNum">    3209 </span>            : };
<a name="3210"><span class="lineNum">    3210 </span>            : </a>
<span class="lineNum">    3211 </span>            : 
<span class="lineNum">    3212 </span><span class="lineCov">       2877 : const GF_FilterRegister *httpout_register(GF_FilterSession *session)</span>
<span class="lineNum">    3213 </span>            : {
<span class="lineNum">    3214 </span><span class="lineCov">       2877 :         return &amp;HTTPOutRegister;</span>
<span class="lineNum">    3215 </span>            : }
<span class="lineNum">    3216 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

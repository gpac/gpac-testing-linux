<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - filters/filelist.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">filters</a> - filelist.c<span style="font-size: 80%;"> (source / <a href="filelist.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">607</td>
            <td class="headerCovTableEntry">1395</td>
            <td class="headerCovTableEntryLo">43.5 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">16</td>
            <td class="headerCovTableEntry">23</td>
            <td class="headerCovTableEntryLo">69.6 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2018-2021
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / file concatenator filter
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/filters.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;gpac/thread.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;gpac/list.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;gpac/bitstream.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;gpac/isomedia.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;gpac/network.h&gt;
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : #ifndef GPAC_DISABLE_AV_PARSERS
<span class="lineNum">      35 </span>            : #include &lt;gpac/avparse.h&gt;
<span class="lineNum">      36 </span>            : #endif
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : enum
<span class="lineNum">      39 </span>            : {
<span class="lineNum">      40 </span>            :         FLIST_STATE_STOP=0,
<span class="lineNum">      41 </span>            :         FLIST_STATE_PLAY,
<span class="lineNum">      42 </span>            :         FLIST_STATE_WAIT_PLAY,
<span class="lineNum">      43 </span>            : };
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : typedef struct
<span class="lineNum">      46 </span>            : {
<span class="lineNum">      47 </span>            :         Bool is_raw, planar;
<span class="lineNum">      48 </span>            :         u32 nb_ch, abps, sample_rate;
<span class="lineNum">      49 </span>            : } RawAudioInfo;
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            : typedef struct
<span class="lineNum">      53 </span>            : {
<span class="lineNum">      54 </span>            :         GF_FilterPid *ipid;
<span class="lineNum">      55 </span>            :         GF_FilterPid *opid;
<span class="lineNum">      56 </span>            :         GF_FilterPid *opid_aux;
<span class="lineNum">      57 </span>            :         u32 stream_type;
<span class="lineNum">      58 </span>            :         //in current timescale
<span class="lineNum">      59 </span>            :         u64 max_cts, max_dts;
<span class="lineNum">      60 </span>            :         u32 o_timescale, timescale;
<span class="lineNum">      61 </span>            :         //in output timescale
<span class="lineNum">      62 </span>            :         u64 cts_o, dts_o;
<span class="lineNum">      63 </span>            :         Bool single_frame;
<span class="lineNum">      64 </span>            :         Bool is_eos;
<span class="lineNum">      65 </span>            :         u64 dts_sub;
<span class="lineNum">      66 </span>            :         u64 first_dts_plus_one;
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            :         Bool skip_dts_init;
<span class="lineNum">      69 </span>            :         u32 play_state;
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            :         Bool send_cue;
<span class="lineNum">      72 </span>            :         s32 delay, initial_delay;
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            :         RawAudioInfo ra_info, splice_ra_info;
<span class="lineNum">      75 </span>            : 
<span class="lineNum">      76 </span>            :         s32 audio_samples_to_keep;
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            :         GF_FilterPid *splice_ipid;
<span class="lineNum">      79 </span>            :         Bool splice_ready;
<span class="lineNum">      80 </span>            : 
<span class="lineNum">      81 </span>            :         u64 cts_o_splice, dts_o_splice;
<span class="lineNum">      82 </span>            :         u64 dts_sub_splice;
<span class="lineNum">      83 </span>            :         u32 timescale_splice;
<span class="lineNum">      84 </span>            :         s32 splice_delay;
<span class="lineNum">      85 </span>            :         Bool wait_rap;
<span class="lineNum">      86 </span>            : } FileListPid;
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            : typedef struct
<span class="lineNum">      89 </span>            : {
<span class="lineNum">      90 </span>            :         char *file_name;
<span class="lineNum">      91 </span>            :         u64 last_mod_time;
<span class="lineNum">      92 </span>            :         u64 file_size;
<span class="lineNum">      93 </span>            : } FileListEntry;
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span>            : enum
<span class="lineNum">      96 </span>            : {
<span class="lineNum">      97 </span>            :         FL_SORT_NONE=0,
<span class="lineNum">      98 </span>            :         FL_SORT_NAME,
<span class="lineNum">      99 </span>            :         FL_SORT_SIZE,
<span class="lineNum">     100 </span>            :         FL_SORT_DATE,
<span class="lineNum">     101 </span>            :         FL_SORT_DATEX,
<span class="lineNum">     102 </span>            : };
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span>            : enum
<span class="lineNum">     105 </span>            : {
<span class="lineNum">     106 </span>            :         //no splicing
<span class="lineNum">     107 </span>            :         FL_SPLICE_NONE=0,
<span class="lineNum">     108 </span>            :         //waiting for splice to be active, content is main content
<span class="lineNum">     109 </span>            :         FL_SPLICE_BEFORE,
<span class="lineNum">     110 </span>            :         //splice is active, content is spliced content
<span class="lineNum">     111 </span>            :         FL_SPLICE_ACTIVE,
<span class="lineNum">     112 </span>            :         //splice no longer active, content is main content
<span class="lineNum">     113 </span>            :         FL_SPLICE_AFTER,
<span class="lineNum">     114 </span>            : };
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span>            : enum
<span class="lineNum">     117 </span>            : {
<span class="lineNum">     118 </span>            :         FL_RAW_AV=0,
<span class="lineNum">     119 </span>            :         FL_RAW_AUDIO,
<span class="lineNum">     120 </span>            :         FL_RAW_VIDEO,
<span class="lineNum">     121 </span>            :         FL_RAW_NO
<span class="lineNum">     122 </span>            : };
<span class="lineNum">     123 </span>            : 
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span>            : enum
<span class="lineNum">     126 </span>            : {
<span class="lineNum">     127 </span>            :         FL_SPLICE_DELTA = 1,
<span class="lineNum">     128 </span>            :         FL_SPLICE_FRAME = 1&lt;&lt;1,
<span class="lineNum">     129 </span>            : };
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span>            : typedef struct
<span class="lineNum">     132 </span>            : {
<span class="lineNum">     133 </span>            :         //opts
<span class="lineNum">     134 </span>            :         Bool revert, sigcues, fdel;
<span class="lineNum">     135 </span>            :         u32 raw;
<span class="lineNum">     136 </span>            :         s32 floop;
<span class="lineNum">     137 </span>            :         u32 fsort;
<span class="lineNum">     138 </span>            :         u32 ka;
<span class="lineNum">     139 </span>            :         GF_PropStringList srcs;
<span class="lineNum">     140 </span>            :         GF_Fraction fdur;
<span class="lineNum">     141 </span>            :         u32 timescale;
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span>            :         GF_FilterPid *file_pid;
<span class="lineNum">     144 </span>            :         char *file_path;
<span class="lineNum">     145 </span>            :         u32 last_url_crc;
<span class="lineNum">     146 </span>            :         u32 last_url_lineno;
<span class="lineNum">     147 </span>            :         u32 last_splice_crc;
<span class="lineNum">     148 </span>            :         u32 last_splice_lineno;
<span class="lineNum">     149 </span>            :         Bool load_next;
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span>            :         GF_List *filter_srcs;
<span class="lineNum">     152 </span>            :         GF_List *io_pids;
<span class="lineNum">     153 </span>            :         Bool is_eos;
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span>            :         GF_Fraction64 cts_offset, dts_offset, wait_dts_plus_one, dts_sub_plus_one;
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span>            :         u32 nb_repeat;
<span class="lineNum">     158 </span>            :         Double start, stop;
<span class="lineNum">     159 </span>            :         Bool do_cat, do_del, src_error;
<span class="lineNum">     160 </span>            :         u64 start_range, end_range;
<span class="lineNum">     161 </span>            :         GF_List *file_list;
<span class="lineNum">     162 </span>            :         s32 file_list_idx;
<span class="lineNum">     163 </span>            : 
<span class="lineNum">     164 </span>            :         u64 current_file_dur;
<span class="lineNum">     165 </span>            :         Bool last_is_isom;
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span>            :         u32 wait_update_start;
<span class="lineNum">     168 </span>            :         u64 last_file_modif_time;
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span>            :         Bool skip_sync;
<span class="lineNum">     171 </span>            :         Bool first_loaded;
<span class="lineNum">     172 </span>            :         char *frag_url;
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span>            :         char *unknown_params;
<span class="lineNum">     175 </span>            :         char *pid_props;
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span>            :         GF_Fraction64 splice_start, splice_end;
<span class="lineNum">     178 </span>            :         u32 flags_splice_start, flags_splice_end;
<span class="lineNum">     179 </span>            :         u32 splice_state;
<span class="lineNum">     180 </span>            :         FileListPid *splice_ctrl;
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span>            :         //splice out, in and current time in **output** timeline
<span class="lineNum">     183 </span>            :         u64 splice_end_cts, splice_start_cts, spliced_current_cts;
<span class="lineNum">     184 </span>            :         Bool wait_splice_start;
<span class="lineNum">     185 </span>            :         Bool wait_splice_end;
<span class="lineNum">     186 </span>            :         Bool wait_source;
<span class="lineNum">     187 </span>            :         GF_Fraction64 cts_offset_at_splice, dts_offset_at_splice, dts_sub_plus_one_at_splice;
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span>            :         GF_List *splice_srcs;
<span class="lineNum">     190 </span>            :         char *dyn_period_id;
<span class="lineNum">     191 </span>            :         u32 cur_splice_index;
<span class="lineNum">     192 </span>            :         u32 splice_nb_repeat;
<span class="lineNum">     193 </span>            :         Bool keep_splice, mark_only, was_kept;
<span class="lineNum">     194 </span>            :         char *splice_props;
<span class="lineNum">     195 </span>            :         char *splice_pid_props;
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span>            :         GF_Fraction64 init_splice_start, init_splice_end;
<span class="lineNum">     198 </span>            :         u32 init_flags_splice_start, init_flags_splice_end;
<span class="lineNum">     199 </span>            :         Double init_start, init_stop;
<span class="lineNum">     200 </span>            :         Bool force_splice_resume;
<span class="lineNum">     201 </span>            : } GF_FileListCtx;
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span>            : static const GF_FilterCapability FileListCapsSrc[] =
<span class="lineNum">     204 </span>            : {
<span class="lineNum">     205 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">     206 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_NONE),
<span class="lineNum">     207 </span>            : };
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span>            : static const GF_FilterCapability FileListCapsSrc_RAW_AV[] =
<span class="lineNum">     210 </span>            : {
<span class="lineNum">     211 </span>            :         //raw audio and video only
<span class="lineNum">     212 </span>            :         CAP_UINT(GF_CAPS_INPUT_OUTPUT,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_AUDIO),
<span class="lineNum">     213 </span>            :         CAP_UINT(GF_CAPS_INPUT_OUTPUT,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_VISUAL),
<span class="lineNum">     214 </span>            :         CAP_UINT(GF_CAPS_INPUT_OUTPUT,  GF_PROP_PID_CODECID, GF_CODECID_RAW),
<span class="lineNum">     215 </span>            :         {0},
<span class="lineNum">     216 </span>            :         //no restriction for media other than audio and video - cf regular caps for comments
<span class="lineNum">     217 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_AUDIO),
<span class="lineNum">     218 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_VISUAL),
<span class="lineNum">     219 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">     220 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_NONE),
<span class="lineNum">     221 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_UNFRAMED, GF_TRUE),
<span class="lineNum">     222 </span>            : };
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span>            : static const GF_FilterCapability FileListCapsSrc_RAW_A[] =
<span class="lineNum">     225 </span>            : {
<span class="lineNum">     226 </span>            :         //raw audio only
<span class="lineNum">     227 </span>            :         CAP_UINT(GF_CAPS_INPUT_OUTPUT,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_AUDIO),
<span class="lineNum">     228 </span>            :         CAP_UINT(GF_CAPS_INPUT_OUTPUT,  GF_PROP_PID_CODECID, GF_CODECID_RAW),
<span class="lineNum">     229 </span>            :         {0},
<span class="lineNum">     230 </span>            :         //no restriction for media other than audio - cf regular caps for comments
<span class="lineNum">     231 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_AUDIO),
<span class="lineNum">     232 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">     233 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_NONE),
<span class="lineNum">     234 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_UNFRAMED, GF_TRUE),
<span class="lineNum">     235 </span>            : };
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span>            : static const GF_FilterCapability FileListCapsSrc_RAW_V[] =
<span class="lineNum">     238 </span>            : {
<span class="lineNum">     239 </span>            :         //raw video only
<span class="lineNum">     240 </span>            :         CAP_UINT(GF_CAPS_INPUT_OUTPUT,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_VISUAL),
<span class="lineNum">     241 </span>            :         CAP_UINT(GF_CAPS_INPUT_OUTPUT,  GF_PROP_PID_CODECID, GF_CODECID_RAW),
<span class="lineNum">     242 </span>            :         {0},
<span class="lineNum">     243 </span>            :         //no restriction for media other than video - cf regular caps for comments
<span class="lineNum">     244 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_VISUAL),
<span class="lineNum">     245 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">     246 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED, GF_PROP_PID_CODECID, GF_CODECID_NONE),
<span class="lineNum">     247 </span>            :         CAP_UINT(GF_CAPS_INPUT_EXCLUDED,  GF_PROP_PID_UNFRAMED, GF_TRUE),
<a name="248"><span class="lineNum">     248 </span>            : };</a>
<span class="lineNum">     249 </span>            : 
<span class="lineNum">     250 </span><span class="lineCov">         61 : static void filelist_start_ipid(GF_FileListCtx *ctx, FileListPid *iopid, u32 prev_timescale)</span>
<span class="lineNum">     251 </span>            : {
<span class="lineNum">     252 </span><span class="lineCov">         61 :         iopid-&gt;is_eos = GF_FALSE;</span>
<span class="lineNum">     253 </span>            : 
<span class="lineNum">     254 </span><span class="lineCov">         61 :         if (!ctx-&gt;do_cat) {</span>
<span class="lineNum">     255 </span>            :                 GF_FilterEvent evt;
<span class="lineNum">     256 </span>            :                 //if we reattached the input, we must send a play request
<span class="lineNum">     257 </span><span class="lineCov">         34 :                 gf_filter_pid_init_play_event(iopid-&gt;ipid, &amp;evt, ctx-&gt;start, 1.0, &quot;FileList&quot;);</span>
<span class="lineNum">     258 </span><span class="lineCov">         34 :                 gf_filter_pid_send_event(iopid-&gt;ipid, &amp;evt);</span>
<span class="lineNum">     259 </span><span class="lineCov">         34 :         iopid-&gt;skip_dts_init = GF_FALSE;</span>
<span class="lineNum">     260 </span><span class="lineCov">         34 :         if (iopid-&gt;play_state==FLIST_STATE_STOP) {</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :             GF_FEVT_INIT(evt, GF_FEVT_STOP, iopid-&gt;ipid)</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :             gf_filter_pid_send_event(iopid-&gt;ipid, &amp;evt);</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :             iopid-&gt;skip_dts_init = GF_TRUE;</span>
<span class="lineNum">     264 </span>            :         }
<span class="lineNum">     265 </span>            :         }
<span class="lineNum">     266 </span>            : 
<span class="lineNum">     267 </span>            :         //and convert back cts/dts offsets to output timescale
<span class="lineNum">     268 </span><span class="lineCov">         61 :         if (ctx-&gt;dts_offset.num &amp;&amp; ctx-&gt;dts_offset.den) {</span>
<span class="lineNum">     269 </span><span class="lineCov">         58 :                 iopid-&gt;dts_o = ctx-&gt;dts_offset.num;</span>
<span class="lineNum">     270 </span><span class="lineCov">         58 :                 iopid-&gt;dts_o *= iopid-&gt;o_timescale;</span>
<span class="lineNum">     271 </span><span class="lineCov">         58 :                 iopid-&gt;dts_o /= ctx-&gt;dts_offset.den;</span>
<span class="lineNum">     272 </span>            :         } else {
<span class="lineNum">     273 </span><span class="lineCov">          3 :                 iopid-&gt;dts_o = 0;</span>
<span class="lineNum">     274 </span>            :         }
<span class="lineNum">     275 </span><span class="lineCov">         61 :         if (ctx-&gt;cts_offset.num &amp;&amp; ctx-&gt;cts_offset.den) {</span>
<span class="lineNum">     276 </span><span class="lineCov">         58 :                 iopid-&gt;cts_o = ctx-&gt;cts_offset.num;</span>
<span class="lineNum">     277 </span><span class="lineCov">         58 :                 iopid-&gt;cts_o *= iopid-&gt;o_timescale;</span>
<span class="lineNum">     278 </span><span class="lineCov">         58 :                 iopid-&gt;cts_o /= ctx-&gt;cts_offset.den;</span>
<span class="lineNum">     279 </span>            :         } else {
<span class="lineNum">     280 </span><span class="lineCov">          3 :                 iopid-&gt;cts_o = 0;</span>
<span class="lineNum">     281 </span>            :         }
<span class="lineNum">     282 </span>            :         
<span class="lineNum">     283 </span><span class="lineCov">         61 :         if (prev_timescale) {</span>
<span class="lineNum">     284 </span>            :                 u64 dts, cts;
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span>            :                 //in input timescale
<span class="lineNum">     287 </span><span class="lineCov">         61 :                 dts = iopid-&gt;max_dts - iopid-&gt;dts_sub;</span>
<span class="lineNum">     288 </span><span class="lineCov">         61 :                 cts = iopid-&gt;max_cts - iopid-&gt;dts_sub;</span>
<span class="lineNum">     289 </span>            :                 //convert to output timescale
<span class="lineNum">     290 </span><span class="lineCov">         61 :                 if (prev_timescale != iopid-&gt;o_timescale) {</span>
<span class="lineNum">     291 </span><span class="lineCov">          4 :                         dts *= iopid-&gt;o_timescale;</span>
<span class="lineNum">     292 </span><span class="lineCov">          4 :                         dts /= prev_timescale;</span>
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span><span class="lineCov">          4 :                         cts *= iopid-&gt;o_timescale;</span>
<span class="lineNum">     295 </span><span class="lineCov">          4 :                         cts /= prev_timescale;</span>
<span class="lineNum">     296 </span>            :                 }
<span class="lineNum">     297 </span><span class="lineCov">         61 :                 if (</span>
<span class="lineNum">     298 </span>            :                         //skip sync mode, do not adjust timestamps
<span class="lineNum">     299 </span><span class="lineCov">         61 :                         ctx-&gt;skip_sync</span>
<span class="lineNum">     300 </span>            :                         //in case of rounding
<span class="lineNum">     301 </span><span class="lineCov">         61 :                         || ((dts &gt; iopid-&gt;dts_o) &amp;&amp; (cts &gt; iopid-&gt;cts_o))</span>
<span class="lineNum">     302 </span>            :                 ) {
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :                         iopid-&gt;dts_o = dts;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :                         iopid-&gt;cts_o = cts;</span>
<span class="lineNum">     305 </span>            :                 }
<span class="lineNum">     306 </span>            :         }
<span class="lineNum">     307 </span><span class="lineCov">         61 :         iopid-&gt;max_cts = iopid-&gt;max_dts = 0;</span>
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span><span class="lineCov">         61 :         iopid-&gt;first_dts_plus_one = 0;</span>
<a name="310"><span class="lineNum">     310 </span><span class="lineCov">         61 : }</span></a>
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span><span class="lineCov">        119 : static Bool filelist_merge_prop(void *cbk, u32 prop_4cc, const char *prop_name, const GF_PropertyValue *src_prop)</span>
<span class="lineNum">     313 </span>            : {
<span class="lineNum">     314 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">     315 </span>            :         GF_FilterPid *pid = (GF_FilterPid *) cbk;
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineCov">        119 :         if (prop_4cc) p = gf_filter_pid_get_property(pid, prop_4cc);</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :         else p = gf_filter_pid_get_property_str(pid, prop_name);</span>
<span class="lineNum">     319 </span><span class="lineCov">        119 :         if (p) return GF_FALSE;</span>
<span class="lineNum">     320 </span><span class="lineCov">          2 :         return GF_TRUE;</span>
<a name="321"><span class="lineNum">     321 </span>            : }</a>
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span><span class="lineNoCov">          0 : static void filelist_push_period_id(GF_FileListCtx *ctx, GF_FilterPid *opid)</span>
<span class="lineNum">     324 </span>            : {
<span class="lineNum">     325 </span>            :         char szID[200];
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :         char *dyn_period = NULL;</span>
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :         gf_dynstrcat(&amp;dyn_period, ctx-&gt;dyn_period_id, NULL);</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :         sprintf(szID, &quot;_%d&quot;, ctx-&gt;cur_splice_index+1);</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :         gf_dynstrcat(&amp;dyn_period, szID, NULL);</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :         gf_filter_pid_set_property(opid, GF_PROP_PID_PERIOD_ID, &amp;PROP_STRING_NO_COPY(dyn_period));</span>
<a name="332"><span class="lineNum">     332 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span><span class="lineCov">         10 : static void filelist_override_caps(GF_Filter *filter, GF_FileListCtx *ctx)</span>
<span class="lineNum">     335 </span>            : {
<span class="lineNum">     336 </span><span class="lineCov">         10 :         switch (ctx-&gt;raw) {</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :         case FL_RAW_AV:</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                 gf_filter_override_caps(filter, FileListCapsSrc_RAW_AV, GF_ARRAY_LENGTH(FileListCapsSrc_RAW_AV) );</span>
<span class="lineNum">     339 </span>            :                 break;
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :         case FL_RAW_AUDIO:</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :                 gf_filter_override_caps(filter, FileListCapsSrc_RAW_A, GF_ARRAY_LENGTH(FileListCapsSrc_RAW_A) );</span>
<span class="lineNum">     342 </span>            :                 break;
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :         case FL_RAW_VIDEO:</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :                 gf_filter_override_caps(filter, FileListCapsSrc_RAW_V, GF_ARRAY_LENGTH(FileListCapsSrc_RAW_V) );</span>
<span class="lineNum">     345 </span>            :                 break;
<span class="lineNum">     346 </span><span class="lineCov">         10 :         default:</span>
<span class="lineNum">     347 </span><span class="lineCov">         10 :                 gf_filter_override_caps(filter, FileListCapsSrc, 2);</span>
<span class="lineNum">     348 </span>            :         }
<a name="349"><span class="lineNum">     349 </span><span class="lineCov">         10 : }</span></a>
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span><span class="lineCov">         47 : static GF_Err filelist_configure_pid(GF_Filter *filter, GF_FilterPid *pid, Bool is_remove)</span>
<span class="lineNum">     352 </span>            : {
<span class="lineNum">     353 </span>            :         FileListPid *iopid;
<span class="lineNum">     354 </span>            :         GF_FilterPid *opid = NULL;
<span class="lineNum">     355 </span>            :         const GF_PropertyValue *p;
<span class="lineNum">     356 </span>            :         u32 i, count;
<span class="lineNum">     357 </span>            :         Bool reassign = GF_FALSE;
<span class="lineNum">     358 </span>            :         Bool first_config = GF_FALSE;
<span class="lineNum">     359 </span>            :         u32 force_bitrate = 0;
<span class="lineNum">     360 </span>            :         u32 prev_timescale = 0;
<span class="lineNum">     361 </span>            :         char *src_url = NULL;
<span class="lineNum">     362 </span><span class="lineCov">         47 :         GF_FileListCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span><span class="lineCov">         47 :         if (is_remove) {</span>
<span class="lineNum">     365 </span><span class="lineCov">         10 :                 if (pid==ctx-&gt;file_pid)</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :                         ctx-&gt;file_pid = NULL;</span>
<span class="lineNum">     367 </span>            :                 else {
<span class="lineNum">     368 </span><span class="lineCov">         10 :                         iopid = gf_filter_pid_get_udta(pid);</span>
<span class="lineNum">     369 </span><span class="lineCov">         10 :                         if (iopid)</span>
<span class="lineNum">     370 </span><span class="lineCov">         10 :                                 iopid-&gt;ipid = NULL;</span>
<span class="lineNum">     371 </span>            :                 }
<span class="lineNum">     372 </span>            :                 return GF_OK;
<span class="lineNum">     373 </span>            :         }
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineCov">         37 :         if (!ctx-&gt;file_pid &amp;&amp; !ctx-&gt;file_list) {</span>
<span class="lineNum">     376 </span><span class="lineCov">          7 :                 if (! gf_filter_pid_check_caps(pid))</span>
<span class="lineNum">     377 </span>            :                         return GF_NOT_SUPPORTED;
<span class="lineNum">     378 </span><span class="lineCov">          7 :                 ctx-&gt;file_pid = pid;</span>
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span>            :                 //we will declare pids later
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span>            :                 //from now on we only accept the above caps
<span class="lineNum">     383 </span><span class="lineCov">          7 :                 filelist_override_caps(filter, ctx);</span>
<span class="lineNum">     384 </span>            :         }
<span class="lineNum">     385 </span><span class="lineCov">         37 :         if (ctx-&gt;file_pid == pid) return GF_OK;</span>
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span>            :         iopid = NULL;
<span class="lineNum">     388 </span><span class="lineCov">         23 :         count = gf_list_count(ctx-&gt;io_pids);</span>
<span class="lineNum">     389 </span><span class="lineCov">         23 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     390 </span><span class="lineCov">         13 :                 iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">     391 </span><span class="lineCov">         13 :                 if (iopid-&gt;ipid==pid) break;</span>
<span class="lineNum">     392 </span>            :                 //check matching stream types if out pit not connected, and reuse if matching
<span class="lineNum">     393 </span><span class="lineCov">         10 :                 if (!iopid-&gt;ipid) {</span>
<span class="lineNum">     394 </span><span class="lineCov">         10 :                         p = gf_filter_pid_get_property(pid, GF_PROP_PID_STREAM_TYPE);</span>
<span class="lineNum">     395 </span>            :                         assert(p);
<span class="lineNum">     396 </span><span class="lineCov">         10 :                         if (p-&gt;value.uint == iopid-&gt;stream_type) {</span>
<span class="lineNum">     397 </span><span class="lineCov">         10 :                                 iopid-&gt;ipid = pid;</span>
<span class="lineNum">     398 </span><span class="lineCov">         10 :                                 prev_timescale = iopid-&gt;timescale;</span>
<span class="lineNum">     399 </span><span class="lineCov">         10 :                                 iopid-&gt;timescale = gf_filter_pid_get_timescale(pid);</span>
<span class="lineNum">     400 </span>            :                                 reassign = GF_TRUE;
<span class="lineNum">     401 </span><span class="lineCov">         10 :                                 break;</span>
<span class="lineNum">     402 </span>            :                         }
<span class="lineNum">     403 </span>            :                 }
<span class="lineNum">     404 </span>            :                 iopid = NULL;
<span class="lineNum">     405 </span>            :         }
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span><span class="lineCov">         23 :         if (!iopid) {</span>
<span class="lineNum">     408 </span><span class="lineCov">         10 :                 GF_SAFEALLOC(iopid, FileListPid);</span>
<span class="lineNum">     409 </span><span class="lineCov">         10 :                 if (!iopid) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     410 </span><span class="lineCov">         10 :                 iopid-&gt;ipid = pid;</span>
<span class="lineNum">     411 </span><span class="lineCov">         10 :                 if (ctx-&gt;timescale) iopid-&gt;o_timescale = ctx-&gt;timescale;</span>
<span class="lineNum">     412 </span>            :                 else {
<span class="lineNum">     413 </span><span class="lineCov">         10 :                         iopid-&gt;o_timescale = gf_filter_pid_get_timescale(pid);</span>
<span class="lineNum">     414 </span><span class="lineCov">         10 :                         if (!iopid-&gt;o_timescale) iopid-&gt;o_timescale = 1000;</span>
<span class="lineNum">     415 </span>            :                 }
<span class="lineNum">     416 </span><span class="lineCov">         10 :                 gf_list_add(ctx-&gt;io_pids, iopid);</span>
<span class="lineNum">     417 </span><span class="lineCov">         10 :                 iopid-&gt;send_cue = ctx-&gt;sigcues;</span>
<span class="lineNum">     418 </span><span class="lineCov">         10 :                 iopid-&gt;play_state = FLIST_STATE_WAIT_PLAY;</span>
<span class="lineNum">     419 </span>            :                 first_config = GF_TRUE;
<span class="lineNum">     420 </span>            :         }
<span class="lineNum">     421 </span><span class="lineCov">         23 :         gf_filter_pid_set_udta(pid, iopid);</span>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineCov">         23 :         if (!iopid-&gt;opid) {</span>
<span class="lineNum">     424 </span><span class="lineCov">         10 :                 iopid-&gt;opid = gf_filter_pid_new(filter);</span>
<span class="lineNum">     425 </span><span class="lineCov">         10 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_STREAM_TYPE);</span>
<span class="lineNum">     426 </span>            :                 assert(p);
<span class="lineNum">     427 </span><span class="lineCov">         10 :                 iopid-&gt;stream_type = p-&gt;value.uint;</span>
<span class="lineNum">     428 </span>            :         }
<span class="lineNum">     429 </span><span class="lineCov">         23 :         gf_filter_pid_set_framing_mode(pid, GF_TRUE);</span>
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineCov">         23 :         if (ctx-&gt;sigcues) {</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property(iopid-&gt;opid, GF_PROP_PID_BITRATE);</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :                 if (!p) p = gf_filter_pid_get_property(iopid-&gt;ipid, GF_PROP_PID_BITRATE);</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :                 if (p) force_bitrate = p-&gt;value.uint;</span>
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property(iopid-&gt;ipid, GF_PROP_PID_URL);</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                 if (p &amp;&amp; p-&gt;value.string) src_url = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span>            :         }
<span class="lineNum">     440 </span><span class="lineCov">         23 :         opid = iopid-&gt;opid;</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineCov">         23 :         if (ctx-&gt;keep_splice &amp;&amp; (ctx-&gt;splice_state==FL_SPLICE_ACTIVE) &amp;&amp; iopid-&gt;splice_ipid) {</span>
<span class="lineNum">     443 </span>            :                 assert(!iopid-&gt;opid_aux);
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :                 iopid-&gt;opid_aux = gf_filter_pid_new(filter);</span>
<span class="lineNum">     445 </span>            :                 opid = iopid-&gt;opid_aux;
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_switch&quot;, &amp;PROP_BOOL(GF_TRUE));</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_resume&quot;, &amp;PROP_STRING(ctx-&gt;dyn_period_id ? ctx-&gt;dyn_period_id : &quot;&quot;) );</span>
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;splice_props)</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :                         gf_filter_pid_push_properties(iopid-&gt;opid, ctx-&gt;splice_props, GF_TRUE, GF_TRUE);</span>
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span>            :         } else {
<span class="lineNum">     454 </span><span class="lineCov">         23 :                 gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_switch&quot;, NULL);</span>
<span class="lineNum">     455 </span>            :         }
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span>            :         //copy properties at init or reconfig:
<span class="lineNum">     458 </span>            :         //reset (no more props)
<span class="lineNum">     459 </span><span class="lineCov">         23 :         gf_filter_pid_reset_properties(opid);</span>
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineCov">         23 :         gf_filter_pid_copy_properties(opid, iopid-&gt;ipid);</span>
<span class="lineNum">     462 </span>            : 
<span class="lineNum">     463 </span>            :         //if file pid is defined, merge its properties. This will allow forwarding user-defined properties,
<span class="lineNum">     464 </span>            :         // eg -i list.txt:#MyProp=toto to all PIDs coming from the sources
<span class="lineNum">     465 </span><span class="lineCov">         23 :         if (ctx-&gt;file_pid) {</span>
<span class="lineNum">     466 </span><span class="lineCov">         17 :                 gf_filter_pid_merge_properties(opid, ctx-&gt;file_pid, filelist_merge_prop, iopid-&gt;ipid);</span>
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span><span class="lineCov">         17 :                 p = gf_filter_pid_get_property(opid, GF_PROP_PID_MIME);</span>
<span class="lineNum">     469 </span><span class="lineCov">         17 :                 if (p &amp;&amp; p-&gt;value.string &amp;&amp; !strcmp(p-&gt;value.string, &quot;application/x-gpac-playlist&quot;))</span>
<span class="lineNum">     470 </span><span class="lineCov">          2 :                         gf_filter_pid_set_property(opid, GF_PROP_PID_MIME, NULL);</span>
<span class="lineNum">     471 </span>            :         }
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span>            :         //we could further optimize by querying the duration of all sources in the list
<span class="lineNum">     474 </span><span class="lineCov">         23 :         gf_filter_pid_set_property(opid, GF_PROP_PID_PLAYBACK_MODE, &amp;PROP_UINT(GF_PLAYBACK_MODE_NONE) );</span>
<span class="lineNum">     475 </span><span class="lineCov">         23 :         gf_filter_pid_set_property(opid, GF_PROP_PID_TIMESCALE, &amp;PROP_UINT(iopid-&gt;o_timescale) );</span>
<span class="lineNum">     476 </span><span class="lineCov">         23 :         gf_filter_pid_set_property(opid, GF_PROP_PID_NB_FRAMES, NULL );</span>
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span><span class="lineCov">         23 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_NB_FRAMES);</span>
<span class="lineNum">     479 </span><span class="lineCov">         23 :         iopid-&gt;single_frame = (p &amp;&amp; (p-&gt;value.uint==1)) ? GF_TRUE : GF_FALSE ;</span>
<span class="lineNum">     480 </span><span class="lineCov">         23 :         iopid-&gt;timescale = gf_filter_pid_get_timescale(pid);</span>
<span class="lineNum">     481 </span><span class="lineCov">         23 :         if (!iopid-&gt;timescale) iopid-&gt;timescale = 1000;</span>
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span><span class="lineCov">         23 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_CODECID);</span>
<span class="lineNum">     484 </span><span class="lineCov">         23 :         if (p &amp;&amp; (p-&gt;value.uint==GF_CODECID_RAW) &amp;&amp; (iopid-&gt;stream_type==GF_STREAM_AUDIO)) {</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_NUM_CHANNELS);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :                 iopid-&gt;ra_info.nb_ch = p ? p-&gt;value.uint : 1;</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_SAMPLE_RATE);</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :                 iopid-&gt;ra_info.sample_rate = p ? p-&gt;value.uint : 0;</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :                 iopid-&gt;ra_info.abps = 0;</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_AUDIO_FORMAT);</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :                 if (p) {</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :                         iopid-&gt;ra_info.abps = gf_audio_fmt_bit_depth(p-&gt;value.uint) / 8;</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :                         iopid-&gt;ra_info.planar = (p-&gt;value.uint &gt; GF_AUDIO_FMT_LAST_PACKED) ? 1 : 0;</span>
<span class="lineNum">     494 </span>            :                 }
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :                 iopid-&gt;ra_info.abps *= iopid-&gt;ra_info.nb_ch;</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                 iopid-&gt;ra_info.is_raw = GF_TRUE;</span>
<span class="lineNum">     497 </span>            :         } else {
<span class="lineNum">     498 </span><span class="lineCov">         23 :                 iopid-&gt;ra_info.abps = iopid-&gt;ra_info.nb_ch = iopid-&gt;ra_info.sample_rate = 0;</span>
<span class="lineNum">     499 </span><span class="lineCov">         23 :                 iopid-&gt;ra_info.is_raw = GF_FALSE;</span>
<span class="lineNum">     500 </span>            :         }
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span><span class="lineCov">         23 :         if (ctx-&gt;frag_url)</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_ORIG_FRAG_URL, &amp;PROP_NAME(ctx-&gt;frag_url) );</span>
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span><span class="lineCov">         23 :         if (ctx-&gt;sigcues) {</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :                 if (!src_url) {</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :                         gf_filter_pid_set_property(opid, GF_PROP_PID_URL, &amp;PROP_STRING(&quot;mysource&quot;) );</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                         gf_filter_pid_set_property(opid, GF_PROP_PID_FILEPATH, &amp;PROP_STRING(&quot;mysource&quot;) );</span>
<span class="lineNum">     509 </span>            :                 } else {
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :                         gf_filter_pid_set_property(opid, GF_PROP_PID_URL, &amp;PROP_STRING(src_url) );</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :                         gf_filter_pid_set_property(opid, GF_PROP_PID_FILEPATH, &amp;PROP_STRING_NO_COPY(src_url));</span>
<span class="lineNum">     512 </span>            :                 }
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :                 if (force_bitrate)</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :                         gf_filter_pid_set_property(opid, GF_PROP_PID_BITRATE, &amp;PROP_UINT(force_bitrate) );</span>
<span class="lineNum">     515 </span>            :                 else
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :                         gf_filter_pid_set_property(opid, GF_PROP_PID_BITRATE, NULL );</span>
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_DASH_CUE, &amp;PROP_STRING(&quot;inband&quot;) );</span>
<span class="lineNum">     519 </span>            :         } else {
<span class="lineNum">     520 </span><span class="lineCov">         23 :                 p = gf_filter_pid_get_property(pid, GF_PROP_PID_URL);</span>
<span class="lineNum">     521 </span><span class="lineCov">         23 :                 if (p)</span>
<span class="lineNum">     522 </span><span class="lineCov">         23 :                         gf_filter_pid_set_property(opid, GF_PROP_PID_URL, p);</span>
<span class="lineNum">     523 </span>            :         }
<span class="lineNum">     524 </span>            : 
<span class="lineNum">     525 </span><span class="lineCov">         23 :         if (ctx-&gt;pid_props) {</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :                 gf_filter_pid_push_properties(opid, ctx-&gt;pid_props, GF_TRUE, GF_TRUE);</span>
<span class="lineNum">     527 </span>            :         }
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span><span class="lineCov">         23 :         p = gf_filter_pid_get_property(pid, GF_PROP_PID_DELAY);</span>
<span class="lineNum">     530 </span><span class="lineCov">         23 :         iopid-&gt;delay = p ? (s32) p-&gt;value.longsint : 0;</span>
<span class="lineNum">     531 </span><span class="lineCov">         23 :         if (first_config) {</span>
<span class="lineNum">     532 </span><span class="lineCov">         10 :                 iopid-&gt;initial_delay = iopid-&gt;delay;</span>
<span class="lineNum">     533 </span>            :         } else {
<span class="lineNum">     534 </span><span class="lineCov">         13 :                 gf_filter_pid_set_property(opid, GF_PROP_PID_DELAY, iopid-&gt;initial_delay ? &amp;PROP_LONGSINT(iopid-&gt;initial_delay) : NULL);</span>
<span class="lineNum">     535 </span>            :         }
<span class="lineNum">     536 </span>            : 
<span class="lineNum">     537 </span><span class="lineCov">         23 :         if (ctx-&gt;splice_state==FL_SPLICE_BEFORE) {</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :                 if (!ctx-&gt;splice_ctrl) ctx-&gt;splice_ctrl = iopid;</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :                 else if (iopid-&gt;stream_type==GF_STREAM_VISUAL) ctx-&gt;splice_ctrl = iopid;</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :                 iopid-&gt;timescale_splice = iopid-&gt;timescale;</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :                 iopid-&gt;splice_delay = iopid-&gt;delay;</span>
<span class="lineNum">     542 </span>            : 
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;dyn_period_id) gf_free(ctx-&gt;dyn_period_id);</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :                 p = gf_filter_pid_get_property(opid, GF_PROP_PID_PERIOD_ID);</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :                 if (p &amp;&amp; p-&gt;value.string) {</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :                         ctx-&gt;dyn_period_id = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">     547 </span>            :                 } else {
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :                         ctx-&gt;dyn_period_id = NULL;</span>
<span class="lineNum">     549 </span>            :                 }
<span class="lineNum">     550 </span>            :         }
<span class="lineNum">     551 </span><span class="lineCov">         23 :         if (ctx-&gt;dyn_period_id) {</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :                 if ((ctx-&gt;splice_state==FL_SPLICE_BEFORE) || (ctx-&gt;splice_state==FL_SPLICE_AFTER)) {</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :                         filelist_push_period_id(ctx, opid);</span>
<span class="lineNum">     554 </span>            :                 }
<span class="lineNum">     555 </span>            :                 //reset period ID if we keep the splice, and copy it from spliced content if any
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :                 else if ((ctx-&gt;splice_state==FL_SPLICE_ACTIVE) &amp;&amp; ctx-&gt;keep_splice) {</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :                         gf_filter_pid_set_property(iopid-&gt;opid, GF_PROP_PID_PERIOD_ID, NULL);</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :                         p = gf_filter_pid_get_property(opid, GF_PROP_PID_PERIOD_ID);</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :                         if (p &amp;&amp; p-&gt;value.string)</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_property(iopid-&gt;opid, GF_PROP_PID_PERIOD_ID, p);</span>
<span class="lineNum">     561 </span>            :                 }
<span class="lineNum">     562 </span>            :         }
<span class="lineNum">     563 </span><span class="lineCov">         23 :         gf_filter_pid_set_property_str(opid, &quot;period_resume&quot;, NULL);</span>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span>            :         //if we reattached the input, we must send a play request
<span class="lineNum">     566 </span><span class="lineCov">         23 :         if (reassign) {</span>
<span class="lineNum">     567 </span><span class="lineCov">         10 :                 filelist_start_ipid(ctx, iopid, prev_timescale);</span>
<span class="lineNum">     568 </span>            :         }
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span>            :         return GF_OK;
<a name="571"><span class="lineNum">     571 </span>            : }</a>
<span class="lineNum">     572 </span>            : 
<span class="lineNum">     573 </span><span class="lineCov">        405 : static Bool filelist_process_event(GF_Filter *filter, const GF_FilterEvent *evt)</span>
<span class="lineNum">     574 </span>            : {
<span class="lineNum">     575 </span>            :         u32 i, count;
<span class="lineNum">     576 </span>            :         FileListPid *iopid;
<span class="lineNum">     577 </span>            :         GF_FilterEvent fevt;
<span class="lineNum">     578 </span><span class="lineCov">        405 :         GF_FileListCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span>            :         //manually forward event to all input, except our file in pid
<span class="lineNum">     581 </span>            :         memcpy(&amp;fevt, evt, sizeof(GF_FilterEvent));
<span class="lineNum">     582 </span><span class="lineCov">        405 :         count = gf_list_count(ctx-&gt;io_pids);</span>
<span class="lineNum">     583 </span><span class="lineCov">        803 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     584 </span><span class="lineCov">        398 :                 iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">     585 </span><span class="lineCov">        398 :                 if (!iopid-&gt;ipid) continue;</span>
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span>            :         //only send on non connected inputs or on the one matching the pid event
<span class="lineNum">     588 </span><span class="lineCov">        397 :         if (iopid-&gt;opid &amp;&amp; (iopid-&gt;opid != evt-&gt;base.on_pid))</span>
<span class="lineNum">     589 </span><span class="lineCov">        386 :             continue;</span>
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span><span class="lineCov">         11 :                 fevt.base.on_pid = iopid-&gt;ipid;</span>
<span class="lineNum">     592 </span><span class="lineCov">         11 :                 if (evt-&gt;base.type==GF_FEVT_PLAY) {</span>
<span class="lineNum">     593 </span><span class="lineCov">         10 :                         gf_filter_pid_init_play_event(iopid-&gt;ipid, &amp;fevt, ctx-&gt;start, 1.0, &quot;FileList&quot;);</span>
<span class="lineNum">     594 </span><span class="lineCov">         10 :                         iopid-&gt;play_state = FLIST_STATE_PLAY;</span>
<span class="lineNum">     595 </span><span class="lineCov">         10 :                         iopid-&gt;is_eos = GF_FALSE;</span>
<span class="lineNum">     596 </span><span class="lineCov">          1 :                 } else if (evt-&gt;base.type==GF_FEVT_STOP) {</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :                         iopid-&gt;play_state = FLIST_STATE_STOP;</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :                         iopid-&gt;is_eos = GF_TRUE;</span>
<span class="lineNum">     599 </span>            :                 }
<span class="lineNum">     600 </span><span class="lineCov">         11 :                 gf_filter_pid_send_event(iopid-&gt;ipid, &amp;fevt);</span>
<span class="lineNum">     601 </span>            :         }
<span class="lineNum">     602 </span>            :         //and cancel
<span class="lineNum">     603 </span><span class="lineCov">        405 :         return GF_TRUE;</span>
<span class="lineNum">     604 </span>            : }
<a name="605"><span class="lineNum">     605 </span>            : </a>
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span><span class="lineCov">         47 : static void filelist_check_implicit_cat(GF_FileListCtx *ctx, char *szURL)</span>
<span class="lineNum">     608 </span>            : {
<span class="lineNum">     609 </span>            :         char *res_url = NULL;
<span class="lineNum">     610 </span><span class="lineCov">         47 :         if (ctx-&gt;file_path) {</span>
<span class="lineNum">     611 </span><span class="lineCov">         41 :                 res_url = gf_url_concatenate(ctx-&gt;file_path, szURL);</span>
<span class="lineNum">     612 </span>            :                 szURL = res_url;
<span class="lineNum">     613 </span>            :         }
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineCov">         47 :         switch (gf_isom_probe_file(szURL)) {</span>
<span class="lineNum">     616 </span>            :         //this is a fragment
<span class="lineNum">     617 </span><span class="lineCov">         27 :         case 3:</span>
<span class="lineNum">     618 </span><span class="lineCov">         27 :                 if (ctx-&gt;last_is_isom) {</span>
<span class="lineNum">     619 </span><span class="lineCov">         27 :                         ctx-&gt;do_cat = GF_TRUE;</span>
<span class="lineNum">     620 </span>            :                 }
<span class="lineNum">     621 </span>            :                 break;
<span class="lineNum">     622 </span>            :         //this is a movie, reload
<span class="lineNum">     623 </span><span class="lineCov">          3 :         case 2:</span>
<span class="lineNum">     624 </span>            :         case 1:
<span class="lineNum">     625 </span><span class="lineCov">          3 :                 ctx-&gt;do_cat = GF_FALSE;</span>
<span class="lineNum">     626 </span><span class="lineCov">          3 :                 ctx-&gt;last_is_isom = GF_TRUE;</span>
<span class="lineNum">     627 </span><span class="lineCov">          3 :                 break;</span>
<span class="lineNum">     628 </span><span class="lineCov">         17 :         default:</span>
<span class="lineNum">     629 </span><span class="lineCov">         17 :                 ctx-&gt;do_cat = GF_FALSE;</span>
<span class="lineNum">     630 </span><span class="lineCov">         17 :                 ctx-&gt;last_is_isom = GF_FALSE;</span>
<span class="lineNum">     631 </span>            :         }
<span class="lineNum">     632 </span><span class="lineCov">         47 :         if (res_url)</span>
<span class="lineNum">     633 </span><span class="lineCov">         41 :                 gf_free(res_url);</span>
<a name="634"><span class="lineNum">     634 </span><span class="lineCov">         47 : }</span></a>
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span><span class="lineNoCov">          0 : static void filelist_parse_splice_time(char *aval, GF_Fraction64 *frac, u32 *flags)</span>
<span class="lineNum">     637 </span>            : {
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :         *flags = 0;</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :         if (!aval || !strlen(aval)) {</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :                 frac-&gt;num = -1;</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :                 frac-&gt;den = 1;</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     643 </span>            :         }
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :         frac-&gt;num = 0;</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :         frac-&gt;den = 0;</span>
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :         if (!stricmp(aval, &quot;now&quot;)) {</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :                 frac-&gt;num = -2;</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :                 frac-&gt;den = 1;</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     651 </span>            :         }
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :         if (strchr(aval, ':')) {</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :                 frac-&gt;den = gf_net_parse_date(aval);</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :                 frac-&gt;num = -3;</span>
<span class="lineNum">     655 </span>            :         }
<span class="lineNum">     656 </span>            : 
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :         if (aval[0]=='+') {</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :                 aval ++;</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :                 *flags |= FL_SPLICE_DELTA;</span>
<span class="lineNum">     660 </span>            :         }
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :         if (aval[0]=='F') {</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :                 aval ++;</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :                 *flags |= FL_SPLICE_FRAME;</span>
<span class="lineNum">     664 </span>            :         }
<span class="lineNum">     665 </span>            : 
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :         gf_parse_lfrac(aval, frac);</span>
<a name="667"><span class="lineNum">     667 </span>            : }</a>
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span><span class="lineCov">         57 : static Bool filelist_next_url(GF_Filter *filter, GF_FileListCtx *ctx, char szURL[GF_MAX_PATH], Bool is_splice_update)</span>
<span class="lineNum">     670 </span>            : {
<span class="lineNum">     671 </span>            :         u32 len;
<span class="lineNum">     672 </span>            :         u32 url_crc = 0;
<span class="lineNum">     673 </span>            :         Bool last_found = GF_FALSE;
<span class="lineNum">     674 </span>            :         FILE *f;
<span class="lineNum">     675 </span>            :         u32 nb_repeat=0, lineno=0;
<span class="lineNum">     676 </span><span class="lineCov">         57 :         u64 start_range=0, end_range=0;</span>
<span class="lineNum">     677 </span>            :         Double start=0, stop=0;
<span class="lineNum">     678 </span>            :         GF_Fraction64 splice_start, splice_end;
<span class="lineNum">     679 </span>            :         Bool do_cat=0;
<span class="lineNum">     680 </span>            :         Bool do_del=0;
<span class="lineNum">     681 </span>            :         Bool is_end=0;
<span class="lineNum">     682 </span>            :         Bool keep_splice=0;
<span class="lineNum">     683 </span>            :         Bool mark_only=0;
<span class="lineNum">     684 </span>            :         Bool no_sync=0;
<span class="lineNum">     685 </span><span class="lineCov">         57 :         u32 start_flags=0;</span>
<span class="lineNum">     686 </span><span class="lineCov">         57 :         u32 end_flags=0;</span>
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span><span class="lineCov">         57 :         if (ctx-&gt;file_list) {</span>
<span class="lineNum">     689 </span>            :                 FileListEntry *fentry, *next;
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span><span class="lineCov">          9 :                 if (ctx-&gt;revert) {</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :                         if (!ctx-&gt;file_list_idx) {</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :                                 if (!ctx-&gt;floop) return GF_FALSE;</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;floop&gt;0) ctx-&gt;floop--;</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :                                 ctx-&gt;file_list_idx = gf_list_count(ctx-&gt;file_list);</span>
<span class="lineNum">     696 </span>            :                         }
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :                         ctx-&gt;file_list_idx --;</span>
<span class="lineNum">     698 </span>            :                 } else {
<span class="lineNum">     699 </span><span class="lineCov">          9 :                         ctx-&gt;file_list_idx ++;</span>
<span class="lineNum">     700 </span><span class="lineCov">          9 :                         if (ctx-&gt;file_list_idx &gt;= (s32) gf_list_count(ctx-&gt;file_list)) {</span>
<span class="lineNum">     701 </span><span class="lineCov">          3 :                                 if (!ctx-&gt;floop) return GF_FALSE;</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;floop&gt;0) ctx-&gt;floop--;</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :                                 ctx-&gt;file_list_idx = 0;</span>
<span class="lineNum">     704 </span>            :                         }
<span class="lineNum">     705 </span>            :                 }
<span class="lineNum">     706 </span><span class="lineCov">          6 :                 fentry = gf_list_get(ctx-&gt;file_list, ctx-&gt;file_list_idx);</span>
<span class="lineNum">     707 </span><span class="lineCov">          6 :                 strncpy(szURL, fentry-&gt;file_name, sizeof(char)*(GF_MAX_PATH-1) );</span>
<span class="lineNum">     708 </span><span class="lineCov">          6 :                 szURL[GF_MAX_PATH-1] = 0;</span>
<span class="lineNum">     709 </span><span class="lineCov">          6 :                 filelist_check_implicit_cat(ctx, szURL);</span>
<span class="lineNum">     710 </span><span class="lineCov">          6 :                 next = gf_list_get(ctx-&gt;file_list, ctx-&gt;file_list_idx + 1);</span>
<span class="lineNum">     711 </span><span class="lineCov">          6 :                 if (next)</span>
<span class="lineNum">     712 </span><span class="lineCov">          3 :                         ctx-&gt;current_file_dur = next-&gt;last_mod_time - fentry-&gt;last_mod_time;</span>
<span class="lineNum">     713 </span>            :                 return GF_TRUE;
<span class="lineNum">     714 </span>            :         }
<span class="lineNum">     715 </span>            : 
<span class="lineNum">     716 </span><span class="lineCov">         48 :         if (ctx-&gt;wait_update_start || is_splice_update) {</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :                 u64 last_modif_time = gf_file_modification_time(ctx-&gt;file_path);</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;last_file_modif_time &gt;= last_modif_time) {</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :                         if (!is_splice_update) {</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :                                 u32 diff = gf_sys_clock() - ctx-&gt;wait_update_start;</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :                                 if (diff &gt; 60 * ctx-&gt;ka) {</span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_AUTHOR, (&quot;[FileList] Timeout refreshing playlist after %d ms, triggering eos\n&quot;, diff));</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :                                         ctx-&gt;ka = 0;</span>
<span class="lineNum">     724 </span>            :                                 }
<span class="lineNum">     725 </span>            :                         }
<span class="lineNum">     726 </span>            :                         return GF_FALSE;
<span class="lineNum">     727 </span>            :                 }
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :                 ctx-&gt;wait_update_start = 0;</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :                 ctx-&gt;last_file_modif_time = last_modif_time;</span>
<span class="lineNum">     730 </span>            :         }
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span><span class="lineCov">         48 :         splice_start.num = splice_end.num = 0;</span>
<span class="lineNum">     733 </span><span class="lineCov">         48 :         splice_start.den = splice_end.den = 0;</span>
<span class="lineNum">     734 </span>            : 
<span class="lineNum">     735 </span><span class="lineCov">         48 :         f = gf_fopen(ctx-&gt;file_path, &quot;rt&quot;);</span>
<span class="lineNum">     736 </span><span class="lineCov">        302 :         while (f) {</span>
<span class="lineNum">     737 </span><span class="lineCov">        254 :                 char *l = gf_fgets(szURL, GF_MAX_PATH, f);</span>
<span class="lineNum">     738 </span>            :                 url_crc = 0;
<span class="lineNum">     739 </span><span class="lineCov">        254 :                 if (!l || (gf_feof(f) &amp;&amp; !szURL[0]) ) {</span>
<span class="lineNum">     740 </span><span class="lineCov">          7 :                         if (ctx-&gt;floop != 0) {</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :                                 gf_fseek(f, 0, SEEK_SET);</span>
<span class="lineNum">     742 </span>            :                                 //load first line
<span class="lineNum">     743 </span>            :                                 last_found = GF_TRUE;
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     745 </span>            :                         }
<span class="lineNum">     746 </span><span class="lineCov">          7 :                         gf_fclose(f);</span>
<span class="lineNum">     747 </span><span class="lineCov">          7 :                         if (is_end) {</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :                                 ctx-&gt;ka = 0;</span>
<span class="lineNum">     749 </span><span class="lineCov">          7 :                         } else if (ctx-&gt;ka) {</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :                                 ctx-&gt;wait_update_start = gf_sys_clock();</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :                                 ctx-&gt;last_file_modif_time = gf_file_modification_time(ctx-&gt;file_path);</span>
<span class="lineNum">     752 </span>            :                         }
<span class="lineNum">     753 </span>            :                         return GF_FALSE;
<span class="lineNum">     754 </span>            :                 }
<span class="lineNum">     755 </span>            : 
<span class="lineNum">     756 </span><span class="lineCov">        247 :                 len = (u32) strlen(szURL);</span>
<span class="lineNum">     757 </span>            :                 //in keep-alive mode, each line shall end with \n, of not consider the file is not yet ready
<span class="lineNum">     758 </span><span class="lineCov">        247 :                 if (ctx-&gt;ka &amp;&amp; !is_end &amp;&amp; len &amp;&amp; (szURL[len-1]!='\n')) {</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :                         gf_fclose(f);</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :                         ctx-&gt;wait_update_start = gf_sys_clock();</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :                         ctx-&gt;last_file_modif_time = gf_file_modification_time(ctx-&gt;file_path);</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :                         return GF_FALSE;</span>
<span class="lineNum">     763 </span>            :                 }
<span class="lineNum">     764 </span>            :                 //strip all \r, \n, \t at the end
<span class="lineNum">     765 </span><span class="lineCov">        494 :                 while (len &amp;&amp; strchr(&quot;\n\r\t &quot;, szURL[len-1])) {</span>
<span class="lineNum">     766 </span><span class="lineCov">        247 :                         szURL[len-1] = 0;</span>
<span class="lineNum">     767 </span>            :                         len--;
<span class="lineNum">     768 </span>            :                 }
<span class="lineNum">     769 </span><span class="lineCov">        247 :                 if (!len) continue;</span>
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span>            :                 //comment
<span class="lineNum">     772 </span><span class="lineCov">        232 :                 if (szURL[0] == '#') {</span>
<span class="lineNum">     773 </span>            :                         //ignored line
<span class="lineNum">     774 </span><span class="lineCov">          2 :                         if (szURL[1] == '#')</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     776 </span>            : 
<span class="lineNum">     777 </span><span class="lineCov">          2 :                         char *args = szURL+1;</span>
<span class="lineNum">     778 </span>            :                         nb_repeat=0;
<span class="lineNum">     779 </span>            :                         start=stop=0;
<span class="lineNum">     780 </span>            :                         do_cat = 0;
<span class="lineNum">     781 </span><span class="lineCov">          2 :                         start_range=end_range=0;</span>
<span class="lineNum">     782 </span><span class="lineCov">          2 :                         if (ctx-&gt;pid_props) {</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :                                 gf_free(ctx-&gt;pid_props);</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :                                 ctx-&gt;pid_props = NULL;</span>
<span class="lineNum">     785 </span>            :                         }
<span class="lineNum">     786 </span>            : 
<span class="lineNum">     787 </span><span class="lineCov">          2 :                         while (args) {</span>
<span class="lineNum">     788 </span>            :                                 char c;
<span class="lineNum">     789 </span>            :                                 char *sep, *aval = NULL;
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :                                 while (args[0]==' ') args++;</span>
<span class="lineNum">     791 </span>            : 
<span class="lineNum">     792 </span><span class="lineCov">          2 :                                 sep = strchr(args, ' ');</span>
<span class="lineNum">     793 </span><span class="lineCov">          2 :                                 if (strncmp(args, &quot;props&quot;, 5))</span>
<span class="lineNum">     794 </span><span class="lineCov">          2 :                                         aval = strchr(args, ',');</span>
<span class="lineNum">     795 </span>            : 
<span class="lineNum">     796 </span><span class="lineCov">          2 :                                 if (sep &amp;&amp; aval &amp;&amp; (aval &lt; sep))</span>
<span class="lineNum">     797 </span>            :                                         sep = aval;
<span class="lineNum">     798 </span><span class="lineCov">          2 :                                 else if (aval)</span>
<span class="lineNum">     799 </span>            :                                         sep = aval;
<span class="lineNum">     800 </span>            : 
<span class="lineNum">     801 </span><span class="lineCov">          2 :                                 if (sep) {</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :                                         c = sep[0];</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :                                         sep[0] = 0;</span>
<span class="lineNum">     804 </span>            :                                 }
<span class="lineNum">     805 </span><span class="lineCov">          2 :                                 aval = strchr(args, '=');</span>
<span class="lineNum">     806 </span><span class="lineCov">          2 :                                 if (aval) {</span>
<span class="lineNum">     807 </span><span class="lineCov">          2 :                                         aval[0] = 0;</span>
<span class="lineNum">     808 </span><span class="lineCov">          2 :                                         aval++;</span>
<span class="lineNum">     809 </span>            :                                 }
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span><span class="lineCov">          2 :                                 if (!strcmp(args, &quot;repeat&quot;)) {</span>
<span class="lineNum">     812 </span><span class="lineCov">          2 :                                         if (aval)</span>
<span class="lineNum">     813 </span><span class="lineCov">          2 :                                                 nb_repeat = atoi(aval);</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;start&quot;)) {</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :                                         if (aval)</span>
<span class="lineNum">     816 </span>            :                                                 start = atof(aval);
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;stop&quot;)) {</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :                                         if (aval)</span>
<span class="lineNum">     819 </span>            :                                                 stop = atof(aval);
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;cat&quot;)) {</span>
<span class="lineNum">     821 </span>            :                                         do_cat = GF_TRUE;
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;del&quot;)) {</span>
<span class="lineNum">     823 </span>            :                                         do_del = GF_TRUE;
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :                                 } else if (do_cat &amp;&amp; !strcmp(args, &quot;srange&quot;)) {</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :                                         if (aval)</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :                                                 sscanf(aval, LLU, &amp;start_range);</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :                                 } else if (do_cat &amp;&amp; !strcmp(args, &quot;send&quot;)) {</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :                                         if (aval)</span>
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :                                                 sscanf(aval, LLU, &amp;end_range);</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :                                 } else if (ctx-&gt;ka &amp;&amp; !strcmp(args, &quot;end&quot;)) {</span>
<span class="lineNum">     831 </span>            :                                         is_end = GF_TRUE;
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;ka&quot;)) {</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :                                         sscanf(aval, &quot;%u&quot;, &amp;ctx-&gt;ka);</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;raw&quot;)) {</span>
<span class="lineNum">     835 </span>            :                                         u32 raw_type = 0;
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :                                         if (aval) {</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :                                                 if (!stricmp(aval, &quot;av&quot;)) raw_type = FL_RAW_AV;</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :                                                 else if (!stricmp(aval, &quot;a&quot;)) raw_type = FL_RAW_AUDIO;</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :                                                 else if (!stricmp(aval, &quot;v&quot;)) raw_type = FL_RAW_VIDEO;</span>
<span class="lineNum">     840 </span>            :                                         }
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :                                         if (filter &amp;&amp; (ctx-&gt;raw != raw_type) ) {</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :                                                 ctx-&gt;raw = raw_type;</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :                                                 filelist_override_caps(filter, ctx);</span>
<span class="lineNum">     844 </span>            :                                         }
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;floop&quot;)) {</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :                                         ctx-&gt;floop = atoi(aval);</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;props&quot;)) {</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :                                         if (ctx-&gt;pid_props) gf_free(ctx-&gt;pid_props);</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :                                         ctx-&gt;pid_props = aval ? gf_strdup(aval) : NULL;</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;out&quot;)) {</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :                                         filelist_parse_splice_time(aval, &amp;splice_start, &amp;start_flags);</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;in&quot;)) {</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :                                         filelist_parse_splice_time(aval, &amp;splice_end, &amp;end_flags);</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;keep&quot;)) {</span>
<span class="lineNum">     855 </span>            :                                         keep_splice = GF_TRUE;
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;mark&quot;)) {</span>
<span class="lineNum">     857 </span>            :                                         mark_only = GF_TRUE;
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;nosync&quot;)) {</span>
<span class="lineNum">     859 </span>            :                                         no_sync = GF_TRUE;
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :                                 } else if (!strcmp(args, &quot;sprops&quot;)) {</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :                                         if (ctx-&gt;splice_props) gf_free(ctx-&gt;splice_props);</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_props = aval ? gf_strdup(aval) : NULL;</span>
<span class="lineNum">     863 </span>            :                                 } else {
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :                                         if (!ctx-&gt;unknown_params || !strstr(ctx-&gt;unknown_params, args)) {</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :                                                 GF_LOG(GF_LOG_WARNING, GF_LOG_AUTHOR, (&quot;[FileList] Unrecognized directive %s, ignoring\n&quot;, args));</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :                                                 gf_dynstrcat(&amp;ctx-&gt;unknown_params, args, &quot;,&quot;);</span>
<span class="lineNum">     867 </span>            :                                         }
<span class="lineNum">     868 </span>            :                                 }
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span><span class="lineCov">          2 :                                 if (aval) aval[0] = '=';</span>
<span class="lineNum">     871 </span>            : 
<span class="lineNum">     872 </span><span class="lineCov">          2 :                                 if (!sep) break;</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :                                 sep[0] = c;</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :                                 args = sep+1;</span>
<span class="lineNum">     875 </span>            :                         }
<span class="lineNum">     876 </span><span class="lineCov">          2 :                         continue;</span>
<span class="lineNum">     877 </span>            :                 }
<span class="lineNum">     878 </span>            :                 //increase line num only for non-comment lines
<span class="lineNum">     879 </span><span class="lineCov">        230 :                 lineno++;</span>
<span class="lineNum">     880 </span>            : 
<span class="lineNum">     881 </span><span class="lineCov">        230 :                 url_crc = gf_crc_32(szURL, (u32) strlen(szURL) );</span>
<span class="lineNum">     882 </span><span class="lineCov">        230 :                 if (!ctx-&gt;last_url_crc) {</span>
<span class="lineNum">     883 </span><span class="lineCov">          7 :                         ctx-&gt;last_url_crc = url_crc;</span>
<span class="lineNum">     884 </span><span class="lineCov">          7 :                         ctx-&gt;last_url_lineno = lineno;</span>
<span class="lineNum">     885 </span><span class="lineCov">          7 :                         break;</span>
<span class="lineNum">     886 </span>            :                 }
<span class="lineNum">     887 </span><span class="lineCov">        223 :                 if ( ((ctx-&gt;last_url_crc == url_crc) &amp;&amp; (ctx-&gt;last_url_lineno == lineno))</span>
<span class="lineNum">     888 </span><span class="lineCov">        182 :                         || (is_splice_update &amp;&amp; (ctx-&gt;last_splice_crc==url_crc))</span>
<span class="lineNum">     889 </span>            :                 ) {
<span class="lineNum">     890 </span>            :                         last_found = GF_TRUE;
<span class="lineNum">     891 </span>            :                         nb_repeat=0;
<span class="lineNum">     892 </span>            :                         start=stop=0;
<span class="lineNum">     893 </span>            :                         do_cat=0;
<span class="lineNum">     894 </span><span class="lineCov">         41 :                         start_range=end_range=0;</span>
<span class="lineNum">     895 </span><span class="lineCov">         41 :                         if (is_splice_update)</span>
<span class="lineNum">     896 </span>            :                                 break;
<span class="lineNum">     897 </span><span class="lineCov">         41 :                         splice_start.den = splice_end.den = 0;</span>
<span class="lineNum">     898 </span>            :                         keep_splice = 0;
<span class="lineNum">     899 </span>            :                         mark_only = 0;
<span class="lineNum">     900 </span><span class="lineCov">         41 :                         start_flags=0;</span>
<span class="lineNum">     901 </span><span class="lineCov">         41 :                         end_flags=0;</span>
<span class="lineNum">     902 </span>            :                         no_sync=0;
<span class="lineNum">     903 </span><span class="lineCov">         41 :                         continue;</span>
<span class="lineNum">     904 </span>            :                 }
<span class="lineNum">     905 </span><span class="lineCov">        182 :                 if (last_found) {</span>
<span class="lineNum">     906 </span><span class="lineCov">         34 :                         ctx-&gt;last_url_crc = url_crc;</span>
<span class="lineNum">     907 </span><span class="lineCov">         34 :                         ctx-&gt;last_url_lineno = lineno;</span>
<span class="lineNum">     908 </span><span class="lineCov">         34 :                         break;</span>
<span class="lineNum">     909 </span>            :                 }
<span class="lineNum">     910 </span>            :                 nb_repeat=0;
<span class="lineNum">     911 </span>            :                 start=stop=0;
<span class="lineNum">     912 </span>            :                 do_cat=0;
<span class="lineNum">     913 </span>            :                 do_del=0;
<span class="lineNum">     914 </span><span class="lineCov">        148 :                 start_range=end_range=0;</span>
<span class="lineNum">     915 </span><span class="lineCov">        148 :                 splice_start.den = splice_end.den = 0;</span>
<span class="lineNum">     916 </span>            :                 keep_splice = 0;
<span class="lineNum">     917 </span>            :                 mark_only = 0;
<span class="lineNum">     918 </span><span class="lineCov">        148 :                 start_flags=0;</span>
<span class="lineNum">     919 </span><span class="lineCov">        148 :                 end_flags=0;</span>
<span class="lineNum">     920 </span>            :                 no_sync=0;
<span class="lineNum">     921 </span>            :         }
<span class="lineNum">     922 </span><span class="lineCov">         41 :         gf_fclose(f);</span>
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span><span class="lineCov">         41 :         if (is_splice_update &amp;&amp; !last_found)</span>
<span class="lineNum">     925 </span>            :                 return GF_FALSE;
<span class="lineNum">     926 </span>            : 
<span class="lineNum">     927 </span>            :         //not in active splicing and we had a splice start set, trigger a new splice
<span class="lineNum">     928 </span><span class="lineCov">         41 :         if ((ctx-&gt;splice_state != FL_SPLICE_ACTIVE) &amp;&amp; splice_start.den) {</span>
<span class="lineNum">     929 </span>            :                 //activate if:
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :                 if (</span>
<span class="lineNum">     931 </span>            :                         //new new splice start is undefined (prepare for new splice)
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :                         (splice_start.num&lt;0)</span>
<span class="lineNum">     933 </span>            :                         // or new splice start is defined and prev splice start was undefined
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :                         || ((splice_start.num&gt;=0) &amp;&amp; ((ctx-&gt;splice_start.num &lt; 0) || !ctx-&gt;splice_start.den) )</span>
<span class="lineNum">     935 </span>            :                         // or new splice time is greater than previous one
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :                         || (ctx-&gt;splice_start.num * splice_start.den &lt; splice_start.num * ctx-&gt;splice_start.den)</span>
<span class="lineNum">     937 </span>            :                 ) {
<span class="lineNum">     938 </span>            : 
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :                         ctx-&gt;init_splice_start = ctx-&gt;splice_start = splice_start;</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :                         if (!splice_end.den) {</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_end.num = -1;</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_end.den = 1;</span>
<span class="lineNum">     943 </span>            :                         } else {
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_end = splice_end;</span>
<span class="lineNum">     945 </span>            :                         }
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :                         ctx-&gt;init_splice_end = ctx-&gt;splice_end;</span>
<span class="lineNum">     947 </span>            : 
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_state = FL_SPLICE_BEFORE;</span>
<span class="lineNum">     949 </span>            :                         //items to be spliced are the ones after the spliced content
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :                         ctx-&gt;last_splice_crc = ctx-&gt;last_url_crc = url_crc;</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :                         ctx-&gt;last_url_lineno = lineno;</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :                         ctx-&gt;last_splice_lineno = lineno;</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :                         ctx-&gt;last_file_modif_time = gf_file_modification_time(ctx-&gt;file_path);</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :                         ctx-&gt;keep_splice = keep_splice;</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :                         ctx-&gt;mark_only = mark_only;</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :                         ctx-&gt;init_flags_splice_start = ctx-&gt;flags_splice_start = start_flags;</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :                         ctx-&gt;init_flags_splice_end = ctx-&gt;flags_splice_end = end_flags;</span>
<span class="lineNum">     958 </span>            : 
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :                         if (!ctx-&gt;first_loaded) {</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;splice_start.num == -2)</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_start.num = -1;</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;splice_end.num == -2)</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_end.num = -1;</span>
<span class="lineNum">     964 </span>            :                         }
<span class="lineNum">     965 </span>            :                 }
<span class="lineNum">     966 </span>            :         }
<span class="lineNum">     967 </span>            :         //in active splicing and we hava a splice end set, update splice value if previous one was undefined or not set
<span class="lineNum">     968 </span><span class="lineCov">         41 :         else if ((ctx-&gt;splice_state == FL_SPLICE_ACTIVE)  &amp;&amp; splice_end.den &amp;&amp; (!ctx-&gt;splice_end.den || (ctx-&gt;splice_end.num&lt;0))) {</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :                 ctx-&gt;init_splice_end = ctx-&gt;splice_end = splice_end;</span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :                 ctx-&gt;init_flags_splice_end = ctx-&gt;flags_splice_end = end_flags;</span>
<span class="lineNum">     971 </span>            :         }
<span class="lineNum">     972 </span>            : 
<span class="lineNum">     973 </span><span class="lineCov">         41 :         if (is_splice_update)</span>
<span class="lineNum">     974 </span>            :                 return GF_FALSE;
<span class="lineNum">     975 </span>            : 
<span class="lineNum">     976 </span><span class="lineCov">         41 :         if ((ctx-&gt;splice_state == FL_SPLICE_ACTIVE) &amp;&amp; (splice_start.den || splice_end.den)) {</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] URL %s is a main splice content but expecting a regular content in active splice\n&quot;, szURL));</span>
<span class="lineNum">     978 </span>            :                 return GF_FALSE;
<span class="lineNum">     979 </span>            :         }
<span class="lineNum">     980 </span>            : 
<span class="lineNum">     981 </span>            : 
<span class="lineNum">     982 </span><span class="lineCov">         41 :         len = (u32) strlen(szURL);</span>
<span class="lineNum">     983 </span><span class="lineCov">         82 :         while (len &amp;&amp; strchr(&quot;\r\n&quot;, szURL[len-1])) {</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :                 szURL[len-1] = 0;</span>
<span class="lineNum">     985 </span>            :                 len--;
<span class="lineNum">     986 </span>            :         }
<span class="lineNum">     987 </span><span class="lineCov">         41 :         ctx-&gt;nb_repeat = nb_repeat;</span>
<span class="lineNum">     988 </span><span class="lineCov">         41 :         ctx-&gt;start = start;</span>
<span class="lineNum">     989 </span><span class="lineCov">         41 :         ctx-&gt;stop = stop;</span>
<span class="lineNum">     990 </span><span class="lineCov">         41 :         ctx-&gt;do_cat = do_cat;</span>
<span class="lineNum">     991 </span><span class="lineCov">         41 :         ctx-&gt;skip_sync = no_sync;</span>
<span class="lineNum">     992 </span>            : 
<span class="lineNum">     993 </span><span class="lineCov">         41 :         if (!ctx-&gt;floop)</span>
<span class="lineNum">     994 </span><span class="lineCov">         41 :                 ctx-&gt;do_del = (do_del || ctx-&gt;fdel) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">     995 </span><span class="lineCov">         41 :         ctx-&gt;start_range = start_range;</span>
<span class="lineNum">     996 </span><span class="lineCov">         41 :         ctx-&gt;end_range = end_range;</span>
<span class="lineNum">     997 </span><span class="lineCov">         41 :         filelist_check_implicit_cat(ctx, szURL);</span>
<span class="lineNum">     998 </span><span class="lineCov">         41 :         return GF_TRUE;</span>
<a name="999"><span class="lineNum">     999 </span>            : }</a>
<span class="lineNum">    1000 </span>            : 
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 : static void filelist_on_filter_setup_error(GF_Filter *failed_filter, void *udta, GF_Err err)</span>
<span class="lineNum">    1002 </span>            : {
<span class="lineNum">    1003 </span>            :         u32 i, count;
<span class="lineNum">    1004 </span>            :         GF_Filter *filter = (GF_Filter *)udta;
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :         GF_FileListCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    1006 </span>            : 
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] Failed to load URL %s: %s\n&quot;, gf_filter_get_src_args(failed_filter), gf_error_to_string(err) ));</span>
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :         count = gf_list_count(ctx-&gt;io_pids);</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :                 FileListPid *iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :                 if (!iopid-&gt;ipid) continue;</span>
<span class="lineNum">    1013 </span>            : 
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :                 if (gf_filter_pid_is_filter_in_parents(iopid-&gt;ipid, failed_filter))</span>
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :                         iopid-&gt;ipid = NULL;</span>
<span class="lineNum">    1016 </span>            :         }
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :         ctx-&gt;src_error = GF_TRUE;</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :         gf_list_del_item(ctx-&gt;filter_srcs, failed_filter);</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :         gf_filter_post_process_task(filter);</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 : }</span>
<a name="1021"><span class="lineNum">    1021 </span>            : </a>
<span class="lineNum">    1022 </span>            : 
<span class="lineNum">    1023 </span><span class="lineCov">         57 : static GF_Err filelist_load_next(GF_Filter *filter, GF_FileListCtx *ctx)</span>
<span class="lineNum">    1024 </span>            : {
<span class="lineNum">    1025 </span>            :         GF_Filter *fsrc;
<span class="lineNum">    1026 </span>            :         FileListPid *iopid;
<span class="lineNum">    1027 </span>            :         u32 i, count;
<span class="lineNum">    1028 </span>            :         GF_Filter *prev_filter;
<span class="lineNum">    1029 </span>            :         GF_List *filters = NULL;
<span class="lineNum">    1030 </span>            :         char *link_args = NULL;
<span class="lineNum">    1031 </span>            :         s32 link_idx = -1;
<span class="lineNum">    1032 </span>            :         Bool is_filter_chain = GF_FALSE;
<span class="lineNum">    1033 </span><span class="lineCov">         57 :         Bool do_del = ctx-&gt;do_del;</span>
<span class="lineNum">    1034 </span>            :         GF_Err e;
<span class="lineNum">    1035 </span>            :         u32 s_idx;
<span class="lineNum">    1036 </span>            :         char *url;
<span class="lineNum">    1037 </span>            :         char szURL[GF_MAX_PATH];
<span class="lineNum">    1038 </span>            :         Bool next_url_ok;
<span class="lineNum">    1039 </span>            : 
<span class="lineNum">    1040 </span><span class="lineCov">         57 :         next_url_ok = filelist_next_url(filter, ctx, szURL, GF_FALSE);</span>
<span class="lineNum">    1041 </span>            : 
<span class="lineNum">    1042 </span><span class="lineCov">         57 :         if (!next_url_ok &amp;&amp; ctx-&gt;ka) {</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :                 gf_filter_ask_rt_reschedule(filter, ctx-&gt;ka*1000);</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1045 </span>            :         }
<span class="lineNum">    1046 </span><span class="lineCov">         57 :         count = gf_list_count(ctx-&gt;io_pids);</span>
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span><span class="lineCov">         57 :         if (ctx-&gt;wait_splice_start) {</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :                 if (!next_url_ok) {</span>
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :                         ctx-&gt;wait_splice_start = GF_FALSE;</span>
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :                         ctx-&gt;wait_source = GF_FALSE;</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] No URL for splice, ignoring splice\n&quot;));</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_state = FL_SPLICE_AFTER;</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_end_cts = ctx-&gt;splice_start_cts;</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :                         ctx-&gt;cts_offset = ctx-&gt;cts_offset_at_splice;</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :                         ctx-&gt;dts_offset = ctx-&gt;dts_offset_at_splice;</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :                         ctx-&gt;dts_sub_plus_one = ctx-&gt;dts_sub_plus_one_at_splice;</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :                         return GF_OK;</span>
<span class="lineNum">    1059 </span>            :                 }
<span class="lineNum">    1060 </span>            :                 do_del = GF_FALSE;
<span class="lineNum">    1061 </span>            :                 assert (!ctx-&gt;splice_srcs);
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :                 ctx-&gt;splice_srcs = ctx-&gt;filter_srcs;</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :                 ctx-&gt;filter_srcs = gf_list_new();</span>
<span class="lineNum">    1064 </span>            :         }
<span class="lineNum">    1065 </span>            : 
<span class="lineNum">    1066 </span><span class="lineCov">         57 :         if (do_del) {</span>
<span class="lineNum">    1067 </span>            :                 GF_FilterEvent evt;
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :                 GF_FEVT_INIT(evt, GF_FEVT_FILE_DELETE, NULL);</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :                 evt.file_del.url = &quot;__gpac_self__&quot;;</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;gf_list_count(ctx-&gt;filter_srcs); i++) {</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :                         fsrc = gf_list_get(ctx-&gt;filter_srcs, i);</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :                         gf_filter_send_event(fsrc, &amp;evt, GF_FALSE);</span>
<span class="lineNum">    1073 </span>            :                 }
<span class="lineNum">    1074 </span>            :         }
<span class="lineNum">    1075 </span><span class="lineCov">         57 :         if (!ctx-&gt;do_cat</span>
<span class="lineNum">    1076 </span>            :                 //only reset if not last entry, so that we keep the last graph setup at the end
<span class="lineNum">    1077 </span><span class="lineCov">         27 :                 &amp;&amp; next_url_ok</span>
<span class="lineNum">    1078 </span>            :         ) {
<span class="lineNum">    1079 </span><span class="lineCov">         30 :                 while (gf_list_count(ctx-&gt;filter_srcs)) {</span>
<span class="lineNum">    1080 </span><span class="lineCov">         10 :                         fsrc = gf_list_pop_back(ctx-&gt;filter_srcs);</span>
<span class="lineNum">    1081 </span><span class="lineCov">         10 :                         gf_filter_remove_src(filter, fsrc);</span>
<span class="lineNum">    1082 </span>            :                 }
<span class="lineNum">    1083 </span>            :         }
<span class="lineNum">    1084 </span>            : 
<span class="lineNum">    1085 </span>            : 
<span class="lineNum">    1086 </span><span class="lineCov">         57 :         ctx-&gt;load_next = GF_FALSE;</span>
<span class="lineNum">    1087 </span>            : 
<span class="lineNum">    1088 </span><span class="lineCov">         57 :         if (! next_url_ok) {</span>
<span class="lineNum">    1089 </span><span class="lineCov">         10 :                 if (ctx-&gt;splice_state==FL_SPLICE_ACTIVE) {</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] No next URL for splice but splice period still active, resuming splice with possible broken coding dependencies!\n&quot;));</span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :                         ctx-&gt;wait_splice_end = GF_TRUE;</span>
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_state = FL_SPLICE_AFTER;</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :                         ctx-&gt;dts_sub_plus_one.num = 1;</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :                         ctx-&gt;dts_sub_plus_one.den = 1;</span>
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :                                 FileListPid *iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :                                 iopid-&gt;splice_ready = GF_TRUE;</span>
<span class="lineNum">    1098 </span>            :                         }
<span class="lineNum">    1099 </span>            :                         return GF_OK;
<span class="lineNum">    1100 </span>            :                 }
<span class="lineNum">    1101 </span>            : 
<span class="lineNum">    1102 </span><span class="lineCov">         10 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1103 </span><span class="lineCov">         10 :                         iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1104 </span><span class="lineCov">         10 :                         gf_filter_pid_set_eos(iopid-&gt;opid);</span>
<span class="lineNum">    1105 </span><span class="lineCov">         10 :                         if (iopid-&gt;opid_aux)</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_eos(iopid-&gt;opid_aux);</span>
<span class="lineNum">    1107 </span><span class="lineCov">         10 :                         iopid-&gt;ipid = NULL;</span>
<span class="lineNum">    1108 </span>            :                 }
<span class="lineNum">    1109 </span><span class="lineCov">         10 :                 ctx-&gt;is_eos = GF_TRUE;</span>
<span class="lineNum">    1110 </span><span class="lineCov">         10 :                 return GF_EOS;</span>
<span class="lineNum">    1111 </span>            :         }
<span class="lineNum">    1112 </span><span class="lineCov">         37 :         for (i=0; i&lt;gf_list_count(ctx-&gt;io_pids); i++) {</span>
<span class="lineNum">    1113 </span><span class="lineCov">         37 :                 FileListPid *an_iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1114 </span><span class="lineCov">         37 :                 if (ctx-&gt;do_cat) {</span>
<span class="lineNum">    1115 </span><span class="lineCov">         27 :                         gf_filter_pid_clear_eos(an_iopid-&gt;ipid, GF_TRUE);</span>
<span class="lineNum">    1116 </span><span class="lineCov">         27 :                         filelist_start_ipid(ctx, an_iopid, an_iopid-&gt;timescale);</span>
<span class="lineNum">    1117 </span>            :                 } else {
<span class="lineNum">    1118 </span><span class="lineCov">         10 :                         if (ctx-&gt;wait_splice_start &amp;&amp; !an_iopid-&gt;splice_ipid) {</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :                                 an_iopid-&gt;splice_ipid = an_iopid-&gt;ipid;</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :                                 an_iopid-&gt;dts_o_splice = an_iopid-&gt;dts_o;</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :                                 an_iopid-&gt;cts_o_splice = an_iopid-&gt;cts_o;</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :                                 an_iopid-&gt;dts_sub_splice = an_iopid-&gt;dts_sub;</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :                                 an_iopid-&gt;splice_ra_info = an_iopid-&gt;ra_info;</span>
<span class="lineNum">    1124 </span>            :                         }
<span class="lineNum">    1125 </span><span class="lineCov">         10 :                         an_iopid-&gt;ipid = NULL;</span>
<span class="lineNum">    1126 </span><span class="lineCov">         10 :                         an_iopid-&gt;ra_info.is_raw = GF_FALSE;</span>
<span class="lineNum">    1127 </span>            :                 }
<span class="lineNum">    1128 </span>            :         }
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span>            :         fsrc = NULL;
<span class="lineNum">    1131 </span>            :         prev_filter = NULL;
<span class="lineNum">    1132 </span>            :         s_idx = 0;
<span class="lineNum">    1133 </span>            :         url = szURL;
<span class="lineNum">    1134 </span><span class="lineCov">         47 :         while (url) {</span>
<span class="lineNum">    1135 </span>            :                 char c = 0;
<span class="lineNum">    1136 </span>            :                 char *sep, *lsep;
<span class="lineNum">    1137 </span><span class="lineCov">         47 :                 char *sep_f = strstr(url, &quot; @&quot;);</span>
<span class="lineNum">    1138 </span>            : 
<span class="lineNum">    1139 </span><span class="lineCov">         47 :                 sep = strstr(url, &quot; &amp;&amp; &quot;);</span>
<span class="lineNum">    1140 </span><span class="lineCov">         47 :                 if (!sep &amp;&amp; ctx-&gt;srcs.nb_items)</span>
<span class="lineNum">    1141 </span><span class="lineCov">          6 :                         sep = strstr(url, &quot;&amp;&amp;&quot;);</span>
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span><span class="lineCov">         47 :                 if (sep_f &amp;&amp; ctx-&gt;do_cat) {</span>
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] Cannot use filter directives in cat mode\n&quot;));</span>
<span class="lineNum">    1145 </span>            :                         return GF_BAD_PARAM;
<span class="lineNum">    1146 </span>            :                 }
<span class="lineNum">    1147 </span>            : 
<span class="lineNum">    1148 </span><span class="lineCov">         47 :                 if (sep &amp;&amp; sep_f) {</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :                         if (sep_f &lt; sep)</span>
<span class="lineNum">    1150 </span>            :                                 sep = NULL;
<span class="lineNum">    1151 </span>            :                         else
<span class="lineNum">    1152 </span>            :                                 sep_f = NULL;
<span class="lineNum">    1153 </span>            :                 }
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span><span class="lineCov">         47 :                 if (sep) {</span>
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 :                         c = sep[0];</span>
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :                         sep[0] = 0;</span>
<span class="lineNum">    1158 </span>            :                 }
<span class="lineNum">    1159 </span><span class="lineCov">         47 :                 else if (sep_f) {</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :                         sep_f[0] = 0;</span>
<span class="lineNum">    1161 </span>            :                 }
<span class="lineNum">    1162 </span>            :                 //skip empty
<span class="lineNum">    1163 </span><span class="lineCov">         47 :                 while (url[0] == ' ')</span>
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :                         url++;</span>
<span class="lineNum">    1165 </span>            : 
<span class="lineNum">    1166 </span>            : 
<span class="lineNum">    1167 </span>            : #define SET_SOURCE(_filter, _from) \
<span class="lineNum">    1168 </span>            :                         if (link_idx&gt;0) { \
<span class="lineNum">    1169 </span>            :                                 prev_filter = gf_list_get(filters, (u32) link_idx); \
<span class="lineNum">    1170 </span>            :                                 if (!prev_filter) { \
<span class="lineNum">    1171 </span>            :                                         if (filters) gf_list_del(filters); \
<span class="lineNum">    1172 </span>            :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] Invalid link directive, filter index %d does not point to a valid filter\n&quot;)); \
<span class="lineNum">    1173 </span>            :                                         return GF_SERVICE_ERROR; \
<span class="lineNum">    1174 </span>            :                                 } \
<span class="lineNum">    1175 </span>            :                         }\
<span class="lineNum">    1176 </span>            :                         lsep = link_args ? strchr(link_args, ' ') : NULL; \
<span class="lineNum">    1177 </span>            :                         if (lsep) lsep[0] = 0; \
<span class="lineNum">    1178 </span>            :                         gf_filter_set_source(_filter, _from, link_args); \
<span class="lineNum">    1179 </span>            :                         if (lsep) lsep[0] = ' '; \
<span class="lineNum">    1180 </span>            :                         link_args = NULL;\
<span class="lineNum">    1181 </span>            :                         link_idx=-1;
<span class="lineNum">    1182 </span>            : 
<span class="lineNum">    1183 </span>            : 
<span class="lineNum">    1184 </span><span class="lineCov">         47 :                 if (!url[0]) {</span>
<span class="lineNum">    1185 </span>            :                         //last link directive before new source specifier
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :                         if (is_filter_chain &amp;&amp; prev_filter &amp;&amp; (link_idx&gt;=0)) {</span>
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :                                 SET_SOURCE(filter, prev_filter);</span>
<span class="lineNum">    1188 </span>            :                                 prev_filter = NULL;
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :                                 gf_list_reset(filters);</span>
<span class="lineNum">    1190 </span>            :                         }
<span class="lineNum">    1191 </span><span class="lineCov">         47 :                 } else if (ctx-&gt;do_cat) {</span>
<span class="lineNum">    1192 </span>            :                         char *f_url;
<span class="lineNum">    1193 </span>            :                         GF_FilterEvent evt;
<span class="lineNum">    1194 </span><span class="lineCov">         27 :                         fsrc = gf_list_get(ctx-&gt;filter_srcs, s_idx);</span>
<span class="lineNum">    1195 </span><span class="lineCov">         27 :                         if (!fsrc) {</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :                                 if (sep) sep[0] = c;</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :                                 else if (sep_f) sep_f[0] = ' ';</span>
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] More URL to cat than opened service!\n&quot;));</span>
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :                                 return GF_BAD_PARAM;</span>
<span class="lineNum">    1201 </span>            :                         }
<span class="lineNum">    1202 </span><span class="lineCov">         27 :                         f_url = gf_url_concatenate(ctx-&gt;file_path, url);</span>
<span class="lineNum">    1203 </span>            :                         memset(&amp;evt, 0, sizeof(GF_FilterEvent));
<span class="lineNum">    1204 </span><span class="lineCov">         27 :                         evt.base.type = GF_FEVT_SOURCE_SWITCH;</span>
<span class="lineNum">    1205 </span><span class="lineCov">         27 :                         evt.seek.source_switch = f_url ? f_url : url;</span>
<span class="lineNum">    1206 </span><span class="lineCov">         27 :                         evt.seek.start_offset = ctx-&gt;start_range;</span>
<span class="lineNum">    1207 </span><span class="lineCov">         27 :                         evt.seek.end_offset = ctx-&gt;end_range;</span>
<span class="lineNum">    1208 </span><span class="lineCov">         27 :                         gf_filter_send_event(fsrc, &amp;evt, GF_FALSE);</span>
<span class="lineNum">    1209 </span><span class="lineCov">         27 :                         if (f_url)</span>
<span class="lineNum">    1210 </span><span class="lineCov">         27 :                                 gf_free(f_url);</span>
<span class="lineNum">    1211 </span>            :                 } else {
<span class="lineNum">    1212 </span>            :                         GF_Filter *f = NULL;
<span class="lineNum">    1213 </span><span class="lineCov">         20 :                         if (is_filter_chain) {</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :                                 f = gf_filter_load_filter(filter, url, &amp;e);</span>
<span class="lineNum">    1215 </span>            :                         } else {
<span class="lineNum">    1216 </span><span class="lineCov">         20 :                                 fsrc = gf_filter_connect_source(filter, url, ctx-&gt;file_path, GF_TRUE, &amp;e);</span>
<span class="lineNum">    1217 </span>            : 
<span class="lineNum">    1218 </span><span class="lineCov">         20 :                                 if (fsrc)</span>
<span class="lineNum">    1219 </span><span class="lineCov">         20 :                                         gf_filter_set_setup_failure_callback(filter, fsrc, filelist_on_filter_setup_error, filter);</span>
<span class="lineNum">    1220 </span>            :                         }
<span class="lineNum">    1221 </span>            : 
<span class="lineNum">    1222 </span><span class="lineCov">         20 :                         if (e) {</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :                                 if (filters) gf_list_del(filters);</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] Failed to open file %s: %s\n&quot;, szURL, gf_error_to_string(e) ));</span>
<span class="lineNum">    1225 </span>            : 
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :                                 if (sep) sep[0] = c;</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :                                 else if (sep_f) sep_f[0] = ' ';</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :                                 if (!ctx-&gt;splice_srcs)</span>
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_state = FL_SPLICE_NONE;</span>
<span class="lineNum">    1230 </span>            :                                 return GF_SERVICE_ERROR;
<span class="lineNum">    1231 </span>            :                         }
<span class="lineNum">    1232 </span><span class="lineCov">         20 :                         if (is_filter_chain) {</span>
<span class="lineNum">    1233 </span>            : 
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :                                 if (!filters) filters = gf_list_new();</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :                                 if (!gf_list_count(filters)) gf_list_add(filters, fsrc);</span>
<span class="lineNum">    1236 </span>            : 
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :                                 SET_SOURCE(f, prev_filter);</span>
<span class="lineNum">    1238 </span>            : 
<span class="lineNum">    1239 </span>            :                                 //insert at beginning, so that link_idx=0 &lt;=&gt; last declared filter
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :                                 gf_list_insert(filters, f, 0);</span>
<span class="lineNum">    1241 </span>            :                                 prev_filter = f;
<span class="lineNum">    1242 </span>            :                         } else {
<span class="lineNum">    1243 </span><span class="lineCov">         20 :                                 gf_list_add(ctx-&gt;filter_srcs, fsrc);</span>
<span class="lineNum">    1244 </span>            :                         }
<span class="lineNum">    1245 </span>            :                 }
<span class="lineNum">    1246 </span><span class="lineCov">         47 :                 if (!sep &amp;&amp; !sep_f) break;</span>
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :                 if (sep) {</span>
<span class="lineNum">    1248 </span><span class="lineNoCov">          0 :                         sep[0] = c;</span>
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :                         url = (sep[0]==' ') ? sep+4 : sep+2;</span>
<span class="lineNum">    1250 </span>            :                         is_filter_chain = GF_FALSE;
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :                         if (prev_filter) {</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :                                 gf_filter_set_source(filter, prev_filter, NULL);</span>
<span class="lineNum">    1253 </span>            :                                 prev_filter = NULL;
<span class="lineNum">    1254 </span>            :                         }
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :                         if (filters) gf_list_reset(filters);</span>
<span class="lineNum">    1256 </span>            :                         link_idx = -1;
<span class="lineNum">    1257 </span>            :                 } else {
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :                         sep_f[0] = ' ';</span>
<span class="lineNum">    1259 </span>            : 
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :                         if (sep_f[2] != ' ') link_args = sep_f+2;</span>
<span class="lineNum">    1261 </span>            :                         else link_args = NULL;
<span class="lineNum">    1262 </span>            : 
<span class="lineNum">    1263 </span>            :                         link_idx = 0;
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :                         if (link_args) {</span>
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :                                 if (link_args[0] != '#') {</span>
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :                                         sep = strchr(link_args, '#');</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :                                         if (sep) {</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :                                                 sep[0] = 0;</span>
<span class="lineNum">    1269 </span>            :                                                 link_idx = atoi(link_args);
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :                                                 sep[0] = '#';</span>
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :                                                 link_args = sep+1;</span>
<span class="lineNum">    1272 </span>            :                                         } else {
<span class="lineNum">    1273 </span>            :                                                 link_idx = atoi(link_args);
<span class="lineNum">    1274 </span>            :                                                 link_args = NULL;
<span class="lineNum">    1275 </span>            :                                         }
<span class="lineNum">    1276 </span>            :                                         // &quot; @-1&quot; directive restart chain from source
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :                                         if (link_idx&lt;0) {</span>
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :                                                 if (prev_filter) {</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :                                                         gf_filter_set_source(filter, prev_filter, NULL);</span>
<span class="lineNum">    1280 </span>            :                                                         prev_filter = NULL;
<span class="lineNum">    1281 </span>            :                                                 }
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :                                                 if (filters) gf_list_reset(filters);</span>
<span class="lineNum">    1283 </span>            :                                         }
<span class="lineNum">    1284 </span>            : 
<span class="lineNum">    1285 </span>            :                                 } else {
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :                                         link_args++;</span>
<span class="lineNum">    1287 </span>            :                                 }
<span class="lineNum">    1288 </span>            :                         }
<span class="lineNum">    1289 </span>            : 
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :                         url = strchr(sep_f+2, ' ');</span>
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :                         if (url &amp;&amp; (url[1]!='&amp;'))</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :                                 url += 1;</span>
<span class="lineNum">    1293 </span>            : 
<span class="lineNum">    1294 </span>            :                         is_filter_chain = GF_TRUE;
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 :                         if (!prev_filter) {</span>
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :                                 if (!fsrc) {</span>
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :                                         if (filters) gf_list_del(filters);</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] Missing source declaration before filter directive\n&quot;));</span>
<span class="lineNum">    1299 </span>            :                                         return GF_BAD_PARAM;
<span class="lineNum">    1300 </span>            :                                 }
<span class="lineNum">    1301 </span>            :                                 prev_filter = fsrc;
<span class="lineNum">    1302 </span>            :                         }
<span class="lineNum">    1303 </span>            : 
<span class="lineNum">    1304 </span>            :                         //last empty link
<span class="lineNum">    1305 </span><span class="lineNoCov">          0 :                         if (!url &amp;&amp; prev_filter) {</span>
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :                                 SET_SOURCE(filter, prev_filter);</span>
<span class="lineNum">    1307 </span>            :                                 prev_filter = NULL;
<span class="lineNum">    1308 </span>            :                         }
<span class="lineNum">    1309 </span>            :                 }
<span class="lineNum">    1310 </span>            :         }
<span class="lineNum">    1311 </span><span class="lineCov">         47 :         if (prev_filter) {</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :                 gf_filter_set_source(filter, prev_filter, NULL);</span>
<span class="lineNum">    1313 </span>            :                 prev_filter = NULL;
<span class="lineNum">    1314 </span>            :         }
<span class="lineNum">    1315 </span><span class="lineCov">         47 :         if (filters) gf_list_del(filters);</span>
<span class="lineNum">    1316 </span>            :         //wait for PIDs to connect
<span class="lineNum">    1317 </span><span class="lineCov">         47 :         GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[FileList] Switching to file %s\n&quot;, szURL));</span>
<span class="lineNum">    1318 </span>            : 
<span class="lineNum">    1319 </span><span class="lineCov">         47 :         ctx-&gt;wait_splice_start = GF_FALSE;</span>
<span class="lineNum">    1320 </span><span class="lineCov">         47 :         return GF_OK;</span>
<span class="lineNum">    1321 </span>            : }
<span class="lineNum">    1322 </span>            : 
<span class="lineNum">    1323 </span>            : static s64 filelist_translate_splice_cts(FileListPid *iopid, u64 cts)
<span class="lineNum">    1324 </span>            : {
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :         if (iopid-&gt;timescale_splice != iopid-&gt;o_timescale) {</span>
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 :                 cts *= iopid-&gt;o_timescale;</span>
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :                 cts /= iopid-&gt;timescale_splice;</span>
<span class="lineNum">    1328 </span>            :         }
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :         return iopid-&gt;cts_o_splice + cts - iopid-&gt;dts_sub_splice;</span>
<a name="1330"><span class="lineNum">    1330 </span>            : }</a>
<span class="lineNum">    1331 </span>            : 
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 : static Bool filelist_check_splice(GF_FileListCtx *ctx)</span>
<span class="lineNum">    1333 </span>            : {
<span class="lineNum">    1334 </span>            :         u64 cts;
<span class="lineNum">    1335 </span>            :         u32 i, count;
<span class="lineNum">    1336 </span>            :         GF_FilterPacket *pck;
<span class="lineNum">    1337 </span>            :         GF_FilterSAPType sap;
<span class="lineNum">    1338 </span>            :         GF_FilterPid *ipid;
<span class="lineNum">    1339 </span>            :         Bool is_raw_audio;
<span class="lineNum">    1340 </span>            :         assert(ctx-&gt;splice_ctrl);
<span class="lineNum">    1341 </span>            :         assert(ctx-&gt;splice_state);
<span class="lineNum">    1342 </span>            : 
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :         ipid = ctx-&gt;splice_ctrl-&gt;splice_ipid ? ctx-&gt;splice_ctrl-&gt;splice_ipid : ctx-&gt;splice_ctrl-&gt;ipid;</span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :         is_raw_audio = ctx-&gt;splice_ctrl-&gt;splice_ipid ? ctx-&gt;splice_ctrl-&gt;splice_ra_info.is_raw : ctx-&gt;splice_ctrl-&gt;ra_info.is_raw;</span>
<span class="lineNum">    1345 </span>            : 
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :         pck = gf_filter_pid_get_packet(ipid);</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :         if (!pck) {</span>
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :                 if (!gf_filter_pid_is_eos(ipid))</span>
<span class="lineNum">    1349 </span>            :                         return GF_FALSE;
<span class="lineNum">    1350 </span>            : 
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;splice_state==FL_SPLICE_BEFORE)</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_state = FL_SPLICE_AFTER;</span>
<span class="lineNum">    1353 </span>            : 
<span class="lineNum">    1354 </span>            :                 //if we are in end of stream, abort
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;splice_state==FL_SPLICE_ACTIVE) {</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_state = FL_SPLICE_AFTER;</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_end_cts = ctx-&gt;spliced_current_cts;</span>
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :                         count = gf_list_count(ctx-&gt;io_pids);</span>
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :                                 FileListPid *iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :                                 iopid-&gt;splice_ready = GF_FALSE;</span>
<span class="lineNum">    1363 </span>            :                         }
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :                         ctx-&gt;wait_splice_end = GF_TRUE;</span>
<span class="lineNum">    1365 </span>            :                 }
<span class="lineNum">    1366 </span>            :                 return GF_TRUE;
<span class="lineNum">    1367 </span>            :         }
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :         cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :         if (cts==GF_FILTER_NO_TS)</span>
<span class="lineNum">    1370 </span>            :                 return GF_TRUE;
<span class="lineNum">    1371 </span>            : 
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :         if (ctx-&gt;splice_ctrl-&gt;splice_delay&gt;=0) {</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :                 cts += ctx-&gt;splice_ctrl-&gt;splice_delay;</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :         } else if (cts &gt; - ctx-&gt;splice_ctrl-&gt;splice_delay) {</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :                 cts += ctx-&gt;splice_ctrl-&gt;splice_delay;</span>
<span class="lineNum">    1376 </span>            :         } else {
<span class="lineNum">    1377 </span>            :                 cts = 0;
<span class="lineNum">    1378 </span>            :         }
<span class="lineNum">    1379 </span>            : 
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :         sap = is_raw_audio ? GF_FILTER_SAP_1 : gf_filter_pck_get_sap(pck);</span>
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :         if (ctx-&gt;splice_state==FL_SPLICE_BEFORE) {</span>
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :                 ctx-&gt;spliced_current_cts = filelist_translate_splice_cts(ctx-&gt;splice_ctrl, cts);</span>
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :                 if (sap &amp;&amp; (sap &lt;= GF_FILTER_SAP_3)) {</span>
<span class="lineNum">    1384 </span>            :                         u64 check_ts = cts;
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :                         if (is_raw_audio) {</span>
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :                                 check_ts += gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :                                 check_ts -= 1;</span>
<span class="lineNum">    1388 </span>            :                         }
<span class="lineNum">    1389 </span>            : 
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;splice_start.num==-1) {</span>
<span class="lineNum">    1391 </span>            :                                 char szURL[GF_MAX_PATH];
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :                                 filelist_next_url(NULL, ctx, szURL, GF_TRUE);</span>
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :                         } else if (ctx-&gt;splice_start.num==-2) {</span>
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_start.num = cts;</span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_start.den = ctx-&gt;splice_ctrl-&gt;timescale_splice;</span>
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :                         } else if (ctx-&gt;splice_start.num==-3) {</span>
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :                                 u64 now = gf_net_get_utc();</span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :                                 if (now &gt;= ctx-&gt;splice_start.den) {</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_start.num = cts;</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_start.den = ctx-&gt;splice_ctrl-&gt;timescale_splice;</span>
<span class="lineNum">    1401 </span>            :                                 }
<span class="lineNum">    1402 </span>            :                         }
<span class="lineNum">    1403 </span>            : 
<span class="lineNum">    1404 </span>            :                         //we're entering the splice period
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :                         if ((ctx-&gt;splice_start.num &gt;= 0)</span>
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :                                 &amp;&amp; ( (s64) check_ts * (s64) ctx-&gt;splice_start.den &gt;= ctx-&gt;splice_start.num * (s64) ctx-&gt;splice_ctrl-&gt;timescale_splice)</span>
<span class="lineNum">    1407 </span>            :                         ) {
<span class="lineNum">    1408 </span>            :                                 //cts larger than splice end, move directly to splice_in state
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :                                 if ((ctx-&gt;splice_end.num &gt;= 0)</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :                                         &amp;&amp; !ctx-&gt;flags_splice_end</span>
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :                                         &amp;&amp; ((s64) cts * (s64) ctx-&gt;splice_end.den &gt;= ctx-&gt;splice_end.num * ctx-&gt;splice_ctrl-&gt;timescale_splice)</span>
<span class="lineNum">    1412 </span>            :                                 ) {
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_state = FL_SPLICE_AFTER;</span>
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_end_cts = filelist_translate_splice_cts(ctx-&gt;splice_ctrl, cts);</span>
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :                                         return GF_TRUE;</span>
<span class="lineNum">    1416 </span>            :                                 }
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :                                 if (is_raw_audio) {</span>
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :                                         u64 ts_diff = ctx-&gt;splice_start.num * ctx-&gt;splice_ctrl-&gt;timescale_splice;</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :                                         ts_diff /= ctx-&gt;splice_start.den;</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :                                         if (ts_diff &gt;= cts) {</span>
<span class="lineNum">    1421 </span>            :                                                 ts_diff -= cts;
<span class="lineNum">    1422 </span>            :                                                 cts += ts_diff;
<span class="lineNum">    1423 </span>            :                                         }
<span class="lineNum">    1424 </span>            :                                 }
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_state = FL_SPLICE_ACTIVE;</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_start_cts = filelist_translate_splice_cts(ctx-&gt;splice_ctrl, cts);</span>
<span class="lineNum">    1427 </span>            :                                 //we just activate splice, iopid-&gt;dts_sub_splice is not set yet !!
<span class="lineNum">    1428 </span>            :                                 assert(!ctx-&gt;splice_ctrl-&gt;dts_sub_splice);
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_start_cts -= ctx-&gt;splice_ctrl-&gt;dts_sub;</span>
<span class="lineNum">    1430 </span>            : 
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;flags_splice_end &amp; FL_SPLICE_DELTA) {</span>
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_start.num = cts;</span>
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_start.den = ctx-&gt;splice_ctrl-&gt;timescale_splice;</span>
<span class="lineNum">    1434 </span>            :                                 }
<span class="lineNum">    1435 </span>            : 
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 :                                 count = gf_list_count(ctx-&gt;io_pids);</span>
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :                                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :                                         FileListPid *iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :                                         iopid-&gt;splice_ready = GF_FALSE;</span>
<span class="lineNum">    1440 </span>            :                                 }
<span class="lineNum">    1441 </span>            :                                 //signal on controler that we are ready for splicing
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_ctrl-&gt;splice_ready = GF_TRUE;</span>
<span class="lineNum">    1443 </span>            :                                 //but wait for all other streams to be ready too
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :                                 ctx-&gt;wait_splice_start = GF_TRUE;</span>
<span class="lineNum">    1445 </span>            :                         }
<span class="lineNum">    1446 </span>            :                 }
<span class="lineNum">    1447 </span>            :         }
<span class="lineNum">    1448 </span>            : 
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :         if (ctx-&gt;splice_state==FL_SPLICE_ACTIVE) {</span>
<span class="lineNum">    1450 </span>            :                 u64 check_ts = cts;
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :                 if (is_raw_audio) {</span>
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :                         check_ts += gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :                         check_ts -= 1;</span>
<span class="lineNum">    1454 </span>            :                 }
<span class="lineNum">    1455 </span>            : 
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;flags_splice_end &amp; FL_SPLICE_DELTA) {</span>
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :                         GF_Fraction64 s_end = ctx-&gt;splice_start;</span>
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :                         u64 diff = ctx-&gt;splice_end.num;</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :                         diff *= ctx-&gt;splice_start.den;</span>
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :                         diff /= ctx-&gt;splice_end.den;</span>
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 :                         s_end.num += diff;</span>
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_end = s_end;</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :                         ctx-&gt;flags_splice_end = 0;</span>
<span class="lineNum">    1464 </span>            :                 }
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :                 else if (ctx-&gt;splice_end.num==-1) {</span>
<span class="lineNum">    1466 </span>            :                         char szURL[GF_MAX_PATH];
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :                         filelist_next_url(NULL, ctx, szURL, GF_TRUE);</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :                 } else if (sap &amp;&amp; (sap &lt;= GF_FILTER_SAP_3)) {</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;splice_end.num==-2) {</span>
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_end.num = cts;</span>
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_end.den = ctx-&gt;splice_ctrl-&gt;timescale_splice;</span>
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :                         } else if (ctx-&gt;splice_end.num==-3) {</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :                                 u64 now = gf_net_get_utc();</span>
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :                                 if (now &gt;= ctx-&gt;splice_start.den) {</span>
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_end.num = cts;</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :                                         ctx-&gt;splice_end.den = ctx-&gt;splice_ctrl-&gt;timescale_splice;</span>
<span class="lineNum">    1477 </span>            :                                 }
<span class="lineNum">    1478 </span>            :                         }
<span class="lineNum">    1479 </span>            :                 }
<span class="lineNum">    1480 </span>            : 
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :                 if (sap &amp;&amp; (sap &lt;= GF_FILTER_SAP_3)</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :                         &amp;&amp; (ctx-&gt;splice_end.num &gt;= 0)</span>
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 :                         &amp;&amp; ((s64) check_ts * (s64) ctx-&gt;splice_end.den &gt;= ctx-&gt;splice_end.num * ctx-&gt;splice_ctrl-&gt;timescale_splice)</span>
<span class="lineNum">    1484 </span>            :                 ) {
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_state = FL_SPLICE_AFTER;</span>
<span class="lineNum">    1486 </span>            : 
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :                         if (is_raw_audio) {</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :                                 u64 ts_diff = ctx-&gt;splice_end.num * ctx-&gt;splice_ctrl-&gt;timescale_splice;</span>
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :                                 ts_diff /= ctx-&gt;splice_end.den;</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :                                 if (ts_diff &gt;= cts) {</span>
<span class="lineNum">    1491 </span>            :                                         ts_diff -= cts;
<span class="lineNum">    1492 </span>            :                                         cts += ts_diff;
<span class="lineNum">    1493 </span>            :                                 }
<span class="lineNum">    1494 </span>            :                         }
<span class="lineNum">    1495 </span>            : 
<span class="lineNum">    1496 </span>            : 
<span class="lineNum">    1497 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_end_cts = filelist_translate_splice_cts(ctx-&gt;splice_ctrl, cts);</span>
<span class="lineNum">    1498 </span>            : 
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :                         count = gf_list_count(ctx-&gt;io_pids);</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :                                 FileListPid *iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :                                 iopid-&gt;splice_ready = GF_FALSE;</span>
<span class="lineNum">    1503 </span>            :                         }
<span class="lineNum">    1504 </span>            :                         //do not signal splice ready on controler yet, we need to wait for the first frame in the splice content to have cts &gt;= splice end
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :                         ctx-&gt;wait_splice_end = GF_TRUE;</span>
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">    1507 </span>            :                 }
<span class="lineNum">    1508 </span>            : 
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :                 ctx-&gt;spliced_current_cts = filelist_translate_splice_cts(ctx-&gt;splice_ctrl, cts);</span>
<span class="lineNum">    1510 </span>            :         }
<span class="lineNum">    1511 </span>            : 
<span class="lineNum">    1512 </span>            :         return GF_TRUE;
<a name="1513"><span class="lineNum">    1513 </span>            : }</a>
<span class="lineNum">    1514 </span>            : 
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 : void filelist_copy_raw_audio(FileListPid *iopid, const u8 *src, u32 src_size, u32 offset, u8 *dst, u32 nb_samp, RawAudioInfo *ra)</span>
<span class="lineNum">    1516 </span>            : {
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :         if (iopid-&gt;ra_info.planar) {</span>
<span class="lineNum">    1518 </span>            :                 u32 i, bps, stride;
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :                 stride = src_size / ra-&gt;nb_ch;</span>
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :                 bps = ra-&gt;abps / ra-&gt;nb_ch;</span>
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;ra-&gt;nb_ch; i++) {</span>
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :                         memcpy(dst + i*bps*nb_samp, src + i*stride + offset * bps, nb_samp * bps);</span>
<span class="lineNum">    1523 </span>            :                 }
<span class="lineNum">    1524 </span>            :         } else {
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :                 memcpy(dst, src + offset * ra-&gt;abps, nb_samp * ra-&gt;abps);</span>
<span class="lineNum">    1526 </span>            :         }
<a name="1527"><span class="lineNum">    1527 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1528 </span>            : 
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 : static void filelist_forward_splice_pck(FileListPid *iopid, GF_FilterPacket *pck)</span>
<span class="lineNum">    1530 </span>            : {
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :         if (iopid-&gt;audio_samples_to_keep) {</span>
<span class="lineNum">    1532 </span>            :                 u32 nb_samp, dur;
<span class="lineNum">    1533 </span>            :                 u64 cts;
<span class="lineNum">    1534 </span>            :                 u8 *output;
<span class="lineNum">    1535 </span>            :                 const u8 *data;
<span class="lineNum">    1536 </span>            :                 GF_FilterPacket *dst_pck;
<span class="lineNum">    1537 </span>            :                 u32 pck_size, osize, offset=0;
<span class="lineNum">    1538 </span>            : 
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :                 cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :                 dur = gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">    1541 </span>            : 
<span class="lineNum">    1542 </span><span class="lineNoCov">          0 :                 data = gf_filter_pck_get_data(pck, &amp;pck_size);</span>
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :                 if (iopid-&gt;audio_samples_to_keep&gt;0) {</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :                         nb_samp = iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :                         iopid-&gt;audio_samples_to_keep = -iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1546 </span>            :                 } else {
<span class="lineNum">    1547 </span><span class="lineNoCov">          0 :                         nb_samp = pck_size / iopid-&gt;splice_ra_info.abps + iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :                         offset = -iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :                         iopid-&gt;audio_samples_to_keep = 0;</span>
<span class="lineNum">    1550 </span>            :                 }
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :                 osize = nb_samp * iopid-&gt;splice_ra_info.abps;</span>
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :                 dst_pck = gf_filter_pck_new_alloc(iopid-&gt;opid, osize, &amp;output);</span>
<span class="lineNum">    1553 </span><span class="lineNoCov">          0 :                 if (!dst_pck) return;</span>
<span class="lineNum">    1554 </span>            : 
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :                 filelist_copy_raw_audio(iopid, data, pck_size, offset, output, nb_samp, &amp;iopid-&gt;splice_ra_info);</span>
<span class="lineNum">    1556 </span>            : 
<span class="lineNum">    1557 </span>            :                 dur = nb_samp;
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :                 if (iopid-&gt;timescale_splice != iopid-&gt;splice_ra_info.sample_rate) {</span>
<span class="lineNum">    1559 </span><span class="lineNoCov">          0 :                         dur *= iopid-&gt;timescale_splice;</span>
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :                         dur /= iopid-&gt;splice_ra_info.sample_rate;</span>
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :                         offset *= iopid-&gt;timescale_splice;</span>
<span class="lineNum">    1562 </span><span class="lineNoCov">          0 :                         offset /= iopid-&gt;splice_ra_info.sample_rate;</span>
<span class="lineNum">    1563 </span>            :                 }
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 :                 cts += offset;</span>
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :                 gf_filter_pck_set_cts(dst_pck, cts);</span>
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :                 gf_filter_pck_set_dts(dst_pck, cts);</span>
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :                 gf_filter_pck_set_duration(dst_pck, dur);</span>
<span class="lineNum">    1568 </span>            : 
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :                 gf_filter_pck_send(dst_pck);</span>
<span class="lineNum">    1570 </span>            :         } else {
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :                 gf_filter_pck_forward(pck, iopid-&gt;opid);</span>
<span class="lineNum">    1572 </span>            :         }
<a name="1573"><span class="lineNum">    1573 </span>            : }</a>
<span class="lineNum">    1574 </span>            : 
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 : static void filelist_purge_slice(GF_FileListCtx *ctx)</span>
<span class="lineNum">    1576 </span>            : {
<span class="lineNum">    1577 </span><span class="lineNoCov">          0 :         u32 i, count = gf_list_count(ctx-&gt;io_pids);</span>
<span class="lineNum">    1578 </span>            :         assert(ctx-&gt;splice_ctrl);
<span class="lineNum">    1579 </span>            : 
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :         if (ctx-&gt;mark_only)</span>
<span class="lineNum">    1581 </span>            :                 return;
<span class="lineNum">    1582 </span>            :         assert(ctx-&gt;splice_ctrl-&gt;splice_ipid);
<span class="lineNum">    1583 </span>            : 
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :                 FileListPid *iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :                 if (iopid == ctx-&gt;splice_ctrl) continue;</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :                 if (!iopid-&gt;splice_ipid) continue;</span>
<span class="lineNum">    1588 </span>            : 
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :                 while (1) {</span>
<span class="lineNum">    1590 </span>            :                         u64 cts;
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :                         GF_FilterPacket *pck = gf_filter_pid_get_packet(iopid-&gt;splice_ipid);</span>
<span class="lineNum">    1592 </span><span class="lineNoCov">          0 :                         if (!pck) break;</span>
<span class="lineNum">    1593 </span>            : 
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :                         cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    1595 </span><span class="lineNoCov">          0 :                         if (cts==GF_FILTER_NO_TS) cts=0;</span>
<span class="lineNum">    1596 </span>            : 
<span class="lineNum">    1597 </span>            :                         cts = filelist_translate_splice_cts(iopid, cts);
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :                         if (cts * ctx-&gt;splice_ctrl-&gt;o_timescale &gt; ctx-&gt;spliced_current_cts * iopid-&gt;o_timescale)</span>
<span class="lineNum">    1599 </span>            :                                 break;
<span class="lineNum">    1600 </span>            : 
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;keep_splice) {</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :                                 GF_FilterPacket *pck = gf_filter_pid_get_packet(iopid-&gt;splice_ipid);</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :                                 filelist_forward_splice_pck(iopid, pck);</span>
<span class="lineNum">    1604 </span>            :                         }
<span class="lineNum">    1605 </span><span class="lineNoCov">          0 :                         gf_filter_pid_drop_packet(iopid-&gt;splice_ipid);</span>
<span class="lineNum">    1606 </span>            :                 }
<span class="lineNum">    1607 </span>            :         }
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :         if (ctx-&gt;keep_splice) {</span>
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :                 GF_FilterPacket *pck = gf_filter_pid_get_packet(ctx-&gt;splice_ctrl-&gt;splice_ipid);</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :                 filelist_forward_splice_pck(ctx-&gt;splice_ctrl, pck);</span>
<span class="lineNum">    1611 </span>            :         }
<span class="lineNum">    1612 </span>            : 
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :         gf_filter_pid_drop_packet(ctx-&gt;splice_ctrl-&gt;splice_ipid);</span>
<a name="1614"><span class="lineNum">    1614 </span>            : }</a>
<span class="lineNum">    1615 </span>            : 
<span class="lineNum">    1616 </span><span class="lineCov">       2310 : void filein_send_packet(GF_FileListCtx *ctx, FileListPid *iopid, GF_FilterPacket *pck, Bool is_splice_forced)</span>
<span class="lineNum">    1617 </span>            : {
<span class="lineNum">    1618 </span>            :         GF_FilterPacket *dst_pck;
<span class="lineNum">    1619 </span>            :         u32 dur;
<span class="lineNum">    1620 </span>            :         u64 dts, cts;
<span class="lineNum">    1621 </span><span class="lineCov">       2310 :         if (iopid-&gt;audio_samples_to_keep) {</span>
<span class="lineNum">    1622 </span>            :                 u32 nb_samp;
<span class="lineNum">    1623 </span>            :                 u8 *output;
<span class="lineNum">    1624 </span>            :                 const u8 *data;
<span class="lineNum">    1625 </span>            :                 u32 pck_size, osize, offset=0;
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :                 RawAudioInfo *ra = is_splice_forced ? &amp;iopid-&gt;splice_ra_info : &amp;iopid-&gt;ra_info;</span>
<span class="lineNum">    1627 </span>            : 
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :                 data = gf_filter_pck_get_data(pck, &amp;pck_size);</span>
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :                 if (iopid-&gt;audio_samples_to_keep&gt;0) {</span>
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :                         nb_samp = iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1631 </span>            :                 } else {
<span class="lineNum">    1632 </span><span class="lineNoCov">          0 :                         nb_samp = pck_size / ra-&gt;abps + iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :                         offset = -iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1634 </span>            :                 }
<span class="lineNum">    1635 </span>            : 
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :                 osize = ABS(iopid-&gt;audio_samples_to_keep) * ra-&gt;abps;</span>
<span class="lineNum">    1637 </span><span class="lineNoCov">          0 :                 dst_pck = gf_filter_pck_new_alloc((!is_splice_forced &amp;&amp; iopid-&gt;opid_aux) ? iopid-&gt;opid_aux : iopid-&gt;opid, osize, &amp;output);</span>
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :                 if (!dst_pck) return;</span>
<span class="lineNum">    1639 </span>            : 
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :                 filelist_copy_raw_audio(iopid, data, pck_size, offset, output, nb_samp, ra);</span>
<span class="lineNum">    1641 </span>            :         } else {
<span class="lineNum">    1642 </span><span class="lineCov">       2310 :                 dst_pck = gf_filter_pck_new_ref(iopid-&gt;opid_aux ? iopid-&gt;opid_aux : iopid-&gt;opid, 0, 0, pck);</span>
<span class="lineNum">    1643 </span><span class="lineCov">       2310 :                 if (!dst_pck) return;</span>
<span class="lineNum">    1644 </span>            :         }
<span class="lineNum">    1645 </span><span class="lineCov">       2310 :         gf_filter_pck_merge_properties(pck, dst_pck);</span>
<span class="lineNum">    1646 </span>            : 
<span class="lineNum">    1647 </span><span class="lineCov">       2310 :         dts = gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">    1648 </span><span class="lineCov">       2310 :         if (dts==GF_FILTER_NO_TS) dts=0;</span>
<span class="lineNum">    1649 </span>            : 
<span class="lineNum">    1650 </span><span class="lineCov">       2310 :         cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    1651 </span><span class="lineCov">       2310 :         if (cts==GF_FILTER_NO_TS) cts=0;</span>
<span class="lineNum">    1652 </span>            : 
<span class="lineNum">    1653 </span><span class="lineCov">       2310 :         if (iopid-&gt;single_frame &amp;&amp; (ctx-&gt;fsort==FL_SORT_DATEX) ) {</span>
<span class="lineNum">    1654 </span><span class="lineNoCov">          0 :                 dur = (u32) ctx-&gt;current_file_dur;</span>
<span class="lineNum">    1655 </span>            :                 //move from second to input pid timescale
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :                 dur *= iopid-&gt;timescale;</span>
<span class="lineNum">    1657 </span><span class="lineCov">       2345 :         } else if (iopid-&gt;single_frame &amp;&amp; ctx-&gt;fdur.num &amp;&amp; ctx-&gt;fdur.den) {</span>
<span class="lineNum">    1658 </span><span class="lineCov">         35 :                 s64 pdur = ctx-&gt;fdur.num;</span>
<span class="lineNum">    1659 </span><span class="lineCov">         35 :                 pdur *= iopid-&gt;timescale;</span>
<span class="lineNum">    1660 </span><span class="lineCov">         35 :                 pdur /= ctx-&gt;fdur.den;</span>
<span class="lineNum">    1661 </span><span class="lineCov">         35 :                 dur = (u32) pdur;</span>
<span class="lineNum">    1662 </span><span class="lineCov">       2275 :         } else if (iopid-&gt;audio_samples_to_keep) {</span>
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :                 RawAudioInfo *ra = is_splice_forced ? &amp;iopid-&gt;splice_ra_info : &amp;iopid-&gt;ra_info;</span>
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 :                 if (iopid-&gt;audio_samples_to_keep&gt;0) {</span>
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :                         dur = iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :                         if ( (iopid-&gt;splice_ipid &amp;&amp; (iopid-&gt;splice_ipid != iopid-&gt;ipid)) || (!ctx-&gt;keep_splice &amp;&amp; !ctx-&gt;mark_only))</span>
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :                                 iopid-&gt;audio_samples_to_keep = 0;</span>
<span class="lineNum">    1668 </span>            :                         else
<span class="lineNum">    1669 </span><span class="lineNoCov">          0 :                                 iopid-&gt;audio_samples_to_keep = -iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1670 </span>            :                 } else {
<span class="lineNum">    1671 </span>            :                         u32 pck_size;
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :                         gf_filter_pck_get_data(pck, &amp;pck_size);</span>
<span class="lineNum">    1673 </span><span class="lineNoCov">          0 :                         dur = pck_size/ra-&gt;abps + iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1674 </span><span class="lineNoCov">          0 :                         cts += -iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :                         dts += -iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :                         iopid-&gt;audio_samples_to_keep = 0;</span>
<span class="lineNum">    1677 </span>            :                 }
<span class="lineNum">    1678 </span><span class="lineNoCov">          0 :                 if (iopid-&gt;timescale != ra-&gt;sample_rate) {</span>
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :                         dur *= iopid-&gt;timescale;</span>
<span class="lineNum">    1680 </span><span class="lineNoCov">          0 :                         dur /= ra-&gt;sample_rate;</span>
<span class="lineNum">    1681 </span>            :                 }
<span class="lineNum">    1682 </span>            :         } else {
<span class="lineNum">    1683 </span><span class="lineCov">       2275 :                 dur = gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">    1684 </span>            :         }
<span class="lineNum">    1685 </span>            : 
<span class="lineNum">    1686 </span><span class="lineCov">       2310 :         if (iopid-&gt;timescale == iopid-&gt;o_timescale) {</span>
<span class="lineNum">    1687 </span><span class="lineCov">       1635 :                 gf_filter_pck_set_dts(dst_pck, iopid-&gt;dts_o + dts - iopid-&gt;dts_sub);</span>
<span class="lineNum">    1688 </span><span class="lineCov">       1635 :                 gf_filter_pck_set_cts(dst_pck, iopid-&gt;cts_o + cts - iopid-&gt;dts_sub);</span>
<span class="lineNum">    1689 </span><span class="lineCov">       1635 :                 gf_filter_pck_set_duration(dst_pck, dur);</span>
<span class="lineNum">    1690 </span>            :         } else {
<span class="lineNum">    1691 </span>            :                 u64 ts = dts;
<span class="lineNum">    1692 </span><span class="lineCov">        675 :                 ts *= iopid-&gt;o_timescale;</span>
<span class="lineNum">    1693 </span><span class="lineCov">        675 :                 ts /= iopid-&gt;timescale;</span>
<span class="lineNum">    1694 </span><span class="lineCov">        675 :                 gf_filter_pck_set_dts(dst_pck, iopid-&gt;dts_o + ts - iopid-&gt;dts_sub);</span>
<span class="lineNum">    1695 </span>            :                 ts = cts;
<span class="lineNum">    1696 </span><span class="lineCov">        675 :                 ts *= iopid-&gt;o_timescale;</span>
<span class="lineNum">    1697 </span><span class="lineCov">        675 :                 ts /= iopid-&gt;timescale;</span>
<span class="lineNum">    1698 </span><span class="lineCov">        675 :                 gf_filter_pck_set_cts(dst_pck, iopid-&gt;cts_o + ts - iopid-&gt;dts_sub);</span>
<span class="lineNum">    1699 </span>            : 
<span class="lineNum">    1700 </span><span class="lineCov">        675 :                 ts = dur;</span>
<span class="lineNum">    1701 </span><span class="lineCov">        675 :                 ts *= iopid-&gt;o_timescale;</span>
<span class="lineNum">    1702 </span><span class="lineCov">        675 :                 ts /= iopid-&gt;timescale;</span>
<span class="lineNum">    1703 </span><span class="lineCov">        675 :                 gf_filter_pck_set_duration(dst_pck, (u32) ts);</span>
<span class="lineNum">    1704 </span>            :         }
<span class="lineNum">    1705 </span><span class="lineCov">       2310 :         dts += dur;</span>
<span class="lineNum">    1706 </span><span class="lineCov">       2310 :         cts += dur;</span>
<span class="lineNum">    1707 </span>            : 
<span class="lineNum">    1708 </span><span class="lineCov">       2310 :         if (iopid-&gt;delay&gt;=0) {</span>
<span class="lineNum">    1709 </span><span class="lineCov">       2310 :                 cts += iopid-&gt;delay;</span>
<span class="lineNum">    1710 </span><span class="lineNoCov">          0 :         } else if (cts &gt; - iopid-&gt;delay) {</span>
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :                 cts += iopid-&gt;delay;</span>
<span class="lineNum">    1712 </span>            :         } else {
<span class="lineNum">    1713 </span>            :                 cts = 0;
<span class="lineNum">    1714 </span>            :         }
<span class="lineNum">    1715 </span>            : 
<span class="lineNum">    1716 </span><span class="lineCov">       2310 :         if (!is_splice_forced) {</span>
<span class="lineNum">    1717 </span><span class="lineCov">       2310 :                 if (dts &gt; iopid-&gt;max_dts)</span>
<span class="lineNum">    1718 </span><span class="lineCov">       2310 :                         iopid-&gt;max_dts = dts;</span>
<span class="lineNum">    1719 </span><span class="lineCov">       2310 :                 if (cts &gt; iopid-&gt;max_cts)</span>
<span class="lineNum">    1720 </span><span class="lineCov">       1755 :                         iopid-&gt;max_cts = cts;</span>
<span class="lineNum">    1721 </span>            : 
<span class="lineNum">    1722 </span>            :                 //remember our first DTS
<span class="lineNum">    1723 </span><span class="lineCov">       2310 :                 if (!iopid-&gt;first_dts_plus_one) {</span>
<span class="lineNum">    1724 </span><span class="lineCov">         68 :                         iopid-&gt;first_dts_plus_one = dts + 1;</span>
<span class="lineNum">    1725 </span>            :                 }
<span class="lineNum">    1726 </span>            : 
<span class="lineNum">    1727 </span><span class="lineCov">       2310 :                 if (iopid-&gt;send_cue) {</span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :                         iopid-&gt;send_cue = GF_FALSE;</span>
<span class="lineNum">    1729 </span><span class="lineNoCov">          0 :                         gf_filter_pck_set_property(dst_pck, GF_PROP_PCK_CUE_START, &amp;PROP_BOOL(GF_TRUE));</span>
<span class="lineNum">    1730 </span>            :                 }
<span class="lineNum">    1731 </span>            :         }
<span class="lineNum">    1732 </span>            : 
<span class="lineNum">    1733 </span><span class="lineCov">       2310 :         gf_filter_pck_send(dst_pck);</span>
<span class="lineNum">    1734 </span>            : 
<span class="lineNum">    1735 </span><span class="lineCov">       2310 :         if (!iopid-&gt;audio_samples_to_keep) {</span>
<span class="lineNum">    1736 </span><span class="lineCov">       2310 :                 gf_filter_pid_drop_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    1737 </span>            :         }
<a name="1738"><span class="lineNum">    1738 </span>            : }</a>
<span class="lineNum">    1739 </span>            : 
<span class="lineNum">    1740 </span><span class="lineCov">       2913 : static GF_Err filelist_process(GF_Filter *filter)</span>
<span class="lineNum">    1741 </span>            : {
<span class="lineNum">    1742 </span>            :         Bool start, end, purge_splice = GF_FALSE;
<span class="lineNum">    1743 </span>            :         u32 i, count, nb_done, nb_inactive, nb_stop, nb_ready;
<span class="lineNum">    1744 </span>            :         FileListPid *iopid;
<span class="lineNum">    1745 </span><span class="lineCov">       2913 :         GF_FileListCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    1746 </span>            : 
<span class="lineNum">    1747 </span>            : 
<span class="lineNum">    1748 </span><span class="lineCov">       2913 :         if (!ctx-&gt;file_list) {</span>
<span class="lineNum">    1749 </span>            :                 GF_FilterPacket *pck;
<span class="lineNum">    1750 </span><span class="lineCov">       2439 :                 if (!ctx-&gt;file_pid) {</span>
<span class="lineNum">    1751 </span>            :                         return GF_EOS;
<span class="lineNum">    1752 </span>            :                 }
<span class="lineNum">    1753 </span><span class="lineCov">       2439 :                 pck = gf_filter_pid_get_packet(ctx-&gt;file_pid);</span>
<span class="lineNum">    1754 </span><span class="lineCov">       2439 :                 if (pck) {</span>
<span class="lineNum">    1755 </span><span class="lineCov">          7 :                         gf_filter_pck_get_framing(pck, &amp;start, &amp;end);</span>
<span class="lineNum">    1756 </span><span class="lineCov">          7 :                         gf_filter_pid_drop_packet(ctx-&gt;file_pid);</span>
<span class="lineNum">    1757 </span>            : 
<span class="lineNum">    1758 </span><span class="lineCov">          7 :                         if (end) {</span>
<span class="lineNum">    1759 </span>            :                                 const GF_PropertyValue *p;
<span class="lineNum">    1760 </span>            :                                 Bool is_first = GF_TRUE;
<span class="lineNum">    1761 </span>            :                                 FILE *f=NULL;
<span class="lineNum">    1762 </span><span class="lineCov">          7 :                                 p = gf_filter_pid_get_property(ctx-&gt;file_pid, GF_PROP_PID_FILEPATH);</span>
<span class="lineNum">    1763 </span><span class="lineCov">          7 :                                 if (p) {</span>
<span class="lineNum">    1764 </span>            :                                         char *frag;
<span class="lineNum">    1765 </span><span class="lineCov">          7 :                                         if (ctx-&gt;file_path) {</span>
<span class="lineNum">    1766 </span><span class="lineNoCov">          0 :                                                 gf_free(ctx-&gt;file_path);</span>
<span class="lineNum">    1767 </span>            :                                                 is_first = GF_FALSE;
<span class="lineNum">    1768 </span>            :                                         }
<span class="lineNum">    1769 </span><span class="lineCov">          7 :                                         ctx-&gt;file_path = gf_strdup(p-&gt;value.string);</span>
<span class="lineNum">    1770 </span><span class="lineCov">          7 :                                         frag = strchr(ctx-&gt;file_path, '#');</span>
<span class="lineNum">    1771 </span><span class="lineCov">          7 :                                         if (frag) {</span>
<span class="lineNum">    1772 </span><span class="lineNoCov">          0 :                                                 frag[0] = 0;</span>
<span class="lineNum">    1773 </span><span class="lineNoCov">          0 :                                                 ctx-&gt;frag_url = gf_strdup(frag+1);</span>
<span class="lineNum">    1774 </span>            :                                         }
<span class="lineNum">    1775 </span><span class="lineCov">          7 :                                         f = gf_fopen(ctx-&gt;file_path, &quot;rt&quot;);</span>
<span class="lineNum">    1776 </span>            :                                 }
<span class="lineNum">    1777 </span><span class="lineCov">          7 :                                 if (!f) {</span>
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] Unable to open file %s\n&quot;, ctx-&gt;file_path ? ctx-&gt;file_path : &quot;no source path&quot;));</span>
<span class="lineNum">    1779 </span>            :                                         return GF_SERVICE_ERROR;
<span class="lineNum">    1780 </span>            :                                 } else {
<span class="lineNum">    1781 </span><span class="lineCov">          7 :                                         gf_fclose(f);</span>
<span class="lineNum">    1782 </span><span class="lineCov">          7 :                                         ctx-&gt;load_next = is_first;</span>
<span class="lineNum">    1783 </span>            :                                 }
<span class="lineNum">    1784 </span>            :                         }
<span class="lineNum">    1785 </span>            :                 }
<span class="lineNum">    1786 </span>            :         }
<span class="lineNum">    1787 </span><span class="lineCov">       2913 :         if (ctx-&gt;is_eos)</span>
<span class="lineNum">    1788 </span>            :                 return GF_EOS;
<span class="lineNum">    1789 </span>            : 
<span class="lineNum">    1790 </span><span class="lineCov">       2909 :         if (ctx-&gt;load_next) {</span>
<span class="lineNum">    1791 </span><span class="lineCov">         57 :                 return filelist_load_next(filter, ctx);</span>
<span class="lineNum">    1792 </span>            :         }
<span class="lineNum">    1793 </span>            : 
<span class="lineNum">    1794 </span>            : 
<span class="lineNum">    1795 </span><span class="lineCov">       2852 :         count = gf_list_count(ctx-&gt;io_pids);</span>
<span class="lineNum">    1796 </span>            :         //init first timestamp
<span class="lineNum">    1797 </span><span class="lineCov">       2852 :         if (!ctx-&gt;dts_sub_plus_one.num) {</span>
<span class="lineNum">    1798 </span>            :                 u32 nb_eos = 0;
<span class="lineNum">    1799 </span>            : 
<span class="lineNum">    1800 </span><span class="lineCov">        124 :                 for (i=0; i&lt;gf_list_count(ctx-&gt;filter_srcs); i++) {</span>
<span class="lineNum">    1801 </span><span class="lineCov">        590 :                         GF_Filter *fsrc = gf_list_get(ctx-&gt;filter_srcs, i);</span>
<span class="lineNum">    1802 </span><span class="lineCov">        590 :                         if (gf_filter_has_pid_connection_pending(fsrc, filter)) {</span>
<span class="lineNum">    1803 </span>            :                                 return GF_OK;
<span class="lineNum">    1804 </span>            :                         }
<span class="lineNum">    1805 </span>            :                 }
<span class="lineNum">    1806 </span>            : 
<span class="lineNum">    1807 </span><span class="lineCov">         71 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1808 </span>            :                         GF_FilterPacket *pck;
<span class="lineNum">    1809 </span>            :                         u64 dts;
<span class="lineNum">    1810 </span><span class="lineCov">        123 :                         iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1811 </span><span class="lineCov">        123 :             if (!iopid-&gt;ipid) {</span>
<span class="lineNum">    1812 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;src_error) {</span>
<span class="lineNum">    1813 </span><span class="lineNoCov">          0 :                                         nb_eos++;</span>
<span class="lineNum">    1814 </span><span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">    1815 </span>            :                                 }
<span class="lineNum">    1816 </span>            : 
<span class="lineNum">    1817 </span><span class="lineNoCov">          0 :                                 if (iopid-&gt;opid) gf_filter_pid_set_eos(iopid-&gt;opid);</span>
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :                                 if (iopid-&gt;opid_aux) gf_filter_pid_set_eos(iopid-&gt;opid_aux);</span>
<span class="lineNum">    1819 </span>            :                                 return GF_OK;
<span class="lineNum">    1820 </span>            :                         }
<span class="lineNum">    1821 </span><span class="lineCov">        123 :             if (iopid-&gt;skip_dts_init) continue;</span>
<span class="lineNum">    1822 </span><span class="lineCov">        123 :             pck = gf_filter_pid_get_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    1823 </span>            : 
<span class="lineNum">    1824 </span><span class="lineCov">        123 :                         if (!pck) {</span>
<span class="lineNum">    1825 </span><span class="lineCov">         55 :                                 if (gf_filter_pid_is_eos(iopid-&gt;ipid) || (iopid-&gt;play_state==FLIST_STATE_STOP)) {</span>
<span class="lineNum">    1826 </span><span class="lineCov">          3 :                                         nb_eos++;</span>
<span class="lineNum">    1827 </span><span class="lineCov">          3 :                                         continue;</span>
<span class="lineNum">    1828 </span>            :                                 }
<span class="lineNum">    1829 </span><span class="lineCov">         52 :                                 ctx-&gt;dts_sub_plus_one.num = 0;</span>
<span class="lineNum">    1830 </span><span class="lineCov">         52 :                                 return GF_OK;</span>
<span class="lineNum">    1831 </span>            :                         }
<span class="lineNum">    1832 </span>            : 
<span class="lineNum">    1833 </span>            : 
<span class="lineNum">    1834 </span><span class="lineCov">         68 :                         dts = gf_filter_pck_get_dts(pck);</span>
<span class="lineNum">    1835 </span><span class="lineCov">         68 :                         if (dts==GF_FILTER_NO_TS)</span>
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :                                 dts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    1837 </span><span class="lineCov">         68 :                         if (dts==GF_FILTER_NO_TS)</span>
<span class="lineNum">    1838 </span>            :                                 dts = 0;
<span class="lineNum">    1839 </span>            : 
<span class="lineNum">    1840 </span>            :                         //make sure we start all streams on a SAP
<span class="lineNum">    1841 </span><span class="lineCov">         68 :                         if (!iopid-&gt;wait_rap &amp;&amp; gf_filter_pck_get_seek_flag(pck)) {</span>
<span class="lineNum">    1842 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_drop_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    1843 </span>            :                                 pck = NULL;
<span class="lineNum">    1844 </span>            :                         }
<span class="lineNum">    1845 </span><span class="lineCov">         68 :                         else if (iopid-&gt;wait_rap &amp;&amp; !iopid-&gt;ra_info.is_raw &amp;&amp; !gf_filter_pck_get_sap(pck)) {</span>
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_drop_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    1847 </span>            :                                 pck = NULL;
<span class="lineNum">    1848 </span>            :                         }
<span class="lineNum">    1849 </span>            :                         if (!pck) {
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 :                                 iopid-&gt;wait_rap = GF_TRUE;</span>
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :                                 if (!ctx-&gt;wait_dts_plus_one.num</span>
<span class="lineNum">    1852 </span><span class="lineNoCov">          0 :                                         || ((dts + 1) * ctx-&gt;wait_dts_plus_one.den &gt; ctx-&gt;wait_dts_plus_one.num * (u64) iopid-&gt;timescale)</span>
<span class="lineNum">    1853 </span>            :                                 ) {
<span class="lineNum">    1854 </span><span class="lineNoCov">          0 :                                         ctx-&gt;wait_dts_plus_one.num = dts + 1;</span>
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :                                         ctx-&gt;wait_dts_plus_one.den = iopid-&gt;timescale;</span>
<span class="lineNum">    1856 </span>            :                                 }
<span class="lineNum">    1857 </span><span class="lineNoCov">          0 :                                 ctx-&gt;dts_sub_plus_one.num = 0;</span>
<span class="lineNum">    1858 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">    1859 </span>            :                         }
<span class="lineNum">    1860 </span><span class="lineCov">         68 :                         if (ctx-&gt;wait_dts_plus_one.num &amp;&amp; (dts * ctx-&gt;wait_dts_plus_one.den &lt; (ctx-&gt;wait_dts_plus_one.num - 1) * (u64) iopid-&gt;timescale) ) {</span>
<span class="lineNum">    1861 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_drop_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    1862 </span><span class="lineNoCov">          0 :                                 iopid-&gt;wait_rap = GF_TRUE;</span>
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :                                 ctx-&gt;dts_sub_plus_one.num = 0;</span>
<span class="lineNum">    1864 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">    1865 </span>            :                         }
<span class="lineNum">    1866 </span><span class="lineCov">         68 :                         if (iopid-&gt;wait_rap) {</span>
<span class="lineNum">    1867 </span><span class="lineNoCov">          0 :                                 iopid-&gt;wait_rap = GF_FALSE;</span>
<span class="lineNum">    1868 </span><span class="lineNoCov">          0 :                                 ctx-&gt;dts_sub_plus_one.num = 0;</span>
<span class="lineNum">    1869 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">    1870 </span>            :                         }
<span class="lineNum">    1871 </span><span class="lineCov">         68 :                         if (!ctx-&gt;dts_sub_plus_one.num</span>
<span class="lineNum">    1872 </span><span class="lineNoCov">          0 :                                 || (dts * ctx-&gt;dts_sub_plus_one.den &lt; (ctx-&gt;dts_sub_plus_one.num - 1) *(u64)  iopid-&gt;timescale)</span>
<span class="lineNum">    1873 </span>            :                         ) {
<span class="lineNum">    1874 </span><span class="lineCov">         68 :                                 ctx-&gt;dts_sub_plus_one.num = dts + 1;</span>
<span class="lineNum">    1875 </span><span class="lineCov">         68 :                                 ctx-&gt;dts_sub_plus_one.den = iopid-&gt;timescale;</span>
<span class="lineNum">    1876 </span>            :                         }
<span class="lineNum">    1877 </span>            :                 }
<span class="lineNum">    1878 </span><span class="lineCov">         72 :                 ctx-&gt;src_error = GF_FALSE;</span>
<span class="lineNum">    1879 </span><span class="lineCov">         72 :                 if (nb_eos) {</span>
<span class="lineNum">    1880 </span><span class="lineCov">          3 :                         if (nb_eos==count) {</span>
<span class="lineNum">    1881 </span>            :                                 //force load
<span class="lineNum">    1882 </span><span class="lineCov">          3 :                                 ctx-&gt;load_next = GF_TRUE;</span>
<span class="lineNum">    1883 </span><span class="lineCov">          3 :                                 return filelist_process(filter);</span>
<span class="lineNum">    1884 </span>            :                         }
<span class="lineNum">    1885 </span>            :                         return GF_OK;
<span class="lineNum">    1886 </span>            :                 }
<span class="lineNum">    1887 </span>            : 
<span class="lineNum">    1888 </span>            :                 //if we start with a splice, set first dst_sub to 0 to keep timestamps untouched
<span class="lineNum">    1889 </span><span class="lineCov">         69 :                 if (!ctx-&gt;splice_state) {</span>
<span class="lineNum">    1890 </span><span class="lineCov">         69 :                         ctx-&gt;first_loaded = GF_TRUE;</span>
<span class="lineNum">    1891 </span><span class="lineCov">         69 :                         ctx-&gt;skip_sync = GF_FALSE;</span>
<span class="lineNum">    1892 </span><span class="lineNoCov">          0 :                 } else if (!ctx-&gt;first_loaded) {</span>
<span class="lineNum">    1893 </span><span class="lineNoCov">          0 :                         ctx-&gt;dts_sub_plus_one.num = 1;</span>
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :                         ctx-&gt;dts_sub_plus_one.den = 1;</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :                         ctx-&gt;first_loaded = 1;</span>
<span class="lineNum">    1896 </span><span class="lineNoCov">          0 :                         ctx-&gt;skip_sync = GF_FALSE;</span>
<span class="lineNum">    1897 </span>            :                 }
<span class="lineNum">    1898 </span>            : 
<span class="lineNum">    1899 </span><span class="lineCov">         68 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1900 </span><span class="lineCov">         68 :                         iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1901 </span><span class="lineCov">         68 :                         iopid-&gt;dts_sub = ctx-&gt;dts_sub_plus_one.num - 1;</span>
<span class="lineNum">    1902 </span><span class="lineCov">         68 :                         iopid-&gt;dts_sub *= iopid-&gt;o_timescale;</span>
<span class="lineNum">    1903 </span><span class="lineCov">         68 :                         iopid-&gt;dts_sub /= ctx-&gt;dts_sub_plus_one.den;</span>
<span class="lineNum">    1904 </span>            :                 }
<span class="lineNum">    1905 </span><span class="lineCov">         69 :                 ctx-&gt;wait_dts_plus_one.num = 0;</span>
<span class="lineNum">    1906 </span>            :         }
<span class="lineNum">    1907 </span>            : 
<span class="lineNum">    1908 </span><span class="lineCov">       2331 :         if (ctx-&gt;splice_state) {</span>
<span class="lineNum">    1909 </span><span class="lineNoCov">          0 :                 if (!filelist_check_splice(ctx))</span>
<span class="lineNum">    1910 </span>            :                         return GF_OK;
<span class="lineNum">    1911 </span>            :         }
<span class="lineNum">    1912 </span>            : 
<span class="lineNum">    1913 </span>            :         nb_done = nb_inactive = nb_stop = nb_ready = 0;
<span class="lineNum">    1914 </span><span class="lineCov">       2330 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1915 </span><span class="lineCov">       2330 :                 iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    1916 </span><span class="lineCov">       2330 :                 if (!iopid-&gt;ipid) {</span>
<span class="lineNum">    1917 </span><span class="lineNoCov">          0 :             iopid-&gt;splice_ready = GF_TRUE;</span>
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :                         nb_inactive++;</span>
<span class="lineNum">    1919 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1920 </span>            :                 }
<span class="lineNum">    1921 </span><span class="lineCov">       2330 :                 if (iopid-&gt;play_state==FLIST_STATE_WAIT_PLAY)</span>
<span class="lineNum">    1922 </span><span class="lineCov">         12 :                         continue;</span>
<span class="lineNum">    1923 </span><span class="lineCov">       2318 :         if (iopid-&gt;play_state==FLIST_STATE_STOP) {</span>
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :                         nb_stop++;</span>
<span class="lineNum">    1925 </span>            :             //in case the input still dispatch packets, drop them
<span class="lineNum">    1926 </span><span class="lineNoCov">          0 :             while (1) {</span>
<span class="lineNum">    1927 </span><span class="lineNoCov">          0 :                 GF_FilterPacket *pck = gf_filter_pid_get_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    1928 </span><span class="lineNoCov">          0 :                 if (!pck) break;</span>
<span class="lineNum">    1929 </span><span class="lineNoCov">          0 :                 gf_filter_pid_drop_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    1930 </span>            :             }
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :             while (iopid-&gt;splice_ipid) {</span>
<span class="lineNum">    1932 </span><span class="lineNoCov">          0 :                 GF_FilterPacket *pck = gf_filter_pid_get_packet(iopid-&gt;splice_ipid);</span>
<span class="lineNum">    1933 </span><span class="lineNoCov">          0 :                 if (!pck) break;</span>
<span class="lineNum">    1934 </span><span class="lineNoCov">          0 :                 gf_filter_pid_drop_packet(iopid-&gt;splice_ipid);</span>
<span class="lineNum">    1935 </span>            :             }
<span class="lineNum">    1936 </span><span class="lineNoCov">          0 :             nb_done++;</span>
<span class="lineNum">    1937 </span><span class="lineNoCov">          0 :             iopid-&gt;splice_ready = GF_TRUE;</span>
<span class="lineNum">    1938 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    1939 </span>            :         }
<span class="lineNum">    1940 </span><span class="lineCov">       2318 :                 if (iopid-&gt;is_eos) {</span>
<span class="lineNum">    1941 </span><span class="lineNoCov">          0 :             iopid-&gt;splice_ready = GF_TRUE;</span>
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :                         nb_done++;</span>
<span class="lineNum">    1943 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1944 </span>            :                 }
<span class="lineNum">    1945 </span>            : 
<span class="lineNum">    1946 </span>            :                 while (1) {
<span class="lineNum">    1947 </span>            :                         u64 cts;
<span class="lineNum">    1948 </span>            :                         GF_FilterPacket *pck;
<span class="lineNum">    1949 </span>            : 
<span class="lineNum">    1950 </span><span class="lineCov">       4628 :                         pck = gf_filter_pid_get_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    1951 </span><span class="lineCov">       4628 :                         if (!pck) {</span>
<span class="lineNum">    1952 </span><span class="lineCov">        469 :                                 if (gf_filter_pid_is_eos(iopid-&gt;ipid)) {</span>
<span class="lineNum">    1953 </span><span class="lineCov">         68 :                                         if (ctx-&gt;wait_splice_end) {</span>
<span class="lineNum">    1954 </span><span class="lineNoCov">          0 :                                                 iopid-&gt;splice_ready = GF_TRUE;</span>
<span class="lineNum">    1955 </span><span class="lineCov">         68 :                                         } else if (ctx-&gt;wait_splice_start) {</span>
<span class="lineNum">    1956 </span><span class="lineNoCov">          0 :                                                 iopid-&gt;splice_ready = GF_TRUE;</span>
<span class="lineNum">    1957 </span>            :                                         } else {
<span class="lineNum">    1958 </span><span class="lineCov">         68 :                                                 iopid-&gt;is_eos = GF_TRUE;</span>
<span class="lineNum">    1959 </span><span class="lineCov">         68 :                                                 if (ctx-&gt;splice_state==FL_SPLICE_ACTIVE)</span>
<span class="lineNum">    1960 </span>            :                                                         purge_splice = GF_TRUE;
<span class="lineNum">    1961 </span>            :                                         }
<span class="lineNum">    1962 </span>            :                                 }
<span class="lineNum">    1963 </span>            : 
<span class="lineNum">    1964 </span><span class="lineCov">        469 :                                 if (iopid-&gt;is_eos)</span>
<span class="lineNum">    1965 </span><span class="lineCov">         68 :                                         nb_done++;</span>
<span class="lineNum">    1966 </span>            :                                 break;
<span class="lineNum">    1967 </span>            :                         }
<span class="lineNum">    1968 </span>            : 
<span class="lineNum">    1969 </span><span class="lineCov">       4159 :                         if (gf_filter_pid_would_block(iopid-&gt;opid) &amp;&amp; (!iopid-&gt;opid_aux || gf_filter_pid_would_block(iopid-&gt;opid_aux)))</span>
<span class="lineNum">    1970 </span>            :                                 break;
<span class="lineNum">    1971 </span>            : 
<span class="lineNum">    1972 </span><span class="lineCov">       2310 :                         cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    1973 </span><span class="lineCov">       2310 :                         if (ctx-&gt;splice_state &amp;&amp; (cts != GF_FILTER_NO_TS)) {</span>
<span class="lineNum">    1974 </span><span class="lineNoCov">          0 :                                 u32 dur = gf_filter_pck_get_duration(pck);</span>
<span class="lineNum">    1975 </span>            : 
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :                                 if (iopid-&gt;delay&gt;=0) {</span>
<span class="lineNum">    1977 </span><span class="lineNoCov">          0 :                                         cts += iopid-&gt;delay;</span>
<span class="lineNum">    1978 </span><span class="lineNoCov">          0 :                                 } else if (cts &gt; - iopid-&gt;delay) {</span>
<span class="lineNum">    1979 </span><span class="lineNoCov">          0 :                                         cts += iopid-&gt;delay;</span>
<span class="lineNum">    1980 </span>            :                                 } else {
<span class="lineNum">    1981 </span>            :                                         cts = 0;
<span class="lineNum">    1982 </span>            :                                 }
<span class="lineNum">    1983 </span>            : 
<span class="lineNum">    1984 </span>            :                                 //translate cts in output timescale, and compare with splice
<span class="lineNum">    1985 </span><span class="lineNoCov">          0 :                                 if (iopid-&gt;timescale != iopid-&gt;o_timescale) {</span>
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :                                         cts *= iopid-&gt;o_timescale;</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :                                         cts /= iopid-&gt;timescale;</span>
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :                                         dur *= iopid-&gt;o_timescale;</span>
<span class="lineNum">    1989 </span><span class="lineNoCov">          0 :                                         dur /= iopid-&gt;timescale;</span>
<span class="lineNum">    1990 </span>            :                                 }
<span class="lineNum">    1991 </span><span class="lineNoCov">          0 :                                 if (iopid-&gt;cts_o + cts &gt;= iopid-&gt;dts_sub)</span>
<span class="lineNum">    1992 </span><span class="lineNoCov">          0 :                                         cts = iopid-&gt;cts_o + cts - iopid-&gt;dts_sub;</span>
<span class="lineNum">    1993 </span>            :                                 else
<span class="lineNum">    1994 </span>            :                                         cts = 0;
<span class="lineNum">    1995 </span>            : 
<span class="lineNum">    1996 </span>            :                                 //about to enter the splice period
<span class="lineNum">    1997 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;splice_state==FL_SPLICE_BEFORE) {</span>
<span class="lineNum">    1998 </span>            :                                         //do not dispatch yet if cts is greater than last CTS seen on splice control pid
<span class="lineNum">    1999 </span><span class="lineNoCov">          0 :                                         if (cts * ctx-&gt;splice_ctrl-&gt;o_timescale &gt; ctx-&gt;spliced_current_cts * iopid-&gt;o_timescale)</span>
<span class="lineNum">    2000 </span>            :                                                 break;
<span class="lineNum">    2001 </span>            :                                 }
<span class="lineNum">    2002 </span>            :                                 //in the splice period
<span class="lineNum">    2003 </span><span class="lineNoCov">          0 :                                 else if (ctx-&gt;splice_state==FL_SPLICE_ACTIVE) {</span>
<span class="lineNum">    2004 </span>            :                                         u64 check_ts = cts;
<span class="lineNum">    2005 </span>            : 
<span class="lineNum">    2006 </span><span class="lineNoCov">          0 :                                         if (iopid-&gt;ra_info.is_raw) {</span>
<span class="lineNum">    2007 </span><span class="lineNoCov">          0 :                                                 check_ts += dur;</span>
<span class="lineNum">    2008 </span><span class="lineNoCov">          0 :                                                 check_ts -= 1;</span>
<span class="lineNum">    2009 </span>            :                                         }
<span class="lineNum">    2010 </span>            : 
<span class="lineNum">    2011 </span>            :                                         //packet in splice range
<span class="lineNum">    2012 </span><span class="lineNoCov">          0 :                                         if (check_ts * ctx-&gt;splice_ctrl-&gt;o_timescale &gt;= ctx-&gt;splice_start_cts * iopid-&gt;o_timescale) {</span>
<span class="lineNum">    2013 </span>            :                                                 Bool keep_pck = GF_FALSE;
<span class="lineNum">    2014 </span>            :                                                 //waiting for all streams to reach splice out point (packet is from main content)
<span class="lineNum">    2015 </span>            :                                                 //don't drop packet yet in case splice content is not ready
<span class="lineNum">    2016 </span><span class="lineNoCov">          0 :                                                 if (ctx-&gt;wait_splice_start) {</span>
<span class="lineNum">    2017 </span><span class="lineNoCov">          0 :                                                         if (iopid-&gt;ra_info.is_raw &amp;&amp; iopid-&gt;ra_info.sample_rate &amp;&amp; !iopid-&gt;audio_samples_to_keep) {</span>
<span class="lineNum">    2018 </span>            :                                                                 u64 ts_diff = ctx-&gt;splice_start_cts * iopid-&gt;o_timescale;
<span class="lineNum">    2019 </span><span class="lineNoCov">          0 :                                                                 ts_diff /= ctx-&gt;splice_ctrl-&gt;o_timescale;</span>
<span class="lineNum">    2020 </span><span class="lineNoCov">          0 :                                                                 if (ts_diff &gt;= cts) {</span>
<span class="lineNum">    2021 </span><span class="lineNoCov">          0 :                                                                         ts_diff -= cts;</span>
<span class="lineNum">    2022 </span><span class="lineNoCov">          0 :                                                                         if (iopid-&gt;ra_info.sample_rate != iopid-&gt;o_timescale) {</span>
<span class="lineNum">    2023 </span><span class="lineNoCov">          0 :                                                                                 ts_diff *= iopid-&gt;ra_info.sample_rate;</span>
<span class="lineNum">    2024 </span><span class="lineNoCov">          0 :                                                                                 ts_diff /= iopid-&gt;o_timescale;</span>
<span class="lineNum">    2025 </span>            :                                                                         }
<span class="lineNum">    2026 </span><span class="lineNoCov">          0 :                                                                         iopid-&gt;audio_samples_to_keep = (s32) ts_diff;</span>
<span class="lineNum">    2027 </span><span class="lineNoCov">          0 :                                                                         if (ts_diff) keep_pck = GF_TRUE;</span>
<span class="lineNum">    2028 </span>            :                                                                 }
<span class="lineNum">    2029 </span>            :                                                         }
<span class="lineNum">    2030 </span>            :                                                         if (!keep_pck) {
<span class="lineNum">    2031 </span><span class="lineNoCov">          0 :                                                                 iopid-&gt;splice_ready = GF_TRUE;</span>
<span class="lineNum">    2032 </span><span class="lineNoCov">          0 :                                                                 break;</span>
<span class="lineNum">    2033 </span>            :                                                         }
<span class="lineNum">    2034 </span>            :                                                 }
<span class="lineNum">    2035 </span><span class="lineNoCov">          0 :                                                 if (!keep_pck &amp;&amp; (iopid == ctx-&gt;splice_ctrl))</span>
<span class="lineNum">    2036 </span>            :                                                         purge_splice = GF_TRUE;
<span class="lineNum">    2037 </span>            : 
<span class="lineNum">    2038 </span>            :                                                 //do not dispatch yet if cts is greater than last CTS seen on splice control pid
<span class="lineNum">    2039 </span><span class="lineNoCov">          0 :                                                 if (cts * ctx-&gt;splice_ctrl-&gt;o_timescale &gt; ctx-&gt;spliced_current_cts * iopid-&gt;o_timescale)</span>
<span class="lineNum">    2040 </span>            :                                                         break;
<span class="lineNum">    2041 </span>            : 
<span class="lineNum">    2042 </span>            :                                         }
<span class="lineNum">    2043 </span>            :                                         //should not happen
<span class="lineNum">    2044 </span><span class="lineNoCov">          0 :                                         else if (!ctx-&gt;wait_splice_start) {</span>
<span class="lineNum">    2045 </span><span class="lineNoCov">          0 :                                                 gf_filter_pid_drop_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    2046 </span><span class="lineNoCov">          0 :                                                 continue;</span>
<span class="lineNum">    2047 </span>            :                                         }
<span class="lineNum">    2048 </span>            :                                 }
<span class="lineNum">    2049 </span>            :                                 //leaving the splice period
<span class="lineNum">    2050 </span><span class="lineNoCov">          0 :                                 else if (ctx-&gt;splice_state==FL_SPLICE_AFTER) {</span>
<span class="lineNum">    2051 </span>            :                                         //still in spliced content
<span class="lineNum">    2052 </span><span class="lineNoCov">          0 :                                         if (ctx-&gt;wait_splice_end) {</span>
<span class="lineNum">    2053 </span>            :                                                 u64 check_ts = cts;
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :                                                 if (iopid-&gt;ra_info.is_raw) {</span>
<span class="lineNum">    2055 </span><span class="lineNoCov">          0 :                                                         check_ts += dur;</span>
<span class="lineNum">    2056 </span><span class="lineNoCov">          0 :                                                         check_ts -= 1;</span>
<span class="lineNum">    2057 </span>            :                                                 }
<span class="lineNum">    2058 </span>            : 
<span class="lineNum">    2059 </span><span class="lineNoCov">          0 :                                                 if (</span>
<span class="lineNum">    2060 </span>            :                                                         //packet is after splice end, drop
<span class="lineNum">    2061 </span><span class="lineNoCov">          0 :                                                         (check_ts * ctx-&gt;splice_ctrl-&gt;o_timescale &gt;= ctx-&gt;splice_end_cts * iopid-&gt;o_timescale)</span>
<span class="lineNum">    2062 </span>            :                                                         //packet is before splice end but a previous packet was dropped because after splice end (i.e. we dropped a ref), drop
<span class="lineNum">    2063 </span><span class="lineNoCov">          0 :                                                         || iopid-&gt;splice_ready</span>
<span class="lineNum">    2064 </span>            :                                                 ) {
<span class="lineNum">    2065 </span>            :                                                         Bool do_break = GF_TRUE;
<span class="lineNum">    2066 </span><span class="lineNoCov">          0 :                                                         if (iopid-&gt;ra_info.is_raw &amp;&amp; !iopid-&gt;audio_samples_to_keep) {</span>
<span class="lineNum">    2067 </span>            :                                                                 u64 ts_diff = ctx-&gt;splice_end_cts * iopid-&gt;o_timescale;
<span class="lineNum">    2068 </span><span class="lineNoCov">          0 :                                                                 ts_diff /= ctx-&gt;splice_ctrl-&gt;o_timescale;</span>
<span class="lineNum">    2069 </span><span class="lineNoCov">          0 :                                                                 if (ts_diff &gt;= cts) {</span>
<span class="lineNum">    2070 </span><span class="lineNoCov">          0 :                                                                         ts_diff -= cts;</span>
<span class="lineNum">    2071 </span><span class="lineNoCov">          0 :                                                                         if (iopid-&gt;ra_info.sample_rate != iopid-&gt;o_timescale) {</span>
<span class="lineNum">    2072 </span><span class="lineNoCov">          0 :                                                                                 ts_diff *= iopid-&gt;ra_info.sample_rate;</span>
<span class="lineNum">    2073 </span><span class="lineNoCov">          0 :                                                                                 ts_diff /= iopid-&gt;o_timescale;</span>
<span class="lineNum">    2074 </span>            :                                                                         }
<span class="lineNum">    2075 </span><span class="lineNoCov">          0 :                                                                         iopid-&gt;audio_samples_to_keep = (s32) ts_diff;</span>
<span class="lineNum">    2076 </span><span class="lineNoCov">          0 :                                                                         if (ts_diff)</span>
<span class="lineNum">    2077 </span>            :                                                                                 do_break = GF_FALSE;
<span class="lineNum">    2078 </span>            :                                                                 }
<span class="lineNum">    2079 </span>            :                                                         }
<span class="lineNum">    2080 </span>            :                                                         if (do_break) {
<span class="lineNum">    2081 </span><span class="lineNoCov">          0 :                                                                 iopid-&gt;splice_ready = GF_TRUE;</span>
<span class="lineNum">    2082 </span><span class="lineNoCov">          0 :                                                                 if (!ctx-&gt;mark_only)</span>
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :                                                                         gf_filter_pid_drop_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    2084 </span>            :                                                                 break;
<span class="lineNum">    2085 </span>            :                                                         }
<span class="lineNum">    2086 </span>            :                                                 }
<span class="lineNum">    2087 </span>            :                                         } else {
<span class="lineNum">    2088 </span>            :                                                 //out of spliced content, packet is from main:
<span class="lineNum">    2089 </span>            :                                                 //drop packet if before CTS of splice end point (open gop or packets from other PIDs not yet discarded during splice)
<span class="lineNum">    2090 </span>            :                                                 u64 check_ts = cts;
<span class="lineNum">    2091 </span><span class="lineNoCov">          0 :                                                 if (iopid-&gt;ra_info.is_raw) {</span>
<span class="lineNum">    2092 </span><span class="lineNoCov">          0 :                                                         check_ts += dur;</span>
<span class="lineNum">    2093 </span><span class="lineNoCov">          0 :                                                         check_ts -= 1;</span>
<span class="lineNum">    2094 </span>            :                                                 }
<span class="lineNum">    2095 </span><span class="lineNoCov">          0 :                                                 if (!iopid-&gt;audio_samples_to_keep &amp;&amp; (check_ts * ctx-&gt;splice_ctrl-&gt;o_timescale &lt; ctx-&gt;splice_end_cts * iopid-&gt;o_timescale)) {</span>
<span class="lineNum">    2096 </span>            :                                                         //do not drop if not raw audio and we were in keep/mark mode
<span class="lineNum">    2097 </span><span class="lineNoCov">          0 :                                                         if (iopid-&gt;ra_info.is_raw || !ctx-&gt;was_kept) {</span>
<span class="lineNum">    2098 </span><span class="lineNoCov">          0 :                                                                 gf_filter_pid_drop_packet(iopid-&gt;ipid);</span>
<span class="lineNum">    2099 </span><span class="lineNoCov">          0 :                                                                 break;</span>
<span class="lineNum">    2100 </span>            :                                                         }
<span class="lineNum">    2101 </span>            :                                                 }
<span class="lineNum">    2102 </span><span class="lineNoCov">          0 :                                                 if (ctx-&gt;wait_splice_start) {</span>
<span class="lineNum">    2103 </span><span class="lineNoCov">          0 :                                                         iopid-&gt;splice_ready = GF_FALSE;</span>
<span class="lineNum">    2104 </span>            :                                                 }
<span class="lineNum">    2105 </span>            :                                         }
<span class="lineNum">    2106 </span>            :                                 }
<span class="lineNum">    2107 </span>            :                         }
<span class="lineNum">    2108 </span>            : 
<span class="lineNum">    2109 </span><span class="lineCov">       2310 :                         if (ctx-&gt;wait_source) {</span>
<span class="lineNum">    2110 </span><span class="lineNoCov">          0 :                                 nb_ready++;</span>
<span class="lineNum">    2111 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    2112 </span>            :                         }
<span class="lineNum">    2113 </span>            : 
<span class="lineNum">    2114 </span><span class="lineCov">       2310 :                         filein_send_packet(ctx, iopid, pck, GF_FALSE);</span>
<span class="lineNum">    2115 </span>            : 
<span class="lineNum">    2116 </span>            :                         //if we have an end range, compute max_dts (includes dur) - first_dts
<span class="lineNum">    2117 </span><span class="lineCov">       2310 :                         if (ctx-&gt;stop &gt; ctx-&gt;start) {</span>
<span class="lineNum">    2118 </span><span class="lineNoCov">          0 :                                 if ( (ctx-&gt;stop-ctx-&gt;start) * iopid-&gt;timescale &lt;= (iopid-&gt;max_dts - iopid-&gt;first_dts_plus_one + 1)) {</span>
<span class="lineNum">    2119 </span>            :                                         GF_FilterEvent evt;
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :                                         GF_FEVT_INIT(evt, GF_FEVT_STOP, iopid-&gt;ipid)</span>
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_send_event(iopid-&gt;ipid, &amp;evt);</span>
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_set_discard(iopid-&gt;ipid, GF_TRUE);</span>
<span class="lineNum">    2123 </span><span class="lineNoCov">          0 :                                         iopid-&gt;is_eos = GF_TRUE;</span>
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :                                         nb_done++;</span>
<span class="lineNum">    2125 </span>            :                                         break;
<span class="lineNum">    2126 </span>            :                                 }
<span class="lineNum">    2127 </span>            :                         }
<span class="lineNum">    2128 </span>            :                 }
<span class="lineNum">    2129 </span>            :         }
<span class="lineNum">    2130 </span>            : 
<span class="lineNum">    2131 </span><span class="lineCov">       2331 :         if (purge_splice) {</span>
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :                 filelist_purge_slice(ctx);</span>
<span class="lineNum">    2133 </span>            :         }
<span class="lineNum">    2134 </span><span class="lineCov">       2331 :         if (ctx-&gt;wait_source) {</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :                 if (nb_ready + nb_inactive + nb_done == count) {</span>
<span class="lineNum">    2136 </span><span class="lineNoCov">          0 :                         ctx-&gt;wait_source = GF_FALSE;</span>
<span class="lineNum">    2137 </span>            : 
<span class="lineNum">    2138 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;splice_state==FL_SPLICE_AFTER)</span>
<span class="lineNum">    2139 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_state = FL_SPLICE_BEFORE;</span>
<span class="lineNum">    2140 </span>            :                 }
<span class="lineNum">    2141 </span>            :         }
<span class="lineNum">    2142 </span>            : 
<span class="lineNum">    2143 </span>            : 
<span class="lineNum">    2144 </span><span class="lineCov">       2331 :         if (ctx-&gt;wait_splice_end) {</span>
<span class="lineNum">    2145 </span>            :                 Bool ready = GF_TRUE;
<span class="lineNum">    2146 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2147 </span><span class="lineNoCov">          0 :                         iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2148 </span><span class="lineNoCov">          0 :                         if (!iopid-&gt;ipid) continue;</span>
<span class="lineNum">    2149 </span><span class="lineNoCov">          0 :                         if (!iopid-&gt;splice_ready) {</span>
<span class="lineNum">    2150 </span>            :                                 ready = GF_FALSE;
<span class="lineNum">    2151 </span>            :                                 break;
<span class="lineNum">    2152 </span>            :                         }
<span class="lineNum">    2153 </span>            :                 }
<span class="lineNum">    2154 </span><span class="lineNoCov">          0 :                 if (!ready)</span>
<span class="lineNum">    2155 </span>            :                         return GF_OK;
<span class="lineNum">    2156 </span>            : 
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[FileList] Splice end reached, resuming main content\n&quot;));</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :                 ctx-&gt;wait_splice_end = GF_FALSE;</span>
<span class="lineNum">    2159 </span><span class="lineNoCov">          0 :                 ctx-&gt;nb_repeat = ctx-&gt;splice_nb_repeat;</span>
<span class="lineNum">    2160 </span><span class="lineNoCov">          0 :                 ctx-&gt;splice_nb_repeat = 0;</span>
<span class="lineNum">    2161 </span>            : 
<span class="lineNum">    2162 </span>            :                 //reset props pushed by splice
<span class="lineNum">    2163 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;pid_props) gf_free(ctx-&gt;pid_props);</span>
<span class="lineNum">    2164 </span><span class="lineNoCov">          0 :                 ctx-&gt;pid_props = ctx-&gt;splice_pid_props;</span>
<span class="lineNum">    2165 </span><span class="lineNoCov">          0 :                 ctx-&gt;splice_pid_props = NULL;</span>
<span class="lineNum">    2166 </span><span class="lineNoCov">          0 :                 ctx-&gt;skip_sync = GF_FALSE;</span>
<span class="lineNum">    2167 </span>            : 
<span class="lineNum">    2168 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2169 </span><span class="lineNoCov">          0 :                         iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 :                         iopid-&gt;splice_ready = GF_FALSE;</span>
<span class="lineNum">    2171 </span>            :                         //detach
<span class="lineNum">    2172 </span><span class="lineNoCov">          0 :                         if (!ctx-&gt;mark_only &amp;&amp; iopid-&gt;ipid) {</span>
<span class="lineNum">    2173 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_udta(iopid-&gt;ipid, NULL);</span>
<span class="lineNum">    2174 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_discard(iopid-&gt;ipid, GF_TRUE);</span>
<span class="lineNum">    2175 </span>            :                         }
<span class="lineNum">    2176 </span>            : 
<span class="lineNum">    2177 </span><span class="lineNoCov">          0 :                         if (iopid-&gt;splice_ipid) {</span>
<span class="lineNum">    2178 </span>            :                                 GF_FilterPacket *pck;
<span class="lineNum">    2179 </span><span class="lineNoCov">          0 :                                 iopid-&gt;ipid = iopid-&gt;splice_ipid;</span>
<span class="lineNum">    2180 </span><span class="lineNoCov">          0 :                                 iopid-&gt;dts_o = iopid-&gt;dts_o_splice;</span>
<span class="lineNum">    2181 </span><span class="lineNoCov">          0 :                                 iopid-&gt;cts_o = iopid-&gt;cts_o_splice;</span>
<span class="lineNum">    2182 </span><span class="lineNoCov">          0 :                                 iopid-&gt;dts_sub = iopid-&gt;dts_sub_splice;</span>
<span class="lineNum">    2183 </span><span class="lineNoCov">          0 :                                 iopid-&gt;dts_sub_splice = 0;</span>
<span class="lineNum">    2184 </span><span class="lineNoCov">          0 :                                 iopid-&gt;dts_o_splice = 0;</span>
<span class="lineNum">    2185 </span><span class="lineNoCov">          0 :                                 iopid-&gt;cts_o_splice = 0;</span>
<span class="lineNum">    2186 </span><span class="lineNoCov">          0 :                                 iopid-&gt;splice_ipid = NULL;</span>
<span class="lineNum">    2187 </span><span class="lineNoCov">          0 :                                 iopid-&gt;ra_info = iopid-&gt;splice_ra_info;</span>
<span class="lineNum">    2188 </span><span class="lineNoCov">          0 :                                 iopid-&gt;splice_ra_info.is_raw = GF_FALSE;</span>
<span class="lineNum">    2189 </span><span class="lineNoCov">          0 :                                 iopid-&gt;timescale = iopid-&gt;timescale_splice;</span>
<span class="lineNum">    2190 </span>            : 
<span class="lineNum">    2191 </span>            :                                 //if spliced media was raw audio, we may need to forward or truncate part of the packet before switching properties
<span class="lineNum">    2192 </span><span class="lineNoCov">          0 :                                 pck = iopid-&gt;ra_info.is_raw ? gf_filter_pid_get_packet(iopid-&gt;ipid) : NULL;</span>
<span class="lineNum">    2193 </span><span class="lineNoCov">          0 :                                 if (pck) {</span>
<span class="lineNum">    2194 </span><span class="lineNoCov">          0 :                                         u64 cts = gf_filter_pck_get_cts(pck);</span>
<span class="lineNum">    2195 </span><span class="lineNoCov">          0 :                                         u64 check_ts = cts + gf_filter_pck_get_duration(pck) - 1;</span>
<span class="lineNum">    2196 </span>            : 
<span class="lineNum">    2197 </span><span class="lineNoCov">          0 :                                         if (cts * ctx-&gt;splice_ctrl-&gt;timescale &lt; ctx-&gt;splice_end_cts * iopid-&gt;timescale) {</span>
<span class="lineNum">    2198 </span><span class="lineNoCov">          0 :                                                 if (check_ts * ctx-&gt;splice_ctrl-&gt;timescale &gt; ctx-&gt;splice_end_cts * iopid-&gt;timescale) {</span>
<span class="lineNum">    2199 </span><span class="lineNoCov">          0 :                                                         u64 diff_ts = ctx-&gt;splice_end_cts * iopid-&gt;timescale / ctx-&gt;splice_ctrl-&gt;timescale;</span>
<span class="lineNum">    2200 </span><span class="lineNoCov">          0 :                                                         diff_ts -= cts;</span>
<span class="lineNum">    2201 </span>            : 
<span class="lineNum">    2202 </span><span class="lineNoCov">          0 :                                                         if (iopid-&gt;timescale != iopid-&gt;ra_info.sample_rate) {</span>
<span class="lineNum">    2203 </span><span class="lineNoCov">          0 :                                                                 diff_ts *= iopid-&gt;ra_info.sample_rate;</span>
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :                                                                 diff_ts /= iopid-&gt;timescale;</span>
<span class="lineNum">    2205 </span>            :                                                         }
<span class="lineNum">    2206 </span><span class="lineNoCov">          0 :                                                         iopid-&gt;audio_samples_to_keep = (s32) diff_ts;</span>
<span class="lineNum">    2207 </span><span class="lineNoCov">          0 :                                                         if (ctx-&gt;keep_splice) {</span>
<span class="lineNum">    2208 </span><span class="lineNoCov">          0 :                                                                 filein_send_packet(ctx, iopid, pck, GF_TRUE);</span>
<span class="lineNum">    2209 </span>            :                                                         } else {
<span class="lineNum">    2210 </span><span class="lineNoCov">          0 :                                                                 iopid-&gt;audio_samples_to_keep = -iopid-&gt;audio_samples_to_keep;</span>
<span class="lineNum">    2211 </span>            :                                                         }
<span class="lineNum">    2212 </span>            :                                                 }
<span class="lineNum">    2213 </span>            :                                         }
<span class="lineNum">    2214 </span>            : 
<span class="lineNum">    2215 </span>            :                                 }
<span class="lineNum">    2216 </span><span class="lineNoCov">          0 :                         } else if (!ctx-&gt;mark_only) {</span>
<span class="lineNum">    2217 </span><span class="lineNoCov">          0 :                                 iopid-&gt;ipid = NULL;</span>
<span class="lineNum">    2218 </span>            :                         }
<span class="lineNum">    2219 </span><span class="lineNoCov">          0 :                         iopid-&gt;is_eos = GF_FALSE;</span>
<span class="lineNum">    2220 </span>            :                 }
<span class="lineNum">    2221 </span><span class="lineNoCov">          0 :                 if (!ctx-&gt;mark_only) {</span>
<span class="lineNum">    2222 </span><span class="lineNoCov">          0 :                         while (gf_list_count(ctx-&gt;filter_srcs)) {</span>
<span class="lineNum">    2223 </span><span class="lineNoCov">          0 :                                 GF_Filter *fsrc = gf_list_pop_back(ctx-&gt;filter_srcs);</span>
<span class="lineNum">    2224 </span><span class="lineNoCov">          0 :                                 gf_filter_remove_src(filter, fsrc);</span>
<span class="lineNum">    2225 </span>            :                         }
<span class="lineNum">    2226 </span><span class="lineNoCov">          0 :                         gf_list_del(ctx-&gt;filter_srcs);</span>
<span class="lineNum">    2227 </span><span class="lineNoCov">          0 :                         ctx-&gt;filter_srcs = ctx-&gt;splice_srcs;</span>
<span class="lineNum">    2228 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_srcs = NULL;</span>
<span class="lineNum">    2229 </span>            :                 } else {
<span class="lineNum">    2230 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2231 </span><span class="lineNoCov">          0 :                                 iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2232 </span><span class="lineNoCov">          0 :                                 if (!iopid-&gt;ipid) continue;</span>
<span class="lineNum">    2233 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_resume&quot;, NULL);</span>
<span class="lineNum">    2234 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_resume&quot;, &amp;PROP_STRING(ctx-&gt;dyn_period_id ? ctx-&gt;dyn_period_id : &quot;&quot;) );</span>
<span class="lineNum">    2235 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_switch&quot;, NULL);</span>
<span class="lineNum">    2236 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_switch&quot;, &amp;PROP_BOOL(GF_TRUE) );</span>
<span class="lineNum">    2237 </span>            :                         }
<span class="lineNum">    2238 </span>            :                 }
<span class="lineNum">    2239 </span><span class="lineNoCov">          0 :                 ctx-&gt;was_kept = (ctx-&gt;mark_only || ctx-&gt;keep_splice) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    2240 </span>            : 
<span class="lineNum">    2241 </span><span class="lineNoCov">          0 :                 ctx-&gt;mark_only = GF_FALSE;</span>
<span class="lineNum">    2242 </span>            : 
<span class="lineNum">    2243 </span>            : 
<span class="lineNum">    2244 </span><span class="lineNoCov">          0 :                 ctx-&gt;splice_state = FL_SPLICE_AFTER;</span>
<span class="lineNum">    2245 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;keep_splice) {</span>
<span class="lineNum">    2246 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2247 </span><span class="lineNoCov">          0 :                                 iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2248 </span><span class="lineNoCov">          0 :                                 if (iopid-&gt;opid_aux) {</span>
<span class="lineNum">    2249 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_set_eos(iopid-&gt;opid_aux);</span>
<span class="lineNum">    2250 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_remove(iopid-&gt;opid_aux);</span>
<span class="lineNum">    2251 </span><span class="lineNoCov">          0 :                                         iopid-&gt;opid_aux = NULL;</span>
<span class="lineNum">    2252 </span>            :                                 }
<span class="lineNum">    2253 </span>            :                         }
<span class="lineNum">    2254 </span><span class="lineNoCov">          0 :                         ctx-&gt;keep_splice = GF_FALSE;</span>
<span class="lineNum">    2255 </span>            : 
<span class="lineNum">    2256 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;splice_props) {</span>
<span class="lineNum">    2257 </span><span class="lineNoCov">          0 :                                 gf_free(ctx-&gt;splice_props);</span>
<span class="lineNum">    2258 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_props = NULL;</span>
<span class="lineNum">    2259 </span>            :                         }
<span class="lineNum">    2260 </span>            :                 }
<span class="lineNum">    2261 </span>            : 
<span class="lineNum">    2262 </span>            :                 //spliced media is still active, restore our timeline as it was before splicing
<span class="lineNum">    2263 </span><span class="lineNoCov">          0 :                 if (! gf_filter_pid_is_eos(ctx-&gt;splice_ctrl-&gt;ipid)) {</span>
<span class="lineNum">    2264 </span>            : 
<span class="lineNum">    2265 </span><span class="lineNoCov">          0 :                         ctx-&gt;cur_splice_index ++;</span>
<span class="lineNum">    2266 </span>            :                         //force a reconfig
<span class="lineNum">    2267 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2268 </span><span class="lineNoCov">          0 :                                 iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2269 </span><span class="lineNoCov">          0 :                                 if (iopid-&gt;ipid) {</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :                                         filelist_configure_pid(filter, iopid-&gt;ipid, GF_FALSE);</span>
<span class="lineNum">    2271 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_resume&quot;, &amp;PROP_STRING(ctx-&gt;dyn_period_id ? ctx-&gt;dyn_period_id : &quot;&quot;) );</span>
<span class="lineNum">    2272 </span>            :                                 }
<span class="lineNum">    2273 </span>            :                         }
<span class="lineNum">    2274 </span>            : 
<span class="lineNum">    2275 </span><span class="lineNoCov">          0 :                         ctx-&gt;cts_offset = ctx-&gt;cts_offset_at_splice;</span>
<span class="lineNum">    2276 </span><span class="lineNoCov">          0 :                         ctx-&gt;dts_offset = ctx-&gt;dts_offset_at_splice;</span>
<span class="lineNum">    2277 </span><span class="lineNoCov">          0 :                         ctx-&gt;dts_sub_plus_one = ctx-&gt;dts_sub_plus_one_at_splice;</span>
<span class="lineNum">    2278 </span>            :                         //set splice start as undefined to probe for new splice time
<span class="lineNum">    2279 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_start.num = -1;</span>
<span class="lineNum">    2280 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_start.den = 1;</span>
<span class="lineNum">    2281 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_end.num = -1;</span>
<span class="lineNum">    2282 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_end.den = 1;</span>
<span class="lineNum">    2283 </span>            :                         //make sure we have a packet ready on each input pid before dispatching packets from the main content
<span class="lineNum">    2284 </span>            :                         //so that we trigger synchronized reconfig on all pids
<span class="lineNum">    2285 </span><span class="lineNoCov">          0 :                         ctx-&gt;wait_source = GF_TRUE;</span>
<span class="lineNum">    2286 </span><span class="lineNoCov">          0 :                         return GF_OK;</span>
<span class="lineNum">    2287 </span>            :                 }
<span class="lineNum">    2288 </span>            : 
<span class="lineNum">    2289 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2290 </span><span class="lineNoCov">          0 :                         iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2291 </span><span class="lineNoCov">          0 :                         if (!iopid-&gt;ipid) continue;</span>
<span class="lineNum">    2292 </span><span class="lineNoCov">          0 :                         gf_filter_pid_set_udta(iopid-&gt;ipid, NULL);</span>
<span class="lineNum">    2293 </span><span class="lineNoCov">          0 :                         gf_filter_pid_set_discard(iopid-&gt;ipid, GF_TRUE);</span>
<span class="lineNum">    2294 </span>            :                 }
<span class="lineNum">    2295 </span>            :                 //spliced media is done, load next
<span class="lineNum">    2296 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[FileList] Spliced media is over, switching to next item in playlist\n&quot;));</span>
<span class="lineNum">    2297 </span>            :                 nb_inactive = 0;
<span class="lineNum">    2298 </span>            :                 nb_done = count;
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :                 ctx-&gt;cur_splice_index = 0;</span>
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :                 ctx-&gt;splice_state = ctx-&gt;nb_repeat ? FL_SPLICE_BEFORE : FL_SPLICE_NONE;</span>
<span class="lineNum">    2301 </span>            :         }
<span class="lineNum">    2302 </span>            : 
<span class="lineNum">    2303 </span><span class="lineCov">       2331 :         if (ctx-&gt;wait_splice_start) {</span>
<span class="lineNum">    2304 </span>            :                 Bool ready = GF_TRUE;
<span class="lineNum">    2305 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2306 </span><span class="lineNoCov">          0 :                         iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2307 </span><span class="lineNoCov">          0 :                         if (!iopid-&gt;ipid) continue;</span>
<span class="lineNum">    2308 </span><span class="lineNoCov">          0 :                         if (!iopid-&gt;splice_ready) {</span>
<span class="lineNum">    2309 </span>            :                                 ready = GF_FALSE;
<span class="lineNum">    2310 </span>            :                                 break;
<span class="lineNum">    2311 </span>            :                         }
<span class="lineNum">    2312 </span>            :                 }
<span class="lineNum">    2313 </span><span class="lineNoCov">          0 :                 if (!ready)</span>
<span class="lineNum">    2314 </span>            :                         return GF_OK;
<span class="lineNum">    2315 </span>            : 
<span class="lineNum">    2316 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[FileList] Splice start reached, loading splice content\n&quot;));</span>
<span class="lineNum">    2317 </span><span class="lineNoCov">          0 :                 ctx-&gt;splice_nb_repeat = ctx-&gt;nb_repeat;</span>
<span class="lineNum">    2318 </span><span class="lineNoCov">          0 :                 ctx-&gt;nb_repeat = 0;</span>
<span class="lineNum">    2319 </span><span class="lineNoCov">          0 :                 ctx-&gt;init_start = ctx-&gt;start;</span>
<span class="lineNum">    2320 </span><span class="lineNoCov">          0 :                 ctx-&gt;init_stop = ctx-&gt;stop;</span>
<span class="lineNum">    2321 </span><span class="lineNoCov">          0 :                 ctx-&gt;was_kept = GF_FALSE;</span>
<span class="lineNum">    2322 </span><span class="lineNoCov">          0 :                 ctx-&gt;stop = ctx-&gt;start = 0;</span>
<span class="lineNum">    2323 </span>            :                 nb_inactive = 0;
<span class="lineNum">    2324 </span>            :                 nb_done = count;
<span class="lineNum">    2325 </span>            : 
<span class="lineNum">    2326 </span>            :                 assert(!ctx-&gt;splice_pid_props);
<span class="lineNum">    2327 </span><span class="lineNoCov">          0 :                 ctx-&gt;splice_pid_props = ctx-&gt;pid_props;</span>
<span class="lineNum">    2328 </span><span class="lineNoCov">          0 :                 ctx-&gt;pid_props = NULL;</span>
<span class="lineNum">    2329 </span>            : 
<span class="lineNum">    2330 </span><span class="lineNoCov">          0 :                 ctx-&gt;cts_offset_at_splice = ctx-&gt;cts_offset;</span>
<span class="lineNum">    2331 </span><span class="lineNoCov">          0 :                 ctx-&gt;dts_offset_at_splice = ctx-&gt;dts_offset;</span>
<span class="lineNum">    2332 </span><span class="lineNoCov">          0 :                 ctx-&gt;dts_sub_plus_one_at_splice = ctx-&gt;dts_sub_plus_one;</span>
<span class="lineNum">    2333 </span>            : 
<span class="lineNum">    2334 </span><span class="lineNoCov">          0 :                 if (ctx-&gt;mark_only) {</span>
<span class="lineNum">    2335 </span><span class="lineNoCov">          0 :                         ctx-&gt;cur_splice_index ++;</span>
<span class="lineNum">    2336 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2337 </span><span class="lineNoCov">          0 :                                 iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2338 </span><span class="lineNoCov">          0 :                                 if (iopid-&gt;ipid) {</span>
<span class="lineNum">    2339 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_resume&quot;, NULL);</span>
<span class="lineNum">    2340 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_resume&quot;, &amp;PROP_STRING(ctx-&gt;dyn_period_id ? ctx-&gt;dyn_period_id : &quot;&quot;) );</span>
<span class="lineNum">    2341 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_switch&quot;, NULL);</span>
<span class="lineNum">    2342 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_set_property_str(iopid-&gt;opid, &quot;period_switch&quot;, &amp;PROP_BOOL(GF_TRUE) );</span>
<span class="lineNum">    2343 </span>            :                                 }
<span class="lineNum">    2344 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;splice_props)</span>
<span class="lineNum">    2345 </span><span class="lineNoCov">          0 :                                         gf_filter_pid_push_properties(iopid-&gt;opid, ctx-&gt;splice_props, GF_TRUE, GF_TRUE);</span>
<span class="lineNum">    2346 </span>            : 
<span class="lineNum">    2347 </span><span class="lineNoCov">          0 :                                 if (ctx-&gt;dyn_period_id)</span>
<span class="lineNum">    2348 </span><span class="lineNoCov">          0 :                                         filelist_push_period_id(ctx, iopid-&gt;opid);</span>
<span class="lineNum">    2349 </span>            :                         }
<span class="lineNum">    2350 </span><span class="lineNoCov">          0 :                         if (ctx-&gt;splice_props) {</span>
<span class="lineNum">    2351 </span><span class="lineNoCov">          0 :                                 gf_free(ctx-&gt;splice_props);</span>
<span class="lineNum">    2352 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_props = NULL;</span>
<span class="lineNum">    2353 </span>            :                         }
<span class="lineNum">    2354 </span><span class="lineNoCov">          0 :                         ctx-&gt;wait_splice_start = GF_FALSE;</span>
<span class="lineNum">    2355 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_ctrl-&gt;splice_ipid = ctx-&gt;splice_ctrl-&gt;ipid;</span>
<span class="lineNum">    2356 </span><span class="lineNoCov">          0 :                         ctx-&gt;splice_ctrl-&gt;splice_ra_info = ctx-&gt;splice_ctrl-&gt;ra_info;</span>
<span class="lineNum">    2357 </span><span class="lineNoCov">          0 :                         return GF_OK;</span>
<span class="lineNum">    2358 </span>            :                 }
<span class="lineNum">    2359 </span>            :                 //make sure we have a packet ready on each input pid before dispatching packets from the splice
<span class="lineNum">    2360 </span>            :                 //so that we trigger synchronized reconfig on all pids
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :                 ctx-&gt;wait_source = GF_TRUE;</span>
<span class="lineNum">    2362 </span>            :         }
<span class="lineNum">    2363 </span>            : 
<span class="lineNum">    2364 </span>            : 
<span class="lineNum">    2365 </span>            : 
<span class="lineNum">    2366 </span><span class="lineCov">       2331 :         if ((nb_inactive!=count) &amp;&amp; (nb_done+nb_inactive==count)) {</span>
<span class="lineNum">    2367 </span>            :                 //compute max cts and dts
<span class="lineNum">    2368 </span>            :                 GF_Fraction64 max_cts, max_dts;
<span class="lineNum">    2369 </span>            :                 max_cts.num = max_dts.num = 0;
<span class="lineNum">    2370 </span>            :                 max_cts.den = max_dts.den = 1;
<span class="lineNum">    2371 </span>            : 
<span class="lineNum">    2372 </span><span class="lineCov">         68 :                 if (gf_filter_end_of_session(filter) || (nb_stop + nb_inactive == count) ) {</span>
<span class="lineNum">    2373 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2374 </span><span class="lineNoCov">          0 :                                 iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2375 </span><span class="lineNoCov">          0 :                                 gf_filter_pid_set_eos(iopid-&gt;opid);</span>
<span class="lineNum">    2376 </span>            :                         }
<span class="lineNum">    2377 </span><span class="lineNoCov">          0 :                         ctx-&gt;is_eos = GF_TRUE;</span>
<span class="lineNum">    2378 </span><span class="lineNoCov">          0 :                         return GF_EOS;</span>
<span class="lineNum">    2379 </span>            :                 }
<span class="lineNum">    2380 </span><span class="lineCov">         68 :                 ctx-&gt;dts_sub_plus_one.num = 0;</span>
<span class="lineNum">    2381 </span><span class="lineCov">        136 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2382 </span>            :                         u64 ts;
<span class="lineNum">    2383 </span><span class="lineCov">         68 :                         iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2384 </span><span class="lineCov">         68 :                         iopid-&gt;send_cue = ctx-&gt;sigcues;</span>
<span class="lineNum">    2385 </span><span class="lineCov">         68 :                         if (!iopid-&gt;ipid) continue;</span>
<span class="lineNum">    2386 </span>            : 
<span class="lineNum">    2387 </span><span class="lineCov">         68 :                         ts = iopid-&gt;max_cts - iopid-&gt;dts_sub;</span>
<span class="lineNum">    2388 </span><span class="lineCov">         68 :                         if (max_cts.num * (u64) iopid-&gt;timescale &lt; ts * max_cts.den) {</span>
<span class="lineNum">    2389 </span>            :                                 max_cts.num = ts;
<span class="lineNum">    2390 </span>            :                                 max_cts.den = iopid-&gt;timescale;
<span class="lineNum">    2391 </span>            :                         }
<span class="lineNum">    2392 </span>            : 
<span class="lineNum">    2393 </span><span class="lineCov">         68 :                         ts = iopid-&gt;max_dts - iopid-&gt;dts_sub;</span>
<span class="lineNum">    2394 </span><span class="lineCov">         68 :                         if (max_dts.num * (u64) iopid-&gt;timescale &lt; ts * max_dts.den) {</span>
<span class="lineNum">    2395 </span><span class="lineCov">         68 :                                 max_dts.num = ts;</span>
<span class="lineNum">    2396 </span>            :                                 max_dts.den = iopid-&gt;timescale;
<span class="lineNum">    2397 </span>            :                         }
<span class="lineNum">    2398 </span>            :                 }
<span class="lineNum">    2399 </span><span class="lineCov">         68 :                 if (!ctx-&gt;cts_offset.num) {</span>
<span class="lineNum">    2400 </span><span class="lineCov">         10 :                         ctx-&gt;cts_offset = max_dts;</span>
<span class="lineNum">    2401 </span><span class="lineCov">         58 :                 } else if (ctx-&gt;cts_offset.den == max_dts.den) {</span>
<span class="lineNum">    2402 </span><span class="lineCov">         51 :                         ctx-&gt;cts_offset.num += max_dts.num;</span>
<span class="lineNum">    2403 </span><span class="lineCov">          7 :                 } else if (max_dts.den&gt;ctx-&gt;cts_offset.den) {</span>
<span class="lineNum">    2404 </span><span class="lineCov">          3 :                         ctx-&gt;cts_offset.num *= max_dts.den;</span>
<span class="lineNum">    2405 </span><span class="lineCov">          3 :                         ctx-&gt;cts_offset.num /= ctx-&gt;cts_offset.den;</span>
<span class="lineNum">    2406 </span><span class="lineCov">          3 :                         ctx-&gt;cts_offset.num += max_dts.num;</span>
<span class="lineNum">    2407 </span><span class="lineCov">          3 :                         ctx-&gt;cts_offset.den = max_dts.den;</span>
<span class="lineNum">    2408 </span>            :                 } else {
<span class="lineNum">    2409 </span><span class="lineCov">          4 :                         ctx-&gt;cts_offset.num += max_dts.num * ctx-&gt;cts_offset.den / max_dts.den;</span>
<span class="lineNum">    2410 </span>            :                 }
<span class="lineNum">    2411 </span>            : 
<span class="lineNum">    2412 </span><span class="lineCov">         68 :                 if (!ctx-&gt;dts_offset.num) {</span>
<span class="lineNum">    2413 </span><span class="lineCov">         10 :                         ctx-&gt;dts_offset = max_dts;</span>
<span class="lineNum">    2414 </span><span class="lineCov">         58 :                 } else if (ctx-&gt;dts_offset.den == max_dts.den) {</span>
<span class="lineNum">    2415 </span><span class="lineCov">         51 :                         ctx-&gt;dts_offset.num += max_dts.num;</span>
<span class="lineNum">    2416 </span><span class="lineCov">          7 :                 } else if (max_dts.den&gt;ctx-&gt;dts_offset.den) {</span>
<span class="lineNum">    2417 </span><span class="lineCov">          3 :                         ctx-&gt;dts_offset.num *= max_dts.den;</span>
<span class="lineNum">    2418 </span><span class="lineCov">          3 :                         ctx-&gt;dts_offset.num /= ctx-&gt;dts_offset.den;</span>
<span class="lineNum">    2419 </span><span class="lineCov">          3 :                         ctx-&gt;dts_offset.num += max_dts.num;</span>
<span class="lineNum">    2420 </span><span class="lineCov">          3 :                         ctx-&gt;dts_offset.den = max_dts.den;</span>
<span class="lineNum">    2421 </span>            :                 } else {
<span class="lineNum">    2422 </span><span class="lineCov">          4 :                         ctx-&gt;dts_offset.num += max_dts.num * ctx-&gt;dts_offset.den / max_dts.den;</span>
<span class="lineNum">    2423 </span>            :                 }
<span class="lineNum">    2424 </span>            : 
<span class="lineNum">    2425 </span><span class="lineCov">         68 :                 if (ctx-&gt;nb_repeat) {</span>
<span class="lineNum">    2426 </span>            :                         Bool is_splice_resume = GF_FALSE;
<span class="lineNum">    2427 </span><span class="lineCov">         24 :                         if ((s32) ctx-&gt;nb_repeat&gt;0)</span>
<span class="lineNum">    2428 </span><span class="lineCov">         24 :                                 ctx-&gt;nb_repeat--;</span>
<span class="lineNum">    2429 </span>            : 
<span class="lineNum">    2430 </span>            :                         //reload of main content
<span class="lineNum">    2431 </span><span class="lineCov">         24 :                         if (ctx-&gt;splice_state==FL_SPLICE_AFTER) {</span>
<span class="lineNum">    2432 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_start = ctx-&gt;init_splice_start;</span>
<span class="lineNum">    2433 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_end = ctx-&gt;init_splice_end;</span>
<span class="lineNum">    2434 </span><span class="lineNoCov">          0 :                                 ctx-&gt;flags_splice_start = ctx-&gt;init_flags_splice_start;</span>
<span class="lineNum">    2435 </span><span class="lineNoCov">          0 :                                 ctx-&gt;flags_splice_end = ctx-&gt;init_flags_splice_end;</span>
<span class="lineNum">    2436 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_state = FL_SPLICE_BEFORE;</span>
<span class="lineNum">    2437 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_end_cts = 0;</span>
<span class="lineNum">    2438 </span><span class="lineNoCov">          0 :                                 ctx-&gt;splice_start_cts = 0;</span>
<span class="lineNum">    2439 </span><span class="lineNoCov">          0 :                                 ctx-&gt;spliced_current_cts = 0;</span>
<span class="lineNum">    2440 </span><span class="lineNoCov">          0 :                                 ctx-&gt;dts_sub_plus_one_at_splice.num = 0;</span>
<span class="lineNum">    2441 </span><span class="lineNoCov">          0 :                                 ctx-&gt;last_url_crc = ctx-&gt;last_splice_crc;</span>
<span class="lineNum">    2442 </span><span class="lineNoCov">          0 :                                 ctx-&gt;last_url_lineno = ctx-&gt;last_splice_lineno;</span>
<span class="lineNum">    2443 </span><span class="lineNoCov">          0 :                                 ctx-&gt;start = ctx-&gt;init_start;</span>
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 :                                 ctx-&gt;stop = ctx-&gt;init_stop;</span>
<span class="lineNum">    2445 </span>            :                                 is_splice_resume = GF_TRUE;
<span class="lineNum">    2446 </span>            :                         }
<span class="lineNum">    2447 </span>            : 
<span class="lineNum">    2448 </span><span class="lineCov">         48 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2449 </span>            :                                 GF_FilterEvent evt;
<span class="lineNum">    2450 </span><span class="lineCov">         24 :                                 iopid = gf_list_get(ctx-&gt;io_pids, i);</span>
<span class="lineNum">    2451 </span><span class="lineCov">         24 :                                 if (!iopid-&gt;ipid) continue;</span>
<span class="lineNum">    2452 </span>            : 
<span class="lineNum">    2453 </span><span class="lineCov">         24 :                                 gf_filter_pid_set_discard(iopid-&gt;ipid, GF_FALSE);</span>
<span class="lineNum">    2454 </span>            : 
<span class="lineNum">    2455 </span><span class="lineCov">         24 :                                 GF_FEVT_INIT(evt, GF_FEVT_STOP, iopid-&gt;ipid);</span>
<span class="lineNum">    2456 </span><span class="lineCov">         24 :                                 gf_filter_pid_send_event(iopid-&gt;ipid, &amp;evt);</span>
<span class="lineNum">    2457 </span>            : 
<span class="lineNum">    2458 </span><span class="lineCov">         24 :                                 iopid-&gt;is_eos = GF_FALSE;</span>
<span class="lineNum">    2459 </span><span class="lineCov">         24 :                                 filelist_start_ipid(ctx, iopid, iopid-&gt;timescale);</span>
<span class="lineNum">    2460 </span><span class="lineCov">         24 :                                 if (is_splice_resume) {</span>
<span class="lineNum">    2461 </span><span class="lineNoCov">          0 :                                         iopid-&gt;dts_o_splice = iopid-&gt;cts_o;</span>
<span class="lineNum">    2462 </span><span class="lineNoCov">          0 :                                         iopid-&gt;cts_o_splice = iopid-&gt;dts_o;</span>
<span class="lineNum">    2463 </span><span class="lineNoCov">          0 :                                         iopid-&gt;splice_ra_info = iopid-&gt;ra_info;</span>
<span class="lineNum">    2464 </span><span class="lineNoCov">          0 :                                         iopid-&gt;dts_sub_splice = 0;</span>
<span class="lineNum">    2465 </span>            :                                 }
<span class="lineNum">    2466 </span>            :                         }
<span class="lineNum">    2467 </span>            :                 } else {
<span class="lineNum">    2468 </span><span class="lineCov">         44 :                         if (ctx-&gt;splice_state!=FL_SPLICE_ACTIVE) {</span>
<span class="lineNum">    2469 </span><span class="lineCov">         44 :                                 ctx-&gt;splice_state = FL_SPLICE_NONE;</span>
<span class="lineNum">    2470 </span><span class="lineCov">         44 :                                 ctx-&gt;last_splice_crc = 0;</span>
<span class="lineNum">    2471 </span>            :                         }
<span class="lineNum">    2472 </span>            :                         //force load
<span class="lineNum">    2473 </span><span class="lineCov">         44 :                         ctx-&gt;load_next = GF_TRUE;</span>
<span class="lineNum">    2474 </span><span class="lineCov">         44 :                         return filelist_process(filter);</span>
<span class="lineNum">    2475 </span>            :                 }
<span class="lineNum">    2476 </span>            :         }
<span class="lineNum">    2477 </span>            :         return GF_OK;
<a name="2478"><span class="lineNum">    2478 </span>            : }</a>
<span class="lineNum">    2479 </span>            : 
<span class="lineNum">    2480 </span><span class="lineCov">          6 : static void filelist_add_entry(GF_FileListCtx *ctx, FileListEntry *fentry)</span>
<span class="lineNum">    2481 </span>            : {
<span class="lineNum">    2482 </span>            :         u32 i, count;
<span class="lineNum">    2483 </span><span class="lineCov">          6 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_AUTHOR, (&quot;[FileList] Adding file %s to list\n&quot;, fentry-&gt;file_name));</span>
<span class="lineNum">    2484 </span><span class="lineCov">          6 :         if (ctx-&gt;fsort==FL_SORT_NONE) {</span>
<span class="lineNum">    2485 </span><span class="lineCov">          4 :                 gf_list_add(ctx-&gt;file_list, fentry);</span>
<span class="lineNum">    2486 </span>            :                 return;
<span class="lineNum">    2487 </span>            :         }
<span class="lineNum">    2488 </span><span class="lineCov">          2 :         count = gf_list_count(ctx-&gt;file_list);</span>
<span class="lineNum">    2489 </span><span class="lineCov">          1 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2490 </span>            :                 Bool insert=GF_FALSE;
<span class="lineNum">    2491 </span><span class="lineCov">          1 :                 FileListEntry *cur = gf_list_get(ctx-&gt;file_list, i);</span>
<span class="lineNum">    2492 </span><span class="lineCov">          1 :                 switch (ctx-&gt;fsort) {</span>
<span class="lineNum">    2493 </span><span class="lineNoCov">          0 :                 case FL_SORT_SIZE:</span>
<span class="lineNum">    2494 </span><span class="lineNoCov">          0 :                         if (cur-&gt;file_size&gt;fentry-&gt;file_size) insert = GF_TRUE;</span>
<span class="lineNum">    2495 </span>            :                         break;
<span class="lineNum">    2496 </span><span class="lineNoCov">          0 :                 case FL_SORT_DATE:</span>
<span class="lineNum">    2497 </span>            :                 case FL_SORT_DATEX:
<span class="lineNum">    2498 </span><span class="lineNoCov">          0 :                         if (cur-&gt;last_mod_time&gt;fentry-&gt;last_mod_time) insert = GF_TRUE;</span>
<span class="lineNum">    2499 </span>            :                         break;
<span class="lineNum">    2500 </span><span class="lineCov">          1 :                 case FL_SORT_NAME:</span>
<span class="lineNum">    2501 </span><span class="lineCov">          1 :                         if (strcmp(cur-&gt;file_name, fentry-&gt;file_name) &gt; 0) insert = GF_TRUE;</span>
<span class="lineNum">    2502 </span>            :                         break;
<span class="lineNum">    2503 </span>            :                 }
<span class="lineNum">    2504 </span>            :                 if (insert) {
<span class="lineNum">    2505 </span><span class="lineNoCov">          0 :                         gf_list_insert(ctx-&gt;file_list, fentry, i);</span>
<span class="lineNum">    2506 </span>            :                         return;
<span class="lineNum">    2507 </span>            :                 }
<span class="lineNum">    2508 </span>            :         }
<span class="lineNum">    2509 </span><span class="lineCov">          2 :         gf_list_add(ctx-&gt;file_list, fentry);</span>
<a name="2510"><span class="lineNum">    2510 </span>            : }</a>
<span class="lineNum">    2511 </span>            : 
<span class="lineNum">    2512 </span><span class="lineCov">          2 : static Bool filelist_enum(void *cbck, char *item_name, char *item_path, GF_FileEnumInfo *file_info)</span>
<span class="lineNum">    2513 </span>            : {
<span class="lineNum">    2514 </span>            :         FileListEntry *fentry;
<span class="lineNum">    2515 </span>            :         GF_FileListCtx *ctx = cbck;
<span class="lineNum">    2516 </span><span class="lineCov">          2 :         if (file_info-&gt;hidden) return GF_FALSE;</span>
<span class="lineNum">    2517 </span><span class="lineCov">          2 :         if (file_info-&gt;directory) return GF_FALSE;</span>
<span class="lineNum">    2518 </span><span class="lineCov">          2 :         if (file_info-&gt;drive) return GF_FALSE;</span>
<span class="lineNum">    2519 </span><span class="lineCov">          2 :         if (file_info-&gt;system) return GF_FALSE;</span>
<span class="lineNum">    2520 </span>            : 
<span class="lineNum">    2521 </span><span class="lineCov">          2 :         GF_SAFEALLOC(fentry, FileListEntry);</span>
<span class="lineNum">    2522 </span><span class="lineCov">          2 :         if (!fentry) return GF_TRUE;</span>
<span class="lineNum">    2523 </span>            : 
<span class="lineNum">    2524 </span><span class="lineCov">          2 :         fentry-&gt;file_name = gf_strdup(item_path);</span>
<span class="lineNum">    2525 </span><span class="lineCov">          2 :         fentry-&gt;file_size = file_info-&gt;size;</span>
<span class="lineNum">    2526 </span><span class="lineCov">          2 :         fentry-&gt;last_mod_time = file_info-&gt;last_modified;</span>
<span class="lineNum">    2527 </span><span class="lineCov">          2 :         filelist_add_entry(ctx, fentry);</span>
<span class="lineNum">    2528 </span>            : 
<span class="lineNum">    2529 </span><span class="lineCov">          2 :         return GF_FALSE;</span>
<a name="2530"><span class="lineNum">    2530 </span>            : }</a>
<span class="lineNum">    2531 </span>            : 
<span class="lineNum">    2532 </span><span class="lineCov">         10 : static GF_Err filelist_initialize(GF_Filter *filter)</span>
<span class="lineNum">    2533 </span>            : {
<span class="lineNum">    2534 </span>            :         u32 i, count;
<span class="lineNum">    2535 </span>            :         char *sep_dir, c=0, *dir, *pattern;
<span class="lineNum">    2536 </span><span class="lineCov">         10 :         GF_FileListCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    2537 </span><span class="lineCov">         10 :         ctx-&gt;io_pids = gf_list_new();</span>
<span class="lineNum">    2538 </span>            : 
<span class="lineNum">    2539 </span><span class="lineCov">         10 :         ctx-&gt;filter_srcs = gf_list_new();</span>
<span class="lineNum">    2540 </span><span class="lineCov">         10 :         if (ctx-&gt;ka)</span>
<span class="lineNum">    2541 </span><span class="lineNoCov">          0 :                 ctx-&gt;floop = 0;</span>
<span class="lineNum">    2542 </span>            : 
<span class="lineNum">    2543 </span>            : 
<span class="lineNum">    2544 </span><span class="lineCov">         10 :         if (! ctx-&gt;srcs.nb_items ) {</span>
<span class="lineNum">    2545 </span><span class="lineCov">          7 :                 if (! gf_filter_is_dynamic(filter)) {</span>
<span class="lineNum">    2546 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_INFO, GF_LOG_AUTHOR, (&quot;[FileList] No inputs\n&quot;));</span>
<span class="lineNum">    2547 </span>            :                 }
<span class="lineNum">    2548 </span>            :                 return GF_OK;
<span class="lineNum">    2549 </span>            :         }
<span class="lineNum">    2550 </span>            : 
<span class="lineNum">    2551 </span><span class="lineCov">          3 :         ctx-&gt;file_list = gf_list_new();</span>
<span class="lineNum">    2552 </span><span class="lineCov">          3 :         count = ctx-&gt;srcs.nb_items;</span>
<span class="lineNum">    2553 </span><span class="lineCov">          8 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    2554 </span><span class="lineCov">          5 :                 char *list = ctx-&gt;srcs.vals[i];</span>
<span class="lineNum">    2555 </span>            : 
<span class="lineNum">    2556 </span><span class="lineCov">          5 :                 if (strchr(list, '*') ) {</span>
<span class="lineNum">    2557 </span><span class="lineCov">          1 :                         sep_dir = strrchr(list, '/');</span>
<span class="lineNum">    2558 </span><span class="lineCov">          1 :                         if (!sep_dir) sep_dir = strrchr(list, '\\');</span>
<span class="lineNum">    2559 </span><span class="lineCov">          1 :                         if (sep_dir) {</span>
<span class="lineNum">    2560 </span><span class="lineCov">          1 :                                 c = sep_dir[0];</span>
<span class="lineNum">    2561 </span><span class="lineCov">          1 :                                 sep_dir[0] = 0;</span>
<span class="lineNum">    2562 </span>            :                                 dir = list;
<span class="lineNum">    2563 </span><span class="lineCov">          1 :                                 pattern = sep_dir+2;</span>
<span class="lineNum">    2564 </span>            :                         } else {
<span class="lineNum">    2565 </span>            :                                 dir = &quot;.&quot;;
<span class="lineNum">    2566 </span>            :                                 pattern = list;
<span class="lineNum">    2567 </span>            :                         }
<span class="lineNum">    2568 </span><span class="lineCov">          1 :                         gf_enum_directory(dir, GF_FALSE, filelist_enum, ctx, pattern);</span>
<span class="lineNum">    2569 </span><span class="lineCov">          1 :                         if (c &amp;&amp; sep_dir) sep_dir[0] = c;</span>
<span class="lineNum">    2570 </span>            :                 } else {
<span class="lineNum">    2571 </span>            :                         u32 type = 0;
<span class="lineNum">    2572 </span><span class="lineCov">          4 :                         if (strstr(list, &quot; &amp;&amp; &quot;) || strstr(list, &quot;&amp;&amp;&quot;))</span>
<span class="lineNum">    2573 </span>            :                                 type = 1;
<span class="lineNum">    2574 </span><span class="lineCov">          4 :                         else if (gf_file_exists(list))</span>
<span class="lineNum">    2575 </span>            :                                 type = 2;
<span class="lineNum">    2576 </span>            : 
<span class="lineNum">    2577 </span>            :                         if (type) {
<span class="lineNum">    2578 </span>            :                                 FileListEntry *fentry;
<span class="lineNum">    2579 </span><span class="lineCov">          4 :                                 GF_SAFEALLOC(fentry, FileListEntry);</span>
<span class="lineNum">    2580 </span><span class="lineCov">          4 :                                 if (fentry) {</span>
<span class="lineNum">    2581 </span><span class="lineCov">          4 :                                         fentry-&gt;file_name = gf_strdup(list);</span>
<span class="lineNum">    2582 </span><span class="lineCov">          4 :                                         if (type==2) {</span>
<span class="lineNum">    2583 </span>            :                                                 FILE *fo;
<span class="lineNum">    2584 </span><span class="lineCov">          4 :                                                 fentry-&gt;last_mod_time = gf_file_modification_time(list);</span>
<span class="lineNum">    2585 </span><span class="lineCov">          4 :                                                 fo = gf_fopen(list, &quot;rb&quot;);</span>
<span class="lineNum">    2586 </span><span class="lineCov">          4 :                                                 if (fo) {</span>
<span class="lineNum">    2587 </span><span class="lineCov">          4 :                                                         fentry-&gt;file_size = gf_fsize(fo);</span>
<span class="lineNum">    2588 </span><span class="lineCov">          4 :                                                         gf_fclose(fo);</span>
<span class="lineNum">    2589 </span>            :                                                 }
<span class="lineNum">    2590 </span>            :                                         }
<span class="lineNum">    2591 </span><span class="lineCov">          4 :                                         filelist_add_entry(ctx, fentry);</span>
<span class="lineNum">    2592 </span>            :                                 }
<span class="lineNum">    2593 </span>            :                         } else {
<span class="lineNum">    2594 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_AUTHOR, (&quot;[FileList] File %s not found, ignoring\n&quot;, list));</span>
<span class="lineNum">    2595 </span>            :                         }
<span class="lineNum">    2596 </span>            :                 }
<span class="lineNum">    2597 </span>            :         }
<span class="lineNum">    2598 </span>            : 
<span class="lineNum">    2599 </span><span class="lineCov">          3 :         if (!gf_list_count(ctx-&gt;file_list)) {</span>
<span class="lineNum">    2600 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_AUTHOR, (&quot;[FileList] No files found in list %s\n&quot;, ctx-&gt;srcs));</span>
<span class="lineNum">    2601 </span>            :                 return GF_BAD_PARAM;
<span class="lineNum">    2602 </span>            :         }
<span class="lineNum">    2603 </span><span class="lineCov">          3 :         if (ctx-&gt;fsort==FL_SORT_DATEX) {</span>
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 :                 ctx-&gt;revert = GF_FALSE;</span>
<span class="lineNum">    2605 </span><span class="lineNoCov">          0 :                 ctx-&gt;floop = 0;</span>
<span class="lineNum">    2606 </span>            :         }
<span class="lineNum">    2607 </span><span class="lineCov">          3 :         ctx-&gt;file_list_idx = ctx-&gt;revert ? gf_list_count(ctx-&gt;file_list) : -1;</span>
<span class="lineNum">    2608 </span><span class="lineCov">          3 :         ctx-&gt;load_next = GF_TRUE;</span>
<span class="lineNum">    2609 </span>            :         //from now on we only accept the above caps
<span class="lineNum">    2610 </span><span class="lineCov">          3 :         filelist_override_caps(filter, ctx);</span>
<span class="lineNum">    2611 </span>            :         //and we act as a source, request processing
<span class="lineNum">    2612 </span><span class="lineCov">          3 :         gf_filter_post_process_task(filter);</span>
<span class="lineNum">    2613 </span>            :         //prevent deconnection of filter when no input
<span class="lineNum">    2614 </span><span class="lineCov">          3 :         gf_filter_make_sticky(filter);</span>
<span class="lineNum">    2615 </span><span class="lineCov">          3 :         return GF_OK;</span>
<a name="2616"><span class="lineNum">    2616 </span>            : }</a>
<span class="lineNum">    2617 </span>            : 
<span class="lineNum">    2618 </span><span class="lineCov">         10 : static void filelist_finalize(GF_Filter *filter)</span>
<span class="lineNum">    2619 </span>            : {
<span class="lineNum">    2620 </span><span class="lineCov">         10 :         GF_FileListCtx *ctx = gf_filter_get_udta(filter);</span>
<span class="lineNum">    2621 </span><span class="lineCov">         30 :         while (gf_list_count(ctx-&gt;io_pids)) {</span>
<span class="lineNum">    2622 </span><span class="lineCov">         10 :                 FileListPid *iopid = gf_list_pop_back(ctx-&gt;io_pids);</span>
<span class="lineNum">    2623 </span><span class="lineCov">         10 :                 gf_free(iopid);</span>
<span class="lineNum">    2624 </span>            :         }
<span class="lineNum">    2625 </span><span class="lineCov">         10 :         if (ctx-&gt;file_list) {</span>
<span class="lineNum">    2626 </span><span class="lineCov">          9 :                 while (gf_list_count(ctx-&gt;file_list)) {</span>
<span class="lineNum">    2627 </span><span class="lineCov">          6 :                         FileListEntry *fentry = gf_list_pop_back(ctx-&gt;file_list);</span>
<span class="lineNum">    2628 </span><span class="lineCov">          6 :                         gf_free(fentry-&gt;file_name);</span>
<span class="lineNum">    2629 </span><span class="lineCov">          6 :                         gf_free(fentry);</span>
<span class="lineNum">    2630 </span>            :                 }
<span class="lineNum">    2631 </span><span class="lineCov">          3 :                 gf_list_del(ctx-&gt;file_list);</span>
<span class="lineNum">    2632 </span>            :         }
<span class="lineNum">    2633 </span><span class="lineCov">         10 :         gf_list_del(ctx-&gt;io_pids);</span>
<span class="lineNum">    2634 </span><span class="lineCov">         10 :         gf_list_del(ctx-&gt;filter_srcs);</span>
<span class="lineNum">    2635 </span><span class="lineCov">         10 :         if (ctx-&gt;file_path) gf_free(ctx-&gt;file_path);</span>
<span class="lineNum">    2636 </span><span class="lineCov">         10 :         if (ctx-&gt;frag_url) gf_free(ctx-&gt;frag_url);</span>
<span class="lineNum">    2637 </span><span class="lineCov">         10 :         if (ctx-&gt;unknown_params) gf_free(ctx-&gt;unknown_params);</span>
<span class="lineNum">    2638 </span><span class="lineCov">         10 :         if (ctx-&gt;pid_props) gf_free(ctx-&gt;pid_props);</span>
<span class="lineNum">    2639 </span><span class="lineCov">         10 :         if (ctx-&gt;dyn_period_id) gf_free(ctx-&gt;dyn_period_id);</span>
<span class="lineNum">    2640 </span><span class="lineCov">         10 :         if (ctx-&gt;splice_props) gf_free(ctx-&gt;splice_props);</span>
<span class="lineNum">    2641 </span><span class="lineCov">         10 :         if (ctx-&gt;splice_pid_props) gf_free(ctx-&gt;splice_pid_props);</span>
<a name="2642"><span class="lineNum">    2642 </span><span class="lineCov">         10 : }</span></a>
<span class="lineNum">    2643 </span>            : 
<span class="lineNum">    2644 </span><span class="lineCov">       3065 : static const char *filelist_probe_data(const u8 *data, u32 size, GF_FilterProbeScore *score)</span>
<span class="lineNum">    2645 </span>            : {
<span class="lineNum">    2646 </span>            :         u32 nb_lines = 0;
<span class="lineNum">    2647 </span><span class="lineCov">       3065 :         if (!gf_utf8_is_legal(data, size)) {</span>
<span class="lineNum">    2648 </span>            :                 return NULL;
<span class="lineNum">    2649 </span>            :         }
<span class="lineNum">    2650 </span><span class="lineCov">       3218 :         while (data &amp;&amp; size) {</span>
<span class="lineNum">    2651 </span>            :                 u32 i, line_size;
<span class="lineNum">    2652 </span>            :                 Bool is_cr = GF_FALSE;
<span class="lineNum">    2653 </span>            :                 char *nl;
<span class="lineNum">    2654 </span><span class="lineCov">       3088 :                 nl = memchr(data, '\r', size);</span>
<span class="lineNum">    2655 </span><span class="lineCov">       3088 :                 if (!nl)</span>
<span class="lineNum">    2656 </span><span class="lineCov">       3063 :                         nl = memchr(data, '\n', size);</span>
<span class="lineNum">    2657 </span>            :                 else
<span class="lineNum">    2658 </span>            :                         is_cr = GF_TRUE;
<span class="lineNum">    2659 </span>            : 
<span class="lineNum">    2660 </span><span class="lineCov">       3088 :                 if (nl)</span>
<span class="lineNum">    2661 </span><span class="lineCov">       2987 :                         line_size = (u32) (nl - (char *) data);</span>
<span class="lineNum">    2662 </span>            :                 else
<span class="lineNum">    2663 </span><span class="lineCov">        101 :                         line_size = size-1;</span>
<span class="lineNum">    2664 </span>            : 
<span class="lineNum">    2665 </span>            :                 //line is comment
<span class="lineNum">    2666 </span><span class="lineCov">       3088 :                 if (data[0] != '#') {</span>
<span class="lineNum">    2667 </span>            :                         Bool line_empty = GF_TRUE;
<span class="lineNum">    2668 </span><span class="lineCov">      21699 :                         for (i=0;i&lt;line_size; i++) {</span>
<span class="lineNum">    2669 </span><span class="lineCov">      22478 :                                 char c = (char) data[i];</span>
<span class="lineNum">    2670 </span><span class="lineCov">      22478 :                                 if (!c) return NULL;</span>
<span class="lineNum">    2671 </span><span class="lineCov">      22416 :                                 if ( isalnum(c)) continue;</span>
<span class="lineNum">    2672 </span>            :                                 //valid URL chars plus backslash for win path
<span class="lineNum">    2673 </span><span class="lineCov">       2586 :                                 if (strchr(&quot;-._~:/?#[]@!$&amp;'()*+,;%=\\&quot;, c)) {</span>
<span class="lineNum">    2674 </span>            :                                         line_empty = GF_FALSE;
<span class="lineNum">    2675 </span><span class="lineCov">       1869 :                                         continue;</span>
<span class="lineNum">    2676 </span>            :                                 }
<span class="lineNum">    2677 </span>            :                                 //not a valid URL
<span class="lineNum">    2678 </span>            :                                 return NULL;
<span class="lineNum">    2679 </span>            :                         }
<span class="lineNum">    2680 </span><span class="lineCov">        506 :                         if (!line_empty)</span>
<span class="lineNum">    2681 </span><span class="lineCov">        331 :                                 nb_lines++;</span>
<span class="lineNum">    2682 </span>            :                 }
<span class="lineNum">    2683 </span><span class="lineCov">       2309 :                 if (!nl) break;</span>
<span class="lineNum">    2684 </span><span class="lineCov">       2306 :                 size -= (u32) (nl+1 - (char *) data);</span>
<span class="lineNum">    2685 </span>            :                 data = nl+1;
<span class="lineNum">    2686 </span><span class="lineCov">       2306 :                 if (is_cr &amp;&amp; (data[0]=='\n')) {</span>
<span class="lineNum">    2687 </span><span class="lineCov">          4 :                         size --;</span>
<span class="lineNum">    2688 </span><span class="lineCov">          4 :                         data++;</span>
<span class="lineNum">    2689 </span>            :                 }
<span class="lineNum">    2690 </span>            :         }
<span class="lineNum">    2691 </span><span class="lineCov">        133 :         if (!nb_lines) return NULL;</span>
<span class="lineNum">    2692 </span><span class="lineCov">        129 :         *score = GF_FPROBE_MAYBE_SUPPORTED;</span>
<span class="lineNum">    2693 </span><span class="lineCov">        129 :         return &quot;application/x-gpac-playlist&quot;;</span>
<span class="lineNum">    2694 </span>            : }
<span class="lineNum">    2695 </span>            : 
<span class="lineNum">    2696 </span>            : #define OFFS(_n)        #_n, offsetof(GF_FileListCtx, _n)
<span class="lineNum">    2697 </span>            : static const GF_FilterArgs GF_FileListArgs[] =
<span class="lineNum">    2698 </span>            : {
<span class="lineNum">    2699 </span>            :         { OFFS(floop), &quot;loop playlist/list of files, `0` for one time, `n` for n+1 times, `-1` for indefinitely&quot;, GF_PROP_SINT, &quot;0&quot;, NULL, 0},
<span class="lineNum">    2700 </span>            :         { OFFS(srcs), &quot;list of files to play - see filter help&quot;, GF_PROP_STRING_LIST, NULL, NULL, 0},
<span class="lineNum">    2701 </span>            :         { OFFS(fdur), &quot;for source files with a single frame, sets frame duration. 0/NaN fraction means reuse source timing which is usually not set!&quot;, GF_PROP_FRACTION, &quot;1/25&quot;, NULL, 0},
<span class="lineNum">    2702 </span>            :         { OFFS(revert), &quot;revert list of files (not playlist)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2703 </span>            :         { OFFS(timescale), &quot;force output timescale on all pids. 0 uses the timescale of the first pid found&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2704 </span>            :         { OFFS(ka), &quot;keep playlist alive (disable loop), waiting the for a new input to be added or `#end` to end playlist. The value specify the refresh rate in ms&quot;, GF_PROP_UINT, &quot;0&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2705 </span>            : 
<span class="lineNum">    2706 </span>            :         { OFFS(fsort), &quot;sort list of files\n&quot;
<span class="lineNum">    2707 </span>            :                 &quot;- no: no sorting, use default directory enumeration of OS\n&quot;
<span class="lineNum">    2708 </span>            :                 &quot;- name: sort by alphabetical name\n&quot;
<span class="lineNum">    2709 </span>            :                 &quot;- size: sort by increasing size\n&quot;
<span class="lineNum">    2710 </span>            :                 &quot;- date: sort by increasing modification time\n&quot;
<span class="lineNum">    2711 </span>            :                 &quot;- datex: sort by increasing modification time - see filter help&quot;
<span class="lineNum">    2712 </span>            :                 , GF_PROP_UINT, &quot;no&quot;, &quot;no|name|size|date|datex&quot;, 0},
<span class="lineNum">    2713 </span>            : 
<span class="lineNum">    2714 </span>            :         { OFFS(sigcues), &quot;inject CueStart property at each source begin (new or repeated) for DASHing&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2715 </span>            :         { OFFS(fdel), &quot;delete source files after processing in playlist mode (does not delete the playlist)&quot;, GF_PROP_BOOL, &quot;false&quot;, NULL, GF_FS_ARG_HINT_ADVANCED},
<span class="lineNum">    2716 </span>            :         { OFFS(raw), &quot;force input AV streams to be in raw format\n&quot;
<span class="lineNum">    2717 </span>            :         &quot;- no: do not force decoding of inputs\n&quot;
<span class="lineNum">    2718 </span>            :         &quot;- av: force decoding of audio and video inputs\n&quot;
<span class="lineNum">    2719 </span>            :         &quot;- a: force decoding of audio inputs\n&quot;
<span class="lineNum">    2720 </span>            :         &quot;- v: force decoding of video inputs&quot;, GF_PROP_UINT, &quot;no&quot;, &quot;av|a|v|no&quot;, GF_FS_ARG_HINT_NORMAL},
<span class="lineNum">    2721 </span>            : 
<span class="lineNum">    2722 </span>            :         {0}
<span class="lineNum">    2723 </span>            : };
<span class="lineNum">    2724 </span>            : 
<span class="lineNum">    2725 </span>            : 
<span class="lineNum">    2726 </span>            : static const GF_FilterCapability FileListCaps[] =
<span class="lineNum">    2727 </span>            : {
<span class="lineNum">    2728 </span>            :         CAP_UINT(GF_CAPS_INPUT, GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    2729 </span>            :         CAP_STRING(GF_CAPS_INPUT, GF_PROP_PID_FILE_EXT, &quot;txt|m3u|pl&quot;),
<span class="lineNum">    2730 </span>            :         CAP_STRING(GF_CAPS_INPUT, GF_PROP_PID_MIME, &quot;application/x-gpac-playlist&quot;),
<span class="lineNum">    2731 </span>            :         CAP_UINT(GF_CAPS_OUTPUT_EXCLUDED, GF_PROP_PID_STREAM_TYPE, GF_STREAM_FILE),
<span class="lineNum">    2732 </span>            : };
<span class="lineNum">    2733 </span>            : 
<span class="lineNum">    2734 </span>            : 
<span class="lineNum">    2735 </span>            : GF_FilterRegister FileListRegister = {
<span class="lineNum">    2736 </span>            :         .name = &quot;flist&quot;,
<span class="lineNum">    2737 </span>            :         GF_FS_SET_DESCRIPTION(&quot;Sources concatenator&quot;)
<span class="lineNum">    2738 </span>            :         GF_FS_SET_HELP(&quot;This filter can be used to play playlist files or a list of sources.\n&quot;
<span class="lineNum">    2739 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2740 </span>            :                 &quot;The filter loads any source supported by GPAC: remote or local files or streaming sessions (TS, RTP, DASH or other).\n&quot;
<span class="lineNum">    2741 </span>            :                 &quot;The filter forces input demultiplex and recomputes the input timestamps into a continuous timeline.\n&quot;
<span class="lineNum">    2742 </span>            :                 &quot;At each new source, the filter tries to remap input PIDs to already declared output PIDs of the same type, if any, or declares new output PIDs otherwise. If no input PID matches the type of an output, no packets are send for that PID.\n&quot;
<span class="lineNum">    2743 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2744 </span>            :                 &quot;# Source list mode\n&quot;
<span class="lineNum">    2745 </span>            :                 &quot;The source list mode is activated by using `flist:srcs=f1[,f2]`, where f1 can be a file or a directory to enumerate.\n&quot;
<span class="lineNum">    2746 </span>            :                 &quot;The syntax for directory enumeration is:\n&quot;
<span class="lineNum">    2747 </span>            :                 &quot;- dir/*: enumerates everything in dir\n&quot;
<span class="lineNum">    2748 </span>            :                 &quot;- foo/*.png: enumerates all files with extension png in foo\n&quot;
<span class="lineNum">    2749 </span>            :                 &quot;- foo/*.png;*.jpg: enumerates all files with extension png or jpg in foo\n&quot;
<span class="lineNum">    2750 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2751 </span>            :                 &quot;The resulting file list can be sorted using [-fsort]().\n&quot;
<span class="lineNum">    2752 </span>            :                 &quot;If the sort mode is `datex` and source files are images or single frame files, the following applies:\n&quot;
<span class="lineNum">    2753 </span>            :                 &quot;- options [-floop](), [-revert]() and [-dur]() are ignored\n&quot;
<span class="lineNum">    2754 </span>            :                 &quot;- the files are sorted by modification time\n&quot;
<span class="lineNum">    2755 </span>            :                 &quot;- the first frame is assigned a timestamp of 0\n&quot;
<span class="lineNum">    2756 </span>            :                 &quot;- each frame (coming from each file) is assigned a duration equal to the difference of modification time between the file and the next file\n&quot;
<span class="lineNum">    2757 </span>            :                 &quot;- the last frame is assigned the same duration as the previous one\n&quot;
<span class="lineNum">    2758 </span>            :                 &quot;# Playlist mode\n&quot;
<span class="lineNum">    2759 </span>            :                 &quot;The playlist mode is activated when opening a playlist file (m3u format, utf-8 encoding, default extensions `m3u`, `txt` or `pl`).\n&quot;
<span class="lineNum">    2760 </span>            :                 &quot;In this mode, directives can be given in a comment line, i.e. a line starting with '#' before the line with the file name.\n&quot;
<span class="lineNum">    2761 </span>            :                 &quot;Lines stating with `##` are ignored.\n&quot;
<span class="lineNum">    2762 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2763 </span>            :                 &quot;The playlist file is refreshed whenever the next source has to be reloaded in order to allow for dynamic pushing of sources in the playlist.\n&quot;\
<span class="lineNum">    2764 </span>            :                 &quot;If the last URL played cannot be found in the playlist, the first URL in the playlist file will be loaded.\n&quot;
<span class="lineNum">    2765 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2766 </span>            :                 &quot;When [-ka]() is used to keep refreshing the playlist on regular basis, the playlist must end with a new line.\n&quot;
<span class="lineNum">    2767 </span>            :                 &quot;Playlist refreshing will abort:\n&quot;
<span class="lineNum">    2768 </span>            :                 &quot;- if the input playlist has a line not ending with a LF `(\\n)` character, in order to avoid asynchronous issues when reading the playlist.\n&quot;
<span class="lineNum">    2769 </span>            :                 &quot;- if the input playlist has not been modified for 60 times the refresh rate (based on file system modification time info).\n&quot;
<span class="lineNum">    2770 </span>            :                 &quot;## Playlist directives\n&quot;
<span class="lineNum">    2771 </span>            :                 &quot;A playlist directive line can contain zero or more directives, separated with space. The following directives are supported:\n&quot;
<span class="lineNum">    2772 </span>            :                 &quot;- repeat=N: repeats N times the content (hence played N+1).\n&quot;
<span class="lineNum">    2773 </span>            :                 &quot;- start=T: tries to play the file from start time T seconds (double format only). This may not work with some files/formats not supporting seeking.\n&quot;
<span class="lineNum">    2774 </span>            :                 &quot;- stop=T: stops source playback after T seconds (double format only). This works on any source (implemented independently from seek support).\n&quot;
<span class="lineNum">    2775 </span>            :                 &quot;- cat: specifies that the following entry should be concatenated to the previous source rather than opening a new source. This can optionally specify a byte range if desired, otherwise the full file is concatenated.\n&quot;
<span class="lineNum">    2776 </span>            :                 &quot;Note: When sources are ISOBMFF files or segments on local storage or GF_FileIO objects, the concatenation will be automatically detected.\n&quot;
<span class="lineNum">    2777 </span>            :                 &quot;- srange=T: when cat is set, indicates the start T (64 bit decimal, default 0) of the byte range from the next entry to concatenate.\n&quot;
<span class="lineNum">    2778 </span>            :                 &quot;- send=T: when cat is set, indicates the end T (64 bit decimal, default 0) of the byte range from the next entry to concatenate.\n&quot;
<span class="lineNum">    2779 </span>            :                 &quot;- props=STR: assigns properties described in `STR` to all pids coming from the listed sources on next line. `STR` is formatted according to `gpac -h doc` using the default parameter set.\n&quot;
<span class="lineNum">    2780 </span>            :                 &quot;- del: specifies that the source file(s) must be deleted once processed, true by default is [-fdel]() is set.\n&quot;
<span class="lineNum">    2781 </span>            :                 &quot;- out=V: specifies splicing start time (cf below).\n&quot;
<span class="lineNum">    2782 </span>            :                 &quot;- in=V: specifies splicing end time (cf below).\n&quot;
<span class="lineNum">    2783 </span>            :                 &quot;- nosync: prevents timestamp adjustments when joining sources (implied if `cat` is set).\n&quot;
<span class="lineNum">    2784 </span>            :                 &quot;- keep: keeps spliced period in output (cf below).\n&quot;
<span class="lineNum">    2785 </span>            :                 &quot;- mark: only inject marker for the splice period and do not load any replacement content (cf below).\n&quot;
<span class="lineNum">    2786 </span>            :                 &quot;- sprops=STR: assigns properties described in `STR` to all pids of the main content during a splice (cf below). `STR` is formatted according to `gpac -h doc` using the default parameter set.\n&quot;
<span class="lineNum">    2787 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2788 </span>            :                 &quot;The following global options (applying to the filter, not the sources) may also be set in the playlist:\n&quot;
<span class="lineNum">    2789 </span>            :                 &quot;- ka=N: force [-ka]() option to `N` millisecond refresh.\n&quot;
<span class="lineNum">    2790 </span>            :                 &quot;- floop=N: set [-floop]() option from within playlist.\n&quot;
<span class="lineNum">    2791 </span>            :                 &quot;- raw: set [-raw]() option from within playlist.\n&quot;
<span class="lineNum">    2792 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2793 </span>            :                 &quot;The default behavior when joining sources is to realign the timeline origin of the new source to the maximum time in all pids of the previous sources.\n&quot;
<span class="lineNum">    2794 </span>            :                 &quot;This may create gaps in the timeline in case each pid are not of equal duration (quite common with most audio codecs).\n&quot;
<span class="lineNum">    2795 </span>            :                 &quot;Using `nosync` directive will disable this realignment and provide a continuous timeline but may introduce synchronization errors depending in the source encoding (use with caution).\n&quot;
<span class="lineNum">    2796 </span>            :                 &quot;## Source syntax\n&quot;
<span class="lineNum">    2797 </span>            :                 &quot;The source lines follow the usual source syntax, see `gpac -h`.\n&quot;
<span class="lineNum">    2798 </span>            :                 &quot;Additional pid properties can be added per source (see `gpac -h doc`), but are valid only for the current source, and reset at next source.\n&quot;
<span class="lineNum">    2799 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2800 </span>            :                 &quot;The URL given can either be a single URL, or a list of URLs separated by \&quot; &amp;&amp; \&quot; to load several sources for the active entry.\n&quot;
<span class="lineNum">    2801 </span>            :                 &quot;Warning: There shall not be any other space/tab characters between sources.\n&quot;
<span class="lineNum">    2802 </span>            :                 &quot;EX audio.mp4 &amp;&amp; video.mp4\n&quot;
<span class="lineNum">    2803 </span>            :                 &quot;## Source with filter chains\n&quot;
<span class="lineNum">    2804 </span>            :                 &quot;Each URL can be followed by a chain of one or more filters, using the `@` link directive as used in gpac (see `gpac -h doc`).\n&quot;
<span class="lineNum">    2805 </span>            :                 &quot;A negative link index (e.g. `@-1`) can be used to setup a new filter chain starting from the last specified source in the line.\n&quot;
<span class="lineNum">    2806 </span>            :                 &quot;Warning: There shall be a single character, with value space (' '), before and after each link directive.\n&quot;
<span class="lineNum">    2807 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2808 </span>            :                 &quot;EX src.mp4 @ reframer:rt=on\n&quot;
<span class="lineNum">    2809 </span>            :                 &quot;This will inject a reframer with real-time regulation between source and `flist` filter.\n&quot;
<span class="lineNum">    2810 </span>            :                 &quot;EX src.mp4 @ reframer:saps=1 @1 reframer:saps=0,2,3\n&quot;
<span class="lineNum">    2811 </span>            :                 &quot;EX src.mp4 @ reframer:saps=1 @-1 reframer:saps=0,2,3\n&quot;
<span class="lineNum">    2812 </span>            :                 &quot;This will inject a reframer filtering only SAP1 frames and a reframer filtering only non-SAP1 frames between source and `flist` filter\n&quot;
<span class="lineNum">    2813 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2814 </span>            :                 &quot;Link options can be specified (see `gpac -h doc`).\n&quot;
<span class="lineNum">    2815 </span>            :                 &quot;EX src.mp4 @#video reframer:rt=on\n&quot;
<span class="lineNum">    2816 </span>            :                 &quot;This will inject a reframer with real-time regulation between video pid of source and `flist` filter.\n&quot;
<span class="lineNum">    2817 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2818 </span>            :                 &quot;When using filter chains, the `flist` filter will only accept PIDs from the last declared filter in the chain.\n&quot;
<span class="lineNum">    2819 </span>            :                 &quot;In order to accept other PIDs from the source, you must specify a final link directive with no following filter.\n&quot;
<span class="lineNum">    2820 </span>            :                 &quot;EX src.mp4 @#video reframer:rt=on @-1#audio\n&quot;
<span class="lineNum">    2821 </span>            :                 &quot;This will inject a reframer with real-time regulation between video pid of source and `flist` filter, and will also allow audio pids from source to connect to `flist` filter.\n&quot;
<span class="lineNum">    2822 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2823 </span>            :                 &quot;The empty link directive can also be used on the last declared filter\n&quot;
<span class="lineNum">    2824 </span>            :                 &quot;EX src.mp4 @ reframer:rt=on @#audio\n&quot;
<span class="lineNum">    2825 </span>            :                 &quot;This will inject a reframer with real-time regulation between source and `flist` filter and only connect audio pids to `flist` filter.\n&quot;
<span class="lineNum">    2826 </span>            :                 &quot;## Splicing\n&quot;
<span class="lineNum">    2827 </span>            :                 &quot;The playlist can be used to splice content with other content following a media in the playlist.\n&quot;
<span class="lineNum">    2828 </span>            :                 &quot;A source item is declared as main media in a splice operation if and only if it has an `out` directive set (possibly empty).\n&quot;
<span class="lineNum">    2829 </span>            :                 &quot;Directive can be used for the main media except concatenation directives.\n&quot;
<span class="lineNum">    2830 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2831 </span>            :                 &quot;The splicing operations do not alter media frames and do not perform uncompressed domain operations such as cross-fade or mixing.\n&quot;
<span class="lineNum">    2832 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2833 </span>            :                 &quot;The `out` (resp. `in`) directive specifies the media splice start (resp. end) time. The value can be formatted as follows:\n&quot;
<span class="lineNum">    2834 </span>            :                 &quot;- empty: the time is not yet assigned\n&quot;
<span class="lineNum">    2835 </span>            :                 &quot;- `now`: the time is resolved to the next SAP point in the media\n&quot;
<span class="lineNum">    2836 </span>            :                 &quot;- integer, float or fraction: set time in seconds\n&quot;
<span class="lineNum">    2837 </span>            :                 &quot;- `+VAL`: used for `in` only, specify the end point as delta in seconds from the start point (`VAL` can be integer, float or fraction)\n&quot;
<span class="lineNum">    2838 </span>            :                 &quot;- DATE: set splice time according to wall clock `DATE`, formatted as an `XSD dateTime`\n&quot;
<span class="lineNum">    2839 </span>            :                 &quot;The splice times (except wall clock) are expressed in the source (main media) timing, not the reconstructed output timeline.\n&quot;
<span class="lineNum">    2840 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2841 </span>            :                 &quot;When a splice begins (`out` time reached), the source items following the main media are played until the end of the splice or the end of the main media.\n&quot;
<span class="lineNum">    2842 </span>            :                 &quot;Sources used during the splice period can use directives such as `start`, `dur` or `repeat`.\n&quot;
<span class="lineNum">    2843 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2844 </span>            :                 &quot;Once a splice is done (`in` time reached), the main media `out` splice time is reset to undefined.\n&quot;
<span class="lineNum">    2845 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2846 </span>            :                 &quot;When the main media has undefined `out` or `in` splice times, the playlist is reloaded at each new main media packet to check for resolved values.\n&quot;
<span class="lineNum">    2847 </span>            :                 &quot;- `out` can only be modified when no splice is active, otherwise it is ignored. If modified, it resets the next source to play to be the one following the modified main media.\n&quot;
<span class="lineNum">    2848 </span>            :                 &quot;- `in` can only be modified when a splice is active with an undefined end time, otherwise it is ignored.\n&quot;
<span class="lineNum">    2849 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2850 </span>            :                 &quot;When the main media is over:\n&quot;
<span class="lineNum">    2851 </span>            :                 &quot;- if `repeat` directive is set, the main media is repeated, `in` and `out` set to their initial values and the next splicing content is the one following the main content,\n&quot;
<span class="lineNum">    2852 </span>            :                 &quot;- otherwise, the next source queued is the one following the last source played during the last splice period.\n&quot;
<span class="lineNum">    2853 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2854 </span>            :                 &quot;It is allowed to defined several main media in the playlist, but a main media is not allowed as media for a splice period.\n&quot;
<span class="lineNum">    2855 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2856 </span>            :                 &quot;The filter will look for the property `Period` on the output PIDs of the main media for multi-period DASH.\n&quot;
<span class="lineNum">    2857 </span>            :                 &quot;If found, `_N` is appended to the period ID, with `N` starting from 1 and increased at each main media resume.\n&quot;
<span class="lineNum">    2858 </span>            :                 &quot;If no `Period` property is set on main or spliced media, period switch can still be forced using [-pswitch](dasher) DASH option.\n&quot;
<span class="lineNum">    2859 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2860 </span>            :                 &quot;If `mark` directive is set for a main media, no content replacement is done and the splice boundaries will be signaled in the main media.\n&quot;
<span class="lineNum">    2861 </span>            :                 &quot;If `keep` directive is set for a main media, the main media is forwarded along with the replacement content.\n&quot;
<span class="lineNum">    2862 </span>            :                 &quot;When `mark` or `keep` directives are set, it is possible to alter the PID properties of the main media using `sprops` directive.\n&quot;
<span class="lineNum">    2863 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2864 </span>            :                 &quot;EX #out=2 in=4 mark sprops=#xlink=http://foo.bar/\nEX src:#Period=main\n&quot;
<span class="lineNum">    2865 </span>            :                 &quot;This will inject property xlink on the output pids in the splice zone (corresponding to period `main_2`) but not in the rest of the main media.\n&quot;
<span class="lineNum">    2866 </span>            :                 &quot;\n&quot;
<span class="lineNum">    2867 </span>            :                 &quot;Directives `mark`, `keep` and `sprops` are reset at the end of the splice period.\n&quot;
<span class="lineNum">    2868 </span>            :                 )
<span class="lineNum">    2869 </span>            :         .private_size = sizeof(GF_FileListCtx),
<span class="lineNum">    2870 </span>            :         .max_extra_pids = -1,
<span class="lineNum">    2871 </span>            :         .flags = GF_FS_REG_ACT_AS_SOURCE | GF_FS_REG_REQUIRES_RESOLVER,
<span class="lineNum">    2872 </span>            :         .args = GF_FileListArgs,
<span class="lineNum">    2873 </span>            :         .initialize = filelist_initialize,
<span class="lineNum">    2874 </span>            :         .finalize = filelist_finalize,
<span class="lineNum">    2875 </span>            :         SETCAPS(FileListCaps),
<span class="lineNum">    2876 </span>            :         .configure_pid = filelist_configure_pid,
<span class="lineNum">    2877 </span>            :         .process = filelist_process,
<span class="lineNum">    2878 </span>            :         .process_event = filelist_process_event,
<span class="lineNum">    2879 </span>            :         .probe_data = filelist_probe_data
<a name="2880"><span class="lineNum">    2880 </span>            : };</a>
<span class="lineNum">    2881 </span>            : 
<span class="lineNum">    2882 </span><span class="lineCov">       2877 : const GF_FilterRegister *filelist_register(GF_FilterSession *session)</span>
<span class="lineNum">    2883 </span>            : {
<span class="lineNum">    2884 </span><span class="lineCov">       2877 :         return &amp;FileListRegister;</span>
<span class="lineNum">    2885 </span>            : }
<span class="lineNum">    2886 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

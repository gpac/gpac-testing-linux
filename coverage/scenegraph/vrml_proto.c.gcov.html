<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - scenegraph/vrml_proto.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">scenegraph</a> - vrml_proto.c<span style="font-size: 80%;"> (source / <a href="vrml_proto.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">503</td>
            <td class="headerCovTableEntry">644</td>
            <td class="headerCovTableEntryMed">78.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-29 23:48:07</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">34</td>
            <td class="headerCovTableEntry">38</td>
            <td class="headerCovTableEntryMed">89.5 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2000-2012
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / Scene Graph sub-project
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : #include &lt;gpac/internal/scenegraph_dev.h&gt;
<span class="lineNum">      28 </span>            : /*MPEG4 &amp; X3D tags (for node tables &amp; script handling)*/
<span class="lineNum">      29 </span>            : #include &lt;gpac/nodes_mpeg4.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;gpac/nodes_x3d.h&gt;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : #ifndef GPAC_DISABLE_VRML
<a name="33"><span class="lineNum">      33 </span>            : </a>
<span class="lineNum">      34 </span>            : GF_EXPORT
<span class="lineNum">      35 </span><span class="lineCov">        159 : GF_Proto *gf_sg_proto_new(GF_SceneGraph *inScene, u32 ProtoID, char *name, Bool unregistered)</span>
<span class="lineNum">      36 </span>            : {
<span class="lineNum">      37 </span>            :         GF_Proto *tmp;
<span class="lineNum">      38 </span><span class="lineCov">        159 :         if (!inScene) return NULL;</span>
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            :         /*make sure we don't define a proto already defined in this scope*/
<span class="lineNum">      41 </span><span class="lineCov">        159 :         if (!unregistered) {</span>
<span class="lineNum">      42 </span><span class="lineCov">         17 :                 tmp = gf_sg_find_proto(inScene, ProtoID, name);</span>
<span class="lineNum">      43 </span><span class="lineCov">         17 :                 if (tmp) {</span>
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_SCENE, (&quot;[Scenegraph] PROTO %s redefined - skipping loading\n&quot;, name));</span>
<span class="lineNum">      45 </span>            :                         return NULL;
<span class="lineNum">      46 </span>            :                 }
<span class="lineNum">      47 </span>            :         }
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span><span class="lineCov">        159 :         GF_SAFEALLOC(tmp, GF_Proto)</span>
<span class="lineNum">      50 </span><span class="lineCov">        159 :         if (!tmp) return NULL;</span>
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span><span class="lineCov">        159 :         tmp-&gt;proto_fields = gf_list_new();</span>
<span class="lineNum">      53 </span><span class="lineCov">        159 :         tmp-&gt;node_code = gf_list_new();</span>
<span class="lineNum">      54 </span><span class="lineCov">        159 :         tmp-&gt;parent_graph = inScene;</span>
<span class="lineNum">      55 </span><span class="lineCov">        159 :         tmp-&gt;sub_graph = gf_sg_new_subscene(inScene);</span>
<span class="lineNum">      56 </span><span class="lineCov">        159 :         tmp-&gt;instances = gf_list_new();</span>
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span><span class="lineCov">        159 :         if (name)</span>
<span class="lineNum">      59 </span><span class="lineCov">        159 :                 tmp-&gt;Name = gf_strdup(name);</span>
<span class="lineNum">      60 </span>            :         else
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :                 tmp-&gt;Name = gf_strdup(&quot;Unnamed Proto&quot;);</span>
<span class="lineNum">      62 </span><span class="lineCov">        159 :         tmp-&gt;ID = ProtoID;</span>
<span class="lineNum">      63 </span><span class="lineCov">        159 :         if (!unregistered) {</span>
<span class="lineNum">      64 </span><span class="lineCov">         17 :                 gf_list_add(inScene-&gt;protos, tmp);</span>
<span class="lineNum">      65 </span>            :         } else {
<span class="lineNum">      66 </span><span class="lineCov">        142 :                 gf_list_add(inScene-&gt;unregistered_protos, tmp);</span>
<span class="lineNum">      67 </span>            :         }
<span class="lineNum">      68 </span>            :         return tmp;
<span class="lineNum">      69 </span>            : }
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            : #if 0
<span class="lineNum">      72 </span>            : /*used for memory handling of scene graph only. move proto from off-graph to in-graph or reverse*/
<span class="lineNum">      73 </span>            : GF_Err gf_sg_proto_set_in_graph(GF_Proto *proto, GF_SceneGraph *inScene, Bool set_in)
<span class="lineNum">      74 </span>            : {
<span class="lineNum">      75 </span>            :         u32 i;
<span class="lineNum">      76 </span>            :         GF_Proto *tmp;
<span class="lineNum">      77 </span>            :         GF_List *removeFrom;
<span class="lineNum">      78 </span>            :         GF_List *insertIn;
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span>            :         if (set_in) {
<span class="lineNum">      81 </span>            :                 removeFrom = proto-&gt;parent_graph-&gt;unregistered_protos;
<span class="lineNum">      82 </span>            :                 insertIn = proto-&gt;parent_graph-&gt;protos;
<span class="lineNum">      83 </span>            :         } else {
<span class="lineNum">      84 </span>            :                 insertIn = proto-&gt;parent_graph-&gt;unregistered_protos;
<span class="lineNum">      85 </span>            :                 removeFrom = proto-&gt;parent_graph-&gt;protos;
<span class="lineNum">      86 </span>            :         }
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            :         gf_list_del_item(removeFrom, proto);
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            :         i=0;
<span class="lineNum">      91 </span>            :         while ((tmp = (GF_Proto*)gf_list_enum(insertIn, &amp;i))) {
<span class="lineNum">      92 </span>            :                 if (tmp==proto) return GF_OK;
<span class="lineNum">      93 </span>            :                 if (!set_in) continue;
<span class="lineNum">      94 </span>            :                 /*if registering, make sure no other proto has the same ID/name*/
<span class="lineNum">      95 </span>            :                 if (tmp-&gt;ID==proto-&gt;ID) return GF_BAD_PARAM;
<span class="lineNum">      96 </span>            :                 if (!stricmp(tmp-&gt;Name, proto-&gt;Name)) return GF_BAD_PARAM;
<span class="lineNum">      97 </span>            :         }
<span class="lineNum">      98 </span>            :         return gf_list_add(insertIn, proto);
<span class="lineNum">      99 </span>            : }
<span class="lineNum">     100 </span>            : #endif
<a name="101"><span class="lineNum">     101 </span>            : </a>
<span class="lineNum">     102 </span>            : GF_EXPORT
<span class="lineNum">     103 </span><span class="lineCov">        159 : GF_Err gf_sg_proto_del(GF_Proto *proto)</span>
<span class="lineNum">     104 </span>            : {
<span class="lineNum">     105 </span>            :         s32 i;
<span class="lineNum">     106 </span>            : 
<span class="lineNum">     107 </span><span class="lineCov">        159 :         if (!proto) return GF_OK;</span>
<span class="lineNum">     108 </span><span class="lineCov">        159 :         i = gf_list_del_item(proto-&gt;parent_graph-&gt;protos, proto);</span>
<span class="lineNum">     109 </span><span class="lineCov">        159 :         if (i&lt;0) {</span>
<span class="lineNum">     110 </span><span class="lineCov">         77 :                 gf_list_del_item(proto-&gt;parent_graph-&gt;unregistered_protos, proto);</span>
<span class="lineNum">     111 </span>            :         }
<span class="lineNum">     112 </span><span class="lineCov">        159 :         if (proto-&gt;userpriv &amp;&amp; proto-&gt;OnDelete) proto-&gt;OnDelete(proto-&gt;userpriv);</span>
<span class="lineNum">     113 </span>            : 
<span class="lineNum">     114 </span>            :         /*first destroy the code*/
<span class="lineNum">     115 </span><span class="lineCov">        344 :         while (gf_list_count(proto-&gt;node_code)) {</span>
<span class="lineNum">     116 </span><span class="lineCov">        185 :                 GF_Node *node = (GF_Node*)gf_list_get(proto-&gt;node_code, 0);</span>
<span class="lineNum">     117 </span><span class="lineCov">        185 :                 gf_node_unregister(node, NULL);</span>
<span class="lineNum">     118 </span><span class="lineCov">        185 :                 gf_list_rem(proto-&gt;node_code, 0);</span>
<span class="lineNum">     119 </span>            :         }
<span class="lineNum">     120 </span><span class="lineCov">        159 :         gf_list_del(proto-&gt;node_code);</span>
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span>            :         /*delete interface*/
<span class="lineNum">     123 </span><span class="lineCov">       1260 :         while (gf_list_count(proto-&gt;proto_fields)) {</span>
<span class="lineNum">     124 </span><span class="lineCov">        942 :                 GF_ProtoFieldInterface *field = (GF_ProtoFieldInterface*)gf_list_get(proto-&gt;proto_fields, 0);</span>
<span class="lineNum">     125 </span><span class="lineCov">        942 :                 if (field-&gt;userpriv &amp;&amp; field-&gt;OnDelete) field-&gt;OnDelete(field-&gt;userpriv);</span>
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span><span class="lineCov">        942 :                 if (field-&gt;FieldType==GF_SG_VRML_SFNODE) {</span>
<span class="lineNum">     128 </span><span class="lineCov">         97 :                         if (field-&gt;def_sfnode_value)</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :                                 gf_node_unregister(field-&gt;def_sfnode_value, NULL);</span>
<span class="lineNum">     130 </span>            :                 }
<span class="lineNum">     131 </span><span class="lineCov">        845 :                 else if (field-&gt;FieldType==GF_SG_VRML_MFNODE) {</span>
<span class="lineNum">     132 </span><span class="lineCov">         15 :                         if (field-&gt;def_mfnode_value)</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :                                 gf_node_unregister_children(NULL, field-&gt;def_mfnode_value);</span>
<span class="lineNum">     134 </span>            :                 }
<span class="lineNum">     135 </span><span class="lineCov">        830 :                 else if (field-&gt;def_value)</span>
<span class="lineNum">     136 </span><span class="lineCov">        830 :                         gf_sg_vrml_field_pointer_del(field-&gt;def_value, field-&gt;FieldType);</span>
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span><span class="lineCov">        942 :                 if (field-&gt;FieldName) gf_free(field-&gt;FieldName);</span>
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span>            :                 /*QP fields are SF fields, we can safely gf_free() them*/
<span class="lineNum">     141 </span><span class="lineCov">        942 :                 if (field-&gt;qp_max_value) gf_free(field-&gt;qp_max_value);</span>
<span class="lineNum">     142 </span><span class="lineCov">        942 :                 if (field-&gt;qp_min_value) gf_free(field-&gt;qp_min_value);</span>
<span class="lineNum">     143 </span><span class="lineCov">        942 :                 gf_free(field);</span>
<span class="lineNum">     144 </span><span class="lineCov">        942 :                 gf_list_rem(proto-&gt;proto_fields, 0);</span>
<span class="lineNum">     145 </span>            :         }
<span class="lineNum">     146 </span><span class="lineCov">        159 :         gf_list_del(proto-&gt;proto_fields);</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineCov">        437 :         while (gf_list_count(proto-&gt;instances)) {</span>
<span class="lineNum">     149 </span><span class="lineCov">        119 :                 GF_ProtoInstance *p = (GF_ProtoInstance *)gf_list_get(proto-&gt;instances, 0);</span>
<span class="lineNum">     150 </span><span class="lineCov">        119 :                 gf_list_rem(proto-&gt;instances, 0);</span>
<span class="lineNum">     151 </span><span class="lineCov">        119 :                 p-&gt;proto_interface = NULL;</span>
<span class="lineNum">     152 </span>            :         }
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span>            :         /*delete sub graph*/
<span class="lineNum">     155 </span><span class="lineCov">        159 :         gf_sg_del(proto-&gt;sub_graph);</span>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span><span class="lineCov">        159 :         if (proto-&gt;Name) gf_free(proto-&gt;Name);</span>
<span class="lineNum">     159 </span><span class="lineCov">        159 :         gf_sg_mfurl_del(proto-&gt;ExternProto);</span>
<span class="lineNum">     160 </span><span class="lineCov">        159 :         gf_list_del(proto-&gt;instances);</span>
<span class="lineNum">     161 </span><span class="lineCov">        159 :         gf_free(proto);</span>
<span class="lineNum">     162 </span><span class="lineCov">        159 :         return GF_OK;</span>
<span class="lineNum">     163 </span>            : }
<a name="164"><span class="lineNum">     164 </span>            : </a>
<span class="lineNum">     165 </span>            : GF_EXPORT
<span class="lineNum">     166 </span><span class="lineCov">        232 : GF_SceneGraph *gf_sg_proto_get_graph(GF_Proto *proto)</span>
<span class="lineNum">     167 </span>            : {
<span class="lineNum">     168 </span><span class="lineCov">        232 :         return proto ? proto-&gt;sub_graph : NULL;</span>
<span class="lineNum">     169 </span>            : }
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span>            : #if 0
<span class="lineNum">     173 </span>            : void gf_sg_proto_set_private(GF_Proto *p, void *ptr, void (*OnDelete)(void *ptr) )
<span class="lineNum">     174 </span>            : {
<span class="lineNum">     175 </span>            :         if (p) {
<span class="lineNum">     176 </span>            :                 p-&gt;userpriv = ptr;
<span class="lineNum">     177 </span>            :                 p-&gt;OnDelete = OnDelete;
<span class="lineNum">     178 </span>            :         }
<span class="lineNum">     179 </span>            : }
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span>            : void *gf_sg_proto_get_private(GF_Proto *p)
<span class="lineNum">     182 </span>            : {
<span class="lineNum">     183 </span>            :         return p ? p-&gt;userpriv : NULL;
<span class="lineNum">     184 </span>            : }
<span class="lineNum">     185 </span>            : #endif
<a name="186"><span class="lineNum">     186 </span>            : </a>
<span class="lineNum">     187 </span>            : GF_EXPORT
<span class="lineNum">     188 </span><span class="lineCov">        679 : MFURL *gf_sg_proto_get_extern_url(GF_Proto *proto)</span>
<span class="lineNum">     189 </span>            : {
<span class="lineNum">     190 </span><span class="lineCov">        679 :         return proto ? &amp;proto-&gt;ExternProto : NULL;</span>
<span class="lineNum">     191 </span>            : }
<a name="192"><span class="lineNum">     192 </span>            : </a>
<span class="lineNum">     193 </span>            : GF_EXPORT
<span class="lineNum">     194 </span><span class="lineCov">        185 : GF_Err gf_sg_proto_add_node_code(GF_Proto *proto, GF_Node *pNode)</span>
<span class="lineNum">     195 </span>            : {
<span class="lineNum">     196 </span><span class="lineCov">        185 :         if (!proto) return GF_BAD_PARAM;</span>
<span class="lineNum">     197 </span><span class="lineCov">        185 :         return gf_list_add(proto-&gt;node_code, pNode);</span>
<span class="lineNum">     198 </span>            : }
<a name="199"><span class="lineNum">     199 </span>            : </a>
<span class="lineNum">     200 </span>            : GF_EXPORT
<span class="lineNum">     201 </span><span class="lineCov">       1313 : GF_ProtoFieldInterface *gf_sg_proto_field_find_by_name(GF_Proto *proto, char *fieldName)</span>
<span class="lineNum">     202 </span>            : {
<span class="lineNum">     203 </span>            :         GF_ProtoFieldInterface *ptr;
<span class="lineNum">     204 </span><span class="lineCov">       1313 :         u32 i=0;</span>
<span class="lineNum">     205 </span><span class="lineCov">       7601 :         while ((ptr = (GF_ProtoFieldInterface*)gf_list_enum(proto-&gt;proto_fields, &amp;i))) {</span>
<span class="lineNum">     206 </span><span class="lineCov">       5346 :                 if (ptr-&gt;FieldName &amp;&amp; !strcmp(ptr-&gt;FieldName, fieldName)) return ptr;</span>
<span class="lineNum">     207 </span>            :         }
<span class="lineNum">     208 </span>            :         return NULL;
<span class="lineNum">     209 </span>            : }
<a name="210"><span class="lineNum">     210 </span>            : </a>
<span class="lineNum">     211 </span>            : GF_EXPORT
<span class="lineNum">     212 </span><span class="lineCov">        942 : GF_ProtoFieldInterface *gf_sg_proto_field_new(GF_Proto *proto, u32 fieldType, u32 eventType, char *fieldName)</span>
<span class="lineNum">     213 </span>            : {
<span class="lineNum">     214 </span>            :         GF_ProtoFieldInterface *tmp;
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span><span class="lineCov">        942 :         if (fieldName) {</span>
<span class="lineNum">     217 </span><span class="lineCov">        942 :                 tmp = gf_sg_proto_field_find_by_name(proto, fieldName);</span>
<span class="lineNum">     218 </span><span class="lineCov">        942 :                 if (tmp) return NULL;</span>
<span class="lineNum">     219 </span>            :         }
<span class="lineNum">     220 </span><span class="lineCov">        942 :         GF_SAFEALLOC(tmp, GF_ProtoFieldInterface)</span>
<span class="lineNum">     221 </span><span class="lineCov">        942 :         if (!tmp) return NULL;</span>
<span class="lineNum">     222 </span>            : 
<span class="lineNum">     223 </span><span class="lineCov">        942 :         tmp-&gt;FieldType = fieldType;</span>
<span class="lineNum">     224 </span><span class="lineCov">        942 :         tmp-&gt;EventType = eventType;</span>
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span>            :         /*create container - can be NULL if SF node*/
<span class="lineNum">     227 </span><span class="lineCov">        942 :         if ( fieldType == GF_SG_VRML_SFNODE) {</span>
<span class="lineNum">     228 </span><span class="lineCov">         97 :                 tmp-&gt;def_sfnode_value = NULL;</span>
<span class="lineNum">     229 </span><span class="lineCov">         97 :                 tmp-&gt;def_value = &amp;tmp-&gt;def_sfnode_value;</span>
<span class="lineNum">     230 </span><span class="lineCov">        845 :         } else if ( fieldType == GF_SG_VRML_MFNODE) {</span>
<span class="lineNum">     231 </span><span class="lineCov">         15 :                 tmp-&gt;def_mfnode_value = NULL;</span>
<span class="lineNum">     232 </span><span class="lineCov">         15 :                 tmp-&gt;def_value = &amp;tmp-&gt;def_mfnode_value;</span>
<span class="lineNum">     233 </span>            :         } else {
<span class="lineNum">     234 </span><span class="lineCov">        830 :                 tmp-&gt;def_value = gf_sg_vrml_field_pointer_new(fieldType);</span>
<span class="lineNum">     235 </span>            :         }
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span><span class="lineCov">        942 :         if (fieldName) tmp-&gt;FieldName = gf_strdup(fieldName);</span>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineCov">        942 :         tmp-&gt;ALL_index = gf_list_count(proto-&gt;proto_fields);</span>
<span class="lineNum">     240 </span><span class="lineCov">        942 :         tmp-&gt;OUT_index = tmp-&gt;DEF_index = tmp-&gt;IN_index = (u32) -1;</span>
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span><span class="lineCov">        942 :         switch (eventType) {</span>
<span class="lineNum">     243 </span><span class="lineCov">        868 :         case GF_SG_EVENT_EXPOSED_FIELD:</span>
<span class="lineNum">     244 </span><span class="lineCov">        868 :                 tmp-&gt;IN_index = proto-&gt;NumIn;</span>
<span class="lineNum">     245 </span><span class="lineCov">        868 :                 proto-&gt;NumIn ++;</span>
<span class="lineNum">     246 </span><span class="lineCov">        868 :                 tmp-&gt;OUT_index = proto-&gt;NumOut;</span>
<span class="lineNum">     247 </span><span class="lineCov">        868 :                 proto-&gt;NumOut ++;</span>
<span class="lineNum">     248 </span><span class="lineCov">        870 :         case GF_SG_EVENT_FIELD:</span>
<span class="lineNum">     249 </span><span class="lineCov">        870 :                 tmp-&gt;DEF_index = proto-&gt;NumDef;</span>
<span class="lineNum">     250 </span><span class="lineCov">        870 :                 proto-&gt;NumDef ++;</span>
<span class="lineNum">     251 </span><span class="lineCov">        870 :                 break;</span>
<span class="lineNum">     252 </span><span class="lineCov">         63 :         case GF_SG_EVENT_IN:</span>
<span class="lineNum">     253 </span><span class="lineCov">         63 :                 tmp-&gt;IN_index = proto-&gt;NumIn;</span>
<span class="lineNum">     254 </span><span class="lineCov">         63 :                 proto-&gt;NumIn ++;</span>
<span class="lineNum">     255 </span><span class="lineCov">         63 :                 break;</span>
<span class="lineNum">     256 </span><span class="lineCov">          9 :         case GF_SG_EVENT_OUT:</span>
<span class="lineNum">     257 </span><span class="lineCov">          9 :                 tmp-&gt;OUT_index = proto-&gt;NumOut;</span>
<span class="lineNum">     258 </span><span class="lineCov">          9 :                 proto-&gt;NumOut ++;</span>
<span class="lineNum">     259 </span><span class="lineCov">          9 :                 break;</span>
<span class="lineNum">     260 </span>            :         }
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span><span class="lineCov">        942 :         gf_list_add(proto-&gt;proto_fields, tmp);</span>
<span class="lineNum">     263 </span><span class="lineCov">        942 :         return tmp;</span>
<span class="lineNum">     264 </span>            : }
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span>            : #if 0 //unused
<span class="lineNum">     267 </span>            : void gf_sg_proto_field_set_private(GF_ProtoFieldInterface *field, void *ptr, void (*OnDelete)(void *ptr))
<span class="lineNum">     268 </span>            : {
<span class="lineNum">     269 </span>            :         if (field) {
<span class="lineNum">     270 </span>            :                 field-&gt;userpriv = ptr;
<span class="lineNum">     271 </span>            :                 field-&gt;OnDelete = OnDelete;
<span class="lineNum">     272 </span>            :         }
<span class="lineNum">     273 </span>            : }
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span>            : void *gf_sg_proto_field_get_private(GF_ProtoFieldInterface *field)
<span class="lineNum">     276 </span>            : {
<span class="lineNum">     277 </span>            :         return field ? field-&gt;userpriv : NULL;
<span class="lineNum">     278 </span>            : }
<span class="lineNum">     279 </span>            : #endif
<a name="280"><span class="lineNum">     280 </span>            : </a>
<span class="lineNum">     281 </span>            : GF_EXPORT
<span class="lineNum">     282 </span><span class="lineCov">       1981 : GF_Err gf_sg_proto_field_get_field(GF_ProtoFieldInterface *field, GF_FieldInfo *info)</span>
<span class="lineNum">     283 </span>            : {
<span class="lineNum">     284 </span><span class="lineCov">       1981 :         if (!field || !info) return GF_BAD_PARAM;</span>
<span class="lineNum">     285 </span>            :         memset(info, 0, sizeof(GF_FieldInfo));
<span class="lineNum">     286 </span><span class="lineCov">       1981 :         info-&gt;fieldIndex = field-&gt;ALL_index;</span>
<span class="lineNum">     287 </span><span class="lineCov">       1981 :         info-&gt;fieldType = field-&gt;FieldType;</span>
<span class="lineNum">     288 </span><span class="lineCov">       1981 :         info-&gt;eventType = field-&gt;EventType;</span>
<span class="lineNum">     289 </span><span class="lineCov">       1981 :         info-&gt;far_ptr = field-&gt;def_value;</span>
<span class="lineNum">     290 </span><span class="lineCov">       1981 :         info-&gt;name = field-&gt;FieldName;</span>
<span class="lineNum">     291 </span><span class="lineCov">       1981 :         info-&gt;NDTtype = NDT_SFWorldNode;</span>
<span class="lineNum">     292 </span><span class="lineCov">       1981 :         return GF_OK;</span>
<a name="293"><span class="lineNum">     293 </span>            : }</a>
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span><span class="lineCov">      46686 : GF_Err gf_sg_proto_get_field(GF_Proto *proto, GF_Node *node, GF_FieldInfo *info)</span>
<span class="lineNum">     296 </span>            : {
<span class="lineNum">     297 </span>            :         GF_ProtoFieldInterface *proto_field;
<span class="lineNum">     298 </span>            :         GF_ProtoInstance *inst;
<span class="lineNum">     299 </span>            :         GF_ProtoField *field;
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span><span class="lineCov">      46686 :         if (!proto &amp;&amp; !node) return GF_BAD_PARAM;</span>
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span><span class="lineCov">      46686 :         if (proto) {</span>
<span class="lineNum">     304 </span><span class="lineCov">        651 :                 proto_field = (GF_ProtoFieldInterface*)gf_list_get(proto-&gt;proto_fields, info-&gt;fieldIndex);</span>
<span class="lineNum">     305 </span><span class="lineCov">        651 :                 if (!proto_field) return GF_BAD_PARAM;</span>
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineCov">        651 :                 info-&gt;fieldType = proto_field-&gt;FieldType;</span>
<span class="lineNum">     308 </span><span class="lineCov">        651 :                 info-&gt;eventType = proto_field-&gt;EventType;</span>
<span class="lineNum">     309 </span><span class="lineCov">        651 :                 info-&gt;fieldIndex = proto_field-&gt;ALL_index;</span>
<span class="lineNum">     310 </span><span class="lineCov">        651 :                 info-&gt;NDTtype = NDT_SFWorldNode;</span>
<span class="lineNum">     311 </span><span class="lineCov">        651 :                 info-&gt;far_ptr = proto_field-&gt;def_value;</span>
<span class="lineNum">     312 </span><span class="lineCov">        651 :                 info-&gt;name = proto_field-&gt;FieldName;</span>
<span class="lineNum">     313 </span><span class="lineCov">        651 :                 return GF_OK;</span>
<span class="lineNum">     314 </span>            :         }
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span>            :         /*otherwise this is an instantiated proto*/
<span class="lineNum">     317 </span><span class="lineCov">      46035 :         if (node-&gt;sgprivate-&gt;tag!=TAG_ProtoNode) return GF_BAD_PARAM;</span>
<span class="lineNum">     318 </span>            : 
<span class="lineNum">     319 </span>            :         inst = (GF_ProtoInstance *) node;
<span class="lineNum">     320 </span><span class="lineCov">      46035 :         field = (GF_ProtoField*)gf_list_get(inst-&gt;fields, info-&gt;fieldIndex);</span>
<span class="lineNum">     321 </span><span class="lineCov">      46035 :         if (!field) return GF_BAD_PARAM;</span>
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span><span class="lineCov">      46035 :         info-&gt;fieldType = field-&gt;FieldType;</span>
<span class="lineNum">     324 </span><span class="lineCov">      46035 :         info-&gt;eventType = field-&gt;EventType;</span>
<span class="lineNum">     325 </span><span class="lineCov">      46035 :         info-&gt;on_event_in = field-&gt;on_event_in;</span>
<span class="lineNum">     326 </span>            :         /*SF/MF nodes need pointers to field object - cf gf_sg_proto_create_node*/
<span class="lineNum">     327 </span><span class="lineCov">      46035 :         if (gf_sg_vrml_get_sf_type(field-&gt;FieldType) == GF_SG_VRML_SFNODE) {</span>
<span class="lineNum">     328 </span><span class="lineCov">       4469 :                 info-&gt;far_ptr = &amp;field-&gt;field_pointer;</span>
<span class="lineNum">     329 </span>            :         } else {
<span class="lineNum">     330 </span><span class="lineCov">      41566 :                 info-&gt;far_ptr = field-&gt;field_pointer;</span>
<span class="lineNum">     331 </span>            :         }
<span class="lineNum">     332 </span>            :         /*set the name - watchout for deletion case*/
<span class="lineNum">     333 </span><span class="lineCov">      46035 :         if (inst-&gt;proto_interface) {</span>
<span class="lineNum">     334 </span><span class="lineCov">      45978 :                 proto_field = (GF_ProtoFieldInterface*)gf_list_get(inst-&gt;proto_interface-&gt;proto_fields, info-&gt;fieldIndex);</span>
<span class="lineNum">     335 </span><span class="lineCov">      45978 :                 info-&gt;name = proto_field-&gt;FieldName;</span>
<span class="lineNum">     336 </span>            :         } else {
<span class="lineNum">     337 </span><span class="lineCov">         57 :                 info-&gt;name = &quot;ProtoFieldDeleted&quot;;</span>
<span class="lineNum">     338 </span>            :         }
<span class="lineNum">     339 </span><span class="lineCov">      46035 :         info-&gt;NDTtype = NDT_SFWorldNode;</span>
<span class="lineNum">     340 </span><span class="lineCov">      46035 :         return GF_OK;</span>
<a name="341"><span class="lineNum">     341 </span>            : }</a>
<span class="lineNum">     342 </span>            : 
<span class="lineNum">     343 </span><span class="lineCov">      24847 : s32 gf_sg_proto_get_field_index_by_name(GF_Proto *proto, GF_Node *node, char *name)</span>
<span class="lineNum">     344 </span>            : {
<span class="lineNum">     345 </span>            :         u32 i;
<span class="lineNum">     346 </span>            :         GF_Proto *__proto=NULL;
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span><span class="lineCov">      24847 :         if (!node &amp;&amp; !proto) return -1;</span>
<span class="lineNum">     349 </span><span class="lineCov">      24847 :         if (node &amp;&amp; (node-&gt;sgprivate-&gt;tag!=TAG_ProtoNode)) return -1;</span>
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span><span class="lineCov">      24847 :         if (proto)</span>
<span class="lineNum">     352 </span>            :                 __proto = proto;
<span class="lineNum">     353 </span><span class="lineCov">      24847 :         else if (node)</span>
<span class="lineNum">     354 </span><span class="lineCov">      24847 :                 __proto = ((GF_ProtoInstance *) node)-&gt;proto_interface;</span>
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineCov">      24847 :         if (!__proto ) return -1;</span>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span><span class="lineCov">     150341 :         for (i=0; i&lt;gf_list_count(__proto-&gt;proto_fields); i++) {</span>
<span class="lineNum">     359 </span><span class="lineCov">     174966 :                 GF_ProtoFieldInterface *proto_field = (GF_ProtoFieldInterface*)gf_list_get(__proto-&gt;proto_fields, i);</span>
<span class="lineNum">     360 </span><span class="lineCov">     174966 :                 if (proto_field-&gt;FieldName &amp;&amp; !strcmp(proto_field-&gt;FieldName, name)) return i;</span>
<span class="lineNum">     361 </span>            :         }
<span class="lineNum">     362 </span>            :         return -1;
<span class="lineNum">     363 </span>            : }
<a name="364"><span class="lineNum">     364 </span>            : </a>
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span><span class="lineCov">      13514 : GF_Node *gf_vrml_node_clone(GF_SceneGraph *inScene, GF_Node *orig, GF_Node *cloned_parent, char *inst_id_suffix)</span>
<span class="lineNum">     367 </span>            : {
<span class="lineNum">     368 </span>            :         u32 i, count, id;
<span class="lineNum">     369 </span>            :         char *szNodeName;
<span class="lineNum">     370 </span>            :         Bool is_script;
<span class="lineNum">     371 </span>            :         GF_Node *node, *child;
<span class="lineNum">     372 </span>            :         GF_ChildNodeItem *list, *last;
<span class="lineNum">     373 </span>            :         GF_Route *r1;
<span class="lineNum">     374 </span>            : #ifndef GPAC_DISABLE_BIFS
<span class="lineNum">     375 </span>            :         void BIFS_SetupConditionalClone(GF_Node *node, GF_Node *orig);
<span class="lineNum">     376 </span>            : #endif
<span class="lineNum">     377 </span>            :         GF_ProtoInstance *proto;
<span class="lineNum">     378 </span>            :         GF_FieldInfo field_orig, field;
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span>            :         /*this is not a mistake*/
<span class="lineNum">     381 </span><span class="lineCov">      13514 :         if (!orig) return NULL;</span>
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span>            :         /*check for DEF/USE*/
<span class="lineNum">     384 </span>            :         szNodeName = NULL;
<span class="lineNum">     385 </span><span class="lineCov">      13514 :         if (!inst_id_suffix) id = 0;</span>
<span class="lineNum">     386 </span>            :         else {
<span class="lineNum">     387 </span><span class="lineCov">      13514 :                 const char *orig_name = gf_node_get_name_and_id(orig, &amp;id);</span>
<span class="lineNum">     388 </span>            :                 /*generate clone IDs based on original one*/
<span class="lineNum">     389 </span><span class="lineCov">      13514 :                 if (inst_id_suffix[0] &amp;&amp; id) {</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :                         id = gf_sg_get_next_available_node_id(inScene);</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                         if (orig_name) {</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                                 szNodeName = gf_malloc(sizeof(char)*(strlen(orig_name)+strlen(inst_id_suffix)+1));</span>
<span class="lineNum">     393 </span>            :                                 strcpy(szNodeName, orig_name);
<span class="lineNum">     394 </span>            :                                 strcat(szNodeName, inst_id_suffix);
<span class="lineNum">     395 </span>            :                         }
<span class="lineNum">     396 </span>            :                 }
<span class="lineNum">     397 </span><span class="lineCov">      13514 :                 else if (orig_name) szNodeName = gf_strdup(orig_name);</span>
<span class="lineNum">     398 </span>            :         }
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span><span class="lineCov">      13514 :         if (id) {</span>
<span class="lineNum">     401 </span><span class="lineCov">       5717 :                 node = szNodeName ? gf_sg_find_node_by_name(inScene, szNodeName) : gf_sg_find_node(inScene, id);</span>
<span class="lineNum">     402 </span>            :                 /*node already created, USE*/
<span class="lineNum">     403 </span><span class="lineCov">       5717 :                 if (node) {</span>
<span class="lineNum">     404 </span><span class="lineCov">       1430 :                         gf_node_register(node, cloned_parent);</span>
<span class="lineNum">     405 </span><span class="lineCov">       1430 :                         if (szNodeName) gf_free(szNodeName);</span>
<span class="lineNum">     406 </span>            :                         return node;
<span class="lineNum">     407 </span>            :                 }
<span class="lineNum">     408 </span>            :         }
<span class="lineNum">     409 </span>            :         /*create a node*/
<span class="lineNum">     410 </span><span class="lineCov">      12084 :         if (orig-&gt;sgprivate-&gt;tag == TAG_ProtoNode) {</span>
<span class="lineNum">     411 </span><span class="lineCov">        366 :                 GF_Proto *proto_node = ((GF_ProtoInstance *)orig)-&gt;proto_interface;</span>
<span class="lineNum">     412 </span>            :                 /*create the instance but don't load the code -c we MUST wait for ISed routes to be cloned before*/
<span class="lineNum">     413 </span><span class="lineCov">        366 :                 node = gf_sg_proto_create_node(inScene, proto_node, (GF_ProtoInstance *) orig);</span>
<span class="lineNum">     414 </span>            :         } else {
<span class="lineNum">     415 </span><span class="lineCov">      11718 :                 node = gf_node_new(inScene, orig-&gt;sgprivate-&gt;tag);</span>
<span class="lineNum">     416 </span>            :         }
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span><span class="lineCov">      12084 :         count = gf_node_get_field_count(orig);</span>
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span>            :         is_script = 0;
<span class="lineNum">     421 </span><span class="lineCov">      12084 :         if (orig-&gt;sgprivate-&gt;tag==TAG_MPEG4_Script) is_script = 1;</span>
<span class="lineNum">     422 </span>            : #ifndef GPAC_DISABLE_X3D
<span class="lineNum">     423 </span><span class="lineCov">      11719 :         else if (orig-&gt;sgprivate-&gt;tag==TAG_X3D_Script) is_script = 1;</span>
<span class="lineNum">     424 </span>            : #endif
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span><span class="lineCov">        365 :         if (is_script) gf_sg_script_prepare_clone(node, orig);</span>
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span>            :         /*register node*/
<span class="lineNum">     430 </span><span class="lineCov">      12084 :         if (id) {</span>
<span class="lineNum">     431 </span><span class="lineCov">       4287 :                 gf_node_set_id(node, id, szNodeName);</span>
<span class="lineNum">     432 </span><span class="lineCov">       4287 :                 if (szNodeName) gf_free(szNodeName);</span>
<span class="lineNum">     433 </span>            :         }
<span class="lineNum">     434 </span><span class="lineCov">      12084 :         gf_node_register(node, cloned_parent);</span>
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span>            :         /*copy each field*/
<span class="lineNum">     437 </span><span class="lineCov">     118879 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     438 </span><span class="lineCov">     106795 :                 gf_node_get_field(orig, i, &amp;field_orig);</span>
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span>            :                 /*get target ptr*/
<span class="lineNum">     441 </span><span class="lineCov">     106795 :                 gf_node_get_field(node, i, &amp;field);</span>
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span>            :                 assert(field.eventType==field_orig.eventType);
<span class="lineNum">     444 </span>            :                 assert(field.fieldType==field_orig.fieldType);
<span class="lineNum">     445 </span>            : 
<span class="lineNum">     446 </span>            :                 /*duplicate it*/
<span class="lineNum">     447 </span><span class="lineCov">     106795 :                 switch (field.fieldType) {</span>
<span class="lineNum">     448 </span><span class="lineCov">      10113 :                 case GF_SG_VRML_SFNODE:</span>
<span class="lineNum">     449 </span><span class="lineCov">      10113 :                         child = gf_node_clone(inScene, (* ((GF_Node **) field_orig.far_ptr)), node, inst_id_suffix, 1);</span>
<span class="lineNum">     450 </span><span class="lineCov">      10113 :                         *((GF_Node **) field.far_ptr) = child;</span>
<span class="lineNum">     451 </span><span class="lineCov">      10113 :                         break;</span>
<span class="lineNum">     452 </span><span class="lineCov">       5567 :                 case GF_SG_VRML_MFNODE:</span>
<span class="lineNum">     453 </span><span class="lineCov">       5567 :                         last = NULL;</span>
<span class="lineNum">     454 </span><span class="lineCov">       5567 :                         list = *( (GF_ChildNodeItem **) field_orig.far_ptr);</span>
<span class="lineNum">     455 </span><span class="lineCov">      16550 :                         while (list) {</span>
<span class="lineNum">     456 </span><span class="lineCov">       5416 :                                 child = gf_node_clone(inScene, list-&gt;node, node, inst_id_suffix, 1);</span>
<span class="lineNum">     457 </span><span class="lineCov">       5416 :                                 gf_node_list_add_child_last((GF_ChildNodeItem **) field.far_ptr, child, &amp;last);</span>
<span class="lineNum">     458 </span><span class="lineCov">       5416 :                                 list = list-&gt;next;</span>
<span class="lineNum">     459 </span>            :                         }
<span class="lineNum">     460 </span>            :                         break;
<span class="lineNum">     461 </span><span class="lineCov">       5023 :                 case GF_SG_VRML_SFTIME:</span>
<span class="lineNum">     462 </span><span class="lineCov">       5023 :                         gf_sg_vrml_field_copy(field.far_ptr, field_orig.far_ptr, field.fieldType);</span>
<span class="lineNum">     463 </span><span class="lineCov">       5023 :                         if (!inScene-&gt;GetSceneTime) break;</span>
<span class="lineNum">     464 </span>            :                         /*update SFTime that must be updated when cloning the node*/
<span class="lineNum">     465 </span><span class="lineCov">       5023 :                         if (orig-&gt;sgprivate-&gt;tag == TAG_ProtoNode) {</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                                 if (gf_sg_proto_field_is_sftime_offset(orig, &amp;field_orig))</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                                         *((SFTime *)field.far_ptr) += inScene-&gt;GetSceneTime(inScene-&gt;userpriv);</span>
<span class="lineNum">     468 </span><span class="lineCov">       5023 :                         } else if (!stricmp(field.name, &quot;startTime&quot;) || !stricmp(field_orig.name, &quot;startTime&quot;) ) {</span>
<span class="lineNum">     469 </span><span class="lineCov">        379 :                                 *((SFTime *)field.far_ptr) += inScene-&gt;GetSceneTime(inScene-&gt;userpriv);</span>
<span class="lineNum">     470 </span>            :                         }
<span class="lineNum">     471 </span>            :                         break;
<span class="lineNum">     472 </span><span class="lineCov">      86092 :                 default:</span>
<span class="lineNum">     473 </span><span class="lineCov">      86092 :                         gf_sg_vrml_field_clone(field.far_ptr, field_orig.far_ptr, field.fieldType, inScene);</span>
<span class="lineNum">     474 </span><span class="lineCov">      86092 :                         break;</span>
<span class="lineNum">     475 </span>            :                 }
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span>            : #ifndef GPAC_DISABLE_BIFS
<span class="lineNum">     479 </span>            :         /*init node before creating ISed routes so the eventIn handler are in place*/
<span class="lineNum">     480 </span><span class="lineCov">      12084 :         if (node-&gt;sgprivate-&gt;tag == TAG_MPEG4_Conditional)</span>
<span class="lineNum">     481 </span><span class="lineCov">         39 :                 BIFS_SetupConditionalClone(node, orig);</span>
<span class="lineNum">     482 </span>            :         else
<span class="lineNum">     483 </span>            : #endif
<span class="lineNum">     484 </span><span class="lineCov">      12045 :                 if (node-&gt;sgprivate-&gt;tag != TAG_ProtoNode) gf_node_init(node);</span>
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span><span class="lineCov">      12084 :         if (!inScene-&gt;pOwningProto) return node;</span>
<span class="lineNum">     487 </span>            :         proto = inScene-&gt;pOwningProto;
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span>            :         /*create Routes for ISed fields*/
<span class="lineNum">     490 </span><span class="lineCov">      11903 :         i=0;</span>
<span class="lineNum">     491 </span><span class="lineCov">     213797 :         while ((r1 = (GF_Route*)gf_list_enum(proto-&gt;proto_interface-&gt;sub_graph-&gt;Routes, &amp;i))) {</span>
<span class="lineNum">     492 </span>            :                 GF_Route *r2 = NULL;
<span class="lineNum">     493 </span>            :                 /*locate only ISed routes*/
<span class="lineNum">     494 </span><span class="lineCov">     189991 :                 if (!r1-&gt;IS_route) continue;</span>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span>            :                 /*eventOut*/
<span class="lineNum">     497 </span><span class="lineCov">     142901 :                 if (r1-&gt;FromNode == orig) {</span>
<span class="lineNum">     498 </span><span class="lineCov">       4248 :                         r2 = gf_sg_route_new(inScene, node, r1-&gt;FromField.fieldIndex, (GF_Node *) proto, r1-&gt;ToField.fieldIndex);</span>
<span class="lineNum">     499 </span><span class="lineCov">       4248 :                         r2-&gt;IS_route = 1;</span>
<span class="lineNum">     500 </span>            :                 }
<span class="lineNum">     501 </span>            :                 /*eventIn or exposedField*/
<span class="lineNum">     502 </span><span class="lineCov">     138653 :                 else if (r1-&gt;ToNode == orig) {</span>
<span class="lineNum">     503 </span><span class="lineCov">       4258 :                         r2 = gf_sg_route_new(inScene, (GF_Node *) proto, r1-&gt;FromField.fieldIndex, node, r1-&gt;ToField.fieldIndex);</span>
<span class="lineNum">     504 </span><span class="lineCov">       4258 :                         r2-&gt;IS_route = 1;</span>
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span>            :                         /*activate the route now so that proto instanciation works properly, otherwise we may load scripts with wrong field values
<span class="lineNum">     507 </span>            :                         Note: we don't activate eventOut routes upon instanciation since no event has been triggered yet*/
<span class="lineNum">     508 </span><span class="lineCov">       4258 :                         gf_sg_route_activate(r2);</span>
<span class="lineNum">     509 </span>            :                 }
<span class="lineNum">     510 </span>            :         }
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span>            :         /*remember scripts*/
<span class="lineNum">     513 </span><span class="lineCov">      11903 :         if (is_script) gf_list_add(proto-&gt;scripts_to_load, node);</span>
<span class="lineNum">     514 </span>            : 
<span class="lineNum">     515 </span>            :         /*this is a proto node, init our internal stuff*/
<span class="lineNum">     516 </span><span class="lineCov">      11903 :         if (node-&gt;sgprivate-&gt;tag == TAG_ProtoNode) {</span>
<span class="lineNum">     517 </span><span class="lineCov">        366 :                 node-&gt;sgprivate-&gt;UserCallback = NULL;</span>
<span class="lineNum">     518 </span><span class="lineCov">        366 :                 node-&gt;sgprivate-&gt;UserPrivate = NULL;</span>
<span class="lineNum">     519 </span>            :                 /*NO RENDER, this is filtered at the generic gf_node_traverse to cope with instanciations and externProto*/
<span class="lineNum">     520 </span>            :                 /*load code*/
<span class="lineNum">     521 </span><span class="lineCov">        366 :                 gf_sg_proto_instantiate((GF_ProtoInstance *)node);</span>
<span class="lineNum">     522 </span>            :         }
<span class="lineNum">     523 </span>            :         return node;
<a name="524"><span class="lineNum">     524 </span>            : }</a>
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span><span class="lineCov">       2651 : GF_Err gf_sg_proto_get_field_ind_static(GF_Node *Node, u32 inField, u8 IndexMode, u32 *allField)</span>
<span class="lineNum">     527 </span>            : {
<span class="lineNum">     528 </span><span class="lineCov">       2651 :         return gf_sg_proto_get_field_index((GF_ProtoInstance *)Node, inField, IndexMode, allField);</span>
<span class="lineNum">     529 </span>            : }
<a name="530"><span class="lineNum">     530 </span>            : </a>
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span><span class="lineCov">         12 : static Bool is_same_proto(GF_Proto *extern_proto, GF_Proto *proto)</span>
<span class="lineNum">     533 </span>            : {
<span class="lineNum">     534 </span>            :         u32 i, count;
<span class="lineNum">     535 </span>            :         /*VRML allows external protos to have more fields defined that the externProto referencing them*/
<span class="lineNum">     536 </span><span class="lineCov">         12 :         if (gf_list_count(extern_proto-&gt;proto_fields) &gt; gf_list_count(proto-&gt;proto_fields)) return 0;</span>
<span class="lineNum">     537 </span><span class="lineCov">         12 :         count = gf_list_count(extern_proto-&gt;proto_fields);</span>
<span class="lineNum">     538 </span><span class="lineCov">         84 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     539 </span><span class="lineCov">         84 :                 GF_ProtoFieldInterface *pf1 = (GF_ProtoFieldInterface*)gf_list_get(extern_proto-&gt;proto_fields, i);</span>
<span class="lineNum">     540 </span><span class="lineCov">         84 :                 GF_ProtoFieldInterface *pf2 = (GF_ProtoFieldInterface*)gf_list_get(proto-&gt;proto_fields, i);</span>
<span class="lineNum">     541 </span><span class="lineCov">         84 :                 if (pf1-&gt;EventType != pf2-&gt;EventType) return 0;</span>
<span class="lineNum">     542 </span><span class="lineCov">         84 :                 if (pf1-&gt;FieldType != pf2-&gt;FieldType) return 0;</span>
<span class="lineNum">     543 </span>            :                 /*note we don't check names since we're not sure both protos use name coding (MPEG4 only)*/
<span class="lineNum">     544 </span>            :         }
<span class="lineNum">     545 </span>            :         return 1;
<a name="546"><span class="lineNum">     546 </span>            : }</a>
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span><span class="lineCov">          6 : static GF_Proto *find_proto_by_interface(GF_SceneGraph *sg, GF_Proto *extern_proto)</span>
<span class="lineNum">     549 </span>            : {
<span class="lineNum">     550 </span>            :         GF_Proto *proto;
<span class="lineNum">     551 </span>            :         u32 i, count;
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span>            :         assert(sg);
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span>            :         /*browse all top-level */
<span class="lineNum">     556 </span><span class="lineCov">          6 :         i=0;</span>
<span class="lineNum">     557 </span><span class="lineCov">          6 :         while ((proto = (GF_Proto*)gf_list_enum(sg-&gt;protos, &amp;i))) {</span>
<span class="lineNum">     558 </span><span class="lineCov">          6 :                 if (is_same_proto(proto, extern_proto)) return proto;</span>
<span class="lineNum">     559 </span>            :         }
<span class="lineNum">     560 </span>            :         /*browse all top-level unregistered in reverse order*/
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :         count = gf_list_count(sg-&gt;unregistered_protos);</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :         for (i=count; i&gt;0; i--) {</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :                 proto = (GF_Proto*)gf_list_get(sg-&gt;unregistered_protos, i-1);</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :                 if (is_same_proto(proto, extern_proto)) return proto;</span>
<span class="lineNum">     565 </span>            :         }
<span class="lineNum">     566 </span>            :         return NULL;
<span class="lineNum">     567 </span>            : }
<a name="568"><span class="lineNum">     568 </span>            : </a>
<span class="lineNum">     569 </span>            : /*performs common initialization of routes ISed fields and protos once everything is loaded*/
<span class="lineNum">     570 </span><span class="lineCov">       1098 : void gf_sg_proto_instantiate(GF_ProtoInstance *proto_node)</span>
<span class="lineNum">     571 </span>            : {
<span class="lineNum">     572 </span>            :         GF_Node *node, *orig;
<span class="lineNum">     573 </span>            :         GF_Route *route, *r2;
<span class="lineNum">     574 </span>            :         u32 i, count;
<span class="lineNum">     575 </span><span class="lineCov">       1098 :         GF_Proto *proto = proto_node-&gt;proto_interface;</span>
<span class="lineNum">     576 </span>            :         GF_Proto *owner = proto;
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span><span class="lineCov">       1372 :         if (!proto) return;</span>
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span><span class="lineCov">       1098 :         if (owner-&gt;ExternProto.count) {</span>
<span class="lineNum">     581 </span>            :                 GF_ProtoFieldInterface *pfi;
<span class="lineNum">     582 </span>            :                 GF_SceneGraph *extern_lib;
<span class="lineNum">     583 </span><span class="lineCov">        280 :                 if (!owner-&gt;parent_graph-&gt;GetExternProtoLib) return;</span>
<span class="lineNum">     584 </span><span class="lineCov">        280 :                 extern_lib = owner-&gt;parent_graph-&gt;GetExternProtoLib(proto-&gt;parent_graph-&gt;userpriv, &amp;owner-&gt;ExternProto);</span>
<span class="lineNum">     585 </span><span class="lineCov">        280 :                 if (!extern_lib) return;</span>
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span>            :                 /*this is an hardcoded proto - all routes, node modifications and co are handled internally*/
<span class="lineNum">     588 </span><span class="lineCov">        100 :                 if (PTR_TO_U_CAST extern_lib == GF_SG_INTERNAL_PROTO) {</span>
<span class="lineNum">     589 </span><span class="lineCov">         87 :                         proto_node-&gt;sgprivate-&gt;flags |= GF_SG_NODE_DIRTY;</span>
<span class="lineNum">     590 </span>            :                         // take default values
<span class="lineNum">     591 </span><span class="lineCov">         87 :                         count = gf_list_count(owner-&gt;proto_fields);</span>
<span class="lineNum">     592 </span><span class="lineCov">        279 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     593 </span><span class="lineCov">        192 :                                 GF_ProtoField *pf = (GF_ProtoField *)gf_list_get(proto_node-&gt;fields, i);</span>
<span class="lineNum">     594 </span><span class="lineCov">        192 :                                 if (!pf-&gt;has_been_accessed) {</span>
<span class="lineNum">     595 </span><span class="lineCov">        167 :                                         pfi = (GF_ProtoFieldInterface*)gf_list_get(proto-&gt;proto_fields, i);</span>
<span class="lineNum">     596 </span><span class="lineCov">        167 :                                         gf_sg_vrml_field_copy(pf-&gt;field_pointer, pfi-&gt;def_value, pfi-&gt;FieldType);</span>
<span class="lineNum">     597 </span>            :                                 }
<span class="lineNum">     598 </span>            :                         }
<span class="lineNum">     599 </span><span class="lineCov">         87 :                         owner-&gt;parent_graph-&gt;NodeCallback(owner-&gt;parent_graph-&gt;userpriv, GF_SG_CALLBACK_INIT, (GF_Node *) proto_node, NULL);</span>
<span class="lineNum">     600 </span><span class="lineCov">         87 :                         proto_node-&gt;flags |= GF_SG_PROTO_LOADED | GF_SG_PROTO_HARDCODED;</span>
<span class="lineNum">     601 </span><span class="lineCov">         87 :                         return;</span>
<span class="lineNum">     602 </span>            :                 }
<span class="lineNum">     603 </span>            :                 /*not loaded yet*/
<span class="lineNum">     604 </span><span class="lineCov">         13 :                 if (!gf_list_count(extern_lib-&gt;protos)) return;</span>
<span class="lineNum">     605 </span>            : 
<span class="lineNum">     606 </span>            :                 /*overwrite this proto by external one*/
<span class="lineNum">     607 </span>            :                 proto = NULL;
<span class="lineNum">     608 </span>            :                 /*start with proto v2 addressing*/
<span class="lineNum">     609 </span><span class="lineCov">          6 :                 if (owner-&gt;ExternProto.vals[0].url) {</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :                         u32 ID = (u32) -1;</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :                         char *szName = strrchr(owner-&gt;ExternProto.vals[0].url, '#');</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :                         if (szName) {</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :                                 szName++;</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :                                 if (sscanf(szName, &quot;%u&quot;, &amp;ID)) ID = (u32) -1;</span>
<span class="lineNum">     615 </span>            :                         }
<span class="lineNum">     616 </span>            :                         /*if we have the proto name, use it*/
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :                         if (owner-&gt;Name) szName = owner-&gt;Name;</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :                         proto = gf_sg_find_proto(extern_lib, ID, szName);</span>
<span class="lineNum">     619 </span>            :                 }
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :                 if (!proto) proto = gf_sg_find_proto(extern_lib, owner-&gt;ID, owner-&gt;Name);</span>
<span class="lineNum">     621 </span><span class="lineCov">          6 :                 if (!proto) proto = find_proto_by_interface(extern_lib, owner);</span>
<span class="lineNum">     622 </span>            : 
<span class="lineNum">     623 </span><span class="lineCov">          6 :                 if (proto &amp;&amp; !is_same_proto(owner, proto)) {</span>
<span class="lineNum">     624 </span>            :                         proto = NULL;
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_SCENE, (&quot;[Scenegraph] fields/types mismatch for PROTO %s - skipping instantiation\n&quot;, owner-&gt;Name));</span>
<span class="lineNum">     626 </span>            :                 }
<span class="lineNum">     627 </span>            :                 /*couldn't find proto in the given lib, consider the proto as loaded (give up)*/
<span class="lineNum">     628 </span><span class="lineCov">          6 :                 if (!proto) {</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :                         proto_node-&gt;flags |= GF_SG_PROTO_LOADED;</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     631 </span>            :                 }
<span class="lineNum">     632 </span>            :                 /*cf VRML: once an external proto is loaded, copy back the default field values of the external proto*/
<span class="lineNum">     633 </span><span class="lineCov">          6 :                 count = gf_list_count(owner-&gt;proto_fields);</span>
<span class="lineNum">     634 </span><span class="lineCov">         48 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     635 </span><span class="lineCov">         42 :                         GF_ProtoField *pf = (GF_ProtoField *)gf_list_get(proto_node-&gt;fields, i);</span>
<span class="lineNum">     636 </span><span class="lineCov">         42 :                         if (!pf-&gt;has_been_accessed) {</span>
<span class="lineNum">     637 </span><span class="lineCov">         18 :                                 pfi = (GF_ProtoFieldInterface*)gf_list_get(proto-&gt;proto_fields, i);</span>
<span class="lineNum">     638 </span><span class="lineCov">         18 :                                 gf_sg_vrml_field_copy(pf-&gt;field_pointer, pfi-&gt;def_value, pfi-&gt;FieldType);</span>
<span class="lineNum">     639 </span>            :                         } else {
<span class="lineNum">     640 </span>            :                                 //pfi = (GF_ProtoFieldInterface*)gf_list_get(proto-&gt;proto_fields, i);
<span class="lineNum">     641 </span>            :                         }
<span class="lineNum">     642 </span>            :                 }
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span>            :                 /*unregister from prev and reg with real proto*/
<span class="lineNum">     645 </span><span class="lineCov">          6 :                 gf_list_del_item(owner-&gt;instances, proto_node);</span>
<span class="lineNum">     646 </span><span class="lineCov">          6 :                 gf_list_add(proto-&gt;instances, proto_node);</span>
<span class="lineNum">     647 </span>            :         }
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span>            :         /*OVERRIDE the proto instance (eg don't instantiate an empty externproto...)*/
<span class="lineNum">     650 </span><span class="lineCov">        824 :         proto_node-&gt;proto_interface = proto;</span>
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span>            :         /*clone all nodes*/
<span class="lineNum">     653 </span><span class="lineCov">        824 :         i=0;</span>
<span class="lineNum">     654 </span><span class="lineCov">       3266 :         while ((orig = (GF_Node*)gf_list_enum(proto-&gt;node_code, &amp;i))) {</span>
<span class="lineNum">     655 </span>            :                 /*node is cloned in the new scenegraph and its parent is NULL */
<span class="lineNum">     656 </span><span class="lineCov">       1618 :                 node = gf_node_clone(proto_node-&gt;sgprivate-&gt;scenegraph, orig, NULL, &quot;&quot;, 1);</span>
<span class="lineNum">     657 </span>            :                 assert(node);
<span class="lineNum">     658 </span>            : 
<span class="lineNum">     659 </span>            :                 /*assign first rendering node*/
<span class="lineNum">     660 </span><span class="lineCov">       1618 :                 if (i==1) proto_node-&gt;RenderingNode = node;</span>
<span class="lineNum">     661 </span><span class="lineCov">       1618 :                 gf_list_add(proto_node-&gt;node_code, node);</span>
<span class="lineNum">     662 </span>            :         }
<span class="lineNum">     663 </span>            : 
<span class="lineNum">     664 </span>            :         /*instantiate routes (not ISed ones)*/
<span class="lineNum">     665 </span><span class="lineCov">        824 :         i=0;</span>
<span class="lineNum">     666 </span><span class="lineCov">      13570 :         while ((route = (GF_Route*)gf_list_enum(proto-&gt;sub_graph-&gt;Routes, &amp;i))) {</span>
<span class="lineNum">     667 </span><span class="lineCov">      11922 :                 if (route-&gt;IS_route) continue;</span>
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span><span class="lineCov">      10248 :                 r2 = gf_sg_route_new(proto_node-&gt;sgprivate-&gt;scenegraph,</span>
<span class="lineNum">     670 </span><span class="lineCov">       3416 :                                      gf_sg_find_node(proto_node-&gt;sgprivate-&gt;scenegraph, gf_node_get_id(route-&gt;FromNode) ),</span>
<span class="lineNum">     671 </span>            :                                      route-&gt;FromField.fieldIndex,
<span class="lineNum">     672 </span><span class="lineCov">       3416 :                                      gf_sg_find_node(proto_node-&gt;sgprivate-&gt;scenegraph, gf_node_get_id(route-&gt;ToNode) ),</span>
<span class="lineNum">     673 </span>            :                                      route-&gt;ToField.fieldIndex);
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span><span class="lineCov">       3416 :                 if (route-&gt;ID) gf_sg_route_set_id(r2, route-&gt;ID);</span>
<span class="lineNum">     676 </span><span class="lineCov">       3416 :                 if (route-&gt;name) gf_sg_route_set_name(r2, route-&gt;name);</span>
<span class="lineNum">     677 </span>            :         }
<span class="lineNum">     678 </span>            :         /*activate all ISed fields so that inits on events is properly done*/
<span class="lineNum">     679 </span><span class="lineCov">        824 :         i=0;</span>
<span class="lineNum">     680 </span><span class="lineCov">      13570 :         while ((route = (GF_Route*)gf_list_enum(proto_node-&gt;sgprivate-&gt;scenegraph-&gt;Routes, &amp;i))) {</span>
<span class="lineNum">     681 </span><span class="lineCov">      11922 :                 if (!route-&gt;IS_route) continue;</span>
<span class="lineNum">     682 </span>            :                 /*do not activate eventIn to eventIn routes*/
<span class="lineNum">     683 </span><span class="lineCov">       8506 :                 if (route-&gt;is_setup) {</span>
<span class="lineNum">     684 </span><span class="lineCov">       4258 :                         if ((route-&gt;ToField.eventType == GF_SG_EVENT_IN) &amp;&amp; (route-&gt;FromField.eventType == GF_SG_EVENT_IN) ) continue;</span>
<span class="lineNum">     685 </span>            :                 }
<span class="lineNum">     686 </span><span class="lineCov">       8478 :                 gf_sg_route_activate(route);</span>
<span class="lineNum">     687 </span>            :         }
<span class="lineNum">     688 </span>            :         /*and load all scripts (this must be done once all fields are routed for the &quot;initialize&quot; method)*/
<span class="lineNum">     689 </span><span class="lineCov">       1189 :         while (gf_list_count(proto_node-&gt;scripts_to_load)) {</span>
<span class="lineNum">     690 </span><span class="lineCov">        365 :                 node = (GF_Node*)gf_list_get(proto_node-&gt;scripts_to_load, 0);</span>
<span class="lineNum">     691 </span><span class="lineCov">        365 :                 gf_list_rem(proto_node-&gt;scripts_to_load, 0);</span>
<span class="lineNum">     692 </span><span class="lineCov">        365 :                 gf_sg_script_load(node);</span>
<span class="lineNum">     693 </span>            :         }
<span class="lineNum">     694 </span>            :         /*re-activate all ISed fields pointing to scripts once scripts are loaded (eventIns)*/
<span class="lineNum">     695 </span><span class="lineCov">        824 :         i=0;</span>
<span class="lineNum">     696 </span><span class="lineCov">      13570 :         while ((route = (GF_Route*)gf_list_enum(proto_node-&gt;sgprivate-&gt;scenegraph-&gt;Routes, &amp;i))) {</span>
<span class="lineNum">     697 </span><span class="lineCov">      11922 :                 if (!route-&gt;IS_route || !route-&gt;ToNode) continue;</span>
<span class="lineNum">     698 </span>            :                 /*              assert(route-&gt;is_setup);
<span class="lineNum">     699 </span>            :                                 if ((route-&gt;FromField.eventType == GF_SG_EVENT_OUT) || (route-&gt;FromField.eventType == GF_SG_EVENT_IN) ) continue;
<span class="lineNum">     700 </span>            :                 */
<span class="lineNum">     701 </span>            : 
<span class="lineNum">     702 </span><span class="lineCov">       8506 :                 if (route-&gt;is_setup) {</span>
<span class="lineNum">     703 </span><span class="lineCov">       8506 :                         if ((route-&gt;ToField.eventType == GF_SG_EVENT_IN) &amp;&amp; (route-&gt;FromField.eventType == GF_SG_EVENT_IN) ) continue;</span>
<span class="lineNum">     704 </span>            :                 }
<span class="lineNum">     705 </span>            : 
<span class="lineNum">     706 </span><span class="lineCov">       8478 :                 if (route-&gt;ToNode-&gt;sgprivate-&gt;tag==TAG_MPEG4_Script)</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :                         gf_sg_route_activate(route);</span>
<span class="lineNum">     708 </span>            : #ifndef GPAC_DISABLE_X3D
<span class="lineNum">     709 </span><span class="lineCov">       8478 :                 else if (route-&gt;ToNode-&gt;sgprivate-&gt;tag==TAG_X3D_Script)</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :                         gf_sg_route_activate(route);</span>
<span class="lineNum">     711 </span>            : #endif
<span class="lineNum">     712 </span>            :         }
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span>            : #if 0
<span class="lineNum">     715 </span>            :         /*reset all regular route activation times - if we don't do so, creating a proto by script and then manipulating one of its
<span class="lineNum">     716 </span>            :         ISed field may not trigger the proper routes*/
<span class="lineNum">     717 </span>            :         i=0;
<span class="lineNum">     718 </span>            :         while ((route = (GF_Route*)gf_list_enum(proto_node-&gt;sgprivate-&gt;scenegraph-&gt;Routes, &amp;i))) {
<span class="lineNum">     719 </span>            :                 if (!route-&gt;IS_route) {
<span class="lineNum">     720 </span>            :                         route-&gt;lastActivateTime = 0;
<span class="lineNum">     721 </span>            :                 }
<span class="lineNum">     722 </span>            :         }
<span class="lineNum">     723 </span>            : #endif
<span class="lineNum">     724 </span><span class="lineCov">        824 :         proto_node-&gt;flags |= GF_SG_PROTO_LOADED;</span>
<a name="725"><span class="lineNum">     725 </span>            : }</a>
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span><span class="lineCov">      18637 : void gf_sg_proto_mark_field_loaded(GF_Node *proto_inst, GF_FieldInfo *info)</span>
<span class="lineNum">     728 </span>            : {
<span class="lineNum">     729 </span><span class="lineCov">      18637 :         GF_ProtoInstance *inst= (proto_inst-&gt;sgprivate-&gt;tag==TAG_ProtoNode) ? (GF_ProtoInstance *)proto_inst : NULL;</span>
<span class="lineNum">     730 </span><span class="lineCov">      18637 :         GF_ProtoField *pf = inst ? (GF_ProtoField *)gf_list_get(inst-&gt;fields, info-&gt;fieldIndex) : NULL;</span>
<span class="lineNum">     731 </span><span class="lineCov">      18637 :         if (pf) pf-&gt;has_been_accessed = 1;</span>
<a name="732"><span class="lineNum">     732 </span><span class="lineCov">      18637 : }</span></a>
<span class="lineNum">     733 </span>            : 
<span class="lineNum">     734 </span><span class="lineCov">       1959 : GF_Node *gf_sg_proto_create_node(GF_SceneGraph *scene, GF_Proto *proto, GF_ProtoInstance *from_inst)</span>
<span class="lineNum">     735 </span>            : {
<span class="lineNum">     736 </span>            :         u32 i;
<span class="lineNum">     737 </span>            :         GF_ProtoField *inst, *from_field;
<span class="lineNum">     738 </span>            :         GF_ProtoFieldInterface *field;
<span class="lineNum">     739 </span>            :         GF_ProtoInstance *proto_node;
<span class="lineNum">     740 </span><span class="lineCov">       1959 :         if (!proto) return NULL;</span>
<span class="lineNum">     741 </span>            :         
<span class="lineNum">     742 </span><span class="lineCov">       1959 :         GF_SAFEALLOC(proto_node, GF_ProtoInstance)</span>
<span class="lineNum">     743 </span><span class="lineCov">       1959 :         if (!proto_node) return NULL;</span>
<span class="lineNum">     744 </span>            : 
<span class="lineNum">     745 </span><span class="lineCov">       1959 :         gf_node_setup((GF_Node *)proto_node, TAG_ProtoNode);</span>
<span class="lineNum">     746 </span><span class="lineCov">       1959 :         proto_node-&gt;node_code = gf_list_new();</span>
<span class="lineNum">     747 </span><span class="lineCov">       1959 :         proto_node-&gt;fields = gf_list_new();</span>
<span class="lineNum">     748 </span><span class="lineCov">       1959 :         proto_node-&gt;scripts_to_load = gf_list_new();</span>
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span><span class="lineCov">       1959 :         proto_node-&gt;proto_interface = proto;</span>
<span class="lineNum">     751 </span><span class="lineCov">       1959 :         gf_list_add(proto-&gt;instances, proto_node);</span>
<span class="lineNum">     752 </span>            : 
<span class="lineNum">     753 </span><span class="lineCov">       1959 :         proto_node-&gt;proto_name = gf_strdup(proto-&gt;Name);</span>
<span class="lineNum">     754 </span>            : 
<span class="lineNum">     755 </span>            :         /*create the namespace*/
<span class="lineNum">     756 </span><span class="lineCov">       1959 :         proto_node-&gt;sgprivate-&gt;scenegraph = gf_sg_new_subscene(scene);</span>
<span class="lineNum">     757 </span>            :         /*set this proto as owner of the new graph*/
<span class="lineNum">     758 </span><span class="lineCov">       1959 :         proto_node-&gt;sgprivate-&gt;scenegraph-&gt;pOwningProto = proto_node;</span>
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span>            :         /*instantiate fields*/
<span class="lineNum">     761 </span><span class="lineCov">       1959 :         i=0;</span>
<span class="lineNum">     762 </span><span class="lineCov">      15314 :         while ((field = (GF_ProtoFieldInterface*)gf_list_enum(proto-&gt;proto_fields, &amp;i))) {</span>
<span class="lineNum">     763 </span><span class="lineCov">      11396 :                 GF_SAFEALLOC(inst, GF_ProtoField);</span>
<span class="lineNum">     764 </span><span class="lineCov">      11396 :                 if (!inst) {</span>
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_SCENE, (&quot;[VRML] Failed to allocate proto instance field\n]&quot;));</span>
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     767 </span>            :                 }
<span class="lineNum">     768 </span>            :                 
<span class="lineNum">     769 </span><span class="lineCov">      11396 :                 inst-&gt;EventType = field-&gt;EventType;</span>
<span class="lineNum">     770 </span><span class="lineCov">      11396 :                 inst-&gt;FieldType = field-&gt;FieldType;</span>
<span class="lineNum">     771 </span>            : 
<span class="lineNum">     772 </span>            :                 /*this is OK to call on GF_Node (returns NULL) and MFNode (returns gf_list_new() )*/
<span class="lineNum">     773 </span><span class="lineCov">      11396 :                 inst-&gt;field_pointer = gf_sg_vrml_field_pointer_new(inst-&gt;FieldType);</span>
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span>            :                 /*regular field, duplicate from default value or instantiated one if specified (since
<span class="lineNum">     776 </span>            :                 a proto may be partially instantiated when used in another proto)*/
<span class="lineNum">     777 </span><span class="lineCov">      11396 :                 if (gf_sg_vrml_get_sf_type(inst-&gt;FieldType) != GF_SG_VRML_SFNODE) {</span>
<span class="lineNum">     778 </span><span class="lineCov">      10242 :                         if (from_inst) {</span>
<span class="lineNum">     779 </span><span class="lineCov">        387 :                                 from_field = (GF_ProtoField *)gf_list_get(from_inst-&gt;fields, i-1);</span>
<span class="lineNum">     780 </span><span class="lineCov">        387 :                                 gf_sg_vrml_field_copy(inst-&gt;field_pointer, from_field-&gt;field_pointer, inst-&gt;FieldType);</span>
<span class="lineNum">     781 </span><span class="lineCov">        387 :                                 inst-&gt;has_been_accessed = from_field-&gt;has_been_accessed;</span>
<span class="lineNum">     782 </span>            :                         } else {
<span class="lineNum">     783 </span><span class="lineCov">       9855 :                                 gf_sg_vrml_field_copy(inst-&gt;field_pointer, field-&gt;def_value, inst-&gt;FieldType);</span>
<span class="lineNum">     784 </span>            :                         }
<span class="lineNum">     785 </span>            :                 }
<span class="lineNum">     786 </span>            :                 /*No default values for SFNodes as interfaces ...*/
<span class="lineNum">     787 </span><span class="lineCov">      11396 :                 gf_list_add(proto_node-&gt;fields, inst);</span>
<span class="lineNum">     788 </span>            :         }
<span class="lineNum">     789 </span>            :         return (GF_Node *) proto_node;
<span class="lineNum">     790 </span>            : }
<span class="lineNum">     791 </span>            : 
<a name="792"><span class="lineNum">     792 </span>            : </a>
<span class="lineNum">     793 </span>            : GF_EXPORT
<span class="lineNum">     794 </span><span class="lineCov">       1569 : GF_Node *gf_sg_proto_create_instance(GF_SceneGraph *sg, GF_Proto *proto)</span>
<span class="lineNum">     795 </span>            : {
<span class="lineNum">     796 </span><span class="lineCov">       1569 :         return gf_sg_proto_create_node(sg, proto, NULL);</span>
<span class="lineNum">     797 </span>            : }
<a name="798"><span class="lineNum">     798 </span>            : </a>
<span class="lineNum">     799 </span>            : GF_EXPORT
<span class="lineNum">     800 </span><span class="lineCov">        541 : GF_Err gf_sg_proto_load_code(GF_Node *node)</span>
<span class="lineNum">     801 </span>            : {
<span class="lineNum">     802 </span>            :         GF_ProtoInstance *inst;
<span class="lineNum">     803 </span><span class="lineCov">        541 :         if (node-&gt;sgprivate-&gt;tag != TAG_ProtoNode) return GF_BAD_PARAM;</span>
<span class="lineNum">     804 </span>            :         inst = (GF_ProtoInstance *) node;
<span class="lineNum">     805 </span><span class="lineCov">        541 :         if (!inst-&gt;proto_interface) return GF_BAD_PARAM;</span>
<span class="lineNum">     806 </span><span class="lineCov">        541 :         if (inst-&gt;flags &amp; GF_SG_PROTO_LOADED) return GF_OK;</span>
<span class="lineNum">     807 </span><span class="lineCov">        541 :         gf_sg_proto_instantiate(inst);</span>
<span class="lineNum">     808 </span><span class="lineCov">        541 :         return GF_OK;</span>
<span class="lineNum">     809 </span>            : }
<a name="810"><span class="lineNum">     810 </span>            : </a>
<span class="lineNum">     811 </span>            : 
<span class="lineNum">     812 </span><span class="lineCov">       2264 : u32 gf_sg_proto_get_num_fields(GF_Node *node, u8 code_mode)</span>
<span class="lineNum">     813 </span>            : {
<span class="lineNum">     814 </span>            :         GF_ProtoInstance *proto;
<span class="lineNum">     815 </span><span class="lineCov">       2264 :         if (!node) return 0;</span>
<span class="lineNum">     816 </span>            : 
<span class="lineNum">     817 </span>            :         proto = (GF_ProtoInstance *)node;
<span class="lineNum">     818 </span>            :         /*watchout for deletion case*/
<span class="lineNum">     819 </span><span class="lineCov">       2264 :         switch (code_mode) {</span>
<span class="lineNum">     820 </span><span class="lineCov">        153 :         case GF_SG_FIELD_CODING_IN:</span>
<span class="lineNum">     821 </span><span class="lineCov">        153 :                 return proto-&gt;proto_interface ? proto-&gt;proto_interface-&gt;NumIn : 0;</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :         case GF_SG_FIELD_CODING_OUT:</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :                 return proto-&gt;proto_interface ? proto-&gt;proto_interface-&gt;NumOut : 0;</span>
<span class="lineNum">     824 </span><span class="lineCov">        989 :         case GF_SG_FIELD_CODING_DEF:</span>
<span class="lineNum">     825 </span><span class="lineCov">        989 :                 return proto-&gt;proto_interface ? proto-&gt;proto_interface-&gt;NumDef : 0;</span>
<span class="lineNum">     826 </span><span class="lineCov">       1122 :         case GF_SG_FIELD_CODING_ALL:</span>
<span class="lineNum">     827 </span><span class="lineCov">       1122 :                 return gf_list_count(proto-&gt;proto_interface ? proto-&gt;proto_interface-&gt;proto_fields : proto-&gt;fields);</span>
<span class="lineNum">     828 </span>            :         /*BIFS-ANIM not supported*/
<span class="lineNum">     829 </span>            :         case GF_SG_FIELD_CODING_DYN:
<span class="lineNum">     830 </span>            :         default:
<span class="lineNum">     831 </span>            :                 return 0;
<span class="lineNum">     832 </span>            :         }
<span class="lineNum">     833 </span>            : }
<a name="834"><span class="lineNum">     834 </span>            : </a>
<span class="lineNum">     835 </span>            : 
<span class="lineNum">     836 </span><span class="lineCov">       1959 : void gf_sg_proto_del_instance(GF_ProtoInstance *inst)</span>
<span class="lineNum">     837 </span>            : {
<span class="lineNum">     838 </span>            :         GF_SceneGraph *sg;
<span class="lineNum">     839 </span>            : 
<span class="lineNum">     840 </span><span class="lineCov">      15314 :         while (gf_list_count(inst-&gt;fields)) {</span>
<span class="lineNum">     841 </span><span class="lineCov">      11396 :                 GF_ProtoField *field = (GF_ProtoField *)gf_list_get(inst-&gt;fields, 0);</span>
<span class="lineNum">     842 </span><span class="lineCov">      11396 :                 gf_list_rem(inst-&gt;fields, 0);</span>
<span class="lineNum">     843 </span>            : 
<span class="lineNum">     844 </span>            :                 /*regular type*/
<span class="lineNum">     845 </span><span class="lineCov">      11396 :                 if ( (field-&gt;FieldType!=GF_SG_VRML_SFNODE) &amp;&amp; (field-&gt;FieldType!=GF_SG_VRML_MFNODE)) {</span>
<span class="lineNum">     846 </span><span class="lineCov">      10242 :                         gf_sg_vrml_field_pointer_del(field-&gt;field_pointer, field-&gt;FieldType);</span>
<span class="lineNum">     847 </span>            :                 }
<span class="lineNum">     848 </span>            :                 /*node types: delete instances*/
<span class="lineNum">     849 </span><span class="lineCov">       1154 :                 else if (field-&gt;field_pointer) {</span>
<span class="lineNum">     850 </span><span class="lineCov">        495 :                         if (field-&gt;FieldType == GF_SG_VRML_SFNODE) {</span>
<span class="lineNum">     851 </span><span class="lineCov">        422 :                                 gf_node_unregister((GF_Node *) field-&gt;field_pointer, (GF_Node *) inst);</span>
<span class="lineNum">     852 </span>            :                         } else {
<span class="lineNum">     853 </span>            :                                 GF_ChildNodeItem *list = (GF_ChildNodeItem *)field-&gt;field_pointer;
<span class="lineNum">     854 </span><span class="lineCov">        146 :                                 while (list) {</span>
<span class="lineNum">     855 </span>            :                                         GF_ChildNodeItem *cur = list;
<span class="lineNum">     856 </span><span class="lineCov">         73 :                                         gf_node_unregister(list-&gt;node, (GF_Node *) inst);</span>
<span class="lineNum">     857 </span><span class="lineCov">         73 :                                         list = list-&gt;next;</span>
<span class="lineNum">     858 </span><span class="lineCov">         73 :                                         gf_free(cur);</span>
<span class="lineNum">     859 </span>            :                                 }
<span class="lineNum">     860 </span>            :                         }
<span class="lineNum">     861 </span>            :                 }
<span class="lineNum">     862 </span>            : 
<span class="lineNum">     863 </span><span class="lineCov">      11396 :                 gf_free(field);</span>
<span class="lineNum">     864 </span>            :         }
<span class="lineNum">     865 </span><span class="lineCov">       1959 :         gf_list_del(inst-&gt;fields);</span>
<span class="lineNum">     866 </span>            : 
<span class="lineNum">     867 </span>            :         /*destroy the code*/
<span class="lineNum">     868 </span><span class="lineCov">       5536 :         while (gf_list_count(inst-&gt;node_code)) {</span>
<span class="lineNum">     869 </span><span class="lineCov">       1618 :                 GF_Node *node = (GF_Node*)gf_list_get(inst-&gt;node_code, 0);</span>
<span class="lineNum">     870 </span><span class="lineCov">       1618 :                 gf_node_unregister(node, (GF_Node*) inst);</span>
<span class="lineNum">     871 </span><span class="lineCov">       1618 :                 gf_list_rem(inst-&gt;node_code, 0);</span>
<span class="lineNum">     872 </span>            :         }
<span class="lineNum">     873 </span>            : 
<span class="lineNum">     874 </span><span class="lineCov">       1959 :         sg = inst-&gt;sgprivate-&gt;scenegraph;</span>
<span class="lineNum">     875 </span>            : 
<span class="lineNum">     876 </span>            :         /*reset the scene graph before destroying the node code list, as unregistering nodes
<span class="lineNum">     877 </span>            :         not destroyed in the previous phase (eg, cyclic references such as script and co) will
<span class="lineNum">     878 </span>            :         refer to the node-code list*/
<span class="lineNum">     879 </span><span class="lineCov">       1959 :         gf_sg_reset(sg);</span>
<span class="lineNum">     880 </span><span class="lineCov">       1959 :         sg-&gt;pOwningProto = NULL;</span>
<span class="lineNum">     881 </span>            : 
<span class="lineNum">     882 </span><span class="lineCov">       1959 :         gf_free((char *) inst-&gt;proto_name);</span>
<span class="lineNum">     883 </span><span class="lineCov">       1959 :         gf_list_del(inst-&gt;node_code);</span>
<span class="lineNum">     884 </span>            :         assert(!gf_list_count(inst-&gt;scripts_to_load));
<span class="lineNum">     885 </span><span class="lineCov">       1959 :         gf_list_del(inst-&gt;scripts_to_load);</span>
<span class="lineNum">     886 </span>            : 
<span class="lineNum">     887 </span><span class="lineCov">       1959 :         if (inst-&gt;proto_interface &amp;&amp; inst-&gt;proto_interface-&gt;instances) gf_list_del_item(inst-&gt;proto_interface-&gt;instances, inst);</span>
<span class="lineNum">     888 </span>            : 
<span class="lineNum">     889 </span><span class="lineCov">       1959 :         gf_node_free((GF_Node *)inst);</span>
<span class="lineNum">     890 </span><span class="lineCov">       1959 :         gf_sg_del(sg);</span>
<span class="lineNum">     891 </span><span class="lineCov">       1959 : }</span>
<span class="lineNum">     892 </span>            : 
<span class="lineNum">     893 </span>            : /*Note on ISed fields: we cannot support fan-in on proto, eg we assume only one eventIn field can receive events
<span class="lineNum">     894 </span>            : thus situations where a proto receives eventIn from outside and the node with ISed eventIn receives event
<a name="895"><span class="lineNum">     895 </span>            : from inside the proto are undefined*/</a>
<span class="lineNum">     896 </span>            : GF_EXPORT
<span class="lineNum">     897 </span><span class="lineCov">        552 : GF_Err gf_sg_proto_field_set_ised(GF_Proto *proto, u32 protoFieldIndex, GF_Node *node, u32 nodeFieldIndex)</span>
<span class="lineNum">     898 </span>            : {
<span class="lineNum">     899 </span>            :         GF_Err e;
<span class="lineNum">     900 </span>            :         GF_Route *r;
<span class="lineNum">     901 </span>            :         GF_FieldInfo field, nodeField;
<span class="lineNum">     902 </span><span class="lineCov">        552 :         field.fieldIndex = protoFieldIndex;</span>
<span class="lineNum">     903 </span><span class="lineCov">        552 :         e = gf_sg_proto_get_field(proto, NULL, &amp;field);</span>
<span class="lineNum">     904 </span><span class="lineCov">        552 :         if (e) return e;</span>
<span class="lineNum">     905 </span><span class="lineCov">        552 :         e = gf_node_get_field(node, nodeFieldIndex, &amp;nodeField);</span>
<span class="lineNum">     906 </span><span class="lineCov">        552 :         if (e) return e;</span>
<span class="lineNum">     907 </span><span class="lineCov">        552 :         if (field.fieldType != nodeField.fieldType) {</span>
<span class="lineNum">     908 </span><span class="lineCov">          5 :                 if ((gf_sg_vrml_get_sf_type(field.fieldType)==GF_SG_VRML_SFSTRING) &amp;&amp; (gf_sg_vrml_get_sf_type(nodeField.fieldType) == GF_SG_VRML_SFURL)) {</span>
<span class="lineNum">     909 </span>            : //                      e = GF_OK;
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :                 } else if ((gf_sg_vrml_get_sf_type(field.fieldType)==GF_SG_VRML_SFURL) &amp;&amp; (gf_sg_vrml_get_sf_type(nodeField.fieldType) == GF_SG_VRML_SFSTRING)) {</span>
<span class="lineNum">     911 </span>            : //                      e = GF_OK;
<span class="lineNum">     912 </span>            :                 } else {
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_SCENE, (&quot;[VRML] error in IS - node field %s.%s - inType %s - outType %s\n&quot;, gf_node_get_class_name(node) , nodeField.name, gf_sg_vrml_get_field_type_name(field.fieldType), gf_sg_vrml_get_field_type_name(nodeField.fieldType)));</span>
<span class="lineNum">     914 </span>            :                         return GF_SG_INVALID_PROTO;
<span class="lineNum">     915 </span>            :                 }
<span class="lineNum">     916 </span>            :         }
<span class="lineNum">     917 </span>            : 
<span class="lineNum">     918 </span><span class="lineCov">        552 :         GF_SAFEALLOC(r, GF_Route)</span>
<span class="lineNum">     919 </span><span class="lineCov">        552 :         if (!r) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     920 </span><span class="lineCov">        552 :         r-&gt;IS_route = 1;</span>
<span class="lineNum">     921 </span>            : 
<span class="lineNum">     922 </span><span class="lineCov">        552 :         if (nodeField.eventType==GF_SG_EVENT_OUT) {</span>
<span class="lineNum">     923 </span><span class="lineCov">          8 :                 r-&gt;FromField.fieldIndex = nodeFieldIndex;</span>
<span class="lineNum">     924 </span><span class="lineCov">          8 :                 r-&gt;FromNode = node;</span>
<span class="lineNum">     925 </span><span class="lineCov">          8 :                 r-&gt;ToField.fieldIndex = protoFieldIndex;</span>
<span class="lineNum">     926 </span><span class="lineCov">          8 :                 r-&gt;ToNode = NULL;</span>
<span class="lineNum">     927 </span><span class="lineCov">          8 :                 if (!node-&gt;sgprivate-&gt;interact) {</span>
<span class="lineNum">     928 </span><span class="lineCov">          8 :                         GF_SAFEALLOC(node-&gt;sgprivate-&gt;interact, struct _node_interactive_ext);</span>
<span class="lineNum">     929 </span><span class="lineCov">          8 :                         if (!node-&gt;sgprivate-&gt;interact) {</span>
<span class="lineNum">     930 </span>            :                                 return GF_OUT_OF_MEM;
<span class="lineNum">     931 </span>            :                         }
<span class="lineNum">     932 </span>            :                 }
<span class="lineNum">     933 </span><span class="lineCov">          8 :                 if (!node-&gt;sgprivate-&gt;interact-&gt;routes) node-&gt;sgprivate-&gt;interact-&gt;routes = gf_list_new();</span>
<span class="lineNum">     934 </span><span class="lineCov">          8 :                 gf_list_add(node-&gt;sgprivate-&gt;interact-&gt;routes, r);</span>
<span class="lineNum">     935 </span>            :         } else {
<span class="lineNum">     936 </span><span class="lineCov">        544 :                 switch (field.eventType) {</span>
<span class="lineNum">     937 </span><span class="lineCov">        544 :                 case GF_SG_EVENT_FIELD:</span>
<span class="lineNum">     938 </span>            :                 case GF_SG_EVENT_EXPOSED_FIELD:
<span class="lineNum">     939 </span>            :                 case GF_SG_EVENT_IN:
<span class="lineNum">     940 </span><span class="lineCov">        544 :                         r-&gt;FromField.fieldIndex = protoFieldIndex;</span>
<span class="lineNum">     941 </span><span class="lineCov">        544 :                         r-&gt;FromNode = NULL;</span>
<span class="lineNum">     942 </span><span class="lineCov">        544 :                         r-&gt;ToField.fieldIndex = nodeFieldIndex;</span>
<span class="lineNum">     943 </span><span class="lineCov">        544 :                         r-&gt;ToNode = node;</span>
<span class="lineNum">     944 </span>            :                         /*create an ISed route for the eventOut part of the exposedFIeld*/
<span class="lineNum">     945 </span><span class="lineCov">        544 :                         if ((field.eventType==GF_SG_EVENT_EXPOSED_FIELD) &amp;&amp; (nodeField.eventType==GF_SG_EVENT_EXPOSED_FIELD)) {</span>
<span class="lineNum">     946 </span>            :                                 GF_Route *r2;
<span class="lineNum">     947 </span><span class="lineCov">        478 :                                 GF_SAFEALLOC(r2, GF_Route);</span>
<span class="lineNum">     948 </span><span class="lineCov">        478 :                                 if (!r2) {</span>
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :                                         gf_free(r);</span>
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :                                         return GF_OUT_OF_MEM;</span>
<span class="lineNum">     951 </span>            :                                 }
<span class="lineNum">     952 </span><span class="lineCov">        478 :                                 r2-&gt;IS_route = 1;</span>
<span class="lineNum">     953 </span><span class="lineCov">        478 :                                 r2-&gt;FromField.fieldIndex = nodeFieldIndex;</span>
<span class="lineNum">     954 </span><span class="lineCov">        478 :                                 r2-&gt;FromNode = node;</span>
<span class="lineNum">     955 </span><span class="lineCov">        478 :                                 r2-&gt;ToField.fieldIndex = protoFieldIndex;</span>
<span class="lineNum">     956 </span><span class="lineCov">        478 :                                 r2-&gt;ToNode = NULL;</span>
<span class="lineNum">     957 </span><span class="lineCov">        478 :                                 r2-&gt;graph =  proto-&gt;sub_graph;</span>
<span class="lineNum">     958 </span><span class="lineCov">        478 :                                 if (!node-&gt;sgprivate-&gt;interact) {</span>
<span class="lineNum">     959 </span><span class="lineCov">        268 :                                         GF_SAFEALLOC(node-&gt;sgprivate-&gt;interact, struct _node_interactive_ext);</span>
<span class="lineNum">     960 </span><span class="lineCov">        268 :                                         if (!node-&gt;sgprivate-&gt;interact) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     961 </span>            :                                 }
<span class="lineNum">     962 </span><span class="lineCov">        478 :                                 if (!node-&gt;sgprivate-&gt;interact-&gt;routes) node-&gt;sgprivate-&gt;interact-&gt;routes = gf_list_new();</span>
<span class="lineNum">     963 </span><span class="lineCov">        478 :                                 gf_list_add(node-&gt;sgprivate-&gt;interact-&gt;routes, r2);</span>
<span class="lineNum">     964 </span><span class="lineCov">        478 :                                 gf_list_add(proto-&gt;sub_graph-&gt;Routes, r2);</span>
<span class="lineNum">     965 </span>            :                         }
<span class="lineNum">     966 </span>            :                         break;
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :                 case GF_SG_EVENT_OUT:</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :                         r-&gt;FromField.fieldIndex = nodeFieldIndex;</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :                         r-&gt;FromNode = node;</span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :                         r-&gt;ToField.fieldIndex = protoFieldIndex;</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :                         r-&gt;ToNode = NULL;</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :                         if (!node-&gt;sgprivate-&gt;interact) {</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :                                 GF_SAFEALLOC(node-&gt;sgprivate-&gt;interact, struct _node_interactive_ext);</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :                                 if (!node-&gt;sgprivate-&gt;interact) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     975 </span>            :                         }
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :                         if (!node-&gt;sgprivate-&gt;interact-&gt;routes) node-&gt;sgprivate-&gt;interact-&gt;routes = gf_list_new();</span>
<span class="lineNum">     977 </span>            :                         break;
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :                 default:</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :                         gf_free(r);</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :                         return GF_BAD_PARAM;</span>
<span class="lineNum">     981 </span>            :                 }
<span class="lineNum">     982 </span>            :         }
<span class="lineNum">     983 </span><span class="lineCov">        552 :         r-&gt;graph = proto-&gt;sub_graph;</span>
<span class="lineNum">     984 </span><span class="lineCov">        552 :         return gf_list_add(proto-&gt;sub_graph-&gt;Routes, r);</span>
<span class="lineNum">     985 </span>            : }
<a name="986"><span class="lineNum">     986 </span>            : </a>
<span class="lineNum">     987 </span>            : GF_EXPORT
<span class="lineNum">     988 </span><span class="lineNoCov">          0 : GF_Err gf_sg_proto_instance_set_ised(GF_Node *protoinst, u32 protoFieldIndex, GF_Node *node, u32 nodeFieldIndex)</span>
<span class="lineNum">     989 </span>            : {
<span class="lineNum">     990 </span>            :         GF_Err e;
<span class="lineNum">     991 </span>            :         GF_Route *r;
<span class="lineNum">     992 </span>            :         GF_FieldInfo field, nodeField;
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :         if (protoinst-&gt;sgprivate-&gt;tag != TAG_ProtoNode) return GF_BAD_PARAM;</span>
<span class="lineNum">     994 </span>            : 
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :         e = gf_node_get_field(protoinst, protoFieldIndex, &amp;field);</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :         e = gf_node_get_field(node, nodeFieldIndex, &amp;nodeField);</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :         if (field.fieldType != nodeField.fieldType) {</span>
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :                 if ((gf_sg_vrml_get_sf_type(field.fieldType)==GF_SG_VRML_SFSTRING) &amp;&amp; (gf_sg_vrml_get_sf_type(nodeField.fieldType) == GF_SG_VRML_SFURL)) {</span>
<span class="lineNum">    1001 </span>            : //                      e = GF_OK;
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :                 } else if ((gf_sg_vrml_get_sf_type(field.fieldType)==GF_SG_VRML_SFURL) &amp;&amp; (gf_sg_vrml_get_sf_type(nodeField.fieldType) == GF_SG_VRML_SFSTRING)) {</span>
<span class="lineNum">    1003 </span>            : //                      e = GF_OK;
<span class="lineNum">    1004 </span>            :                 } else {
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_SCENE, (&quot;[VRML] error in IS - node field %s.%s - inType %s - outType %s\n&quot;, gf_node_get_class_name(node) , nodeField.name, gf_sg_vrml_get_field_type_name(field.fieldType), gf_sg_vrml_get_field_type_name(nodeField.fieldType)));</span>
<span class="lineNum">    1006 </span>            :                         return GF_SG_INVALID_PROTO;
<span class="lineNum">    1007 </span>            :                 }
<span class="lineNum">    1008 </span>            :         }
<span class="lineNum">    1009 </span>            : 
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :         GF_SAFEALLOC(r, GF_Route)</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :         if (!r) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :         r-&gt;IS_route = 1;</span>
<span class="lineNum">    1013 </span>            : 
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :         if (nodeField.eventType==GF_SG_EVENT_OUT) {</span>
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :                 r-&gt;FromField.fieldIndex = nodeFieldIndex;</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :                 r-&gt;FromNode = node;</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :                 r-&gt;ToField.fieldIndex = protoFieldIndex;</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :                 r-&gt;ToNode = protoinst;</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :                 if (!node-&gt;sgprivate-&gt;interact) {</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :                         GF_SAFEALLOC(node-&gt;sgprivate-&gt;interact, struct _node_interactive_ext);</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :                         if (!node-&gt;sgprivate-&gt;interact) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1022 </span>            :                 }
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :                 if (!node-&gt;sgprivate-&gt;interact-&gt;routes) node-&gt;sgprivate-&gt;interact-&gt;routes = gf_list_new();</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :                 gf_list_add(node-&gt;sgprivate-&gt;interact-&gt;routes, r);</span>
<span class="lineNum">    1025 </span>            :         } else {
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :                 switch (field.eventType) {</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :                 case GF_SG_EVENT_FIELD:</span>
<span class="lineNum">    1028 </span>            :                 case GF_SG_EVENT_EXPOSED_FIELD:
<span class="lineNum">    1029 </span>            :                 case GF_SG_EVENT_IN:
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :                         r-&gt;FromField.fieldIndex = protoFieldIndex;</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :                         r-&gt;FromNode = protoinst;</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :                         r-&gt;ToField.fieldIndex = nodeFieldIndex;</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :                         r-&gt;ToNode = node;</span>
<span class="lineNum">    1034 </span>            : 
<span class="lineNum">    1035 </span>            :                         /*create an ISed route for the eventOut part of the exposedFIeld*/
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :                         if ((field.eventType==GF_SG_EVENT_EXPOSED_FIELD) &amp;&amp; (nodeField.eventType==GF_SG_EVENT_EXPOSED_FIELD)) {</span>
<span class="lineNum">    1037 </span>            :                                 GF_Route *r2;
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :                                 GF_SAFEALLOC(r2, GF_Route);</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :                                 if (!r2) {</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :                                         gf_free(r);</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :                                         return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1042 </span>            :                                 }
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :                                 r2-&gt;IS_route = 1;</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :                                 r2-&gt;FromField.fieldIndex = nodeFieldIndex;</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :                                 r2-&gt;FromNode = node;</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :                                 r2-&gt;ToField.fieldIndex = protoFieldIndex;</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :                                 r2-&gt;ToNode = protoinst;</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :                                 r2-&gt;graph =  node-&gt;sgprivate-&gt;scenegraph;</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :                                 if (!node-&gt;sgprivate-&gt;interact) {</span>
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :                                         GF_SAFEALLOC(node-&gt;sgprivate-&gt;interact, struct _node_interactive_ext);</span>
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :                                         if (!node-&gt;sgprivate-&gt;interact) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1052 </span>            :                                 }
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :                                 if (!node-&gt;sgprivate-&gt;interact-&gt;routes) node-&gt;sgprivate-&gt;interact-&gt;routes = gf_list_new();</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :                                 gf_list_add(node-&gt;sgprivate-&gt;interact-&gt;routes, r2);</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :                                 gf_list_add(r-&gt;graph-&gt;Routes, r2);</span>
<span class="lineNum">    1056 </span>            :                         }
<span class="lineNum">    1057 </span>            :                         break;
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :                 case GF_SG_EVENT_OUT:</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :                         r-&gt;FromField.fieldIndex = nodeFieldIndex;</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :                         r-&gt;FromNode = node;</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :                         r-&gt;ToField.fieldIndex = protoFieldIndex;</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :                         r-&gt;ToNode = protoinst;</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :                         if (!node-&gt;sgprivate-&gt;interact) {</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :                                 GF_SAFEALLOC(node-&gt;sgprivate-&gt;interact, struct _node_interactive_ext);</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :                                 if (!node-&gt;sgprivate-&gt;interact) return GF_OUT_OF_MEM;</span>
<span class="lineNum">    1066 </span>            :                         }
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :                         if (!node-&gt;sgprivate-&gt;interact-&gt;routes) node-&gt;sgprivate-&gt;interact-&gt;routes = gf_list_new();</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :                         gf_list_add(node-&gt;sgprivate-&gt;interact-&gt;routes, r);</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :                 default:</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :                         gf_free(r);</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :                         return GF_BAD_PARAM;</span>
<span class="lineNum">    1073 </span>            :                 }
<span class="lineNum">    1074 </span>            :         }
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :         r-&gt;graph = node-&gt;sgprivate-&gt;scenegraph;</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :         gf_sg_route_activate(r);</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :         return gf_list_add(r-&gt;graph-&gt;Routes, r);</span>
<span class="lineNum">    1078 </span>            : }
<a name="1079"><span class="lineNum">    1079 </span>            : </a>
<span class="lineNum">    1080 </span>            : 
<span class="lineNum">    1081 </span><span class="lineCov">          4 : GF_Err gf_bifs_proto_field_set_aq_info(GF_ProtoFieldInterface *field,</span>
<span class="lineNum">    1082 </span>            :                                        u32 QP_Type,
<span class="lineNum">    1083 </span>            :                                        u32 hasMinMax,
<span class="lineNum">    1084 </span>            :                                        u32 QPSFType,
<span class="lineNum">    1085 </span>            :                                        void *qp_min_value,
<span class="lineNum">    1086 </span>            :                                        void *qp_max_value,
<span class="lineNum">    1087 </span>            :                                        u32 QP13_NumBits)
<span class="lineNum">    1088 </span>            : {
<span class="lineNum">    1089 </span>            : 
<span class="lineNum">    1090 </span><span class="lineCov">          4 :         if (!field) return GF_BAD_PARAM;</span>
<span class="lineNum">    1091 </span><span class="lineCov">          4 :         if (!QP_Type) return GF_OK;</span>
<span class="lineNum">    1092 </span><span class="lineCov">          4 :         if (!gf_sg_vrml_is_sf_field(QPSFType)) return GF_BAD_PARAM;</span>
<span class="lineNum">    1093 </span>            : 
<span class="lineNum">    1094 </span><span class="lineCov">          4 :         field-&gt;QP_Type = QP_Type;</span>
<span class="lineNum">    1095 </span><span class="lineCov">          4 :         field-&gt;hasMinMax = hasMinMax;</span>
<span class="lineNum">    1096 </span><span class="lineCov">          4 :         if (hasMinMax) {</span>
<span class="lineNum">    1097 </span><span class="lineCov">          4 :                 if (qp_min_value) {</span>
<span class="lineNum">    1098 </span><span class="lineCov">          4 :                         field-&gt;qp_min_value = gf_sg_vrml_field_pointer_new(QPSFType);</span>
<span class="lineNum">    1099 </span><span class="lineCov">          4 :                         gf_sg_vrml_field_copy(field-&gt;qp_min_value, qp_min_value, QPSFType);</span>
<span class="lineNum">    1100 </span>            :                 }
<span class="lineNum">    1101 </span><span class="lineCov">          4 :                 if (qp_max_value) {</span>
<span class="lineNum">    1102 </span><span class="lineCov">          4 :                         field-&gt;qp_max_value = gf_sg_vrml_field_pointer_new(QPSFType);</span>
<span class="lineNum">    1103 </span><span class="lineCov">          4 :                         gf_sg_vrml_field_copy(field-&gt;qp_max_value, qp_max_value, QPSFType);</span>
<span class="lineNum">    1104 </span>            :                 }
<span class="lineNum">    1105 </span>            :         }
<span class="lineNum">    1106 </span><span class="lineCov">          4 :         field-&gt;NumBits = QP13_NumBits;</span>
<span class="lineNum">    1107 </span><span class="lineCov">          4 :         return GF_OK;</span>
<span class="lineNum">    1108 </span>            : }
<a name="1109"><span class="lineNum">    1109 </span>            : </a>
<span class="lineNum">    1110 </span>            : 
<span class="lineNum">    1111 </span><span class="lineCov">       2651 : GF_Err gf_sg_proto_get_field_index(GF_ProtoInstance *proto, u32 index, u32 code_mode, u32 *all_index)</span>
<span class="lineNum">    1112 </span>            : {
<span class="lineNum">    1113 </span>            :         u32 i;
<span class="lineNum">    1114 </span>            :         GF_ProtoFieldInterface *proto_field;
<span class="lineNum">    1115 </span>            : 
<span class="lineNum">    1116 </span><span class="lineCov">       2651 :         i=0;</span>
<span class="lineNum">    1117 </span><span class="lineCov">      11508 :         while ((proto_field = (GF_ProtoFieldInterface*)gf_list_enum(proto-&gt;proto_interface-&gt;proto_fields, &amp;i))) {</span>
<span class="lineNum">    1118 </span>            :                 assert(proto_field);
<span class="lineNum">    1119 </span><span class="lineCov">       8857 :                 switch (code_mode) {</span>
<span class="lineNum">    1120 </span><span class="lineCov">        197 :                 case GF_SG_FIELD_CODING_IN:</span>
<span class="lineNum">    1121 </span><span class="lineCov">        197 :                         if (proto_field-&gt;IN_index == index) {</span>
<span class="lineNum">    1122 </span><span class="lineCov">        133 :                                 *all_index = proto_field-&gt;ALL_index;</span>
<span class="lineNum">    1123 </span><span class="lineCov">        133 :                                 return GF_OK;</span>
<span class="lineNum">    1124 </span>            :                         }
<span class="lineNum">    1125 </span>            :                         break;
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :                 case GF_SG_FIELD_CODING_OUT:</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :                         if (proto_field-&gt;OUT_index == index) {</span>
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 :                                 *all_index = proto_field-&gt;ALL_index;</span>
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">    1130 </span>            :                         }
<span class="lineNum">    1131 </span>            :                         break;
<span class="lineNum">    1132 </span><span class="lineCov">       8660 :                 case GF_SG_FIELD_CODING_DEF:</span>
<span class="lineNum">    1133 </span><span class="lineCov">       8660 :                         if (proto_field-&gt;DEF_index == index) {</span>
<span class="lineNum">    1134 </span><span class="lineCov">       2518 :                                 *all_index = proto_field-&gt;ALL_index;</span>
<span class="lineNum">    1135 </span><span class="lineCov">       2518 :                                 return GF_OK;</span>
<span class="lineNum">    1136 </span>            :                         }
<span class="lineNum">    1137 </span>            :                         break;
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :                 case GF_SG_FIELD_CODING_ALL:</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :                         if (proto_field-&gt;ALL_index == index) {</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :                                 *all_index = proto_field-&gt;ALL_index;</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">    1142 </span>            :                         }
<span class="lineNum">    1143 </span>            :                         break;
<span class="lineNum">    1144 </span>            :                 /*BIFS-ANIM not supported*/
<span class="lineNum">    1145 </span>            :                 case GF_SG_FIELD_CODING_DYN:
<span class="lineNum">    1146 </span>            :                 default:
<span class="lineNum">    1147 </span>            :                         return GF_BAD_PARAM;
<span class="lineNum">    1148 </span>            :                 }
<span class="lineNum">    1149 </span>            :         }
<span class="lineNum">    1150 </span>            :         return GF_BAD_PARAM;
<span class="lineNum">    1151 </span>            : }
<a name="1152"><span class="lineNum">    1152 </span>            : </a>
<span class="lineNum">    1153 </span>            : GF_EXPORT
<span class="lineNum">    1154 </span><span class="lineCov">        710 : u32 gf_sg_proto_get_field_count(GF_Proto *proto)</span>
<span class="lineNum">    1155 </span>            : {
<span class="lineNum">    1156 </span><span class="lineCov">        710 :         if (!proto) return 0;</span>
<span class="lineNum">    1157 </span><span class="lineCov">        710 :         return gf_list_count(proto-&gt;proto_fields);</span>
<span class="lineNum">    1158 </span>            : }
<a name="1159"><span class="lineNum">    1159 </span>            : </a>
<span class="lineNum">    1160 </span>            : GF_EXPORT
<span class="lineNum">    1161 </span><span class="lineCov">        326 : GF_ProtoFieldInterface *gf_sg_proto_field_find(GF_Proto *proto, u32 fieldIndex)</span>
<span class="lineNum">    1162 </span>            : {
<span class="lineNum">    1163 </span><span class="lineCov">        326 :         if (!proto) return NULL;</span>
<span class="lineNum">    1164 </span><span class="lineCov">        326 :         return (GF_ProtoFieldInterface*)gf_list_get(proto-&gt;proto_fields, fieldIndex);</span>
<a name="1165"><span class="lineNum">    1165 </span>            : }</a>
<span class="lineNum">    1166 </span>            : 
<span class="lineNum">    1167 </span><span class="lineCov">      61686 : void gf_sg_proto_propagate_event(GF_Node *node, u32 fieldIndex, GF_Node *from_node)</span>
<span class="lineNum">    1168 </span>            : {
<span class="lineNum">    1169 </span>            :         u32 i;
<span class="lineNum">    1170 </span>            :         GF_Route *r;
<span class="lineNum">    1171 </span><span class="lineCov">     106222 :         if (!node) return;</span>
<span class="lineNum">    1172 </span>            :         /*propagation only for proto*/
<span class="lineNum">    1173 </span><span class="lineCov">      61686 :         if (node-&gt;sgprivate-&gt;tag != TAG_ProtoNode) return;</span>
<span class="lineNum">    1174 </span>            :         /*with ISed fields*/
<span class="lineNum">    1175 </span><span class="lineCov">      21955 :         if (!node-&gt;sgprivate-&gt;interact || !node-&gt;sgprivate-&gt;interact-&gt;routes) return;</span>
<span class="lineNum">    1176 </span>            :         /*we only need to propagate ISed for eventIn/exposedField. This means that if the event comes from
<span class="lineNum">    1177 </span>            :         the same scene graph as the proto (eg from the proto code) we don't propagate the event*/
<span class="lineNum">    1178 </span><span class="lineCov">      21056 :         if (from_node-&gt;sgprivate-&gt;scenegraph == node-&gt;sgprivate-&gt;scenegraph) return;</span>
<span class="lineNum">    1179 </span>            : 
<span class="lineNum">    1180 </span>            :         /*for all ISed routes*/
<span class="lineNum">    1181 </span><span class="lineCov">      17150 :         i=0;</span>
<span class="lineNum">    1182 </span><span class="lineCov">     214342 :         while ((r = (GF_Route*)gf_list_enum(node-&gt;sgprivate-&gt;interact-&gt;routes, &amp;i))) {</span>
<span class="lineNum">    1183 </span><span class="lineCov">     180042 :                 if (!r-&gt;IS_route) continue;</span>
<span class="lineNum">    1184 </span>            :                 /*connecting from this node &amp;&amp; field to a destination node other than the event source (this will break loops due to exposedFields)*/
<span class="lineNum">    1185 </span><span class="lineCov">     154378 :                 if ((r-&gt;FromNode == node) &amp;&amp; (r-&gt;FromField.fieldIndex == fieldIndex) &amp;&amp; (r-&gt;ToNode != from_node) ) {</span>
<span class="lineNum">    1186 </span><span class="lineCov">       9600 :                         if (gf_sg_route_activate(r))</span>
<span class="lineNum">    1187 </span><span class="lineCov">       2201 :                                 gf_node_changed(r-&gt;ToNode, &amp;r-&gt;ToField);</span>
<span class="lineNum">    1188 </span>            :                 }
<span class="lineNum">    1189 </span>            :         }
<span class="lineNum">    1190 </span>            : }
<a name="1191"><span class="lineNum">    1191 </span>            : </a>
<span class="lineNum">    1192 </span>            : 
<span class="lineNum">    1193 </span><span class="lineCov">         73 : Bool gf_sg_proto_get_aq_info(GF_Node *Node, u32 FieldIndex, u8 *QType, u8 *AType, Fixed *b_min, Fixed *b_max, u32 *QT13_bits)</span>
<span class="lineNum">    1194 </span>            : {
<span class="lineNum">    1195 </span>            :         GF_Proto *proto;
<span class="lineNum">    1196 </span>            :         u32 i;
<span class="lineNum">    1197 </span>            :         GF_ProtoFieldInterface *proto_field;
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span><span class="lineCov">         73 :         proto = ((GF_ProtoInstance *)Node)-&gt;proto_interface;</span>
<span class="lineNum">    1200 </span>            : 
<span class="lineNum">    1201 </span><span class="lineCov">         73 :         i=0;</span>
<span class="lineNum">    1202 </span><span class="lineCov">        426 :         while ((proto_field = (GF_ProtoFieldInterface*)gf_list_enum(proto-&gt;proto_fields, &amp;i))) {</span>
<span class="lineNum">    1203 </span><span class="lineCov">        353 :                 if (proto_field-&gt;ALL_index!=FieldIndex) continue;</span>
<span class="lineNum">    1204 </span>            : 
<span class="lineNum">    1205 </span><span class="lineCov">         73 :                 *QType = proto_field-&gt;QP_Type;</span>
<span class="lineNum">    1206 </span><span class="lineCov">         73 :                 *AType = proto_field-&gt;Anim_Type;</span>
<span class="lineNum">    1207 </span><span class="lineCov">         73 :                 *b_min = FIX_MIN;</span>
<span class="lineNum">    1208 </span><span class="lineCov">         73 :                 *b_max = FIX_MAX;</span>
<span class="lineNum">    1209 </span>            : 
<span class="lineNum">    1210 </span><span class="lineCov">         73 :                 if (proto_field-&gt;hasMinMax) {</span>
<span class="lineNum">    1211 </span>            : 
<span class="lineNum">    1212 </span>            :                         /*translate our bounds*/
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :                         switch (gf_sg_vrml_get_sf_type(proto_field-&gt;FieldType)) {</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :                         case GF_SG_VRML_SFINT32:</span>
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :                                 *b_min = (SFFloat) * ( (SFInt32 *) proto_field-&gt;qp_min_value);</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                                 *b_max = (SFFloat) * ( (SFInt32 *) proto_field-&gt;qp_max_value);</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    1218 </span>            :                         /*TO DO EVERYWHERE: check on field translation from double to float
<span class="lineNum">    1219 </span>            :                         during quant bounds*/
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :                         case GF_SG_VRML_SFTIME:</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :                                 *b_min = (SFFloat) * ( (SFTime *) proto_field-&gt;qp_min_value);</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :                                 *b_max = (SFFloat) * ( (SFTime *) proto_field-&gt;qp_max_value);</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :                         default:</span>
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :                                 if (proto_field-&gt;qp_min_value)</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :                                         *b_min = (SFFloat) * ( (SFFloat *) proto_field-&gt;qp_min_value);</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :                                 if (proto_field-&gt;qp_max_value)</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :                                         *b_max = (SFFloat) * ( (SFFloat *) proto_field-&gt;qp_max_value);</span>
<span class="lineNum">    1229 </span>            :                                 break;
<span class="lineNum">    1230 </span>            :                         }
<span class="lineNum">    1231 </span>            : 
<span class="lineNum">    1232 </span><span class="lineCov">         73 :                 }</span>
<span class="lineNum">    1233 </span><span class="lineCov">         73 :                 *QT13_bits = proto_field-&gt;NumBits;</span>
<span class="lineNum">    1234 </span><span class="lineCov">         73 :                 return 1;</span>
<span class="lineNum">    1235 </span>            :         }
<span class="lineNum">    1236 </span>            :         return 0;
<span class="lineNum">    1237 </span>            : }
<span class="lineNum">    1238 </span>            : 
<a name="1239"><span class="lineNum">    1239 </span>            : </a>
<span class="lineNum">    1240 </span>            : GF_EXPORT
<span class="lineNum">    1241 </span><span class="lineCov">        661 : GF_Proto *gf_node_get_proto(GF_Node *node)</span>
<span class="lineNum">    1242 </span>            : {
<span class="lineNum">    1243 </span>            :         GF_ProtoInstance *inst;
<span class="lineNum">    1244 </span><span class="lineCov">        661 :         if (node-&gt;sgprivate-&gt;tag != TAG_ProtoNode) return NULL;</span>
<span class="lineNum">    1245 </span>            :         inst = (GF_ProtoInstance *) node;
<span class="lineNum">    1246 </span><span class="lineCov">        661 :         return inst-&gt;proto_interface;</span>
<span class="lineNum">    1247 </span>            : }
<span class="lineNum">    1248 </span>            : 
<a name="1249"><span class="lineNum">    1249 </span>            : /*returns the ID of the proto*/</a>
<span class="lineNum">    1250 </span>            : GF_EXPORT
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 : u32 gf_sg_proto_get_id(GF_Proto *proto)</span>
<span class="lineNum">    1252 </span>            : {
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :         return proto-&gt;ID;</span>
<span class="lineNum">    1254 </span>            : }
<a name="1255"><span class="lineNum">    1255 </span>            : </a>
<span class="lineNum">    1256 </span>            : GF_EXPORT
<span class="lineNum">    1257 </span><span class="lineCov">         18 : const char *gf_sg_proto_get_class_name(GF_Proto *proto)</span>
<span class="lineNum">    1258 </span>            : {
<span class="lineNum">    1259 </span><span class="lineCov">         18 :         return (const char *) proto-&gt;Name;</span>
<a name="1260"><span class="lineNum">    1260 </span>            : }</a>
<span class="lineNum">    1261 </span>            : 
<span class="lineNum">    1262 </span><span class="lineCov">        131 : u32 gf_sg_proto_get_root_tag(GF_Proto *proto)</span>
<span class="lineNum">    1263 </span>            : {
<span class="lineNum">    1264 </span>            :         GF_Node *n;
<span class="lineNum">    1265 </span><span class="lineCov">        131 :         if (!proto) return TAG_UndefinedNode;</span>
<span class="lineNum">    1266 </span><span class="lineCov">        131 :         n = (GF_Node*)gf_list_get(proto-&gt;node_code, 0);</span>
<span class="lineNum">    1267 </span><span class="lineCov">        131 :         if (!n) return TAG_UndefinedNode;</span>
<span class="lineNum">    1268 </span><span class="lineCov">         98 :         if (n-&gt;sgprivate-&gt;tag == TAG_ProtoNode) return gf_sg_proto_get_root_tag(((GF_ProtoInstance *)n)-&gt;proto_interface);</span>
<span class="lineNum">    1269 </span><span class="lineCov">         98 :         return n-&gt;sgprivate-&gt;tag;</span>
<span class="lineNum">    1270 </span>            : }
<a name="1271"><span class="lineNum">    1271 </span>            : </a>
<span class="lineNum">    1272 </span>            : GF_EXPORT
<span class="lineNum">    1273 </span><span class="lineCov">         31 : Bool gf_sg_proto_field_is_sftime_offset(GF_Node *node, GF_FieldInfo *field)</span>
<span class="lineNum">    1274 </span>            : {
<span class="lineNum">    1275 </span>            :         u32 i;
<span class="lineNum">    1276 </span>            :         GF_Route *r;
<span class="lineNum">    1277 </span>            :         GF_ProtoInstance *inst;
<span class="lineNum">    1278 </span>            :         GF_FieldInfo inf;
<span class="lineNum">    1279 </span><span class="lineCov">         31 :         if (node-&gt;sgprivate-&gt;tag != TAG_ProtoNode) return 0;</span>
<span class="lineNum">    1280 </span><span class="lineCov">         31 :         if (field-&gt;fieldType != GF_SG_VRML_SFTIME) return 0;</span>
<span class="lineNum">    1281 </span>            : 
<span class="lineNum">    1282 </span>            :         inst = (GF_ProtoInstance *) node;
<span class="lineNum">    1283 </span>            :         /*check in interface if this is ISed */
<span class="lineNum">    1284 </span><span class="lineCov">         31 :         i=0;</span>
<span class="lineNum">    1285 </span><span class="lineCov">        344 :         while ((r = (GF_Route*)gf_list_enum(inst-&gt;proto_interface-&gt;sub_graph-&gt;Routes, &amp;i))) {</span>
<span class="lineNum">    1286 </span><span class="lineCov">        292 :                 if (!r-&gt;IS_route) continue;</span>
<span class="lineNum">    1287 </span>            :                 /*only check eventIn/field/exposedField*/
<span class="lineNum">    1288 </span><span class="lineCov">        278 :                 if (r-&gt;FromNode || (r-&gt;FromField.fieldIndex != field-&gt;fieldIndex)) continue;</span>
<span class="lineNum">    1289 </span>            : 
<span class="lineNum">    1290 </span><span class="lineCov">         17 :                 gf_node_get_field(r-&gt;ToNode, r-&gt;ToField.fieldIndex, &amp;inf);</span>
<span class="lineNum">    1291 </span>            :                 /*IS to another proto*/
<span class="lineNum">    1292 </span><span class="lineCov">         17 :                 if (r-&gt;ToNode-&gt;sgprivate-&gt;tag == TAG_ProtoNode) return gf_sg_proto_field_is_sftime_offset(r-&gt;ToNode, &amp;inf);</span>
<span class="lineNum">    1293 </span>            :                 /*IS to a startTime/stopTime field*/
<span class="lineNum">    1294 </span><span class="lineCov">         17 :                 if (!stricmp(inf.name, &quot;startTime&quot;) || !stricmp(inf.name, &quot;stopTime&quot;)) return 1;</span>
<span class="lineNum">    1295 </span>            :         }
<span class="lineNum">    1296 </span>            :         return 0;
<span class="lineNum">    1297 </span>            : }
<a name="1298"><span class="lineNum">    1298 </span>            : </a>
<span class="lineNum">    1299 </span>            : GF_EXPORT
<span class="lineNum">    1300 </span><span class="lineCov">         84 : GF_Err gf_node_proto_set_grouping(GF_Node *node)</span>
<span class="lineNum">    1301 </span>            : {
<span class="lineNum">    1302 </span><span class="lineCov">         84 :         if (!node || (node-&gt;sgprivate-&gt;tag!=TAG_ProtoNode)) return GF_BAD_PARAM;</span>
<span class="lineNum">    1303 </span><span class="lineCov">         84 :         ((GF_ProtoInstance *)node)-&gt;flags |= GF_SG_PROTO_IS_GROUPING;</span>
<span class="lineNum">    1304 </span><span class="lineCov">         84 :         return GF_OK;</span>
<span class="lineNum">    1305 </span>            : }
<a name="1306"><span class="lineNum">    1306 </span>            : </a>
<span class="lineNum">    1307 </span>            : GF_EXPORT
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 : Bool gf_node_proto_is_grouping(GF_Node *node)</span>
<span class="lineNum">    1309 </span>            : {
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :         if (!node || (node-&gt;sgprivate-&gt;tag!=TAG_ProtoNode)) return 0;</span>
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :         if ( ((GF_ProtoInstance *)node)-&gt;flags &amp; GF_SG_PROTO_IS_GROUPING) return 1;</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    1313 </span>            : }
<a name="1314"><span class="lineNum">    1314 </span>            : </a>
<span class="lineNum">    1315 </span>            : GF_EXPORT
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 : GF_Node *gf_node_get_proto_root(GF_Node *node)</span>
<span class="lineNum">    1317 </span>            : {
<span class="lineNum">    1318 </span><span class="lineNoCov">          0 :         if (!node || (node-&gt;sgprivate-&gt;tag!=TAG_ProtoNode)) return NULL;</span>
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :         return ((GF_ProtoInstance *)node)-&gt;RenderingNode;</span>
<span class="lineNum">    1320 </span>            : }
<span class="lineNum">    1321 </span>            : 
<span class="lineNum">    1322 </span>            : #if 0 //unused
<span class="lineNum">    1323 </span>            : GF_Node *gf_node_get_proto_parent(GF_Node *node)
<span class="lineNum">    1324 </span>            : {
<span class="lineNum">    1325 </span>            :         if (!node) return NULL;
<span class="lineNum">    1326 </span>            :         if (node-&gt;sgprivate-&gt;scenegraph-&gt;pOwningProto) {
<span class="lineNum">    1327 </span>            :                 GF_Node *the_node = (GF_Node *) node-&gt;sgprivate-&gt;scenegraph-&gt;pOwningProto;
<span class="lineNum">    1328 </span>            :                 if (the_node != node) return the_node;
<span class="lineNum">    1329 </span>            :         }
<span class="lineNum">    1330 </span>            :         return NULL;
<span class="lineNum">    1331 </span>            : }
<span class="lineNum">    1332 </span>            : 
<span class="lineNum">    1333 </span>            : Bool gf_node_is_proto_root(GF_Node *node)
<span class="lineNum">    1334 </span>            : {
<span class="lineNum">    1335 </span>            :         if (!node) return 0;
<span class="lineNum">    1336 </span>            :         if (!node-&gt;sgprivate-&gt;scenegraph-&gt;pOwningProto) return 0;
<span class="lineNum">    1337 </span>            : 
<span class="lineNum">    1338 </span>            :         if (gf_list_find(node-&gt;sgprivate-&gt;scenegraph-&gt;pOwningProto-&gt;node_code, node)&gt;=0) return 1;
<span class="lineNum">    1339 </span>            :         return 0;
<span class="lineNum">    1340 </span>            : }
<span class="lineNum">    1341 </span>            : #endif
<span class="lineNum">    1342 </span>            : 
<a name="1343"><span class="lineNum">    1343 </span>            : </a>
<span class="lineNum">    1344 </span>            : GF_EXPORT
<span class="lineNum">    1345 </span><span class="lineCov">          1 : GF_Err gf_node_set_proto_eventin_handler(GF_Node *node, u32 fieldIndex, void (*event_in_cbk)(GF_Node *pThis, struct _route *route) )</span>
<span class="lineNum">    1346 </span>            : {
<span class="lineNum">    1347 </span>            :         GF_ProtoInstance *inst;
<span class="lineNum">    1348 </span>            :         GF_ProtoField *field;
<span class="lineNum">    1349 </span><span class="lineCov">          1 :         if (!node || (node-&gt;sgprivate-&gt;tag!=TAG_ProtoNode)) return GF_BAD_PARAM;</span>
<span class="lineNum">    1350 </span>            : 
<span class="lineNum">    1351 </span>            :         inst = (GF_ProtoInstance *) node;
<span class="lineNum">    1352 </span><span class="lineCov">          1 :         field = (GF_ProtoField*)gf_list_get(inst-&gt;fields, fieldIndex);</span>
<span class="lineNum">    1353 </span><span class="lineCov">          1 :         if (!field) return GF_BAD_PARAM;</span>
<span class="lineNum">    1354 </span>            : 
<span class="lineNum">    1355 </span><span class="lineCov">          1 :         if (field-&gt;EventType!=GF_SG_EVENT_IN) return GF_BAD_PARAM;</span>
<span class="lineNum">    1356 </span><span class="lineCov">          1 :         field-&gt;on_event_in = event_in_cbk;</span>
<span class="lineNum">    1357 </span><span class="lineCov">          1 :         return GF_OK;</span>
<span class="lineNum">    1358 </span>            : }
<span class="lineNum">    1359 </span>            : 
<span class="lineNum">    1360 </span>            : 
<span class="lineNum">    1361 </span>            : 
<span class="lineNum">    1362 </span>            : #endif  /*GPAC_DISABLE_VRML*/
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
